<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - fuzz_coverage.info - src/wallet/wallet.cpp</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

          <table width="100%" border=0 cellspacing=0 cellpadding=0>
            <tr><td class="title">LCOV - code coverage report</td></tr>
            <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

            <tr>
              <td width="100%">
                <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="10%" class="headerValue"><a href="../../index.html" title="Click to go to top-level">top level</a> - <a href="index.html" title="Click to go to directory src/wallet">src/wallet</a> - wallet.cpp<span style="font-size: 80%;"> (source / <a href="wallet.cpp.func-c.html" title="Click to go to function table">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="5%"></td>
            <td width="5%" class="headerCovTableHead">Coverage</td>
            <td width="5%" class="headerCovTableHead" title="Covered + Uncovered code">Total</td>
            <td width="5%" class="headerCovTableHead" title="Exercised code only">Hit</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">fuzz_coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntryLo">0.0&nbsp;%</td>
            <td class="headerCovTableEntry">2545</td>
            <td class="headerCovTableEntry">0</td>
          </tr>
          <tr>
            <td class="headerItem">Test Date:</td>
            <td class="headerValue">2024-11-22 13:43:01</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntryLo">0.0&nbsp;%</td>
            <td class="headerCovTableEntry">216</td>
            <td class="headerCovTableEntry">0</td>
          </tr>
          <tr>
            <td></td>
            <td></td>
            <td></td>
            <td class="headerItem">Branches:</td>
            <td class="headerCovTableEntryLo">0.0&nbsp;%</td>
            <td class="headerCovTableEntry">4210</td>
            <td class="headerCovTableEntry">0</td>
          </tr>
                  <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
                </table>
              </td>
            </tr>

            <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
          </table>

          <table cellpadding=0 cellspacing=0 border=0>
            <tr>
              <td><br></td>
            </tr>
            <tr>
              <td>
<pre class="sourceHeading">             Branch data     Line data    Source code</pre>
<pre class="source">
<span id="L1"><span class="lineNum">       1</span>                 :             : // Copyright (c) 2009-2010 Satoshi Nakamoto</span>
<span id="L2"><span class="lineNum">       2</span>                 :             : // Copyright (c) 2009-2022 The Bitcoin Core developers</span>
<span id="L3"><span class="lineNum">       3</span>                 :             : // Distributed under the MIT software license, see the accompanying</span>
<span id="L4"><span class="lineNum">       4</span>                 :             : // file COPYING or http://www.opensource.org/licenses/mit-license.php.</span>
<span id="L5"><span class="lineNum">       5</span>                 :             : </span>
<span id="L6"><span class="lineNum">       6</span>                 :             : #include &lt;wallet/wallet.h&gt;</span>
<span id="L7"><span class="lineNum">       7</span>                 :             : </span>
<span id="L8"><span class="lineNum">       8</span>                 :             : #include &lt;bitcoin-build-config.h&gt; // IWYU pragma: keep</span>
<span id="L9"><span class="lineNum">       9</span>                 :             : #include &lt;addresstype.h&gt;</span>
<span id="L10"><span class="lineNum">      10</span>                 :             : #include &lt;blockfilter.h&gt;</span>
<span id="L11"><span class="lineNum">      11</span>                 :             : #include &lt;chain.h&gt;</span>
<span id="L12"><span class="lineNum">      12</span>                 :             : #include &lt;coins.h&gt;</span>
<span id="L13"><span class="lineNum">      13</span>                 :             : #include &lt;common/args.h&gt;</span>
<span id="L14"><span class="lineNum">      14</span>                 :             : #include &lt;common/messages.h&gt;</span>
<span id="L15"><span class="lineNum">      15</span>                 :             : #include &lt;common/settings.h&gt;</span>
<span id="L16"><span class="lineNum">      16</span>                 :             : #include &lt;common/signmessage.h&gt;</span>
<span id="L17"><span class="lineNum">      17</span>                 :             : #include &lt;common/system.h&gt;</span>
<span id="L18"><span class="lineNum">      18</span>                 :             : #include &lt;consensus/amount.h&gt;</span>
<span id="L19"><span class="lineNum">      19</span>                 :             : #include &lt;consensus/consensus.h&gt;</span>
<span id="L20"><span class="lineNum">      20</span>                 :             : #include &lt;consensus/validation.h&gt;</span>
<span id="L21"><span class="lineNum">      21</span>                 :             : #include &lt;external_signer.h&gt;</span>
<span id="L22"><span class="lineNum">      22</span>                 :             : #include &lt;interfaces/chain.h&gt;</span>
<span id="L23"><span class="lineNum">      23</span>                 :             : #include &lt;interfaces/handler.h&gt;</span>
<span id="L24"><span class="lineNum">      24</span>                 :             : #include &lt;interfaces/wallet.h&gt;</span>
<span id="L25"><span class="lineNum">      25</span>                 :             : #include &lt;kernel/chain.h&gt;</span>
<span id="L26"><span class="lineNum">      26</span>                 :             : #include &lt;kernel/mempool_removal_reason.h&gt;</span>
<span id="L27"><span class="lineNum">      27</span>                 :             : #include &lt;key.h&gt;</span>
<span id="L28"><span class="lineNum">      28</span>                 :             : #include &lt;key_io.h&gt;</span>
<span id="L29"><span class="lineNum">      29</span>                 :             : #include &lt;logging.h&gt;</span>
<span id="L30"><span class="lineNum">      30</span>                 :             : #include &lt;node/types.h&gt;</span>
<span id="L31"><span class="lineNum">      31</span>                 :             : #include &lt;outputtype.h&gt;</span>
<span id="L32"><span class="lineNum">      32</span>                 :             : #include &lt;policy/feerate.h&gt;</span>
<span id="L33"><span class="lineNum">      33</span>                 :             : #include &lt;primitives/block.h&gt;</span>
<span id="L34"><span class="lineNum">      34</span>                 :             : #include &lt;primitives/transaction.h&gt;</span>
<span id="L35"><span class="lineNum">      35</span>                 :             : #include &lt;psbt.h&gt;</span>
<span id="L36"><span class="lineNum">      36</span>                 :             : #include &lt;pubkey.h&gt;</span>
<span id="L37"><span class="lineNum">      37</span>                 :             : #include &lt;random.h&gt;</span>
<span id="L38"><span class="lineNum">      38</span>                 :             : #include &lt;script/descriptor.h&gt;</span>
<span id="L39"><span class="lineNum">      39</span>                 :             : #include &lt;script/interpreter.h&gt;</span>
<span id="L40"><span class="lineNum">      40</span>                 :             : #include &lt;script/script.h&gt;</span>
<span id="L41"><span class="lineNum">      41</span>                 :             : #include &lt;script/sign.h&gt;</span>
<span id="L42"><span class="lineNum">      42</span>                 :             : #include &lt;script/signingprovider.h&gt;</span>
<span id="L43"><span class="lineNum">      43</span>                 :             : #include &lt;script/solver.h&gt;</span>
<span id="L44"><span class="lineNum">      44</span>                 :             : #include &lt;serialize.h&gt;</span>
<span id="L45"><span class="lineNum">      45</span>                 :             : #include &lt;span.h&gt;</span>
<span id="L46"><span class="lineNum">      46</span>                 :             : #include &lt;streams.h&gt;</span>
<span id="L47"><span class="lineNum">      47</span>                 :             : #include &lt;support/allocators/secure.h&gt;</span>
<span id="L48"><span class="lineNum">      48</span>                 :             : #include &lt;support/allocators/zeroafterfree.h&gt;</span>
<span id="L49"><span class="lineNum">      49</span>                 :             : #include &lt;support/cleanse.h&gt;</span>
<span id="L50"><span class="lineNum">      50</span>                 :             : #include &lt;sync.h&gt;</span>
<span id="L51"><span class="lineNum">      51</span>                 :             : #include &lt;tinyformat.h&gt;</span>
<span id="L52"><span class="lineNum">      52</span>                 :             : #include &lt;uint256.h&gt;</span>
<span id="L53"><span class="lineNum">      53</span>                 :             : #include &lt;univalue.h&gt;</span>
<span id="L54"><span class="lineNum">      54</span>                 :             : #include &lt;util/check.h&gt;</span>
<span id="L55"><span class="lineNum">      55</span>                 :             : #include &lt;util/fs.h&gt;</span>
<span id="L56"><span class="lineNum">      56</span>                 :             : #include &lt;util/fs_helpers.h&gt;</span>
<span id="L57"><span class="lineNum">      57</span>                 :             : #include &lt;util/moneystr.h&gt;</span>
<span id="L58"><span class="lineNum">      58</span>                 :             : #include &lt;util/result.h&gt;</span>
<span id="L59"><span class="lineNum">      59</span>                 :             : #include &lt;util/string.h&gt;</span>
<span id="L60"><span class="lineNum">      60</span>                 :             : #include &lt;util/time.h&gt;</span>
<span id="L61"><span class="lineNum">      61</span>                 :             : #include &lt;util/translation.h&gt;</span>
<span id="L62"><span class="lineNum">      62</span>                 :             : #include &lt;wallet/coincontrol.h&gt;</span>
<span id="L63"><span class="lineNum">      63</span>                 :             : #include &lt;wallet/context.h&gt;</span>
<span id="L64"><span class="lineNum">      64</span>                 :             : #include &lt;wallet/crypter.h&gt;</span>
<span id="L65"><span class="lineNum">      65</span>                 :             : #include &lt;wallet/db.h&gt;</span>
<span id="L66"><span class="lineNum">      66</span>                 :             : #include &lt;wallet/external_signer_scriptpubkeyman.h&gt;</span>
<span id="L67"><span class="lineNum">      67</span>                 :             : #include &lt;wallet/scriptpubkeyman.h&gt;</span>
<span id="L68"><span class="lineNum">      68</span>                 :             : #include &lt;wallet/transaction.h&gt;</span>
<span id="L69"><span class="lineNum">      69</span>                 :             : #include &lt;wallet/types.h&gt;</span>
<span id="L70"><span class="lineNum">      70</span>                 :             : #include &lt;wallet/walletdb.h&gt;</span>
<span id="L71"><span class="lineNum">      71</span>                 :             : #include &lt;wallet/walletutil.h&gt;</span>
<span id="L72"><span class="lineNum">      72</span>                 :             : </span>
<span id="L73"><span class="lineNum">      73</span>                 :             : #include &lt;algorithm&gt;</span>
<span id="L74"><span class="lineNum">      74</span>                 :             : #include &lt;cassert&gt;</span>
<span id="L75"><span class="lineNum">      75</span>                 :             : #include &lt;condition_variable&gt;</span>
<span id="L76"><span class="lineNum">      76</span>                 :             : #include &lt;exception&gt;</span>
<span id="L77"><span class="lineNum">      77</span>                 :             : #include &lt;optional&gt;</span>
<span id="L78"><span class="lineNum">      78</span>                 :             : #include &lt;stdexcept&gt;</span>
<span id="L79"><span class="lineNum">      79</span>                 :             : #include &lt;thread&gt;</span>
<span id="L80"><span class="lineNum">      80</span>                 :             : #include &lt;tuple&gt;</span>
<span id="L81"><span class="lineNum">      81</span>                 :             : #include &lt;variant&gt;</span>
<span id="L82"><span class="lineNum">      82</span>                 :             : </span>
<span id="L83"><span class="lineNum">      83</span>                 :             : struct KeyOriginInfo;</span>
<span id="L84"><span class="lineNum">      84</span>                 :             : </span>
<span id="L85"><span class="lineNum">      85</span>                 :             : using common::AmountErrMsg;</span>
<span id="L86"><span class="lineNum">      86</span>                 :             : using common::AmountHighWarn;</span>
<span id="L87"><span class="lineNum">      87</span>                 :             : using common::PSBTError;</span>
<span id="L88"><span class="lineNum">      88</span>                 :             : using interfaces::FoundBlock;</span>
<span id="L89"><span class="lineNum">      89</span>                 :             : using util::ReplaceAll;</span>
<span id="L90"><span class="lineNum">      90</span>                 :             : using util::ToString;</span>
<span id="L91"><span class="lineNum">      91</span>                 :             : </span>
<span id="L92"><span class="lineNum">      92</span>                 :             : namespace wallet {</span>
<span id="L93"><span class="lineNum">      93</span>                 :             : </span>
<span id="L94"><span class="lineNum">      94</span>                 :<span class="tlaUNC tlaBgUNC">           0 : bool AddWalletSetting(interfaces::Chain&amp; chain, const std::string&amp; wallet_name)</span></span>
<span id="L95"><span class="lineNum">      95</span>                 :             : {</span>
<span id="L96"><span class="lineNum">      96</span>                 :<span class="tlaUNC">           0 :     const auto update_function = [&amp;wallet_name](common::SettingsValue&amp; setting_value) {</span></span>
<span id="L97"><span class="lineNum">      97</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!setting_value.isArray()) setting_value.setArray();</span></span>
<span id="L98"><span class="lineNum">      98</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (const auto&amp; value : setting_value.getValues()) {</span></span>
<span id="L99"><span class="lineNum">      99</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (value.isStr() &amp;&amp; value.get_str() == wallet_name) return interfaces::SettingsAction::SKIP_WRITE;</span></span>
<span id="L100"><span class="lineNum">     100</span>                 :             :         }</span>
<span id="L101"><span class="lineNum">     101</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         setting_value.push_back(wallet_name);</span></span>
<span id="L102"><span class="lineNum">     102</span>                 :<span class="tlaUNC">           0 :         return interfaces::SettingsAction::WRITE;</span></span>
<span id="L103"><span class="lineNum">     103</span>                 :<span class="tlaUNC">           0 :     };</span></span>
<span id="L104"><span class="lineNum">     104</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     return chain.updateRwSetting(&quot;wallet&quot;, update_function);</span></span>
<span id="L105"><span class="lineNum">     105</span>                 :             : }</span>
<span id="L106"><span class="lineNum">     106</span>                 :             : </span>
<span id="L107"><span class="lineNum">     107</span>                 :<span class="tlaUNC">           0 : bool RemoveWalletSetting(interfaces::Chain&amp; chain, const std::string&amp; wallet_name)</span></span>
<span id="L108"><span class="lineNum">     108</span>                 :             : {</span>
<span id="L109"><span class="lineNum">     109</span>                 :<span class="tlaUNC">           0 :     const auto update_function = [&amp;wallet_name](common::SettingsValue&amp; setting_value) {</span></span>
<span id="L110"><span class="lineNum">     110</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!setting_value.isArray()) return interfaces::SettingsAction::SKIP_WRITE;</span></span>
<span id="L111"><span class="lineNum">     111</span>                 :<span class="tlaUNC">           0 :         common::SettingsValue new_value(common::SettingsValue::VARR);</span></span>
<span id="L112"><span class="lineNum">     112</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (const auto&amp; value : setting_value.getValues()) {</span></span>
<span id="L113"><span class="lineNum">     113</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             if (!value.isStr() || value.get_str() != wallet_name) new_value.push_back(value);</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not executed"> # </span>]
<span id="L114"><span class="lineNum">     114</span>                 :             :         }</span>
<span id="L115"><span class="lineNum">     115</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (new_value.size() == setting_value.size()) return interfaces::SettingsAction::SKIP_WRITE;</span></span>
<span id="L116"><span class="lineNum">     116</span>                 :<span class="tlaUNC">           0 :         setting_value = std::move(new_value);</span></span>
<span id="L117"><span class="lineNum">     117</span>                 :<span class="tlaUNC">           0 :         return interfaces::SettingsAction::WRITE;</span></span>
<span id="L118"><span class="lineNum">     118</span>                 :<span class="tlaUNC">           0 :     };</span></span>
<span id="L119"><span class="lineNum">     119</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     return chain.updateRwSetting(&quot;wallet&quot;, update_function);</span></span>
<span id="L120"><span class="lineNum">     120</span>                 :             : }</span>
<span id="L121"><span class="lineNum">     121</span>                 :             : </span>
<span id="L122"><span class="lineNum">     122</span>                 :<span class="tlaUNC">           0 : static void UpdateWalletSetting(interfaces::Chain&amp; chain,</span></span>
<span id="L123"><span class="lineNum">     123</span>                 :             :                                 const std::string&amp; wallet_name,</span>
<span id="L124"><span class="lineNum">     124</span>                 :             :                                 std::optional&lt;bool&gt; load_on_startup,</span>
<span id="L125"><span class="lineNum">     125</span>                 :             :                                 std::vector&lt;bilingual_str&gt;&amp; warnings)</span>
<span id="L126"><span class="lineNum">     126</span>                 :             : {</span>
<span id="L127"><span class="lineNum">     127</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!load_on_startup) return;</span></span>
<span id="L128"><span class="lineNum">     128</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (load_on_startup.value() &amp;&amp; !AddWalletSetting(chain, wallet_name)) {</span></span>
<span id="L129"><span class="lineNum">     129</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         warnings.emplace_back(Untranslated(&quot;Wallet load on startup setting could not be updated, so wallet may not be loaded next node startup.&quot;));</span></span>
<span id="L130"><span class="lineNum">     130</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     } else if (!load_on_startup.value() &amp;&amp; !RemoveWalletSetting(chain, wallet_name)) {</span></span>
<span id="L131"><span class="lineNum">     131</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         warnings.emplace_back(Untranslated(&quot;Wallet load on startup setting could not be updated, so wallet may still be loaded next node startup.&quot;));</span></span>
<span id="L132"><span class="lineNum">     132</span>                 :             :     }</span>
<span id="L133"><span class="lineNum">     133</span>                 :             : }</span>
<span id="L134"><span class="lineNum">     134</span>                 :             : </span>
<span id="L135"><span class="lineNum">     135</span>                 :             : /**</span>
<span id="L136"><span class="lineNum">     136</span>                 :             :  * Refresh mempool status so the wallet is in an internally consistent state and</span>
<span id="L137"><span class="lineNum">     137</span>                 :             :  * immediately knows the transaction's status: Whether it can be considered</span>
<span id="L138"><span class="lineNum">     138</span>                 :             :  * trusted and is eligible to be abandoned ...</span>
<span id="L139"><span class="lineNum">     139</span>                 :             :  */</span>
<span id="L140"><span class="lineNum">     140</span>                 :<span class="tlaUNC">           0 : static void RefreshMempoolStatus(CWalletTx&amp; tx, interfaces::Chain&amp; chain)</span></span>
<span id="L141"><span class="lineNum">     141</span>                 :             : {</span>
<span id="L142"><span class="lineNum">     142</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (chain.isInMempool(tx.GetHash())) {</span></span>
<span id="L143"><span class="lineNum">     143</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         tx.m_state = TxStateInMempool();</span></span>
<span id="L144"><span class="lineNum">     144</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     } else if (tx.state&lt;TxStateInMempool&gt;()) {</span></span>
<span id="L145"><span class="lineNum">     145</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         tx.m_state = TxStateInactive();</span></span>
<span id="L146"><span class="lineNum">     146</span>                 :             :     }</span>
<span id="L147"><span class="lineNum">     147</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L148"><span class="lineNum">     148</span>                 :             : </span>
<span id="L149"><span class="lineNum">     149</span>                 :<span class="tlaUNC">           0 : bool AddWallet(WalletContext&amp; context, const std::shared_ptr&lt;CWallet&gt;&amp; wallet)</span></span>
<span id="L150"><span class="lineNum">     150</span>                 :             : {</span>
<span id="L151"><span class="lineNum">     151</span>                 :<span class="tlaUNC">           0 :     LOCK(context.wallets_mutex);</span></span>
<span id="L152"><span class="lineNum">     152</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     assert(wallet);</span></span>
<span id="L153"><span class="lineNum">     153</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     std::vector&lt;std::shared_ptr&lt;CWallet&gt;&gt;::const_iterator i = std::find(context.wallets.begin(), context.wallets.end(), wallet);</span></span>
<span id="L154"><span class="lineNum">     154</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (i != context.wallets.end()) return false;</span></span>
<span id="L155"><span class="lineNum">     155</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     context.wallets.push_back(wallet);</span></span>
<span id="L156"><span class="lineNum">     156</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     wallet-&gt;ConnectScriptPubKeyManNotifiers();</span></span>
<span id="L157"><span class="lineNum">     157</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     wallet-&gt;NotifyCanGetAddressesChanged();</span></span>
<span id="L158"><span class="lineNum">     158</span>                 :             :     return true;</span>
<span id="L159"><span class="lineNum">     159</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L160"><span class="lineNum">     160</span>                 :             : </span>
<span id="L161"><span class="lineNum">     161</span>                 :<span class="tlaUNC">           0 : bool RemoveWallet(WalletContext&amp; context, const std::shared_ptr&lt;CWallet&gt;&amp; wallet, std::optional&lt;bool&gt; load_on_start, std::vector&lt;bilingual_str&gt;&amp; warnings)</span></span>
<span id="L162"><span class="lineNum">     162</span>                 :             : {</span>
<span id="L163"><span class="lineNum">     163</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     assert(wallet);</span></span>
<span id="L164"><span class="lineNum">     164</span>                 :             : </span>
<span id="L165"><span class="lineNum">     165</span>                 :<span class="tlaUNC">           0 :     interfaces::Chain&amp; chain = wallet-&gt;chain();</span></span>
<span id="L166"><span class="lineNum">     166</span>                 :<span class="tlaUNC">           0 :     std::string name = wallet-&gt;GetName();</span></span>
<span id="L167"><span class="lineNum">     167</span>                 :             : </span>
<span id="L168"><span class="lineNum">     168</span>                 :             :     // Unregister with the validation interface which also drops shared pointers.</span>
<span id="L169"><span class="lineNum">     169</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     wallet-&gt;m_chain_notifications_handler.reset();</span></span>
<span id="L170"><span class="lineNum">     170</span>                 :<span class="tlaUNC">           0 :     {</span></span>
<span id="L171"><span class="lineNum">     171</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LOCK(context.wallets_mutex);</span></span>
<span id="L172"><span class="lineNum">     172</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         std::vector&lt;std::shared_ptr&lt;CWallet&gt;&gt;::iterator i = std::find(context.wallets.begin(), context.wallets.end(), wallet);</span></span>
<span id="L173"><span class="lineNum">     173</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (i == context.wallets.end()) return false;</span></span>
<span id="L174"><span class="lineNum">     174</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         context.wallets.erase(i);</span></span>
<span id="L175"><span class="lineNum">     175</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L176"><span class="lineNum">     176</span>                 :             :     // Notify unload so that upper layers release the shared pointer.</span>
<span id="L177"><span class="lineNum">     177</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     wallet-&gt;NotifyUnload();</span></span>
<span id="L178"><span class="lineNum">     178</span>                 :             : </span>
<span id="L179"><span class="lineNum">     179</span>                 :             :     // Write the wallet setting</span>
<span id="L180"><span class="lineNum">     180</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     UpdateWalletSetting(chain, name, load_on_start, warnings);</span></span>
<span id="L181"><span class="lineNum">     181</span>                 :             : </span>
<span id="L182"><span class="lineNum">     182</span>                 :             :     return true;</span>
<span id="L183"><span class="lineNum">     183</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L184"><span class="lineNum">     184</span>                 :             : </span>
<span id="L185"><span class="lineNum">     185</span>                 :<span class="tlaUNC">           0 : bool RemoveWallet(WalletContext&amp; context, const std::shared_ptr&lt;CWallet&gt;&amp; wallet, std::optional&lt;bool&gt; load_on_start)</span></span>
<span id="L186"><span class="lineNum">     186</span>                 :             : {</span>
<span id="L187"><span class="lineNum">     187</span>                 :<span class="tlaUNC">           0 :     std::vector&lt;bilingual_str&gt; warnings;</span></span>
<span id="L188"><span class="lineNum">     188</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     return RemoveWallet(context, wallet, load_on_start, warnings);</span></span>
<span id="L189"><span class="lineNum">     189</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L190"><span class="lineNum">     190</span>                 :             : </span>
<span id="L191"><span class="lineNum">     191</span>                 :<span class="tlaUNC">           0 : std::vector&lt;std::shared_ptr&lt;CWallet&gt;&gt; GetWallets(WalletContext&amp; context)</span></span>
<span id="L192"><span class="lineNum">     192</span>                 :             : {</span>
<span id="L193"><span class="lineNum">     193</span>                 :<span class="tlaUNC">           0 :     LOCK(context.wallets_mutex);</span></span>
<span id="L194"><span class="lineNum">     194</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     return context.wallets;</span></span>
<span id="L195"><span class="lineNum">     195</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L196"><span class="lineNum">     196</span>                 :             : </span>
<span id="L197"><span class="lineNum">     197</span>                 :<span class="tlaUNC">           0 : std::shared_ptr&lt;CWallet&gt; GetDefaultWallet(WalletContext&amp; context, size_t&amp; count)</span></span>
<span id="L198"><span class="lineNum">     198</span>                 :             : {</span>
<span id="L199"><span class="lineNum">     199</span>                 :<span class="tlaUNC">           0 :     LOCK(context.wallets_mutex);</span></span>
<span id="L200"><span class="lineNum">     200</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     count = context.wallets.size();</span></span>
<span id="L201"><span class="lineNum">     201</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     return count == 1 ? context.wallets[0] : nullptr;</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L202"><span class="lineNum">     202</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L203"><span class="lineNum">     203</span>                 :             : </span>
<span id="L204"><span class="lineNum">     204</span>                 :<span class="tlaUNC">           0 : std::shared_ptr&lt;CWallet&gt; GetWallet(WalletContext&amp; context, const std::string&amp; name)</span></span>
<span id="L205"><span class="lineNum">     205</span>                 :             : {</span>
<span id="L206"><span class="lineNum">     206</span>                 :<span class="tlaUNC">           0 :     LOCK(context.wallets_mutex);</span></span>
<span id="L207"><span class="lineNum">     207</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (const std::shared_ptr&lt;CWallet&gt;&amp; wallet : context.wallets) {</span></span>
<span id="L208"><span class="lineNum">     208</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         if (wallet-&gt;GetName() == name) return wallet;</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L209"><span class="lineNum">     209</span>                 :             :     }</span>
<span id="L210"><span class="lineNum">     210</span>                 :<span class="tlaUNC">           0 :     return nullptr;</span></span>
<span id="L211"><span class="lineNum">     211</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L212"><span class="lineNum">     212</span>                 :             : </span>
<span id="L213"><span class="lineNum">     213</span>                 :<span class="tlaUNC">           0 : std::unique_ptr&lt;interfaces::Handler&gt; HandleLoadWallet(WalletContext&amp; context, LoadWalletFn load_wallet)</span></span>
<span id="L214"><span class="lineNum">     214</span>                 :             : {</span>
<span id="L215"><span class="lineNum">     215</span>                 :<span class="tlaUNC">           0 :     LOCK(context.wallets_mutex);</span></span>
<span id="L216"><span class="lineNum">     216</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     auto it = context.wallet_load_fns.emplace(context.wallet_load_fns.end(), std::move(load_wallet));</span></span>
<span id="L217"><span class="lineNum">     217</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     return interfaces::MakeCleanupHandler([&amp;context, it] { LOCK(context.wallets_mutex); context.wallet_load_fns.erase(it); });</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L218"><span class="lineNum">     218</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L219"><span class="lineNum">     219</span>                 :             : </span>
<span id="L220"><span class="lineNum">     220</span>                 :<span class="tlaUNC">           0 : void NotifyWalletLoaded(WalletContext&amp; context, const std::shared_ptr&lt;CWallet&gt;&amp; wallet)</span></span>
<span id="L221"><span class="lineNum">     221</span>                 :             : {</span>
<span id="L222"><span class="lineNum">     222</span>                 :<span class="tlaUNC">           0 :     LOCK(context.wallets_mutex);</span></span>
<span id="L223"><span class="lineNum">     223</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (auto&amp; load_wallet : context.wallet_load_fns) {</span></span>
<span id="L224"><span class="lineNum">     224</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         load_wallet(interfaces::MakeWallet(context, wallet));</span></span>
<span id="L225"><span class="lineNum">     225</span>                 :             :     }</span>
<span id="L226"><span class="lineNum">     226</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L227"><span class="lineNum">     227</span>                 :             : </span>
<span id="L228"><span class="lineNum">     228</span>                 :             : static GlobalMutex g_loading_wallet_mutex;</span>
<span id="L229"><span class="lineNum">     229</span>                 :             : static GlobalMutex g_wallet_release_mutex;</span>
<span id="L230"><span class="lineNum">     230</span>                 :             : static std::condition_variable g_wallet_release_cv;</span>
<span id="L231"><span class="lineNum">     231</span>                 :             : static std::set&lt;std::string&gt; g_loading_wallet_set GUARDED_BY(g_loading_wallet_mutex);</span>
<span id="L232"><span class="lineNum">     232</span>                 :             : static std::set&lt;std::string&gt; g_unloading_wallet_set GUARDED_BY(g_wallet_release_mutex);</span>
<span id="L233"><span class="lineNum">     233</span>                 :             : </span>
<span id="L234"><span class="lineNum">     234</span>                 :             : // Custom deleter for shared_ptr&lt;CWallet&gt;.</span>
<span id="L235"><span class="lineNum">     235</span>                 :<span class="tlaUNC">           0 : static void FlushAndDeleteWallet(CWallet* wallet)</span></span>
<span id="L236"><span class="lineNum">     236</span>                 :             : {</span>
<span id="L237"><span class="lineNum">     237</span>                 :<span class="tlaUNC">           0 :     const std::string name = wallet-&gt;GetName();</span></span>
<span id="L238"><span class="lineNum">     238</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     wallet-&gt;WalletLogPrintf(&quot;Releasing wallet %s..\n&quot;, name);</span></span>
<span id="L239"><span class="lineNum">     239</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     wallet-&gt;Flush();</span></span>
<span id="L240"><span class="lineNum">     240</span>                 :<span class="tlaUNC">           0 :     delete wallet;</span></span>
<span id="L241"><span class="lineNum">     241</span>                 :             :     // Wallet is now released, notify WaitForDeleteWallet, if any.</span>
<span id="L242"><span class="lineNum">     242</span>                 :<span class="tlaUNC">           0 :     {</span></span>
<span id="L243"><span class="lineNum">     243</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LOCK(g_wallet_release_mutex);</span></span>
<span id="L244"><span class="lineNum">     244</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (g_unloading_wallet_set.erase(name) == 0) {</span></span>
<span id="L245"><span class="lineNum">     245</span>                 :             :             // WaitForDeleteWallet was not called for this wallet, all done.</span>
<span id="L246"><span class="lineNum">     246</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             return;</span></span>
<span id="L247"><span class="lineNum">     247</span>                 :             :         }</span>
<span id="L248"><span class="lineNum">     248</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L249"><span class="lineNum">     249</span>                 :<span class="tlaUNC">           0 :     g_wallet_release_cv.notify_all();</span></span>
<span id="L250"><span class="lineNum">     250</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L251"><span class="lineNum">     251</span>                 :             : </span>
<span id="L252"><span class="lineNum">     252</span>                 :<span class="tlaUNC">           0 : void WaitForDeleteWallet(std::shared_ptr&lt;CWallet&gt;&amp;&amp; wallet)</span></span>
<span id="L253"><span class="lineNum">     253</span>                 :             : {</span>
<span id="L254"><span class="lineNum">     254</span>                 :             :     // Mark wallet for unloading.</span>
<span id="L255"><span class="lineNum">     255</span>                 :<span class="tlaUNC">           0 :     const std::string name = wallet-&gt;GetName();</span></span>
<span id="L256"><span class="lineNum">     256</span>                 :<span class="tlaUNC">           0 :     {</span></span>
<span id="L257"><span class="lineNum">     257</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LOCK(g_wallet_release_mutex);</span></span>
<span id="L258"><span class="lineNum">     258</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         g_unloading_wallet_set.insert(name);</span></span>
<span id="L259"><span class="lineNum">     259</span>                 :             :         // Do not expect to be the only one removing this wallet.</span>
<span id="L260"><span class="lineNum">     260</span>                 :             :         // Multiple threads could simultaneously be waiting for deletion.</span>
<span id="L261"><span class="lineNum">     261</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L262"><span class="lineNum">     262</span>                 :             : </span>
<span id="L263"><span class="lineNum">     263</span>                 :             :     // Time to ditch our shared_ptr and wait for FlushAndDeleteWallet call.</span>
<span id="L264"><span class="lineNum">     264</span>                 :<span class="tlaUNC">           0 :     wallet.reset();</span></span>
<span id="L265"><span class="lineNum">     265</span>                 :<span class="tlaUNC">           0 :     {</span></span>
<span id="L266"><span class="lineNum">     266</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         WAIT_LOCK(g_wallet_release_mutex, lock);</span></span>
<span id="L267"><span class="lineNum">     267</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         while (g_unloading_wallet_set.count(name) == 1) {</span></span>
<span id="L268"><span class="lineNum">     268</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             g_wallet_release_cv.wait(lock);</span></span>
<span id="L269"><span class="lineNum">     269</span>                 :             :         }</span>
<span id="L270"><span class="lineNum">     270</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L271"><span class="lineNum">     271</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L272"><span class="lineNum">     272</span>                 :             : </span>
<span id="L273"><span class="lineNum">     273</span>                 :             : namespace {</span>
<span id="L274"><span class="lineNum">     274</span>                 :<span class="tlaUNC">           0 : std::shared_ptr&lt;CWallet&gt; LoadWalletInternal(WalletContext&amp; context, const std::string&amp; name, std::optional&lt;bool&gt; load_on_start, const DatabaseOptions&amp; options, DatabaseStatus&amp; status, bilingual_str&amp; error, std::vector&lt;bilingual_str&gt;&amp; warnings)</span></span>
<span id="L275"><span class="lineNum">     275</span>                 :             : {</span>
<span id="L276"><span class="lineNum">     276</span>                 :<span class="tlaUNC">           0 :     try {</span></span>
<span id="L277"><span class="lineNum">     277</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         std::unique_ptr&lt;WalletDatabase&gt; database = MakeWalletDatabase(name, options, status, error);</span></span>
<span id="L278"><span class="lineNum">     278</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!database) {</span></span>
<span id="L279"><span class="lineNum">     279</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             error = Untranslated(&quot;Wallet file verification failed.&quot;) + Untranslated(&quot; &quot;) + error;</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not executed"> # </span>]
<span id="L280"><span class="lineNum">     280</span>                 :<span class="tlaUNC">           0 :             return nullptr;</span></span>
<span id="L281"><span class="lineNum">     281</span>                 :             :         }</span>
<span id="L282"><span class="lineNum">     282</span>                 :             : </span>
<span id="L283"><span class="lineNum">     283</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         context.chain-&gt;initMessage(_(&quot;Loading wallet&quot;).translated);</span></span>
<span id="L284"><span class="lineNum">     284</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         std::shared_ptr&lt;CWallet&gt; wallet = CWallet::Create(context, name, std::move(database), options.create_flags, error, warnings);</span></span>
<span id="L285"><span class="lineNum">     285</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!wallet) {</span></span>
<span id="L286"><span class="lineNum">     286</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             error = Untranslated(&quot;Wallet loading failed.&quot;) + Untranslated(&quot; &quot;) + error;</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not executed"> # </span>]
<span id="L287"><span class="lineNum">     287</span>                 :<span class="tlaUNC">           0 :             status = DatabaseStatus::FAILED_LOAD;</span></span>
<span id="L288"><span class="lineNum">     288</span>                 :<span class="tlaUNC">           0 :             return nullptr;</span></span>
<span id="L289"><span class="lineNum">     289</span>                 :             :         }</span>
<span id="L290"><span class="lineNum">     290</span>                 :             : </span>
<span id="L291"><span class="lineNum">     291</span>                 :             :         // Legacy wallets are being deprecated, warn if the loaded wallet is legacy</span>
<span id="L292"><span class="lineNum">     292</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!wallet-&gt;IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {</span></span>
<span id="L293"><span class="lineNum">     293</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             warnings.push_back(_(&quot;Wallet loaded successfully. The legacy wallet type is being deprecated and support for creating and opening legacy wallets will be removed in the future. Legacy wallets can be migrated to a descriptor wallet with migratewallet.&quot;));</span></span>
<span id="L294"><span class="lineNum">     294</span>                 :             :         }</span>
<span id="L295"><span class="lineNum">     295</span>                 :             : </span>
<span id="L296"><span class="lineNum">     296</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         NotifyWalletLoaded(context, wallet);</span></span>
<span id="L297"><span class="lineNum">     297</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         AddWallet(context, wallet);</span></span>
<span id="L298"><span class="lineNum">     298</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         wallet-&gt;postInitProcess();</span></span>
<span id="L299"><span class="lineNum">     299</span>                 :             : </span>
<span id="L300"><span class="lineNum">     300</span>                 :             :         // Write the wallet setting</span>
<span id="L301"><span class="lineNum">     301</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         UpdateWalletSetting(*context.chain, name, load_on_start, warnings);</span></span>
<span id="L302"><span class="lineNum">     302</span>                 :             : </span>
<span id="L303"><span class="lineNum">     303</span>                 :<span class="tlaUNC">           0 :         return wallet;</span></span>
<span id="L304"><span class="lineNum">     304</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     } catch (const std::runtime_error&amp; e) {</span></span>
<span id="L305"><span class="lineNum">     305</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaUNC">           0 :         error = Untranslated(e.what());</span></span>
<span id="L306"><span class="lineNum">     306</span>                 :<span class="tlaUNC">           0 :         status = DatabaseStatus::FAILED_LOAD;</span></span>
<span id="L307"><span class="lineNum">     307</span>                 :<span class="tlaUNC">           0 :         return nullptr;</span></span>
<span id="L308"><span class="lineNum">     308</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L309"><span class="lineNum">     309</span>                 :             : }</span>
<span id="L310"><span class="lineNum">     310</span>                 :             : </span>
<span id="L311"><span class="lineNum">     311</span>                 :             : class FastWalletRescanFilter</span>
<span id="L312"><span class="lineNum">     312</span>                 :             : {</span>
<span id="L313"><span class="lineNum">     313</span>                 :             : public:</span>
<span id="L314"><span class="lineNum">     314</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     FastWalletRescanFilter(const CWallet&amp; wallet) : m_wallet(wallet)</span></span>
<span id="L315"><span class="lineNum">     315</span>                 :             :     {</span>
<span id="L316"><span class="lineNum">     316</span>                 :             :         // fast rescanning via block filters is only supported by descriptor wallets right now</span>
<span id="L317"><span class="lineNum">     317</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         assert(!m_wallet.IsLegacy());</span></span>
<span id="L318"><span class="lineNum">     318</span>                 :             : </span>
<span id="L319"><span class="lineNum">     319</span>                 :             :         // create initial filter with scripts from all ScriptPubKeyMans</span>
<span id="L320"><span class="lineNum">     320</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (auto spkm : m_wallet.GetAllScriptPubKeyMans()) {</span></span>
<span id="L321"><span class="lineNum">     321</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             auto desc_spkm{dynamic_cast&lt;DescriptorScriptPubKeyMan*&gt;(spkm)};</span></span>
<span id="L322"><span class="lineNum">     322</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             assert(desc_spkm != nullptr);</span></span>
<span id="L323"><span class="lineNum">     323</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             AddScriptPubKeys(desc_spkm);</span></span>
<span id="L324"><span class="lineNum">     324</span>                 :             :             // save each range descriptor's end for possible future filter updates</span>
<span id="L325"><span class="lineNum">     325</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (desc_spkm-&gt;IsHDEnabled()) {</span></span>
<span id="L326"><span class="lineNum">     326</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                 m_last_range_ends.emplace(desc_spkm-&gt;GetID(), desc_spkm-&gt;GetEndRange());</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L327"><span class="lineNum">     327</span>                 :             :             }</span>
<span id="L328"><span class="lineNum">     328</span>                 :<span class="tlaUNC">           0 :         }</span></span>
<span id="L329"><span class="lineNum">     329</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L330"><span class="lineNum">     330</span>                 :             : </span>
<span id="L331"><span class="lineNum">     331</span>                 :<span class="tlaUNC">           0 :     void UpdateIfNeeded()</span></span>
<span id="L332"><span class="lineNum">     332</span>                 :             :     {</span>
<span id="L333"><span class="lineNum">     333</span>                 :             :         // repopulate filter with new scripts if top-up has happened since last iteration</span>
<span id="L334"><span class="lineNum">     334</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (const auto&amp; [desc_spkm_id, last_range_end] : m_last_range_ends) {</span></span>
<span id="L335"><span class="lineNum">     335</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             auto desc_spkm{dynamic_cast&lt;DescriptorScriptPubKeyMan*&gt;(m_wallet.GetScriptPubKeyMan(desc_spkm_id))};</span></span>
<span id="L336"><span class="lineNum">     336</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             assert(desc_spkm != nullptr);</span></span>
<span id="L337"><span class="lineNum">     337</span>                 :<span class="tlaUNC">           0 :             int32_t current_range_end{desc_spkm-&gt;GetEndRange()};</span></span>
<span id="L338"><span class="lineNum">     338</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (current_range_end &gt; last_range_end) {</span></span>
<span id="L339"><span class="lineNum">     339</span>                 :<span class="tlaUNC">           0 :                 AddScriptPubKeys(desc_spkm, last_range_end);</span></span>
<span id="L340"><span class="lineNum">     340</span>                 :<span class="tlaUNC">           0 :                 m_last_range_ends.at(desc_spkm-&gt;GetID()) = current_range_end;</span></span>
<span id="L341"><span class="lineNum">     341</span>                 :             :             }</span>
<span id="L342"><span class="lineNum">     342</span>                 :             :         }</span>
<span id="L343"><span class="lineNum">     343</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L344"><span class="lineNum">     344</span>                 :             : </span>
<span id="L345"><span class="lineNum">     345</span>                 :<span class="tlaUNC">           0 :     std::optional&lt;bool&gt; MatchesBlock(const uint256&amp; block_hash) const</span></span>
<span id="L346"><span class="lineNum">     346</span>                 :             :     {</span>
<span id="L347"><span class="lineNum">     347</span>                 :<span class="tlaUNC">           0 :         return m_wallet.chain().blockFilterMatchesAny(BlockFilterType::BASIC, block_hash, m_filter_set);</span></span>
<span id="L348"><span class="lineNum">     348</span>                 :             :     }</span>
<span id="L349"><span class="lineNum">     349</span>                 :             : </span>
<span id="L350"><span class="lineNum">     350</span>                 :             : private:</span>
<span id="L351"><span class="lineNum">     351</span>                 :             :     const CWallet&amp; m_wallet;</span>
<span id="L352"><span class="lineNum">     352</span>                 :             :     /** Map for keeping track of each range descriptor's last seen end range.</span>
<span id="L353"><span class="lineNum">     353</span>                 :             :       * This information is used to detect whether new addresses were derived</span>
<span id="L354"><span class="lineNum">     354</span>                 :             :       * (that is, if the current end range is larger than the saved end range)</span>
<span id="L355"><span class="lineNum">     355</span>                 :             :       * after processing a block and hence a filter set update is needed to</span>
<span id="L356"><span class="lineNum">     356</span>                 :             :       * take possible keypool top-ups into account.</span>
<span id="L357"><span class="lineNum">     357</span>                 :             :       */</span>
<span id="L358"><span class="lineNum">     358</span>                 :             :     std::map&lt;uint256, int32_t&gt; m_last_range_ends;</span>
<span id="L359"><span class="lineNum">     359</span>                 :             :     GCSFilter::ElementSet m_filter_set;</span>
<span id="L360"><span class="lineNum">     360</span>                 :             : </span>
<span id="L361"><span class="lineNum">     361</span>                 :<span class="tlaUNC">           0 :     void AddScriptPubKeys(const DescriptorScriptPubKeyMan* desc_spkm, int32_t last_range_end = 0)</span></span>
<span id="L362"><span class="lineNum">     362</span>                 :             :     {</span>
<span id="L363"><span class="lineNum">     363</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (const auto&amp; script_pub_key : desc_spkm-&gt;GetScriptPubKeys(last_range_end)) {</span></span>
<span id="L364"><span class="lineNum">     364</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());</span></span>
<span id="L365"><span class="lineNum">     365</span>                 :<span class="tlaUNC">           0 :         }</span></span>
<span id="L366"><span class="lineNum">     366</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L367"><span class="lineNum">     367</span>                 :             : };</span>
<span id="L368"><span class="lineNum">     368</span>                 :             : } // namespace</span>
<span id="L369"><span class="lineNum">     369</span>                 :             : </span>
<span id="L370"><span class="lineNum">     370</span>                 :<span class="tlaUNC">           0 : std::shared_ptr&lt;CWallet&gt; LoadWallet(WalletContext&amp; context, const std::string&amp; name, std::optional&lt;bool&gt; load_on_start, const DatabaseOptions&amp; options, DatabaseStatus&amp; status, bilingual_str&amp; error, std::vector&lt;bilingual_str&gt;&amp; warnings)</span></span>
<span id="L371"><span class="lineNum">     371</span>                 :             : {</span>
<span id="L372"><span class="lineNum">     372</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     auto result = WITH_LOCK(g_loading_wallet_mutex, return g_loading_wallet_set.insert(name));</span></span>
<span id="L373"><span class="lineNum">     373</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!result.second) {</span></span>
<span id="L374"><span class="lineNum">     374</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         error = Untranslated(&quot;Wallet already loading.&quot;);</span></span>
<span id="L375"><span class="lineNum">     375</span>                 :<span class="tlaUNC">           0 :         status = DatabaseStatus::FAILED_LOAD;</span></span>
<span id="L376"><span class="lineNum">     376</span>                 :<span class="tlaUNC">           0 :         return nullptr;</span></span>
<span id="L377"><span class="lineNum">     377</span>                 :             :     }</span>
<span id="L378"><span class="lineNum">     378</span>                 :<span class="tlaUNC">           0 :     auto wallet = LoadWalletInternal(context, name, load_on_start, options, status, error, warnings);</span></span>
<span id="L379"><span class="lineNum">     379</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     WITH_LOCK(g_loading_wallet_mutex, g_loading_wallet_set.erase(result.first));</span></span>
<span id="L380"><span class="lineNum">     380</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     return wallet;</span></span>
<span id="L381"><span class="lineNum">     381</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L382"><span class="lineNum">     382</span>                 :             : </span>
<span id="L383"><span class="lineNum">     383</span>                 :<span class="tlaUNC">           0 : std::shared_ptr&lt;CWallet&gt; CreateWallet(WalletContext&amp; context, const std::string&amp; name, std::optional&lt;bool&gt; load_on_start, DatabaseOptions&amp; options, DatabaseStatus&amp; status, bilingual_str&amp; error, std::vector&lt;bilingual_str&gt;&amp; warnings)</span></span>
<span id="L384"><span class="lineNum">     384</span>                 :             : {</span>
<span id="L385"><span class="lineNum">     385</span>                 :<span class="tlaUNC">           0 :     uint64_t wallet_creation_flags = options.create_flags;</span></span>
<span id="L386"><span class="lineNum">     386</span>                 :<span class="tlaUNC">           0 :     const SecureString&amp; passphrase = options.create_passphrase;</span></span>
<span id="L387"><span class="lineNum">     387</span>                 :             : </span>
<span id="L388"><span class="lineNum">     388</span>                 :<span class="tlaUNC">           0 :     ArgsManager&amp; args = *Assert(context.args);</span></span>
<span id="L389"><span class="lineNum">     389</span>                 :             : </span>
<span id="L390"><span class="lineNum">     390</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (wallet_creation_flags &amp; WALLET_FLAG_DESCRIPTORS) options.require_format = DatabaseFormat::SQLITE;</span></span>
<span id="L391"><span class="lineNum">     391</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     else if (args.GetBoolArg(&quot;-swapbdbendian&quot;, false)) {</span></span>
<span id="L392"><span class="lineNum">     392</span>                 :<span class="tlaUNC">           0 :         options.require_format = DatabaseFormat::BERKELEY_SWAP;</span></span>
<span id="L393"><span class="lineNum">     393</span>                 :             :     }</span>
<span id="L394"><span class="lineNum">     394</span>                 :             : </span>
<span id="L395"><span class="lineNum">     395</span>                 :             :     // Indicate that the wallet is actually supposed to be blank and not just blank to make it encrypted</span>
<span id="L396"><span class="lineNum">     396</span>                 :<span class="tlaUNC">           0 :     bool create_blank = (wallet_creation_flags &amp; WALLET_FLAG_BLANK_WALLET);</span></span>
<span id="L397"><span class="lineNum">     397</span>                 :             : </span>
<span id="L398"><span class="lineNum">     398</span>                 :             :     // Born encrypted wallets need to be created blank first.</span>
<span id="L399"><span class="lineNum">     399</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!passphrase.empty()) {</span></span>
<span id="L400"><span class="lineNum">     400</span>                 :<span class="tlaUNC">           0 :         wallet_creation_flags |= WALLET_FLAG_BLANK_WALLET;</span></span>
<span id="L401"><span class="lineNum">     401</span>                 :             :     }</span>
<span id="L402"><span class="lineNum">     402</span>                 :             : </span>
<span id="L403"><span class="lineNum">     403</span>                 :             :     // Private keys must be disabled for an external signer wallet</span>
<span id="L404"><span class="lineNum">     404</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if ((wallet_creation_flags &amp; WALLET_FLAG_EXTERNAL_SIGNER) &amp;&amp; !(wallet_creation_flags &amp; WALLET_FLAG_DISABLE_PRIVATE_KEYS)) {</span></span>
<span id="L405"><span class="lineNum">     405</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         error = Untranslated(&quot;Private keys must be disabled when using an external signer&quot;);</span></span>
<span id="L406"><span class="lineNum">     406</span>                 :<span class="tlaUNC">           0 :         status = DatabaseStatus::FAILED_CREATE;</span></span>
<span id="L407"><span class="lineNum">     407</span>                 :<span class="tlaUNC">           0 :         return nullptr;</span></span>
<span id="L408"><span class="lineNum">     408</span>                 :             :     }</span>
<span id="L409"><span class="lineNum">     409</span>                 :             : </span>
<span id="L410"><span class="lineNum">     410</span>                 :             :     // Descriptor support must be enabled for an external signer wallet</span>
<span id="L411"><span class="lineNum">     411</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if ((wallet_creation_flags &amp; WALLET_FLAG_EXTERNAL_SIGNER) &amp;&amp; !(wallet_creation_flags &amp; WALLET_FLAG_DESCRIPTORS)) {</span></span>
<span id="L412"><span class="lineNum">     412</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         error = Untranslated(&quot;Descriptor support must be enabled when using an external signer&quot;);</span></span>
<span id="L413"><span class="lineNum">     413</span>                 :<span class="tlaUNC">           0 :         status = DatabaseStatus::FAILED_CREATE;</span></span>
<span id="L414"><span class="lineNum">     414</span>                 :<span class="tlaUNC">           0 :         return nullptr;</span></span>
<span id="L415"><span class="lineNum">     415</span>                 :             :     }</span>
<span id="L416"><span class="lineNum">     416</span>                 :             : </span>
<span id="L417"><span class="lineNum">     417</span>                 :             :     // Do not allow a passphrase when private keys are disabled</span>
<span id="L418"><span class="lineNum">     418</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!passphrase.empty() &amp;&amp; (wallet_creation_flags &amp; WALLET_FLAG_DISABLE_PRIVATE_KEYS)) {</span></span>
<span id="L419"><span class="lineNum">     419</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         error = Untranslated(&quot;Passphrase provided but private keys are disabled. A passphrase is only used to encrypt private keys, so cannot be used for wallets with private keys disabled.&quot;);</span></span>
<span id="L420"><span class="lineNum">     420</span>                 :<span class="tlaUNC">           0 :         status = DatabaseStatus::FAILED_CREATE;</span></span>
<span id="L421"><span class="lineNum">     421</span>                 :<span class="tlaUNC">           0 :         return nullptr;</span></span>
<span id="L422"><span class="lineNum">     422</span>                 :             :     }</span>
<span id="L423"><span class="lineNum">     423</span>                 :             : </span>
<span id="L424"><span class="lineNum">     424</span>                 :             :     // Wallet::Verify will check if we're trying to create a wallet with a duplicate name.</span>
<span id="L425"><span class="lineNum">     425</span>                 :<span class="tlaUNC">           0 :     std::unique_ptr&lt;WalletDatabase&gt; database = MakeWalletDatabase(name, options, status, error);</span></span>
<span id="L426"><span class="lineNum">     426</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!database) {</span></span>
<span id="L427"><span class="lineNum">     427</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         error = Untranslated(&quot;Wallet file verification failed.&quot;) + Untranslated(&quot; &quot;) + error;</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not executed"> # </span>]
<span id="L428"><span class="lineNum">     428</span>                 :<span class="tlaUNC">           0 :         status = DatabaseStatus::FAILED_VERIFY;</span></span>
<span id="L429"><span class="lineNum">     429</span>                 :<span class="tlaUNC">           0 :         return nullptr;</span></span>
<span id="L430"><span class="lineNum">     430</span>                 :             :     }</span>
<span id="L431"><span class="lineNum">     431</span>                 :             : </span>
<span id="L432"><span class="lineNum">     432</span>                 :             :     // Make the wallet</span>
<span id="L433"><span class="lineNum">     433</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     context.chain-&gt;initMessage(_(&quot;Loading wallet&quot;).translated);</span></span>
<span id="L434"><span class="lineNum">     434</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     std::shared_ptr&lt;CWallet&gt; wallet = CWallet::Create(context, name, std::move(database), wallet_creation_flags, error, warnings);</span></span>
<span id="L435"><span class="lineNum">     435</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!wallet) {</span></span>
<span id="L436"><span class="lineNum">     436</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         error = Untranslated(&quot;Wallet creation failed.&quot;) + Untranslated(&quot; &quot;) + error;</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not executed"> # </span>]
<span id="L437"><span class="lineNum">     437</span>                 :<span class="tlaUNC">           0 :         status = DatabaseStatus::FAILED_CREATE;</span></span>
<span id="L438"><span class="lineNum">     438</span>                 :<span class="tlaUNC">           0 :         return nullptr;</span></span>
<span id="L439"><span class="lineNum">     439</span>                 :             :     }</span>
<span id="L440"><span class="lineNum">     440</span>                 :             : </span>
<span id="L441"><span class="lineNum">     441</span>                 :             :     // Encrypt the wallet</span>
<span id="L442"><span class="lineNum">     442</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!passphrase.empty() &amp;&amp; !(wallet_creation_flags &amp; WALLET_FLAG_DISABLE_PRIVATE_KEYS)) {</span></span>
<span id="L443"><span class="lineNum">     443</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!wallet-&gt;EncryptWallet(passphrase)) {</span></span>
<span id="L444"><span class="lineNum">     444</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             error = Untranslated(&quot;Error: Wallet created but failed to encrypt.&quot;);</span></span>
<span id="L445"><span class="lineNum">     445</span>                 :<span class="tlaUNC">           0 :             status = DatabaseStatus::FAILED_ENCRYPT;</span></span>
<span id="L446"><span class="lineNum">     446</span>                 :<span class="tlaUNC">           0 :             return nullptr;</span></span>
<span id="L447"><span class="lineNum">     447</span>                 :             :         }</span>
<span id="L448"><span class="lineNum">     448</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!create_blank) {</span></span>
<span id="L449"><span class="lineNum">     449</span>                 :             :             // Unlock the wallet</span>
<span id="L450"><span class="lineNum">     450</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (!wallet-&gt;Unlock(passphrase)) {</span></span>
<span id="L451"><span class="lineNum">     451</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 error = Untranslated(&quot;Error: Wallet was encrypted but could not be unlocked&quot;);</span></span>
<span id="L452"><span class="lineNum">     452</span>                 :<span class="tlaUNC">           0 :                 status = DatabaseStatus::FAILED_ENCRYPT;</span></span>
<span id="L453"><span class="lineNum">     453</span>                 :<span class="tlaUNC">           0 :                 return nullptr;</span></span>
<span id="L454"><span class="lineNum">     454</span>                 :             :             }</span>
<span id="L455"><span class="lineNum">     455</span>                 :             : </span>
<span id="L456"><span class="lineNum">     456</span>                 :             :             // Set a seed for the wallet</span>
<span id="L457"><span class="lineNum">     457</span>                 :<span class="tlaUNC">           0 :             {</span></span>
<span id="L458"><span class="lineNum">     458</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 LOCK(wallet-&gt;cs_wallet);</span></span>
<span id="L459"><span class="lineNum">     459</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 if (wallet-&gt;IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {</span></span>
<span id="L460"><span class="lineNum">     460</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     wallet-&gt;SetupDescriptorScriptPubKeyMans();</span></span>
<span id="L461"><span class="lineNum">     461</span>                 :             :                 } else {</span>
<span id="L462"><span class="lineNum">     462</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     for (auto spk_man : wallet-&gt;GetActiveScriptPubKeyMans()) {</span></span>
<span id="L463"><span class="lineNum">     463</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                         if (!spk_man-&gt;SetupGeneration()) {</span></span>
<span id="L464"><span class="lineNum">     464</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                             error = Untranslated(&quot;Unable to generate initial keys&quot;);</span></span>
<span id="L465"><span class="lineNum">     465</span>                 :<span class="tlaUNC">           0 :                             status = DatabaseStatus::FAILED_CREATE;</span></span>
<span id="L466"><span class="lineNum">     466</span>                 :<span class="tlaUNC">           0 :                             return nullptr;</span></span>
<span id="L467"><span class="lineNum">     467</span>                 :             :                         }</span>
<span id="L468"><span class="lineNum">     468</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     }</span></span>
<span id="L469"><span class="lineNum">     469</span>                 :             :                 }</span>
<span id="L470"><span class="lineNum">     470</span>                 :<span class="tlaUNC">           0 :             }</span></span>
<span id="L471"><span class="lineNum">     471</span>                 :             : </span>
<span id="L472"><span class="lineNum">     472</span>                 :             :             // Relock the wallet</span>
<span id="L473"><span class="lineNum">     473</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             wallet-&gt;Lock();</span></span>
<span id="L474"><span class="lineNum">     474</span>                 :             :         }</span>
<span id="L475"><span class="lineNum">     475</span>                 :             :     }</span>
<span id="L476"><span class="lineNum">     476</span>                 :             : </span>
<span id="L477"><span class="lineNum">     477</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     NotifyWalletLoaded(context, wallet);</span></span>
<span id="L478"><span class="lineNum">     478</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     AddWallet(context, wallet);</span></span>
<span id="L479"><span class="lineNum">     479</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     wallet-&gt;postInitProcess();</span></span>
<span id="L480"><span class="lineNum">     480</span>                 :             : </span>
<span id="L481"><span class="lineNum">     481</span>                 :             :     // Write the wallet settings</span>
<span id="L482"><span class="lineNum">     482</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     UpdateWalletSetting(*context.chain, name, load_on_start, warnings);</span></span>
<span id="L483"><span class="lineNum">     483</span>                 :             : </span>
<span id="L484"><span class="lineNum">     484</span>                 :             :     // Legacy wallets are being deprecated, warn if a newly created wallet is legacy</span>
<span id="L485"><span class="lineNum">     485</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!(wallet_creation_flags &amp; WALLET_FLAG_DESCRIPTORS)) {</span></span>
<span id="L486"><span class="lineNum">     486</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         warnings.push_back(_(&quot;Wallet created successfully. The legacy wallet type is being deprecated and support for creating and opening legacy wallets will be removed in the future.&quot;));</span></span>
<span id="L487"><span class="lineNum">     487</span>                 :             :     }</span>
<span id="L488"><span class="lineNum">     488</span>                 :             : </span>
<span id="L489"><span class="lineNum">     489</span>                 :<span class="tlaUNC">           0 :     status = DatabaseStatus::SUCCESS;</span></span>
<span id="L490"><span class="lineNum">     490</span>                 :<span class="tlaUNC">           0 :     return wallet;</span></span>
<span id="L491"><span class="lineNum">     491</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L492"><span class="lineNum">     492</span>                 :             : </span>
<span id="L493"><span class="lineNum">     493</span>                 :<span class="tlaUNC">           0 : std::shared_ptr&lt;CWallet&gt; RestoreWallet(WalletContext&amp; context, const fs::path&amp; backup_file, const std::string&amp; wallet_name, std::optional&lt;bool&gt; load_on_start, DatabaseStatus&amp; status, bilingual_str&amp; error, std::vector&lt;bilingual_str&gt;&amp; warnings)</span></span>
<span id="L494"><span class="lineNum">     494</span>                 :             : {</span>
<span id="L495"><span class="lineNum">     495</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     DatabaseOptions options;</span></span>
<span id="L496"><span class="lineNum">     496</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     ReadDatabaseArgs(*context.args, options);</span></span>
<span id="L497"><span class="lineNum">     497</span>                 :<span class="tlaUNC">           0 :     options.require_existing = true;</span></span>
<span id="L498"><span class="lineNum">     498</span>                 :             : </span>
<span id="L499"><span class="lineNum">     499</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     const fs::path wallet_path = fsbridge::AbsPathJoin(GetWalletDir(), fs::u8path(wallet_name));</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L500"><span class="lineNum">     500</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     auto wallet_file = wallet_path / &quot;wallet.dat&quot;;</span></span>
<span id="L501"><span class="lineNum">     501</span>                 :<span class="tlaUNC">           0 :     std::shared_ptr&lt;CWallet&gt; wallet;</span></span>
<span id="L502"><span class="lineNum">     502</span>                 :             : </span>
<span id="L503"><span class="lineNum">     503</span>                 :<span class="tlaUNC">           0 :     try {</span></span>
<span id="L504"><span class="lineNum">     504</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!fs::exists(backup_file)) {</span></span>
<span id="L505"><span class="lineNum">     505</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             error = Untranslated(&quot;Backup file does not exist&quot;);</span></span>
<span id="L506"><span class="lineNum">     506</span>                 :<span class="tlaUNC">           0 :             status = DatabaseStatus::FAILED_INVALID_BACKUP_FILE;</span></span>
<span id="L507"><span class="lineNum">     507</span>                 :<span class="tlaUNC">           0 :             return nullptr;</span></span>
<span id="L508"><span class="lineNum">     508</span>                 :             :         }</span>
<span id="L509"><span class="lineNum">     509</span>                 :             : </span>
<span id="L510"><span class="lineNum">     510</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         if (fs::exists(wallet_path) || !TryCreateDirectories(wallet_path)) {</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L511"><span class="lineNum">     511</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             error = Untranslated(strprintf(&quot;Failed to create database path '%s'. Database already exists.&quot;, fs::PathToString(wallet_path)));</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L512"><span class="lineNum">     512</span>                 :<span class="tlaUNC">           0 :             status = DatabaseStatus::FAILED_ALREADY_EXISTS;</span></span>
<span id="L513"><span class="lineNum">     513</span>                 :<span class="tlaUNC">           0 :             return nullptr;</span></span>
<span id="L514"><span class="lineNum">     514</span>                 :             :         }</span>
<span id="L515"><span class="lineNum">     515</span>                 :             : </span>
<span id="L516"><span class="lineNum">     516</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         fs::copy_file(backup_file, wallet_file, fs::copy_options::none);</span></span>
<span id="L517"><span class="lineNum">     517</span>                 :             : </span>
<span id="L518"><span class="lineNum">     518</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         wallet = LoadWallet(context, wallet_name, load_on_start, options, status, error, warnings);</span></span>
<span id="L519"><span class="lineNum">     519</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaUNC">           0 :     } catch (const std::exception&amp; e) {</span></span>
<span id="L520"><span class="lineNum">     520</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaUNC">           0 :         assert(!wallet);</span></span>
<span id="L521"><span class="lineNum">     521</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaUNC">           0 :         if (!error.empty()) error += Untranslated(&quot;\n&quot;);</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaUNC" title="Branch 6 was not taken"> - </span><span class="tlaUNC" title="Branch 7 was not taken"> - </span>]
<span id="L522"><span class="lineNum">     522</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaUNC">           0 :         error += strprintf(Untranslated(&quot;Unexpected exception: %s&quot;), e.what());</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaUNC" title="Branch 6 was not taken"> - </span><span class="tlaUNC" title="Branch 7 was not taken"> - </span>]
<span id="L523"><span class="lineNum">     523</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L524"><span class="lineNum">     524</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!wallet) {</span></span>
<span id="L525"><span class="lineNum">     525</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         fs::remove_all(wallet_path);</span></span>
<span id="L526"><span class="lineNum">     526</span>                 :             :     }</span>
<span id="L527"><span class="lineNum">     527</span>                 :             : </span>
<span id="L528"><span class="lineNum">     528</span>                 :<span class="tlaUNC">           0 :     return wallet;</span></span>
<span id="L529"><span class="lineNum">     529</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L530"><span class="lineNum">     530</span>                 :             : </span>
<span id="L531"><span class="lineNum">     531</span>                 :             : /** @defgroup mapWallet</span>
<span id="L532"><span class="lineNum">     532</span>                 :             :  *</span>
<span id="L533"><span class="lineNum">     533</span>                 :             :  * @{</span>
<span id="L534"><span class="lineNum">     534</span>                 :             :  */</span>
<span id="L535"><span class="lineNum">     535</span>                 :             : </span>
<span id="L536"><span class="lineNum">     536</span>                 :<span class="tlaUNC">           0 : const CWalletTx* CWallet::GetWalletTx(const uint256&amp; hash) const</span></span>
<span id="L537"><span class="lineNum">     537</span>                 :             : {</span>
<span id="L538"><span class="lineNum">     538</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L539"><span class="lineNum">     539</span>                 :<span class="tlaUNC">           0 :     const auto it = mapWallet.find(hash);</span></span>
<span id="L540"><span class="lineNum">     540</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (it == mapWallet.end())</span></span>
<span id="L541"><span class="lineNum">     541</span>                 :             :         return nullptr;</span>
<span id="L542"><span class="lineNum">     542</span>                 :<span class="tlaUNC">           0 :     return &amp;(it-&gt;second);</span></span>
<span id="L543"><span class="lineNum">     543</span>                 :             : }</span>
<span id="L544"><span class="lineNum">     544</span>                 :             : </span>
<span id="L545"><span class="lineNum">     545</span>                 :<span class="tlaUNC">           0 : void CWallet::UpgradeKeyMetadata()</span></span>
<span id="L546"><span class="lineNum">     546</span>                 :             : {</span>
<span id="L547"><span class="lineNum">     547</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (IsLocked() || IsWalletFlagSet(WALLET_FLAG_KEY_ORIGIN_METADATA)) {</span></span>
<span id="L548"><span class="lineNum">     548</span>                 :<span class="tlaUNC">           0 :         return;</span></span>
<span id="L549"><span class="lineNum">     549</span>                 :             :     }</span>
<span id="L550"><span class="lineNum">     550</span>                 :             : </span>
<span id="L551"><span class="lineNum">     551</span>                 :<span class="tlaUNC">           0 :     auto spk_man = GetLegacyScriptPubKeyMan();</span></span>
<span id="L552"><span class="lineNum">     552</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!spk_man) {</span></span>
<span id="L553"><span class="lineNum">     553</span>                 :             :         return;</span>
<span id="L554"><span class="lineNum">     554</span>                 :             :     }</span>
<span id="L555"><span class="lineNum">     555</span>                 :             : </span>
<span id="L556"><span class="lineNum">     556</span>                 :<span class="tlaUNC">           0 :     spk_man-&gt;UpgradeKeyMetadata();</span></span>
<span id="L557"><span class="lineNum">     557</span>                 :<span class="tlaUNC">           0 :     SetWalletFlag(WALLET_FLAG_KEY_ORIGIN_METADATA);</span></span>
<span id="L558"><span class="lineNum">     558</span>                 :             : }</span>
<span id="L559"><span class="lineNum">     559</span>                 :             : </span>
<span id="L560"><span class="lineNum">     560</span>                 :<span class="tlaUNC">           0 : void CWallet::UpgradeDescriptorCache()</span></span>
<span id="L561"><span class="lineNum">     561</span>                 :             : {</span>
<span id="L562"><span class="lineNum">     562</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     if (!IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS) || IsLocked() || IsWalletFlagSet(WALLET_FLAG_LAST_HARDENED_XPUB_CACHED)) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L563"><span class="lineNum">     563</span>                 :<span class="tlaUNC">           0 :         return;</span></span>
<span id="L564"><span class="lineNum">     564</span>                 :             :     }</span>
<span id="L565"><span class="lineNum">     565</span>                 :             : </span>
<span id="L566"><span class="lineNum">     566</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (ScriptPubKeyMan* spkm : GetAllScriptPubKeyMans()) {</span></span>
<span id="L567"><span class="lineNum">     567</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         DescriptorScriptPubKeyMan* desc_spkm = dynamic_cast&lt;DescriptorScriptPubKeyMan*&gt;(spkm);</span></span>
<span id="L568"><span class="lineNum">     568</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         desc_spkm-&gt;UpgradeDescriptorCache();</span></span>
<span id="L569"><span class="lineNum">     569</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L570"><span class="lineNum">     570</span>                 :<span class="tlaUNC">           0 :     SetWalletFlag(WALLET_FLAG_LAST_HARDENED_XPUB_CACHED);</span></span>
<span id="L571"><span class="lineNum">     571</span>                 :             : }</span>
<span id="L572"><span class="lineNum">     572</span>                 :             : </span>
<span id="L573"><span class="lineNum">     573</span>                 :<span class="tlaUNC">           0 : bool CWallet::Unlock(const SecureString&amp; strWalletPassphrase)</span></span>
<span id="L574"><span class="lineNum">     574</span>                 :             : {</span>
<span id="L575"><span class="lineNum">     575</span>                 :<span class="tlaUNC">           0 :     CCrypter crypter;</span></span>
<span id="L576"><span class="lineNum">     576</span>                 :<span class="tlaUNC">           0 :     CKeyingMaterial _vMasterKey;</span></span>
<span id="L577"><span class="lineNum">     577</span>                 :             : </span>
<span id="L578"><span class="lineNum">     578</span>                 :<span class="tlaUNC">           0 :     {</span></span>
<span id="L579"><span class="lineNum">     579</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LOCK(cs_wallet);</span></span>
<span id="L580"><span class="lineNum">     580</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (const MasterKeyMap::value_type&amp; pMasterKey : mapMasterKeys)</span></span>
<span id="L581"><span class="lineNum">     581</span>                 :             :         {</span>
<span id="L582"><span class="lineNum">     582</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if(!crypter.SetKeyFromPassphrase(strWalletPassphrase, pMasterKey.second.vchSalt, pMasterKey.second.nDeriveIterations, pMasterKey.second.nDerivationMethod))</span></span>
<span id="L583"><span class="lineNum">     583</span>                 :             :                 return false;</span>
<span id="L584"><span class="lineNum">     584</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (!crypter.Decrypt(pMasterKey.second.vchCryptedKey, _vMasterKey))</span></span>
<span id="L585"><span class="lineNum">     585</span>                 :<span class="tlaUNC">           0 :                 continue; // try another master key</span></span>
<span id="L586"><span class="lineNum">     586</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (Unlock(_vMasterKey)) {</span></span>
<span id="L587"><span class="lineNum">     587</span>                 :             :                 // Now that we've unlocked, upgrade the key metadata</span>
<span id="L588"><span class="lineNum">     588</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 UpgradeKeyMetadata();</span></span>
<span id="L589"><span class="lineNum">     589</span>                 :             :                 // Now that we've unlocked, upgrade the descriptor cache</span>
<span id="L590"><span class="lineNum">     590</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 UpgradeDescriptorCache();</span></span>
<span id="L591"><span class="lineNum">     591</span>                 :             :                 return true;</span>
<span id="L592"><span class="lineNum">     592</span>                 :             :             }</span>
<span id="L593"><span class="lineNum">     593</span>                 :             :         }</span>
<span id="L594"><span class="lineNum">     594</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L595"><span class="lineNum">     595</span>                 :<span class="tlaUNC">           0 :     return false;</span></span>
<span id="L596"><span class="lineNum">     596</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L597"><span class="lineNum">     597</span>                 :             : </span>
<span id="L598"><span class="lineNum">     598</span>                 :<span class="tlaUNC">           0 : bool CWallet::ChangeWalletPassphrase(const SecureString&amp; strOldWalletPassphrase, const SecureString&amp; strNewWalletPassphrase)</span></span>
<span id="L599"><span class="lineNum">     599</span>                 :             : {</span>
<span id="L600"><span class="lineNum">     600</span>                 :<span class="tlaUNC">           0 :     bool fWasLocked = IsLocked();</span></span>
<span id="L601"><span class="lineNum">     601</span>                 :             : </span>
<span id="L602"><span class="lineNum">     602</span>                 :<span class="tlaUNC">           0 :     {</span></span>
<span id="L603"><span class="lineNum">     603</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LOCK2(m_relock_mutex, cs_wallet);</span></span>
<span id="L604"><span class="lineNum">     604</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         Lock();</span></span>
<span id="L605"><span class="lineNum">     605</span>                 :             : </span>
<span id="L606"><span class="lineNum">     606</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         CCrypter crypter;</span></span>
<span id="L607"><span class="lineNum">     607</span>                 :<span class="tlaUNC">           0 :         CKeyingMaterial _vMasterKey;</span></span>
<span id="L608"><span class="lineNum">     608</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (MasterKeyMap::value_type&amp; pMasterKey : mapMasterKeys)</span></span>
<span id="L609"><span class="lineNum">     609</span>                 :             :         {</span>
<span id="L610"><span class="lineNum">     610</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if(!crypter.SetKeyFromPassphrase(strOldWalletPassphrase, pMasterKey.second.vchSalt, pMasterKey.second.nDeriveIterations, pMasterKey.second.nDerivationMethod))</span></span>
<span id="L611"><span class="lineNum">     611</span>                 :             :                 return false;</span>
<span id="L612"><span class="lineNum">     612</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (!crypter.Decrypt(pMasterKey.second.vchCryptedKey, _vMasterKey))</span></span>
<span id="L613"><span class="lineNum">     613</span>                 :             :                 return false;</span>
<span id="L614"><span class="lineNum">     614</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (Unlock(_vMasterKey))</span></span>
<span id="L615"><span class="lineNum">     615</span>                 :             :             {</span>
<span id="L616"><span class="lineNum">     616</span>                 :<span class="tlaUNC">           0 :                 constexpr MillisecondsDouble target{100};</span></span>
<span id="L617"><span class="lineNum">     617</span>                 :<span class="tlaUNC">           0 :                 auto start{SteadyClock::now()};</span></span>
<span id="L618"><span class="lineNum">     618</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 crypter.SetKeyFromPassphrase(strNewWalletPassphrase, pMasterKey.second.vchSalt, pMasterKey.second.nDeriveIterations, pMasterKey.second.nDerivationMethod);</span></span>
<span id="L619"><span class="lineNum">     619</span>                 :<span class="tlaUNC">           0 :                 pMasterKey.second.nDeriveIterations = static_cast&lt;unsigned int&gt;(pMasterKey.second.nDeriveIterations * target / (SteadyClock::now() - start));</span></span>
<span id="L620"><span class="lineNum">     620</span>                 :             : </span>
<span id="L621"><span class="lineNum">     621</span>                 :<span class="tlaUNC">           0 :                 start = SteadyClock::now();</span></span>
<span id="L622"><span class="lineNum">     622</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 crypter.SetKeyFromPassphrase(strNewWalletPassphrase, pMasterKey.second.vchSalt, pMasterKey.second.nDeriveIterations, pMasterKey.second.nDerivationMethod);</span></span>
<span id="L623"><span class="lineNum">     623</span>                 :<span class="tlaUNC">           0 :                 pMasterKey.second.nDeriveIterations = (pMasterKey.second.nDeriveIterations + static_cast&lt;unsigned int&gt;(pMasterKey.second.nDeriveIterations * target / (SteadyClock::now() - start))) / 2;</span></span>
<span id="L624"><span class="lineNum">     624</span>                 :             : </span>
<span id="L625"><span class="lineNum">     625</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 if (pMasterKey.second.nDeriveIterations &lt; 25000)</span></span>
<span id="L626"><span class="lineNum">     626</span>                 :<span class="tlaUNC">           0 :                     pMasterKey.second.nDeriveIterations = 25000;</span></span>
<span id="L627"><span class="lineNum">     627</span>                 :             : </span>
<span id="L628"><span class="lineNum">     628</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 WalletLogPrintf(&quot;Wallet passphrase changed to an nDeriveIterations of %i\n&quot;, pMasterKey.second.nDeriveIterations);</span></span>
<span id="L629"><span class="lineNum">     629</span>                 :             : </span>
<span id="L630"><span class="lineNum">     630</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 if (!crypter.SetKeyFromPassphrase(strNewWalletPassphrase, pMasterKey.second.vchSalt, pMasterKey.second.nDeriveIterations, pMasterKey.second.nDerivationMethod))</span></span>
<span id="L631"><span class="lineNum">     631</span>                 :             :                     return false;</span>
<span id="L632"><span class="lineNum">     632</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 if (!crypter.Encrypt(_vMasterKey, pMasterKey.second.vchCryptedKey))</span></span>
<span id="L633"><span class="lineNum">     633</span>                 :             :                     return false;</span>
<span id="L634"><span class="lineNum">     634</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 WalletBatch(GetDatabase()).WriteMasterKey(pMasterKey.first, pMasterKey.second);</span></span>
<span id="L635"><span class="lineNum">     635</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 if (fWasLocked)</span></span>
<span id="L636"><span class="lineNum">     636</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     Lock();</span></span>
<span id="L637"><span class="lineNum">     637</span>                 :<span class="tlaUNC">           0 :                 return true;</span></span>
<span id="L638"><span class="lineNum">     638</span>                 :             :             }</span>
<span id="L639"><span class="lineNum">     639</span>                 :             :         }</span>
<span id="L640"><span class="lineNum">     640</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     }</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L641"><span class="lineNum">     641</span>                 :             : </span>
<span id="L642"><span class="lineNum">     642</span>                 :<span class="tlaUNC">           0 :     return false;</span></span>
<span id="L643"><span class="lineNum">     643</span>                 :             : }</span>
<span id="L644"><span class="lineNum">     644</span>                 :             : </span>
<span id="L645"><span class="lineNum">     645</span>                 :<span class="tlaUNC">           0 : void CWallet::chainStateFlushed(ChainstateRole role, const CBlockLocator&amp; loc)</span></span>
<span id="L646"><span class="lineNum">     646</span>                 :             : {</span>
<span id="L647"><span class="lineNum">     647</span>                 :             :     // Don't update the best block until the chain is attached so that in case of a shutdown,</span>
<span id="L648"><span class="lineNum">     648</span>                 :             :     // the rescan will be restarted at next startup.</span>
<span id="L649"><span class="lineNum">     649</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (m_attaching_chain || role == ChainstateRole::BACKGROUND) {</span></span>
<span id="L650"><span class="lineNum">     650</span>                 :             :         return;</span>
<span id="L651"><span class="lineNum">     651</span>                 :             :     }</span>
<span id="L652"><span class="lineNum">     652</span>                 :<span class="tlaUNC">           0 :     WalletBatch batch(GetDatabase());</span></span>
<span id="L653"><span class="lineNum">     653</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     batch.WriteBestBlock(loc);</span></span>
<span id="L654"><span class="lineNum">     654</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L655"><span class="lineNum">     655</span>                 :             : </span>
<span id="L656"><span class="lineNum">     656</span>                 :<span class="tlaUNC">           0 : void CWallet::SetMinVersion(enum WalletFeature nVersion, WalletBatch* batch_in)</span></span>
<span id="L657"><span class="lineNum">     657</span>                 :             : {</span>
<span id="L658"><span class="lineNum">     658</span>                 :<span class="tlaUNC">           0 :     LOCK(cs_wallet);</span></span>
<span id="L659"><span class="lineNum">     659</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (nWalletVersion &gt;= nVersion)</span></span>
<span id="L660"><span class="lineNum">     660</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         return;</span></span>
<span id="L661"><span class="lineNum">     661</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     WalletLogPrintf(&quot;Setting minversion to %d\n&quot;, nVersion);</span></span>
<span id="L662"><span class="lineNum">     662</span>                 :<span class="tlaUNC">           0 :     nWalletVersion = nVersion;</span></span>
<span id="L663"><span class="lineNum">     663</span>                 :             : </span>
<span id="L664"><span class="lineNum">     664</span>                 :<span class="tlaUNC">           0 :     {</span></span>
<span id="L665"><span class="lineNum">     665</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         WalletBatch* batch = batch_in ? batch_in : new WalletBatch(GetDatabase());</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L666"><span class="lineNum">     666</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (nWalletVersion &gt; 40000)</span></span>
<span id="L667"><span class="lineNum">     667</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             batch-&gt;WriteMinVersion(nWalletVersion);</span></span>
<span id="L668"><span class="lineNum">     668</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!batch_in)</span></span>
<span id="L669"><span class="lineNum">     669</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             delete batch;</span></span>
<span id="L670"><span class="lineNum">     670</span>                 :             :     }</span>
<span id="L671"><span class="lineNum">     671</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L672"><span class="lineNum">     672</span>                 :             : </span>
<span id="L673"><span class="lineNum">     673</span>                 :<span class="tlaUNC">           0 : std::set&lt;uint256&gt; CWallet::GetConflicts(const uint256&amp; txid) const</span></span>
<span id="L674"><span class="lineNum">     674</span>                 :             : {</span>
<span id="L675"><span class="lineNum">     675</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     std::set&lt;uint256&gt; result;</span></span>
<span id="L676"><span class="lineNum">     676</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L677"><span class="lineNum">     677</span>                 :             : </span>
<span id="L678"><span class="lineNum">     678</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     const auto it = mapWallet.find(txid);</span></span>
<span id="L679"><span class="lineNum">     679</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (it == mapWallet.end())</span></span>
<span id="L680"><span class="lineNum">     680</span>                 :             :         return result;</span>
<span id="L681"><span class="lineNum">     681</span>                 :<span class="tlaUNC">           0 :     const CWalletTx&amp; wtx = it-&gt;second;</span></span>
<span id="L682"><span class="lineNum">     682</span>                 :             : </span>
<span id="L683"><span class="lineNum">     683</span>                 :<span class="tlaUNC">           0 :     std::pair&lt;TxSpends::const_iterator, TxSpends::const_iterator&gt; range;</span></span>
<span id="L684"><span class="lineNum">     684</span>                 :             : </span>
<span id="L685"><span class="lineNum">     685</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (const CTxIn&amp; txin : wtx.tx-&gt;vin)</span></span>
<span id="L686"><span class="lineNum">     686</span>                 :             :     {</span>
<span id="L687"><span class="lineNum">     687</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (mapTxSpends.count(txin.prevout) &lt;= 1)</span></span>
<span id="L688"><span class="lineNum">     688</span>                 :<span class="tlaUNC">           0 :             continue;  // No conflict if zero or one spends</span></span>
<span id="L689"><span class="lineNum">     689</span>                 :<span class="tlaUNC">           0 :         range = mapTxSpends.equal_range(txin.prevout);</span></span>
<span id="L690"><span class="lineNum">     690</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (TxSpends::const_iterator _it = range.first; _it != range.second; ++_it)</span></span>
<span id="L691"><span class="lineNum">     691</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             result.insert(_it-&gt;second);</span></span>
<span id="L692"><span class="lineNum">     692</span>                 :             :     }</span>
<span id="L693"><span class="lineNum">     693</span>                 :             :     return result;</span>
<span id="L694"><span class="lineNum">     694</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L695"><span class="lineNum">     695</span>                 :             : </span>
<span id="L696"><span class="lineNum">     696</span>                 :<span class="tlaUNC">           0 : bool CWallet::HasWalletSpend(const CTransactionRef&amp; tx) const</span></span>
<span id="L697"><span class="lineNum">     697</span>                 :             : {</span>
<span id="L698"><span class="lineNum">     698</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L699"><span class="lineNum">     699</span>                 :<span class="tlaUNC">           0 :     const Txid&amp; txid = tx-&gt;GetHash();</span></span>
<span id="L700"><span class="lineNum">     700</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (unsigned int i = 0; i &lt; tx-&gt;vout.size(); ++i) {</span></span>
<span id="L701"><span class="lineNum">     701</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (IsSpent(COutPoint(txid, i))) {</span></span>
<span id="L702"><span class="lineNum">     702</span>                 :             :             return true;</span>
<span id="L703"><span class="lineNum">     703</span>                 :             :         }</span>
<span id="L704"><span class="lineNum">     704</span>                 :             :     }</span>
<span id="L705"><span class="lineNum">     705</span>                 :             :     return false;</span>
<span id="L706"><span class="lineNum">     706</span>                 :             : }</span>
<span id="L707"><span class="lineNum">     707</span>                 :             : </span>
<span id="L708"><span class="lineNum">     708</span>                 :<span class="tlaUNC">           0 : void CWallet::Flush()</span></span>
<span id="L709"><span class="lineNum">     709</span>                 :             : {</span>
<span id="L710"><span class="lineNum">     710</span>                 :<span class="tlaUNC">           0 :     GetDatabase().Flush();</span></span>
<span id="L711"><span class="lineNum">     711</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L712"><span class="lineNum">     712</span>                 :             : </span>
<span id="L713"><span class="lineNum">     713</span>                 :<span class="tlaUNC">           0 : void CWallet::Close()</span></span>
<span id="L714"><span class="lineNum">     714</span>                 :             : {</span>
<span id="L715"><span class="lineNum">     715</span>                 :<span class="tlaUNC">           0 :     GetDatabase().Close();</span></span>
<span id="L716"><span class="lineNum">     716</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L717"><span class="lineNum">     717</span>                 :             : </span>
<span id="L718"><span class="lineNum">     718</span>                 :<span class="tlaUNC">           0 : void CWallet::SyncMetaData(std::pair&lt;TxSpends::iterator, TxSpends::iterator&gt; range)</span></span>
<span id="L719"><span class="lineNum">     719</span>                 :             : {</span>
<span id="L720"><span class="lineNum">     720</span>                 :             :     // We want all the wallet transactions in range to have the same metadata as</span>
<span id="L721"><span class="lineNum">     721</span>                 :             :     // the oldest (smallest nOrderPos).</span>
<span id="L722"><span class="lineNum">     722</span>                 :             :     // So: find smallest nOrderPos:</span>
<span id="L723"><span class="lineNum">     723</span>                 :             : </span>
<span id="L724"><span class="lineNum">     724</span>                 :<span class="tlaUNC">           0 :     int nMinOrderPos = std::numeric_limits&lt;int&gt;::max();</span></span>
<span id="L725"><span class="lineNum">     725</span>                 :<span class="tlaUNC">           0 :     const CWalletTx* copyFrom = nullptr;</span></span>
<span id="L726"><span class="lineNum">     726</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (TxSpends::iterator it = range.first; it != range.second; ++it) {</span></span>
<span id="L727"><span class="lineNum">     727</span>                 :<span class="tlaUNC">           0 :         const CWalletTx* wtx = &amp;mapWallet.at(it-&gt;second);</span></span>
<span id="L728"><span class="lineNum">     728</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (wtx-&gt;nOrderPos &lt; nMinOrderPos) {</span></span>
<span id="L729"><span class="lineNum">     729</span>                 :<span class="tlaUNC">           0 :             nMinOrderPos = wtx-&gt;nOrderPos;</span></span>
<span id="L730"><span class="lineNum">     730</span>                 :<span class="tlaUNC">           0 :             copyFrom = wtx;</span></span>
<span id="L731"><span class="lineNum">     731</span>                 :             :         }</span>
<span id="L732"><span class="lineNum">     732</span>                 :             :     }</span>
<span id="L733"><span class="lineNum">     733</span>                 :             : </span>
<span id="L734"><span class="lineNum">     734</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!copyFrom) {</span></span>
<span id="L735"><span class="lineNum">     735</span>                 :             :         return;</span>
<span id="L736"><span class="lineNum">     736</span>                 :             :     }</span>
<span id="L737"><span class="lineNum">     737</span>                 :             : </span>
<span id="L738"><span class="lineNum">     738</span>                 :             :     // Now copy data from copyFrom to rest:</span>
<span id="L739"><span class="lineNum">     739</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (TxSpends::iterator it = range.first; it != range.second; ++it)</span></span>
<span id="L740"><span class="lineNum">     740</span>                 :             :     {</span>
<span id="L741"><span class="lineNum">     741</span>                 :<span class="tlaUNC">           0 :         const uint256&amp; hash = it-&gt;second;</span></span>
<span id="L742"><span class="lineNum">     742</span>                 :<span class="tlaUNC">           0 :         CWalletTx* copyTo = &amp;mapWallet.at(hash);</span></span>
<span id="L743"><span class="lineNum">     743</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (copyFrom == copyTo) continue;</span></span>
<span id="L744"><span class="lineNum">     744</span>                 :<span class="tlaUNC">           0 :         assert(copyFrom &amp;&amp; &quot;Oldest wallet transaction in range assumed to have been found.&quot;);</span></span>
<span id="L745"><span class="lineNum">     745</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!copyFrom-&gt;IsEquivalentTo(*copyTo)) continue;</span></span>
<span id="L746"><span class="lineNum">     746</span>                 :<span class="tlaUNC">           0 :         copyTo-&gt;mapValue = copyFrom-&gt;mapValue;</span></span>
<span id="L747"><span class="lineNum">     747</span>                 :<span class="tlaUNC">           0 :         copyTo-&gt;vOrderForm = copyFrom-&gt;vOrderForm;</span></span>
<span id="L748"><span class="lineNum">     748</span>                 :             :         // fTimeReceivedIsTxTime not copied on purpose</span>
<span id="L749"><span class="lineNum">     749</span>                 :             :         // nTimeReceived not copied on purpose</span>
<span id="L750"><span class="lineNum">     750</span>                 :<span class="tlaUNC">           0 :         copyTo-&gt;nTimeSmart = copyFrom-&gt;nTimeSmart;</span></span>
<span id="L751"><span class="lineNum">     751</span>                 :<span class="tlaUNC">           0 :         copyTo-&gt;fFromMe = copyFrom-&gt;fFromMe;</span></span>
<span id="L752"><span class="lineNum">     752</span>                 :             :         // nOrderPos not copied on purpose</span>
<span id="L753"><span class="lineNum">     753</span>                 :             :         // cached members not copied on purpose</span>
<span id="L754"><span class="lineNum">     754</span>                 :             :     }</span>
<span id="L755"><span class="lineNum">     755</span>                 :             : }</span>
<span id="L756"><span class="lineNum">     756</span>                 :             : </span>
<span id="L757"><span class="lineNum">     757</span>                 :             : /**</span>
<span id="L758"><span class="lineNum">     758</span>                 :             :  * Outpoint is spent if any non-conflicted transaction</span>
<span id="L759"><span class="lineNum">     759</span>                 :             :  * spends it:</span>
<span id="L760"><span class="lineNum">     760</span>                 :             :  */</span>
<span id="L761"><span class="lineNum">     761</span>                 :<span class="tlaUNC">           0 : bool CWallet::IsSpent(const COutPoint&amp; outpoint) const</span></span>
<span id="L762"><span class="lineNum">     762</span>                 :             : {</span>
<span id="L763"><span class="lineNum">     763</span>                 :<span class="tlaUNC">           0 :     std::pair&lt;TxSpends::const_iterator, TxSpends::const_iterator&gt; range;</span></span>
<span id="L764"><span class="lineNum">     764</span>                 :<span class="tlaUNC">           0 :     range = mapTxSpends.equal_range(outpoint);</span></span>
<span id="L765"><span class="lineNum">     765</span>                 :             : </span>
<span id="L766"><span class="lineNum">     766</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (TxSpends::const_iterator it = range.first; it != range.second; ++it) {</span></span>
<span id="L767"><span class="lineNum">     767</span>                 :<span class="tlaUNC">           0 :         const uint256&amp; wtxid = it-&gt;second;</span></span>
<span id="L768"><span class="lineNum">     768</span>                 :<span class="tlaUNC">           0 :         const auto mit = mapWallet.find(wtxid);</span></span>
<span id="L769"><span class="lineNum">     769</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (mit != mapWallet.end()) {</span></span>
<span id="L770"><span class="lineNum">     770</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             const auto&amp; wtx = mit-&gt;second;</span></span>
<span id="L771"><span class="lineNum">     771</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             if (!wtx.isAbandoned() &amp;&amp; !wtx.isBlockConflicted() &amp;&amp; !wtx.isMempoolConflicted())</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L772"><span class="lineNum">     772</span>                 :             :                 return true; // Spent</span>
<span id="L773"><span class="lineNum">     773</span>                 :             :         }</span>
<span id="L774"><span class="lineNum">     774</span>                 :             :     }</span>
<span id="L775"><span class="lineNum">     775</span>                 :             :     return false;</span>
<span id="L776"><span class="lineNum">     776</span>                 :             : }</span>
<span id="L777"><span class="lineNum">     777</span>                 :             : </span>
<span id="L778"><span class="lineNum">     778</span>                 :<span class="tlaUNC">           0 : void CWallet::AddToSpends(const COutPoint&amp; outpoint, const uint256&amp; wtxid, WalletBatch* batch)</span></span>
<span id="L779"><span class="lineNum">     779</span>                 :             : {</span>
<span id="L780"><span class="lineNum">     780</span>                 :<span class="tlaUNC">           0 :     mapTxSpends.insert(std::make_pair(outpoint, wtxid));</span></span>
<span id="L781"><span class="lineNum">     781</span>                 :             : </span>
<span id="L782"><span class="lineNum">     782</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (batch) {</span></span>
<span id="L783"><span class="lineNum">     783</span>                 :<span class="tlaUNC">           0 :         UnlockCoin(outpoint, batch);</span></span>
<span id="L784"><span class="lineNum">     784</span>                 :             :     } else {</span>
<span id="L785"><span class="lineNum">     785</span>                 :<span class="tlaUNC">           0 :         WalletBatch temp_batch(GetDatabase());</span></span>
<span id="L786"><span class="lineNum">     786</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         UnlockCoin(outpoint, &amp;temp_batch);</span></span>
<span id="L787"><span class="lineNum">     787</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L788"><span class="lineNum">     788</span>                 :             : </span>
<span id="L789"><span class="lineNum">     789</span>                 :<span class="tlaUNC">           0 :     std::pair&lt;TxSpends::iterator, TxSpends::iterator&gt; range;</span></span>
<span id="L790"><span class="lineNum">     790</span>                 :<span class="tlaUNC">           0 :     range = mapTxSpends.equal_range(outpoint);</span></span>
<span id="L791"><span class="lineNum">     791</span>                 :<span class="tlaUNC">           0 :     SyncMetaData(range);</span></span>
<span id="L792"><span class="lineNum">     792</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L793"><span class="lineNum">     793</span>                 :             : </span>
<span id="L794"><span class="lineNum">     794</span>                 :             : </span>
<span id="L795"><span class="lineNum">     795</span>                 :<span class="tlaUNC">           0 : void CWallet::AddToSpends(const CWalletTx&amp; wtx, WalletBatch* batch)</span></span>
<span id="L796"><span class="lineNum">     796</span>                 :             : {</span>
<span id="L797"><span class="lineNum">     797</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (wtx.IsCoinBase()) // Coinbases don't spend anything!</span></span>
<span id="L798"><span class="lineNum">     798</span>                 :             :         return;</span>
<span id="L799"><span class="lineNum">     799</span>                 :             : </span>
<span id="L800"><span class="lineNum">     800</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (const CTxIn&amp; txin : wtx.tx-&gt;vin)</span></span>
<span id="L801"><span class="lineNum">     801</span>                 :<span class="tlaUNC">           0 :         AddToSpends(txin.prevout, wtx.GetHash(), batch);</span></span>
<span id="L802"><span class="lineNum">     802</span>                 :             : }</span>
<span id="L803"><span class="lineNum">     803</span>                 :             : </span>
<span id="L804"><span class="lineNum">     804</span>                 :<span class="tlaUNC">           0 : bool CWallet::EncryptWallet(const SecureString&amp; strWalletPassphrase)</span></span>
<span id="L805"><span class="lineNum">     805</span>                 :             : {</span>
<span id="L806"><span class="lineNum">     806</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (IsCrypted())</span></span>
<span id="L807"><span class="lineNum">     807</span>                 :             :         return false;</span>
<span id="L808"><span class="lineNum">     808</span>                 :             : </span>
<span id="L809"><span class="lineNum">     809</span>                 :<span class="tlaUNC">           0 :     CKeyingMaterial _vMasterKey;</span></span>
<span id="L810"><span class="lineNum">     810</span>                 :             : </span>
<span id="L811"><span class="lineNum">     811</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     _vMasterKey.resize(WALLET_CRYPTO_KEY_SIZE);</span></span>
<span id="L812"><span class="lineNum">     812</span>                 :<span class="tlaUNC">           0 :     GetStrongRandBytes(_vMasterKey);</span></span>
<span id="L813"><span class="lineNum">     813</span>                 :             : </span>
<span id="L814"><span class="lineNum">     814</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     CMasterKey kMasterKey;</span></span>
<span id="L815"><span class="lineNum">     815</span>                 :             : </span>
<span id="L816"><span class="lineNum">     816</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     kMasterKey.vchSalt.resize(WALLET_CRYPTO_SALT_SIZE);</span></span>
<span id="L817"><span class="lineNum">     817</span>                 :<span class="tlaUNC">           0 :     GetStrongRandBytes(kMasterKey.vchSalt);</span></span>
<span id="L818"><span class="lineNum">     818</span>                 :             : </span>
<span id="L819"><span class="lineNum">     819</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     CCrypter crypter;</span></span>
<span id="L820"><span class="lineNum">     820</span>                 :<span class="tlaUNC">           0 :     constexpr MillisecondsDouble target{100};</span></span>
<span id="L821"><span class="lineNum">     821</span>                 :<span class="tlaUNC">           0 :     auto start{SteadyClock::now()};</span></span>
<span id="L822"><span class="lineNum">     822</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     crypter.SetKeyFromPassphrase(strWalletPassphrase, kMasterKey.vchSalt, 25000, kMasterKey.nDerivationMethod);</span></span>
<span id="L823"><span class="lineNum">     823</span>                 :<span class="tlaUNC">           0 :     kMasterKey.nDeriveIterations = static_cast&lt;unsigned int&gt;(25000 * target / (SteadyClock::now() - start));</span></span>
<span id="L824"><span class="lineNum">     824</span>                 :             : </span>
<span id="L825"><span class="lineNum">     825</span>                 :<span class="tlaUNC">           0 :     start = SteadyClock::now();</span></span>
<span id="L826"><span class="lineNum">     826</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     crypter.SetKeyFromPassphrase(strWalletPassphrase, kMasterKey.vchSalt, kMasterKey.nDeriveIterations, kMasterKey.nDerivationMethod);</span></span>
<span id="L827"><span class="lineNum">     827</span>                 :<span class="tlaUNC">           0 :     kMasterKey.nDeriveIterations = (kMasterKey.nDeriveIterations + static_cast&lt;unsigned int&gt;(kMasterKey.nDeriveIterations * target / (SteadyClock::now() - start))) / 2;</span></span>
<span id="L828"><span class="lineNum">     828</span>                 :             : </span>
<span id="L829"><span class="lineNum">     829</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (kMasterKey.nDeriveIterations &lt; 25000)</span></span>
<span id="L830"><span class="lineNum">     830</span>                 :<span class="tlaUNC">           0 :         kMasterKey.nDeriveIterations = 25000;</span></span>
<span id="L831"><span class="lineNum">     831</span>                 :             : </span>
<span id="L832"><span class="lineNum">     832</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     WalletLogPrintf(&quot;Encrypting Wallet with an nDeriveIterations of %i\n&quot;, kMasterKey.nDeriveIterations);</span></span>
<span id="L833"><span class="lineNum">     833</span>                 :             : </span>
<span id="L834"><span class="lineNum">     834</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!crypter.SetKeyFromPassphrase(strWalletPassphrase, kMasterKey.vchSalt, kMasterKey.nDeriveIterations, kMasterKey.nDerivationMethod))</span></span>
<span id="L835"><span class="lineNum">     835</span>                 :             :         return false;</span>
<span id="L836"><span class="lineNum">     836</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!crypter.Encrypt(_vMasterKey, kMasterKey.vchCryptedKey))</span></span>
<span id="L837"><span class="lineNum">     837</span>                 :             :         return false;</span>
<span id="L838"><span class="lineNum">     838</span>                 :             : </span>
<span id="L839"><span class="lineNum">     839</span>                 :<span class="tlaUNC">           0 :     {</span></span>
<span id="L840"><span class="lineNum">     840</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LOCK2(m_relock_mutex, cs_wallet);</span></span>
<span id="L841"><span class="lineNum">     841</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         mapMasterKeys[++nMasterKeyMaxID] = kMasterKey;</span></span>
<span id="L842"><span class="lineNum">     842</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         WalletBatch* encrypted_batch = new WalletBatch(GetDatabase());</span></span>
<span id="L843"><span class="lineNum">     843</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!encrypted_batch-&gt;TxnBegin()) {</span></span>
<span id="L844"><span class="lineNum">     844</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             delete encrypted_batch;</span></span>
<span id="L845"><span class="lineNum">     845</span>                 :<span class="tlaUNC">           0 :             encrypted_batch = nullptr;</span></span>
<span id="L846"><span class="lineNum">     846</span>                 :<span class="tlaUNC">           0 :             return false;</span></span>
<span id="L847"><span class="lineNum">     847</span>                 :             :         }</span>
<span id="L848"><span class="lineNum">     848</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         encrypted_batch-&gt;WriteMasterKey(nMasterKeyMaxID, kMasterKey);</span></span>
<span id="L849"><span class="lineNum">     849</span>                 :             : </span>
<span id="L850"><span class="lineNum">     850</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (const auto&amp; spk_man_pair : m_spk_managers) {</span></span>
<span id="L851"><span class="lineNum">     851</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             auto spk_man = spk_man_pair.second.get();</span></span>
<span id="L852"><span class="lineNum">     852</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (!spk_man-&gt;Encrypt(_vMasterKey, encrypted_batch)) {</span></span>
<span id="L853"><span class="lineNum">     853</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 encrypted_batch-&gt;TxnAbort();</span></span>
<span id="L854"><span class="lineNum">     854</span>                 :<span class="tlaUNC">           0 :                 delete encrypted_batch;</span></span>
<span id="L855"><span class="lineNum">     855</span>                 :<span class="tlaUNC">           0 :                 encrypted_batch = nullptr;</span></span>
<span id="L856"><span class="lineNum">     856</span>                 :             :                 // We now probably have half of our keys encrypted in memory, and half not...</span>
<span id="L857"><span class="lineNum">     857</span>                 :             :                 // die and let the user reload the unencrypted wallet.</span>
<span id="L858"><span class="lineNum">     858</span>                 :<span class="tlaUNC">           0 :                 assert(false);</span></span>
<span id="L859"><span class="lineNum">     859</span>                 :             :             }</span>
<span id="L860"><span class="lineNum">     860</span>                 :             :         }</span>
<span id="L861"><span class="lineNum">     861</span>                 :             : </span>
<span id="L862"><span class="lineNum">     862</span>                 :             :         // Encryption was introduced in version 0.4.0</span>
<span id="L863"><span class="lineNum">     863</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         SetMinVersion(FEATURE_WALLETCRYPT, encrypted_batch);</span></span>
<span id="L864"><span class="lineNum">     864</span>                 :             : </span>
<span id="L865"><span class="lineNum">     865</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!encrypted_batch-&gt;TxnCommit()) {</span></span>
<span id="L866"><span class="lineNum">     866</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             delete encrypted_batch;</span></span>
<span id="L867"><span class="lineNum">     867</span>                 :<span class="tlaUNC">           0 :             encrypted_batch = nullptr;</span></span>
<span id="L868"><span class="lineNum">     868</span>                 :             :             // We now have keys encrypted in memory, but not on disk...</span>
<span id="L869"><span class="lineNum">     869</span>                 :             :             // die to avoid confusion and let the user reload the unencrypted wallet.</span>
<span id="L870"><span class="lineNum">     870</span>                 :<span class="tlaUNC">           0 :             assert(false);</span></span>
<span id="L871"><span class="lineNum">     871</span>                 :             :         }</span>
<span id="L872"><span class="lineNum">     872</span>                 :             : </span>
<span id="L873"><span class="lineNum">     873</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         delete encrypted_batch;</span></span>
<span id="L874"><span class="lineNum">     874</span>                 :<span class="tlaUNC">           0 :         encrypted_batch = nullptr;</span></span>
<span id="L875"><span class="lineNum">     875</span>                 :             : </span>
<span id="L876"><span class="lineNum">     876</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         Lock();</span></span>
<span id="L877"><span class="lineNum">     877</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         Unlock(strWalletPassphrase);</span></span>
<span id="L878"><span class="lineNum">     878</span>                 :             : </span>
<span id="L879"><span class="lineNum">     879</span>                 :             :         // If we are using descriptors, make new descriptors with a new seed</span>
<span id="L880"><span class="lineNum">     880</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         if (IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS) &amp;&amp; !IsWalletFlagSet(WALLET_FLAG_BLANK_WALLET)) {</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L881"><span class="lineNum">     881</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             SetupDescriptorScriptPubKeyMans();</span></span>
<span id="L882"><span class="lineNum">     882</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         } else if (auto spk_man = GetLegacyScriptPubKeyMan()) {</span></span>
<span id="L883"><span class="lineNum">     883</span>                 :             :             // if we are using HD, replace the HD seed with a new one</span>
<span id="L884"><span class="lineNum">     884</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (spk_man-&gt;IsHDEnabled()) {</span></span>
<span id="L885"><span class="lineNum">     885</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 if (!spk_man-&gt;SetupGeneration(true)) {</span></span>
<span id="L886"><span class="lineNum">     886</span>                 :             :                     return false;</span>
<span id="L887"><span class="lineNum">     887</span>                 :             :                 }</span>
<span id="L888"><span class="lineNum">     888</span>                 :             :             }</span>
<span id="L889"><span class="lineNum">     889</span>                 :             :         }</span>
<span id="L890"><span class="lineNum">     890</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         Lock();</span></span>
<span id="L891"><span class="lineNum">     891</span>                 :             : </span>
<span id="L892"><span class="lineNum">     892</span>                 :             :         // Need to completely rewrite the wallet file; if we don't, bdb might keep</span>
<span id="L893"><span class="lineNum">     893</span>                 :             :         // bits of the unencrypted private key in slack space in the database file.</span>
<span id="L894"><span class="lineNum">     894</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         GetDatabase().Rewrite();</span></span>
<span id="L895"><span class="lineNum">     895</span>                 :             : </span>
<span id="L896"><span class="lineNum">     896</span>                 :             :         // BDB seems to have a bad habit of writing old data into</span>
<span id="L897"><span class="lineNum">     897</span>                 :             :         // slack space in .dat files; that is bad if the old data is</span>
<span id="L898"><span class="lineNum">     898</span>                 :             :         // unencrypted private keys. So:</span>
<span id="L899"><span class="lineNum">     899</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         GetDatabase().ReloadDbEnv();</span></span>
<span id="L900"><span class="lineNum">     900</span>                 :             : </span>
<span id="L901"><span class="lineNum">     901</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     }</span></span>
<span id="L902"><span class="lineNum">     902</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     NotifyStatusChanged(this);</span></span>
<span id="L903"><span class="lineNum">     903</span>                 :             : </span>
<span id="L904"><span class="lineNum">     904</span>                 :             :     return true;</span>
<span id="L905"><span class="lineNum">     905</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L906"><span class="lineNum">     906</span>                 :             : </span>
<span id="L907"><span class="lineNum">     907</span>                 :<span class="tlaUNC">           0 : DBErrors CWallet::ReorderTransactions()</span></span>
<span id="L908"><span class="lineNum">     908</span>                 :             : {</span>
<span id="L909"><span class="lineNum">     909</span>                 :<span class="tlaUNC">           0 :     LOCK(cs_wallet);</span></span>
<span id="L910"><span class="lineNum">     910</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     WalletBatch batch(GetDatabase());</span></span>
<span id="L911"><span class="lineNum">     911</span>                 :             : </span>
<span id="L912"><span class="lineNum">     912</span>                 :             :     // Old wallets didn't have any defined order for transactions</span>
<span id="L913"><span class="lineNum">     913</span>                 :             :     // Probably a bad idea to change the output of this</span>
<span id="L914"><span class="lineNum">     914</span>                 :             : </span>
<span id="L915"><span class="lineNum">     915</span>                 :             :     // First: get all CWalletTx into a sorted-by-time multimap.</span>
<span id="L916"><span class="lineNum">     916</span>                 :<span class="tlaUNC">           0 :     typedef std::multimap&lt;int64_t, CWalletTx*&gt; TxItems;</span></span>
<span id="L917"><span class="lineNum">     917</span>                 :<span class="tlaUNC">           0 :     TxItems txByTime;</span></span>
<span id="L918"><span class="lineNum">     918</span>                 :             : </span>
<span id="L919"><span class="lineNum">     919</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (auto&amp; entry : mapWallet)</span></span>
<span id="L920"><span class="lineNum">     920</span>                 :             :     {</span>
<span id="L921"><span class="lineNum">     921</span>                 :<span class="tlaUNC">           0 :         CWalletTx* wtx = &amp;entry.second;</span></span>
<span id="L922"><span class="lineNum">     922</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         txByTime.insert(std::make_pair(wtx-&gt;nTimeReceived, wtx));</span></span>
<span id="L923"><span class="lineNum">     923</span>                 :             :     }</span>
<span id="L924"><span class="lineNum">     924</span>                 :             : </span>
<span id="L925"><span class="lineNum">     925</span>                 :<span class="tlaUNC">           0 :     nOrderPosNext = 0;</span></span>
<span id="L926"><span class="lineNum">     926</span>                 :<span class="tlaUNC">           0 :     std::vector&lt;int64_t&gt; nOrderPosOffsets;</span></span>
<span id="L927"><span class="lineNum">     927</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (TxItems::iterator it = txByTime.begin(); it != txByTime.end(); ++it)</span></span>
<span id="L928"><span class="lineNum">     928</span>                 :             :     {</span>
<span id="L929"><span class="lineNum">     929</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         CWalletTx *const pwtx = (*it).second;</span></span>
<span id="L930"><span class="lineNum">     930</span>                 :<span class="tlaUNC">           0 :         int64_t&amp; nOrderPos = pwtx-&gt;nOrderPos;</span></span>
<span id="L931"><span class="lineNum">     931</span>                 :             : </span>
<span id="L932"><span class="lineNum">     932</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (nOrderPos == -1)</span></span>
<span id="L933"><span class="lineNum">     933</span>                 :             :         {</span>
<span id="L934"><span class="lineNum">     934</span>                 :<span class="tlaUNC">           0 :             nOrderPos = nOrderPosNext++;</span></span>
<span id="L935"><span class="lineNum">     935</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             nOrderPosOffsets.push_back(nOrderPos);</span></span>
<span id="L936"><span class="lineNum">     936</span>                 :             : </span>
<span id="L937"><span class="lineNum">     937</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (!batch.WriteTx(*pwtx))</span></span>
<span id="L938"><span class="lineNum">     938</span>                 :             :                 return DBErrors::LOAD_FAIL;</span>
<span id="L939"><span class="lineNum">     939</span>                 :             :         }</span>
<span id="L940"><span class="lineNum">     940</span>                 :             :         else</span>
<span id="L941"><span class="lineNum">     941</span>                 :             :         {</span>
<span id="L942"><span class="lineNum">     942</span>                 :<span class="tlaUNC">           0 :             int64_t nOrderPosOff = 0;</span></span>
<span id="L943"><span class="lineNum">     943</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             for (const int64_t&amp; nOffsetStart : nOrderPosOffsets)</span></span>
<span id="L944"><span class="lineNum">     944</span>                 :             :             {</span>
<span id="L945"><span class="lineNum">     945</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 if (nOrderPos &gt;= nOffsetStart)</span></span>
<span id="L946"><span class="lineNum">     946</span>                 :<span class="tlaUNC">           0 :                     ++nOrderPosOff;</span></span>
<span id="L947"><span class="lineNum">     947</span>                 :             :             }</span>
<span id="L948"><span class="lineNum">     948</span>                 :<span class="tlaUNC">           0 :             nOrderPos += nOrderPosOff;</span></span>
<span id="L949"><span class="lineNum">     949</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             nOrderPosNext = std::max(nOrderPosNext, nOrderPos + 1);</span></span>
<span id="L950"><span class="lineNum">     950</span>                 :             : </span>
<span id="L951"><span class="lineNum">     951</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (!nOrderPosOff)</span></span>
<span id="L952"><span class="lineNum">     952</span>                 :<span class="tlaUNC">           0 :                 continue;</span></span>
<span id="L953"><span class="lineNum">     953</span>                 :             : </span>
<span id="L954"><span class="lineNum">     954</span>                 :             :             // Since we're changing the order, write it back</span>
<span id="L955"><span class="lineNum">     955</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (!batch.WriteTx(*pwtx))</span></span>
<span id="L956"><span class="lineNum">     956</span>                 :             :                 return DBErrors::LOAD_FAIL;</span>
<span id="L957"><span class="lineNum">     957</span>                 :             :         }</span>
<span id="L958"><span class="lineNum">     958</span>                 :             :     }</span>
<span id="L959"><span class="lineNum">     959</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     batch.WriteOrderPosNext(nOrderPosNext);</span></span>
<span id="L960"><span class="lineNum">     960</span>                 :             : </span>
<span id="L961"><span class="lineNum">     961</span>                 :             :     return DBErrors::LOAD_OK;</span>
<span id="L962"><span class="lineNum">     962</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 : }</span></span>
<span id="L963"><span class="lineNum">     963</span>                 :             : </span>
<span id="L964"><span class="lineNum">     964</span>                 :<span class="tlaUNC">           0 : int64_t CWallet::IncOrderPosNext(WalletBatch* batch)</span></span>
<span id="L965"><span class="lineNum">     965</span>                 :             : {</span>
<span id="L966"><span class="lineNum">     966</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L967"><span class="lineNum">     967</span>                 :<span class="tlaUNC">           0 :     int64_t nRet = nOrderPosNext++;</span></span>
<span id="L968"><span class="lineNum">     968</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (batch) {</span></span>
<span id="L969"><span class="lineNum">     969</span>                 :<span class="tlaUNC">           0 :         batch-&gt;WriteOrderPosNext(nOrderPosNext);</span></span>
<span id="L970"><span class="lineNum">     970</span>                 :             :     } else {</span>
<span id="L971"><span class="lineNum">     971</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         WalletBatch(GetDatabase()).WriteOrderPosNext(nOrderPosNext);</span></span>
<span id="L972"><span class="lineNum">     972</span>                 :             :     }</span>
<span id="L973"><span class="lineNum">     973</span>                 :<span class="tlaUNC">           0 :     return nRet;</span></span>
<span id="L974"><span class="lineNum">     974</span>                 :             : }</span>
<span id="L975"><span class="lineNum">     975</span>                 :             : </span>
<span id="L976"><span class="lineNum">     976</span>                 :<span class="tlaUNC">           0 : void CWallet::MarkDirty()</span></span>
<span id="L977"><span class="lineNum">     977</span>                 :             : {</span>
<span id="L978"><span class="lineNum">     978</span>                 :<span class="tlaUNC">           0 :     {</span></span>
<span id="L979"><span class="lineNum">     979</span>                 :<span class="tlaUNC">           0 :         LOCK(cs_wallet);</span></span>
<span id="L980"><span class="lineNum">     980</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (std::pair&lt;const uint256, CWalletTx&gt;&amp; item : mapWallet)</span></span>
<span id="L981"><span class="lineNum">     981</span>                 :<span class="tlaUNC">           0 :             item.second.MarkDirty();</span></span>
<span id="L982"><span class="lineNum">     982</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L983"><span class="lineNum">     983</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L984"><span class="lineNum">     984</span>                 :             : </span>
<span id="L985"><span class="lineNum">     985</span>                 :<span class="tlaUNC">           0 : bool CWallet::MarkReplaced(const uint256&amp; originalHash, const uint256&amp; newHash)</span></span>
<span id="L986"><span class="lineNum">     986</span>                 :             : {</span>
<span id="L987"><span class="lineNum">     987</span>                 :<span class="tlaUNC">           0 :     LOCK(cs_wallet);</span></span>
<span id="L988"><span class="lineNum">     988</span>                 :             : </span>
<span id="L989"><span class="lineNum">     989</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     auto mi = mapWallet.find(originalHash);</span></span>
<span id="L990"><span class="lineNum">     990</span>                 :             : </span>
<span id="L991"><span class="lineNum">     991</span>                 :             :     // There is a bug if MarkReplaced is not called on an existing wallet transaction.</span>
<span id="L992"><span class="lineNum">     992</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     assert(mi != mapWallet.end());</span></span>
<span id="L993"><span class="lineNum">     993</span>                 :             : </span>
<span id="L994"><span class="lineNum">     994</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     CWalletTx&amp; wtx = (*mi).second;</span></span>
<span id="L995"><span class="lineNum">     995</span>                 :             : </span>
<span id="L996"><span class="lineNum">     996</span>                 :             :     // Ensure for now that we're not overwriting data</span>
<span id="L997"><span class="lineNum">     997</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     assert(wtx.mapValue.count(&quot;replaced_by_txid&quot;) == 0);</span></span>
<span id="L998"><span class="lineNum">     998</span>                 :             : </span>
<span id="L999"><span class="lineNum">     999</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     wtx.mapValue[&quot;replaced_by_txid&quot;] = newHash.ToString();</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L1000"><span class="lineNum">    1000</span>                 :             : </span>
<span id="L1001"><span class="lineNum">    1001</span>                 :             :     // Refresh mempool status without waiting for transactionRemovedFromMempool or transactionAddedToMempool</span>
<span id="L1002"><span class="lineNum">    1002</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     RefreshMempoolStatus(wtx, chain());</span></span>
<span id="L1003"><span class="lineNum">    1003</span>                 :             : </span>
<span id="L1004"><span class="lineNum">    1004</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     WalletBatch batch(GetDatabase());</span></span>
<span id="L1005"><span class="lineNum">    1005</span>                 :             : </span>
<span id="L1006"><span class="lineNum">    1006</span>                 :<span class="tlaUNC">           0 :     bool success = true;</span></span>
<span id="L1007"><span class="lineNum">    1007</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!batch.WriteTx(wtx)) {</span></span>
<span id="L1008"><span class="lineNum">    1008</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         WalletLogPrintf(&quot;%s: Updating batch tx %s failed\n&quot;, __func__, wtx.GetHash().ToString());</span></span>
<span id="L1009"><span class="lineNum">    1009</span>                 :<span class="tlaUNC">           0 :         success = false;</span></span>
<span id="L1010"><span class="lineNum">    1010</span>                 :             :     }</span>
<span id="L1011"><span class="lineNum">    1011</span>                 :             : </span>
<span id="L1012"><span class="lineNum">    1012</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     NotifyTransactionChanged(originalHash, CT_UPDATED);</span></span>
<span id="L1013"><span class="lineNum">    1013</span>                 :             : </span>
<span id="L1014"><span class="lineNum">    1014</span>                 :<span class="tlaUNC">           0 :     return success;</span></span>
<span id="L1015"><span class="lineNum">    1015</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 : }</span></span>
<span id="L1016"><span class="lineNum">    1016</span>                 :             : </span>
<span id="L1017"><span class="lineNum">    1017</span>                 :<span class="tlaUNC">           0 : void CWallet::SetSpentKeyState(WalletBatch&amp; batch, const uint256&amp; hash, unsigned int n, bool used, std::set&lt;CTxDestination&gt;&amp; tx_destinations)</span></span>
<span id="L1018"><span class="lineNum">    1018</span>                 :             : {</span>
<span id="L1019"><span class="lineNum">    1019</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L1020"><span class="lineNum">    1020</span>                 :<span class="tlaUNC">           0 :     const CWalletTx* srctx = GetWalletTx(hash);</span></span>
<span id="L1021"><span class="lineNum">    1021</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!srctx) return;</span></span>
<span id="L1022"><span class="lineNum">    1022</span>                 :             : </span>
<span id="L1023"><span class="lineNum">    1023</span>                 :<span class="tlaUNC">           0 :     CTxDestination dst;</span></span>
<span id="L1024"><span class="lineNum">    1024</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (ExtractDestination(srctx-&gt;tx-&gt;vout[n].scriptPubKey, dst)) {</span></span>
<span id="L1025"><span class="lineNum">    1025</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (IsMine(dst)) {</span></span>
<span id="L1026"><span class="lineNum">    1026</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (used != IsAddressPreviouslySpent(dst)) {</span></span>
<span id="L1027"><span class="lineNum">    1027</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 if (used) {</span></span>
<span id="L1028"><span class="lineNum">    1028</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     tx_destinations.insert(dst);</span></span>
<span id="L1029"><span class="lineNum">    1029</span>                 :             :                 }</span>
<span id="L1030"><span class="lineNum">    1030</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 SetAddressPreviouslySpent(batch, dst, used);</span></span>
<span id="L1031"><span class="lineNum">    1031</span>                 :             :             }</span>
<span id="L1032"><span class="lineNum">    1032</span>                 :             :         }</span>
<span id="L1033"><span class="lineNum">    1033</span>                 :             :     }</span>
<span id="L1034"><span class="lineNum">    1034</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L1035"><span class="lineNum">    1035</span>                 :             : </span>
<span id="L1036"><span class="lineNum">    1036</span>                 :<span class="tlaUNC">           0 : bool CWallet::IsSpentKey(const CScript&amp; scriptPubKey) const</span></span>
<span id="L1037"><span class="lineNum">    1037</span>                 :             : {</span>
<span id="L1038"><span class="lineNum">    1038</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L1039"><span class="lineNum">    1039</span>                 :<span class="tlaUNC">           0 :     CTxDestination dest;</span></span>
<span id="L1040"><span class="lineNum">    1040</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!ExtractDestination(scriptPubKey, dest)) {</span></span>
<span id="L1041"><span class="lineNum">    1041</span>                 :             :         return false;</span>
<span id="L1042"><span class="lineNum">    1042</span>                 :             :     }</span>
<span id="L1043"><span class="lineNum">    1043</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (IsAddressPreviouslySpent(dest)) {</span></span>
<span id="L1044"><span class="lineNum">    1044</span>                 :             :         return true;</span>
<span id="L1045"><span class="lineNum">    1045</span>                 :             :     }</span>
<span id="L1046"><span class="lineNum">    1046</span>                 :             : </span>
<span id="L1047"><span class="lineNum">    1047</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (LegacyScriptPubKeyMan* spk_man = GetLegacyScriptPubKeyMan()) {</span></span>
<span id="L1048"><span class="lineNum">    1048</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (const auto&amp; keyid : GetAffectedKeys(scriptPubKey, *spk_man)) {</span></span>
<span id="L1049"><span class="lineNum">    1049</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             WitnessV0KeyHash wpkh_dest(keyid);</span></span>
<span id="L1050"><span class="lineNum">    1050</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (IsAddressPreviouslySpent(wpkh_dest)) {</span></span>
<span id="L1051"><span class="lineNum">    1051</span>                 :             :                 return true;</span>
<span id="L1052"><span class="lineNum">    1052</span>                 :             :             }</span>
<span id="L1053"><span class="lineNum">    1053</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             ScriptHash sh_wpkh_dest(GetScriptForDestination(wpkh_dest));</span></span>
<span id="L1054"><span class="lineNum">    1054</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (IsAddressPreviouslySpent(sh_wpkh_dest)) {</span></span>
<span id="L1055"><span class="lineNum">    1055</span>                 :             :                 return true;</span>
<span id="L1056"><span class="lineNum">    1056</span>                 :             :             }</span>
<span id="L1057"><span class="lineNum">    1057</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             PKHash pkh_dest(keyid);</span></span>
<span id="L1058"><span class="lineNum">    1058</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (IsAddressPreviouslySpent(pkh_dest)) {</span></span>
<span id="L1059"><span class="lineNum">    1059</span>                 :             :                 return true;</span>
<span id="L1060"><span class="lineNum">    1060</span>                 :             :             }</span>
<span id="L1061"><span class="lineNum">    1061</span>                 :<span class="tlaUNC">           0 :         }</span></span>
<span id="L1062"><span class="lineNum">    1062</span>                 :             :     }</span>
<span id="L1063"><span class="lineNum">    1063</span>                 :             :     return false;</span>
<span id="L1064"><span class="lineNum">    1064</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L1065"><span class="lineNum">    1065</span>                 :             : </span>
<span id="L1066"><span class="lineNum">    1066</span>                 :<span class="tlaUNC">           0 : CWalletTx* CWallet::AddToWallet(CTransactionRef tx, const TxState&amp; state, const UpdateWalletTxFn&amp; update_wtx, bool fFlushOnClose, bool rescanning_old_block)</span></span>
<span id="L1067"><span class="lineNum">    1067</span>                 :             : {</span>
<span id="L1068"><span class="lineNum">    1068</span>                 :<span class="tlaUNC">           0 :     LOCK(cs_wallet);</span></span>
<span id="L1069"><span class="lineNum">    1069</span>                 :             : </span>
<span id="L1070"><span class="lineNum">    1070</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     WalletBatch batch(GetDatabase(), fFlushOnClose);</span></span>
<span id="L1071"><span class="lineNum">    1071</span>                 :             : </span>
<span id="L1072"><span class="lineNum">    1072</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     uint256 hash = tx-&gt;GetHash();</span></span>
<span id="L1073"><span class="lineNum">    1073</span>                 :             : </span>
<span id="L1074"><span class="lineNum">    1074</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (IsWalletFlagSet(WALLET_FLAG_AVOID_REUSE)) {</span></span>
<span id="L1075"><span class="lineNum">    1075</span>                 :             :         // Mark used destinations</span>
<span id="L1076"><span class="lineNum">    1076</span>                 :<span class="tlaUNC">           0 :         std::set&lt;CTxDestination&gt; tx_destinations;</span></span>
<span id="L1077"><span class="lineNum">    1077</span>                 :             : </span>
<span id="L1078"><span class="lineNum">    1078</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (const CTxIn&amp; txin : tx-&gt;vin) {</span></span>
<span id="L1079"><span class="lineNum">    1079</span>                 :<span class="tlaUNC">           0 :             const COutPoint&amp; op = txin.prevout;</span></span>
<span id="L1080"><span class="lineNum">    1080</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             SetSpentKeyState(batch, op.hash, op.n, true, tx_destinations);</span></span>
<span id="L1081"><span class="lineNum">    1081</span>                 :             :         }</span>
<span id="L1082"><span class="lineNum">    1082</span>                 :             : </span>
<span id="L1083"><span class="lineNum">    1083</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         MarkDestinationsDirty(tx_destinations);</span></span>
<span id="L1084"><span class="lineNum">    1084</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L1085"><span class="lineNum">    1085</span>                 :             : </span>
<span id="L1086"><span class="lineNum">    1086</span>                 :             :     // Inserts only if not already there, returns tx inserted or tx found</span>
<span id="L1087"><span class="lineNum">    1087</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     auto ret = mapWallet.emplace(std::piecewise_construct, std::forward_as_tuple(hash), std::forward_as_tuple(tx, state));</span></span>
<span id="L1088"><span class="lineNum">    1088</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     CWalletTx&amp; wtx = (*ret.first).second;</span></span>
<span id="L1089"><span class="lineNum">    1089</span>                 :<span class="tlaUNC">           0 :     bool fInsertedNew = ret.second;</span></span>
<span id="L1090"><span class="lineNum">    1090</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     bool fUpdated = update_wtx &amp;&amp; update_wtx(wtx, fInsertedNew);</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L1091"><span class="lineNum">    1091</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (fInsertedNew) {</span></span>
<span id="L1092"><span class="lineNum">    1092</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         wtx.nTimeReceived = GetTime();</span></span>
<span id="L1093"><span class="lineNum">    1093</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         wtx.nOrderPos = IncOrderPosNext(&amp;batch);</span></span>
<span id="L1094"><span class="lineNum">    1094</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         wtx.m_it_wtxOrdered = wtxOrdered.insert(std::make_pair(wtx.nOrderPos, &amp;wtx));</span></span>
<span id="L1095"><span class="lineNum">    1095</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         wtx.nTimeSmart = ComputeTimeSmart(wtx, rescanning_old_block);</span></span>
<span id="L1096"><span class="lineNum">    1096</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         AddToSpends(wtx, &amp;batch);</span></span>
<span id="L1097"><span class="lineNum">    1097</span>                 :             : </span>
<span id="L1098"><span class="lineNum">    1098</span>                 :             :         // Update birth time when tx time is older than it.</span>
<span id="L1099"><span class="lineNum">    1099</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         MaybeUpdateBirthTime(wtx.GetTxTime());</span></span>
<span id="L1100"><span class="lineNum">    1100</span>                 :             :     }</span>
<span id="L1101"><span class="lineNum">    1101</span>                 :             : </span>
<span id="L1102"><span class="lineNum">    1102</span>                 :<span class="tlaUNC">           0 :     if (!fInsertedNew)</span></span>
<span id="L1103"><span class="lineNum">    1103</span>                 :             :     {</span>
<span id="L1104"><span class="lineNum">    1104</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (state.index() != wtx.m_state.index()) {</span></span>
<span id="L1105"><span class="lineNum">    1105</span>                 :<span class="tlaUNC">           0 :             wtx.m_state = state;</span></span>
<span id="L1106"><span class="lineNum">    1106</span>                 :<span class="tlaUNC">           0 :             fUpdated = true;</span></span>
<span id="L1107"><span class="lineNum">    1107</span>                 :             :         } else {</span>
<span id="L1108"><span class="lineNum">    1108</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             assert(TxStateSerializedIndex(wtx.m_state) == TxStateSerializedIndex(state));</span></span>
<span id="L1109"><span class="lineNum">    1109</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             assert(TxStateSerializedBlockHash(wtx.m_state) == TxStateSerializedBlockHash(state));</span></span>
<span id="L1110"><span class="lineNum">    1110</span>                 :             :         }</span>
<span id="L1111"><span class="lineNum">    1111</span>                 :             :         // If we have a witness-stripped version of this transaction, and we</span>
<span id="L1112"><span class="lineNum">    1112</span>                 :             :         // see a new version with a witness, then we must be upgrading a pre-segwit</span>
<span id="L1113"><span class="lineNum">    1113</span>                 :             :         // wallet.  Store the new version of the transaction with the witness,</span>
<span id="L1114"><span class="lineNum">    1114</span>                 :             :         // as the stripped-version must be invalid.</span>
<span id="L1115"><span class="lineNum">    1115</span>                 :             :         // TODO: Store all versions of the transaction, instead of just one.</span>
<span id="L1116"><span class="lineNum">    1116</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (tx-&gt;HasWitness() &amp;&amp; !wtx.tx-&gt;HasWitness()) {</span></span>
<span id="L1117"><span class="lineNum">    1117</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             wtx.SetTx(tx);</span></span>
<span id="L1118"><span class="lineNum">    1118</span>                 :<span class="tlaUNC">           0 :             fUpdated = true;</span></span>
<span id="L1119"><span class="lineNum">    1119</span>                 :             :         }</span>
<span id="L1120"><span class="lineNum">    1120</span>                 :             :     }</span>
<span id="L1121"><span class="lineNum">    1121</span>                 :             : </span>
<span id="L1122"><span class="lineNum">    1122</span>                 :             :     // Mark inactive coinbase transactions and their descendants as abandoned</span>
<span id="L1123"><span class="lineNum">    1123</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (wtx.IsCoinBase() &amp;&amp; wtx.isInactive()) {</span></span>
<span id="L1124"><span class="lineNum">    1124</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         std::vector&lt;CWalletTx*&gt; txs{&amp;wtx};</span></span>
<span id="L1125"><span class="lineNum">    1125</span>                 :             : </span>
<span id="L1126"><span class="lineNum">    1126</span>                 :<span class="tlaUNC">           0 :         TxStateInactive inactive_state = TxStateInactive{/*abandoned=*/true};</span></span>
<span id="L1127"><span class="lineNum">    1127</span>                 :             : </span>
<span id="L1128"><span class="lineNum">    1128</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         while (!txs.empty()) {</span></span>
<span id="L1129"><span class="lineNum">    1129</span>                 :<span class="tlaUNC">           0 :             CWalletTx* desc_tx = txs.back();</span></span>
<span id="L1130"><span class="lineNum">    1130</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             txs.pop_back();</span></span>
<span id="L1131"><span class="lineNum">    1131</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             desc_tx-&gt;m_state = inactive_state;</span></span>
<span id="L1132"><span class="lineNum">    1132</span>                 :             :             // Break caches since we have changed the state</span>
<span id="L1133"><span class="lineNum">    1133</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             desc_tx-&gt;MarkDirty();</span></span>
<span id="L1134"><span class="lineNum">    1134</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             batch.WriteTx(*desc_tx);</span></span>
<span id="L1135"><span class="lineNum">    1135</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             MarkInputsDirty(desc_tx-&gt;tx);</span></span>
<span id="L1136"><span class="lineNum">    1136</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             for (unsigned int i = 0; i &lt; desc_tx-&gt;tx-&gt;vout.size(); ++i) {</span></span>
<span id="L1137"><span class="lineNum">    1137</span>                 :<span class="tlaUNC">           0 :                 COutPoint outpoint(desc_tx-&gt;GetHash(), i);</span></span>
<span id="L1138"><span class="lineNum">    1138</span>                 :<span class="tlaUNC">           0 :                 std::pair&lt;TxSpends::const_iterator, TxSpends::const_iterator&gt; range = mapTxSpends.equal_range(outpoint);</span></span>
<span id="L1139"><span class="lineNum">    1139</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 for (TxSpends::const_iterator it = range.first; it != range.second; ++it) {</span></span>
<span id="L1140"><span class="lineNum">    1140</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     const auto wit = mapWallet.find(it-&gt;second);</span></span>
<span id="L1141"><span class="lineNum">    1141</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     if (wit != mapWallet.end()) {</span></span>
<span id="L1142"><span class="lineNum">    1142</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                         txs.push_back(&amp;wit-&gt;second);</span></span>
<span id="L1143"><span class="lineNum">    1143</span>                 :             :                     }</span>
<span id="L1144"><span class="lineNum">    1144</span>                 :             :                 }</span>
<span id="L1145"><span class="lineNum">    1145</span>                 :             :             }</span>
<span id="L1146"><span class="lineNum">    1146</span>                 :             :         }</span>
<span id="L1147"><span class="lineNum">    1147</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L1148"><span class="lineNum">    1148</span>                 :             : </span>
<span id="L1149"><span class="lineNum">    1149</span>                 :             :     //// debug print</span>
<span id="L1150"><span class="lineNum">    1150</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     WalletLogPrintf(&quot;AddToWallet %s  %s%s %s\n&quot;, hash.ToString(), (fInsertedNew ? &quot;new&quot; : &quot;&quot;), (fUpdated ? &quot;update&quot; : &quot;&quot;), TxStateString(state));</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not executed"> # </span>]
<span id="L1151"><span class="lineNum">    1151</span>                 :             : </span>
<span id="L1152"><span class="lineNum">    1152</span>                 :             :     // Write to disk</span>
<span id="L1153"><span class="lineNum">    1153</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (fInsertedNew || fUpdated)</span></span>
<span id="L1154"><span class="lineNum">    1154</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!batch.WriteTx(wtx))</span></span>
<span id="L1155"><span class="lineNum">    1155</span>                 :             :             return nullptr;</span>
<span id="L1156"><span class="lineNum">    1156</span>                 :             : </span>
<span id="L1157"><span class="lineNum">    1157</span>                 :             :     // Break debit/credit balance caches:</span>
<span id="L1158"><span class="lineNum">    1158</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     wtx.MarkDirty();</span></span>
<span id="L1159"><span class="lineNum">    1159</span>                 :             : </span>
<span id="L1160"><span class="lineNum">    1160</span>                 :             :     // Notify UI of new or updated transaction</span>
<span id="L1161"><span class="lineNum">    1161</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     NotifyTransactionChanged(hash, fInsertedNew ? CT_NEW : CT_UPDATED);</span></span>
<span id="L1162"><span class="lineNum">    1162</span>                 :             : </span>
<span id="L1163"><span class="lineNum">    1163</span>                 :             : #if HAVE_SYSTEM</span>
<span id="L1164"><span class="lineNum">    1164</span>                 :             :     // notify an external script when a wallet transaction comes in or is updated</span>
<span id="L1165"><span class="lineNum">    1165</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     std::string strCmd = m_notify_tx_changed_script;</span></span>
<span id="L1166"><span class="lineNum">    1166</span>                 :             : </span>
<span id="L1167"><span class="lineNum">    1167</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!strCmd.empty())</span></span>
<span id="L1168"><span class="lineNum">    1168</span>                 :             :     {</span>
<span id="L1169"><span class="lineNum">    1169</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         ReplaceAll(strCmd, &quot;%s&quot;, hash.GetHex());</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L1170"><span class="lineNum">    1170</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (auto* conf = wtx.state&lt;TxStateConfirmed&gt;())</span></span>
<span id="L1171"><span class="lineNum">    1171</span>                 :             :         {</span>
<span id="L1172"><span class="lineNum">    1172</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             ReplaceAll(strCmd, &quot;%b&quot;, conf-&gt;confirmed_block_hash.GetHex());</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L1173"><span class="lineNum">    1173</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             ReplaceAll(strCmd, &quot;%h&quot;, ToString(conf-&gt;confirmed_block_height));</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L1174"><span class="lineNum">    1174</span>                 :             :         } else {</span>
<span id="L1175"><span class="lineNum">    1175</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             ReplaceAll(strCmd, &quot;%b&quot;, &quot;unconfirmed&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L1176"><span class="lineNum">    1176</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             ReplaceAll(strCmd, &quot;%h&quot;, &quot;-1&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L1177"><span class="lineNum">    1177</span>                 :             :         }</span>
<span id="L1178"><span class="lineNum">    1178</span>                 :             : #ifndef WIN32</span>
<span id="L1179"><span class="lineNum">    1179</span>                 :             :         // Substituting the wallet name isn't currently supported on windows</span>
<span id="L1180"><span class="lineNum">    1180</span>                 :             :         // because windows shell escaping has not been implemented yet:</span>
<span id="L1181"><span class="lineNum">    1181</span>                 :             :         // https://github.com/bitcoin/bitcoin/pull/13339#issuecomment-537384875</span>
<span id="L1182"><span class="lineNum">    1182</span>                 :             :         // A few ways it could be implemented in the future are described in:</span>
<span id="L1183"><span class="lineNum">    1183</span>                 :             :         // https://github.com/bitcoin/bitcoin/pull/13339#issuecomment-461288094</span>
<span id="L1184"><span class="lineNum">    1184</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         ReplaceAll(strCmd, &quot;%w&quot;, ShellEscape(GetName()));</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L1185"><span class="lineNum">    1185</span>                 :             : #endif</span>
<span id="L1186"><span class="lineNum">    1186</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         std::thread t(runCommand, strCmd);</span></span>
<span id="L1187"><span class="lineNum">    1187</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         t.detach(); // thread runs free</span></span>
<span id="L1188"><span class="lineNum">    1188</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L1189"><span class="lineNum">    1189</span>                 :             : #endif</span>
<span id="L1190"><span class="lineNum">    1190</span>                 :             : </span>
<span id="L1191"><span class="lineNum">    1191</span>                 :<span class="tlaUNC">           0 :     return &amp;wtx;</span></span>
<span id="L1192"><span class="lineNum">    1192</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 : }</span></span>
<span id="L1193"><span class="lineNum">    1193</span>                 :             : </span>
<span id="L1194"><span class="lineNum">    1194</span>                 :<span class="tlaUNC">           0 : bool CWallet::LoadToWallet(const uint256&amp; hash, const UpdateWalletTxFn&amp; fill_wtx)</span></span>
<span id="L1195"><span class="lineNum">    1195</span>                 :             : {</span>
<span id="L1196"><span class="lineNum">    1196</span>                 :<span class="tlaUNC">           0 :     const auto&amp; ins = mapWallet.emplace(std::piecewise_construct, std::forward_as_tuple(hash), std::forward_as_tuple(nullptr, TxStateInactive{}));</span></span>
<span id="L1197"><span class="lineNum">    1197</span>                 :<span class="tlaUNC">           0 :     CWalletTx&amp; wtx = ins.first-&gt;second;</span></span>
<span id="L1198"><span class="lineNum">    1198</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!fill_wtx(wtx, ins.second)) {</span></span>
<span id="L1199"><span class="lineNum">    1199</span>                 :             :         return false;</span>
<span id="L1200"><span class="lineNum">    1200</span>                 :             :     }</span>
<span id="L1201"><span class="lineNum">    1201</span>                 :             :     // If wallet doesn't have a chain (e.g when using bitcoin-wallet tool),</span>
<span id="L1202"><span class="lineNum">    1202</span>                 :             :     // don't bother to update txn.</span>
<span id="L1203"><span class="lineNum">    1203</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (HaveChain()) {</span></span>
<span id="L1204"><span class="lineNum">    1204</span>                 :<span class="tlaUNC">           0 :       wtx.updateState(chain());</span></span>
<span id="L1205"><span class="lineNum">    1205</span>                 :             :     }</span>
<span id="L1206"><span class="lineNum">    1206</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (/* insertion took place */ ins.second) {</span></span>
<span id="L1207"><span class="lineNum">    1207</span>                 :<span class="tlaUNC">           0 :         wtx.m_it_wtxOrdered = wtxOrdered.insert(std::make_pair(wtx.nOrderPos, &amp;wtx));</span></span>
<span id="L1208"><span class="lineNum">    1208</span>                 :             :     }</span>
<span id="L1209"><span class="lineNum">    1209</span>                 :<span class="tlaUNC">           0 :     AddToSpends(wtx);</span></span>
<span id="L1210"><span class="lineNum">    1210</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (const CTxIn&amp; txin : wtx.tx-&gt;vin) {</span></span>
<span id="L1211"><span class="lineNum">    1211</span>                 :<span class="tlaUNC">           0 :         auto it = mapWallet.find(txin.prevout.hash);</span></span>
<span id="L1212"><span class="lineNum">    1212</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (it != mapWallet.end()) {</span></span>
<span id="L1213"><span class="lineNum">    1213</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             CWalletTx&amp; prevtx = it-&gt;second;</span></span>
<span id="L1214"><span class="lineNum">    1214</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (auto* prev = prevtx.state&lt;TxStateBlockConflicted&gt;()) {</span></span>
<span id="L1215"><span class="lineNum">    1215</span>                 :<span class="tlaUNC">           0 :                 MarkConflicted(prev-&gt;conflicting_block_hash, prev-&gt;conflicting_block_height, wtx.GetHash());</span></span>
<span id="L1216"><span class="lineNum">    1216</span>                 :             :             }</span>
<span id="L1217"><span class="lineNum">    1217</span>                 :             :         }</span>
<span id="L1218"><span class="lineNum">    1218</span>                 :             :     }</span>
<span id="L1219"><span class="lineNum">    1219</span>                 :             : </span>
<span id="L1220"><span class="lineNum">    1220</span>                 :             :     // Update birth time when tx time is older than it.</span>
<span id="L1221"><span class="lineNum">    1221</span>                 :<span class="tlaUNC">           0 :     MaybeUpdateBirthTime(wtx.GetTxTime());</span></span>
<span id="L1222"><span class="lineNum">    1222</span>                 :             : </span>
<span id="L1223"><span class="lineNum">    1223</span>                 :<span class="tlaUNC">           0 :     return true;</span></span>
<span id="L1224"><span class="lineNum">    1224</span>                 :             : }</span>
<span id="L1225"><span class="lineNum">    1225</span>                 :             : </span>
<span id="L1226"><span class="lineNum">    1226</span>                 :<span class="tlaUNC">           0 : bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef&amp; ptx, const SyncTxState&amp; state, bool fUpdate, bool rescanning_old_block)</span></span>
<span id="L1227"><span class="lineNum">    1227</span>                 :             : {</span>
<span id="L1228"><span class="lineNum">    1228</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     const CTransaction&amp; tx = *ptx;</span></span>
<span id="L1229"><span class="lineNum">    1229</span>                 :<span class="tlaUNC">           0 :     {</span></span>
<span id="L1230"><span class="lineNum">    1230</span>                 :<span class="tlaUNC">           0 :         AssertLockHeld(cs_wallet);</span></span>
<span id="L1231"><span class="lineNum">    1231</span>                 :             : </span>
<span id="L1232"><span class="lineNum">    1232</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (auto* conf = std::get_if&lt;TxStateConfirmed&gt;(&amp;state)) {</span></span>
<span id="L1233"><span class="lineNum">    1233</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             for (const CTxIn&amp; txin : tx.vin) {</span></span>
<span id="L1234"><span class="lineNum">    1234</span>                 :<span class="tlaUNC">           0 :                 std::pair&lt;TxSpends::const_iterator, TxSpends::const_iterator&gt; range = mapTxSpends.equal_range(txin.prevout);</span></span>
<span id="L1235"><span class="lineNum">    1235</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 while (range.first != range.second) {</span></span>
<span id="L1236"><span class="lineNum">    1236</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     if (range.first-&gt;second != tx.GetHash()) {</span></span>
<span id="L1237"><span class="lineNum">    1237</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                         WalletLogPrintf(&quot;Transaction %s (in block %s) conflicts with wallet transaction %s (both spend %s:%i)\n&quot;, tx.GetHash().ToString(), conf-&gt;confirmed_block_hash.ToString(), range.first-&gt;second.ToString(), range.first-&gt;first.hash.ToString(), range.first-&gt;first.n);</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L1238"><span class="lineNum">    1238</span>                 :<span class="tlaUNC">           0 :                         MarkConflicted(conf-&gt;confirmed_block_hash, conf-&gt;confirmed_block_height, range.first-&gt;second);</span></span>
<span id="L1239"><span class="lineNum">    1239</span>                 :             :                     }</span>
<span id="L1240"><span class="lineNum">    1240</span>                 :<span class="tlaUNC">           0 :                     range.first++;</span></span>
<span id="L1241"><span class="lineNum">    1241</span>                 :             :                 }</span>
<span id="L1242"><span class="lineNum">    1242</span>                 :             :             }</span>
<span id="L1243"><span class="lineNum">    1243</span>                 :             :         }</span>
<span id="L1244"><span class="lineNum">    1244</span>                 :             : </span>
<span id="L1245"><span class="lineNum">    1245</span>                 :<span class="tlaUNC">           0 :         bool fExisted = mapWallet.count(tx.GetHash()) != 0;</span></span>
<span id="L1246"><span class="lineNum">    1246</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (fExisted &amp;&amp; !fUpdate) return false;</span></span>
<span id="L1247"><span class="lineNum">    1247</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         if (fExisted || IsMine(tx) || IsFromMe(tx))</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L1248"><span class="lineNum">    1248</span>                 :             :         {</span>
<span id="L1249"><span class="lineNum">    1249</span>                 :             :             /* Check if any keys in the wallet keypool that were supposed to be unused</span>
<span id="L1250"><span class="lineNum">    1250</span>                 :             :              * have appeared in a new transaction. If so, remove those keys from the keypool.</span>
<span id="L1251"><span class="lineNum">    1251</span>                 :             :              * This can happen when restoring an old wallet backup that does not contain</span>
<span id="L1252"><span class="lineNum">    1252</span>                 :             :              * the mostly recently created transactions from newer versions of the wallet.</span>
<span id="L1253"><span class="lineNum">    1253</span>                 :             :              */</span>
<span id="L1254"><span class="lineNum">    1254</span>                 :             : </span>
<span id="L1255"><span class="lineNum">    1255</span>                 :             :             // loop though all outputs</span>
<span id="L1256"><span class="lineNum">    1256</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             for (const CTxOut&amp; txout: tx.vout) {</span></span>
<span id="L1257"><span class="lineNum">    1257</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 for (const auto&amp; spk_man : GetScriptPubKeyMans(txout.scriptPubKey)) {</span></span>
<span id="L1258"><span class="lineNum">    1258</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     for (auto &amp;dest : spk_man-&gt;MarkUnusedAddresses(txout.scriptPubKey)) {</span></span>
<span id="L1259"><span class="lineNum">    1259</span>                 :             :                         // If internal flag is not defined try to infer it from the ScriptPubKeyMan</span>
<span id="L1260"><span class="lineNum">    1260</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                         if (!dest.internal.has_value()) {</span></span>
<span id="L1261"><span class="lineNum">    1261</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                             dest.internal = IsInternalScriptPubKeyMan(spk_man);</span></span>
<span id="L1262"><span class="lineNum">    1262</span>                 :             :                         }</span>
<span id="L1263"><span class="lineNum">    1263</span>                 :             : </span>
<span id="L1264"><span class="lineNum">    1264</span>                 :             :                         // skip if can't determine whether it's a receiving address or not</span>
<span id="L1265"><span class="lineNum">    1265</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                         if (!dest.internal.has_value()) continue;</span></span>
<span id="L1266"><span class="lineNum">    1266</span>                 :             : </span>
<span id="L1267"><span class="lineNum">    1267</span>                 :             :                         // If this is a receiving address and it's not in the address book yet</span>
<span id="L1268"><span class="lineNum">    1268</span>                 :             :                         // (e.g. it wasn't generated on this node or we're restoring from backup)</span>
<span id="L1269"><span class="lineNum">    1269</span>                 :             :                         // add it to the address book for proper transaction accounting</span>
<span id="L1270"><span class="lineNum">    1270</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                         if (!*dest.internal &amp;&amp; !FindAddressBookEntry(dest.dest, /* allow_change= */ false)) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L1271"><span class="lineNum">    1271</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                             SetAddressBook(dest.dest, &quot;&quot;, AddressPurpose::RECEIVE);</span></span>
<span id="L1272"><span class="lineNum">    1272</span>                 :             :                         }</span>
<span id="L1273"><span class="lineNum">    1273</span>                 :<span class="tlaUNC">           0 :                     }</span></span>
<span id="L1274"><span class="lineNum">    1274</span>                 :<span class="tlaUNC">           0 :                 }</span></span>
<span id="L1275"><span class="lineNum">    1275</span>                 :             :             }</span>
<span id="L1276"><span class="lineNum">    1276</span>                 :             : </span>
<span id="L1277"><span class="lineNum">    1277</span>                 :             :             // Block disconnection override an abandoned tx as unconfirmed</span>
<span id="L1278"><span class="lineNum">    1278</span>                 :             :             // which means user may have to call abandontransaction again</span>
<span id="L1279"><span class="lineNum">    1279</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             TxState tx_state = std::visit([](auto&amp;&amp; s) -&gt; TxState { return s; }, state);</span></span>
<span id="L1280"><span class="lineNum">    1280</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             CWalletTx* wtx = AddToWallet(MakeTransactionRef(tx), tx_state, /*update_wtx=*/nullptr, /*fFlushOnClose=*/false, rescanning_old_block);</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L1281"><span class="lineNum">    1281</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (!wtx) {</span></span>
<span id="L1282"><span class="lineNum">    1282</span>                 :             :                 // Can only be nullptr if there was a db write error (missing db, read-only db or a db engine internal writing error).</span>
<span id="L1283"><span class="lineNum">    1283</span>                 :             :                 // As we only store arriving transaction in this process, and we don't want an inconsistent state, let's throw an error.</span>
<span id="L1284"><span class="lineNum">    1284</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 throw std::runtime_error(&quot;DB error adding transaction to wallet, write failed&quot;);</span></span>
<span id="L1285"><span class="lineNum">    1285</span>                 :             :             }</span>
<span id="L1286"><span class="lineNum">    1286</span>                 :             :             return true;</span>
<span id="L1287"><span class="lineNum">    1287</span>                 :             :         }</span>
<span id="L1288"><span class="lineNum">    1288</span>                 :             :     }</span>
<span id="L1289"><span class="lineNum">    1289</span>                 :             :     return false;</span>
<span id="L1290"><span class="lineNum">    1290</span>                 :             : }</span>
<span id="L1291"><span class="lineNum">    1291</span>                 :             : </span>
<span id="L1292"><span class="lineNum">    1292</span>                 :<span class="tlaUNC">           0 : bool CWallet::TransactionCanBeAbandoned(const uint256&amp; hashTx) const</span></span>
<span id="L1293"><span class="lineNum">    1293</span>                 :             : {</span>
<span id="L1294"><span class="lineNum">    1294</span>                 :<span class="tlaUNC">           0 :     LOCK(cs_wallet);</span></span>
<span id="L1295"><span class="lineNum">    1295</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     const CWalletTx* wtx = GetWalletTx(hashTx);</span></span>
<span id="L1296"><span class="lineNum">    1296</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     return wtx &amp;&amp; !wtx-&gt;isAbandoned() &amp;&amp; GetTxDepthInMainChain(*wtx) == 0 &amp;&amp; !wtx-&gt;InMempool();</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span>       <span class="tlaUNC" title="Branch 9 was not executed"> # </span><span class="tlaUNC" title="Branch 10 was not executed"> # </span><span class="tlaUNC" title="Branch 11 was not executed"> # </span>]
<span id="L1297"><span class="lineNum">    1297</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L1298"><span class="lineNum">    1298</span>                 :             : </span>
<span id="L1299"><span class="lineNum">    1299</span>                 :<span class="tlaUNC">           0 : void CWallet::MarkInputsDirty(const CTransactionRef&amp; tx)</span></span>
<span id="L1300"><span class="lineNum">    1300</span>                 :             : {</span>
<span id="L1301"><span class="lineNum">    1301</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (const CTxIn&amp; txin : tx-&gt;vin) {</span></span>
<span id="L1302"><span class="lineNum">    1302</span>                 :<span class="tlaUNC">           0 :         auto it = mapWallet.find(txin.prevout.hash);</span></span>
<span id="L1303"><span class="lineNum">    1303</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (it != mapWallet.end()) {</span></span>
<span id="L1304"><span class="lineNum">    1304</span>                 :<span class="tlaUNC">           0 :             it-&gt;second.MarkDirty();</span></span>
<span id="L1305"><span class="lineNum">    1305</span>                 :             :         }</span>
<span id="L1306"><span class="lineNum">    1306</span>                 :             :     }</span>
<span id="L1307"><span class="lineNum">    1307</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L1308"><span class="lineNum">    1308</span>                 :             : </span>
<span id="L1309"><span class="lineNum">    1309</span>                 :<span class="tlaUNC">           0 : bool CWallet::AbandonTransaction(const uint256&amp; hashTx)</span></span>
<span id="L1310"><span class="lineNum">    1310</span>                 :             : {</span>
<span id="L1311"><span class="lineNum">    1311</span>                 :<span class="tlaUNC">           0 :     LOCK(cs_wallet);</span></span>
<span id="L1312"><span class="lineNum">    1312</span>                 :             : </span>
<span id="L1313"><span class="lineNum">    1313</span>                 :             :     // Can't mark abandoned if confirmed or in mempool</span>
<span id="L1314"><span class="lineNum">    1314</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     auto it = mapWallet.find(hashTx);</span></span>
<span id="L1315"><span class="lineNum">    1315</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     assert(it != mapWallet.end());</span></span>
<span id="L1316"><span class="lineNum">    1316</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     const CWalletTx&amp; origtx = it-&gt;second;</span></span>
<span id="L1317"><span class="lineNum">    1317</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     if (GetTxDepthInMainChain(origtx) != 0 || origtx.InMempool()) {</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L1318"><span class="lineNum">    1318</span>                 :<span class="tlaUNC">           0 :         return false;</span></span>
<span id="L1319"><span class="lineNum">    1319</span>                 :             :     }</span>
<span id="L1320"><span class="lineNum">    1320</span>                 :             : </span>
<span id="L1321"><span class="lineNum">    1321</span>                 :<span class="tlaUNC">           0 :     auto try_updating_state = [](CWalletTx&amp; wtx) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet) {</span></span>
<span id="L1322"><span class="lineNum">    1322</span>                 :             :         // If the orig tx was not in block/mempool, none of its spends can be.</span>
<span id="L1323"><span class="lineNum">    1323</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         assert(!wtx.isConfirmed());</span></span>
<span id="L1324"><span class="lineNum">    1324</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         assert(!wtx.InMempool());</span></span>
<span id="L1325"><span class="lineNum">    1325</span>                 :             :         // If already conflicted or abandoned, no need to set abandoned</span>
<span id="L1326"><span class="lineNum">    1326</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!wtx.isBlockConflicted() &amp;&amp; !wtx.isAbandoned()) {</span></span>
<span id="L1327"><span class="lineNum">    1327</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             wtx.m_state = TxStateInactive{/*abandoned=*/true};</span></span>
<span id="L1328"><span class="lineNum">    1328</span>                 :<span class="tlaUNC">           0 :             return TxUpdate::NOTIFY_CHANGED;</span></span>
<span id="L1329"><span class="lineNum">    1329</span>                 :             :         }</span>
<span id="L1330"><span class="lineNum">    1330</span>                 :             :         return TxUpdate::UNCHANGED;</span>
<span id="L1331"><span class="lineNum">    1331</span>                 :             :     };</span>
<span id="L1332"><span class="lineNum">    1332</span>                 :             : </span>
<span id="L1333"><span class="lineNum">    1333</span>                 :             :     // Iterate over all its outputs, and mark transactions in the wallet that spend them abandoned too.</span>
<span id="L1334"><span class="lineNum">    1334</span>                 :             :     // States are not permanent, so these transactions can become unabandoned if they are re-added to the</span>
<span id="L1335"><span class="lineNum">    1335</span>                 :             :     // mempool, or confirmed in a block, or conflicted.</span>
<span id="L1336"><span class="lineNum">    1336</span>                 :             :     // Note: If the reorged coinbase is re-added to the main chain, the descendants that have not had their</span>
<span id="L1337"><span class="lineNum">    1337</span>                 :             :     // states change will remain abandoned and will require manual broadcast if the user wants them.</span>
<span id="L1338"><span class="lineNum">    1338</span>                 :             : </span>
<span id="L1339"><span class="lineNum">    1339</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     RecursiveUpdateTxState(hashTx, try_updating_state);</span></span>
<span id="L1340"><span class="lineNum">    1340</span>                 :             : </span>
<span id="L1341"><span class="lineNum">    1341</span>                 :<span class="tlaUNC">           0 :     return true;</span></span>
<span id="L1342"><span class="lineNum">    1342</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L1343"><span class="lineNum">    1343</span>                 :             : </span>
<span id="L1344"><span class="lineNum">    1344</span>                 :<span class="tlaUNC">           0 : void CWallet::MarkConflicted(const uint256&amp; hashBlock, int conflicting_height, const uint256&amp; hashTx)</span></span>
<span id="L1345"><span class="lineNum">    1345</span>                 :             : {</span>
<span id="L1346"><span class="lineNum">    1346</span>                 :<span class="tlaUNC">           0 :     LOCK(cs_wallet);</span></span>
<span id="L1347"><span class="lineNum">    1347</span>                 :             : </span>
<span id="L1348"><span class="lineNum">    1348</span>                 :             :     // If number of conflict confirms cannot be determined, this means</span>
<span id="L1349"><span class="lineNum">    1349</span>                 :             :     // that the block is still unknown or not yet part of the main chain,</span>
<span id="L1350"><span class="lineNum">    1350</span>                 :             :     // for example when loading the wallet during a reindex. Do nothing in that</span>
<span id="L1351"><span class="lineNum">    1351</span>                 :             :     // case.</span>
<span id="L1352"><span class="lineNum">    1352</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (m_last_block_processed_height &lt; 0 || conflicting_height &lt; 0) {</span></span>
<span id="L1353"><span class="lineNum">    1353</span>                 :             :         return;</span>
<span id="L1354"><span class="lineNum">    1354</span>                 :             :     }</span>
<span id="L1355"><span class="lineNum">    1355</span>                 :<span class="tlaUNC">           0 :     int conflictconfirms = (m_last_block_processed_height - conflicting_height + 1) * -1;</span></span>
<span id="L1356"><span class="lineNum">    1356</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (conflictconfirms &gt;= 0)</span></span>
<span id="L1357"><span class="lineNum">    1357</span>                 :             :         return;</span>
<span id="L1358"><span class="lineNum">    1358</span>                 :             : </span>
<span id="L1359"><span class="lineNum">    1359</span>                 :<span class="tlaUNC">           0 :     auto try_updating_state = [&amp;](CWalletTx&amp; wtx) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet) {</span></span>
<span id="L1360"><span class="lineNum">    1360</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (conflictconfirms &lt; GetTxDepthInMainChain(wtx)) {</span></span>
<span id="L1361"><span class="lineNum">    1361</span>                 :             :             // Block is 'more conflicted' than current confirm; update.</span>
<span id="L1362"><span class="lineNum">    1362</span>                 :             :             // Mark transaction as conflicted with this block.</span>
<span id="L1363"><span class="lineNum">    1363</span>                 :<span class="tlaUNC">           0 :             wtx.m_state = TxStateBlockConflicted{hashBlock, conflicting_height};</span></span>
<span id="L1364"><span class="lineNum">    1364</span>                 :<span class="tlaUNC">           0 :             return TxUpdate::CHANGED;</span></span>
<span id="L1365"><span class="lineNum">    1365</span>                 :             :         }</span>
<span id="L1366"><span class="lineNum">    1366</span>                 :             :         return TxUpdate::UNCHANGED;</span>
<span id="L1367"><span class="lineNum">    1367</span>                 :<span class="tlaUNC">           0 :     };</span></span>
<span id="L1368"><span class="lineNum">    1368</span>                 :             : </span>
<span id="L1369"><span class="lineNum">    1369</span>                 :             :     // Iterate over all its outputs, and mark transactions in the wallet that spend them conflicted too.</span>
<span id="L1370"><span class="lineNum">    1370</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     RecursiveUpdateTxState(hashTx, try_updating_state);</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L1371"><span class="lineNum">    1371</span>                 :             : </span>
<span id="L1372"><span class="lineNum">    1372</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L1373"><span class="lineNum">    1373</span>                 :             : </span>
<span id="L1374"><span class="lineNum">    1374</span>                 :<span class="tlaUNC">           0 : void CWallet::RecursiveUpdateTxState(const uint256&amp; tx_hash, const TryUpdatingStateFn&amp; try_updating_state) {</span></span>
<span id="L1375"><span class="lineNum">    1375</span>                 :             :     // Do not flush the wallet here for performance reasons</span>
<span id="L1376"><span class="lineNum">    1376</span>                 :<span class="tlaUNC">           0 :     WalletBatch batch(GetDatabase(), false);</span></span>
<span id="L1377"><span class="lineNum">    1377</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     RecursiveUpdateTxState(&amp;batch, tx_hash, try_updating_state);</span></span>
<span id="L1378"><span class="lineNum">    1378</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L1379"><span class="lineNum">    1379</span>                 :             : </span>
<span id="L1380"><span class="lineNum">    1380</span>                 :<span class="tlaUNC">           0 : void CWallet::RecursiveUpdateTxState(WalletBatch* batch, const uint256&amp; tx_hash, const TryUpdatingStateFn&amp; try_updating_state) {</span></span>
<span id="L1381"><span class="lineNum">    1381</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     std::set&lt;uint256&gt; todo;</span></span>
<span id="L1382"><span class="lineNum">    1382</span>                 :<span class="tlaUNC">           0 :     std::set&lt;uint256&gt; done;</span></span>
<span id="L1383"><span class="lineNum">    1383</span>                 :             : </span>
<span id="L1384"><span class="lineNum">    1384</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     todo.insert(tx_hash);</span></span>
<span id="L1385"><span class="lineNum">    1385</span>                 :             : </span>
<span id="L1386"><span class="lineNum">    1386</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     while (!todo.empty()) {</span></span>
<span id="L1387"><span class="lineNum">    1387</span>                 :<span class="tlaUNC">           0 :         uint256 now = *todo.begin();</span></span>
<span id="L1388"><span class="lineNum">    1388</span>                 :<span class="tlaUNC">           0 :         todo.erase(now);</span></span>
<span id="L1389"><span class="lineNum">    1389</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         done.insert(now);</span></span>
<span id="L1390"><span class="lineNum">    1390</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         auto it = mapWallet.find(now);</span></span>
<span id="L1391"><span class="lineNum">    1391</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         assert(it != mapWallet.end());</span></span>
<span id="L1392"><span class="lineNum">    1392</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         CWalletTx&amp; wtx = it-&gt;second;</span></span>
<span id="L1393"><span class="lineNum">    1393</span>                 :             : </span>
<span id="L1394"><span class="lineNum">    1394</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         TxUpdate update_state = try_updating_state(wtx);</span></span>
<span id="L1395"><span class="lineNum">    1395</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (update_state != TxUpdate::UNCHANGED) {</span></span>
<span id="L1396"><span class="lineNum">    1396</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             wtx.MarkDirty();</span></span>
<span id="L1397"><span class="lineNum">    1397</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (batch) batch-&gt;WriteTx(wtx);</span></span>
<span id="L1398"><span class="lineNum">    1398</span>                 :             :             // Iterate over all its outputs, and update those tx states as well (if applicable)</span>
<span id="L1399"><span class="lineNum">    1399</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             for (unsigned int i = 0; i &lt; wtx.tx-&gt;vout.size(); ++i) {</span></span>
<span id="L1400"><span class="lineNum">    1400</span>                 :<span class="tlaUNC">           0 :                 std::pair&lt;TxSpends::const_iterator, TxSpends::const_iterator&gt; range = mapTxSpends.equal_range(COutPoint(Txid::FromUint256(now), i));</span></span>
<span id="L1401"><span class="lineNum">    1401</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 for (TxSpends::const_iterator iter = range.first; iter != range.second; ++iter) {</span></span>
<span id="L1402"><span class="lineNum">    1402</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     if (!done.count(iter-&gt;second)) {</span></span>
<span id="L1403"><span class="lineNum">    1403</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                         todo.insert(iter-&gt;second);</span></span>
<span id="L1404"><span class="lineNum">    1404</span>                 :             :                     }</span>
<span id="L1405"><span class="lineNum">    1405</span>                 :             :                 }</span>
<span id="L1406"><span class="lineNum">    1406</span>                 :             :             }</span>
<span id="L1407"><span class="lineNum">    1407</span>                 :             : </span>
<span id="L1408"><span class="lineNum">    1408</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (update_state == TxUpdate::NOTIFY_CHANGED) {</span></span>
<span id="L1409"><span class="lineNum">    1409</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 NotifyTransactionChanged(wtx.GetHash(), CT_UPDATED);</span></span>
<span id="L1410"><span class="lineNum">    1410</span>                 :             :             }</span>
<span id="L1411"><span class="lineNum">    1411</span>                 :             : </span>
<span id="L1412"><span class="lineNum">    1412</span>                 :             :             // If a transaction changes its tx state, that usually changes the balance</span>
<span id="L1413"><span class="lineNum">    1413</span>                 :             :             // available of the outputs it spends. So force those to be recomputed</span>
<span id="L1414"><span class="lineNum">    1414</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             MarkInputsDirty(wtx.tx);</span></span>
<span id="L1415"><span class="lineNum">    1415</span>                 :             :         }</span>
<span id="L1416"><span class="lineNum">    1416</span>                 :             :     }</span>
<span id="L1417"><span class="lineNum">    1417</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L1418"><span class="lineNum">    1418</span>                 :             : </span>
<span id="L1419"><span class="lineNum">    1419</span>                 :<span class="tlaUNC">           0 : void CWallet::SyncTransaction(const CTransactionRef&amp; ptx, const SyncTxState&amp; state, bool update_tx, bool rescanning_old_block)</span></span>
<span id="L1420"><span class="lineNum">    1420</span>                 :             : {</span>
<span id="L1421"><span class="lineNum">    1421</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!AddToWalletIfInvolvingMe(ptx, state, update_tx, rescanning_old_block))</span></span>
<span id="L1422"><span class="lineNum">    1422</span>                 :             :         return; // Not one of ours</span>
<span id="L1423"><span class="lineNum">    1423</span>                 :             : </span>
<span id="L1424"><span class="lineNum">    1424</span>                 :             :     // If a transaction changes 'conflicted' state, that changes the balance</span>
<span id="L1425"><span class="lineNum">    1425</span>                 :             :     // available of the outputs it spends. So force those to be</span>
<span id="L1426"><span class="lineNum">    1426</span>                 :             :     // recomputed, also:</span>
<span id="L1427"><span class="lineNum">    1427</span>                 :<span class="tlaUNC">           0 :     MarkInputsDirty(ptx);</span></span>
<span id="L1428"><span class="lineNum">    1428</span>                 :             : }</span>
<span id="L1429"><span class="lineNum">    1429</span>                 :             : </span>
<span id="L1430"><span class="lineNum">    1430</span>                 :<span class="tlaUNC">           0 : void CWallet::transactionAddedToMempool(const CTransactionRef&amp; tx) {</span></span>
<span id="L1431"><span class="lineNum">    1431</span>                 :<span class="tlaUNC">           0 :     LOCK(cs_wallet);</span></span>
<span id="L1432"><span class="lineNum">    1432</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     SyncTransaction(tx, TxStateInMempool{});</span></span>
<span id="L1433"><span class="lineNum">    1433</span>                 :             : </span>
<span id="L1434"><span class="lineNum">    1434</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     auto it = mapWallet.find(tx-&gt;GetHash());</span></span>
<span id="L1435"><span class="lineNum">    1435</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (it != mapWallet.end()) {</span></span>
<span id="L1436"><span class="lineNum">    1436</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         RefreshMempoolStatus(it-&gt;second, chain());</span></span>
<span id="L1437"><span class="lineNum">    1437</span>                 :             :     }</span>
<span id="L1438"><span class="lineNum">    1438</span>                 :             : </span>
<span id="L1439"><span class="lineNum">    1439</span>                 :<span class="tlaUNC">           0 :     const Txid&amp; txid = tx-&gt;GetHash();</span></span>
<span id="L1440"><span class="lineNum">    1440</span>                 :             : </span>
<span id="L1441"><span class="lineNum">    1441</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (const CTxIn&amp; tx_in : tx-&gt;vin) {</span></span>
<span id="L1442"><span class="lineNum">    1442</span>                 :             :         // For each wallet transaction spending this prevout..</span>
<span id="L1443"><span class="lineNum">    1443</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (auto range = mapTxSpends.equal_range(tx_in.prevout); range.first != range.second; range.first++) {</span></span>
<span id="L1444"><span class="lineNum">    1444</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             const uint256&amp; spent_id = range.first-&gt;second;</span></span>
<span id="L1445"><span class="lineNum">    1445</span>                 :             :             // Skip the recently added tx</span>
<span id="L1446"><span class="lineNum">    1446</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (spent_id == txid) continue;</span></span>
<span id="L1447"><span class="lineNum">    1447</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             RecursiveUpdateTxState(/*batch=*/nullptr, spent_id, [&amp;txid](CWalletTx&amp; wtx) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet) {</span></span>
<span id="L1448"><span class="lineNum">    1448</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 return wtx.mempool_conflicts.insert(txid).second ? TxUpdate::CHANGED : TxUpdate::UNCHANGED;</span></span>
<span id="L1449"><span class="lineNum">    1449</span>                 :             :             });</span>
<span id="L1450"><span class="lineNum">    1450</span>                 :             :         }</span>
<span id="L1451"><span class="lineNum">    1451</span>                 :             :     }</span>
<span id="L1452"><span class="lineNum">    1452</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L1453"><span class="lineNum">    1453</span>                 :             : </span>
<span id="L1454"><span class="lineNum">    1454</span>                 :<span class="tlaUNC">           0 : void CWallet::transactionRemovedFromMempool(const CTransactionRef&amp; tx, MemPoolRemovalReason reason) {</span></span>
<span id="L1455"><span class="lineNum">    1455</span>                 :<span class="tlaUNC">           0 :     LOCK(cs_wallet);</span></span>
<span id="L1456"><span class="lineNum">    1456</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     auto it = mapWallet.find(tx-&gt;GetHash());</span></span>
<span id="L1457"><span class="lineNum">    1457</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (it != mapWallet.end()) {</span></span>
<span id="L1458"><span class="lineNum">    1458</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         RefreshMempoolStatus(it-&gt;second, chain());</span></span>
<span id="L1459"><span class="lineNum">    1459</span>                 :             :     }</span>
<span id="L1460"><span class="lineNum">    1460</span>                 :             :     // Handle transactions that were removed from the mempool because they</span>
<span id="L1461"><span class="lineNum">    1461</span>                 :             :     // conflict with transactions in a newly connected block.</span>
<span id="L1462"><span class="lineNum">    1462</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (reason == MemPoolRemovalReason::CONFLICT) {</span></span>
<span id="L1463"><span class="lineNum">    1463</span>                 :             :         // Trigger external -walletnotify notifications for these transactions.</span>
<span id="L1464"><span class="lineNum">    1464</span>                 :             :         // Set Status::UNCONFIRMED instead of Status::CONFLICTED for a few reasons:</span>
<span id="L1465"><span class="lineNum">    1465</span>                 :             :         //</span>
<span id="L1466"><span class="lineNum">    1466</span>                 :             :         // 1. The transactionRemovedFromMempool callback does not currently</span>
<span id="L1467"><span class="lineNum">    1467</span>                 :             :         //    provide the conflicting block's hash and height, and for backwards</span>
<span id="L1468"><span class="lineNum">    1468</span>                 :             :         //    compatibility reasons it may not be not safe to store conflicted</span>
<span id="L1469"><span class="lineNum">    1469</span>                 :             :         //    wallet transactions with a null block hash. See</span>
<span id="L1470"><span class="lineNum">    1470</span>                 :             :         //    https://github.com/bitcoin/bitcoin/pull/18600#discussion_r420195993.</span>
<span id="L1471"><span class="lineNum">    1471</span>                 :             :         // 2. For most of these transactions, the wallet's internal conflict</span>
<span id="L1472"><span class="lineNum">    1472</span>                 :             :         //    detection in the blockConnected handler will subsequently call</span>
<span id="L1473"><span class="lineNum">    1473</span>                 :             :         //    MarkConflicted and update them with CONFLICTED status anyway. This</span>
<span id="L1474"><span class="lineNum">    1474</span>                 :             :         //    applies to any wallet transaction that has inputs spent in the</span>
<span id="L1475"><span class="lineNum">    1475</span>                 :             :         //    block, or that has ancestors in the wallet with inputs spent by</span>
<span id="L1476"><span class="lineNum">    1476</span>                 :             :         //    the block.</span>
<span id="L1477"><span class="lineNum">    1477</span>                 :             :         // 3. Longstanding behavior since the sync implementation in</span>
<span id="L1478"><span class="lineNum">    1478</span>                 :             :         //    https://github.com/bitcoin/bitcoin/pull/9371 and the prior sync</span>
<span id="L1479"><span class="lineNum">    1479</span>                 :             :         //    implementation before that was to mark these transactions</span>
<span id="L1480"><span class="lineNum">    1480</span>                 :             :         //    unconfirmed rather than conflicted.</span>
<span id="L1481"><span class="lineNum">    1481</span>                 :             :         //</span>
<span id="L1482"><span class="lineNum">    1482</span>                 :             :         // Nothing described above should be seen as an unchangeable requirement</span>
<span id="L1483"><span class="lineNum">    1483</span>                 :             :         // when improving this code in the future. The wallet's heuristics for</span>
<span id="L1484"><span class="lineNum">    1484</span>                 :             :         // distinguishing between conflicted and unconfirmed transactions are</span>
<span id="L1485"><span class="lineNum">    1485</span>                 :             :         // imperfect, and could be improved in general, see</span>
<span id="L1486"><span class="lineNum">    1486</span>                 :             :         // https://github.com/bitcoin-core/bitcoin-devwiki/wiki/Wallet-Transaction-Conflict-Tracking</span>
<span id="L1487"><span class="lineNum">    1487</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         SyncTransaction(tx, TxStateInactive{});</span></span>
<span id="L1488"><span class="lineNum">    1488</span>                 :             :     }</span>
<span id="L1489"><span class="lineNum">    1489</span>                 :             : </span>
<span id="L1490"><span class="lineNum">    1490</span>                 :<span class="tlaUNC">           0 :     const Txid&amp; txid = tx-&gt;GetHash();</span></span>
<span id="L1491"><span class="lineNum">    1491</span>                 :             : </span>
<span id="L1492"><span class="lineNum">    1492</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (const CTxIn&amp; tx_in : tx-&gt;vin) {</span></span>
<span id="L1493"><span class="lineNum">    1493</span>                 :             :         // Iterate over all wallet transactions spending txin.prev</span>
<span id="L1494"><span class="lineNum">    1494</span>                 :             :         // and recursively mark them as no longer conflicting with</span>
<span id="L1495"><span class="lineNum">    1495</span>                 :             :         // txid</span>
<span id="L1496"><span class="lineNum">    1496</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (auto range = mapTxSpends.equal_range(tx_in.prevout); range.first != range.second; range.first++) {</span></span>
<span id="L1497"><span class="lineNum">    1497</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             const uint256&amp; spent_id = range.first-&gt;second;</span></span>
<span id="L1498"><span class="lineNum">    1498</span>                 :             : </span>
<span id="L1499"><span class="lineNum">    1499</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             RecursiveUpdateTxState(/*batch=*/nullptr, spent_id, [&amp;txid](CWalletTx&amp; wtx) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet) {</span></span>
<span id="L1500"><span class="lineNum">    1500</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 return wtx.mempool_conflicts.erase(txid) ? TxUpdate::CHANGED : TxUpdate::UNCHANGED;</span></span>
<span id="L1501"><span class="lineNum">    1501</span>                 :             :             });</span>
<span id="L1502"><span class="lineNum">    1502</span>                 :             :         }</span>
<span id="L1503"><span class="lineNum">    1503</span>                 :             :     }</span>
<span id="L1504"><span class="lineNum">    1504</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L1505"><span class="lineNum">    1505</span>                 :             : </span>
<span id="L1506"><span class="lineNum">    1506</span>                 :<span class="tlaUNC">           0 : void CWallet::blockConnected(ChainstateRole role, const interfaces::BlockInfo&amp; block)</span></span>
<span id="L1507"><span class="lineNum">    1507</span>                 :             : {</span>
<span id="L1508"><span class="lineNum">    1508</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (role == ChainstateRole::BACKGROUND) {</span></span>
<span id="L1509"><span class="lineNum">    1509</span>                 :             :         return;</span>
<span id="L1510"><span class="lineNum">    1510</span>                 :             :     }</span>
<span id="L1511"><span class="lineNum">    1511</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     assert(block.data);</span></span>
<span id="L1512"><span class="lineNum">    1512</span>                 :<span class="tlaUNC">           0 :     LOCK(cs_wallet);</span></span>
<span id="L1513"><span class="lineNum">    1513</span>                 :             : </span>
<span id="L1514"><span class="lineNum">    1514</span>                 :<span class="tlaUNC">           0 :     m_last_block_processed_height = block.height;</span></span>
<span id="L1515"><span class="lineNum">    1515</span>                 :<span class="tlaUNC">           0 :     m_last_block_processed = block.hash;</span></span>
<span id="L1516"><span class="lineNum">    1516</span>                 :             : </span>
<span id="L1517"><span class="lineNum">    1517</span>                 :             :     // No need to scan block if it was created before the wallet birthday.</span>
<span id="L1518"><span class="lineNum">    1518</span>                 :             :     // Uses chain max time and twice the grace period to adjust time for block time variability.</span>
<span id="L1519"><span class="lineNum">    1519</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (block.chain_time_max &lt; m_birth_time.load() - (TIMESTAMP_WINDOW * 2)) return;</span></span>
<span id="L1520"><span class="lineNum">    1520</span>                 :             : </span>
<span id="L1521"><span class="lineNum">    1521</span>                 :             :     // Scan block</span>
<span id="L1522"><span class="lineNum">    1522</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (size_t index = 0; index &lt; block.data-&gt;vtx.size(); index++) {</span></span>
<span id="L1523"><span class="lineNum">    1523</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         SyncTransaction(block.data-&gt;vtx[index], TxStateConfirmed{block.hash, block.height, static_cast&lt;int&gt;(index)});</span></span>
<span id="L1524"><span class="lineNum">    1524</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         transactionRemovedFromMempool(block.data-&gt;vtx[index], MemPoolRemovalReason::BLOCK);</span></span>
<span id="L1525"><span class="lineNum">    1525</span>                 :             :     }</span>
<span id="L1526"><span class="lineNum">    1526</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L1527"><span class="lineNum">    1527</span>                 :             : </span>
<span id="L1528"><span class="lineNum">    1528</span>                 :<span class="tlaUNC">           0 : void CWallet::blockDisconnected(const interfaces::BlockInfo&amp; block)</span></span>
<span id="L1529"><span class="lineNum">    1529</span>                 :             : {</span>
<span id="L1530"><span class="lineNum">    1530</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     assert(block.data);</span></span>
<span id="L1531"><span class="lineNum">    1531</span>                 :<span class="tlaUNC">           0 :     LOCK(cs_wallet);</span></span>
<span id="L1532"><span class="lineNum">    1532</span>                 :             : </span>
<span id="L1533"><span class="lineNum">    1533</span>                 :             :     // At block disconnection, this will change an abandoned transaction to</span>
<span id="L1534"><span class="lineNum">    1534</span>                 :             :     // be unconfirmed, whether or not the transaction is added back to the mempool.</span>
<span id="L1535"><span class="lineNum">    1535</span>                 :             :     // User may have to call abandontransaction again. It may be addressed in the</span>
<span id="L1536"><span class="lineNum">    1536</span>                 :             :     // future with a stickier abandoned state or even removing abandontransaction call.</span>
<span id="L1537"><span class="lineNum">    1537</span>                 :<span class="tlaUNC">           0 :     m_last_block_processed_height = block.height - 1;</span></span>
<span id="L1538"><span class="lineNum">    1538</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     m_last_block_processed = *Assert(block.prev_hash);</span></span>
<span id="L1539"><span class="lineNum">    1539</span>                 :             : </span>
<span id="L1540"><span class="lineNum">    1540</span>                 :<span class="tlaUNC">           0 :     int disconnect_height = block.height;</span></span>
<span id="L1541"><span class="lineNum">    1541</span>                 :             : </span>
<span id="L1542"><span class="lineNum">    1542</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (const CTransactionRef&amp; ptx : Assert(block.data)-&gt;vtx) {</span></span>
<span id="L1543"><span class="lineNum">    1543</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         SyncTransaction(ptx, TxStateInactive{});</span></span>
<span id="L1544"><span class="lineNum">    1544</span>                 :             : </span>
<span id="L1545"><span class="lineNum">    1545</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (const CTxIn&amp; tx_in : ptx-&gt;vin) {</span></span>
<span id="L1546"><span class="lineNum">    1546</span>                 :             :             // No other wallet transactions conflicted with this transaction</span>
<span id="L1547"><span class="lineNum">    1547</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (mapTxSpends.count(tx_in.prevout) &lt; 1) continue;</span></span>
<span id="L1548"><span class="lineNum">    1548</span>                 :             : </span>
<span id="L1549"><span class="lineNum">    1549</span>                 :<span class="tlaUNC">           0 :             std::pair&lt;TxSpends::const_iterator, TxSpends::const_iterator&gt; range = mapTxSpends.equal_range(tx_in.prevout);</span></span>
<span id="L1550"><span class="lineNum">    1550</span>                 :             : </span>
<span id="L1551"><span class="lineNum">    1551</span>                 :             :             // For all of the spends that conflict with this transaction</span>
<span id="L1552"><span class="lineNum">    1552</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             for (TxSpends::const_iterator _it = range.first; _it != range.second; ++_it) {</span></span>
<span id="L1553"><span class="lineNum">    1553</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 CWalletTx&amp; wtx = mapWallet.find(_it-&gt;second)-&gt;second;</span></span>
<span id="L1554"><span class="lineNum">    1554</span>                 :             : </span>
<span id="L1555"><span class="lineNum">    1555</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 if (!wtx.isBlockConflicted()) continue;</span></span>
<span id="L1556"><span class="lineNum">    1556</span>                 :             : </span>
<span id="L1557"><span class="lineNum">    1557</span>                 :<span class="tlaUNC">           0 :                 auto try_updating_state = [&amp;](CWalletTx&amp; tx) {</span></span>
<span id="L1558"><span class="lineNum">    1558</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     if (!tx.isBlockConflicted()) return TxUpdate::UNCHANGED;</span></span>
<span id="L1559"><span class="lineNum">    1559</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     if (tx.state&lt;TxStateBlockConflicted&gt;()-&gt;conflicting_block_height &gt;= disconnect_height) {</span></span>
<span id="L1560"><span class="lineNum">    1560</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                         tx.m_state = TxStateInactive{};</span></span>
<span id="L1561"><span class="lineNum">    1561</span>                 :<span class="tlaUNC">           0 :                         return TxUpdate::CHANGED;</span></span>
<span id="L1562"><span class="lineNum">    1562</span>                 :             :                     }</span>
<span id="L1563"><span class="lineNum">    1563</span>                 :             :                     return TxUpdate::UNCHANGED;</span>
<span id="L1564"><span class="lineNum">    1564</span>                 :<span class="tlaUNC">           0 :                 };</span></span>
<span id="L1565"><span class="lineNum">    1565</span>                 :             : </span>
<span id="L1566"><span class="lineNum">    1566</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 RecursiveUpdateTxState(wtx.tx-&gt;GetHash(), try_updating_state);</span></span>
<span id="L1567"><span class="lineNum">    1567</span>                 :             :             }</span>
<span id="L1568"><span class="lineNum">    1568</span>                 :             :         }</span>
<span id="L1569"><span class="lineNum">    1569</span>                 :             :     }</span>
<span id="L1570"><span class="lineNum">    1570</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L1571"><span class="lineNum">    1571</span>                 :             : </span>
<span id="L1572"><span class="lineNum">    1572</span>                 :<span class="tlaUNC">           0 : void CWallet::updatedBlockTip()</span></span>
<span id="L1573"><span class="lineNum">    1573</span>                 :             : {</span>
<span id="L1574"><span class="lineNum">    1574</span>                 :<span class="tlaUNC">           0 :     m_best_block_time = GetTime();</span></span>
<span id="L1575"><span class="lineNum">    1575</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L1576"><span class="lineNum">    1576</span>                 :             : </span>
<span id="L1577"><span class="lineNum">    1577</span>                 :<span class="tlaUNC">           0 : void CWallet::BlockUntilSyncedToCurrentChain() const {</span></span>
<span id="L1578"><span class="lineNum">    1578</span>                 :<span class="tlaUNC">           0 :     AssertLockNotHeld(cs_wallet);</span></span>
<span id="L1579"><span class="lineNum">    1579</span>                 :             :     // Skip the queue-draining stuff if we know we're caught up with</span>
<span id="L1580"><span class="lineNum">    1580</span>                 :             :     // chain().Tip(), otherwise put a callback in the validation interface queue and wait</span>
<span id="L1581"><span class="lineNum">    1581</span>                 :             :     // for the queue to drain enough to execute it (indicating we are caught up</span>
<span id="L1582"><span class="lineNum">    1582</span>                 :             :     // at least with the time we entered this function).</span>
<span id="L1583"><span class="lineNum">    1583</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     uint256 last_block_hash = WITH_LOCK(cs_wallet, return m_last_block_processed);</span></span>
<span id="L1584"><span class="lineNum">    1584</span>                 :<span class="tlaUNC">           0 :     chain().waitForNotificationsIfTipChanged(last_block_hash);</span></span>
<span id="L1585"><span class="lineNum">    1585</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L1586"><span class="lineNum">    1586</span>                 :             : </span>
<span id="L1587"><span class="lineNum">    1587</span>                 :             : // Note that this function doesn't distinguish between a 0-valued input,</span>
<span id="L1588"><span class="lineNum">    1588</span>                 :             : // and a not-&quot;is mine&quot; (according to the filter) input.</span>
<span id="L1589"><span class="lineNum">    1589</span>                 :<span class="tlaUNC">           0 : CAmount CWallet::GetDebit(const CTxIn &amp;txin, const isminefilter&amp; filter) const</span></span>
<span id="L1590"><span class="lineNum">    1590</span>                 :             : {</span>
<span id="L1591"><span class="lineNum">    1591</span>                 :<span class="tlaUNC">           0 :     {</span></span>
<span id="L1592"><span class="lineNum">    1592</span>                 :<span class="tlaUNC">           0 :         LOCK(cs_wallet);</span></span>
<span id="L1593"><span class="lineNum">    1593</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         const auto mi = mapWallet.find(txin.prevout.hash);</span></span>
<span id="L1594"><span class="lineNum">    1594</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (mi != mapWallet.end())</span></span>
<span id="L1595"><span class="lineNum">    1595</span>                 :             :         {</span>
<span id="L1596"><span class="lineNum">    1596</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             const CWalletTx&amp; prev = (*mi).second;</span></span>
<span id="L1597"><span class="lineNum">    1597</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (txin.prevout.n &lt; prev.tx-&gt;vout.size())</span></span>
<span id="L1598"><span class="lineNum">    1598</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 if (IsMine(prev.tx-&gt;vout[txin.prevout.n]) &amp; filter)</span></span>
<span id="L1599"><span class="lineNum">    1599</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     return prev.tx-&gt;vout[txin.prevout.n].nValue;</span></span>
<span id="L1600"><span class="lineNum">    1600</span>                 :             :         }</span>
<span id="L1601"><span class="lineNum">    1601</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L1602"><span class="lineNum">    1602</span>                 :<span class="tlaUNC">           0 :     return 0;</span></span>
<span id="L1603"><span class="lineNum">    1603</span>                 :             : }</span>
<span id="L1604"><span class="lineNum">    1604</span>                 :             : </span>
<span id="L1605"><span class="lineNum">    1605</span>                 :<span class="tlaUNC">           0 : isminetype CWallet::IsMine(const CTxOut&amp; txout) const</span></span>
<span id="L1606"><span class="lineNum">    1606</span>                 :             : {</span>
<span id="L1607"><span class="lineNum">    1607</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L1608"><span class="lineNum">    1608</span>                 :<span class="tlaUNC">           0 :     return IsMine(txout.scriptPubKey);</span></span>
<span id="L1609"><span class="lineNum">    1609</span>                 :             : }</span>
<span id="L1610"><span class="lineNum">    1610</span>                 :             : </span>
<span id="L1611"><span class="lineNum">    1611</span>                 :<span class="tlaUNC">           0 : isminetype CWallet::IsMine(const CTxDestination&amp; dest) const</span></span>
<span id="L1612"><span class="lineNum">    1612</span>                 :             : {</span>
<span id="L1613"><span class="lineNum">    1613</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L1614"><span class="lineNum">    1614</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     return IsMine(GetScriptForDestination(dest));</span></span>
<span id="L1615"><span class="lineNum">    1615</span>                 :             : }</span>
<span id="L1616"><span class="lineNum">    1616</span>                 :             : </span>
<span id="L1617"><span class="lineNum">    1617</span>                 :<span class="tlaUNC">           0 : isminetype CWallet::IsMine(const CScript&amp; script) const</span></span>
<span id="L1618"><span class="lineNum">    1618</span>                 :             : {</span>
<span id="L1619"><span class="lineNum">    1619</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L1620"><span class="lineNum">    1620</span>                 :             : </span>
<span id="L1621"><span class="lineNum">    1621</span>                 :             :     // Search the cache so that IsMine is called only on the relevant SPKMs instead of on everything in m_spk_managers</span>
<span id="L1622"><span class="lineNum">    1622</span>                 :<span class="tlaUNC">           0 :     const auto&amp; it = m_cached_spks.find(script);</span></span>
<span id="L1623"><span class="lineNum">    1623</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (it != m_cached_spks.end()) {</span></span>
<span id="L1624"><span class="lineNum">    1624</span>                 :<span class="tlaUNC">           0 :         isminetype res = ISMINE_NO;</span></span>
<span id="L1625"><span class="lineNum">    1625</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (const auto&amp; spkm : it-&gt;second) {</span></span>
<span id="L1626"><span class="lineNum">    1626</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             res = std::max(res, spkm-&gt;IsMine(script));</span></span>
<span id="L1627"><span class="lineNum">    1627</span>                 :             :         }</span>
<span id="L1628"><span class="lineNum">    1628</span>                 :<span class="tlaUNC">           0 :         Assume(res == ISMINE_SPENDABLE);</span></span>
<span id="L1629"><span class="lineNum">    1629</span>                 :<span class="tlaUNC">           0 :         return res;</span></span>
<span id="L1630"><span class="lineNum">    1630</span>                 :             :     }</span>
<span id="L1631"><span class="lineNum">    1631</span>                 :             : </span>
<span id="L1632"><span class="lineNum">    1632</span>                 :             :     // Legacy wallet</span>
<span id="L1633"><span class="lineNum">    1633</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (LegacyScriptPubKeyMan* spkm = GetLegacyScriptPubKeyMan()) {</span></span>
<span id="L1634"><span class="lineNum">    1634</span>                 :<span class="tlaUNC">           0 :         return spkm-&gt;IsMine(script);</span></span>
<span id="L1635"><span class="lineNum">    1635</span>                 :             :     }</span>
<span id="L1636"><span class="lineNum">    1636</span>                 :             : </span>
<span id="L1637"><span class="lineNum">    1637</span>                 :             :     return ISMINE_NO;</span>
<span id="L1638"><span class="lineNum">    1638</span>                 :             : }</span>
<span id="L1639"><span class="lineNum">    1639</span>                 :             : </span>
<span id="L1640"><span class="lineNum">    1640</span>                 :<span class="tlaUNC">           0 : bool CWallet::IsMine(const CTransaction&amp; tx) const</span></span>
<span id="L1641"><span class="lineNum">    1641</span>                 :             : {</span>
<span id="L1642"><span class="lineNum">    1642</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L1643"><span class="lineNum">    1643</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (const CTxOut&amp; txout : tx.vout)</span></span>
<span id="L1644"><span class="lineNum">    1644</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (IsMine(txout))</span></span>
<span id="L1645"><span class="lineNum">    1645</span>                 :             :             return true;</span>
<span id="L1646"><span class="lineNum">    1646</span>                 :             :     return false;</span>
<span id="L1647"><span class="lineNum">    1647</span>                 :             : }</span>
<span id="L1648"><span class="lineNum">    1648</span>                 :             : </span>
<span id="L1649"><span class="lineNum">    1649</span>                 :<span class="tlaUNC">           0 : isminetype CWallet::IsMine(const COutPoint&amp; outpoint) const</span></span>
<span id="L1650"><span class="lineNum">    1650</span>                 :             : {</span>
<span id="L1651"><span class="lineNum">    1651</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L1652"><span class="lineNum">    1652</span>                 :<span class="tlaUNC">           0 :     auto wtx = GetWalletTx(outpoint.hash);</span></span>
<span id="L1653"><span class="lineNum">    1653</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!wtx) {</span></span>
<span id="L1654"><span class="lineNum">    1654</span>                 :             :         return ISMINE_NO;</span>
<span id="L1655"><span class="lineNum">    1655</span>                 :             :     }</span>
<span id="L1656"><span class="lineNum">    1656</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (outpoint.n &gt;= wtx-&gt;tx-&gt;vout.size()) {</span></span>
<span id="L1657"><span class="lineNum">    1657</span>                 :             :         return ISMINE_NO;</span>
<span id="L1658"><span class="lineNum">    1658</span>                 :             :     }</span>
<span id="L1659"><span class="lineNum">    1659</span>                 :<span class="tlaUNC">           0 :     return IsMine(wtx-&gt;tx-&gt;vout[outpoint.n]);</span></span>
<span id="L1660"><span class="lineNum">    1660</span>                 :             : }</span>
<span id="L1661"><span class="lineNum">    1661</span>                 :             : </span>
<span id="L1662"><span class="lineNum">    1662</span>                 :<span class="tlaUNC">           0 : bool CWallet::IsFromMe(const CTransaction&amp; tx) const</span></span>
<span id="L1663"><span class="lineNum">    1663</span>                 :             : {</span>
<span id="L1664"><span class="lineNum">    1664</span>                 :<span class="tlaUNC">           0 :     return (GetDebit(tx, ISMINE_ALL) &gt; 0);</span></span>
<span id="L1665"><span class="lineNum">    1665</span>                 :             : }</span>
<span id="L1666"><span class="lineNum">    1666</span>                 :             : </span>
<span id="L1667"><span class="lineNum">    1667</span>                 :<span class="tlaUNC">           0 : CAmount CWallet::GetDebit(const CTransaction&amp; tx, const isminefilter&amp; filter) const</span></span>
<span id="L1668"><span class="lineNum">    1668</span>                 :             : {</span>
<span id="L1669"><span class="lineNum">    1669</span>                 :<span class="tlaUNC">           0 :     CAmount nDebit = 0;</span></span>
<span id="L1670"><span class="lineNum">    1670</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (const CTxIn&amp; txin : tx.vin)</span></span>
<span id="L1671"><span class="lineNum">    1671</span>                 :             :     {</span>
<span id="L1672"><span class="lineNum">    1672</span>                 :<span class="tlaUNC">           0 :         nDebit += GetDebit(txin, filter);</span></span>
<span id="L1673"><span class="lineNum">    1673</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!MoneyRange(nDebit))</span></span>
<span id="L1674"><span class="lineNum">    1674</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             throw std::runtime_error(std::string(__func__) + &quot;: value out of range&quot;);</span></span>
<span id="L1675"><span class="lineNum">    1675</span>                 :             :     }</span>
<span id="L1676"><span class="lineNum">    1676</span>                 :<span class="tlaUNC">           0 :     return nDebit;</span></span>
<span id="L1677"><span class="lineNum">    1677</span>                 :             : }</span>
<span id="L1678"><span class="lineNum">    1678</span>                 :             : </span>
<span id="L1679"><span class="lineNum">    1679</span>                 :<span class="tlaUNC">           0 : bool CWallet::IsHDEnabled() const</span></span>
<span id="L1680"><span class="lineNum">    1680</span>                 :             : {</span>
<span id="L1681"><span class="lineNum">    1681</span>                 :             :     // All Active ScriptPubKeyMans must be HD for this to be true</span>
<span id="L1682"><span class="lineNum">    1682</span>                 :<span class="tlaUNC">           0 :     bool result = false;</span></span>
<span id="L1683"><span class="lineNum">    1683</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (const auto&amp; spk_man : GetActiveScriptPubKeyMans()) {</span></span>
<span id="L1684"><span class="lineNum">    1684</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!spk_man-&gt;IsHDEnabled()) return false;</span></span>
<span id="L1685"><span class="lineNum">    1685</span>                 :<span class="tlaUNC">           0 :         result = true;</span></span>
<span id="L1686"><span class="lineNum">    1686</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L1687"><span class="lineNum">    1687</span>                 :<span class="tlaUNC">           0 :     return result;</span></span>
<span id="L1688"><span class="lineNum">    1688</span>                 :             : }</span>
<span id="L1689"><span class="lineNum">    1689</span>                 :             : </span>
<span id="L1690"><span class="lineNum">    1690</span>                 :<span class="tlaUNC">           0 : bool CWallet::CanGetAddresses(bool internal) const</span></span>
<span id="L1691"><span class="lineNum">    1691</span>                 :             : {</span>
<span id="L1692"><span class="lineNum">    1692</span>                 :<span class="tlaUNC">           0 :     LOCK(cs_wallet);</span></span>
<span id="L1693"><span class="lineNum">    1693</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (m_spk_managers.empty()) return false;</span></span>
<span id="L1694"><span class="lineNum">    1694</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (OutputType t : OUTPUT_TYPES) {</span></span>
<span id="L1695"><span class="lineNum">    1695</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         auto spk_man = GetScriptPubKeyMan(t, internal);</span></span>
<span id="L1696"><span class="lineNum">    1696</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         if (spk_man &amp;&amp; spk_man-&gt;CanGetAddresses(internal)) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L1697"><span class="lineNum">    1697</span>                 :             :             return true;</span>
<span id="L1698"><span class="lineNum">    1698</span>                 :             :         }</span>
<span id="L1699"><span class="lineNum">    1699</span>                 :             :     }</span>
<span id="L1700"><span class="lineNum">    1700</span>                 :             :     return false;</span>
<span id="L1701"><span class="lineNum">    1701</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L1702"><span class="lineNum">    1702</span>                 :             : </span>
<span id="L1703"><span class="lineNum">    1703</span>                 :<span class="tlaUNC">           0 : void CWallet::SetWalletFlag(uint64_t flags)</span></span>
<span id="L1704"><span class="lineNum">    1704</span>                 :             : {</span>
<span id="L1705"><span class="lineNum">    1705</span>                 :<span class="tlaUNC">           0 :     WalletBatch batch(GetDatabase());</span></span>
<span id="L1706"><span class="lineNum">    1706</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     return SetWalletFlagWithDB(batch, flags);</span></span>
<span id="L1707"><span class="lineNum">    1707</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L1708"><span class="lineNum">    1708</span>                 :             : </span>
<span id="L1709"><span class="lineNum">    1709</span>                 :<span class="tlaUNC">           0 : void CWallet::SetWalletFlagWithDB(WalletBatch&amp; batch, uint64_t flags)</span></span>
<span id="L1710"><span class="lineNum">    1710</span>                 :             : {</span>
<span id="L1711"><span class="lineNum">    1711</span>                 :<span class="tlaUNC">           0 :     LOCK(cs_wallet);</span></span>
<span id="L1712"><span class="lineNum">    1712</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     m_wallet_flags |= flags;</span></span>
<span id="L1713"><span class="lineNum">    1713</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!batch.WriteWalletFlags(m_wallet_flags))</span></span>
<span id="L1714"><span class="lineNum">    1714</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         throw std::runtime_error(std::string(__func__) + &quot;: writing wallet flags failed&quot;);</span></span>
<span id="L1715"><span class="lineNum">    1715</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L1716"><span class="lineNum">    1716</span>                 :             : </span>
<span id="L1717"><span class="lineNum">    1717</span>                 :<span class="tlaUNC">           0 : void CWallet::UnsetWalletFlag(uint64_t flag)</span></span>
<span id="L1718"><span class="lineNum">    1718</span>                 :             : {</span>
<span id="L1719"><span class="lineNum">    1719</span>                 :<span class="tlaUNC">           0 :     WalletBatch batch(GetDatabase());</span></span>
<span id="L1720"><span class="lineNum">    1720</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     UnsetWalletFlagWithDB(batch, flag);</span></span>
<span id="L1721"><span class="lineNum">    1721</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L1722"><span class="lineNum">    1722</span>                 :             : </span>
<span id="L1723"><span class="lineNum">    1723</span>                 :<span class="tlaUNC">           0 : void CWallet::UnsetWalletFlagWithDB(WalletBatch&amp; batch, uint64_t flag)</span></span>
<span id="L1724"><span class="lineNum">    1724</span>                 :             : {</span>
<span id="L1725"><span class="lineNum">    1725</span>                 :<span class="tlaUNC">           0 :     LOCK(cs_wallet);</span></span>
<span id="L1726"><span class="lineNum">    1726</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     m_wallet_flags &amp;= ~flag;</span></span>
<span id="L1727"><span class="lineNum">    1727</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!batch.WriteWalletFlags(m_wallet_flags))</span></span>
<span id="L1728"><span class="lineNum">    1728</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         throw std::runtime_error(std::string(__func__) + &quot;: writing wallet flags failed&quot;);</span></span>
<span id="L1729"><span class="lineNum">    1729</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L1730"><span class="lineNum">    1730</span>                 :             : </span>
<span id="L1731"><span class="lineNum">    1731</span>                 :<span class="tlaUNC">           0 : void CWallet::UnsetBlankWalletFlag(WalletBatch&amp; batch)</span></span>
<span id="L1732"><span class="lineNum">    1732</span>                 :             : {</span>
<span id="L1733"><span class="lineNum">    1733</span>                 :<span class="tlaUNC">           0 :     UnsetWalletFlagWithDB(batch, WALLET_FLAG_BLANK_WALLET);</span></span>
<span id="L1734"><span class="lineNum">    1734</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L1735"><span class="lineNum">    1735</span>                 :             : </span>
<span id="L1736"><span class="lineNum">    1736</span>                 :<span class="tlaUNC">           0 : bool CWallet::IsWalletFlagSet(uint64_t flag) const</span></span>
<span id="L1737"><span class="lineNum">    1737</span>                 :             : {</span>
<span id="L1738"><span class="lineNum">    1738</span>                 :<span class="tlaUNC">           0 :     return (m_wallet_flags &amp; flag);</span></span>
<span id="L1739"><span class="lineNum">    1739</span>                 :             : }</span>
<span id="L1740"><span class="lineNum">    1740</span>                 :             : </span>
<span id="L1741"><span class="lineNum">    1741</span>                 :<span class="tlaUNC">           0 : bool CWallet::LoadWalletFlags(uint64_t flags)</span></span>
<span id="L1742"><span class="lineNum">    1742</span>                 :             : {</span>
<span id="L1743"><span class="lineNum">    1743</span>                 :<span class="tlaUNC">           0 :     LOCK(cs_wallet);</span></span>
<span id="L1744"><span class="lineNum">    1744</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (((flags &amp; KNOWN_WALLET_FLAGS) &gt;&gt; 32) ^ (flags &gt;&gt; 32)) {</span></span>
<span id="L1745"><span class="lineNum">    1745</span>                 :             :         // contains unknown non-tolerable wallet flags</span>
<span id="L1746"><span class="lineNum">    1746</span>                 :             :         return false;</span>
<span id="L1747"><span class="lineNum">    1747</span>                 :             :     }</span>
<span id="L1748"><span class="lineNum">    1748</span>                 :<span class="tlaUNC">           0 :     m_wallet_flags = flags;</span></span>
<span id="L1749"><span class="lineNum">    1749</span>                 :             : </span>
<span id="L1750"><span class="lineNum">    1750</span>                 :<span class="tlaUNC">           0 :     return true;</span></span>
<span id="L1751"><span class="lineNum">    1751</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L1752"><span class="lineNum">    1752</span>                 :             : </span>
<span id="L1753"><span class="lineNum">    1753</span>                 :<span class="tlaUNC">           0 : void CWallet::InitWalletFlags(uint64_t flags)</span></span>
<span id="L1754"><span class="lineNum">    1754</span>                 :             : {</span>
<span id="L1755"><span class="lineNum">    1755</span>                 :<span class="tlaUNC">           0 :     LOCK(cs_wallet);</span></span>
<span id="L1756"><span class="lineNum">    1756</span>                 :             : </span>
<span id="L1757"><span class="lineNum">    1757</span>                 :             :     // We should never be writing unknown non-tolerable wallet flags</span>
<span id="L1758"><span class="lineNum">    1758</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     assert(((flags &amp; KNOWN_WALLET_FLAGS) &gt;&gt; 32) == (flags &gt;&gt; 32));</span></span>
<span id="L1759"><span class="lineNum">    1759</span>                 :             :     // This should only be used once, when creating a new wallet - so current flags are expected to be blank</span>
<span id="L1760"><span class="lineNum">    1760</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     assert(m_wallet_flags == 0);</span></span>
<span id="L1761"><span class="lineNum">    1761</span>                 :             : </span>
<span id="L1762"><span class="lineNum">    1762</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     if (!WalletBatch(GetDatabase()).WriteWalletFlags(flags)) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L1763"><span class="lineNum">    1763</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         throw std::runtime_error(std::string(__func__) + &quot;: writing wallet flags failed&quot;);</span></span>
<span id="L1764"><span class="lineNum">    1764</span>                 :             :     }</span>
<span id="L1765"><span class="lineNum">    1765</span>                 :             : </span>
<span id="L1766"><span class="lineNum">    1766</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!LoadWalletFlags(flags)) assert(false);</span></span>
<span id="L1767"><span class="lineNum">    1767</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L1768"><span class="lineNum">    1768</span>                 :             : </span>
<span id="L1769"><span class="lineNum">    1769</span>                 :<span class="tlaUNC">           0 : bool CWallet::ImportScripts(const std::set&lt;CScript&gt; scripts, int64_t timestamp)</span></span>
<span id="L1770"><span class="lineNum">    1770</span>                 :             : {</span>
<span id="L1771"><span class="lineNum">    1771</span>                 :<span class="tlaUNC">           0 :     auto spk_man = GetLegacyScriptPubKeyMan();</span></span>
<span id="L1772"><span class="lineNum">    1772</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!spk_man) {</span></span>
<span id="L1773"><span class="lineNum">    1773</span>                 :             :         return false;</span>
<span id="L1774"><span class="lineNum">    1774</span>                 :             :     }</span>
<span id="L1775"><span class="lineNum">    1775</span>                 :<span class="tlaUNC">           0 :     LOCK(spk_man-&gt;cs_KeyStore);</span></span>
<span id="L1776"><span class="lineNum">    1776</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     return spk_man-&gt;ImportScripts(scripts, timestamp);</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L1777"><span class="lineNum">    1777</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L1778"><span class="lineNum">    1778</span>                 :             : </span>
<span id="L1779"><span class="lineNum">    1779</span>                 :<span class="tlaUNC">           0 : bool CWallet::ImportPrivKeys(const std::map&lt;CKeyID, CKey&gt;&amp; privkey_map, const int64_t timestamp)</span></span>
<span id="L1780"><span class="lineNum">    1780</span>                 :             : {</span>
<span id="L1781"><span class="lineNum">    1781</span>                 :<span class="tlaUNC">           0 :     auto spk_man = GetLegacyScriptPubKeyMan();</span></span>
<span id="L1782"><span class="lineNum">    1782</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!spk_man) {</span></span>
<span id="L1783"><span class="lineNum">    1783</span>                 :             :         return false;</span>
<span id="L1784"><span class="lineNum">    1784</span>                 :             :     }</span>
<span id="L1785"><span class="lineNum">    1785</span>                 :<span class="tlaUNC">           0 :     LOCK(spk_man-&gt;cs_KeyStore);</span></span>
<span id="L1786"><span class="lineNum">    1786</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     return spk_man-&gt;ImportPrivKeys(privkey_map, timestamp);</span></span>
<span id="L1787"><span class="lineNum">    1787</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L1788"><span class="lineNum">    1788</span>                 :             : </span>
<span id="L1789"><span class="lineNum">    1789</span>                 :<span class="tlaUNC">           0 : bool CWallet::ImportPubKeys(const std::vector&lt;std::pair&lt;CKeyID, bool&gt;&gt;&amp; ordered_pubkeys, const std::map&lt;CKeyID, CPubKey&gt;&amp; pubkey_map, const std::map&lt;CKeyID, std::pair&lt;CPubKey, KeyOriginInfo&gt;&gt;&amp; key_origins, const bool add_keypool, const int64_t timestamp)</span></span>
<span id="L1790"><span class="lineNum">    1790</span>                 :             : {</span>
<span id="L1791"><span class="lineNum">    1791</span>                 :<span class="tlaUNC">           0 :     auto spk_man = GetLegacyScriptPubKeyMan();</span></span>
<span id="L1792"><span class="lineNum">    1792</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!spk_man) {</span></span>
<span id="L1793"><span class="lineNum">    1793</span>                 :             :         return false;</span>
<span id="L1794"><span class="lineNum">    1794</span>                 :             :     }</span>
<span id="L1795"><span class="lineNum">    1795</span>                 :<span class="tlaUNC">           0 :     LOCK(spk_man-&gt;cs_KeyStore);</span></span>
<span id="L1796"><span class="lineNum">    1796</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     return spk_man-&gt;ImportPubKeys(ordered_pubkeys, pubkey_map, key_origins, add_keypool, timestamp);</span></span>
<span id="L1797"><span class="lineNum">    1797</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L1798"><span class="lineNum">    1798</span>                 :             : </span>
<span id="L1799"><span class="lineNum">    1799</span>                 :<span class="tlaUNC">           0 : bool CWallet::ImportScriptPubKeys(const std::string&amp; label, const std::set&lt;CScript&gt;&amp; script_pub_keys, const bool have_solving_data, const bool apply_label, const int64_t timestamp)</span></span>
<span id="L1800"><span class="lineNum">    1800</span>                 :             : {</span>
<span id="L1801"><span class="lineNum">    1801</span>                 :<span class="tlaUNC">           0 :     auto spk_man = GetLegacyScriptPubKeyMan();</span></span>
<span id="L1802"><span class="lineNum">    1802</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!spk_man) {</span></span>
<span id="L1803"><span class="lineNum">    1803</span>                 :             :         return false;</span>
<span id="L1804"><span class="lineNum">    1804</span>                 :             :     }</span>
<span id="L1805"><span class="lineNum">    1805</span>                 :<span class="tlaUNC">           0 :     LOCK(spk_man-&gt;cs_KeyStore);</span></span>
<span id="L1806"><span class="lineNum">    1806</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!spk_man-&gt;ImportScriptPubKeys(script_pub_keys, have_solving_data, timestamp)) {</span></span>
<span id="L1807"><span class="lineNum">    1807</span>                 :             :         return false;</span>
<span id="L1808"><span class="lineNum">    1808</span>                 :             :     }</span>
<span id="L1809"><span class="lineNum">    1809</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (apply_label) {</span></span>
<span id="L1810"><span class="lineNum">    1810</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         WalletBatch batch(GetDatabase());</span></span>
<span id="L1811"><span class="lineNum">    1811</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (const CScript&amp; script : script_pub_keys) {</span></span>
<span id="L1812"><span class="lineNum">    1812</span>                 :<span class="tlaUNC">           0 :             CTxDestination dest;</span></span>
<span id="L1813"><span class="lineNum">    1813</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             ExtractDestination(script, dest);</span></span>
<span id="L1814"><span class="lineNum">    1814</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (IsValidDestination(dest)) {</span></span>
<span id="L1815"><span class="lineNum">    1815</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 SetAddressBookWithDB(batch, dest, label, AddressPurpose::RECEIVE);</span></span>
<span id="L1816"><span class="lineNum">    1816</span>                 :             :             }</span>
<span id="L1817"><span class="lineNum">    1817</span>                 :<span class="tlaUNC">           0 :         }</span></span>
<span id="L1818"><span class="lineNum">    1818</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L1819"><span class="lineNum">    1819</span>                 :             :     return true;</span>
<span id="L1820"><span class="lineNum">    1820</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L1821"><span class="lineNum">    1821</span>                 :             : </span>
<span id="L1822"><span class="lineNum">    1822</span>                 :<span class="tlaUNC">           0 : void CWallet::MaybeUpdateBirthTime(int64_t time)</span></span>
<span id="L1823"><span class="lineNum">    1823</span>                 :             : {</span>
<span id="L1824"><span class="lineNum">    1824</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     int64_t birthtime = m_birth_time.load();</span></span>
<span id="L1825"><span class="lineNum">    1825</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (time &lt; birthtime) {</span></span>
<span id="L1826"><span class="lineNum">    1826</span>                 :<span class="tlaUNC">           0 :         m_birth_time = time;</span></span>
<span id="L1827"><span class="lineNum">    1827</span>                 :             :     }</span>
<span id="L1828"><span class="lineNum">    1828</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L1829"><span class="lineNum">    1829</span>                 :             : </span>
<span id="L1830"><span class="lineNum">    1830</span>                 :             : /**</span>
<span id="L1831"><span class="lineNum">    1831</span>                 :             :  * Scan active chain for relevant transactions after importing keys. This should</span>
<span id="L1832"><span class="lineNum">    1832</span>                 :             :  * be called whenever new keys are added to the wallet, with the oldest key</span>
<span id="L1833"><span class="lineNum">    1833</span>                 :             :  * creation time.</span>
<span id="L1834"><span class="lineNum">    1834</span>                 :             :  *</span>
<span id="L1835"><span class="lineNum">    1835</span>                 :             :  * @return Earliest timestamp that could be successfully scanned from. Timestamp</span>
<span id="L1836"><span class="lineNum">    1836</span>                 :             :  * returned will be higher than startTime if relevant blocks could not be read.</span>
<span id="L1837"><span class="lineNum">    1837</span>                 :             :  */</span>
<span id="L1838"><span class="lineNum">    1838</span>                 :<span class="tlaUNC">           0 : int64_t CWallet::RescanFromTime(int64_t startTime, const WalletRescanReserver&amp; reserver, bool update)</span></span>
<span id="L1839"><span class="lineNum">    1839</span>                 :             : {</span>
<span id="L1840"><span class="lineNum">    1840</span>                 :             :     // Find starting block. May be null if nCreateTime is greater than the</span>
<span id="L1841"><span class="lineNum">    1841</span>                 :             :     // highest blockchain timestamp, in which case there is nothing that needs</span>
<span id="L1842"><span class="lineNum">    1842</span>                 :             :     // to be scanned.</span>
<span id="L1843"><span class="lineNum">    1843</span>                 :<span class="tlaUNC">           0 :     int start_height = 0;</span></span>
<span id="L1844"><span class="lineNum">    1844</span>                 :<span class="tlaUNC">           0 :     uint256 start_block;</span></span>
<span id="L1845"><span class="lineNum">    1845</span>                 :<span class="tlaUNC">           0 :     bool start = chain().findFirstBlockWithTimeAndHeight(startTime - TIMESTAMP_WINDOW, 0, FoundBlock().hash(start_block).height(start_height));</span></span>
<span id="L1846"><span class="lineNum">    1846</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     WalletLogPrintf(&quot;%s: Rescanning last %i blocks\n&quot;, __func__, start ? WITH_LOCK(cs_wallet, return GetLastBlockHeight()) - start_height + 1 : 0);</span></span>
<span id="L1847"><span class="lineNum">    1847</span>                 :             : </span>
<span id="L1848"><span class="lineNum">    1848</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (start) {</span></span>
<span id="L1849"><span class="lineNum">    1849</span>                 :             :         // TODO: this should take into account failure by ScanResult::USER_ABORT</span>
<span id="L1850"><span class="lineNum">    1850</span>                 :<span class="tlaUNC">           0 :         ScanResult result = ScanForWalletTransactions(start_block, start_height, /*max_height=*/{}, reserver, /*fUpdate=*/update, /*save_progress=*/false);</span></span>
<span id="L1851"><span class="lineNum">    1851</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (result.status == ScanResult::FAILURE) {</span></span>
<span id="L1852"><span class="lineNum">    1852</span>                 :<span class="tlaUNC">           0 :             int64_t time_max;</span></span>
<span id="L1853"><span class="lineNum">    1853</span>                 :<span class="tlaUNC">           0 :             CHECK_NONFATAL(chain().findBlock(result.last_failed_block, FoundBlock().maxTime(time_max)));</span></span>
<span id="L1854"><span class="lineNum">    1854</span>                 :<span class="tlaUNC">           0 :             return time_max + TIMESTAMP_WINDOW + 1;</span></span>
<span id="L1855"><span class="lineNum">    1855</span>                 :             :         }</span>
<span id="L1856"><span class="lineNum">    1856</span>                 :             :     }</span>
<span id="L1857"><span class="lineNum">    1857</span>                 :             :     return startTime;</span>
<span id="L1858"><span class="lineNum">    1858</span>                 :             : }</span>
<span id="L1859"><span class="lineNum">    1859</span>                 :             : </span>
<span id="L1860"><span class="lineNum">    1860</span>                 :             : /**</span>
<span id="L1861"><span class="lineNum">    1861</span>                 :             :  * Scan the block chain (starting in start_block) for transactions</span>
<span id="L1862"><span class="lineNum">    1862</span>                 :             :  * from or to us. If fUpdate is true, found transactions that already</span>
<span id="L1863"><span class="lineNum">    1863</span>                 :             :  * exist in the wallet will be updated. If max_height is not set, the</span>
<span id="L1864"><span class="lineNum">    1864</span>                 :             :  * mempool will be scanned as well.</span>
<span id="L1865"><span class="lineNum">    1865</span>                 :             :  *</span>
<span id="L1866"><span class="lineNum">    1866</span>                 :             :  * @param[in] start_block Scan starting block. If block is not on the active</span>
<span id="L1867"><span class="lineNum">    1867</span>                 :             :  *                        chain, the scan will return SUCCESS immediately.</span>
<span id="L1868"><span class="lineNum">    1868</span>                 :             :  * @param[in] start_height Height of start_block</span>
<span id="L1869"><span class="lineNum">    1869</span>                 :             :  * @param[in] max_height  Optional max scanning height. If unset there is</span>
<span id="L1870"><span class="lineNum">    1870</span>                 :             :  *                        no maximum and scanning can continue to the tip</span>
<span id="L1871"><span class="lineNum">    1871</span>                 :             :  *</span>
<span id="L1872"><span class="lineNum">    1872</span>                 :             :  * @return ScanResult returning scan information and indicating success or</span>
<span id="L1873"><span class="lineNum">    1873</span>                 :             :  *         failure. Return status will be set to SUCCESS if scan was</span>
<span id="L1874"><span class="lineNum">    1874</span>                 :             :  *         successful. FAILURE if a complete rescan was not possible (due to</span>
<span id="L1875"><span class="lineNum">    1875</span>                 :             :  *         pruning or corruption). USER_ABORT if the rescan was aborted before</span>
<span id="L1876"><span class="lineNum">    1876</span>                 :             :  *         it could complete.</span>
<span id="L1877"><span class="lineNum">    1877</span>                 :             :  *</span>
<span id="L1878"><span class="lineNum">    1878</span>                 :             :  * @pre Caller needs to make sure start_block (and the optional stop_block) are on</span>
<span id="L1879"><span class="lineNum">    1879</span>                 :             :  * the main chain after to the addition of any new keys you want to detect</span>
<span id="L1880"><span class="lineNum">    1880</span>                 :             :  * transactions for.</span>
<span id="L1881"><span class="lineNum">    1881</span>                 :             :  */</span>
<span id="L1882"><span class="lineNum">    1882</span>                 :<span class="tlaUNC">           0 : CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256&amp; start_block, int start_height, std::optional&lt;int&gt; max_height, const WalletRescanReserver&amp; reserver, bool fUpdate, const bool save_progress)</span></span>
<span id="L1883"><span class="lineNum">    1883</span>                 :             : {</span>
<span id="L1884"><span class="lineNum">    1884</span>                 :<span class="tlaUNC">           0 :     constexpr auto INTERVAL_TIME{60s};</span></span>
<span id="L1885"><span class="lineNum">    1885</span>                 :<span class="tlaUNC">           0 :     auto current_time{reserver.now()};</span></span>
<span id="L1886"><span class="lineNum">    1886</span>                 :<span class="tlaUNC">           0 :     auto start_time{reserver.now()};</span></span>
<span id="L1887"><span class="lineNum">    1887</span>                 :             : </span>
<span id="L1888"><span class="lineNum">    1888</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     assert(reserver.isReserved());</span></span>
<span id="L1889"><span class="lineNum">    1889</span>                 :             : </span>
<span id="L1890"><span class="lineNum">    1890</span>                 :<span class="tlaUNC">           0 :     uint256 block_hash = start_block;</span></span>
<span id="L1891"><span class="lineNum">    1891</span>                 :<span class="tlaUNC">           0 :     ScanResult result;</span></span>
<span id="L1892"><span class="lineNum">    1892</span>                 :             : </span>
<span id="L1893"><span class="lineNum">    1893</span>                 :<span class="tlaUNC">           0 :     std::unique_ptr&lt;FastWalletRescanFilter&gt; fast_rescan_filter;</span></span>
<span id="L1894"><span class="lineNum">    1894</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     if (!IsLegacy() &amp;&amp; chain().hasBlockFilterIndex(BlockFilterType::BASIC)) fast_rescan_filter = std::make_unique&lt;FastWalletRescanFilter&gt;(*this);</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not executed"> # </span>]
<span id="L1895"><span class="lineNum">    1895</span>                 :             : </span>
<span id="L1896"><span class="lineNum">    1896</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     WalletLogPrintf(&quot;Rescan started from block %s... (%s)\n&quot;, start_block.ToString(),</span></span>
<span id="L1897"><span class="lineNum">    1897</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     fast_rescan_filter ? &quot;fast variant using block filters&quot; : &quot;slow variant inspecting all blocks&quot;);</span></span>
<span id="L1898"><span class="lineNum">    1898</span>                 :             : </span>
<span id="L1899"><span class="lineNum">    1899</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     fAbortRescan = false;</span></span>
<span id="L1900"><span class="lineNum">    1900</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     ShowProgress(strprintf(&quot;%s %s&quot;, GetDisplayName(), _(&quot;Rescanning&quot;).translated), 0); // show rescan progress in GUI as dialog or on splashscreen, if rescan required on startup (e.g. due to corruption)</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L1901"><span class="lineNum">    1901</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     uint256 tip_hash = WITH_LOCK(cs_wallet, return GetLastBlockHash());</span></span>
<span id="L1902"><span class="lineNum">    1902</span>                 :<span class="tlaUNC">           0 :     uint256 end_hash = tip_hash;</span></span>
<span id="L1903"><span class="lineNum">    1903</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (max_height) chain().findAncestorByHeight(tip_hash, *max_height, FoundBlock().hash(end_hash));</span></span>
<span id="L1904"><span class="lineNum">    1904</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     double progress_begin = chain().guessVerificationProgress(block_hash);</span></span>
<span id="L1905"><span class="lineNum">    1905</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     double progress_end = chain().guessVerificationProgress(end_hash);</span></span>
<span id="L1906"><span class="lineNum">    1906</span>                 :<span class="tlaUNC">           0 :     double progress_current = progress_begin;</span></span>
<span id="L1907"><span class="lineNum">    1907</span>                 :<span class="tlaUNC">           0 :     int block_height = start_height;</span></span>
<span id="L1908"><span class="lineNum">    1908</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     while (!fAbortRescan &amp;&amp; !chain().shutdownRequested()) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L1909"><span class="lineNum">    1909</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (progress_end - progress_begin &gt; 0.0) {</span></span>
<span id="L1910"><span class="lineNum">    1910</span>                 :<span class="tlaUNC">           0 :             m_scanning_progress = (progress_current - progress_begin) / (progress_end - progress_begin);</span></span>
<span id="L1911"><span class="lineNum">    1911</span>                 :             :         } else { // avoid divide-by-zero for single block scan range (i.e. start and stop hashes are equal)</span>
<span id="L1912"><span class="lineNum">    1912</span>                 :<span class="tlaUNC">           0 :             m_scanning_progress = 0;</span></span>
<span id="L1913"><span class="lineNum">    1913</span>                 :             :         }</span>
<span id="L1914"><span class="lineNum">    1914</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (block_height % 100 == 0 &amp;&amp; progress_end - progress_begin &gt; 0.0) {</span></span>
<span id="L1915"><span class="lineNum">    1915</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             ShowProgress(strprintf(&quot;%s %s&quot;, GetDisplayName(), _(&quot;Rescanning&quot;).translated), std::max(1, std::min(99, (int)(m_scanning_progress * 100))));</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span>       <span class="tlaUNC" title="Branch 9 was not executed"> # </span><span class="tlaUNC" title="Branch 10 was not executed"> # </span><span class="tlaUNC" title="Branch 11 was not executed"> # </span>]
<span id="L1916"><span class="lineNum">    1916</span>                 :             :         }</span>
<span id="L1917"><span class="lineNum">    1917</span>                 :             : </span>
<span id="L1918"><span class="lineNum">    1918</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         bool next_interval = reserver.now() &gt;= current_time + INTERVAL_TIME;</span></span>
<span id="L1919"><span class="lineNum">    1919</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (next_interval) {</span></span>
<span id="L1920"><span class="lineNum">    1920</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             current_time = reserver.now();</span></span>
<span id="L1921"><span class="lineNum">    1921</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             WalletLogPrintf(&quot;Still rescanning. At block %d. Progress=%f\n&quot;, block_height, progress_current);</span></span>
<span id="L1922"><span class="lineNum">    1922</span>                 :             :         }</span>
<span id="L1923"><span class="lineNum">    1923</span>                 :             : </span>
<span id="L1924"><span class="lineNum">    1924</span>                 :<span class="tlaUNC">           0 :         bool fetch_block{true};</span></span>
<span id="L1925"><span class="lineNum">    1925</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (fast_rescan_filter) {</span></span>
<span id="L1926"><span class="lineNum">    1926</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             fast_rescan_filter-&gt;UpdateIfNeeded();</span></span>
<span id="L1927"><span class="lineNum">    1927</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             auto matches_block{fast_rescan_filter-&gt;MatchesBlock(block_hash)};</span></span>
<span id="L1928"><span class="lineNum">    1928</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (matches_block.has_value()) {</span></span>
<span id="L1929"><span class="lineNum">    1929</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 if (*matches_block) {</span></span>
<span id="L1930"><span class="lineNum">    1930</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                     LogDebug(BCLog::SCAN, &quot;Fast rescan: inspect block %d [%s] (filter matched)\n&quot;, block_height, block_hash.ToString());</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L1931"><span class="lineNum">    1931</span>                 :             :                 } else {</span>
<span id="L1932"><span class="lineNum">    1932</span>                 :<span class="tlaUNC">           0 :                     result.last_scanned_block = block_hash;</span></span>
<span id="L1933"><span class="lineNum">    1933</span>                 :<span class="tlaUNC">           0 :                     result.last_scanned_height = block_height;</span></span>
<span id="L1934"><span class="lineNum">    1934</span>                 :<span class="tlaUNC">           0 :                     fetch_block = false;</span></span>
<span id="L1935"><span class="lineNum">    1935</span>                 :             :                 }</span>
<span id="L1936"><span class="lineNum">    1936</span>                 :             :             } else {</span>
<span id="L1937"><span class="lineNum">    1937</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                 LogDebug(BCLog::SCAN, &quot;Fast rescan: inspect block %d [%s] (WARNING: block filter not found!)\n&quot;, block_height, block_hash.ToString());</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L1938"><span class="lineNum">    1938</span>                 :             :             }</span>
<span id="L1939"><span class="lineNum">    1939</span>                 :             :         }</span>
<span id="L1940"><span class="lineNum">    1940</span>                 :             : </span>
<span id="L1941"><span class="lineNum">    1941</span>                 :             :         // Find next block separately from reading data above, because reading</span>
<span id="L1942"><span class="lineNum">    1942</span>                 :             :         // is slow and there might be a reorg while it is read.</span>
<span id="L1943"><span class="lineNum">    1943</span>                 :<span class="tlaUNC">           0 :         bool block_still_active = false;</span></span>
<span id="L1944"><span class="lineNum">    1944</span>                 :<span class="tlaUNC">           0 :         bool next_block = false;</span></span>
<span id="L1945"><span class="lineNum">    1945</span>                 :<span class="tlaUNC">           0 :         uint256 next_block_hash;</span></span>
<span id="L1946"><span class="lineNum">    1946</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         chain().findBlock(block_hash, FoundBlock().inActiveChain(block_still_active).nextBlock(FoundBlock().inActiveChain(next_block).hash(next_block_hash)));</span></span>
<span id="L1947"><span class="lineNum">    1947</span>                 :             : </span>
<span id="L1948"><span class="lineNum">    1948</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (fetch_block) {</span></span>
<span id="L1949"><span class="lineNum">    1949</span>                 :             :             // Read block data</span>
<span id="L1950"><span class="lineNum">    1950</span>                 :<span class="tlaUNC">           0 :             CBlock block;</span></span>
<span id="L1951"><span class="lineNum">    1951</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             chain().findBlock(block_hash, FoundBlock().data(block));</span></span>
<span id="L1952"><span class="lineNum">    1952</span>                 :             : </span>
<span id="L1953"><span class="lineNum">    1953</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (!block.IsNull()) {</span></span>
<span id="L1954"><span class="lineNum">    1954</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 LOCK(cs_wallet);</span></span>
<span id="L1955"><span class="lineNum">    1955</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 if (!block_still_active) {</span></span>
<span id="L1956"><span class="lineNum">    1956</span>                 :             :                     // Abort scan if current block is no longer active, to prevent</span>
<span id="L1957"><span class="lineNum">    1957</span>                 :             :                     // marking transactions as coming from the wrong block.</span>
<span id="L1958"><span class="lineNum">    1958</span>                 :<span class="tlaUNC">           0 :                     result.last_failed_block = block_hash;</span></span>
<span id="L1959"><span class="lineNum">    1959</span>                 :<span class="tlaUNC">           0 :                     result.status = ScanResult::FAILURE;</span></span>
<span id="L1960"><span class="lineNum">    1960</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     break;</span></span>
<span id="L1961"><span class="lineNum">    1961</span>                 :             :                 }</span>
<span id="L1962"><span class="lineNum">    1962</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 for (size_t posInBlock = 0; posInBlock &lt; block.vtx.size(); ++posInBlock) {</span></span>
<span id="L1963"><span class="lineNum">    1963</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     SyncTransaction(block.vtx[posInBlock], TxStateConfirmed{block_hash, block_height, static_cast&lt;int&gt;(posInBlock)}, fUpdate, /*rescanning_old_block=*/true);</span></span>
<span id="L1964"><span class="lineNum">    1964</span>                 :             :                 }</span>
<span id="L1965"><span class="lineNum">    1965</span>                 :             :                 // scan succeeded, record block as most recent successfully scanned</span>
<span id="L1966"><span class="lineNum">    1966</span>                 :<span class="tlaUNC">           0 :                 result.last_scanned_block = block_hash;</span></span>
<span id="L1967"><span class="lineNum">    1967</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 result.last_scanned_height = block_height;</span></span>
<span id="L1968"><span class="lineNum">    1968</span>                 :             : </span>
<span id="L1969"><span class="lineNum">    1969</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 if (save_progress &amp;&amp; next_interval) {</span></span>
<span id="L1970"><span class="lineNum">    1970</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     CBlockLocator loc = m_chain-&gt;getActiveChainLocator(block_hash);</span></span>
<span id="L1971"><span class="lineNum">    1971</span>                 :             : </span>
<span id="L1972"><span class="lineNum">    1972</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     if (!loc.IsNull()) {</span></span>
<span id="L1973"><span class="lineNum">    1973</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                         WalletLogPrintf(&quot;Saving scan progress %d.\n&quot;, block_height);</span></span>
<span id="L1974"><span class="lineNum">    1974</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                         WalletBatch batch(GetDatabase());</span></span>
<span id="L1975"><span class="lineNum">    1975</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                         batch.WriteBestBlock(loc);</span></span>
<span id="L1976"><span class="lineNum">    1976</span>                 :<span class="tlaUNC">           0 :                     }</span></span>
<span id="L1977"><span class="lineNum">    1977</span>                 :<span class="tlaUNC">           0 :                 }</span></span>
<span id="L1978"><span class="lineNum">    1978</span>                 :<span class="tlaUNC">           0 :             } else {</span></span>
<span id="L1979"><span class="lineNum">    1979</span>                 :             :                 // could not scan block, keep scanning but record this block as the most recent failure</span>
<span id="L1980"><span class="lineNum">    1980</span>                 :<span class="tlaUNC">           0 :                 result.last_failed_block = block_hash;</span></span>
<span id="L1981"><span class="lineNum">    1981</span>                 :<span class="tlaUNC">           0 :                 result.status = ScanResult::FAILURE;</span></span>
<span id="L1982"><span class="lineNum">    1982</span>                 :             :             }</span>
<span id="L1983"><span class="lineNum">    1983</span>                 :<span class="tlaUNC">           0 :         }</span></span>
<span id="L1984"><span class="lineNum">    1984</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (max_height &amp;&amp; block_height &gt;= *max_height) {</span></span>
<span id="L1985"><span class="lineNum">    1985</span>                 :             :             break;</span>
<span id="L1986"><span class="lineNum">    1986</span>                 :             :         }</span>
<span id="L1987"><span class="lineNum">    1987</span>                 :<span class="tlaUNC">           0 :         {</span></span>
<span id="L1988"><span class="lineNum">    1988</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (!next_block) {</span></span>
<span id="L1989"><span class="lineNum">    1989</span>                 :             :                 // break successfully when rescan has reached the tip, or</span>
<span id="L1990"><span class="lineNum">    1990</span>                 :             :                 // previous block is no longer on the chain due to a reorg</span>
<span id="L1991"><span class="lineNum">    1991</span>                 :             :                 break;</span>
<span id="L1992"><span class="lineNum">    1992</span>                 :             :             }</span>
<span id="L1993"><span class="lineNum">    1993</span>                 :             : </span>
<span id="L1994"><span class="lineNum">    1994</span>                 :             :             // increment block and verification progress</span>
<span id="L1995"><span class="lineNum">    1995</span>                 :<span class="tlaUNC">           0 :             block_hash = next_block_hash;</span></span>
<span id="L1996"><span class="lineNum">    1996</span>                 :<span class="tlaUNC">           0 :             ++block_height;</span></span>
<span id="L1997"><span class="lineNum">    1997</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             progress_current = chain().guessVerificationProgress(block_hash);</span></span>
<span id="L1998"><span class="lineNum">    1998</span>                 :             : </span>
<span id="L1999"><span class="lineNum">    1999</span>                 :             :             // handle updated tip hash</span>
<span id="L2000"><span class="lineNum">    2000</span>                 :<span class="tlaUNC">           0 :             const uint256 prev_tip_hash = tip_hash;</span></span>
<span id="L2001"><span class="lineNum">    2001</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             tip_hash = WITH_LOCK(cs_wallet, return GetLastBlockHash());</span></span>
<span id="L2002"><span class="lineNum">    2002</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (!max_height &amp;&amp; prev_tip_hash != tip_hash) {</span></span>
<span id="L2003"><span class="lineNum">    2003</span>                 :             :                 // in case the tip has changed, update progress max</span>
<span id="L2004"><span class="lineNum">    2004</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 progress_end = chain().guessVerificationProgress(tip_hash);</span></span>
<span id="L2005"><span class="lineNum">    2005</span>                 :             :             }</span>
<span id="L2006"><span class="lineNum">    2006</span>                 :             :         }</span>
<span id="L2007"><span class="lineNum">    2007</span>                 :             :     }</span>
<span id="L2008"><span class="lineNum">    2008</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!max_height) {</span></span>
<span id="L2009"><span class="lineNum">    2009</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         WalletLogPrintf(&quot;Scanning current mempool transactions.\n&quot;);</span></span>
<span id="L2010"><span class="lineNum">    2010</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         WITH_LOCK(cs_wallet, chain().requestMempoolTransactions(*this));</span></span>
<span id="L2011"><span class="lineNum">    2011</span>                 :             :     }</span>
<span id="L2012"><span class="lineNum">    2012</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     ShowProgress(strprintf(&quot;%s %s&quot;, GetDisplayName(), _(&quot;Rescanning&quot;).translated), 100); // hide progress dialog in GUI</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L2013"><span class="lineNum">    2013</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (block_height &amp;&amp; fAbortRescan) {</span></span>
<span id="L2014"><span class="lineNum">    2014</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         WalletLogPrintf(&quot;Rescan aborted at block %d. Progress=%f\n&quot;, block_height, progress_current);</span></span>
<span id="L2015"><span class="lineNum">    2015</span>                 :<span class="tlaUNC">           0 :         result.status = ScanResult::USER_ABORT;</span></span>
<span id="L2016"><span class="lineNum">    2016</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     } else if (block_height &amp;&amp; chain().shutdownRequested()) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L2017"><span class="lineNum">    2017</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         WalletLogPrintf(&quot;Rescan interrupted by shutdown request at block %d. Progress=%f\n&quot;, block_height, progress_current);</span></span>
<span id="L2018"><span class="lineNum">    2018</span>                 :<span class="tlaUNC">           0 :         result.status = ScanResult::USER_ABORT;</span></span>
<span id="L2019"><span class="lineNum">    2019</span>                 :             :     } else {</span>
<span id="L2020"><span class="lineNum">    2020</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         WalletLogPrintf(&quot;Rescan completed in %15dms\n&quot;, Ticks&lt;std::chrono::milliseconds&gt;(reserver.now() - start_time));</span></span>
<span id="L2021"><span class="lineNum">    2021</span>                 :             :     }</span>
<span id="L2022"><span class="lineNum">    2022</span>                 :<span class="tlaUNC">           0 :     return result;</span></span>
<span id="L2023"><span class="lineNum">    2023</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L2024"><span class="lineNum">    2024</span>                 :             : </span>
<span id="L2025"><span class="lineNum">    2025</span>                 :<span class="tlaUNC">           0 : bool CWallet::SubmitTxMemoryPoolAndRelay(CWalletTx&amp; wtx, std::string&amp; err_string, bool relay) const</span></span>
<span id="L2026"><span class="lineNum">    2026</span>                 :             : {</span>
<span id="L2027"><span class="lineNum">    2027</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L2028"><span class="lineNum">    2028</span>                 :             : </span>
<span id="L2029"><span class="lineNum">    2029</span>                 :             :     // Can't relay if wallet is not broadcasting</span>
<span id="L2030"><span class="lineNum">    2030</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!GetBroadcastTransactions()) return false;</span></span>
<span id="L2031"><span class="lineNum">    2031</span>                 :             :     // Don't relay abandoned transactions</span>
<span id="L2032"><span class="lineNum">    2032</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (wtx.isAbandoned()) return false;</span></span>
<span id="L2033"><span class="lineNum">    2033</span>                 :             :     // Don't try to submit coinbase transactions. These would fail anyway but would</span>
<span id="L2034"><span class="lineNum">    2034</span>                 :             :     // cause log spam.</span>
<span id="L2035"><span class="lineNum">    2035</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (wtx.IsCoinBase()) return false;</span></span>
<span id="L2036"><span class="lineNum">    2036</span>                 :             :     // Don't try to submit conflicted or confirmed transactions.</span>
<span id="L2037"><span class="lineNum">    2037</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (GetTxDepthInMainChain(wtx) != 0) return false;</span></span>
<span id="L2038"><span class="lineNum">    2038</span>                 :             : </span>
<span id="L2039"><span class="lineNum">    2039</span>                 :             :     // Submit transaction to mempool for relay</span>
<span id="L2040"><span class="lineNum">    2040</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     WalletLogPrintf(&quot;Submitting wtx %s to mempool for relay\n&quot;, wtx.GetHash().ToString());</span></span>
<span id="L2041"><span class="lineNum">    2041</span>                 :             :     // We must set TxStateInMempool here. Even though it will also be set later by the</span>
<span id="L2042"><span class="lineNum">    2042</span>                 :             :     // entered-mempool callback, if we did not there would be a race where a</span>
<span id="L2043"><span class="lineNum">    2043</span>                 :             :     // user could call sendmoney in a loop and hit spurious out of funds errors</span>
<span id="L2044"><span class="lineNum">    2044</span>                 :             :     // because we think that this newly generated transaction's change is</span>
<span id="L2045"><span class="lineNum">    2045</span>                 :             :     // unavailable as we're not yet aware that it is in the mempool.</span>
<span id="L2046"><span class="lineNum">    2046</span>                 :             :     //</span>
<span id="L2047"><span class="lineNum">    2047</span>                 :             :     // If broadcast fails for any reason, trying to set wtx.m_state here would be incorrect.</span>
<span id="L2048"><span class="lineNum">    2048</span>                 :             :     // If transaction was previously in the mempool, it should be updated when</span>
<span id="L2049"><span class="lineNum">    2049</span>                 :             :     // TransactionRemovedFromMempool fires.</span>
<span id="L2050"><span class="lineNum">    2050</span>                 :<span class="tlaUNC">           0 :     bool ret = chain().broadcastTransaction(wtx.tx, m_default_max_tx_fee, relay, err_string);</span></span>
<span id="L2051"><span class="lineNum">    2051</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (ret) wtx.m_state = TxStateInMempool{};</span></span>
<span id="L2052"><span class="lineNum">    2052</span>                 :             :     return ret;</span>
<span id="L2053"><span class="lineNum">    2053</span>                 :             : }</span>
<span id="L2054"><span class="lineNum">    2054</span>                 :             : </span>
<span id="L2055"><span class="lineNum">    2055</span>                 :<span class="tlaUNC">           0 : std::set&lt;uint256&gt; CWallet::GetTxConflicts(const CWalletTx&amp; wtx) const</span></span>
<span id="L2056"><span class="lineNum">    2056</span>                 :             : {</span>
<span id="L2057"><span class="lineNum">    2057</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L2058"><span class="lineNum">    2058</span>                 :             : </span>
<span id="L2059"><span class="lineNum">    2059</span>                 :<span class="tlaUNC">           0 :     const uint256 myHash{wtx.GetHash()};</span></span>
<span id="L2060"><span class="lineNum">    2060</span>                 :<span class="tlaUNC">           0 :     std::set&lt;uint256&gt; result{GetConflicts(myHash)};</span></span>
<span id="L2061"><span class="lineNum">    2061</span>                 :<span class="tlaUNC">           0 :     result.erase(myHash);</span></span>
<span id="L2062"><span class="lineNum">    2062</span>                 :<span class="tlaUNC">           0 :     return result;</span></span>
<span id="L2063"><span class="lineNum">    2063</span>                 :             : }</span>
<span id="L2064"><span class="lineNum">    2064</span>                 :             : </span>
<span id="L2065"><span class="lineNum">    2065</span>                 :<span class="tlaUNC">           0 : bool CWallet::ShouldResend() const</span></span>
<span id="L2066"><span class="lineNum">    2066</span>                 :             : {</span>
<span id="L2067"><span class="lineNum">    2067</span>                 :             :     // Don't attempt to resubmit if the wallet is configured to not broadcast</span>
<span id="L2068"><span class="lineNum">    2068</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!fBroadcastTransactions) return false;</span></span>
<span id="L2069"><span class="lineNum">    2069</span>                 :             : </span>
<span id="L2070"><span class="lineNum">    2070</span>                 :             :     // During reindex, importing and IBD, old wallet transactions become</span>
<span id="L2071"><span class="lineNum">    2071</span>                 :             :     // unconfirmed. Don't resend them as that would spam other nodes.</span>
<span id="L2072"><span class="lineNum">    2072</span>                 :             :     // We only allow forcing mempool submission when not relaying to avoid this spam.</span>
<span id="L2073"><span class="lineNum">    2073</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!chain().isReadyToBroadcast()) return false;</span></span>
<span id="L2074"><span class="lineNum">    2074</span>                 :             : </span>
<span id="L2075"><span class="lineNum">    2075</span>                 :             :     // Do this infrequently and randomly to avoid giving away</span>
<span id="L2076"><span class="lineNum">    2076</span>                 :             :     // that these are our transactions.</span>
<span id="L2077"><span class="lineNum">    2077</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (NodeClock::now() &lt; m_next_resend) return false;</span></span>
<span id="L2078"><span class="lineNum">    2078</span>                 :             : </span>
<span id="L2079"><span class="lineNum">    2079</span>                 :             :     return true;</span>
<span id="L2080"><span class="lineNum">    2080</span>                 :             : }</span>
<span id="L2081"><span class="lineNum">    2081</span>                 :             : </span>
<span id="L2082"><span class="lineNum">    2082</span>                 :<span class="tlaUNC">           0 : NodeClock::time_point CWallet::GetDefaultNextResend() { return FastRandomContext{}.rand_uniform_delay(NodeClock::now() + 12h, 24h); }</span></span>
<span id="L2083"><span class="lineNum">    2083</span>                 :             : </span>
<span id="L2084"><span class="lineNum">    2084</span>                 :             : // Resubmit transactions from the wallet to the mempool, optionally asking the</span>
<span id="L2085"><span class="lineNum">    2085</span>                 :             : // mempool to relay them. On startup, we will do this for all unconfirmed</span>
<span id="L2086"><span class="lineNum">    2086</span>                 :             : // transactions but will not ask the mempool to relay them. We do this on startup</span>
<span id="L2087"><span class="lineNum">    2087</span>                 :             : // to ensure that our own mempool is aware of our transactions. There</span>
<span id="L2088"><span class="lineNum">    2088</span>                 :             : // is a privacy side effect here as not broadcasting on startup also means that we won't</span>
<span id="L2089"><span class="lineNum">    2089</span>                 :             : // inform the world of our wallet's state, particularly if the wallet (or node) is not</span>
<span id="L2090"><span class="lineNum">    2090</span>                 :             : // yet synced.</span>
<span id="L2091"><span class="lineNum">    2091</span>                 :             : //</span>
<span id="L2092"><span class="lineNum">    2092</span>                 :             : // Otherwise this function is called periodically in order to relay our unconfirmed txs.</span>
<span id="L2093"><span class="lineNum">    2093</span>                 :             : // We do this on a random timer to slightly obfuscate which transactions</span>
<span id="L2094"><span class="lineNum">    2094</span>                 :             : // come from our wallet.</span>
<span id="L2095"><span class="lineNum">    2095</span>                 :             : //</span>
<span id="L2096"><span class="lineNum">    2096</span>                 :             : // TODO: Ideally, we'd only resend transactions that we think should have been</span>
<span id="L2097"><span class="lineNum">    2097</span>                 :             : // mined in the most recent block. Any transaction that wasn't in the top</span>
<span id="L2098"><span class="lineNum">    2098</span>                 :             : // blockweight of transactions in the mempool shouldn't have been mined,</span>
<span id="L2099"><span class="lineNum">    2099</span>                 :             : // and so is probably just sitting in the mempool waiting to be confirmed.</span>
<span id="L2100"><span class="lineNum">    2100</span>                 :             : // Rebroadcasting does nothing to speed up confirmation and only damages</span>
<span id="L2101"><span class="lineNum">    2101</span>                 :             : // privacy.</span>
<span id="L2102"><span class="lineNum">    2102</span>                 :             : //</span>
<span id="L2103"><span class="lineNum">    2103</span>                 :             : // The `force` option results in all unconfirmed transactions being submitted to</span>
<span id="L2104"><span class="lineNum">    2104</span>                 :             : // the mempool. This does not necessarily result in those transactions being relayed,</span>
<span id="L2105"><span class="lineNum">    2105</span>                 :             : // that depends on the `relay` option. Periodic rebroadcast uses the pattern</span>
<span id="L2106"><span class="lineNum">    2106</span>                 :             : // relay=true force=false, while loading into the mempool</span>
<span id="L2107"><span class="lineNum">    2107</span>                 :             : // (on start, or after import) uses relay=false force=true.</span>
<span id="L2108"><span class="lineNum">    2108</span>                 :<span class="tlaUNC">           0 : void CWallet::ResubmitWalletTransactions(bool relay, bool force)</span></span>
<span id="L2109"><span class="lineNum">    2109</span>                 :             : {</span>
<span id="L2110"><span class="lineNum">    2110</span>                 :             :     // Don't attempt to resubmit if the wallet is configured to not broadcast,</span>
<span id="L2111"><span class="lineNum">    2111</span>                 :             :     // even if forcing.</span>
<span id="L2112"><span class="lineNum">    2112</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!fBroadcastTransactions) return;</span></span>
<span id="L2113"><span class="lineNum">    2113</span>                 :             : </span>
<span id="L2114"><span class="lineNum">    2114</span>                 :<span class="tlaUNC">           0 :     int submitted_tx_count = 0;</span></span>
<span id="L2115"><span class="lineNum">    2115</span>                 :             : </span>
<span id="L2116"><span class="lineNum">    2116</span>                 :<span class="tlaUNC">           0 :     { // cs_wallet scope</span></span>
<span id="L2117"><span class="lineNum">    2117</span>                 :<span class="tlaUNC">           0 :         LOCK(cs_wallet);</span></span>
<span id="L2118"><span class="lineNum">    2118</span>                 :             : </span>
<span id="L2119"><span class="lineNum">    2119</span>                 :             :         // First filter for the transactions we want to rebroadcast.</span>
<span id="L2120"><span class="lineNum">    2120</span>                 :             :         // We use a set with WalletTxOrderComparator so that rebroadcasting occurs in insertion order</span>
<span id="L2121"><span class="lineNum">    2121</span>                 :<span class="tlaUNC">           0 :         std::set&lt;CWalletTx*, WalletTxOrderComparator&gt; to_submit;</span></span>
<span id="L2122"><span class="lineNum">    2122</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (auto&amp; [txid, wtx] : mapWallet) {</span></span>
<span id="L2123"><span class="lineNum">    2123</span>                 :             :             // Only rebroadcast unconfirmed txs</span>
<span id="L2124"><span class="lineNum">    2124</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (!wtx.isUnconfirmed()) continue;</span></span>
<span id="L2125"><span class="lineNum">    2125</span>                 :             : </span>
<span id="L2126"><span class="lineNum">    2126</span>                 :             :             // Attempt to rebroadcast all txes more than 5 minutes older than</span>
<span id="L2127"><span class="lineNum">    2127</span>                 :             :             // the last block, or all txs if forcing.</span>
<span id="L2128"><span class="lineNum">    2128</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (!force &amp;&amp; wtx.nTimeReceived &gt; m_best_block_time - 5 * 60) continue;</span></span>
<span id="L2129"><span class="lineNum">    2129</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             to_submit.insert(&amp;wtx);</span></span>
<span id="L2130"><span class="lineNum">    2130</span>                 :             :         }</span>
<span id="L2131"><span class="lineNum">    2131</span>                 :             :         // Now try submitting the transactions to the memory pool and (optionally) relay them.</span>
<span id="L2132"><span class="lineNum">    2132</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (auto wtx : to_submit) {</span></span>
<span id="L2133"><span class="lineNum">    2133</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             std::string unused_err_string;</span></span>
<span id="L2134"><span class="lineNum">    2134</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (SubmitTxMemoryPoolAndRelay(*wtx, unused_err_string, relay)) ++submitted_tx_count;</span></span>
<span id="L2135"><span class="lineNum">    2135</span>                 :<span class="tlaUNC">           0 :         }</span></span>
<span id="L2136"><span class="lineNum">    2136</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     } // cs_wallet</span></span>
<span id="L2137"><span class="lineNum">    2137</span>                 :             : </span>
<span id="L2138"><span class="lineNum">    2138</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (submitted_tx_count &gt; 0) {</span></span>
<span id="L2139"><span class="lineNum">    2139</span>                 :<span class="tlaUNC">           0 :         WalletLogPrintf(&quot;%s: resubmit %u unconfirmed transactions\n&quot;, __func__, submitted_tx_count);</span></span>
<span id="L2140"><span class="lineNum">    2140</span>                 :             :     }</span>
<span id="L2141"><span class="lineNum">    2141</span>                 :             : }</span>
<span id="L2142"><span class="lineNum">    2142</span>                 :             : </span>
<span id="L2143"><span class="lineNum">    2143</span>                 :             : /** @} */ // end of mapWallet</span>
<span id="L2144"><span class="lineNum">    2144</span>                 :             : </span>
<span id="L2145"><span class="lineNum">    2145</span>                 :<span class="tlaUNC">           0 : void MaybeResendWalletTxs(WalletContext&amp; context)</span></span>
<span id="L2146"><span class="lineNum">    2146</span>                 :             : {</span>
<span id="L2147"><span class="lineNum">    2147</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (const std::shared_ptr&lt;CWallet&gt;&amp; pwallet : GetWallets(context)) {</span></span>
<span id="L2148"><span class="lineNum">    2148</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!pwallet-&gt;ShouldResend()) continue;</span></span>
<span id="L2149"><span class="lineNum">    2149</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         pwallet-&gt;ResubmitWalletTransactions(/*relay=*/true, /*force=*/false);</span></span>
<span id="L2150"><span class="lineNum">    2150</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         pwallet-&gt;SetNextResend();</span></span>
<span id="L2151"><span class="lineNum">    2151</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L2152"><span class="lineNum">    2152</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L2153"><span class="lineNum">    2153</span>                 :             : </span>
<span id="L2154"><span class="lineNum">    2154</span>                 :             : </span>
<span id="L2155"><span class="lineNum">    2155</span>                 :             : /** @defgroup Actions</span>
<span id="L2156"><span class="lineNum">    2156</span>                 :             :  *</span>
<span id="L2157"><span class="lineNum">    2157</span>                 :             :  * @{</span>
<span id="L2158"><span class="lineNum">    2158</span>                 :             :  */</span>
<span id="L2159"><span class="lineNum">    2159</span>                 :             : </span>
<span id="L2160"><span class="lineNum">    2160</span>                 :<span class="tlaUNC">           0 : bool CWallet::SignTransaction(CMutableTransaction&amp; tx) const</span></span>
<span id="L2161"><span class="lineNum">    2161</span>                 :             : {</span>
<span id="L2162"><span class="lineNum">    2162</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L2163"><span class="lineNum">    2163</span>                 :             : </span>
<span id="L2164"><span class="lineNum">    2164</span>                 :             :     // Build coins map</span>
<span id="L2165"><span class="lineNum">    2165</span>                 :<span class="tlaUNC">           0 :     std::map&lt;COutPoint, Coin&gt; coins;</span></span>
<span id="L2166"><span class="lineNum">    2166</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (auto&amp; input : tx.vin) {</span></span>
<span id="L2167"><span class="lineNum">    2167</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         const auto mi = mapWallet.find(input.prevout.hash);</span></span>
<span id="L2168"><span class="lineNum">    2168</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if(mi == mapWallet.end() || input.prevout.n &gt;= mi-&gt;second.tx-&gt;vout.size()) {</span></span>
<span id="L2169"><span class="lineNum">    2169</span>                 :             :             return false;</span>
<span id="L2170"><span class="lineNum">    2170</span>                 :             :         }</span>
<span id="L2171"><span class="lineNum">    2171</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         const CWalletTx&amp; wtx = mi-&gt;second;</span></span>
<span id="L2172"><span class="lineNum">    2172</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         int prev_height = wtx.state&lt;TxStateConfirmed&gt;() ? wtx.state&lt;TxStateConfirmed&gt;()-&gt;confirmed_block_height : 0;</span></span>
<span id="L2173"><span class="lineNum">    2173</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         coins[input.prevout] = Coin(wtx.tx-&gt;vout[input.prevout.n], prev_height, wtx.IsCoinBase());</span></span>
<span id="L2174"><span class="lineNum">    2174</span>                 :             :     }</span>
<span id="L2175"><span class="lineNum">    2175</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     std::map&lt;int, bilingual_str&gt; input_errors;</span></span>
<span id="L2176"><span class="lineNum">    2176</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     return SignTransaction(tx, coins, SIGHASH_DEFAULT, input_errors);</span></span>
<span id="L2177"><span class="lineNum">    2177</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L2178"><span class="lineNum">    2178</span>                 :             : </span>
<span id="L2179"><span class="lineNum">    2179</span>                 :<span class="tlaUNC">           0 : bool CWallet::SignTransaction(CMutableTransaction&amp; tx, const std::map&lt;COutPoint, Coin&gt;&amp; coins, int sighash, std::map&lt;int, bilingual_str&gt;&amp; input_errors) const</span></span>
<span id="L2180"><span class="lineNum">    2180</span>                 :             : {</span>
<span id="L2181"><span class="lineNum">    2181</span>                 :             :     // Try to sign with all ScriptPubKeyMans</span>
<span id="L2182"><span class="lineNum">    2182</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (ScriptPubKeyMan* spk_man : GetAllScriptPubKeyMans()) {</span></span>
<span id="L2183"><span class="lineNum">    2183</span>                 :             :         // spk_man-&gt;SignTransaction will return true if the transaction is complete,</span>
<span id="L2184"><span class="lineNum">    2184</span>                 :             :         // so we can exit early and return true if that happens</span>
<span id="L2185"><span class="lineNum">    2185</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (spk_man-&gt;SignTransaction(tx, coins, sighash, input_errors)) {</span></span>
<span id="L2186"><span class="lineNum">    2186</span>                 :<span class="tlaUNC">           0 :             return true;</span></span>
<span id="L2187"><span class="lineNum">    2187</span>                 :             :         }</span>
<span id="L2188"><span class="lineNum">    2188</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L2189"><span class="lineNum">    2189</span>                 :             : </span>
<span id="L2190"><span class="lineNum">    2190</span>                 :             :     // At this point, one input was not fully signed otherwise we would have exited already</span>
<span id="L2191"><span class="lineNum">    2191</span>                 :<span class="tlaUNC">           0 :     return false;</span></span>
<span id="L2192"><span class="lineNum">    2192</span>                 :             : }</span>
<span id="L2193"><span class="lineNum">    2193</span>                 :             : </span>
<span id="L2194"><span class="lineNum">    2194</span>                 :<span class="tlaUNC">           0 : std::optional&lt;PSBTError&gt; CWallet::FillPSBT(PartiallySignedTransaction&amp; psbtx, bool&amp; complete, int sighash_type, bool sign, bool bip32derivs, size_t * n_signed, bool finalize) const</span></span>
<span id="L2195"><span class="lineNum">    2195</span>                 :             : {</span>
<span id="L2196"><span class="lineNum">    2196</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (n_signed) {</span></span>
<span id="L2197"><span class="lineNum">    2197</span>                 :<span class="tlaUNC">           0 :         *n_signed = 0;</span></span>
<span id="L2198"><span class="lineNum">    2198</span>                 :             :     }</span>
<span id="L2199"><span class="lineNum">    2199</span>                 :<span class="tlaUNC">           0 :     LOCK(cs_wallet);</span></span>
<span id="L2200"><span class="lineNum">    2200</span>                 :             :     // Get all of the previous transactions</span>
<span id="L2201"><span class="lineNum">    2201</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (unsigned int i = 0; i &lt; psbtx.tx-&gt;vin.size(); ++i) {</span></span>
<span id="L2202"><span class="lineNum">    2202</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         const CTxIn&amp; txin = psbtx.tx-&gt;vin[i];</span></span>
<span id="L2203"><span class="lineNum">    2203</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         PSBTInput&amp; input = psbtx.inputs.at(i);</span></span>
<span id="L2204"><span class="lineNum">    2204</span>                 :             : </span>
<span id="L2205"><span class="lineNum">    2205</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (PSBTInputSigned(input)) {</span></span>
<span id="L2206"><span class="lineNum">    2206</span>                 :<span class="tlaUNC">           0 :             continue;</span></span>
<span id="L2207"><span class="lineNum">    2207</span>                 :             :         }</span>
<span id="L2208"><span class="lineNum">    2208</span>                 :             : </span>
<span id="L2209"><span class="lineNum">    2209</span>                 :             :         // If we have no utxo, grab it from the wallet.</span>
<span id="L2210"><span class="lineNum">    2210</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!input.non_witness_utxo) {</span></span>
<span id="L2211"><span class="lineNum">    2211</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             const uint256&amp; txhash = txin.prevout.hash;</span></span>
<span id="L2212"><span class="lineNum">    2212</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             const auto it = mapWallet.find(txhash);</span></span>
<span id="L2213"><span class="lineNum">    2213</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (it != mapWallet.end()) {</span></span>
<span id="L2214"><span class="lineNum">    2214</span>                 :<span class="tlaUNC">           0 :                 const CWalletTx&amp; wtx = it-&gt;second;</span></span>
<span id="L2215"><span class="lineNum">    2215</span>                 :             :                 // We only need the non_witness_utxo, which is a superset of the witness_utxo.</span>
<span id="L2216"><span class="lineNum">    2216</span>                 :             :                 //   The signing code will switch to the smaller witness_utxo if this is ok.</span>
<span id="L2217"><span class="lineNum">    2217</span>                 :<span class="tlaUNC">           0 :                 input.non_witness_utxo = wtx.tx;</span></span>
<span id="L2218"><span class="lineNum">    2218</span>                 :             :             }</span>
<span id="L2219"><span class="lineNum">    2219</span>                 :             :         }</span>
<span id="L2220"><span class="lineNum">    2220</span>                 :             :     }</span>
<span id="L2221"><span class="lineNum">    2221</span>                 :             : </span>
<span id="L2222"><span class="lineNum">    2222</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     const PrecomputedTransactionData txdata = PrecomputePSBTData(psbtx);</span></span>
<span id="L2223"><span class="lineNum">    2223</span>                 :             : </span>
<span id="L2224"><span class="lineNum">    2224</span>                 :             :     // Fill in information from ScriptPubKeyMans</span>
<span id="L2225"><span class="lineNum">    2225</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (ScriptPubKeyMan* spk_man : GetAllScriptPubKeyMans()) {</span></span>
<span id="L2226"><span class="lineNum">    2226</span>                 :<span class="tlaUNC">           0 :         int n_signed_this_spkm = 0;</span></span>
<span id="L2227"><span class="lineNum">    2227</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         const auto error{spk_man-&gt;FillPSBT(psbtx, txdata, sighash_type, sign, bip32derivs, &amp;n_signed_this_spkm, finalize)};</span></span>
<span id="L2228"><span class="lineNum">    2228</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (error) {</span></span>
<span id="L2229"><span class="lineNum">    2229</span>                 :<span class="tlaUNC">           0 :             return error;</span></span>
<span id="L2230"><span class="lineNum">    2230</span>                 :             :         }</span>
<span id="L2231"><span class="lineNum">    2231</span>                 :             : </span>
<span id="L2232"><span class="lineNum">    2232</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (n_signed) {</span></span>
<span id="L2233"><span class="lineNum">    2233</span>                 :<span class="tlaUNC">           0 :             (*n_signed) += n_signed_this_spkm;</span></span>
<span id="L2234"><span class="lineNum">    2234</span>                 :             :         }</span>
<span id="L2235"><span class="lineNum">    2235</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L2236"><span class="lineNum">    2236</span>                 :             : </span>
<span id="L2237"><span class="lineNum">    2237</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     RemoveUnnecessaryTransactions(psbtx, sighash_type);</span></span>
<span id="L2238"><span class="lineNum">    2238</span>                 :             : </span>
<span id="L2239"><span class="lineNum">    2239</span>                 :             :     // Complete if every input is now signed</span>
<span id="L2240"><span class="lineNum">    2240</span>                 :<span class="tlaUNC">           0 :     complete = true;</span></span>
<span id="L2241"><span class="lineNum">    2241</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (size_t i = 0; i &lt; psbtx.inputs.size(); ++i) {</span></span>
<span id="L2242"><span class="lineNum">    2242</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         complete &amp;= PSBTInputSignedAndVerified(psbtx, i, &amp;txdata);</span></span>
<span id="L2243"><span class="lineNum">    2243</span>                 :             :     }</span>
<span id="L2244"><span class="lineNum">    2244</span>                 :             : </span>
<span id="L2245"><span class="lineNum">    2245</span>                 :<span class="tlaUNC">           0 :     return {};</span></span>
<span id="L2246"><span class="lineNum">    2246</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 : }</span></span>
<span id="L2247"><span class="lineNum">    2247</span>                 :             : </span>
<span id="L2248"><span class="lineNum">    2248</span>                 :<span class="tlaUNC">           0 : SigningResult CWallet::SignMessage(const std::string&amp; message, const PKHash&amp; pkhash, std::string&amp; str_sig) const</span></span>
<span id="L2249"><span class="lineNum">    2249</span>                 :             : {</span>
<span id="L2250"><span class="lineNum">    2250</span>                 :<span class="tlaUNC">           0 :     SignatureData sigdata;</span></span>
<span id="L2251"><span class="lineNum">    2251</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     CScript script_pub_key = GetScriptForDestination(pkhash);</span></span>
<span id="L2252"><span class="lineNum">    2252</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (const auto&amp; spk_man_pair : m_spk_managers) {</span></span>
<span id="L2253"><span class="lineNum">    2253</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (spk_man_pair.second-&gt;CanProvide(script_pub_key, sigdata)) {</span></span>
<span id="L2254"><span class="lineNum">    2254</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             LOCK(cs_wallet);  // DescriptorScriptPubKeyMan calls IsLocked which can lock cs_wallet in a deadlocking order</span></span>
<span id="L2255"><span class="lineNum">    2255</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             return spk_man_pair.second-&gt;SignMessage(message, pkhash, str_sig);</span></span>
<span id="L2256"><span class="lineNum">    2256</span>                 :<span class="tlaUNC">           0 :         }</span></span>
<span id="L2257"><span class="lineNum">    2257</span>                 :             :     }</span>
<span id="L2258"><span class="lineNum">    2258</span>                 :             :     return SigningResult::PRIVATE_KEY_NOT_AVAILABLE;</span>
<span id="L2259"><span class="lineNum">    2259</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L2260"><span class="lineNum">    2260</span>                 :             : </span>
<span id="L2261"><span class="lineNum">    2261</span>                 :<span class="tlaUNC">           0 : OutputType CWallet::TransactionChangeType(const std::optional&lt;OutputType&gt;&amp; change_type, const std::vector&lt;CRecipient&gt;&amp; vecSend) const</span></span>
<span id="L2262"><span class="lineNum">    2262</span>                 :             : {</span>
<span id="L2263"><span class="lineNum">    2263</span>                 :             :     // If -changetype is specified, always use that change type.</span>
<span id="L2264"><span class="lineNum">    2264</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (change_type) {</span></span>
<span id="L2265"><span class="lineNum">    2265</span>                 :<span class="tlaUNC">           0 :         return *change_type;</span></span>
<span id="L2266"><span class="lineNum">    2266</span>                 :             :     }</span>
<span id="L2267"><span class="lineNum">    2267</span>                 :             : </span>
<span id="L2268"><span class="lineNum">    2268</span>                 :             :     // if m_default_address_type is legacy, use legacy address as change.</span>
<span id="L2269"><span class="lineNum">    2269</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (m_default_address_type == OutputType::LEGACY) {</span></span>
<span id="L2270"><span class="lineNum">    2270</span>                 :             :         return OutputType::LEGACY;</span>
<span id="L2271"><span class="lineNum">    2271</span>                 :             :     }</span>
<span id="L2272"><span class="lineNum">    2272</span>                 :             : </span>
<span id="L2273"><span class="lineNum">    2273</span>                 :<span class="tlaUNC">           0 :     bool any_tr{false};</span></span>
<span id="L2274"><span class="lineNum">    2274</span>                 :<span class="tlaUNC">           0 :     bool any_wpkh{false};</span></span>
<span id="L2275"><span class="lineNum">    2275</span>                 :<span class="tlaUNC">           0 :     bool any_sh{false};</span></span>
<span id="L2276"><span class="lineNum">    2276</span>                 :<span class="tlaUNC">           0 :     bool any_pkh{false};</span></span>
<span id="L2277"><span class="lineNum">    2277</span>                 :             : </span>
<span id="L2278"><span class="lineNum">    2278</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (const auto&amp; recipient : vecSend) {</span></span>
<span id="L2279"><span class="lineNum">    2279</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (std::get_if&lt;WitnessV1Taproot&gt;(&amp;recipient.dest)) {</span></span>
<span id="L2280"><span class="lineNum">    2280</span>                 :             :             any_tr = true;</span>
<span id="L2281"><span class="lineNum">    2281</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         } else if (std::get_if&lt;WitnessV0KeyHash&gt;(&amp;recipient.dest)) {</span></span>
<span id="L2282"><span class="lineNum">    2282</span>                 :             :             any_wpkh = true;</span>
<span id="L2283"><span class="lineNum">    2283</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         } else if (std::get_if&lt;ScriptHash&gt;(&amp;recipient.dest)) {</span></span>
<span id="L2284"><span class="lineNum">    2284</span>                 :             :             any_sh = true;</span>
<span id="L2285"><span class="lineNum">    2285</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         } else if (std::get_if&lt;PKHash&gt;(&amp;recipient.dest)) {</span></span>
<span id="L2286"><span class="lineNum">    2286</span>                 :<span class="tlaUNC">           0 :             any_pkh = true;</span></span>
<span id="L2287"><span class="lineNum">    2287</span>                 :             :         }</span>
<span id="L2288"><span class="lineNum">    2288</span>                 :             :     }</span>
<span id="L2289"><span class="lineNum">    2289</span>                 :             : </span>
<span id="L2290"><span class="lineNum">    2290</span>                 :<span class="tlaUNC">           0 :     const bool has_bech32m_spkman(GetScriptPubKeyMan(OutputType::BECH32M, /*internal=*/true));</span></span>
<span id="L2291"><span class="lineNum">    2291</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (has_bech32m_spkman &amp;&amp; any_tr) {</span></span>
<span id="L2292"><span class="lineNum">    2292</span>                 :             :         // Currently tr is the only type supported by the BECH32M spkman</span>
<span id="L2293"><span class="lineNum">    2293</span>                 :             :         return OutputType::BECH32M;</span>
<span id="L2294"><span class="lineNum">    2294</span>                 :             :     }</span>
<span id="L2295"><span class="lineNum">    2295</span>                 :<span class="tlaUNC">           0 :     const bool has_bech32_spkman(GetScriptPubKeyMan(OutputType::BECH32, /*internal=*/true));</span></span>
<span id="L2296"><span class="lineNum">    2296</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (has_bech32_spkman &amp;&amp; any_wpkh) {</span></span>
<span id="L2297"><span class="lineNum">    2297</span>                 :             :         // Currently wpkh is the only type supported by the BECH32 spkman</span>
<span id="L2298"><span class="lineNum">    2298</span>                 :             :         return OutputType::BECH32;</span>
<span id="L2299"><span class="lineNum">    2299</span>                 :             :     }</span>
<span id="L2300"><span class="lineNum">    2300</span>                 :<span class="tlaUNC">           0 :     const bool has_p2sh_segwit_spkman(GetScriptPubKeyMan(OutputType::P2SH_SEGWIT, /*internal=*/true));</span></span>
<span id="L2301"><span class="lineNum">    2301</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (has_p2sh_segwit_spkman &amp;&amp; any_sh) {</span></span>
<span id="L2302"><span class="lineNum">    2302</span>                 :             :         // Currently sh_wpkh is the only type supported by the P2SH_SEGWIT spkman</span>
<span id="L2303"><span class="lineNum">    2303</span>                 :             :         // As of 2021 about 80% of all SH are wrapping WPKH, so use that</span>
<span id="L2304"><span class="lineNum">    2304</span>                 :             :         return OutputType::P2SH_SEGWIT;</span>
<span id="L2305"><span class="lineNum">    2305</span>                 :             :     }</span>
<span id="L2306"><span class="lineNum">    2306</span>                 :<span class="tlaUNC">           0 :     const bool has_legacy_spkman(GetScriptPubKeyMan(OutputType::LEGACY, /*internal=*/true));</span></span>
<span id="L2307"><span class="lineNum">    2307</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (has_legacy_spkman &amp;&amp; any_pkh) {</span></span>
<span id="L2308"><span class="lineNum">    2308</span>                 :             :         // Currently pkh is the only type supported by the LEGACY spkman</span>
<span id="L2309"><span class="lineNum">    2309</span>                 :             :         return OutputType::LEGACY;</span>
<span id="L2310"><span class="lineNum">    2310</span>                 :             :     }</span>
<span id="L2311"><span class="lineNum">    2311</span>                 :             : </span>
<span id="L2312"><span class="lineNum">    2312</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (has_bech32m_spkman) {</span></span>
<span id="L2313"><span class="lineNum">    2313</span>                 :             :         return OutputType::BECH32M;</span>
<span id="L2314"><span class="lineNum">    2314</span>                 :             :     }</span>
<span id="L2315"><span class="lineNum">    2315</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (has_bech32_spkman) {</span></span>
<span id="L2316"><span class="lineNum">    2316</span>                 :             :         return OutputType::BECH32;</span>
<span id="L2317"><span class="lineNum">    2317</span>                 :             :     }</span>
<span id="L2318"><span class="lineNum">    2318</span>                 :             :     // else use m_default_address_type for change</span>
<span id="L2319"><span class="lineNum">    2319</span>                 :<span class="tlaUNC">           0 :     return m_default_address_type;</span></span>
<span id="L2320"><span class="lineNum">    2320</span>                 :             : }</span>
<span id="L2321"><span class="lineNum">    2321</span>                 :             : </span>
<span id="L2322"><span class="lineNum">    2322</span>                 :<span class="tlaUNC">           0 : void CWallet::CommitTransaction(CTransactionRef tx, mapValue_t mapValue, std::vector&lt;std::pair&lt;std::string, std::string&gt;&gt; orderForm)</span></span>
<span id="L2323"><span class="lineNum">    2323</span>                 :             : {</span>
<span id="L2324"><span class="lineNum">    2324</span>                 :<span class="tlaUNC">           0 :     LOCK(cs_wallet);</span></span>
<span id="L2325"><span class="lineNum">    2325</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     WalletLogPrintf(&quot;CommitTransaction:\n%s\n&quot;, util::RemoveSuffixView(tx-&gt;ToString(), &quot;\n&quot;));</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L2326"><span class="lineNum">    2326</span>                 :             : </span>
<span id="L2327"><span class="lineNum">    2327</span>                 :             :     // Add tx to wallet, because if it has change it's also ours,</span>
<span id="L2328"><span class="lineNum">    2328</span>                 :             :     // otherwise just for transaction history.</span>
<span id="L2329"><span class="lineNum">    2329</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     CWalletTx* wtx = AddToWallet(tx, TxStateInactive{}, [&amp;](CWalletTx&amp; wtx, bool new_tx) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L2330"><span class="lineNum">    2330</span>                 :<span class="tlaUNC">           0 :         CHECK_NONFATAL(wtx.mapValue.empty());</span></span>
<span id="L2331"><span class="lineNum">    2331</span>                 :<span class="tlaUNC">           0 :         CHECK_NONFATAL(wtx.vOrderForm.empty());</span></span>
<span id="L2332"><span class="lineNum">    2332</span>                 :<span class="tlaUNC">           0 :         wtx.mapValue = std::move(mapValue);</span></span>
<span id="L2333"><span class="lineNum">    2333</span>                 :<span class="tlaUNC">           0 :         wtx.vOrderForm = std::move(orderForm);</span></span>
<span id="L2334"><span class="lineNum">    2334</span>                 :<span class="tlaUNC">           0 :         wtx.fTimeReceivedIsTxTime = true;</span></span>
<span id="L2335"><span class="lineNum">    2335</span>                 :<span class="tlaUNC">           0 :         wtx.fFromMe = true;</span></span>
<span id="L2336"><span class="lineNum">    2336</span>                 :<span class="tlaUNC">           0 :         return true;</span></span>
<span id="L2337"><span class="lineNum">    2337</span>                 :             :     });</span>
<span id="L2338"><span class="lineNum">    2338</span>                 :             : </span>
<span id="L2339"><span class="lineNum">    2339</span>                 :             :     // wtx can only be null if the db write failed.</span>
<span id="L2340"><span class="lineNum">    2340</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!wtx) {</span></span>
<span id="L2341"><span class="lineNum">    2341</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         throw std::runtime_error(std::string(__func__) + &quot;: Wallet db error, transaction commit failed&quot;);</span></span>
<span id="L2342"><span class="lineNum">    2342</span>                 :             :     }</span>
<span id="L2343"><span class="lineNum">    2343</span>                 :             : </span>
<span id="L2344"><span class="lineNum">    2344</span>                 :             :     // Notify that old coins are spent</span>
<span id="L2345"><span class="lineNum">    2345</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (const CTxIn&amp; txin : tx-&gt;vin) {</span></span>
<span id="L2346"><span class="lineNum">    2346</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         CWalletTx &amp;coin = mapWallet.at(txin.prevout.hash);</span></span>
<span id="L2347"><span class="lineNum">    2347</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         coin.MarkDirty();</span></span>
<span id="L2348"><span class="lineNum">    2348</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         NotifyTransactionChanged(coin.GetHash(), CT_UPDATED);</span></span>
<span id="L2349"><span class="lineNum">    2349</span>                 :             :     }</span>
<span id="L2350"><span class="lineNum">    2350</span>                 :             : </span>
<span id="L2351"><span class="lineNum">    2351</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!fBroadcastTransactions) {</span></span>
<span id="L2352"><span class="lineNum">    2352</span>                 :             :         // Don't submit tx to the mempool</span>
<span id="L2353"><span class="lineNum">    2353</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         return;</span></span>
<span id="L2354"><span class="lineNum">    2354</span>                 :             :     }</span>
<span id="L2355"><span class="lineNum">    2355</span>                 :             : </span>
<span id="L2356"><span class="lineNum">    2356</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     std::string err_string;</span></span>
<span id="L2357"><span class="lineNum">    2357</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!SubmitTxMemoryPoolAndRelay(*wtx, err_string, true)) {</span></span>
<span id="L2358"><span class="lineNum">    2358</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         WalletLogPrintf(&quot;CommitTransaction(): Transaction cannot be broadcast immediately, %s\n&quot;, err_string);</span></span>
<span id="L2359"><span class="lineNum">    2359</span>                 :             :         // TODO: if we expect the failure to be long term or permanent, instead delete wtx from the wallet and return failure.</span>
<span id="L2360"><span class="lineNum">    2360</span>                 :             :     }</span>
<span id="L2361"><span class="lineNum">    2361</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 : }</span></span>
<span id="L2362"><span class="lineNum">    2362</span>                 :             : </span>
<span id="L2363"><span class="lineNum">    2363</span>                 :<span class="tlaUNC">           0 : DBErrors CWallet::LoadWallet()</span></span>
<span id="L2364"><span class="lineNum">    2364</span>                 :             : {</span>
<span id="L2365"><span class="lineNum">    2365</span>                 :<span class="tlaUNC">           0 :     LOCK(cs_wallet);</span></span>
<span id="L2366"><span class="lineNum">    2366</span>                 :             : </span>
<span id="L2367"><span class="lineNum">    2367</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     Assert(m_spk_managers.empty());</span></span>
<span id="L2368"><span class="lineNum">    2368</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     Assert(m_wallet_flags == 0);</span></span>
<span id="L2369"><span class="lineNum">    2369</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     DBErrors nLoadWalletRet = WalletBatch(GetDatabase()).LoadWallet(this);</span></span>
<span id="L2370"><span class="lineNum">    2370</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (nLoadWalletRet == DBErrors::NEED_REWRITE)</span></span>
<span id="L2371"><span class="lineNum">    2371</span>                 :             :     {</span>
<span id="L2372"><span class="lineNum">    2372</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (GetDatabase().Rewrite(&quot;\x04pool&quot;))</span></span>
<span id="L2373"><span class="lineNum">    2373</span>                 :             :         {</span>
<span id="L2374"><span class="lineNum">    2374</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             for (const auto&amp; spk_man_pair : m_spk_managers) {</span></span>
<span id="L2375"><span class="lineNum">    2375</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 spk_man_pair.second-&gt;RewriteDB();</span></span>
<span id="L2376"><span class="lineNum">    2376</span>                 :             :             }</span>
<span id="L2377"><span class="lineNum">    2377</span>                 :             :         }</span>
<span id="L2378"><span class="lineNum">    2378</span>                 :             :     }</span>
<span id="L2379"><span class="lineNum">    2379</span>                 :             : </span>
<span id="L2380"><span class="lineNum">    2380</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (m_spk_managers.empty()) {</span></span>
<span id="L2381"><span class="lineNum">    2381</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         assert(m_external_spk_managers.empty());</span></span>
<span id="L2382"><span class="lineNum">    2382</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         assert(m_internal_spk_managers.empty());</span></span>
<span id="L2383"><span class="lineNum">    2383</span>                 :             :     }</span>
<span id="L2384"><span class="lineNum">    2384</span>                 :             : </span>
<span id="L2385"><span class="lineNum">    2385</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     return nLoadWalletRet;</span></span>
<span id="L2386"><span class="lineNum">    2386</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L2387"><span class="lineNum">    2387</span>                 :             : </span>
<span id="L2388"><span class="lineNum">    2388</span>                 :<span class="tlaUNC">           0 : util::Result&lt;void&gt; CWallet::RemoveTxs(std::vector&lt;uint256&gt;&amp; txs_to_remove)</span></span>
<span id="L2389"><span class="lineNum">    2389</span>                 :             : {</span>
<span id="L2390"><span class="lineNum">    2390</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L2391"><span class="lineNum">    2391</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     bilingual_str str_err;  // future: make RunWithinTxn return a util::Result</span></span>
<span id="L2392"><span class="lineNum">    2392</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     bool was_txn_committed = RunWithinTxn(GetDatabase(), /*process_desc=*/&quot;remove transactions&quot;, [&amp;](WalletBatch&amp; batch) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet) {</span></span>
<span id="L2393"><span class="lineNum">    2393</span>                 :<span class="tlaUNC">           0 :         util::Result&lt;void&gt; result{RemoveTxs(batch, txs_to_remove)};</span></span>
<span id="L2394"><span class="lineNum">    2394</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!result) str_err = util::ErrorString(result);</span></span>
<span id="L2395"><span class="lineNum">    2395</span>                 :<span class="tlaUNC">           0 :         return result.has_value();</span></span>
<span id="L2396"><span class="lineNum">    2396</span>                 :<span class="tlaUNC">           0 :     });</span></span>
<span id="L2397"><span class="lineNum">    2397</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!str_err.empty()) return util::Error{str_err};</span></span>
<span id="L2398"><span class="lineNum">    2398</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!was_txn_committed) return util::Error{_(&quot;Error starting/committing db txn for wallet transactions removal process&quot;)};</span></span>
<span id="L2399"><span class="lineNum">    2399</span>                 :<span class="tlaUNC">           0 :     return {}; // all good</span></span>
<span id="L2400"><span class="lineNum">    2400</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L2401"><span class="lineNum">    2401</span>                 :             : </span>
<span id="L2402"><span class="lineNum">    2402</span>                 :<span class="tlaUNC">           0 : util::Result&lt;void&gt; CWallet::RemoveTxs(WalletBatch&amp; batch, std::vector&lt;uint256&gt;&amp; txs_to_remove)</span></span>
<span id="L2403"><span class="lineNum">    2403</span>                 :             : {</span>
<span id="L2404"><span class="lineNum">    2404</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L2405"><span class="lineNum">    2405</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!batch.HasActiveTxn()) return util::Error{strprintf(_(&quot;The transactions removal process can only be executed within a db txn&quot;))};</span></span>
<span id="L2406"><span class="lineNum">    2406</span>                 :             : </span>
<span id="L2407"><span class="lineNum">    2407</span>                 :             :     // Check for transaction existence and remove entries from disk</span>
<span id="L2408"><span class="lineNum">    2408</span>                 :<span class="tlaUNC">           0 :     using TxIterator = std::unordered_map&lt;uint256, CWalletTx, SaltedTxidHasher&gt;::const_iterator;</span></span>
<span id="L2409"><span class="lineNum">    2409</span>                 :<span class="tlaUNC">           0 :     std::vector&lt;TxIterator&gt; erased_txs;</span></span>
<span id="L2410"><span class="lineNum">    2410</span>                 :<span class="tlaUNC">           0 :     bilingual_str str_err;</span></span>
<span id="L2411"><span class="lineNum">    2411</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (const uint256&amp; hash : txs_to_remove) {</span></span>
<span id="L2412"><span class="lineNum">    2412</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         auto it_wtx = mapWallet.find(hash);</span></span>
<span id="L2413"><span class="lineNum">    2413</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (it_wtx == mapWallet.end()) {</span></span>
<span id="L2414"><span class="lineNum">    2414</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             return util::Error{strprintf(_(&quot;Transaction %s does not belong to this wallet&quot;), hash.GetHex())};</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L2415"><span class="lineNum">    2415</span>                 :             :         }</span>
<span id="L2416"><span class="lineNum">    2416</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!batch.EraseTx(hash)) {</span></span>
<span id="L2417"><span class="lineNum">    2417</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             return util::Error{strprintf(_(&quot;Failure removing transaction: %s&quot;), hash.GetHex())};</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L2418"><span class="lineNum">    2418</span>                 :             :         }</span>
<span id="L2419"><span class="lineNum">    2419</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         erased_txs.emplace_back(it_wtx);</span></span>
<span id="L2420"><span class="lineNum">    2420</span>                 :             :     }</span>
<span id="L2421"><span class="lineNum">    2421</span>                 :             : </span>
<span id="L2422"><span class="lineNum">    2422</span>                 :             :     // Register callback to update the memory state only when the db txn is actually dumped to disk</span>
<span id="L2423"><span class="lineNum">    2423</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     batch.RegisterTxnListener({.on_commit=[&amp;, erased_txs]() EXCLUSIVE_LOCKS_REQUIRED(cs_wallet) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L2424"><span class="lineNum">    2424</span>                 :             :         // Update the in-memory state and notify upper layers about the removals</span>
<span id="L2425"><span class="lineNum">    2425</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (const auto&amp; it : erased_txs) {</span></span>
<span id="L2426"><span class="lineNum">    2426</span>                 :<span class="tlaUNC">           0 :             const uint256 hash{it-&gt;first};</span></span>
<span id="L2427"><span class="lineNum">    2427</span>                 :<span class="tlaUNC">           0 :             wtxOrdered.erase(it-&gt;second.m_it_wtxOrdered);</span></span>
<span id="L2428"><span class="lineNum">    2428</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             for (const auto&amp; txin : it-&gt;second.tx-&gt;vin)</span></span>
<span id="L2429"><span class="lineNum">    2429</span>                 :<span class="tlaUNC">           0 :                 mapTxSpends.erase(txin.prevout);</span></span>
<span id="L2430"><span class="lineNum">    2430</span>                 :<span class="tlaUNC">           0 :             mapWallet.erase(it);</span></span>
<span id="L2431"><span class="lineNum">    2431</span>                 :<span class="tlaUNC">           0 :             NotifyTransactionChanged(hash, CT_DELETED);</span></span>
<span id="L2432"><span class="lineNum">    2432</span>                 :             :         }</span>
<span id="L2433"><span class="lineNum">    2433</span>                 :             : </span>
<span id="L2434"><span class="lineNum">    2434</span>                 :<span class="tlaUNC">           0 :         MarkDirty();</span></span>
<span id="L2435"><span class="lineNum">    2435</span>                 :<span class="tlaUNC">           0 :     }, .on_abort={}});</span></span>
<span id="L2436"><span class="lineNum">    2436</span>                 :             : </span>
<span id="L2437"><span class="lineNum">    2437</span>                 :<span class="tlaUNC">           0 :     return {};</span></span>
<span id="L2438"><span class="lineNum">    2438</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 : }</span></span>
<span id="L2439"><span class="lineNum">    2439</span>                 :             : </span>
<span id="L2440"><span class="lineNum">    2440</span>                 :<span class="tlaUNC">           0 : bool CWallet::SetAddressBookWithDB(WalletBatch&amp; batch, const CTxDestination&amp; address, const std::string&amp; strName, const std::optional&lt;AddressPurpose&gt;&amp; new_purpose)</span></span>
<span id="L2441"><span class="lineNum">    2441</span>                 :             : {</span>
<span id="L2442"><span class="lineNum">    2442</span>                 :<span class="tlaUNC">           0 :     bool fUpdated = false;</span></span>
<span id="L2443"><span class="lineNum">    2443</span>                 :<span class="tlaUNC">           0 :     bool is_mine;</span></span>
<span id="L2444"><span class="lineNum">    2444</span>                 :<span class="tlaUNC">           0 :     std::optional&lt;AddressPurpose&gt; purpose;</span></span>
<span id="L2445"><span class="lineNum">    2445</span>                 :<span class="tlaUNC">           0 :     {</span></span>
<span id="L2446"><span class="lineNum">    2446</span>                 :<span class="tlaUNC">           0 :         LOCK(cs_wallet);</span></span>
<span id="L2447"><span class="lineNum">    2447</span>                 :<span class="tlaUNC">           0 :         std::map&lt;CTxDestination, CAddressBookData&gt;::iterator mi = m_address_book.find(address);</span></span>
<span id="L2448"><span class="lineNum">    2448</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         fUpdated = mi != m_address_book.end() &amp;&amp; !mi-&gt;second.IsChange();</span></span>
<span id="L2449"><span class="lineNum">    2449</span>                 :             : </span>
<span id="L2450"><span class="lineNum">    2450</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         CAddressBookData&amp; record = mi != m_address_book.end() ? mi-&gt;second : m_address_book[address];</span></span>
<span id="L2451"><span class="lineNum">    2451</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         record.SetLabel(strName);</span></span>
<span id="L2452"><span class="lineNum">    2452</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         is_mine = IsMine(address) != ISMINE_NO;</span></span>
<span id="L2453"><span class="lineNum">    2453</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (new_purpose) { /* update purpose only if requested */</span></span>
<span id="L2454"><span class="lineNum">    2454</span>                 :<span class="tlaUNC">           0 :             record.purpose = new_purpose;</span></span>
<span id="L2455"><span class="lineNum">    2455</span>                 :             :         }</span>
<span id="L2456"><span class="lineNum">    2456</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         purpose = record.purpose;</span></span>
<span id="L2457"><span class="lineNum">    2457</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L2458"><span class="lineNum">    2458</span>                 :             : </span>
<span id="L2459"><span class="lineNum">    2459</span>                 :<span class="tlaUNC">           0 :     const std::string&amp; encoded_dest = EncodeDestination(address);</span></span>
<span id="L2460"><span class="lineNum">    2460</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     if (new_purpose &amp;&amp; !batch.WritePurpose(encoded_dest, PurposeToString(*new_purpose))) {</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not executed"> # </span>]
<span id="L2461"><span class="lineNum">    2461</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         WalletLogPrintf(&quot;Error: fail to write address book 'purpose' entry\n&quot;);</span></span>
<span id="L2462"><span class="lineNum">    2462</span>                 :             :         return false;</span>
<span id="L2463"><span class="lineNum">    2463</span>                 :             :     }</span>
<span id="L2464"><span class="lineNum">    2464</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!batch.WriteName(encoded_dest, strName)) {</span></span>
<span id="L2465"><span class="lineNum">    2465</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         WalletLogPrintf(&quot;Error: fail to write address book 'name' entry\n&quot;);</span></span>
<span id="L2466"><span class="lineNum">    2466</span>                 :             :         return false;</span>
<span id="L2467"><span class="lineNum">    2467</span>                 :             :     }</span>
<span id="L2468"><span class="lineNum">    2468</span>                 :             : </span>
<span id="L2469"><span class="lineNum">    2469</span>                 :             :     // In very old wallets, address purpose may not be recorded so we derive it from IsMine</span>
<span id="L2470"><span class="lineNum">    2470</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     NotifyAddressBookChanged(address, strName, is_mine,</span></span>
<span id="L2471"><span class="lineNum">    2471</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                              purpose.value_or(is_mine ? AddressPurpose::RECEIVE : AddressPurpose::SEND),</span></span>
<span id="L2472"><span class="lineNum">    2472</span>                 :             :                              (fUpdated ? CT_UPDATED : CT_NEW));</span>
<span id="L2473"><span class="lineNum">    2473</span>                 :             :     return true;</span>
<span id="L2474"><span class="lineNum">    2474</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L2475"><span class="lineNum">    2475</span>                 :             : </span>
<span id="L2476"><span class="lineNum">    2476</span>                 :<span class="tlaUNC">           0 : bool CWallet::SetAddressBook(const CTxDestination&amp; address, const std::string&amp; strName, const std::optional&lt;AddressPurpose&gt;&amp; purpose)</span></span>
<span id="L2477"><span class="lineNum">    2477</span>                 :             : {</span>
<span id="L2478"><span class="lineNum">    2478</span>                 :<span class="tlaUNC">           0 :     WalletBatch batch(GetDatabase());</span></span>
<span id="L2479"><span class="lineNum">    2479</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     return SetAddressBookWithDB(batch, address, strName, purpose);</span></span>
<span id="L2480"><span class="lineNum">    2480</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L2481"><span class="lineNum">    2481</span>                 :             : </span>
<span id="L2482"><span class="lineNum">    2482</span>                 :<span class="tlaUNC">           0 : bool CWallet::DelAddressBook(const CTxDestination&amp; address)</span></span>
<span id="L2483"><span class="lineNum">    2483</span>                 :             : {</span>
<span id="L2484"><span class="lineNum">    2484</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     return RunWithinTxn(GetDatabase(), /*process_desc=*/&quot;address book entry removal&quot;, [&amp;](WalletBatch&amp; batch){</span></span>
<span id="L2485"><span class="lineNum">    2485</span>                 :<span class="tlaUNC">           0 :         return DelAddressBookWithDB(batch, address);</span></span>
<span id="L2486"><span class="lineNum">    2486</span>                 :<span class="tlaUNC">           0 :     });</span></span>
<span id="L2487"><span class="lineNum">    2487</span>                 :             : }</span>
<span id="L2488"><span class="lineNum">    2488</span>                 :             : </span>
<span id="L2489"><span class="lineNum">    2489</span>                 :<span class="tlaUNC">           0 : bool CWallet::DelAddressBookWithDB(WalletBatch&amp; batch, const CTxDestination&amp; address)</span></span>
<span id="L2490"><span class="lineNum">    2490</span>                 :             : {</span>
<span id="L2491"><span class="lineNum">    2491</span>                 :<span class="tlaUNC">           0 :     const std::string&amp; dest = EncodeDestination(address);</span></span>
<span id="L2492"><span class="lineNum">    2492</span>                 :<span class="tlaUNC">           0 :     {</span></span>
<span id="L2493"><span class="lineNum">    2493</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LOCK(cs_wallet);</span></span>
<span id="L2494"><span class="lineNum">    2494</span>                 :             :         // If we want to delete receiving addresses, we should avoid calling EraseAddressData because it will delete the previously_spent value. Could instead just erase the label so it becomes a change address, and keep the data.</span>
<span id="L2495"><span class="lineNum">    2495</span>                 :             :         // NOTE: This isn't a problem for sending addresses because they don't have any data that needs to be kept.</span>
<span id="L2496"><span class="lineNum">    2496</span>                 :             :         // When adding new address data, it should be considered here whether to retain or delete it.</span>
<span id="L2497"><span class="lineNum">    2497</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (IsMine(address)) {</span></span>
<span id="L2498"><span class="lineNum">    2498</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             WalletLogPrintf(&quot;%s called with IsMine address, NOT SUPPORTED. Please report this bug! %s\n&quot;, __func__, CLIENT_BUGREPORT);</span></span>
<span id="L2499"><span class="lineNum">    2499</span>                 :             :             return false;</span>
<span id="L2500"><span class="lineNum">    2500</span>                 :             :         }</span>
<span id="L2501"><span class="lineNum">    2501</span>                 :             :         // Delete data rows associated with this address</span>
<span id="L2502"><span class="lineNum">    2502</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!batch.EraseAddressData(address)) {</span></span>
<span id="L2503"><span class="lineNum">    2503</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             WalletLogPrintf(&quot;Error: cannot erase address book entry data\n&quot;);</span></span>
<span id="L2504"><span class="lineNum">    2504</span>                 :             :             return false;</span>
<span id="L2505"><span class="lineNum">    2505</span>                 :             :         }</span>
<span id="L2506"><span class="lineNum">    2506</span>                 :             : </span>
<span id="L2507"><span class="lineNum">    2507</span>                 :             :         // Delete purpose entry</span>
<span id="L2508"><span class="lineNum">    2508</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!batch.ErasePurpose(dest)) {</span></span>
<span id="L2509"><span class="lineNum">    2509</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             WalletLogPrintf(&quot;Error: cannot erase address book entry purpose\n&quot;);</span></span>
<span id="L2510"><span class="lineNum">    2510</span>                 :             :             return false;</span>
<span id="L2511"><span class="lineNum">    2511</span>                 :             :         }</span>
<span id="L2512"><span class="lineNum">    2512</span>                 :             : </span>
<span id="L2513"><span class="lineNum">    2513</span>                 :             :         // Delete name entry</span>
<span id="L2514"><span class="lineNum">    2514</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!batch.EraseName(dest)) {</span></span>
<span id="L2515"><span class="lineNum">    2515</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             WalletLogPrintf(&quot;Error: cannot erase address book entry name\n&quot;);</span></span>
<span id="L2516"><span class="lineNum">    2516</span>                 :             :             return false;</span>
<span id="L2517"><span class="lineNum">    2517</span>                 :             :         }</span>
<span id="L2518"><span class="lineNum">    2518</span>                 :             : </span>
<span id="L2519"><span class="lineNum">    2519</span>                 :             :         // finally, remove it from the map</span>
<span id="L2520"><span class="lineNum">    2520</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         m_address_book.erase(address);</span></span>
<span id="L2521"><span class="lineNum">    2521</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L2522"><span class="lineNum">    2522</span>                 :             : </span>
<span id="L2523"><span class="lineNum">    2523</span>                 :             :     // All good, signal changes</span>
<span id="L2524"><span class="lineNum">    2524</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     NotifyAddressBookChanged(address, &quot;&quot;, /*is_mine=*/false, AddressPurpose::SEND, CT_DELETED);</span></span>
<span id="L2525"><span class="lineNum">    2525</span>                 :<span class="tlaUNC">           0 :     return true;</span></span>
<span id="L2526"><span class="lineNum">    2526</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L2527"><span class="lineNum">    2527</span>                 :             : </span>
<span id="L2528"><span class="lineNum">    2528</span>                 :<span class="tlaUNC">           0 : size_t CWallet::KeypoolCountExternalKeys() const</span></span>
<span id="L2529"><span class="lineNum">    2529</span>                 :             : {</span>
<span id="L2530"><span class="lineNum">    2530</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L2531"><span class="lineNum">    2531</span>                 :             : </span>
<span id="L2532"><span class="lineNum">    2532</span>                 :<span class="tlaUNC">           0 :     auto legacy_spk_man = GetLegacyScriptPubKeyMan();</span></span>
<span id="L2533"><span class="lineNum">    2533</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (legacy_spk_man) {</span></span>
<span id="L2534"><span class="lineNum">    2534</span>                 :<span class="tlaUNC">           0 :         return legacy_spk_man-&gt;KeypoolCountExternalKeys();</span></span>
<span id="L2535"><span class="lineNum">    2535</span>                 :             :     }</span>
<span id="L2536"><span class="lineNum">    2536</span>                 :             : </span>
<span id="L2537"><span class="lineNum">    2537</span>                 :<span class="tlaUNC">           0 :     unsigned int count = 0;</span></span>
<span id="L2538"><span class="lineNum">    2538</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (auto spk_man : m_external_spk_managers) {</span></span>
<span id="L2539"><span class="lineNum">    2539</span>                 :<span class="tlaUNC">           0 :         count += spk_man.second-&gt;GetKeyPoolSize();</span></span>
<span id="L2540"><span class="lineNum">    2540</span>                 :             :     }</span>
<span id="L2541"><span class="lineNum">    2541</span>                 :             : </span>
<span id="L2542"><span class="lineNum">    2542</span>                 :<span class="tlaUNC">           0 :     return count;</span></span>
<span id="L2543"><span class="lineNum">    2543</span>                 :             : }</span>
<span id="L2544"><span class="lineNum">    2544</span>                 :             : </span>
<span id="L2545"><span class="lineNum">    2545</span>                 :<span class="tlaUNC">           0 : unsigned int CWallet::GetKeyPoolSize() const</span></span>
<span id="L2546"><span class="lineNum">    2546</span>                 :             : {</span>
<span id="L2547"><span class="lineNum">    2547</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L2548"><span class="lineNum">    2548</span>                 :             : </span>
<span id="L2549"><span class="lineNum">    2549</span>                 :<span class="tlaUNC">           0 :     unsigned int count = 0;</span></span>
<span id="L2550"><span class="lineNum">    2550</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (auto spk_man : GetActiveScriptPubKeyMans()) {</span></span>
<span id="L2551"><span class="lineNum">    2551</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         count += spk_man-&gt;GetKeyPoolSize();</span></span>
<span id="L2552"><span class="lineNum">    2552</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L2553"><span class="lineNum">    2553</span>                 :<span class="tlaUNC">           0 :     return count;</span></span>
<span id="L2554"><span class="lineNum">    2554</span>                 :             : }</span>
<span id="L2555"><span class="lineNum">    2555</span>                 :             : </span>
<span id="L2556"><span class="lineNum">    2556</span>                 :<span class="tlaUNC">           0 : bool CWallet::TopUpKeyPool(unsigned int kpSize)</span></span>
<span id="L2557"><span class="lineNum">    2557</span>                 :             : {</span>
<span id="L2558"><span class="lineNum">    2558</span>                 :<span class="tlaUNC">           0 :     LOCK(cs_wallet);</span></span>
<span id="L2559"><span class="lineNum">    2559</span>                 :<span class="tlaUNC">           0 :     bool res = true;</span></span>
<span id="L2560"><span class="lineNum">    2560</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (auto spk_man : GetActiveScriptPubKeyMans()) {</span></span>
<span id="L2561"><span class="lineNum">    2561</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         res &amp;= spk_man-&gt;TopUp(kpSize);</span></span>
<span id="L2562"><span class="lineNum">    2562</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L2563"><span class="lineNum">    2563</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     return res;</span></span>
<span id="L2564"><span class="lineNum">    2564</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L2565"><span class="lineNum">    2565</span>                 :             : </span>
<span id="L2566"><span class="lineNum">    2566</span>                 :<span class="tlaUNC">           0 : util::Result&lt;CTxDestination&gt; CWallet::GetNewDestination(const OutputType type, const std::string label)</span></span>
<span id="L2567"><span class="lineNum">    2567</span>                 :             : {</span>
<span id="L2568"><span class="lineNum">    2568</span>                 :<span class="tlaUNC">           0 :     LOCK(cs_wallet);</span></span>
<span id="L2569"><span class="lineNum">    2569</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     auto spk_man = GetScriptPubKeyMan(type, /*internal=*/false);</span></span>
<span id="L2570"><span class="lineNum">    2570</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!spk_man) {</span></span>
<span id="L2571"><span class="lineNum">    2571</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         return util::Error{strprintf(_(&quot;Error: No %s addresses available.&quot;), FormatOutputType(type))};</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L2572"><span class="lineNum">    2572</span>                 :             :     }</span>
<span id="L2573"><span class="lineNum">    2573</span>                 :             : </span>
<span id="L2574"><span class="lineNum">    2574</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     auto op_dest = spk_man-&gt;GetNewDestination(type);</span></span>
<span id="L2575"><span class="lineNum">    2575</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (op_dest) {</span></span>
<span id="L2576"><span class="lineNum">    2576</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         SetAddressBook(*op_dest, label, AddressPurpose::RECEIVE);</span></span>
<span id="L2577"><span class="lineNum">    2577</span>                 :             :     }</span>
<span id="L2578"><span class="lineNum">    2578</span>                 :             : </span>
<span id="L2579"><span class="lineNum">    2579</span>                 :<span class="tlaUNC">           0 :     return op_dest;</span></span>
<span id="L2580"><span class="lineNum">    2580</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L2581"><span class="lineNum">    2581</span>                 :             : </span>
<span id="L2582"><span class="lineNum">    2582</span>                 :<span class="tlaUNC">           0 : util::Result&lt;CTxDestination&gt; CWallet::GetNewChangeDestination(const OutputType type)</span></span>
<span id="L2583"><span class="lineNum">    2583</span>                 :             : {</span>
<span id="L2584"><span class="lineNum">    2584</span>                 :<span class="tlaUNC">           0 :     LOCK(cs_wallet);</span></span>
<span id="L2585"><span class="lineNum">    2585</span>                 :             : </span>
<span id="L2586"><span class="lineNum">    2586</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     ReserveDestination reservedest(this, type);</span></span>
<span id="L2587"><span class="lineNum">    2587</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     auto op_dest = reservedest.GetReservedDestination(true);</span></span>
<span id="L2588"><span class="lineNum">    2588</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (op_dest) reservedest.KeepDestination();</span></span>
<span id="L2589"><span class="lineNum">    2589</span>                 :             : </span>
<span id="L2590"><span class="lineNum">    2590</span>                 :<span class="tlaUNC">           0 :     return op_dest;</span></span>
<span id="L2591"><span class="lineNum">    2591</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 : }</span></span>
<span id="L2592"><span class="lineNum">    2592</span>                 :             : </span>
<span id="L2593"><span class="lineNum">    2593</span>                 :<span class="tlaUNC">           0 : std::optional&lt;int64_t&gt; CWallet::GetOldestKeyPoolTime() const</span></span>
<span id="L2594"><span class="lineNum">    2594</span>                 :             : {</span>
<span id="L2595"><span class="lineNum">    2595</span>                 :<span class="tlaUNC">           0 :     LOCK(cs_wallet);</span></span>
<span id="L2596"><span class="lineNum">    2596</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (m_spk_managers.empty()) {</span></span>
<span id="L2597"><span class="lineNum">    2597</span>                 :<span class="tlaUNC">           0 :         return std::nullopt;</span></span>
<span id="L2598"><span class="lineNum">    2598</span>                 :             :     }</span>
<span id="L2599"><span class="lineNum">    2599</span>                 :             : </span>
<span id="L2600"><span class="lineNum">    2600</span>                 :<span class="tlaUNC">           0 :     std::optional&lt;int64_t&gt; oldest_key{std::numeric_limits&lt;int64_t&gt;::max()};</span></span>
<span id="L2601"><span class="lineNum">    2601</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (const auto&amp; spk_man_pair : m_spk_managers) {</span></span>
<span id="L2602"><span class="lineNum">    2602</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         oldest_key = std::min(oldest_key, spk_man_pair.second-&gt;GetOldestKeyPoolTime());</span></span>
<span id="L2603"><span class="lineNum">    2603</span>                 :             :     }</span>
<span id="L2604"><span class="lineNum">    2604</span>                 :<span class="tlaUNC">           0 :     return oldest_key;</span></span>
<span id="L2605"><span class="lineNum">    2605</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L2606"><span class="lineNum">    2606</span>                 :             : </span>
<span id="L2607"><span class="lineNum">    2607</span>                 :<span class="tlaUNC">           0 : void CWallet::MarkDestinationsDirty(const std::set&lt;CTxDestination&gt;&amp; destinations) {</span></span>
<span id="L2608"><span class="lineNum">    2608</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (auto&amp; entry : mapWallet) {</span></span>
<span id="L2609"><span class="lineNum">    2609</span>                 :<span class="tlaUNC">           0 :         CWalletTx&amp; wtx = entry.second;</span></span>
<span id="L2610"><span class="lineNum">    2610</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (wtx.m_is_cache_empty) continue;</span></span>
<span id="L2611"><span class="lineNum">    2611</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (unsigned int i = 0; i &lt; wtx.tx-&gt;vout.size(); i++) {</span></span>
<span id="L2612"><span class="lineNum">    2612</span>                 :<span class="tlaUNC">           0 :             CTxDestination dst;</span></span>
<span id="L2613"><span class="lineNum">    2613</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             if (ExtractDestination(wtx.tx-&gt;vout[i].scriptPubKey, dst) &amp;&amp; destinations.count(dst)) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L2614"><span class="lineNum">    2614</span>                 :<span class="tlaUNC">           0 :                 wtx.MarkDirty();</span></span>
<span id="L2615"><span class="lineNum">    2615</span>                 :<span class="tlaUNC">           0 :                 break;</span></span>
<span id="L2616"><span class="lineNum">    2616</span>                 :             :             }</span>
<span id="L2617"><span class="lineNum">    2617</span>                 :<span class="tlaUNC">           0 :         }</span></span>
<span id="L2618"><span class="lineNum">    2618</span>                 :             :     }</span>
<span id="L2619"><span class="lineNum">    2619</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L2620"><span class="lineNum">    2620</span>                 :             : </span>
<span id="L2621"><span class="lineNum">    2621</span>                 :<span class="tlaUNC">           0 : void CWallet::ForEachAddrBookEntry(const ListAddrBookFunc&amp; func) const</span></span>
<span id="L2622"><span class="lineNum">    2622</span>                 :             : {</span>
<span id="L2623"><span class="lineNum">    2623</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L2624"><span class="lineNum">    2624</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (const std::pair&lt;const CTxDestination, CAddressBookData&gt;&amp; item : m_address_book) {</span></span>
<span id="L2625"><span class="lineNum">    2625</span>                 :<span class="tlaUNC">           0 :         const auto&amp; entry = item.second;</span></span>
<span id="L2626"><span class="lineNum">    2626</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         func(item.first, entry.GetLabel(), entry.IsChange(), entry.purpose);</span></span>
<span id="L2627"><span class="lineNum">    2627</span>                 :             :     }</span>
<span id="L2628"><span class="lineNum">    2628</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L2629"><span class="lineNum">    2629</span>                 :             : </span>
<span id="L2630"><span class="lineNum">    2630</span>                 :<span class="tlaUNC">           0 : std::vector&lt;CTxDestination&gt; CWallet::ListAddrBookAddresses(const std::optional&lt;AddrBookFilter&gt;&amp; _filter) const</span></span>
<span id="L2631"><span class="lineNum">    2631</span>                 :             : {</span>
<span id="L2632"><span class="lineNum">    2632</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L2633"><span class="lineNum">    2633</span>                 :<span class="tlaUNC">           0 :     std::vector&lt;CTxDestination&gt; result;</span></span>
<span id="L2634"><span class="lineNum">    2634</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     AddrBookFilter filter = _filter ? *_filter : AddrBookFilter();</span></span>
<span id="L2635"><span class="lineNum">    2635</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     ForEachAddrBookEntry([&amp;result, &amp;filter](const CTxDestination&amp; dest, const std::string&amp; label, bool is_change, const std::optional&lt;AddressPurpose&gt;&amp; purpose) {</span></span>
<span id="L2636"><span class="lineNum">    2636</span>                 :             :         // Filter by change</span>
<span id="L2637"><span class="lineNum">    2637</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (filter.ignore_change &amp;&amp; is_change) return;</span></span>
<span id="L2638"><span class="lineNum">    2638</span>                 :             :         // Filter by label</span>
<span id="L2639"><span class="lineNum">    2639</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (filter.m_op_label &amp;&amp; *filter.m_op_label != label) return;</span></span>
<span id="L2640"><span class="lineNum">    2640</span>                 :             :         // All good</span>
<span id="L2641"><span class="lineNum">    2641</span>                 :<span class="tlaUNC">           0 :         result.emplace_back(dest);</span></span>
<span id="L2642"><span class="lineNum">    2642</span>                 :             :     });</span>
<span id="L2643"><span class="lineNum">    2643</span>                 :<span class="tlaUNC">           0 :     return result;</span></span>
<span id="L2644"><span class="lineNum">    2644</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L2645"><span class="lineNum">    2645</span>                 :             : </span>
<span id="L2646"><span class="lineNum">    2646</span>                 :<span class="tlaUNC">           0 : std::set&lt;std::string&gt; CWallet::ListAddrBookLabels(const std::optional&lt;AddressPurpose&gt; purpose) const</span></span>
<span id="L2647"><span class="lineNum">    2647</span>                 :             : {</span>
<span id="L2648"><span class="lineNum">    2648</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L2649"><span class="lineNum">    2649</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     std::set&lt;std::string&gt; label_set;</span></span>
<span id="L2650"><span class="lineNum">    2650</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     ForEachAddrBookEntry([&amp;](const CTxDestination&amp; _dest, const std::string&amp; _label,</span></span>
<span id="L2651"><span class="lineNum">    2651</span>                 :             :                              bool _is_change, const std::optional&lt;AddressPurpose&gt;&amp; _purpose) {</span>
<span id="L2652"><span class="lineNum">    2652</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (_is_change) return;</span></span>
<span id="L2653"><span class="lineNum">    2653</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!purpose || purpose == _purpose) {</span></span>
<span id="L2654"><span class="lineNum">    2654</span>                 :<span class="tlaUNC">           0 :             label_set.insert(_label);</span></span>
<span id="L2655"><span class="lineNum">    2655</span>                 :             :         }</span>
<span id="L2656"><span class="lineNum">    2656</span>                 :             :     });</span>
<span id="L2657"><span class="lineNum">    2657</span>                 :<span class="tlaUNC">           0 :     return label_set;</span></span>
<span id="L2658"><span class="lineNum">    2658</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L2659"><span class="lineNum">    2659</span>                 :             : </span>
<span id="L2660"><span class="lineNum">    2660</span>                 :<span class="tlaUNC">           0 : util::Result&lt;CTxDestination&gt; ReserveDestination::GetReservedDestination(bool internal)</span></span>
<span id="L2661"><span class="lineNum">    2661</span>                 :             : {</span>
<span id="L2662"><span class="lineNum">    2662</span>                 :<span class="tlaUNC">           0 :     m_spk_man = pwallet-&gt;GetScriptPubKeyMan(type, internal);</span></span>
<span id="L2663"><span class="lineNum">    2663</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!m_spk_man) {</span></span>
<span id="L2664"><span class="lineNum">    2664</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         return util::Error{strprintf(_(&quot;Error: No %s addresses available.&quot;), FormatOutputType(type))};</span></span>
<span id="L2665"><span class="lineNum">    2665</span>                 :             :     }</span>
<span id="L2666"><span class="lineNum">    2666</span>                 :             : </span>
<span id="L2667"><span class="lineNum">    2667</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (nIndex == -1) {</span></span>
<span id="L2668"><span class="lineNum">    2668</span>                 :<span class="tlaUNC">           0 :         CKeyPool keypool;</span></span>
<span id="L2669"><span class="lineNum">    2669</span>                 :<span class="tlaUNC">           0 :         int64_t index;</span></span>
<span id="L2670"><span class="lineNum">    2670</span>                 :<span class="tlaUNC">           0 :         auto op_address = m_spk_man-&gt;GetReservedDestination(type, internal, index, keypool);</span></span>
<span id="L2671"><span class="lineNum">    2671</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!op_address) return op_address;</span></span>
<span id="L2672"><span class="lineNum">    2672</span>                 :<span class="tlaUNC">           0 :         nIndex = index;</span></span>
<span id="L2673"><span class="lineNum">    2673</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         address = *op_address;</span></span>
<span id="L2674"><span class="lineNum">    2674</span>                 :<span class="tlaUNC">           0 :         fInternal = keypool.fInternal;</span></span>
<span id="L2675"><span class="lineNum">    2675</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L2676"><span class="lineNum">    2676</span>                 :<span class="tlaUNC">           0 :     return address;</span></span>
<span id="L2677"><span class="lineNum">    2677</span>                 :             : }</span>
<span id="L2678"><span class="lineNum">    2678</span>                 :             : </span>
<span id="L2679"><span class="lineNum">    2679</span>                 :<span class="tlaUNC">           0 : void ReserveDestination::KeepDestination()</span></span>
<span id="L2680"><span class="lineNum">    2680</span>                 :             : {</span>
<span id="L2681"><span class="lineNum">    2681</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (nIndex != -1) {</span></span>
<span id="L2682"><span class="lineNum">    2682</span>                 :<span class="tlaUNC">           0 :         m_spk_man-&gt;KeepDestination(nIndex, type);</span></span>
<span id="L2683"><span class="lineNum">    2683</span>                 :             :     }</span>
<span id="L2684"><span class="lineNum">    2684</span>                 :<span class="tlaUNC">           0 :     nIndex = -1;</span></span>
<span id="L2685"><span class="lineNum">    2685</span>                 :<span class="tlaUNC">           0 :     address = CNoDestination();</span></span>
<span id="L2686"><span class="lineNum">    2686</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L2687"><span class="lineNum">    2687</span>                 :             : </span>
<span id="L2688"><span class="lineNum">    2688</span>                 :<span class="tlaUNC">           0 : void ReserveDestination::ReturnDestination()</span></span>
<span id="L2689"><span class="lineNum">    2689</span>                 :             : {</span>
<span id="L2690"><span class="lineNum">    2690</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (nIndex != -1) {</span></span>
<span id="L2691"><span class="lineNum">    2691</span>                 :<span class="tlaUNC">           0 :         m_spk_man-&gt;ReturnDestination(nIndex, fInternal, address);</span></span>
<span id="L2692"><span class="lineNum">    2692</span>                 :             :     }</span>
<span id="L2693"><span class="lineNum">    2693</span>                 :<span class="tlaUNC">           0 :     nIndex = -1;</span></span>
<span id="L2694"><span class="lineNum">    2694</span>                 :<span class="tlaUNC">           0 :     address = CNoDestination();</span></span>
<span id="L2695"><span class="lineNum">    2695</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L2696"><span class="lineNum">    2696</span>                 :             : </span>
<span id="L2697"><span class="lineNum">    2697</span>                 :<span class="tlaUNC">           0 : util::Result&lt;void&gt; CWallet::DisplayAddress(const CTxDestination&amp; dest)</span></span>
<span id="L2698"><span class="lineNum">    2698</span>                 :             : {</span>
<span id="L2699"><span class="lineNum">    2699</span>                 :<span class="tlaUNC">           0 :     CScript scriptPubKey = GetScriptForDestination(dest);</span></span>
<span id="L2700"><span class="lineNum">    2700</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (const auto&amp; spk_man : GetScriptPubKeyMans(scriptPubKey)) {</span></span>
<span id="L2701"><span class="lineNum">    2701</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         auto signer_spk_man = dynamic_cast&lt;ExternalSignerScriptPubKeyMan *&gt;(spk_man);</span></span>
<span id="L2702"><span class="lineNum">    2702</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (signer_spk_man == nullptr) {</span></span>
<span id="L2703"><span class="lineNum">    2703</span>                 :<span class="tlaUNC">           0 :             continue;</span></span>
<span id="L2704"><span class="lineNum">    2704</span>                 :             :         }</span>
<span id="L2705"><span class="lineNum">    2705</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         ExternalSigner signer = ExternalSignerScriptPubKeyMan::GetExternalSigner();</span></span>
<span id="L2706"><span class="lineNum">    2706</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         return signer_spk_man-&gt;DisplayAddress(dest, signer);</span></span>
<span id="L2707"><span class="lineNum">    2707</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L2708"><span class="lineNum">    2708</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     return util::Error{_(&quot;There is no ScriptPubKeyManager for this address&quot;)};</span></span>
<span id="L2709"><span class="lineNum">    2709</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L2710"><span class="lineNum">    2710</span>                 :             : </span>
<span id="L2711"><span class="lineNum">    2711</span>                 :<span class="tlaUNC">           0 : bool CWallet::LockCoin(const COutPoint&amp; output, WalletBatch* batch)</span></span>
<span id="L2712"><span class="lineNum">    2712</span>                 :             : {</span>
<span id="L2713"><span class="lineNum">    2713</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L2714"><span class="lineNum">    2714</span>                 :<span class="tlaUNC">           0 :     setLockedCoins.insert(output);</span></span>
<span id="L2715"><span class="lineNum">    2715</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (batch) {</span></span>
<span id="L2716"><span class="lineNum">    2716</span>                 :<span class="tlaUNC">           0 :         return batch-&gt;WriteLockedUTXO(output);</span></span>
<span id="L2717"><span class="lineNum">    2717</span>                 :             :     }</span>
<span id="L2718"><span class="lineNum">    2718</span>                 :             :     return true;</span>
<span id="L2719"><span class="lineNum">    2719</span>                 :             : }</span>
<span id="L2720"><span class="lineNum">    2720</span>                 :             : </span>
<span id="L2721"><span class="lineNum">    2721</span>                 :<span class="tlaUNC">           0 : bool CWallet::UnlockCoin(const COutPoint&amp; output, WalletBatch* batch)</span></span>
<span id="L2722"><span class="lineNum">    2722</span>                 :             : {</span>
<span id="L2723"><span class="lineNum">    2723</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L2724"><span class="lineNum">    2724</span>                 :<span class="tlaUNC">           0 :     bool was_locked = setLockedCoins.erase(output);</span></span>
<span id="L2725"><span class="lineNum">    2725</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (batch &amp;&amp; was_locked) {</span></span>
<span id="L2726"><span class="lineNum">    2726</span>                 :<span class="tlaUNC">           0 :         return batch-&gt;EraseLockedUTXO(output);</span></span>
<span id="L2727"><span class="lineNum">    2727</span>                 :             :     }</span>
<span id="L2728"><span class="lineNum">    2728</span>                 :             :     return true;</span>
<span id="L2729"><span class="lineNum">    2729</span>                 :             : }</span>
<span id="L2730"><span class="lineNum">    2730</span>                 :             : </span>
<span id="L2731"><span class="lineNum">    2731</span>                 :<span class="tlaUNC">           0 : bool CWallet::UnlockAllCoins()</span></span>
<span id="L2732"><span class="lineNum">    2732</span>                 :             : {</span>
<span id="L2733"><span class="lineNum">    2733</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L2734"><span class="lineNum">    2734</span>                 :<span class="tlaUNC">           0 :     bool success = true;</span></span>
<span id="L2735"><span class="lineNum">    2735</span>                 :<span class="tlaUNC">           0 :     WalletBatch batch(GetDatabase());</span></span>
<span id="L2736"><span class="lineNum">    2736</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (auto it = setLockedCoins.begin(); it != setLockedCoins.end(); ++it) {</span></span>
<span id="L2737"><span class="lineNum">    2737</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         success &amp;= batch.EraseLockedUTXO(*it);</span></span>
<span id="L2738"><span class="lineNum">    2738</span>                 :             :     }</span>
<span id="L2739"><span class="lineNum">    2739</span>                 :<span class="tlaUNC">           0 :     setLockedCoins.clear();</span></span>
<span id="L2740"><span class="lineNum">    2740</span>                 :<span class="tlaUNC">           0 :     return success;</span></span>
<span id="L2741"><span class="lineNum">    2741</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L2742"><span class="lineNum">    2742</span>                 :             : </span>
<span id="L2743"><span class="lineNum">    2743</span>                 :<span class="tlaUNC">           0 : bool CWallet::IsLockedCoin(const COutPoint&amp; output) const</span></span>
<span id="L2744"><span class="lineNum">    2744</span>                 :             : {</span>
<span id="L2745"><span class="lineNum">    2745</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L2746"><span class="lineNum">    2746</span>                 :<span class="tlaUNC">           0 :     return setLockedCoins.count(output) &gt; 0;</span></span>
<span id="L2747"><span class="lineNum">    2747</span>                 :             : }</span>
<span id="L2748"><span class="lineNum">    2748</span>                 :             : </span>
<span id="L2749"><span class="lineNum">    2749</span>                 :<span class="tlaUNC">           0 : void CWallet::ListLockedCoins(std::vector&lt;COutPoint&gt;&amp; vOutpts) const</span></span>
<span id="L2750"><span class="lineNum">    2750</span>                 :             : {</span>
<span id="L2751"><span class="lineNum">    2751</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L2752"><span class="lineNum">    2752</span>                 :<span class="tlaUNC">           0 :     for (std::set&lt;COutPoint&gt;::iterator it = setLockedCoins.begin();</span></span>
<span id="L2753"><span class="lineNum">    2753</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :          it != setLockedCoins.end(); it++) {</span></span>
<span id="L2754"><span class="lineNum">    2754</span>                 :<span class="tlaUNC">           0 :         COutPoint outpt = (*it);</span></span>
<span id="L2755"><span class="lineNum">    2755</span>                 :<span class="tlaUNC">           0 :         vOutpts.push_back(outpt);</span></span>
<span id="L2756"><span class="lineNum">    2756</span>                 :             :     }</span>
<span id="L2757"><span class="lineNum">    2757</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L2758"><span class="lineNum">    2758</span>                 :             : </span>
<span id="L2759"><span class="lineNum">    2759</span>                 :             : /** @} */ // end of Actions</span>
<span id="L2760"><span class="lineNum">    2760</span>                 :             : </span>
<span id="L2761"><span class="lineNum">    2761</span>                 :<span class="tlaUNC">           0 : void CWallet::GetKeyBirthTimes(std::map&lt;CKeyID, int64_t&gt;&amp; mapKeyBirth) const {</span></span>
<span id="L2762"><span class="lineNum">    2762</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L2763"><span class="lineNum">    2763</span>                 :<span class="tlaUNC">           0 :     mapKeyBirth.clear();</span></span>
<span id="L2764"><span class="lineNum">    2764</span>                 :             : </span>
<span id="L2765"><span class="lineNum">    2765</span>                 :             :     // map in which we'll infer heights of other keys</span>
<span id="L2766"><span class="lineNum">    2766</span>                 :<span class="tlaUNC">           0 :     std::map&lt;CKeyID, const TxStateConfirmed*&gt; mapKeyFirstBlock;</span></span>
<span id="L2767"><span class="lineNum">    2767</span>                 :<span class="tlaUNC">           0 :     TxStateConfirmed max_confirm{uint256{}, /*height=*/-1, /*index=*/-1};</span></span>
<span id="L2768"><span class="lineNum">    2768</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     max_confirm.confirmed_block_height = GetLastBlockHeight() &gt; 144 ? GetLastBlockHeight() - 144 : 0; // the tip can be reorganized; use a 144-block safety margin</span></span>
<span id="L2769"><span class="lineNum">    2769</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     CHECK_NONFATAL(chain().findAncestorByHeight(GetLastBlockHash(), max_confirm.confirmed_block_height, FoundBlock().hash(max_confirm.confirmed_block_hash)));</span></span>
<span id="L2770"><span class="lineNum">    2770</span>                 :             : </span>
<span id="L2771"><span class="lineNum">    2771</span>                 :<span class="tlaUNC">           0 :     {</span></span>
<span id="L2772"><span class="lineNum">    2772</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LegacyScriptPubKeyMan* spk_man = GetLegacyScriptPubKeyMan();</span></span>
<span id="L2773"><span class="lineNum">    2773</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         assert(spk_man != nullptr);</span></span>
<span id="L2774"><span class="lineNum">    2774</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LOCK(spk_man-&gt;cs_KeyStore);</span></span>
<span id="L2775"><span class="lineNum">    2775</span>                 :             : </span>
<span id="L2776"><span class="lineNum">    2776</span>                 :             :         // get birth times for keys with metadata</span>
<span id="L2777"><span class="lineNum">    2777</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (const auto&amp; entry : spk_man-&gt;mapKeyMetadata) {</span></span>
<span id="L2778"><span class="lineNum">    2778</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (entry.second.nCreateTime) {</span></span>
<span id="L2779"><span class="lineNum">    2779</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 mapKeyBirth[entry.first] = entry.second.nCreateTime;</span></span>
<span id="L2780"><span class="lineNum">    2780</span>                 :             :             }</span>
<span id="L2781"><span class="lineNum">    2781</span>                 :             :         }</span>
<span id="L2782"><span class="lineNum">    2782</span>                 :             : </span>
<span id="L2783"><span class="lineNum">    2783</span>                 :             :         // Prepare to infer birth heights for keys without metadata</span>
<span id="L2784"><span class="lineNum">    2784</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (const CKeyID &amp;keyid : spk_man-&gt;GetKeys()) {</span></span>
<span id="L2785"><span class="lineNum">    2785</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (mapKeyBirth.count(keyid) == 0)</span></span>
<span id="L2786"><span class="lineNum">    2786</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 mapKeyFirstBlock[keyid] = &amp;max_confirm;</span></span>
<span id="L2787"><span class="lineNum">    2787</span>                 :<span class="tlaUNC">           0 :         }</span></span>
<span id="L2788"><span class="lineNum">    2788</span>                 :             : </span>
<span id="L2789"><span class="lineNum">    2789</span>                 :             :         // if there are no such keys, we're done</span>
<span id="L2790"><span class="lineNum">    2790</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (mapKeyFirstBlock.empty())</span></span>
<span id="L2791"><span class="lineNum">    2791</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             return;</span></span>
<span id="L2792"><span class="lineNum">    2792</span>                 :             : </span>
<span id="L2793"><span class="lineNum">    2793</span>                 :             :         // find first block that affects those keys, if there are any left</span>
<span id="L2794"><span class="lineNum">    2794</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (const auto&amp; entry : mapWallet) {</span></span>
<span id="L2795"><span class="lineNum">    2795</span>                 :             :             // iterate over all wallet transactions...</span>
<span id="L2796"><span class="lineNum">    2796</span>                 :<span class="tlaUNC">           0 :             const CWalletTx &amp;wtx = entry.second;</span></span>
<span id="L2797"><span class="lineNum">    2797</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (auto* conf = wtx.state&lt;TxStateConfirmed&gt;()) {</span></span>
<span id="L2798"><span class="lineNum">    2798</span>                 :             :                 // ... which are already in a block</span>
<span id="L2799"><span class="lineNum">    2799</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 for (const CTxOut &amp;txout : wtx.tx-&gt;vout) {</span></span>
<span id="L2800"><span class="lineNum">    2800</span>                 :             :                     // iterate over all their outputs</span>
<span id="L2801"><span class="lineNum">    2801</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     for (const auto &amp;keyid : GetAffectedKeys(txout.scriptPubKey, *spk_man)) {</span></span>
<span id="L2802"><span class="lineNum">    2802</span>                 :             :                         // ... and all their affected keys</span>
<span id="L2803"><span class="lineNum">    2803</span>                 :<span class="tlaUNC">           0 :                         auto rit = mapKeyFirstBlock.find(keyid);</span></span>
<span id="L2804"><span class="lineNum">    2804</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                         if (rit != mapKeyFirstBlock.end() &amp;&amp; conf-&gt;confirmed_block_height &lt; rit-&gt;second-&gt;confirmed_block_height) {</span></span>
<span id="L2805"><span class="lineNum">    2805</span>                 :<span class="tlaUNC">           0 :                             rit-&gt;second = conf;</span></span>
<span id="L2806"><span class="lineNum">    2806</span>                 :             :                         }</span>
<span id="L2807"><span class="lineNum">    2807</span>                 :<span class="tlaUNC">           0 :                     }</span></span>
<span id="L2808"><span class="lineNum">    2808</span>                 :             :                 }</span>
<span id="L2809"><span class="lineNum">    2809</span>                 :             :             }</span>
<span id="L2810"><span class="lineNum">    2810</span>                 :             :         }</span>
<span id="L2811"><span class="lineNum">    2811</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L2812"><span class="lineNum">    2812</span>                 :             : </span>
<span id="L2813"><span class="lineNum">    2813</span>                 :             :     // Extract block timestamps for those keys</span>
<span id="L2814"><span class="lineNum">    2814</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (const auto&amp; entry : mapKeyFirstBlock) {</span></span>
<span id="L2815"><span class="lineNum">    2815</span>                 :<span class="tlaUNC">           0 :         int64_t block_time;</span></span>
<span id="L2816"><span class="lineNum">    2816</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         CHECK_NONFATAL(chain().findBlock(entry.second-&gt;confirmed_block_hash, FoundBlock().time(block_time)));</span></span>
<span id="L2817"><span class="lineNum">    2817</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         mapKeyBirth[entry.first] = block_time - TIMESTAMP_WINDOW; // block times can be 2h off</span></span>
<span id="L2818"><span class="lineNum">    2818</span>                 :             :     }</span>
<span id="L2819"><span class="lineNum">    2819</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L2820"><span class="lineNum">    2820</span>                 :             : </span>
<span id="L2821"><span class="lineNum">    2821</span>                 :             : /**</span>
<span id="L2822"><span class="lineNum">    2822</span>                 :             :  * Compute smart timestamp for a transaction being added to the wallet.</span>
<span id="L2823"><span class="lineNum">    2823</span>                 :             :  *</span>
<span id="L2824"><span class="lineNum">    2824</span>                 :             :  * Logic:</span>
<span id="L2825"><span class="lineNum">    2825</span>                 :             :  * - If sending a transaction, assign its timestamp to the current time.</span>
<span id="L2826"><span class="lineNum">    2826</span>                 :             :  * - If receiving a transaction outside a block, assign its timestamp to the</span>
<span id="L2827"><span class="lineNum">    2827</span>                 :             :  *   current time.</span>
<span id="L2828"><span class="lineNum">    2828</span>                 :             :  * - If receiving a transaction during a rescanning process, assign all its</span>
<span id="L2829"><span class="lineNum">    2829</span>                 :             :  *   (not already known) transactions' timestamps to the block time.</span>
<span id="L2830"><span class="lineNum">    2830</span>                 :             :  * - If receiving a block with a future timestamp, assign all its (not already</span>
<span id="L2831"><span class="lineNum">    2831</span>                 :             :  *   known) transactions' timestamps to the current time.</span>
<span id="L2832"><span class="lineNum">    2832</span>                 :             :  * - If receiving a block with a past timestamp, before the most recent known</span>
<span id="L2833"><span class="lineNum">    2833</span>                 :             :  *   transaction (that we care about), assign all its (not already known)</span>
<span id="L2834"><span class="lineNum">    2834</span>                 :             :  *   transactions' timestamps to the same timestamp as that most-recent-known</span>
<span id="L2835"><span class="lineNum">    2835</span>                 :             :  *   transaction.</span>
<span id="L2836"><span class="lineNum">    2836</span>                 :             :  * - If receiving a block with a past timestamp, but after the most recent known</span>
<span id="L2837"><span class="lineNum">    2837</span>                 :             :  *   transaction, assign all its (not already known) transactions' timestamps to</span>
<span id="L2838"><span class="lineNum">    2838</span>                 :             :  *   the block time.</span>
<span id="L2839"><span class="lineNum">    2839</span>                 :             :  *</span>
<span id="L2840"><span class="lineNum">    2840</span>                 :             :  * For more information see CWalletTx::nTimeSmart,</span>
<span id="L2841"><span class="lineNum">    2841</span>                 :             :  * https://bitcointalk.org/?topic=54527, or</span>
<span id="L2842"><span class="lineNum">    2842</span>                 :             :  * https://github.com/bitcoin/bitcoin/pull/1393.</span>
<span id="L2843"><span class="lineNum">    2843</span>                 :             :  */</span>
<span id="L2844"><span class="lineNum">    2844</span>                 :<span class="tlaUNC">           0 : unsigned int CWallet::ComputeTimeSmart(const CWalletTx&amp; wtx, bool rescanning_old_block) const</span></span>
<span id="L2845"><span class="lineNum">    2845</span>                 :             : {</span>
<span id="L2846"><span class="lineNum">    2846</span>                 :<span class="tlaUNC">           0 :     std::optional&lt;uint256&gt; block_hash;</span></span>
<span id="L2847"><span class="lineNum">    2847</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (auto* conf = wtx.state&lt;TxStateConfirmed&gt;()) {</span></span>
<span id="L2848"><span class="lineNum">    2848</span>                 :<span class="tlaUNC">           0 :         block_hash = conf-&gt;confirmed_block_hash;</span></span>
<span id="L2849"><span class="lineNum">    2849</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     } else if (auto* conf = wtx.state&lt;TxStateBlockConflicted&gt;()) {</span></span>
<span id="L2850"><span class="lineNum">    2850</span>                 :<span class="tlaUNC">           0 :         block_hash = conf-&gt;conflicting_block_hash;</span></span>
<span id="L2851"><span class="lineNum">    2851</span>                 :             :     }</span>
<span id="L2852"><span class="lineNum">    2852</span>                 :             : </span>
<span id="L2853"><span class="lineNum">    2853</span>                 :<span class="tlaUNC">           0 :     unsigned int nTimeSmart = wtx.nTimeReceived;</span></span>
<span id="L2854"><span class="lineNum">    2854</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (block_hash) {</span></span>
<span id="L2855"><span class="lineNum">    2855</span>                 :<span class="tlaUNC">           0 :         int64_t blocktime;</span></span>
<span id="L2856"><span class="lineNum">    2856</span>                 :<span class="tlaUNC">           0 :         int64_t block_max_time;</span></span>
<span id="L2857"><span class="lineNum">    2857</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (chain().findBlock(*block_hash, FoundBlock().time(blocktime).maxTime(block_max_time))) {</span></span>
<span id="L2858"><span class="lineNum">    2858</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (rescanning_old_block) {</span></span>
<span id="L2859"><span class="lineNum">    2859</span>                 :<span class="tlaUNC">           0 :                 nTimeSmart = block_max_time;</span></span>
<span id="L2860"><span class="lineNum">    2860</span>                 :             :             } else {</span>
<span id="L2861"><span class="lineNum">    2861</span>                 :<span class="tlaUNC">           0 :                 int64_t latestNow = wtx.nTimeReceived;</span></span>
<span id="L2862"><span class="lineNum">    2862</span>                 :<span class="tlaUNC">           0 :                 int64_t latestEntry = 0;</span></span>
<span id="L2863"><span class="lineNum">    2863</span>                 :             : </span>
<span id="L2864"><span class="lineNum">    2864</span>                 :             :                 // Tolerate times up to the last timestamp in the wallet not more than 5 minutes into the future</span>
<span id="L2865"><span class="lineNum">    2865</span>                 :<span class="tlaUNC">           0 :                 int64_t latestTolerated = latestNow + 300;</span></span>
<span id="L2866"><span class="lineNum">    2866</span>                 :<span class="tlaUNC">           0 :                 const TxItems&amp; txOrdered = wtxOrdered;</span></span>
<span id="L2867"><span class="lineNum">    2867</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 for (auto it = txOrdered.rbegin(); it != txOrdered.rend(); ++it) {</span></span>
<span id="L2868"><span class="lineNum">    2868</span>                 :<span class="tlaUNC">           0 :                     CWalletTx* const pwtx = it-&gt;second;</span></span>
<span id="L2869"><span class="lineNum">    2869</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     if (pwtx == &amp;wtx) {</span></span>
<span id="L2870"><span class="lineNum">    2870</span>                 :<span class="tlaUNC">           0 :                         continue;</span></span>
<span id="L2871"><span class="lineNum">    2871</span>                 :             :                     }</span>
<span id="L2872"><span class="lineNum">    2872</span>                 :<span class="tlaUNC">           0 :                     int64_t nSmartTime;</span></span>
<span id="L2873"><span class="lineNum">    2873</span>                 :<span class="tlaUNC">           0 :                     nSmartTime = pwtx-&gt;nTimeSmart;</span></span>
<span id="L2874"><span class="lineNum">    2874</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     if (!nSmartTime) {</span></span>
<span id="L2875"><span class="lineNum">    2875</span>                 :<span class="tlaUNC">           0 :                         nSmartTime = pwtx-&gt;nTimeReceived;</span></span>
<span id="L2876"><span class="lineNum">    2876</span>                 :             :                     }</span>
<span id="L2877"><span class="lineNum">    2877</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     if (nSmartTime &lt;= latestTolerated) {</span></span>
<span id="L2878"><span class="lineNum">    2878</span>                 :<span class="tlaUNC">           0 :                         latestEntry = nSmartTime;</span></span>
<span id="L2879"><span class="lineNum">    2879</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                         if (nSmartTime &gt; latestNow) {</span></span>
<span id="L2880"><span class="lineNum">    2880</span>                 :<span class="tlaUNC">           0 :                             latestNow = nSmartTime;</span></span>
<span id="L2881"><span class="lineNum">    2881</span>                 :             :                         }</span>
<span id="L2882"><span class="lineNum">    2882</span>                 :             :                         break;</span>
<span id="L2883"><span class="lineNum">    2883</span>                 :             :                     }</span>
<span id="L2884"><span class="lineNum">    2884</span>                 :             :                 }</span>
<span id="L2885"><span class="lineNum">    2885</span>                 :             : </span>
<span id="L2886"><span class="lineNum">    2886</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 nTimeSmart = std::max(latestEntry, std::min(blocktime, latestNow));</span></span>
<span id="L2887"><span class="lineNum">    2887</span>                 :             :             }</span>
<span id="L2888"><span class="lineNum">    2888</span>                 :             :         } else {</span>
<span id="L2889"><span class="lineNum">    2889</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             WalletLogPrintf(&quot;%s: found %s in block %s not in index\n&quot;, __func__, wtx.GetHash().ToString(), block_hash-&gt;ToString());</span></span>
<span id="L2890"><span class="lineNum">    2890</span>                 :             :         }</span>
<span id="L2891"><span class="lineNum">    2891</span>                 :             :     }</span>
<span id="L2892"><span class="lineNum">    2892</span>                 :<span class="tlaUNC">           0 :     return nTimeSmart;</span></span>
<span id="L2893"><span class="lineNum">    2893</span>                 :             : }</span>
<span id="L2894"><span class="lineNum">    2894</span>                 :             : </span>
<span id="L2895"><span class="lineNum">    2895</span>                 :<span class="tlaUNC">           0 : bool CWallet::SetAddressPreviouslySpent(WalletBatch&amp; batch, const CTxDestination&amp; dest, bool used)</span></span>
<span id="L2896"><span class="lineNum">    2896</span>                 :             : {</span>
<span id="L2897"><span class="lineNum">    2897</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (std::get_if&lt;CNoDestination&gt;(&amp;dest))</span></span>
<span id="L2898"><span class="lineNum">    2898</span>                 :             :         return false;</span>
<span id="L2899"><span class="lineNum">    2899</span>                 :             : </span>
<span id="L2900"><span class="lineNum">    2900</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!used) {</span></span>
<span id="L2901"><span class="lineNum">    2901</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (auto* data{common::FindKey(m_address_book, dest)}) data-&gt;previously_spent = false;</span></span>
<span id="L2902"><span class="lineNum">    2902</span>                 :<span class="tlaUNC">           0 :         return batch.WriteAddressPreviouslySpent(dest, false);</span></span>
<span id="L2903"><span class="lineNum">    2903</span>                 :             :     }</span>
<span id="L2904"><span class="lineNum">    2904</span>                 :             : </span>
<span id="L2905"><span class="lineNum">    2905</span>                 :<span class="tlaUNC">           0 :     LoadAddressPreviouslySpent(dest);</span></span>
<span id="L2906"><span class="lineNum">    2906</span>                 :<span class="tlaUNC">           0 :     return batch.WriteAddressPreviouslySpent(dest, true);</span></span>
<span id="L2907"><span class="lineNum">    2907</span>                 :             : }</span>
<span id="L2908"><span class="lineNum">    2908</span>                 :             : </span>
<span id="L2909"><span class="lineNum">    2909</span>                 :<span class="tlaUNC">           0 : void CWallet::LoadAddressPreviouslySpent(const CTxDestination&amp; dest)</span></span>
<span id="L2910"><span class="lineNum">    2910</span>                 :             : {</span>
<span id="L2911"><span class="lineNum">    2911</span>                 :<span class="tlaUNC">           0 :     m_address_book[dest].previously_spent = true;</span></span>
<span id="L2912"><span class="lineNum">    2912</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L2913"><span class="lineNum">    2913</span>                 :             : </span>
<span id="L2914"><span class="lineNum">    2914</span>                 :<span class="tlaUNC">           0 : void CWallet::LoadAddressReceiveRequest(const CTxDestination&amp; dest, const std::string&amp; id, const std::string&amp; request)</span></span>
<span id="L2915"><span class="lineNum">    2915</span>                 :             : {</span>
<span id="L2916"><span class="lineNum">    2916</span>                 :<span class="tlaUNC">           0 :     m_address_book[dest].receive_requests[id] = request;</span></span>
<span id="L2917"><span class="lineNum">    2917</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L2918"><span class="lineNum">    2918</span>                 :             : </span>
<span id="L2919"><span class="lineNum">    2919</span>                 :<span class="tlaUNC">           0 : bool CWallet::IsAddressPreviouslySpent(const CTxDestination&amp; dest) const</span></span>
<span id="L2920"><span class="lineNum">    2920</span>                 :             : {</span>
<span id="L2921"><span class="lineNum">    2921</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (auto* data{common::FindKey(m_address_book, dest)}) return data-&gt;previously_spent;</span></span>
<span id="L2922"><span class="lineNum">    2922</span>                 :             :     return false;</span>
<span id="L2923"><span class="lineNum">    2923</span>                 :             : }</span>
<span id="L2924"><span class="lineNum">    2924</span>                 :             : </span>
<span id="L2925"><span class="lineNum">    2925</span>                 :<span class="tlaUNC">           0 : std::vector&lt;std::string&gt; CWallet::GetAddressReceiveRequests() const</span></span>
<span id="L2926"><span class="lineNum">    2926</span>                 :             : {</span>
<span id="L2927"><span class="lineNum">    2927</span>                 :<span class="tlaUNC">           0 :     std::vector&lt;std::string&gt; values;</span></span>
<span id="L2928"><span class="lineNum">    2928</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (const auto&amp; [dest, entry] : m_address_book) {</span></span>
<span id="L2929"><span class="lineNum">    2929</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (const auto&amp; [id, request] : entry.receive_requests) {</span></span>
<span id="L2930"><span class="lineNum">    2930</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             values.emplace_back(request);</span></span>
<span id="L2931"><span class="lineNum">    2931</span>                 :             :         }</span>
<span id="L2932"><span class="lineNum">    2932</span>                 :             :     }</span>
<span id="L2933"><span class="lineNum">    2933</span>                 :<span class="tlaUNC">           0 :     return values;</span></span>
<span id="L2934"><span class="lineNum">    2934</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L2935"><span class="lineNum">    2935</span>                 :             : </span>
<span id="L2936"><span class="lineNum">    2936</span>                 :<span class="tlaUNC">           0 : bool CWallet::SetAddressReceiveRequest(WalletBatch&amp; batch, const CTxDestination&amp; dest, const std::string&amp; id, const std::string&amp; value)</span></span>
<span id="L2937"><span class="lineNum">    2937</span>                 :             : {</span>
<span id="L2938"><span class="lineNum">    2938</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!batch.WriteAddressReceiveRequest(dest, id, value)) return false;</span></span>
<span id="L2939"><span class="lineNum">    2939</span>                 :<span class="tlaUNC">           0 :     m_address_book[dest].receive_requests[id] = value;</span></span>
<span id="L2940"><span class="lineNum">    2940</span>                 :<span class="tlaUNC">           0 :     return true;</span></span>
<span id="L2941"><span class="lineNum">    2941</span>                 :             : }</span>
<span id="L2942"><span class="lineNum">    2942</span>                 :             : </span>
<span id="L2943"><span class="lineNum">    2943</span>                 :<span class="tlaUNC">           0 : bool CWallet::EraseAddressReceiveRequest(WalletBatch&amp; batch, const CTxDestination&amp; dest, const std::string&amp; id)</span></span>
<span id="L2944"><span class="lineNum">    2944</span>                 :             : {</span>
<span id="L2945"><span class="lineNum">    2945</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!batch.EraseAddressReceiveRequest(dest, id)) return false;</span></span>
<span id="L2946"><span class="lineNum">    2946</span>                 :<span class="tlaUNC">           0 :     m_address_book[dest].receive_requests.erase(id);</span></span>
<span id="L2947"><span class="lineNum">    2947</span>                 :<span class="tlaUNC">           0 :     return true;</span></span>
<span id="L2948"><span class="lineNum">    2948</span>                 :             : }</span>
<span id="L2949"><span class="lineNum">    2949</span>                 :             : </span>
<span id="L2950"><span class="lineNum">    2950</span>                 :<span class="tlaUNC">           0 : static util::Result&lt;fs::path&gt; GetWalletPath(const std::string&amp; name)</span></span>
<span id="L2951"><span class="lineNum">    2951</span>                 :             : {</span>
<span id="L2952"><span class="lineNum">    2952</span>                 :             :     // Do some checking on wallet path. It should be either a:</span>
<span id="L2953"><span class="lineNum">    2953</span>                 :             :     //</span>
<span id="L2954"><span class="lineNum">    2954</span>                 :             :     // 1. Path where a directory can be created.</span>
<span id="L2955"><span class="lineNum">    2955</span>                 :             :     // 2. Path to an existing directory.</span>
<span id="L2956"><span class="lineNum">    2956</span>                 :             :     // 3. Path to a symlink to a directory.</span>
<span id="L2957"><span class="lineNum">    2957</span>                 :             :     // 4. For backwards compatibility, the name of a data file in -walletdir.</span>
<span id="L2958"><span class="lineNum">    2958</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     const fs::path wallet_path = fsbridge::AbsPathJoin(GetWalletDir(), fs::PathFromString(name));</span></span>
<span id="L2959"><span class="lineNum">    2959</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     fs::file_type path_type = fs::symlink_status(wallet_path).type();</span></span>
<span id="L2960"><span class="lineNum">    2960</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     if (!(path_type == fs::file_type::not_found || path_type == fs::file_type::directory ||</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L2961"><span class="lineNum">    2961</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :           (path_type == fs::file_type::symlink &amp;&amp; fs::is_directory(wallet_path)) ||</span></span>
<span id="L2962"><span class="lineNum">    2962</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :           (path_type == fs::file_type::regular &amp;&amp; fs::PathFromString(name).filename() == fs::PathFromString(name)))) {</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 9 was not executed"> # </span><span class="tlaUNC" title="Branch 10 was not executed"> # </span><span class="tlaUNC" title="Branch 11 was not executed"> # </span><span class="tlaUNC" title="Branch 12 was not executed"> # </span><span class="tlaUNC" title="Branch 13 was not executed"> # </span> 
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 14 was not executed"> # </span><span class="tlaUNC" title="Branch 15 was not executed"> # </span>]
<span id="L2963"><span class="lineNum">    2963</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         return util::Error{Untranslated(strprintf(</span></span>
<span id="L2964"><span class="lineNum">    2964</span>                 :             :               &quot;Invalid -wallet path '%s'. -wallet path should point to a directory where wallet.dat and &quot;</span>
<span id="L2965"><span class="lineNum">    2965</span>                 :             :               &quot;database/log.?????????? files can be stored, a location where such a directory could be created, &quot;</span>
<span id="L2966"><span class="lineNum">    2966</span>                 :             :               &quot;or (for backwards compatibility) the name of an existing data file in -walletdir (%s)&quot;,</span>
<span id="L2967"><span class="lineNum">    2967</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :               name, fs::quoted(fs::PathToString(GetWalletDir()))))};</span></span>
<span id="L2968"><span class="lineNum">    2968</span>                 :             :     }</span>
<span id="L2969"><span class="lineNum">    2969</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     return wallet_path;</span></span>
<span id="L2970"><span class="lineNum">    2970</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L2971"><span class="lineNum">    2971</span>                 :             : </span>
<span id="L2972"><span class="lineNum">    2972</span>                 :<span class="tlaUNC">           0 : std::unique_ptr&lt;WalletDatabase&gt; MakeWalletDatabase(const std::string&amp; name, const DatabaseOptions&amp; options, DatabaseStatus&amp; status, bilingual_str&amp; error_string)</span></span>
<span id="L2973"><span class="lineNum">    2973</span>                 :             : {</span>
<span id="L2974"><span class="lineNum">    2974</span>                 :<span class="tlaUNC">           0 :     const auto&amp; wallet_path = GetWalletPath(name);</span></span>
<span id="L2975"><span class="lineNum">    2975</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!wallet_path) {</span></span>
<span id="L2976"><span class="lineNum">    2976</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         error_string = util::ErrorString(wallet_path);</span></span>
<span id="L2977"><span class="lineNum">    2977</span>                 :<span class="tlaUNC">           0 :         status = DatabaseStatus::FAILED_BAD_PATH;</span></span>
<span id="L2978"><span class="lineNum">    2978</span>                 :<span class="tlaUNC">           0 :         return nullptr;</span></span>
<span id="L2979"><span class="lineNum">    2979</span>                 :             :     }</span>
<span id="L2980"><span class="lineNum">    2980</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     return MakeDatabase(*wallet_path, options, status, error_string);</span></span>
<span id="L2981"><span class="lineNum">    2981</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L2982"><span class="lineNum">    2982</span>                 :             : </span>
<span id="L2983"><span class="lineNum">    2983</span>                 :<span class="tlaUNC">           0 : std::shared_ptr&lt;CWallet&gt; CWallet::Create(WalletContext&amp; context, const std::string&amp; name, std::unique_ptr&lt;WalletDatabase&gt; database, uint64_t wallet_creation_flags, bilingual_str&amp; error, std::vector&lt;bilingual_str&gt;&amp; warnings)</span></span>
<span id="L2984"><span class="lineNum">    2984</span>                 :             : {</span>
<span id="L2985"><span class="lineNum">    2985</span>                 :<span class="tlaUNC">           0 :     interfaces::Chain* chain = context.chain;</span></span>
<span id="L2986"><span class="lineNum">    2986</span>                 :<span class="tlaUNC">           0 :     ArgsManager&amp; args = *Assert(context.args);</span></span>
<span id="L2987"><span class="lineNum">    2987</span>                 :<span class="tlaUNC">           0 :     const std::string&amp; walletFile = database-&gt;Filename();</span></span>
<span id="L2988"><span class="lineNum">    2988</span>                 :             : </span>
<span id="L2989"><span class="lineNum">    2989</span>                 :<span class="tlaUNC">           0 :     const auto start{SteadyClock::now()};</span></span>
<span id="L2990"><span class="lineNum">    2990</span>                 :             :     // TODO: Can't use std::make_shared because we need a custom deleter but</span>
<span id="L2991"><span class="lineNum">    2991</span>                 :             :     // should be possible to use std::allocate_shared.</span>
<span id="L2992"><span class="lineNum">    2992</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     std::shared_ptr&lt;CWallet&gt; walletInstance(new CWallet(chain, name, std::move(database)), FlushAndDeleteWallet);</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L2993"><span class="lineNum">    2993</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     walletInstance-&gt;m_keypool_size = std::max(args.GetIntArg(&quot;-keypool&quot;, DEFAULT_KEYPOOL_SIZE), int64_t{1});</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L2994"><span class="lineNum">    2994</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     walletInstance-&gt;m_notify_tx_changed_script = args.GetArg(&quot;-walletnotify&quot;, &quot;&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L2995"><span class="lineNum">    2995</span>                 :             : </span>
<span id="L2996"><span class="lineNum">    2996</span>                 :             :     // Load wallet</span>
<span id="L2997"><span class="lineNum">    2997</span>                 :<span class="tlaUNC">           0 :     bool rescan_required = false;</span></span>
<span id="L2998"><span class="lineNum">    2998</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     DBErrors nLoadWalletRet = walletInstance-&gt;LoadWallet();</span></span>
<span id="L2999"><span class="lineNum">    2999</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     if (nLoadWalletRet != DBErrors::LOAD_OK) {</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not executed"> # </span>]
<span id="L3000"><span class="lineNum">    3000</span>                 :             :         if (nLoadWalletRet == DBErrors::CORRUPT) {</span>
<span id="L3001"><span class="lineNum">    3001</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             error = strprintf(_(&quot;Error loading %s: Wallet corrupted&quot;), walletFile);</span></span>
<span id="L3002"><span class="lineNum">    3002</span>                 :<span class="tlaUNC">           0 :             return nullptr;</span></span>
<span id="L3003"><span class="lineNum">    3003</span>                 :             :         }</span>
<span id="L3004"><span class="lineNum">    3004</span>                 :             :         else if (nLoadWalletRet == DBErrors::NONCRITICAL_ERROR)</span>
<span id="L3005"><span class="lineNum">    3005</span>                 :             :         {</span>
<span id="L3006"><span class="lineNum">    3006</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             warnings.push_back(strprintf(_(&quot;Error reading %s! All keys read correctly, but transaction data&quot;</span></span>
<span id="L3007"><span class="lineNum">    3007</span>                 :             :                                            &quot; or address metadata may be missing or incorrect.&quot;),</span>
<span id="L3008"><span class="lineNum">    3008</span>                 :             :                 walletFile));</span>
<span id="L3009"><span class="lineNum">    3009</span>                 :             :         }</span>
<span id="L3010"><span class="lineNum">    3010</span>                 :             :         else if (nLoadWalletRet == DBErrors::TOO_NEW) {</span>
<span id="L3011"><span class="lineNum">    3011</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             error = strprintf(_(&quot;Error loading %s: Wallet requires newer version of %s&quot;), walletFile, CLIENT_NAME);</span></span>
<span id="L3012"><span class="lineNum">    3012</span>                 :<span class="tlaUNC">           0 :             return nullptr;</span></span>
<span id="L3013"><span class="lineNum">    3013</span>                 :             :         }</span>
<span id="L3014"><span class="lineNum">    3014</span>                 :             :         else if (nLoadWalletRet == DBErrors::EXTERNAL_SIGNER_SUPPORT_REQUIRED) {</span>
<span id="L3015"><span class="lineNum">    3015</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             error = strprintf(_(&quot;Error loading %s: External signer wallet being loaded without external signer support compiled&quot;), walletFile);</span></span>
<span id="L3016"><span class="lineNum">    3016</span>                 :<span class="tlaUNC">           0 :             return nullptr;</span></span>
<span id="L3017"><span class="lineNum">    3017</span>                 :             :         }</span>
<span id="L3018"><span class="lineNum">    3018</span>                 :             :         else if (nLoadWalletRet == DBErrors::NEED_REWRITE)</span>
<span id="L3019"><span class="lineNum">    3019</span>                 :             :         {</span>
<span id="L3020"><span class="lineNum">    3020</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             error = strprintf(_(&quot;Wallet needed to be rewritten: restart %s to complete&quot;), CLIENT_NAME);</span></span>
<span id="L3021"><span class="lineNum">    3021</span>                 :<span class="tlaUNC">           0 :             return nullptr;</span></span>
<span id="L3022"><span class="lineNum">    3022</span>                 :             :         } else if (nLoadWalletRet == DBErrors::NEED_RESCAN) {</span>
<span id="L3023"><span class="lineNum">    3023</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             warnings.push_back(strprintf(_(&quot;Error reading %s! Transaction data may be missing or incorrect.&quot;</span></span>
<span id="L3024"><span class="lineNum">    3024</span>                 :             :                                            &quot; Rescanning wallet.&quot;), walletFile));</span>
<span id="L3025"><span class="lineNum">    3025</span>                 :<span class="tlaUNC">           0 :             rescan_required = true;</span></span>
<span id="L3026"><span class="lineNum">    3026</span>                 :             :         } else if (nLoadWalletRet == DBErrors::UNKNOWN_DESCRIPTOR) {</span>
<span id="L3027"><span class="lineNum">    3027</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             error = strprintf(_(&quot;Unrecognized descriptor found. Loading wallet %s\n\n&quot;</span></span>
<span id="L3028"><span class="lineNum">    3028</span>                 :             :                                 &quot;The wallet might had been created on a newer version.\n&quot;</span>
<span id="L3029"><span class="lineNum">    3029</span>                 :<span class="tlaUNC">           0 :                                 &quot;Please try running the latest software version.\n&quot;), walletFile);</span></span>
<span id="L3030"><span class="lineNum">    3030</span>                 :<span class="tlaUNC">           0 :             return nullptr;</span></span>
<span id="L3031"><span class="lineNum">    3031</span>                 :             :         } else if (nLoadWalletRet == DBErrors::UNEXPECTED_LEGACY_ENTRY) {</span>
<span id="L3032"><span class="lineNum">    3032</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             error = strprintf(_(&quot;Unexpected legacy entry in descriptor wallet found. Loading wallet %s\n\n&quot;</span></span>
<span id="L3033"><span class="lineNum">    3033</span>                 :<span class="tlaUNC">           0 :                                 &quot;The wallet might have been tampered with or created with malicious intent.\n&quot;), walletFile);</span></span>
<span id="L3034"><span class="lineNum">    3034</span>                 :<span class="tlaUNC">           0 :             return nullptr;</span></span>
<span id="L3035"><span class="lineNum">    3035</span>                 :             :         } else {</span>
<span id="L3036"><span class="lineNum">    3036</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             error = strprintf(_(&quot;Error loading %s&quot;), walletFile);</span></span>
<span id="L3037"><span class="lineNum">    3037</span>                 :<span class="tlaUNC">           0 :             return nullptr;</span></span>
<span id="L3038"><span class="lineNum">    3038</span>                 :             :         }</span>
<span id="L3039"><span class="lineNum">    3039</span>                 :             :     }</span>
<span id="L3040"><span class="lineNum">    3040</span>                 :             : </span>
<span id="L3041"><span class="lineNum">    3041</span>                 :             :     // This wallet is in its first run if there are no ScriptPubKeyMans and it isn't blank or no privkeys</span>
<span id="L3042"><span class="lineNum">    3042</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     const bool fFirstRun = walletInstance-&gt;m_spk_managers.empty() &amp;&amp;</span></span>
<span id="L3043"><span class="lineNum">    3043</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                      !walletInstance-&gt;IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS) &amp;&amp;</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L3044"><span class="lineNum">    3044</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                      !walletInstance-&gt;IsWalletFlagSet(WALLET_FLAG_BLANK_WALLET);</span></span>
<span id="L3045"><span class="lineNum">    3045</span>                 :<span class="tlaUNC">           0 :     if (fFirstRun)</span></span>
<span id="L3046"><span class="lineNum">    3046</span>                 :             :     {</span>
<span id="L3047"><span class="lineNum">    3047</span>                 :             :         // ensure this wallet.dat can only be opened by clients supporting HD with chain split and expects no default key</span>
<span id="L3048"><span class="lineNum">    3048</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         walletInstance-&gt;SetMinVersion(FEATURE_LATEST);</span></span>
<span id="L3049"><span class="lineNum">    3049</span>                 :             : </span>
<span id="L3050"><span class="lineNum">    3050</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         walletInstance-&gt;InitWalletFlags(wallet_creation_flags);</span></span>
<span id="L3051"><span class="lineNum">    3051</span>                 :             : </span>
<span id="L3052"><span class="lineNum">    3052</span>                 :             :         // Only create LegacyScriptPubKeyMan when not descriptor wallet</span>
<span id="L3053"><span class="lineNum">    3053</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!walletInstance-&gt;IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {</span></span>
<span id="L3054"><span class="lineNum">    3054</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             walletInstance-&gt;SetupLegacyScriptPubKeyMan();</span></span>
<span id="L3055"><span class="lineNum">    3055</span>                 :             :         }</span>
<span id="L3056"><span class="lineNum">    3056</span>                 :             : </span>
<span id="L3057"><span class="lineNum">    3057</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if ((wallet_creation_flags &amp; WALLET_FLAG_EXTERNAL_SIGNER) || !(wallet_creation_flags &amp; (WALLET_FLAG_DISABLE_PRIVATE_KEYS | WALLET_FLAG_BLANK_WALLET))) {</span></span>
<span id="L3058"><span class="lineNum">    3058</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             LOCK(walletInstance-&gt;cs_wallet);</span></span>
<span id="L3059"><span class="lineNum">    3059</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (walletInstance-&gt;IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {</span></span>
<span id="L3060"><span class="lineNum">    3060</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 walletInstance-&gt;SetupDescriptorScriptPubKeyMans();</span></span>
<span id="L3061"><span class="lineNum">    3061</span>                 :             :                 // SetupDescriptorScriptPubKeyMans already calls SetupGeneration for us so we don't need to call SetupGeneration separately</span>
<span id="L3062"><span class="lineNum">    3062</span>                 :             :             } else {</span>
<span id="L3063"><span class="lineNum">    3063</span>                 :             :                 // Legacy wallets need SetupGeneration here.</span>
<span id="L3064"><span class="lineNum">    3064</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 for (auto spk_man : walletInstance-&gt;GetActiveScriptPubKeyMans()) {</span></span>
<span id="L3065"><span class="lineNum">    3065</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     if (!spk_man-&gt;SetupGeneration()) {</span></span>
<span id="L3066"><span class="lineNum">    3066</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                         error = _(&quot;Unable to generate initial keys&quot;);</span></span>
<span id="L3067"><span class="lineNum">    3067</span>                 :<span class="tlaUNC">           0 :                         return nullptr;</span></span>
<span id="L3068"><span class="lineNum">    3068</span>                 :             :                     }</span>
<span id="L3069"><span class="lineNum">    3069</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 }</span></span>
<span id="L3070"><span class="lineNum">    3070</span>                 :             :             }</span>
<span id="L3071"><span class="lineNum">    3071</span>                 :<span class="tlaUNC">           0 :         }</span></span>
<span id="L3072"><span class="lineNum">    3072</span>                 :             : </span>
<span id="L3073"><span class="lineNum">    3073</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (chain) {</span></span>
<span id="L3074"><span class="lineNum">    3074</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             walletInstance-&gt;chainStateFlushed(ChainstateRole::NORMAL, chain-&gt;getTipLocator());</span></span>
<span id="L3075"><span class="lineNum">    3075</span>                 :             :         }</span>
<span id="L3076"><span class="lineNum">    3076</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     } else if (wallet_creation_flags &amp; WALLET_FLAG_DISABLE_PRIVATE_KEYS) {</span></span>
<span id="L3077"><span class="lineNum">    3077</span>                 :             :         // Make it impossible to disable private keys after creation</span>
<span id="L3078"><span class="lineNum">    3078</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         error = strprintf(_(&quot;Error loading %s: Private keys can only be disabled during creation&quot;), walletFile);</span></span>
<span id="L3079"><span class="lineNum">    3079</span>                 :<span class="tlaUNC">           0 :         return nullptr;</span></span>
<span id="L3080"><span class="lineNum">    3080</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     } else if (walletInstance-&gt;IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS)) {</span></span>
<span id="L3081"><span class="lineNum">    3081</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (auto spk_man : walletInstance-&gt;GetActiveScriptPubKeyMans()) {</span></span>
<span id="L3082"><span class="lineNum">    3082</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (spk_man-&gt;HavePrivateKeys()) {</span></span>
<span id="L3083"><span class="lineNum">    3083</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 warnings.push_back(strprintf(_(&quot;Warning: Private keys detected in wallet {%s} with disabled private keys&quot;), walletFile));</span></span>
<span id="L3084"><span class="lineNum">    3084</span>                 :<span class="tlaUNC">           0 :                 break;</span></span>
<span id="L3085"><span class="lineNum">    3085</span>                 :             :             }</span>
<span id="L3086"><span class="lineNum">    3086</span>                 :<span class="tlaUNC">           0 :         }</span></span>
<span id="L3087"><span class="lineNum">    3087</span>                 :             :     }</span>
<span id="L3088"><span class="lineNum">    3088</span>                 :             : </span>
<span id="L3089"><span class="lineNum">    3089</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     if (!args.GetArg(&quot;-addresstype&quot;, &quot;&quot;).empty()) {</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L3090"><span class="lineNum">    3090</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         std::optional&lt;OutputType&gt; parsed = ParseOutputType(args.GetArg(&quot;-addresstype&quot;, &quot;&quot;));</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L3091"><span class="lineNum">    3091</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!parsed) {</span></span>
<span id="L3092"><span class="lineNum">    3092</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             error = strprintf(_(&quot;Unknown address type '%s'&quot;), args.GetArg(&quot;-addresstype&quot;, &quot;&quot;));</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not executed"> # </span>]
<span id="L3093"><span class="lineNum">    3093</span>                 :<span class="tlaUNC">           0 :             return nullptr;</span></span>
<span id="L3094"><span class="lineNum">    3094</span>                 :             :         }</span>
<span id="L3095"><span class="lineNum">    3095</span>                 :<span class="tlaUNC">           0 :         walletInstance-&gt;m_default_address_type = parsed.value();</span></span>
<span id="L3096"><span class="lineNum">    3096</span>                 :             :     }</span>
<span id="L3097"><span class="lineNum">    3097</span>                 :             : </span>
<span id="L3098"><span class="lineNum">    3098</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     if (!args.GetArg(&quot;-changetype&quot;, &quot;&quot;).empty()) {</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L3099"><span class="lineNum">    3099</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         std::optional&lt;OutputType&gt; parsed = ParseOutputType(args.GetArg(&quot;-changetype&quot;, &quot;&quot;));</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L3100"><span class="lineNum">    3100</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!parsed) {</span></span>
<span id="L3101"><span class="lineNum">    3101</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             error = strprintf(_(&quot;Unknown change type '%s'&quot;), args.GetArg(&quot;-changetype&quot;, &quot;&quot;));</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not executed"> # </span>]
<span id="L3102"><span class="lineNum">    3102</span>                 :<span class="tlaUNC">           0 :             return nullptr;</span></span>
<span id="L3103"><span class="lineNum">    3103</span>                 :             :         }</span>
<span id="L3104"><span class="lineNum">    3104</span>                 :<span class="tlaUNC">           0 :         walletInstance-&gt;m_default_change_type = parsed.value();</span></span>
<span id="L3105"><span class="lineNum">    3105</span>                 :             :     }</span>
<span id="L3106"><span class="lineNum">    3106</span>                 :             : </span>
<span id="L3107"><span class="lineNum">    3107</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     if (args.IsArgSet(&quot;-mintxfee&quot;)) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L3108"><span class="lineNum">    3108</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         std::optional&lt;CAmount&gt; min_tx_fee = ParseMoney(args.GetArg(&quot;-mintxfee&quot;, &quot;&quot;));</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L3109"><span class="lineNum">    3109</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!min_tx_fee) {</span></span>
<span id="L3110"><span class="lineNum">    3110</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             error = AmountErrMsg(&quot;mintxfee&quot;, args.GetArg(&quot;-mintxfee&quot;, &quot;&quot;));</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not executed"> # </span>]
<span id="L3111"><span class="lineNum">    3111</span>                 :<span class="tlaUNC">           0 :             return nullptr;</span></span>
<span id="L3112"><span class="lineNum">    3112</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         } else if (min_tx_fee.value() &gt; HIGH_TX_FEE_PER_KB) {</span></span>
<span id="L3113"><span class="lineNum">    3113</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             warnings.push_back(AmountHighWarn(&quot;-mintxfee&quot;) + Untranslated(&quot; &quot;) +</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not executed"> # </span>]
<span id="L3114"><span class="lineNum">    3114</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                                _(&quot;This is the minimum transaction fee you pay on every transaction.&quot;));</span></span>
<span id="L3115"><span class="lineNum">    3115</span>                 :             :         }</span>
<span id="L3116"><span class="lineNum">    3116</span>                 :             : </span>
<span id="L3117"><span class="lineNum">    3117</span>                 :<span class="tlaUNC">           0 :         walletInstance-&gt;m_min_fee = CFeeRate{min_tx_fee.value()};</span></span>
<span id="L3118"><span class="lineNum">    3118</span>                 :             :     }</span>
<span id="L3119"><span class="lineNum">    3119</span>                 :             : </span>
<span id="L3120"><span class="lineNum">    3120</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     if (args.IsArgSet(&quot;-maxapsfee&quot;)) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L3121"><span class="lineNum">    3121</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         const std::string max_aps_fee{args.GetArg(&quot;-maxapsfee&quot;, &quot;&quot;)};</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L3122"><span class="lineNum">    3122</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (max_aps_fee == &quot;-1&quot;) {</span></span>
<span id="L3123"><span class="lineNum">    3123</span>                 :<span class="tlaUNC">           0 :             walletInstance-&gt;m_max_aps_fee = -1;</span></span>
<span id="L3124"><span class="lineNum">    3124</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         } else if (std::optional&lt;CAmount&gt; max_fee = ParseMoney(max_aps_fee)) {</span></span>
<span id="L3125"><span class="lineNum">    3125</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (max_fee.value() &gt; HIGH_APS_FEE) {</span></span>
<span id="L3126"><span class="lineNum">    3126</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                 warnings.push_back(AmountHighWarn(&quot;-maxapsfee&quot;) + Untranslated(&quot; &quot;) +</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not executed"> # </span>]
<span id="L3127"><span class="lineNum">    3127</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                                   _(&quot;This is the maximum transaction fee you pay (in addition to the normal fee) to prioritize partial spend avoidance over regular coin selection.&quot;));</span></span>
<span id="L3128"><span class="lineNum">    3128</span>                 :             :             }</span>
<span id="L3129"><span class="lineNum">    3129</span>                 :<span class="tlaUNC">           0 :             walletInstance-&gt;m_max_aps_fee = max_fee.value();</span></span>
<span id="L3130"><span class="lineNum">    3130</span>                 :             :         } else {</span>
<span id="L3131"><span class="lineNum">    3131</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             error = AmountErrMsg(&quot;maxapsfee&quot;, max_aps_fee);</span></span>
<span id="L3132"><span class="lineNum">    3132</span>                 :<span class="tlaUNC">           0 :             return nullptr;</span></span>
<span id="L3133"><span class="lineNum">    3133</span>                 :             :         }</span>
<span id="L3134"><span class="lineNum">    3134</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L3135"><span class="lineNum">    3135</span>                 :             : </span>
<span id="L3136"><span class="lineNum">    3136</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     if (args.IsArgSet(&quot;-fallbackfee&quot;)) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L3137"><span class="lineNum">    3137</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         std::optional&lt;CAmount&gt; fallback_fee = ParseMoney(args.GetArg(&quot;-fallbackfee&quot;, &quot;&quot;));</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L3138"><span class="lineNum">    3138</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!fallback_fee) {</span></span>
<span id="L3139"><span class="lineNum">    3139</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             error = strprintf(_(&quot;Invalid amount for %s=&lt;amount&gt;: '%s'&quot;), &quot;-fallbackfee&quot;, args.GetArg(&quot;-fallbackfee&quot;, &quot;&quot;));</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not executed"> # </span>]
<span id="L3140"><span class="lineNum">    3140</span>                 :<span class="tlaUNC">           0 :             return nullptr;</span></span>
<span id="L3141"><span class="lineNum">    3141</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         } else if (fallback_fee.value() &gt; HIGH_TX_FEE_PER_KB) {</span></span>
<span id="L3142"><span class="lineNum">    3142</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             warnings.push_back(AmountHighWarn(&quot;-fallbackfee&quot;) + Untranslated(&quot; &quot;) +</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not executed"> # </span>]
<span id="L3143"><span class="lineNum">    3143</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                                _(&quot;This is the transaction fee you may pay when fee estimates are not available.&quot;));</span></span>
<span id="L3144"><span class="lineNum">    3144</span>                 :             :         }</span>
<span id="L3145"><span class="lineNum">    3145</span>                 :<span class="tlaUNC">           0 :         walletInstance-&gt;m_fallback_fee = CFeeRate{fallback_fee.value()};</span></span>
<span id="L3146"><span class="lineNum">    3146</span>                 :             :     }</span>
<span id="L3147"><span class="lineNum">    3147</span>                 :             : </span>
<span id="L3148"><span class="lineNum">    3148</span>                 :             :     // Disable fallback fee in case value was set to 0, enable if non-null value</span>
<span id="L3149"><span class="lineNum">    3149</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     walletInstance-&gt;m_allow_fallback_fee = walletInstance-&gt;m_fallback_fee.GetFeePerK() != 0;</span></span>
<span id="L3150"><span class="lineNum">    3150</span>                 :             : </span>
<span id="L3151"><span class="lineNum">    3151</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     if (args.IsArgSet(&quot;-discardfee&quot;)) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L3152"><span class="lineNum">    3152</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         std::optional&lt;CAmount&gt; discard_fee = ParseMoney(args.GetArg(&quot;-discardfee&quot;, &quot;&quot;));</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L3153"><span class="lineNum">    3153</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!discard_fee) {</span></span>
<span id="L3154"><span class="lineNum">    3154</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             error = strprintf(_(&quot;Invalid amount for %s=&lt;amount&gt;: '%s'&quot;), &quot;-discardfee&quot;, args.GetArg(&quot;-discardfee&quot;, &quot;&quot;));</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not executed"> # </span>]
<span id="L3155"><span class="lineNum">    3155</span>                 :<span class="tlaUNC">           0 :             return nullptr;</span></span>
<span id="L3156"><span class="lineNum">    3156</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         } else if (discard_fee.value() &gt; HIGH_TX_FEE_PER_KB) {</span></span>
<span id="L3157"><span class="lineNum">    3157</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             warnings.push_back(AmountHighWarn(&quot;-discardfee&quot;) + Untranslated(&quot; &quot;) +</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not executed"> # </span>]
<span id="L3158"><span class="lineNum">    3158</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                                _(&quot;This is the transaction fee you may discard if change is smaller than dust at this level&quot;));</span></span>
<span id="L3159"><span class="lineNum">    3159</span>                 :             :         }</span>
<span id="L3160"><span class="lineNum">    3160</span>                 :<span class="tlaUNC">           0 :         walletInstance-&gt;m_discard_rate = CFeeRate{discard_fee.value()};</span></span>
<span id="L3161"><span class="lineNum">    3161</span>                 :             :     }</span>
<span id="L3162"><span class="lineNum">    3162</span>                 :             : </span>
<span id="L3163"><span class="lineNum">    3163</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     if (args.IsArgSet(&quot;-paytxfee&quot;)) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L3164"><span class="lineNum">    3164</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         std::optional&lt;CAmount&gt; pay_tx_fee = ParseMoney(args.GetArg(&quot;-paytxfee&quot;, &quot;&quot;));</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L3165"><span class="lineNum">    3165</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!pay_tx_fee) {</span></span>
<span id="L3166"><span class="lineNum">    3166</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             error = AmountErrMsg(&quot;paytxfee&quot;, args.GetArg(&quot;-paytxfee&quot;, &quot;&quot;));</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not executed"> # </span>]
<span id="L3167"><span class="lineNum">    3167</span>                 :<span class="tlaUNC">           0 :             return nullptr;</span></span>
<span id="L3168"><span class="lineNum">    3168</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         } else if (pay_tx_fee.value() &gt; HIGH_TX_FEE_PER_KB) {</span></span>
<span id="L3169"><span class="lineNum">    3169</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             warnings.push_back(AmountHighWarn(&quot;-paytxfee&quot;) + Untranslated(&quot; &quot;) +</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not executed"> # </span>]
<span id="L3170"><span class="lineNum">    3170</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                                _(&quot;This is the transaction fee you will pay if you send a transaction.&quot;));</span></span>
<span id="L3171"><span class="lineNum">    3171</span>                 :             :         }</span>
<span id="L3172"><span class="lineNum">    3172</span>                 :             : </span>
<span id="L3173"><span class="lineNum">    3173</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         walletInstance-&gt;m_pay_tx_fee = CFeeRate{pay_tx_fee.value(), 1000};</span></span>
<span id="L3174"><span class="lineNum">    3174</span>                 :             : </span>
<span id="L3175"><span class="lineNum">    3175</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         if (chain &amp;&amp; walletInstance-&gt;m_pay_tx_fee &lt; chain-&gt;relayMinFee()) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L3176"><span class="lineNum">    3176</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             error = strprintf(_(&quot;Invalid amount for %s=&lt;amount&gt;: '%s' (must be at least %s)&quot;),</span></span>
<span id="L3177"><span class="lineNum">    3177</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                 &quot;-paytxfee&quot;, args.GetArg(&quot;-paytxfee&quot;, &quot;&quot;), chain-&gt;relayMinFee().ToString());</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not executed"> # </span>]
<span id="L3178"><span class="lineNum">    3178</span>                 :<span class="tlaUNC">           0 :             return nullptr;</span></span>
<span id="L3179"><span class="lineNum">    3179</span>                 :             :         }</span>
<span id="L3180"><span class="lineNum">    3180</span>                 :             :     }</span>
<span id="L3181"><span class="lineNum">    3181</span>                 :             : </span>
<span id="L3182"><span class="lineNum">    3182</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     if (args.IsArgSet(&quot;-maxtxfee&quot;)) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L3183"><span class="lineNum">    3183</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         std::optional&lt;CAmount&gt; max_fee = ParseMoney(args.GetArg(&quot;-maxtxfee&quot;, &quot;&quot;));</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L3184"><span class="lineNum">    3184</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!max_fee) {</span></span>
<span id="L3185"><span class="lineNum">    3185</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             error = AmountErrMsg(&quot;maxtxfee&quot;, args.GetArg(&quot;-maxtxfee&quot;, &quot;&quot;));</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not executed"> # </span>]
<span id="L3186"><span class="lineNum">    3186</span>                 :<span class="tlaUNC">           0 :             return nullptr;</span></span>
<span id="L3187"><span class="lineNum">    3187</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         } else if (max_fee.value() &gt; HIGH_MAX_TX_FEE) {</span></span>
<span id="L3188"><span class="lineNum">    3188</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             warnings.push_back(strprintf(_(&quot;%s is set very high! Fees this large could be paid on a single transaction.&quot;), &quot;-maxtxfee&quot;));</span></span>
<span id="L3189"><span class="lineNum">    3189</span>                 :             :         }</span>
<span id="L3190"><span class="lineNum">    3190</span>                 :             : </span>
<span id="L3191"><span class="lineNum">    3191</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         if (chain &amp;&amp; CFeeRate{max_fee.value(), 1000} &lt; chain-&gt;relayMinFee()) {</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L3192"><span class="lineNum">    3192</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             error = strprintf(_(&quot;Invalid amount for %s=&lt;amount&gt;: '%s' (must be at least the minrelay fee of %s to prevent stuck transactions)&quot;),</span></span>
<span id="L3193"><span class="lineNum">    3193</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                 &quot;-maxtxfee&quot;, args.GetArg(&quot;-maxtxfee&quot;, &quot;&quot;), chain-&gt;relayMinFee().ToString());</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not executed"> # </span>]
<span id="L3194"><span class="lineNum">    3194</span>                 :<span class="tlaUNC">           0 :             return nullptr;</span></span>
<span id="L3195"><span class="lineNum">    3195</span>                 :             :         }</span>
<span id="L3196"><span class="lineNum">    3196</span>                 :             : </span>
<span id="L3197"><span class="lineNum">    3197</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         walletInstance-&gt;m_default_max_tx_fee = max_fee.value();</span></span>
<span id="L3198"><span class="lineNum">    3198</span>                 :             :     }</span>
<span id="L3199"><span class="lineNum">    3199</span>                 :             : </span>
<span id="L3200"><span class="lineNum">    3200</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     if (args.IsArgSet(&quot;-consolidatefeerate&quot;)) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L3201"><span class="lineNum">    3201</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         if (std::optional&lt;CAmount&gt; consolidate_feerate = ParseMoney(args.GetArg(&quot;-consolidatefeerate&quot;, &quot;&quot;))) {</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not executed"> # </span>]
<span id="L3202"><span class="lineNum">    3202</span>                 :<span class="tlaUNC">           0 :             walletInstance-&gt;m_consolidate_feerate = CFeeRate(*consolidate_feerate);</span></span>
<span id="L3203"><span class="lineNum">    3203</span>                 :             :         } else {</span>
<span id="L3204"><span class="lineNum">    3204</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             error = AmountErrMsg(&quot;consolidatefeerate&quot;, args.GetArg(&quot;-consolidatefeerate&quot;, &quot;&quot;));</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not executed"> # </span>]
<span id="L3205"><span class="lineNum">    3205</span>                 :<span class="tlaUNC">           0 :             return nullptr;</span></span>
<span id="L3206"><span class="lineNum">    3206</span>                 :             :         }</span>
<span id="L3207"><span class="lineNum">    3207</span>                 :             :     }</span>
<span id="L3208"><span class="lineNum">    3208</span>                 :             : </span>
<span id="L3209"><span class="lineNum">    3209</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     if (chain &amp;&amp; chain-&gt;relayMinFee().GetFeePerK() &gt; HIGH_TX_FEE_PER_KB) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L3210"><span class="lineNum">    3210</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         warnings.push_back(AmountHighWarn(&quot;-minrelaytxfee&quot;) + Untranslated(&quot; &quot;) +</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not executed"> # </span>]
<span id="L3211"><span class="lineNum">    3211</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                            _(&quot;The wallet will avoid paying less than the minimum relay fee.&quot;));</span></span>
<span id="L3212"><span class="lineNum">    3212</span>                 :             :     }</span>
<span id="L3213"><span class="lineNum">    3213</span>                 :             : </span>
<span id="L3214"><span class="lineNum">    3214</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     walletInstance-&gt;m_confirm_target = args.GetIntArg(&quot;-txconfirmtarget&quot;, DEFAULT_TX_CONFIRM_TARGET);</span></span>
<span id="L3215"><span class="lineNum">    3215</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     walletInstance-&gt;m_spend_zero_conf_change = args.GetBoolArg(&quot;-spendzeroconfchange&quot;, DEFAULT_SPEND_ZEROCONF_CHANGE);</span></span>
<span id="L3216"><span class="lineNum">    3216</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     walletInstance-&gt;m_signal_rbf = args.GetBoolArg(&quot;-walletrbf&quot;, DEFAULT_WALLET_RBF);</span></span>
<span id="L3217"><span class="lineNum">    3217</span>                 :             : </span>
<span id="L3218"><span class="lineNum">    3218</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     walletInstance-&gt;WalletLogPrintf(&quot;Wallet completed loading in %15dms\n&quot;, Ticks&lt;std::chrono::milliseconds&gt;(SteadyClock::now() - start));</span></span>
<span id="L3219"><span class="lineNum">    3219</span>                 :             : </span>
<span id="L3220"><span class="lineNum">    3220</span>                 :             :     // Try to top up keypool. No-op if the wallet is locked.</span>
<span id="L3221"><span class="lineNum">    3221</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     walletInstance-&gt;TopUpKeyPool();</span></span>
<span id="L3222"><span class="lineNum">    3222</span>                 :             : </span>
<span id="L3223"><span class="lineNum">    3223</span>                 :             :     // Cache the first key time</span>
<span id="L3224"><span class="lineNum">    3224</span>                 :<span class="tlaUNC">           0 :     std::optional&lt;int64_t&gt; time_first_key;</span></span>
<span id="L3225"><span class="lineNum">    3225</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (auto spk_man : walletInstance-&gt;GetAllScriptPubKeyMans()) {</span></span>
<span id="L3226"><span class="lineNum">    3226</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         int64_t time = spk_man-&gt;GetTimeFirstKey();</span></span>
<span id="L3227"><span class="lineNum">    3227</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!time_first_key || time &lt; *time_first_key) time_first_key = time;</span></span>
<span id="L3228"><span class="lineNum">    3228</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L3229"><span class="lineNum">    3229</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (time_first_key) walletInstance-&gt;MaybeUpdateBirthTime(*time_first_key);</span></span>
<span id="L3230"><span class="lineNum">    3230</span>                 :             : </span>
<span id="L3231"><span class="lineNum">    3231</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     if (chain &amp;&amp; !AttachChain(walletInstance, *chain, rescan_required, error, warnings)) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L3232"><span class="lineNum">    3232</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         walletInstance-&gt;m_chain_notifications_handler.reset(); // Reset this pointer so that the wallet will actually be unloaded</span></span>
<span id="L3233"><span class="lineNum">    3233</span>                 :<span class="tlaUNC">           0 :         return nullptr;</span></span>
<span id="L3234"><span class="lineNum">    3234</span>                 :             :     }</span>
<span id="L3235"><span class="lineNum">    3235</span>                 :             : </span>
<span id="L3236"><span class="lineNum">    3236</span>                 :<span class="tlaUNC">           0 :     {</span></span>
<span id="L3237"><span class="lineNum">    3237</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LOCK(walletInstance-&gt;cs_wallet);</span></span>
<span id="L3238"><span class="lineNum">    3238</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         walletInstance-&gt;SetBroadcastTransactions(args.GetBoolArg(&quot;-walletbroadcast&quot;, DEFAULT_WALLETBROADCAST));</span></span>
<span id="L3239"><span class="lineNum">    3239</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         walletInstance-&gt;WalletLogPrintf(&quot;setKeyPool.size() = %u\n&quot;,      walletInstance-&gt;GetKeyPoolSize());</span></span>
<span id="L3240"><span class="lineNum">    3240</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         walletInstance-&gt;WalletLogPrintf(&quot;mapWallet.size() = %u\n&quot;,       walletInstance-&gt;mapWallet.size());</span></span>
<span id="L3241"><span class="lineNum">    3241</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         walletInstance-&gt;WalletLogPrintf(&quot;m_address_book.size() = %u\n&quot;,  walletInstance-&gt;m_address_book.size());</span></span>
<span id="L3242"><span class="lineNum">    3242</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L3243"><span class="lineNum">    3243</span>                 :             : </span>
<span id="L3244"><span class="lineNum">    3244</span>                 :<span class="tlaUNC">           0 :     return walletInstance;</span></span>
<span id="L3245"><span class="lineNum">    3245</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L3246"><span class="lineNum">    3246</span>                 :             : </span>
<span id="L3247"><span class="lineNum">    3247</span>                 :<span class="tlaUNC">           0 : bool CWallet::AttachChain(const std::shared_ptr&lt;CWallet&gt;&amp; walletInstance, interfaces::Chain&amp; chain, const bool rescan_required, bilingual_str&amp; error, std::vector&lt;bilingual_str&gt;&amp; warnings)</span></span>
<span id="L3248"><span class="lineNum">    3248</span>                 :             : {</span>
<span id="L3249"><span class="lineNum">    3249</span>                 :<span class="tlaUNC">           0 :     LOCK(walletInstance-&gt;cs_wallet);</span></span>
<span id="L3250"><span class="lineNum">    3250</span>                 :             :     // allow setting the chain if it hasn't been set already but prevent changing it</span>
<span id="L3251"><span class="lineNum">    3251</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     assert(!walletInstance-&gt;m_chain || walletInstance-&gt;m_chain == &amp;chain);</span></span>
<span id="L3252"><span class="lineNum">    3252</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     walletInstance-&gt;m_chain = &amp;chain;</span></span>
<span id="L3253"><span class="lineNum">    3253</span>                 :             : </span>
<span id="L3254"><span class="lineNum">    3254</span>                 :             :     // Unless allowed, ensure wallet files are not reused across chains:</span>
<span id="L3255"><span class="lineNum">    3255</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     if (!gArgs.GetBoolArg(&quot;-walletcrosschain&quot;, DEFAULT_WALLETCROSSCHAIN)) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L3256"><span class="lineNum">    3256</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         WalletBatch batch(walletInstance-&gt;GetDatabase());</span></span>
<span id="L3257"><span class="lineNum">    3257</span>                 :<span class="tlaUNC">           0 :         CBlockLocator locator;</span></span>
<span id="L3258"><span class="lineNum">    3258</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         if (batch.ReadBestBlock(locator) &amp;&amp; locator.vHave.size() &gt; 0 &amp;&amp; chain.getHeight()) {</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not executed"> # </span>]
<span id="L3259"><span class="lineNum">    3259</span>                 :             :             // Wallet is assumed to be from another chain, if genesis block in the active</span>
<span id="L3260"><span class="lineNum">    3260</span>                 :             :             // chain differs from the genesis block known to the wallet.</span>
<span id="L3261"><span class="lineNum">    3261</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (chain.getBlockHash(0) != locator.vHave.back()) {</span></span>
<span id="L3262"><span class="lineNum">    3262</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 error = Untranslated(&quot;Wallet files should not be reused across chains. Restart bitcoind with -walletcrosschain to override.&quot;);</span></span>
<span id="L3263"><span class="lineNum">    3263</span>                 :<span class="tlaUNC">           0 :                 return false;</span></span>
<span id="L3264"><span class="lineNum">    3264</span>                 :             :             }</span>
<span id="L3265"><span class="lineNum">    3265</span>                 :             :         }</span>
<span id="L3266"><span class="lineNum">    3266</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L3267"><span class="lineNum">    3267</span>                 :             : </span>
<span id="L3268"><span class="lineNum">    3268</span>                 :             :     // Register wallet with validationinterface. It's done before rescan to avoid</span>
<span id="L3269"><span class="lineNum">    3269</span>                 :             :     // missing block connections between end of rescan and validation subscribing.</span>
<span id="L3270"><span class="lineNum">    3270</span>                 :             :     // Because of wallet lock being hold, block connection notifications are going to</span>
<span id="L3271"><span class="lineNum">    3271</span>                 :             :     // be pending on the validation-side until lock release. It's likely to have</span>
<span id="L3272"><span class="lineNum">    3272</span>                 :             :     // block processing duplicata (if rescan block range overlaps with notification one)</span>
<span id="L3273"><span class="lineNum">    3273</span>                 :             :     // but we guarantee at least than wallet state is correct after notifications delivery.</span>
<span id="L3274"><span class="lineNum">    3274</span>                 :             :     // However, chainStateFlushed notifications are ignored until the rescan is finished</span>
<span id="L3275"><span class="lineNum">    3275</span>                 :             :     // so that in case of a shutdown event, the rescan will be repeated at the next start.</span>
<span id="L3276"><span class="lineNum">    3276</span>                 :             :     // This is temporary until rescan and notifications delivery are unified under same</span>
<span id="L3277"><span class="lineNum">    3277</span>                 :             :     // interface.</span>
<span id="L3278"><span class="lineNum">    3278</span>                 :<span class="tlaUNC">           0 :     walletInstance-&gt;m_attaching_chain = true; //ignores chainStateFlushed notifications</span></span>
<span id="L3279"><span class="lineNum">    3279</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     walletInstance-&gt;m_chain_notifications_handler = walletInstance-&gt;chain().handleNotifications(walletInstance);</span></span>
<span id="L3280"><span class="lineNum">    3280</span>                 :             : </span>
<span id="L3281"><span class="lineNum">    3281</span>                 :             :     // If rescan_required = true, rescan_height remains equal to 0</span>
<span id="L3282"><span class="lineNum">    3282</span>                 :<span class="tlaUNC">           0 :     int rescan_height = 0;</span></span>
<span id="L3283"><span class="lineNum">    3283</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!rescan_required)</span></span>
<span id="L3284"><span class="lineNum">    3284</span>                 :             :     {</span>
<span id="L3285"><span class="lineNum">    3285</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         WalletBatch batch(walletInstance-&gt;GetDatabase());</span></span>
<span id="L3286"><span class="lineNum">    3286</span>                 :<span class="tlaUNC">           0 :         CBlockLocator locator;</span></span>
<span id="L3287"><span class="lineNum">    3287</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (batch.ReadBestBlock(locator)) {</span></span>
<span id="L3288"><span class="lineNum">    3288</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (const std::optional&lt;int&gt; fork_height = chain.findLocatorFork(locator)) {</span></span>
<span id="L3289"><span class="lineNum">    3289</span>                 :<span class="tlaUNC">           0 :                 rescan_height = *fork_height;</span></span>
<span id="L3290"><span class="lineNum">    3290</span>                 :             :             }</span>
<span id="L3291"><span class="lineNum">    3291</span>                 :             :         }</span>
<span id="L3292"><span class="lineNum">    3292</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L3293"><span class="lineNum">    3293</span>                 :             : </span>
<span id="L3294"><span class="lineNum">    3294</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     const std::optional&lt;int&gt; tip_height = chain.getHeight();</span></span>
<span id="L3295"><span class="lineNum">    3295</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (tip_height) {</span></span>
<span id="L3296"><span class="lineNum">    3296</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         walletInstance-&gt;m_last_block_processed = chain.getBlockHash(*tip_height);</span></span>
<span id="L3297"><span class="lineNum">    3297</span>                 :<span class="tlaUNC">           0 :         walletInstance-&gt;m_last_block_processed_height = *tip_height;</span></span>
<span id="L3298"><span class="lineNum">    3298</span>                 :             :     } else {</span>
<span id="L3299"><span class="lineNum">    3299</span>                 :<span class="tlaUNC">           0 :         walletInstance-&gt;m_last_block_processed.SetNull();</span></span>
<span id="L3300"><span class="lineNum">    3300</span>                 :<span class="tlaUNC">           0 :         walletInstance-&gt;m_last_block_processed_height = -1;</span></span>
<span id="L3301"><span class="lineNum">    3301</span>                 :             :     }</span>
<span id="L3302"><span class="lineNum">    3302</span>                 :             : </span>
<span id="L3303"><span class="lineNum">    3303</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (tip_height &amp;&amp; *tip_height != rescan_height)</span></span>
<span id="L3304"><span class="lineNum">    3304</span>                 :             :     {</span>
<span id="L3305"><span class="lineNum">    3305</span>                 :             :         // No need to read and scan block if block was created before</span>
<span id="L3306"><span class="lineNum">    3306</span>                 :             :         // our wallet birthday (as adjusted for block time variability)</span>
<span id="L3307"><span class="lineNum">    3307</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         std::optional&lt;int64_t&gt; time_first_key = walletInstance-&gt;m_birth_time.load();</span></span>
<span id="L3308"><span class="lineNum">    3308</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (time_first_key) {</span></span>
<span id="L3309"><span class="lineNum">    3309</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             FoundBlock found = FoundBlock().height(rescan_height);</span></span>
<span id="L3310"><span class="lineNum">    3310</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             chain.findFirstBlockWithTimeAndHeight(*time_first_key - TIMESTAMP_WINDOW, rescan_height, found);</span></span>
<span id="L3311"><span class="lineNum">    3311</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (!found.found) {</span></span>
<span id="L3312"><span class="lineNum">    3312</span>                 :             :                 // We were unable to find a block that had a time more recent than our earliest timestamp</span>
<span id="L3313"><span class="lineNum">    3313</span>                 :             :                 // or a height higher than the wallet was synced to, indicating that the wallet is newer than the</span>
<span id="L3314"><span class="lineNum">    3314</span>                 :             :                 // current chain tip. Skip rescanning in this case.</span>
<span id="L3315"><span class="lineNum">    3315</span>                 :<span class="tlaUNC">           0 :                 rescan_height = *tip_height;</span></span>
<span id="L3316"><span class="lineNum">    3316</span>                 :             :             }</span>
<span id="L3317"><span class="lineNum">    3317</span>                 :             :         }</span>
<span id="L3318"><span class="lineNum">    3318</span>                 :             : </span>
<span id="L3319"><span class="lineNum">    3319</span>                 :             :         // Technically we could execute the code below in any case, but performing the</span>
<span id="L3320"><span class="lineNum">    3320</span>                 :             :         // `while` loop below can make startup very slow, so only check blocks on disk</span>
<span id="L3321"><span class="lineNum">    3321</span>                 :             :         // if necessary.</span>
<span id="L3322"><span class="lineNum">    3322</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         if (chain.havePruned() || chain.hasAssumedValidChain()) {</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L3323"><span class="lineNum">    3323</span>                 :<span class="tlaUNC">           0 :             int block_height = *tip_height;</span></span>
<span id="L3324"><span class="lineNum">    3324</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             while (block_height &gt; 0 &amp;&amp; chain.haveBlockOnDisk(block_height - 1) &amp;&amp; rescan_height != block_height) {</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L3325"><span class="lineNum">    3325</span>                 :<span class="tlaUNC">           0 :                 --block_height;</span></span>
<span id="L3326"><span class="lineNum">    3326</span>                 :             :             }</span>
<span id="L3327"><span class="lineNum">    3327</span>                 :             : </span>
<span id="L3328"><span class="lineNum">    3328</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (rescan_height != block_height) {</span></span>
<span id="L3329"><span class="lineNum">    3329</span>                 :             :                 // We can't rescan beyond blocks we don't have data for, stop and throw an error.</span>
<span id="L3330"><span class="lineNum">    3330</span>                 :             :                 // This might happen if a user uses an old wallet within a pruned node</span>
<span id="L3331"><span class="lineNum">    3331</span>                 :             :                 // or if they ran -disablewallet for a longer time, then decided to re-enable</span>
<span id="L3332"><span class="lineNum">    3332</span>                 :             :                 // Exit early and print an error.</span>
<span id="L3333"><span class="lineNum">    3333</span>                 :             :                 // It also may happen if an assumed-valid chain is in use and therefore not</span>
<span id="L3334"><span class="lineNum">    3334</span>                 :             :                 // all block data is available.</span>
<span id="L3335"><span class="lineNum">    3335</span>                 :             :                 // If a block is pruned after this check, we will load the wallet,</span>
<span id="L3336"><span class="lineNum">    3336</span>                 :             :                 // but fail the rescan with a generic error.</span>
<span id="L3337"><span class="lineNum">    3337</span>                 :             : </span>
<span id="L3338"><span class="lineNum">    3338</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                 error = chain.havePruned() ?</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L3339"><span class="lineNum">    3339</span>                 :             :                      _(&quot;Prune: last wallet synchronisation goes beyond pruned data. You need to -reindex (download the whole blockchain again in case of pruned node)&quot;) :</span>
<span id="L3340"><span class="lineNum">    3340</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                      strprintf(_(</span></span>
<span id="L3341"><span class="lineNum">    3341</span>                 :             :                         &quot;Error loading wallet. Wallet requires blocks to be downloaded, &quot;</span>
<span id="L3342"><span class="lineNum">    3342</span>                 :             :                         &quot;and software does not currently support loading wallets while &quot;</span>
<span id="L3343"><span class="lineNum">    3343</span>                 :             :                         &quot;blocks are being downloaded out of order when using assumeutxo &quot;</span>
<span id="L3344"><span class="lineNum">    3344</span>                 :             :                         &quot;snapshots. Wallet should be able to load successfully after &quot;</span>
<span id="L3345"><span class="lineNum">    3345</span>                 :<span class="tlaUNC">           0 :                         &quot;node sync reaches height %s&quot;), block_height);</span></span>
<span id="L3346"><span class="lineNum">    3346</span>                 :<span class="tlaUNC">           0 :                 return false;</span></span>
<span id="L3347"><span class="lineNum">    3347</span>                 :             :             }</span>
<span id="L3348"><span class="lineNum">    3348</span>                 :             :         }</span>
<span id="L3349"><span class="lineNum">    3349</span>                 :             : </span>
<span id="L3350"><span class="lineNum">    3350</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         chain.initMessage(_(&quot;Rescanning&quot;).translated);</span></span>
<span id="L3351"><span class="lineNum">    3351</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         walletInstance-&gt;WalletLogPrintf(&quot;Rescanning last %i blocks (from block %i)...\n&quot;, *tip_height - rescan_height, rescan_height);</span></span>
<span id="L3352"><span class="lineNum">    3352</span>                 :             : </span>
<span id="L3353"><span class="lineNum">    3353</span>                 :<span class="tlaUNC">           0 :         {</span></span>
<span id="L3354"><span class="lineNum">    3354</span>                 :<span class="tlaUNC">           0 :             WalletRescanReserver reserver(*walletInstance);</span></span>
<span id="L3355"><span class="lineNum">    3355</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             if (!reserver.reserve() || (ScanResult::SUCCESS != walletInstance-&gt;ScanForWalletTransactions(chain.getBlockHash(rescan_height), rescan_height, /*max_height=*/{}, reserver, /*fUpdate=*/true, /*save_progress=*/true).status)) {</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L3356"><span class="lineNum">    3356</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 error = _(&quot;Failed to rescan the wallet during initialization&quot;);</span></span>
<span id="L3357"><span class="lineNum">    3357</span>                 :<span class="tlaUNC">           0 :                 return false;</span></span>
<span id="L3358"><span class="lineNum">    3358</span>                 :             :             }</span>
<span id="L3359"><span class="lineNum">    3359</span>                 :<span class="tlaUNC">           0 :         }</span></span>
<span id="L3360"><span class="lineNum">    3360</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         walletInstance-&gt;m_attaching_chain = false;</span></span>
<span id="L3361"><span class="lineNum">    3361</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         walletInstance-&gt;chainStateFlushed(ChainstateRole::NORMAL, chain.getTipLocator());</span></span>
<span id="L3362"><span class="lineNum">    3362</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         walletInstance-&gt;GetDatabase().IncrementUpdateCounter();</span></span>
<span id="L3363"><span class="lineNum">    3363</span>                 :             :     }</span>
<span id="L3364"><span class="lineNum">    3364</span>                 :<span class="tlaUNC">           0 :     walletInstance-&gt;m_attaching_chain = false;</span></span>
<span id="L3365"><span class="lineNum">    3365</span>                 :             : </span>
<span id="L3366"><span class="lineNum">    3366</span>                 :<span class="tlaUNC">           0 :     return true;</span></span>
<span id="L3367"><span class="lineNum">    3367</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L3368"><span class="lineNum">    3368</span>                 :             : </span>
<span id="L3369"><span class="lineNum">    3369</span>                 :<span class="tlaUNC">           0 : const CAddressBookData* CWallet::FindAddressBookEntry(const CTxDestination&amp; dest, bool allow_change) const</span></span>
<span id="L3370"><span class="lineNum">    3370</span>                 :             : {</span>
<span id="L3371"><span class="lineNum">    3371</span>                 :<span class="tlaUNC">           0 :     const auto&amp; address_book_it = m_address_book.find(dest);</span></span>
<span id="L3372"><span class="lineNum">    3372</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (address_book_it == m_address_book.end()) return nullptr;</span></span>
<span id="L3373"><span class="lineNum">    3373</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if ((!allow_change) &amp;&amp; address_book_it-&gt;second.IsChange()) {</span></span>
<span id="L3374"><span class="lineNum">    3374</span>                 :             :         return nullptr;</span>
<span id="L3375"><span class="lineNum">    3375</span>                 :             :     }</span>
<span id="L3376"><span class="lineNum">    3376</span>                 :<span class="tlaUNC">           0 :     return &amp;address_book_it-&gt;second;</span></span>
<span id="L3377"><span class="lineNum">    3377</span>                 :             : }</span>
<span id="L3378"><span class="lineNum">    3378</span>                 :             : </span>
<span id="L3379"><span class="lineNum">    3379</span>                 :<span class="tlaUNC">           0 : bool CWallet::UpgradeWallet(int version, bilingual_str&amp; error)</span></span>
<span id="L3380"><span class="lineNum">    3380</span>                 :             : {</span>
<span id="L3381"><span class="lineNum">    3381</span>                 :<span class="tlaUNC">           0 :     int prev_version = GetVersion();</span></span>
<span id="L3382"><span class="lineNum">    3382</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (version == 0) {</span></span>
<span id="L3383"><span class="lineNum">    3383</span>                 :<span class="tlaUNC">           0 :         WalletLogPrintf(&quot;Performing wallet upgrade to %i\n&quot;, FEATURE_LATEST);</span></span>
<span id="L3384"><span class="lineNum">    3384</span>                 :<span class="tlaUNC">           0 :         version = FEATURE_LATEST;</span></span>
<span id="L3385"><span class="lineNum">    3385</span>                 :             :     } else {</span>
<span id="L3386"><span class="lineNum">    3386</span>                 :<span class="tlaUNC">           0 :         WalletLogPrintf(&quot;Allowing wallet upgrade up to %i\n&quot;, version);</span></span>
<span id="L3387"><span class="lineNum">    3387</span>                 :             :     }</span>
<span id="L3388"><span class="lineNum">    3388</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (version &lt; prev_version) {</span></span>
<span id="L3389"><span class="lineNum">    3389</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         error = strprintf(_(&quot;Cannot downgrade wallet from version %i to version %i. Wallet version unchanged.&quot;), prev_version, version);</span></span>
<span id="L3390"><span class="lineNum">    3390</span>                 :<span class="tlaUNC">           0 :         return false;</span></span>
<span id="L3391"><span class="lineNum">    3391</span>                 :             :     }</span>
<span id="L3392"><span class="lineNum">    3392</span>                 :             : </span>
<span id="L3393"><span class="lineNum">    3393</span>                 :<span class="tlaUNC">           0 :     LOCK(cs_wallet);</span></span>
<span id="L3394"><span class="lineNum">    3394</span>                 :             : </span>
<span id="L3395"><span class="lineNum">    3395</span>                 :             :     // Do not upgrade versions to any version between HD_SPLIT and FEATURE_PRE_SPLIT_KEYPOOL unless already supporting HD_SPLIT</span>
<span id="L3396"><span class="lineNum">    3396</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     if (!CanSupportFeature(FEATURE_HD_SPLIT) &amp;&amp; version &gt;= FEATURE_HD_SPLIT &amp;&amp; version &lt; FEATURE_PRE_SPLIT_KEYPOOL) {</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L3397"><span class="lineNum">    3397</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         error = strprintf(_(&quot;Cannot upgrade a non HD split wallet from version %i to version %i without upgrading to support pre-split keypool. Please use version %i or no version specified.&quot;), prev_version, version, FEATURE_PRE_SPLIT_KEYPOOL);</span></span>
<span id="L3398"><span class="lineNum">    3398</span>                 :<span class="tlaUNC">           0 :         return false;</span></span>
<span id="L3399"><span class="lineNum">    3399</span>                 :             :     }</span>
<span id="L3400"><span class="lineNum">    3400</span>                 :             : </span>
<span id="L3401"><span class="lineNum">    3401</span>                 :             :     // Permanently upgrade to the version</span>
<span id="L3402"><span class="lineNum">    3402</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     SetMinVersion(GetClosestWalletFeature(version));</span></span>
<span id="L3403"><span class="lineNum">    3403</span>                 :             : </span>
<span id="L3404"><span class="lineNum">    3404</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (auto spk_man : GetActiveScriptPubKeyMans()) {</span></span>
<span id="L3405"><span class="lineNum">    3405</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!spk_man-&gt;Upgrade(prev_version, version, error)) {</span></span>
<span id="L3406"><span class="lineNum">    3406</span>                 :<span class="tlaUNC">           0 :             return false;</span></span>
<span id="L3407"><span class="lineNum">    3407</span>                 :             :         }</span>
<span id="L3408"><span class="lineNum">    3408</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L3409"><span class="lineNum">    3409</span>                 :<span class="tlaUNC">           0 :     return true;</span></span>
<span id="L3410"><span class="lineNum">    3410</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L3411"><span class="lineNum">    3411</span>                 :             : </span>
<span id="L3412"><span class="lineNum">    3412</span>                 :<span class="tlaUNC">           0 : void CWallet::postInitProcess()</span></span>
<span id="L3413"><span class="lineNum">    3413</span>                 :             : {</span>
<span id="L3414"><span class="lineNum">    3414</span>                 :             :     // Add wallet transactions that aren't already in a block to mempool</span>
<span id="L3415"><span class="lineNum">    3415</span>                 :             :     // Do this here as mempool requires genesis block to be loaded</span>
<span id="L3416"><span class="lineNum">    3416</span>                 :<span class="tlaUNC">           0 :     ResubmitWalletTransactions(/*relay=*/false, /*force=*/true);</span></span>
<span id="L3417"><span class="lineNum">    3417</span>                 :             : </span>
<span id="L3418"><span class="lineNum">    3418</span>                 :             :     // Update wallet transactions with current mempool transactions.</span>
<span id="L3419"><span class="lineNum">    3419</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     WITH_LOCK(cs_wallet, chain().requestMempoolTransactions(*this));</span></span>
<span id="L3420"><span class="lineNum">    3420</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L3421"><span class="lineNum">    3421</span>                 :             : </span>
<span id="L3422"><span class="lineNum">    3422</span>                 :<span class="tlaUNC">           0 : bool CWallet::BackupWallet(const std::string&amp; strDest) const</span></span>
<span id="L3423"><span class="lineNum">    3423</span>                 :             : {</span>
<span id="L3424"><span class="lineNum">    3424</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (m_chain) {</span></span>
<span id="L3425"><span class="lineNum">    3425</span>                 :<span class="tlaUNC">           0 :         CBlockLocator loc;</span></span>
<span id="L3426"><span class="lineNum">    3426</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         WITH_LOCK(cs_wallet, chain().findBlock(m_last_block_processed, FoundBlock().locator(loc)));</span></span>
<span id="L3427"><span class="lineNum">    3427</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!loc.IsNull()) {</span></span>
<span id="L3428"><span class="lineNum">    3428</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             WalletBatch batch(GetDatabase());</span></span>
<span id="L3429"><span class="lineNum">    3429</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             batch.WriteBestBlock(loc);</span></span>
<span id="L3430"><span class="lineNum">    3430</span>                 :<span class="tlaUNC">           0 :         }</span></span>
<span id="L3431"><span class="lineNum">    3431</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L3432"><span class="lineNum">    3432</span>                 :<span class="tlaUNC">           0 :     return GetDatabase().Backup(strDest);</span></span>
<span id="L3433"><span class="lineNum">    3433</span>                 :             : }</span>
<span id="L3434"><span class="lineNum">    3434</span>                 :             : </span>
<span id="L3435"><span class="lineNum">    3435</span>                 :<span class="tlaUNC">           0 : CKeyPool::CKeyPool()</span></span>
<span id="L3436"><span class="lineNum">    3436</span>                 :             : {</span>
<span id="L3437"><span class="lineNum">    3437</span>                 :<span class="tlaUNC">           0 :     nTime = GetTime();</span></span>
<span id="L3438"><span class="lineNum">    3438</span>                 :<span class="tlaUNC">           0 :     fInternal = false;</span></span>
<span id="L3439"><span class="lineNum">    3439</span>                 :<span class="tlaUNC">           0 :     m_pre_split = false;</span></span>
<span id="L3440"><span class="lineNum">    3440</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L3441"><span class="lineNum">    3441</span>                 :             : </span>
<span id="L3442"><span class="lineNum">    3442</span>                 :<span class="tlaUNC">           0 : CKeyPool::CKeyPool(const CPubKey&amp; vchPubKeyIn, bool internalIn)</span></span>
<span id="L3443"><span class="lineNum">    3443</span>                 :             : {</span>
<span id="L3444"><span class="lineNum">    3444</span>                 :<span class="tlaUNC">           0 :     nTime = GetTime();</span></span>
<span id="L3445"><span class="lineNum">    3445</span>                 :<span class="tlaUNC">           0 :     vchPubKey = vchPubKeyIn;</span></span>
<span id="L3446"><span class="lineNum">    3446</span>                 :<span class="tlaUNC">           0 :     fInternal = internalIn;</span></span>
<span id="L3447"><span class="lineNum">    3447</span>                 :<span class="tlaUNC">           0 :     m_pre_split = false;</span></span>
<span id="L3448"><span class="lineNum">    3448</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L3449"><span class="lineNum">    3449</span>                 :             : </span>
<span id="L3450"><span class="lineNum">    3450</span>                 :<span class="tlaUNC">           0 : int CWallet::GetTxDepthInMainChain(const CWalletTx&amp; wtx) const</span></span>
<span id="L3451"><span class="lineNum">    3451</span>                 :             : {</span>
<span id="L3452"><span class="lineNum">    3452</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L3453"><span class="lineNum">    3453</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (auto* conf = wtx.state&lt;TxStateConfirmed&gt;()) {</span></span>
<span id="L3454"><span class="lineNum">    3454</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         assert(conf-&gt;confirmed_block_height &gt;= 0);</span></span>
<span id="L3455"><span class="lineNum">    3455</span>                 :<span class="tlaUNC">           0 :         return GetLastBlockHeight() - conf-&gt;confirmed_block_height + 1;</span></span>
<span id="L3456"><span class="lineNum">    3456</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     } else if (auto* conf = wtx.state&lt;TxStateBlockConflicted&gt;()) {</span></span>
<span id="L3457"><span class="lineNum">    3457</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         assert(conf-&gt;conflicting_block_height &gt;= 0);</span></span>
<span id="L3458"><span class="lineNum">    3458</span>                 :<span class="tlaUNC">           0 :         return -1 * (GetLastBlockHeight() - conf-&gt;conflicting_block_height + 1);</span></span>
<span id="L3459"><span class="lineNum">    3459</span>                 :             :     } else {</span>
<span id="L3460"><span class="lineNum">    3460</span>                 :             :         return 0;</span>
<span id="L3461"><span class="lineNum">    3461</span>                 :             :     }</span>
<span id="L3462"><span class="lineNum">    3462</span>                 :             : }</span>
<span id="L3463"><span class="lineNum">    3463</span>                 :             : </span>
<span id="L3464"><span class="lineNum">    3464</span>                 :<span class="tlaUNC">           0 : int CWallet::GetTxBlocksToMaturity(const CWalletTx&amp; wtx) const</span></span>
<span id="L3465"><span class="lineNum">    3465</span>                 :             : {</span>
<span id="L3466"><span class="lineNum">    3466</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L3467"><span class="lineNum">    3467</span>                 :             : </span>
<span id="L3468"><span class="lineNum">    3468</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!wtx.IsCoinBase()) {</span></span>
<span id="L3469"><span class="lineNum">    3469</span>                 :             :         return 0;</span>
<span id="L3470"><span class="lineNum">    3470</span>                 :             :     }</span>
<span id="L3471"><span class="lineNum">    3471</span>                 :<span class="tlaUNC">           0 :     int chain_depth = GetTxDepthInMainChain(wtx);</span></span>
<span id="L3472"><span class="lineNum">    3472</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     assert(chain_depth &gt;= 0); // coinbase tx should not be conflicted</span></span>
<span id="L3473"><span class="lineNum">    3473</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     return std::max(0, (COINBASE_MATURITY+1) - chain_depth);</span></span>
<span id="L3474"><span class="lineNum">    3474</span>                 :             : }</span>
<span id="L3475"><span class="lineNum">    3475</span>                 :             : </span>
<span id="L3476"><span class="lineNum">    3476</span>                 :<span class="tlaUNC">           0 : bool CWallet::IsTxImmatureCoinBase(const CWalletTx&amp; wtx) const</span></span>
<span id="L3477"><span class="lineNum">    3477</span>                 :             : {</span>
<span id="L3478"><span class="lineNum">    3478</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L3479"><span class="lineNum">    3479</span>                 :             : </span>
<span id="L3480"><span class="lineNum">    3480</span>                 :             :     // note GetBlocksToMaturity is 0 for non-coinbase tx</span>
<span id="L3481"><span class="lineNum">    3481</span>                 :<span class="tlaUNC">           0 :     return GetTxBlocksToMaturity(wtx) &gt; 0;</span></span>
<span id="L3482"><span class="lineNum">    3482</span>                 :             : }</span>
<span id="L3483"><span class="lineNum">    3483</span>                 :             : </span>
<span id="L3484"><span class="lineNum">    3484</span>                 :<span class="tlaUNC">           0 : bool CWallet::IsCrypted() const</span></span>
<span id="L3485"><span class="lineNum">    3485</span>                 :             : {</span>
<span id="L3486"><span class="lineNum">    3486</span>                 :<span class="tlaUNC">           0 :     return HasEncryptionKeys();</span></span>
<span id="L3487"><span class="lineNum">    3487</span>                 :             : }</span>
<span id="L3488"><span class="lineNum">    3488</span>                 :             : </span>
<span id="L3489"><span class="lineNum">    3489</span>                 :<span class="tlaUNC">           0 : bool CWallet::IsLocked() const</span></span>
<span id="L3490"><span class="lineNum">    3490</span>                 :             : {</span>
<span id="L3491"><span class="lineNum">    3491</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!IsCrypted()) {</span></span>
<span id="L3492"><span class="lineNum">    3492</span>                 :             :         return false;</span>
<span id="L3493"><span class="lineNum">    3493</span>                 :             :     }</span>
<span id="L3494"><span class="lineNum">    3494</span>                 :<span class="tlaUNC">           0 :     LOCK(cs_wallet);</span></span>
<span id="L3495"><span class="lineNum">    3495</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     return vMasterKey.empty();</span></span>
<span id="L3496"><span class="lineNum">    3496</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L3497"><span class="lineNum">    3497</span>                 :             : </span>
<span id="L3498"><span class="lineNum">    3498</span>                 :<span class="tlaUNC">           0 : bool CWallet::Lock()</span></span>
<span id="L3499"><span class="lineNum">    3499</span>                 :             : {</span>
<span id="L3500"><span class="lineNum">    3500</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!IsCrypted())</span></span>
<span id="L3501"><span class="lineNum">    3501</span>                 :             :         return false;</span>
<span id="L3502"><span class="lineNum">    3502</span>                 :             : </span>
<span id="L3503"><span class="lineNum">    3503</span>                 :<span class="tlaUNC">           0 :     {</span></span>
<span id="L3504"><span class="lineNum">    3504</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LOCK2(m_relock_mutex, cs_wallet);</span></span>
<span id="L3505"><span class="lineNum">    3505</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!vMasterKey.empty()) {</span></span>
<span id="L3506"><span class="lineNum">    3506</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             memory_cleanse(vMasterKey.data(), vMasterKey.size() * sizeof(decltype(vMasterKey)::value_type));</span></span>
<span id="L3507"><span class="lineNum">    3507</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             vMasterKey.clear();</span></span>
<span id="L3508"><span class="lineNum">    3508</span>                 :             :         }</span>
<span id="L3509"><span class="lineNum">    3509</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     }</span></span>
<span id="L3510"><span class="lineNum">    3510</span>                 :             : </span>
<span id="L3511"><span class="lineNum">    3511</span>                 :<span class="tlaUNC">           0 :     NotifyStatusChanged(this);</span></span>
<span id="L3512"><span class="lineNum">    3512</span>                 :<span class="tlaUNC">           0 :     return true;</span></span>
<span id="L3513"><span class="lineNum">    3513</span>                 :             : }</span>
<span id="L3514"><span class="lineNum">    3514</span>                 :             : </span>
<span id="L3515"><span class="lineNum">    3515</span>                 :<span class="tlaUNC">           0 : bool CWallet::Unlock(const CKeyingMaterial&amp; vMasterKeyIn)</span></span>
<span id="L3516"><span class="lineNum">    3516</span>                 :             : {</span>
<span id="L3517"><span class="lineNum">    3517</span>                 :<span class="tlaUNC">           0 :     {</span></span>
<span id="L3518"><span class="lineNum">    3518</span>                 :<span class="tlaUNC">           0 :         LOCK(cs_wallet);</span></span>
<span id="L3519"><span class="lineNum">    3519</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (const auto&amp; spk_man_pair : m_spk_managers) {</span></span>
<span id="L3520"><span class="lineNum">    3520</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (!spk_man_pair.second-&gt;CheckDecryptionKey(vMasterKeyIn)) {</span></span>
<span id="L3521"><span class="lineNum">    3521</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 return false;</span></span>
<span id="L3522"><span class="lineNum">    3522</span>                 :             :             }</span>
<span id="L3523"><span class="lineNum">    3523</span>                 :             :         }</span>
<span id="L3524"><span class="lineNum">    3524</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         vMasterKey = vMasterKeyIn;</span></span>
<span id="L3525"><span class="lineNum">    3525</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L3526"><span class="lineNum">    3526</span>                 :<span class="tlaUNC">           0 :     NotifyStatusChanged(this);</span></span>
<span id="L3527"><span class="lineNum">    3527</span>                 :<span class="tlaUNC">           0 :     return true;</span></span>
<span id="L3528"><span class="lineNum">    3528</span>                 :             : }</span>
<span id="L3529"><span class="lineNum">    3529</span>                 :             : </span>
<span id="L3530"><span class="lineNum">    3530</span>                 :<span class="tlaUNC">           0 : std::set&lt;ScriptPubKeyMan*&gt; CWallet::GetActiveScriptPubKeyMans() const</span></span>
<span id="L3531"><span class="lineNum">    3531</span>                 :             : {</span>
<span id="L3532"><span class="lineNum">    3532</span>                 :<span class="tlaUNC">           0 :     std::set&lt;ScriptPubKeyMan*&gt; spk_mans;</span></span>
<span id="L3533"><span class="lineNum">    3533</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (bool internal : {false, true}) {</span></span>
<span id="L3534"><span class="lineNum">    3534</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (OutputType t : OUTPUT_TYPES) {</span></span>
<span id="L3535"><span class="lineNum">    3535</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             auto spk_man = GetScriptPubKeyMan(t, internal);</span></span>
<span id="L3536"><span class="lineNum">    3536</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (spk_man) {</span></span>
<span id="L3537"><span class="lineNum">    3537</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 spk_mans.insert(spk_man);</span></span>
<span id="L3538"><span class="lineNum">    3538</span>                 :             :             }</span>
<span id="L3539"><span class="lineNum">    3539</span>                 :             :         }</span>
<span id="L3540"><span class="lineNum">    3540</span>                 :             :     }</span>
<span id="L3541"><span class="lineNum">    3541</span>                 :<span class="tlaUNC">           0 :     return spk_mans;</span></span>
<span id="L3542"><span class="lineNum">    3542</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L3543"><span class="lineNum">    3543</span>                 :             : </span>
<span id="L3544"><span class="lineNum">    3544</span>                 :<span class="tlaUNC">           0 : bool CWallet::IsActiveScriptPubKeyMan(const ScriptPubKeyMan&amp; spkm) const</span></span>
<span id="L3545"><span class="lineNum">    3545</span>                 :             : {</span>
<span id="L3546"><span class="lineNum">    3546</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (const auto&amp; [_, ext_spkm] : m_external_spk_managers) {</span></span>
<span id="L3547"><span class="lineNum">    3547</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (ext_spkm == &amp;spkm) return true;</span></span>
<span id="L3548"><span class="lineNum">    3548</span>                 :             :     }</span>
<span id="L3549"><span class="lineNum">    3549</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (const auto&amp; [_, int_spkm] : m_internal_spk_managers) {</span></span>
<span id="L3550"><span class="lineNum">    3550</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (int_spkm == &amp;spkm) return true;</span></span>
<span id="L3551"><span class="lineNum">    3551</span>                 :             :     }</span>
<span id="L3552"><span class="lineNum">    3552</span>                 :             :     return false;</span>
<span id="L3553"><span class="lineNum">    3553</span>                 :             : }</span>
<span id="L3554"><span class="lineNum">    3554</span>                 :             : </span>
<span id="L3555"><span class="lineNum">    3555</span>                 :<span class="tlaUNC">           0 : std::set&lt;ScriptPubKeyMan*&gt; CWallet::GetAllScriptPubKeyMans() const</span></span>
<span id="L3556"><span class="lineNum">    3556</span>                 :             : {</span>
<span id="L3557"><span class="lineNum">    3557</span>                 :<span class="tlaUNC">           0 :     std::set&lt;ScriptPubKeyMan*&gt; spk_mans;</span></span>
<span id="L3558"><span class="lineNum">    3558</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (const auto&amp; spk_man_pair : m_spk_managers) {</span></span>
<span id="L3559"><span class="lineNum">    3559</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         spk_mans.insert(spk_man_pair.second.get());</span></span>
<span id="L3560"><span class="lineNum">    3560</span>                 :             :     }</span>
<span id="L3561"><span class="lineNum">    3561</span>                 :<span class="tlaUNC">           0 :     return spk_mans;</span></span>
<span id="L3562"><span class="lineNum">    3562</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L3563"><span class="lineNum">    3563</span>                 :             : </span>
<span id="L3564"><span class="lineNum">    3564</span>                 :<span class="tlaUNC">           0 : ScriptPubKeyMan* CWallet::GetScriptPubKeyMan(const OutputType&amp; type, bool internal) const</span></span>
<span id="L3565"><span class="lineNum">    3565</span>                 :             : {</span>
<span id="L3566"><span class="lineNum">    3566</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     const std::map&lt;OutputType, ScriptPubKeyMan*&gt;&amp; spk_managers = internal ? m_internal_spk_managers : m_external_spk_managers;</span></span>
<span id="L3567"><span class="lineNum">    3567</span>                 :<span class="tlaUNC">           0 :     std::map&lt;OutputType, ScriptPubKeyMan*&gt;::const_iterator it = spk_managers.find(type);</span></span>
<span id="L3568"><span class="lineNum">    3568</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (it == spk_managers.end()) {</span></span>
<span id="L3569"><span class="lineNum">    3569</span>                 :             :         return nullptr;</span>
<span id="L3570"><span class="lineNum">    3570</span>                 :             :     }</span>
<span id="L3571"><span class="lineNum">    3571</span>                 :<span class="tlaUNC">           0 :     return it-&gt;second;</span></span>
<span id="L3572"><span class="lineNum">    3572</span>                 :             : }</span>
<span id="L3573"><span class="lineNum">    3573</span>                 :             : </span>
<span id="L3574"><span class="lineNum">    3574</span>                 :<span class="tlaUNC">           0 : std::set&lt;ScriptPubKeyMan*&gt; CWallet::GetScriptPubKeyMans(const CScript&amp; script) const</span></span>
<span id="L3575"><span class="lineNum">    3575</span>                 :             : {</span>
<span id="L3576"><span class="lineNum">    3576</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     std::set&lt;ScriptPubKeyMan*&gt; spk_mans;</span></span>
<span id="L3577"><span class="lineNum">    3577</span>                 :             : </span>
<span id="L3578"><span class="lineNum">    3578</span>                 :             :     // Search the cache for relevant SPKMs instead of iterating m_spk_managers</span>
<span id="L3579"><span class="lineNum">    3579</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     const auto&amp; it = m_cached_spks.find(script);</span></span>
<span id="L3580"><span class="lineNum">    3580</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (it != m_cached_spks.end()) {</span></span>
<span id="L3581"><span class="lineNum">    3581</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         spk_mans.insert(it-&gt;second.begin(), it-&gt;second.end());</span></span>
<span id="L3582"><span class="lineNum">    3582</span>                 :             :     }</span>
<span id="L3583"><span class="lineNum">    3583</span>                 :<span class="tlaUNC">           0 :     SignatureData sigdata;</span></span>
<span id="L3584"><span class="lineNum">    3584</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     Assume(std::all_of(spk_mans.begin(), spk_mans.end(), [&amp;script, &amp;sigdata](ScriptPubKeyMan* spkm) { return spkm-&gt;CanProvide(script, sigdata); }));</span></span>
<span id="L3585"><span class="lineNum">    3585</span>                 :             : </span>
<span id="L3586"><span class="lineNum">    3586</span>                 :             :     // Legacy wallet</span>
<span id="L3587"><span class="lineNum">    3587</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     LegacyScriptPubKeyMan* spkm = GetLegacyScriptPubKeyMan();</span></span>
<span id="L3588"><span class="lineNum">    3588</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     if (spkm &amp;&amp; spkm-&gt;CanProvide(script, sigdata)) spk_mans.insert(spkm);</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L3589"><span class="lineNum">    3589</span>                 :             : </span>
<span id="L3590"><span class="lineNum">    3590</span>                 :<span class="tlaUNC">           0 :     return spk_mans;</span></span>
<span id="L3591"><span class="lineNum">    3591</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L3592"><span class="lineNum">    3592</span>                 :             : </span>
<span id="L3593"><span class="lineNum">    3593</span>                 :<span class="tlaUNC">           0 : ScriptPubKeyMan* CWallet::GetScriptPubKeyMan(const uint256&amp; id) const</span></span>
<span id="L3594"><span class="lineNum">    3594</span>                 :             : {</span>
<span id="L3595"><span class="lineNum">    3595</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (m_spk_managers.count(id) &gt; 0) {</span></span>
<span id="L3596"><span class="lineNum">    3596</span>                 :<span class="tlaUNC">           0 :         return m_spk_managers.at(id).get();</span></span>
<span id="L3597"><span class="lineNum">    3597</span>                 :             :     }</span>
<span id="L3598"><span class="lineNum">    3598</span>                 :             :     return nullptr;</span>
<span id="L3599"><span class="lineNum">    3599</span>                 :             : }</span>
<span id="L3600"><span class="lineNum">    3600</span>                 :             : </span>
<span id="L3601"><span class="lineNum">    3601</span>                 :<span class="tlaUNC">           0 : std::unique_ptr&lt;SigningProvider&gt; CWallet::GetSolvingProvider(const CScript&amp; script) const</span></span>
<span id="L3602"><span class="lineNum">    3602</span>                 :             : {</span>
<span id="L3603"><span class="lineNum">    3603</span>                 :<span class="tlaUNC">           0 :     SignatureData sigdata;</span></span>
<span id="L3604"><span class="lineNum">    3604</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     return GetSolvingProvider(script, sigdata);</span></span>
<span id="L3605"><span class="lineNum">    3605</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L3606"><span class="lineNum">    3606</span>                 :             : </span>
<span id="L3607"><span class="lineNum">    3607</span>                 :<span class="tlaUNC">           0 : std::unique_ptr&lt;SigningProvider&gt; CWallet::GetSolvingProvider(const CScript&amp; script, SignatureData&amp; sigdata) const</span></span>
<span id="L3608"><span class="lineNum">    3608</span>                 :             : {</span>
<span id="L3609"><span class="lineNum">    3609</span>                 :             :     // Search the cache for relevant SPKMs instead of iterating m_spk_managers</span>
<span id="L3610"><span class="lineNum">    3610</span>                 :<span class="tlaUNC">           0 :     const auto&amp; it = m_cached_spks.find(script);</span></span>
<span id="L3611"><span class="lineNum">    3611</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (it != m_cached_spks.end()) {</span></span>
<span id="L3612"><span class="lineNum">    3612</span>                 :             :         // All spkms for a given script must already be able to make a SigningProvider for the script, so just return the first one.</span>
<span id="L3613"><span class="lineNum">    3613</span>                 :<span class="tlaUNC">           0 :         Assume(it-&gt;second.at(0)-&gt;CanProvide(script, sigdata));</span></span>
<span id="L3614"><span class="lineNum">    3614</span>                 :<span class="tlaUNC">           0 :         return it-&gt;second.at(0)-&gt;GetSolvingProvider(script);</span></span>
<span id="L3615"><span class="lineNum">    3615</span>                 :             :     }</span>
<span id="L3616"><span class="lineNum">    3616</span>                 :             : </span>
<span id="L3617"><span class="lineNum">    3617</span>                 :             :     // Legacy wallet</span>
<span id="L3618"><span class="lineNum">    3618</span>                 :<span class="tlaUNC">           0 :     LegacyScriptPubKeyMan* spkm = GetLegacyScriptPubKeyMan();</span></span>
<span id="L3619"><span class="lineNum">    3619</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (spkm &amp;&amp; spkm-&gt;CanProvide(script, sigdata)) return spkm-&gt;GetSolvingProvider(script);</span></span>
<span id="L3620"><span class="lineNum">    3620</span>                 :             : </span>
<span id="L3621"><span class="lineNum">    3621</span>                 :<span class="tlaUNC">           0 :     return nullptr;</span></span>
<span id="L3622"><span class="lineNum">    3622</span>                 :             : }</span>
<span id="L3623"><span class="lineNum">    3623</span>                 :             : </span>
<span id="L3624"><span class="lineNum">    3624</span>                 :<span class="tlaUNC">           0 : std::vector&lt;WalletDescriptor&gt; CWallet::GetWalletDescriptors(const CScript&amp; script) const</span></span>
<span id="L3625"><span class="lineNum">    3625</span>                 :             : {</span>
<span id="L3626"><span class="lineNum">    3626</span>                 :<span class="tlaUNC">           0 :     std::vector&lt;WalletDescriptor&gt; descs;</span></span>
<span id="L3627"><span class="lineNum">    3627</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (const auto spk_man: GetScriptPubKeyMans(script)) {</span></span>
<span id="L3628"><span class="lineNum">    3628</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (const auto desc_spk_man = dynamic_cast&lt;DescriptorScriptPubKeyMan*&gt;(spk_man)) {</span></span>
<span id="L3629"><span class="lineNum">    3629</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             LOCK(desc_spk_man-&gt;cs_desc_man);</span></span>
<span id="L3630"><span class="lineNum">    3630</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             descs.push_back(desc_spk_man-&gt;GetWalletDescriptor());</span></span>
<span id="L3631"><span class="lineNum">    3631</span>                 :<span class="tlaUNC">           0 :         }</span></span>
<span id="L3632"><span class="lineNum">    3632</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L3633"><span class="lineNum">    3633</span>                 :<span class="tlaUNC">           0 :     return descs;</span></span>
<span id="L3634"><span class="lineNum">    3634</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L3635"><span class="lineNum">    3635</span>                 :             : </span>
<span id="L3636"><span class="lineNum">    3636</span>                 :<span class="tlaUNC">           0 : LegacyScriptPubKeyMan* CWallet::GetLegacyScriptPubKeyMan() const</span></span>
<span id="L3637"><span class="lineNum">    3637</span>                 :             : {</span>
<span id="L3638"><span class="lineNum">    3638</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {</span></span>
<span id="L3639"><span class="lineNum">    3639</span>                 :             :         return nullptr;</span>
<span id="L3640"><span class="lineNum">    3640</span>                 :             :     }</span>
<span id="L3641"><span class="lineNum">    3641</span>                 :             :     // Legacy wallets only have one ScriptPubKeyMan which is a LegacyScriptPubKeyMan.</span>
<span id="L3642"><span class="lineNum">    3642</span>                 :             :     // Everything in m_internal_spk_managers and m_external_spk_managers point to the same legacyScriptPubKeyMan.</span>
<span id="L3643"><span class="lineNum">    3643</span>                 :<span class="tlaUNC">           0 :     auto it = m_internal_spk_managers.find(OutputType::LEGACY);</span></span>
<span id="L3644"><span class="lineNum">    3644</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (it == m_internal_spk_managers.end()) return nullptr;</span></span>
<span id="L3645"><span class="lineNum">    3645</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     return dynamic_cast&lt;LegacyScriptPubKeyMan*&gt;(it-&gt;second);</span></span>
<span id="L3646"><span class="lineNum">    3646</span>                 :             : }</span>
<span id="L3647"><span class="lineNum">    3647</span>                 :             : </span>
<span id="L3648"><span class="lineNum">    3648</span>                 :<span class="tlaUNC">           0 : LegacyDataSPKM* CWallet::GetLegacyDataSPKM() const</span></span>
<span id="L3649"><span class="lineNum">    3649</span>                 :             : {</span>
<span id="L3650"><span class="lineNum">    3650</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {</span></span>
<span id="L3651"><span class="lineNum">    3651</span>                 :             :         return nullptr;</span>
<span id="L3652"><span class="lineNum">    3652</span>                 :             :     }</span>
<span id="L3653"><span class="lineNum">    3653</span>                 :<span class="tlaUNC">           0 :     auto it = m_internal_spk_managers.find(OutputType::LEGACY);</span></span>
<span id="L3654"><span class="lineNum">    3654</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (it == m_internal_spk_managers.end()) return nullptr;</span></span>
<span id="L3655"><span class="lineNum">    3655</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     return dynamic_cast&lt;LegacyDataSPKM*&gt;(it-&gt;second);</span></span>
<span id="L3656"><span class="lineNum">    3656</span>                 :             : }</span>
<span id="L3657"><span class="lineNum">    3657</span>                 :             : </span>
<span id="L3658"><span class="lineNum">    3658</span>                 :<span class="tlaUNC">           0 : LegacyScriptPubKeyMan* CWallet::GetOrCreateLegacyScriptPubKeyMan()</span></span>
<span id="L3659"><span class="lineNum">    3659</span>                 :             : {</span>
<span id="L3660"><span class="lineNum">    3660</span>                 :<span class="tlaUNC">           0 :     SetupLegacyScriptPubKeyMan();</span></span>
<span id="L3661"><span class="lineNum">    3661</span>                 :<span class="tlaUNC">           0 :     return GetLegacyScriptPubKeyMan();</span></span>
<span id="L3662"><span class="lineNum">    3662</span>                 :             : }</span>
<span id="L3663"><span class="lineNum">    3663</span>                 :             : </span>
<span id="L3664"><span class="lineNum">    3664</span>                 :<span class="tlaUNC">           0 : void CWallet::AddScriptPubKeyMan(const uint256&amp; id, std::unique_ptr&lt;ScriptPubKeyMan&gt; spkm_man)</span></span>
<span id="L3665"><span class="lineNum">    3665</span>                 :             : {</span>
<span id="L3666"><span class="lineNum">    3666</span>                 :             :     // Add spkm_man to m_spk_managers before calling any method</span>
<span id="L3667"><span class="lineNum">    3667</span>                 :             :     // that might access it.</span>
<span id="L3668"><span class="lineNum">    3668</span>                 :<span class="tlaUNC">           0 :     const auto&amp; spkm = m_spk_managers[id] = std::move(spkm_man);</span></span>
<span id="L3669"><span class="lineNum">    3669</span>                 :             : </span>
<span id="L3670"><span class="lineNum">    3670</span>                 :             :     // Update birth time if needed</span>
<span id="L3671"><span class="lineNum">    3671</span>                 :<span class="tlaUNC">           0 :     MaybeUpdateBirthTime(spkm-&gt;GetTimeFirstKey());</span></span>
<span id="L3672"><span class="lineNum">    3672</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L3673"><span class="lineNum">    3673</span>                 :             : </span>
<span id="L3674"><span class="lineNum">    3674</span>                 :<span class="tlaUNC">           0 : LegacyDataSPKM* CWallet::GetOrCreateLegacyDataSPKM()</span></span>
<span id="L3675"><span class="lineNum">    3675</span>                 :             : {</span>
<span id="L3676"><span class="lineNum">    3676</span>                 :<span class="tlaUNC">           0 :     SetupLegacyScriptPubKeyMan();</span></span>
<span id="L3677"><span class="lineNum">    3677</span>                 :<span class="tlaUNC">           0 :     return GetLegacyDataSPKM();</span></span>
<span id="L3678"><span class="lineNum">    3678</span>                 :             : }</span>
<span id="L3679"><span class="lineNum">    3679</span>                 :             : </span>
<span id="L3680"><span class="lineNum">    3680</span>                 :<span class="tlaUNC">           0 : void CWallet::SetupLegacyScriptPubKeyMan()</span></span>
<span id="L3681"><span class="lineNum">    3681</span>                 :             : {</span>
<span id="L3682"><span class="lineNum">    3682</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     if (!m_internal_spk_managers.empty() || !m_external_spk_managers.empty() || !m_spk_managers.empty() || IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L3683"><span class="lineNum">    3683</span>                 :<span class="tlaUNC">           0 :         return;</span></span>
<span id="L3684"><span class="lineNum">    3684</span>                 :             :     }</span>
<span id="L3685"><span class="lineNum">    3685</span>                 :             : </span>
<span id="L3686"><span class="lineNum">    3686</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     std::unique_ptr&lt;ScriptPubKeyMan&gt; spk_manager = m_database-&gt;Format() == &quot;bdb_ro&quot; ?</span></span>
<span id="L3687"><span class="lineNum">    3687</span>                 :             :         std::make_unique&lt;LegacyDataSPKM&gt;(*this) :</span>
<span id="L3688"><span class="lineNum">    3688</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         std::make_unique&lt;LegacyScriptPubKeyMan&gt;(*this, m_keypool_size);</span></span>
<span id="L3689"><span class="lineNum">    3689</span>                 :             : </span>
<span id="L3690"><span class="lineNum">    3690</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (const auto&amp; type : LEGACY_OUTPUT_TYPES) {</span></span>
<span id="L3691"><span class="lineNum">    3691</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         m_internal_spk_managers[type] = spk_manager.get();</span></span>
<span id="L3692"><span class="lineNum">    3692</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         m_external_spk_managers[type] = spk_manager.get();</span></span>
<span id="L3693"><span class="lineNum">    3693</span>                 :             :     }</span>
<span id="L3694"><span class="lineNum">    3694</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     uint256 id = spk_manager-&gt;GetID();</span></span>
<span id="L3695"><span class="lineNum">    3695</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     AddScriptPubKeyMan(id, std::move(spk_manager));</span></span>
<span id="L3696"><span class="lineNum">    3696</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L3697"><span class="lineNum">    3697</span>                 :             : </span>
<span id="L3698"><span class="lineNum">    3698</span>                 :<span class="tlaUNC">           0 : bool CWallet::WithEncryptionKey(std::function&lt;bool (const CKeyingMaterial&amp;)&gt; cb) const</span></span>
<span id="L3699"><span class="lineNum">    3699</span>                 :             : {</span>
<span id="L3700"><span class="lineNum">    3700</span>                 :<span class="tlaUNC">           0 :     LOCK(cs_wallet);</span></span>
<span id="L3701"><span class="lineNum">    3701</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     return cb(vMasterKey);</span></span>
<span id="L3702"><span class="lineNum">    3702</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L3703"><span class="lineNum">    3703</span>                 :             : </span>
<span id="L3704"><span class="lineNum">    3704</span>                 :<span class="tlaUNC">           0 : bool CWallet::HasEncryptionKeys() const</span></span>
<span id="L3705"><span class="lineNum">    3705</span>                 :             : {</span>
<span id="L3706"><span class="lineNum">    3706</span>                 :<span class="tlaUNC">           0 :     return !mapMasterKeys.empty();</span></span>
<span id="L3707"><span class="lineNum">    3707</span>                 :             : }</span>
<span id="L3708"><span class="lineNum">    3708</span>                 :             : </span>
<span id="L3709"><span class="lineNum">    3709</span>                 :<span class="tlaUNC">           0 : void CWallet::ConnectScriptPubKeyManNotifiers()</span></span>
<span id="L3710"><span class="lineNum">    3710</span>                 :             : {</span>
<span id="L3711"><span class="lineNum">    3711</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (const auto&amp; spk_man : GetActiveScriptPubKeyMans()) {</span></span>
<span id="L3712"><span class="lineNum">    3712</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         spk_man-&gt;NotifyWatchonlyChanged.connect(NotifyWatchonlyChanged);</span></span>
<span id="L3713"><span class="lineNum">    3713</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         spk_man-&gt;NotifyCanGetAddressesChanged.connect(NotifyCanGetAddressesChanged);</span></span>
<span id="L3714"><span class="lineNum">    3714</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         spk_man-&gt;NotifyFirstKeyTimeChanged.connect(std::bind(&amp;CWallet::MaybeUpdateBirthTime, this, std::placeholders::_2));</span></span>
<span id="L3715"><span class="lineNum">    3715</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L3716"><span class="lineNum">    3716</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L3717"><span class="lineNum">    3717</span>                 :             : </span>
<span id="L3718"><span class="lineNum">    3718</span>                 :<span class="tlaUNC">           0 : DescriptorScriptPubKeyMan&amp; CWallet::LoadDescriptorScriptPubKeyMan(uint256 id, WalletDescriptor&amp; desc)</span></span>
<span id="L3719"><span class="lineNum">    3719</span>                 :             : {</span>
<span id="L3720"><span class="lineNum">    3720</span>                 :<span class="tlaUNC">           0 :     DescriptorScriptPubKeyMan* spk_manager;</span></span>
<span id="L3721"><span class="lineNum">    3721</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (IsWalletFlagSet(WALLET_FLAG_EXTERNAL_SIGNER)) {</span></span>
<span id="L3722"><span class="lineNum">    3722</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         spk_manager = new ExternalSignerScriptPubKeyMan(*this, desc, m_keypool_size);</span></span>
<span id="L3723"><span class="lineNum">    3723</span>                 :             :     } else {</span>
<span id="L3724"><span class="lineNum">    3724</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         spk_manager = new DescriptorScriptPubKeyMan(*this, desc, m_keypool_size);</span></span>
<span id="L3725"><span class="lineNum">    3725</span>                 :             :     }</span>
<span id="L3726"><span class="lineNum">    3726</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     AddScriptPubKeyMan(id, std::unique_ptr&lt;ScriptPubKeyMan&gt;(spk_manager));</span></span>
<span id="L3727"><span class="lineNum">    3727</span>                 :<span class="tlaUNC">           0 :     return *spk_manager;</span></span>
<span id="L3728"><span class="lineNum">    3728</span>                 :             : }</span>
<span id="L3729"><span class="lineNum">    3729</span>                 :             : </span>
<span id="L3730"><span class="lineNum">    3730</span>                 :<span class="tlaUNC">           0 : DescriptorScriptPubKeyMan&amp; CWallet::SetupDescriptorScriptPubKeyMan(WalletBatch&amp; batch, const CExtKey&amp; master_key, const OutputType&amp; output_type, bool internal)</span></span>
<span id="L3731"><span class="lineNum">    3731</span>                 :             : {</span>
<span id="L3732"><span class="lineNum">    3732</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L3733"><span class="lineNum">    3733</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     auto spk_manager = std::unique_ptr&lt;DescriptorScriptPubKeyMan&gt;(new DescriptorScriptPubKeyMan(*this, m_keypool_size));</span></span>
<span id="L3734"><span class="lineNum">    3734</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (IsCrypted()) {</span></span>
<span id="L3735"><span class="lineNum">    3735</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (IsLocked()) {</span></span>
<span id="L3736"><span class="lineNum">    3736</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             throw std::runtime_error(std::string(__func__) + &quot;: Wallet is locked, cannot setup new descriptors&quot;);</span></span>
<span id="L3737"><span class="lineNum">    3737</span>                 :             :         }</span>
<span id="L3738"><span class="lineNum">    3738</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         if (!spk_manager-&gt;CheckDecryptionKey(vMasterKey) &amp;&amp; !spk_manager-&gt;Encrypt(vMasterKey, &amp;batch)) {</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L3739"><span class="lineNum">    3739</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             throw std::runtime_error(std::string(__func__) + &quot;: Could not encrypt new descriptors&quot;);</span></span>
<span id="L3740"><span class="lineNum">    3740</span>                 :             :         }</span>
<span id="L3741"><span class="lineNum">    3741</span>                 :             :     }</span>
<span id="L3742"><span class="lineNum">    3742</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     spk_manager-&gt;SetupDescriptorGeneration(batch, master_key, output_type, internal);</span></span>
<span id="L3743"><span class="lineNum">    3743</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     DescriptorScriptPubKeyMan* out = spk_manager.get();</span></span>
<span id="L3744"><span class="lineNum">    3744</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     uint256 id = spk_manager-&gt;GetID();</span></span>
<span id="L3745"><span class="lineNum">    3745</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     AddScriptPubKeyMan(id, std::move(spk_manager));</span></span>
<span id="L3746"><span class="lineNum">    3746</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     AddActiveScriptPubKeyManWithDb(batch, id, output_type, internal);</span></span>
<span id="L3747"><span class="lineNum">    3747</span>                 :<span class="tlaUNC">           0 :     return *out;</span></span>
<span id="L3748"><span class="lineNum">    3748</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L3749"><span class="lineNum">    3749</span>                 :             : </span>
<span id="L3750"><span class="lineNum">    3750</span>                 :<span class="tlaUNC">           0 : void CWallet::SetupDescriptorScriptPubKeyMans(WalletBatch&amp; batch, const CExtKey&amp; master_key)</span></span>
<span id="L3751"><span class="lineNum">    3751</span>                 :             : {</span>
<span id="L3752"><span class="lineNum">    3752</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L3753"><span class="lineNum">    3753</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (bool internal : {false, true}) {</span></span>
<span id="L3754"><span class="lineNum">    3754</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (OutputType t : OUTPUT_TYPES) {</span></span>
<span id="L3755"><span class="lineNum">    3755</span>                 :<span class="tlaUNC">           0 :             SetupDescriptorScriptPubKeyMan(batch, master_key, t, internal);</span></span>
<span id="L3756"><span class="lineNum">    3756</span>                 :             :         }</span>
<span id="L3757"><span class="lineNum">    3757</span>                 :             :     }</span>
<span id="L3758"><span class="lineNum">    3758</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L3759"><span class="lineNum">    3759</span>                 :             : </span>
<span id="L3760"><span class="lineNum">    3760</span>                 :<span class="tlaUNC">           0 : void CWallet::SetupOwnDescriptorScriptPubKeyMans(WalletBatch&amp; batch)</span></span>
<span id="L3761"><span class="lineNum">    3761</span>                 :             : {</span>
<span id="L3762"><span class="lineNum">    3762</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L3763"><span class="lineNum">    3763</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     assert(!IsWalletFlagSet(WALLET_FLAG_EXTERNAL_SIGNER));</span></span>
<span id="L3764"><span class="lineNum">    3764</span>                 :             :     // Make a seed</span>
<span id="L3765"><span class="lineNum">    3765</span>                 :<span class="tlaUNC">           0 :     CKey seed_key = GenerateRandomKey();</span></span>
<span id="L3766"><span class="lineNum">    3766</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     CPubKey seed = seed_key.GetPubKey();</span></span>
<span id="L3767"><span class="lineNum">    3767</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     assert(seed_key.VerifyPubKey(seed));</span></span>
<span id="L3768"><span class="lineNum">    3768</span>                 :             : </span>
<span id="L3769"><span class="lineNum">    3769</span>                 :             :     // Get the extended key</span>
<span id="L3770"><span class="lineNum">    3770</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     CExtKey master_key;</span></span>
<span id="L3771"><span class="lineNum">    3771</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     master_key.SetSeed(seed_key);</span></span>
<span id="L3772"><span class="lineNum">    3772</span>                 :             : </span>
<span id="L3773"><span class="lineNum">    3773</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     SetupDescriptorScriptPubKeyMans(batch, master_key);</span></span>
<span id="L3774"><span class="lineNum">    3774</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L3775"><span class="lineNum">    3775</span>                 :             : </span>
<span id="L3776"><span class="lineNum">    3776</span>                 :<span class="tlaUNC">           0 : void CWallet::SetupDescriptorScriptPubKeyMans()</span></span>
<span id="L3777"><span class="lineNum">    3777</span>                 :             : {</span>
<span id="L3778"><span class="lineNum">    3778</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L3779"><span class="lineNum">    3779</span>                 :             : </span>
<span id="L3780"><span class="lineNum">    3780</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!IsWalletFlagSet(WALLET_FLAG_EXTERNAL_SIGNER)) {</span></span>
<span id="L3781"><span class="lineNum">    3781</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!RunWithinTxn(GetDatabase(), /*process_desc=*/&quot;setup descriptors&quot;, [&amp;](WalletBatch&amp; batch) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet){</span></span>
<span id="L3782"><span class="lineNum">    3782</span>                 :<span class="tlaUNC">           0 :             SetupOwnDescriptorScriptPubKeyMans(batch);</span></span>
<span id="L3783"><span class="lineNum">    3783</span>                 :<span class="tlaUNC">           0 :             return true;</span></span>
<span id="L3784"><span class="lineNum">    3784</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         })) throw std::runtime_error(&quot;Error: cannot process db transaction for descriptors setup&quot;);</span></span>
<span id="L3785"><span class="lineNum">    3785</span>                 :             :     } else {</span>
<span id="L3786"><span class="lineNum">    3786</span>                 :<span class="tlaUNC">           0 :         ExternalSigner signer = ExternalSignerScriptPubKeyMan::GetExternalSigner();</span></span>
<span id="L3787"><span class="lineNum">    3787</span>                 :             : </span>
<span id="L3788"><span class="lineNum">    3788</span>                 :             :         // TODO: add account parameter</span>
<span id="L3789"><span class="lineNum">    3789</span>                 :<span class="tlaUNC">           0 :         int account = 0;</span></span>
<span id="L3790"><span class="lineNum">    3790</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         UniValue signer_res = signer.GetDescriptors(account);</span></span>
<span id="L3791"><span class="lineNum">    3791</span>                 :             : </span>
<span id="L3792"><span class="lineNum">    3792</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         if (!signer_res.isObject()) throw std::runtime_error(std::string(__func__) + &quot;: Unexpected result&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L3793"><span class="lineNum">    3793</span>                 :             : </span>
<span id="L3794"><span class="lineNum">    3794</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         WalletBatch batch(GetDatabase());</span></span>
<span id="L3795"><span class="lineNum">    3795</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         if (!batch.TxnBegin()) throw std::runtime_error(&quot;Error: cannot create db transaction for descriptors import&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L3796"><span class="lineNum">    3796</span>                 :             : </span>
<span id="L3797"><span class="lineNum">    3797</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (bool internal : {false, true}) {</span></span>
<span id="L3798"><span class="lineNum">    3798</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             const UniValue&amp; descriptor_vals = signer_res.find_value(internal ? &quot;internal&quot; : &quot;receive&quot;);</span></span>
<span id="L3799"><span class="lineNum">    3799</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             if (!descriptor_vals.isArray()) throw std::runtime_error(std::string(__func__) + &quot;: Unexpected result&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L3800"><span class="lineNum">    3800</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             for (const UniValue&amp; desc_val : descriptor_vals.get_array().getValues()) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L3801"><span class="lineNum">    3801</span>                 :<span class="tlaUNC">           0 :                 const std::string&amp; desc_str = desc_val.getValStr();</span></span>
<span id="L3802"><span class="lineNum">    3802</span>                 :<span class="tlaUNC">           0 :                 FlatSigningProvider keys;</span></span>
<span id="L3803"><span class="lineNum">    3803</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 std::string desc_error;</span></span>
<span id="L3804"><span class="lineNum">    3804</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 auto descs = Parse(desc_str, keys, desc_error, false);</span></span>
<span id="L3805"><span class="lineNum">    3805</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 if (descs.empty()) {</span></span>
<span id="L3806"><span class="lineNum">    3806</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                     throw std::runtime_error(std::string(__func__) + &quot;: Invalid descriptor \&quot;&quot; + desc_str + &quot;\&quot; (&quot; + desc_error + &quot;)&quot;);</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L3807"><span class="lineNum">    3807</span>                 :             :                 }</span>
<span id="L3808"><span class="lineNum">    3808</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 auto&amp; desc = descs.at(0);</span></span>
<span id="L3809"><span class="lineNum">    3809</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 if (!desc-&gt;GetOutputType()) {</span></span>
<span id="L3810"><span class="lineNum">    3810</span>                 :<span class="tlaUNC">           0 :                     continue;</span></span>
<span id="L3811"><span class="lineNum">    3811</span>                 :             :                 }</span>
<span id="L3812"><span class="lineNum">    3812</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 OutputType t =  *desc-&gt;GetOutputType();</span></span>
<span id="L3813"><span class="lineNum">    3813</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                 auto spk_manager = std::unique_ptr&lt;ExternalSignerScriptPubKeyMan&gt;(new ExternalSignerScriptPubKeyMan(*this, m_keypool_size));</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L3814"><span class="lineNum">    3814</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 spk_manager-&gt;SetupDescriptor(batch, std::move(desc));</span></span>
<span id="L3815"><span class="lineNum">    3815</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 uint256 id = spk_manager-&gt;GetID();</span></span>
<span id="L3816"><span class="lineNum">    3816</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 AddScriptPubKeyMan(id, std::move(spk_manager));</span></span>
<span id="L3817"><span class="lineNum">    3817</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 AddActiveScriptPubKeyManWithDb(batch, id, t, internal);</span></span>
<span id="L3818"><span class="lineNum">    3818</span>                 :<span class="tlaUNC">           0 :             }</span></span>
<span id="L3819"><span class="lineNum">    3819</span>                 :             :         }</span>
<span id="L3820"><span class="lineNum">    3820</span>                 :             : </span>
<span id="L3821"><span class="lineNum">    3821</span>                 :             :         // Ensure imported descriptors are committed to disk</span>
<span id="L3822"><span class="lineNum">    3822</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         if (!batch.TxnCommit()) throw std::runtime_error(&quot;Error: cannot commit db transaction for descriptors import&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L3823"><span class="lineNum">    3823</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L3824"><span class="lineNum">    3824</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L3825"><span class="lineNum">    3825</span>                 :             : </span>
<span id="L3826"><span class="lineNum">    3826</span>                 :<span class="tlaUNC">           0 : void CWallet::AddActiveScriptPubKeyMan(uint256 id, OutputType type, bool internal)</span></span>
<span id="L3827"><span class="lineNum">    3827</span>                 :             : {</span>
<span id="L3828"><span class="lineNum">    3828</span>                 :<span class="tlaUNC">           0 :     WalletBatch batch(GetDatabase());</span></span>
<span id="L3829"><span class="lineNum">    3829</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     return AddActiveScriptPubKeyManWithDb(batch, id, type, internal);</span></span>
<span id="L3830"><span class="lineNum">    3830</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L3831"><span class="lineNum">    3831</span>                 :             : </span>
<span id="L3832"><span class="lineNum">    3832</span>                 :<span class="tlaUNC">           0 : void CWallet::AddActiveScriptPubKeyManWithDb(WalletBatch&amp; batch, uint256 id, OutputType type, bool internal)</span></span>
<span id="L3833"><span class="lineNum">    3833</span>                 :             : {</span>
<span id="L3834"><span class="lineNum">    3834</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!batch.WriteActiveScriptPubKeyMan(static_cast&lt;uint8_t&gt;(type), id, internal)) {</span></span>
<span id="L3835"><span class="lineNum">    3835</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         throw std::runtime_error(std::string(__func__) + &quot;: writing active ScriptPubKeyMan id failed&quot;);</span></span>
<span id="L3836"><span class="lineNum">    3836</span>                 :             :     }</span>
<span id="L3837"><span class="lineNum">    3837</span>                 :<span class="tlaUNC">           0 :     LoadActiveScriptPubKeyMan(id, type, internal);</span></span>
<span id="L3838"><span class="lineNum">    3838</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L3839"><span class="lineNum">    3839</span>                 :             : </span>
<span id="L3840"><span class="lineNum">    3840</span>                 :<span class="tlaUNC">           0 : void CWallet::LoadActiveScriptPubKeyMan(uint256 id, OutputType type, bool internal)</span></span>
<span id="L3841"><span class="lineNum">    3841</span>                 :             : {</span>
<span id="L3842"><span class="lineNum">    3842</span>                 :             :     // Activating ScriptPubKeyManager for a given output and change type is incompatible with legacy wallets.</span>
<span id="L3843"><span class="lineNum">    3843</span>                 :             :     // Legacy wallets have only one ScriptPubKeyManager and it's active for all output and change types.</span>
<span id="L3844"><span class="lineNum">    3844</span>                 :<span class="tlaUNC">           0 :     Assert(IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS));</span></span>
<span id="L3845"><span class="lineNum">    3845</span>                 :             : </span>
<span id="L3846"><span class="lineNum">    3846</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     WalletLogPrintf(&quot;Setting spkMan to active: id = %s, type = %s, internal = %s\n&quot;, id.ToString(), FormatOutputType(type), internal ? &quot;true&quot; : &quot;false&quot;);</span></span>
<span id="L3847"><span class="lineNum">    3847</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     auto&amp; spk_mans = internal ? m_internal_spk_managers : m_external_spk_managers;</span></span>
<span id="L3848"><span class="lineNum">    3848</span>                 :<span class="tlaUNC">           0 :     auto&amp; spk_mans_other = internal ? m_external_spk_managers : m_internal_spk_managers;</span></span>
<span id="L3849"><span class="lineNum">    3849</span>                 :<span class="tlaUNC">           0 :     auto spk_man = m_spk_managers.at(id).get();</span></span>
<span id="L3850"><span class="lineNum">    3850</span>                 :<span class="tlaUNC">           0 :     spk_mans[type] = spk_man;</span></span>
<span id="L3851"><span class="lineNum">    3851</span>                 :             : </span>
<span id="L3852"><span class="lineNum">    3852</span>                 :<span class="tlaUNC">           0 :     const auto it = spk_mans_other.find(type);</span></span>
<span id="L3853"><span class="lineNum">    3853</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (it != spk_mans_other.end() &amp;&amp; it-&gt;second == spk_man) {</span></span>
<span id="L3854"><span class="lineNum">    3854</span>                 :<span class="tlaUNC">           0 :         spk_mans_other.erase(type);</span></span>
<span id="L3855"><span class="lineNum">    3855</span>                 :             :     }</span>
<span id="L3856"><span class="lineNum">    3856</span>                 :             : </span>
<span id="L3857"><span class="lineNum">    3857</span>                 :<span class="tlaUNC">           0 :     NotifyCanGetAddressesChanged();</span></span>
<span id="L3858"><span class="lineNum">    3858</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L3859"><span class="lineNum">    3859</span>                 :             : </span>
<span id="L3860"><span class="lineNum">    3860</span>                 :<span class="tlaUNC">           0 : void CWallet::DeactivateScriptPubKeyMan(uint256 id, OutputType type, bool internal)</span></span>
<span id="L3861"><span class="lineNum">    3861</span>                 :             : {</span>
<span id="L3862"><span class="lineNum">    3862</span>                 :<span class="tlaUNC">           0 :     auto spk_man = GetScriptPubKeyMan(type, internal);</span></span>
<span id="L3863"><span class="lineNum">    3863</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (spk_man != nullptr &amp;&amp; spk_man-&gt;GetID() == id) {</span></span>
<span id="L3864"><span class="lineNum">    3864</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         WalletLogPrintf(&quot;Deactivate spkMan: id = %s, type = %s, internal = %s\n&quot;, id.ToString(), FormatOutputType(type), internal ? &quot;true&quot; : &quot;false&quot;);</span></span>
<span id="L3865"><span class="lineNum">    3865</span>                 :<span class="tlaUNC">           0 :         WalletBatch batch(GetDatabase());</span></span>
<span id="L3866"><span class="lineNum">    3866</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!batch.EraseActiveScriptPubKeyMan(static_cast&lt;uint8_t&gt;(type), internal)) {</span></span>
<span id="L3867"><span class="lineNum">    3867</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             throw std::runtime_error(std::string(__func__) + &quot;: erasing active ScriptPubKeyMan id failed&quot;);</span></span>
<span id="L3868"><span class="lineNum">    3868</span>                 :             :         }</span>
<span id="L3869"><span class="lineNum">    3869</span>                 :             : </span>
<span id="L3870"><span class="lineNum">    3870</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         auto&amp; spk_mans = internal ? m_internal_spk_managers : m_external_spk_managers;</span></span>
<span id="L3871"><span class="lineNum">    3871</span>                 :<span class="tlaUNC">           0 :         spk_mans.erase(type);</span></span>
<span id="L3872"><span class="lineNum">    3872</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L3873"><span class="lineNum">    3873</span>                 :             : </span>
<span id="L3874"><span class="lineNum">    3874</span>                 :<span class="tlaUNC">           0 :     NotifyCanGetAddressesChanged();</span></span>
<span id="L3875"><span class="lineNum">    3875</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L3876"><span class="lineNum">    3876</span>                 :             : </span>
<span id="L3877"><span class="lineNum">    3877</span>                 :<span class="tlaUNC">           0 : bool CWallet::IsLegacy() const</span></span>
<span id="L3878"><span class="lineNum">    3878</span>                 :             : {</span>
<span id="L3879"><span class="lineNum">    3879</span>                 :<span class="tlaUNC">           0 :     return !IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS);</span></span>
<span id="L3880"><span class="lineNum">    3880</span>                 :             : }</span>
<span id="L3881"><span class="lineNum">    3881</span>                 :             : </span>
<span id="L3882"><span class="lineNum">    3882</span>                 :<span class="tlaUNC">           0 : DescriptorScriptPubKeyMan* CWallet::GetDescriptorScriptPubKeyMan(const WalletDescriptor&amp; desc) const</span></span>
<span id="L3883"><span class="lineNum">    3883</span>                 :             : {</span>
<span id="L3884"><span class="lineNum">    3884</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (auto&amp; spk_man_pair : m_spk_managers) {</span></span>
<span id="L3885"><span class="lineNum">    3885</span>                 :             :         // Try to downcast to DescriptorScriptPubKeyMan then check if the descriptors match</span>
<span id="L3886"><span class="lineNum">    3886</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         DescriptorScriptPubKeyMan* spk_manager = dynamic_cast&lt;DescriptorScriptPubKeyMan*&gt;(spk_man_pair.second.get());</span></span>
<span id="L3887"><span class="lineNum">    3887</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (spk_manager != nullptr &amp;&amp; spk_manager-&gt;HasWalletDescriptor(desc)) {</span></span>
<span id="L3888"><span class="lineNum">    3888</span>                 :             :             return spk_manager;</span>
<span id="L3889"><span class="lineNum">    3889</span>                 :             :         }</span>
<span id="L3890"><span class="lineNum">    3890</span>                 :             :     }</span>
<span id="L3891"><span class="lineNum">    3891</span>                 :             : </span>
<span id="L3892"><span class="lineNum">    3892</span>                 :             :     return nullptr;</span>
<span id="L3893"><span class="lineNum">    3893</span>                 :             : }</span>
<span id="L3894"><span class="lineNum">    3894</span>                 :             : </span>
<span id="L3895"><span class="lineNum">    3895</span>                 :<span class="tlaUNC">           0 : std::optional&lt;bool&gt; CWallet::IsInternalScriptPubKeyMan(ScriptPubKeyMan* spk_man) const</span></span>
<span id="L3896"><span class="lineNum">    3896</span>                 :             : {</span>
<span id="L3897"><span class="lineNum">    3897</span>                 :             :     // Legacy script pubkey man can't be either external or internal</span>
<span id="L3898"><span class="lineNum">    3898</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (IsLegacy()) {</span></span>
<span id="L3899"><span class="lineNum">    3899</span>                 :<span class="tlaUNC">           0 :         return std::nullopt;</span></span>
<span id="L3900"><span class="lineNum">    3900</span>                 :             :     }</span>
<span id="L3901"><span class="lineNum">    3901</span>                 :             : </span>
<span id="L3902"><span class="lineNum">    3902</span>                 :             :     // only active ScriptPubKeyMan can be internal</span>
<span id="L3903"><span class="lineNum">    3903</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!GetActiveScriptPubKeyMans().count(spk_man)) {</span></span>
<span id="L3904"><span class="lineNum">    3904</span>                 :<span class="tlaUNC">           0 :         return std::nullopt;</span></span>
<span id="L3905"><span class="lineNum">    3905</span>                 :             :     }</span>
<span id="L3906"><span class="lineNum">    3906</span>                 :             : </span>
<span id="L3907"><span class="lineNum">    3907</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     const auto desc_spk_man = dynamic_cast&lt;DescriptorScriptPubKeyMan*&gt;(spk_man);</span></span>
<span id="L3908"><span class="lineNum">    3908</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!desc_spk_man) {</span></span>
<span id="L3909"><span class="lineNum">    3909</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         throw std::runtime_error(std::string(__func__) + &quot;: unexpected ScriptPubKeyMan type.&quot;);</span></span>
<span id="L3910"><span class="lineNum">    3910</span>                 :             :     }</span>
<span id="L3911"><span class="lineNum">    3911</span>                 :             : </span>
<span id="L3912"><span class="lineNum">    3912</span>                 :<span class="tlaUNC">           0 :     LOCK(desc_spk_man-&gt;cs_desc_man);</span></span>
<span id="L3913"><span class="lineNum">    3913</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     const auto&amp; type = desc_spk_man-&gt;GetWalletDescriptor().descriptor-&gt;GetOutputType();</span></span>
<span id="L3914"><span class="lineNum">    3914</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     assert(type.has_value());</span></span>
<span id="L3915"><span class="lineNum">    3915</span>                 :             : </span>
<span id="L3916"><span class="lineNum">    3916</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     return GetScriptPubKeyMan(*type, /* internal= */ true) == desc_spk_man;</span></span>
<span id="L3917"><span class="lineNum">    3917</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L3918"><span class="lineNum">    3918</span>                 :             : </span>
<span id="L3919"><span class="lineNum">    3919</span>                 :<span class="tlaUNC">           0 : ScriptPubKeyMan* CWallet::AddWalletDescriptor(WalletDescriptor&amp; desc, const FlatSigningProvider&amp; signing_provider, const std::string&amp; label, bool internal)</span></span>
<span id="L3920"><span class="lineNum">    3920</span>                 :             : {</span>
<span id="L3921"><span class="lineNum">    3921</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L3922"><span class="lineNum">    3922</span>                 :             : </span>
<span id="L3923"><span class="lineNum">    3923</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {</span></span>
<span id="L3924"><span class="lineNum">    3924</span>                 :<span class="tlaUNC">           0 :         WalletLogPrintf(&quot;Cannot add WalletDescriptor to a non-descriptor wallet\n&quot;);</span></span>
<span id="L3925"><span class="lineNum">    3925</span>                 :<span class="tlaUNC">           0 :         return nullptr;</span></span>
<span id="L3926"><span class="lineNum">    3926</span>                 :             :     }</span>
<span id="L3927"><span class="lineNum">    3927</span>                 :             : </span>
<span id="L3928"><span class="lineNum">    3928</span>                 :<span class="tlaUNC">           0 :     auto spk_man = GetDescriptorScriptPubKeyMan(desc);</span></span>
<span id="L3929"><span class="lineNum">    3929</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (spk_man) {</span></span>
<span id="L3930"><span class="lineNum">    3930</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         WalletLogPrintf(&quot;Update existing descriptor: %s\n&quot;, desc.descriptor-&gt;ToString());</span></span>
<span id="L3931"><span class="lineNum">    3931</span>                 :<span class="tlaUNC">           0 :         spk_man-&gt;UpdateWalletDescriptor(desc);</span></span>
<span id="L3932"><span class="lineNum">    3932</span>                 :             :     } else {</span>
<span id="L3933"><span class="lineNum">    3933</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         auto new_spk_man = std::unique_ptr&lt;DescriptorScriptPubKeyMan&gt;(new DescriptorScriptPubKeyMan(*this, desc, m_keypool_size));</span></span>
<span id="L3934"><span class="lineNum">    3934</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         spk_man = new_spk_man.get();</span></span>
<span id="L3935"><span class="lineNum">    3935</span>                 :             : </span>
<span id="L3936"><span class="lineNum">    3936</span>                 :             :         // Save the descriptor to memory</span>
<span id="L3937"><span class="lineNum">    3937</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         uint256 id = new_spk_man-&gt;GetID();</span></span>
<span id="L3938"><span class="lineNum">    3938</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         AddScriptPubKeyMan(id, std::move(new_spk_man));</span></span>
<span id="L3939"><span class="lineNum">    3939</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L3940"><span class="lineNum">    3940</span>                 :             : </span>
<span id="L3941"><span class="lineNum">    3941</span>                 :             :     // Add the private keys to the descriptor</span>
<span id="L3942"><span class="lineNum">    3942</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (const auto&amp; entry : signing_provider.keys) {</span></span>
<span id="L3943"><span class="lineNum">    3943</span>                 :<span class="tlaUNC">           0 :         const CKey&amp; key = entry.second;</span></span>
<span id="L3944"><span class="lineNum">    3944</span>                 :<span class="tlaUNC">           0 :         spk_man-&gt;AddDescriptorKey(key, key.GetPubKey());</span></span>
<span id="L3945"><span class="lineNum">    3945</span>                 :             :     }</span>
<span id="L3946"><span class="lineNum">    3946</span>                 :             : </span>
<span id="L3947"><span class="lineNum">    3947</span>                 :             :     // Top up key pool, the manager will generate new scriptPubKeys internally</span>
<span id="L3948"><span class="lineNum">    3948</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!spk_man-&gt;TopUp()) {</span></span>
<span id="L3949"><span class="lineNum">    3949</span>                 :<span class="tlaUNC">           0 :         WalletLogPrintf(&quot;Could not top up scriptPubKeys\n&quot;);</span></span>
<span id="L3950"><span class="lineNum">    3950</span>                 :<span class="tlaUNC">           0 :         return nullptr;</span></span>
<span id="L3951"><span class="lineNum">    3951</span>                 :             :     }</span>
<span id="L3952"><span class="lineNum">    3952</span>                 :             : </span>
<span id="L3953"><span class="lineNum">    3953</span>                 :             :     // Apply the label if necessary</span>
<span id="L3954"><span class="lineNum">    3954</span>                 :             :     // Note: we disable labels for ranged descriptors</span>
<span id="L3955"><span class="lineNum">    3955</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!desc.descriptor-&gt;IsRange()) {</span></span>
<span id="L3956"><span class="lineNum">    3956</span>                 :<span class="tlaUNC">           0 :         auto script_pub_keys = spk_man-&gt;GetScriptPubKeys();</span></span>
<span id="L3957"><span class="lineNum">    3957</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (script_pub_keys.empty()) {</span></span>
<span id="L3958"><span class="lineNum">    3958</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             WalletLogPrintf(&quot;Could not generate scriptPubKeys (cache is empty)\n&quot;);</span></span>
<span id="L3959"><span class="lineNum">    3959</span>                 :<span class="tlaUNC">           0 :             return nullptr;</span></span>
<span id="L3960"><span class="lineNum">    3960</span>                 :             :         }</span>
<span id="L3961"><span class="lineNum">    3961</span>                 :             : </span>
<span id="L3962"><span class="lineNum">    3962</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!internal) {</span></span>
<span id="L3963"><span class="lineNum">    3963</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             for (const auto&amp; script : script_pub_keys) {</span></span>
<span id="L3964"><span class="lineNum">    3964</span>                 :<span class="tlaUNC">           0 :                 CTxDestination dest;</span></span>
<span id="L3965"><span class="lineNum">    3965</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 if (ExtractDestination(script, dest)) {</span></span>
<span id="L3966"><span class="lineNum">    3966</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     SetAddressBook(dest, label, AddressPurpose::RECEIVE);</span></span>
<span id="L3967"><span class="lineNum">    3967</span>                 :             :                 }</span>
<span id="L3968"><span class="lineNum">    3968</span>                 :<span class="tlaUNC">           0 :             }</span></span>
<span id="L3969"><span class="lineNum">    3969</span>                 :             :         }</span>
<span id="L3970"><span class="lineNum">    3970</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L3971"><span class="lineNum">    3971</span>                 :             : </span>
<span id="L3972"><span class="lineNum">    3972</span>                 :             :     // Save the descriptor to DB</span>
<span id="L3973"><span class="lineNum">    3973</span>                 :<span class="tlaUNC">           0 :     spk_man-&gt;WriteDescriptor();</span></span>
<span id="L3974"><span class="lineNum">    3974</span>                 :             : </span>
<span id="L3975"><span class="lineNum">    3975</span>                 :<span class="tlaUNC">           0 :     return spk_man;</span></span>
<span id="L3976"><span class="lineNum">    3976</span>                 :             : }</span>
<span id="L3977"><span class="lineNum">    3977</span>                 :             : </span>
<span id="L3978"><span class="lineNum">    3978</span>                 :<span class="tlaUNC">           0 : bool CWallet::MigrateToSQLite(bilingual_str&amp; error)</span></span>
<span id="L3979"><span class="lineNum">    3979</span>                 :             : {</span>
<span id="L3980"><span class="lineNum">    3980</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L3981"><span class="lineNum">    3981</span>                 :             : </span>
<span id="L3982"><span class="lineNum">    3982</span>                 :<span class="tlaUNC">           0 :     WalletLogPrintf(&quot;Migrating wallet storage database from BerkeleyDB to SQLite.\n&quot;);</span></span>
<span id="L3983"><span class="lineNum">    3983</span>                 :             : </span>
<span id="L3984"><span class="lineNum">    3984</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (m_database-&gt;Format() == &quot;sqlite&quot;) {</span></span>
<span id="L3985"><span class="lineNum">    3985</span>                 :<span class="tlaUNC">           0 :         error = _(&quot;Error: This wallet already uses SQLite&quot;);</span></span>
<span id="L3986"><span class="lineNum">    3986</span>                 :<span class="tlaUNC">           0 :         return false;</span></span>
<span id="L3987"><span class="lineNum">    3987</span>                 :             :     }</span>
<span id="L3988"><span class="lineNum">    3988</span>                 :             : </span>
<span id="L3989"><span class="lineNum">    3989</span>                 :             :     // Get all of the records for DB type migration</span>
<span id="L3990"><span class="lineNum">    3990</span>                 :<span class="tlaUNC">           0 :     std::unique_ptr&lt;DatabaseBatch&gt; batch = m_database-&gt;MakeBatch();</span></span>
<span id="L3991"><span class="lineNum">    3991</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     std::unique_ptr&lt;DatabaseCursor&gt; cursor = batch-&gt;GetNewCursor();</span></span>
<span id="L3992"><span class="lineNum">    3992</span>                 :<span class="tlaUNC">           0 :     std::vector&lt;std::pair&lt;SerializeData, SerializeData&gt;&gt; records;</span></span>
<span id="L3993"><span class="lineNum">    3993</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!cursor) {</span></span>
<span id="L3994"><span class="lineNum">    3994</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         error = _(&quot;Error: Unable to begin reading all records in the database&quot;);</span></span>
<span id="L3995"><span class="lineNum">    3995</span>                 :<span class="tlaUNC">           0 :         return false;</span></span>
<span id="L3996"><span class="lineNum">    3996</span>                 :             :     }</span>
<span id="L3997"><span class="lineNum">    3997</span>                 :<span class="tlaUNC">           0 :     DatabaseCursor::Status status = DatabaseCursor::Status::FAIL;</span></span>
<span id="L3998"><span class="lineNum">    3998</span>                 :<span class="tlaUNC">           0 :     while (true) {</span></span>
<span id="L3999"><span class="lineNum">    3999</span>                 :<span class="tlaUNC">           0 :         DataStream ss_key{};</span></span>
<span id="L4000"><span class="lineNum">    4000</span>                 :<span class="tlaUNC">           0 :         DataStream ss_value{};</span></span>
<span id="L4001"><span class="lineNum">    4001</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         status = cursor-&gt;Next(ss_key, ss_value);</span></span>
<span id="L4002"><span class="lineNum">    4002</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (status != DatabaseCursor::Status::MORE) {</span></span>
<span id="L4003"><span class="lineNum">    4003</span>                 :             :             break;</span>
<span id="L4004"><span class="lineNum">    4004</span>                 :             :         }</span>
<span id="L4005"><span class="lineNum">    4005</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         SerializeData key(ss_key.begin(), ss_key.end());</span></span>
<span id="L4006"><span class="lineNum">    4006</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         SerializeData value(ss_value.begin(), ss_value.end());</span></span>
<span id="L4007"><span class="lineNum">    4007</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         records.emplace_back(key, value);</span></span>
<span id="L4008"><span class="lineNum">    4008</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L4009"><span class="lineNum">    4009</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     cursor.reset();</span></span>
<span id="L4010"><span class="lineNum">    4010</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     batch.reset();</span></span>
<span id="L4011"><span class="lineNum">    4011</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (status != DatabaseCursor::Status::DONE) {</span></span>
<span id="L4012"><span class="lineNum">    4012</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         error = _(&quot;Error: Unable to read all records in the database&quot;);</span></span>
<span id="L4013"><span class="lineNum">    4013</span>                 :<span class="tlaUNC">           0 :         return false;</span></span>
<span id="L4014"><span class="lineNum">    4014</span>                 :             :     }</span>
<span id="L4015"><span class="lineNum">    4015</span>                 :             : </span>
<span id="L4016"><span class="lineNum">    4016</span>                 :             :     // Close this database and delete the file</span>
<span id="L4017"><span class="lineNum">    4017</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     fs::path db_path = fs::PathFromString(m_database-&gt;Filename());</span></span>
<span id="L4018"><span class="lineNum">    4018</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     m_database-&gt;Close();</span></span>
<span id="L4019"><span class="lineNum">    4019</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     fs::remove(db_path);</span></span>
<span id="L4020"><span class="lineNum">    4020</span>                 :             : </span>
<span id="L4021"><span class="lineNum">    4021</span>                 :             :     // Generate the path for the location of the migrated wallet</span>
<span id="L4022"><span class="lineNum">    4022</span>                 :             :     // Wallets that are plain files rather than wallet directories will be migrated to be wallet directories.</span>
<span id="L4023"><span class="lineNum">    4023</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     const fs::path wallet_path = fsbridge::AbsPathJoin(GetWalletDir(), fs::PathFromString(m_name));</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L4024"><span class="lineNum">    4024</span>                 :             : </span>
<span id="L4025"><span class="lineNum">    4025</span>                 :             :     // Make new DB</span>
<span id="L4026"><span class="lineNum">    4026</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     DatabaseOptions opts;</span></span>
<span id="L4027"><span class="lineNum">    4027</span>                 :<span class="tlaUNC">           0 :     opts.require_create = true;</span></span>
<span id="L4028"><span class="lineNum">    4028</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     opts.require_format = DatabaseFormat::SQLITE;</span></span>
<span id="L4029"><span class="lineNum">    4029</span>                 :<span class="tlaUNC">           0 :     DatabaseStatus db_status;</span></span>
<span id="L4030"><span class="lineNum">    4030</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     std::unique_ptr&lt;WalletDatabase&gt; new_db = MakeDatabase(wallet_path, opts, db_status, error);</span></span>
<span id="L4031"><span class="lineNum">    4031</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     assert(new_db); // This is to prevent doing anything further with this wallet. The original file was deleted, but a backup exists.</span></span>
<span id="L4032"><span class="lineNum">    4032</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     m_database.reset();</span></span>
<span id="L4033"><span class="lineNum">    4033</span>                 :<span class="tlaUNC">           0 :     m_database = std::move(new_db);</span></span>
<span id="L4034"><span class="lineNum">    4034</span>                 :             : </span>
<span id="L4035"><span class="lineNum">    4035</span>                 :             :     // Write existing records into the new DB</span>
<span id="L4036"><span class="lineNum">    4036</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     batch = m_database-&gt;MakeBatch();</span></span>
<span id="L4037"><span class="lineNum">    4037</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     bool began = batch-&gt;TxnBegin();</span></span>
<span id="L4038"><span class="lineNum">    4038</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     assert(began); // This is a critical error, the new db could not be written to. The original db exists as a backup, but we should not continue execution.</span></span>
<span id="L4039"><span class="lineNum">    4039</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (const auto&amp; [key, value] : records) {</span></span>
<span id="L4040"><span class="lineNum">    4040</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!batch-&gt;Write(Span{key}, Span{value})) {</span></span>
<span id="L4041"><span class="lineNum">    4041</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             batch-&gt;TxnAbort();</span></span>
<span id="L4042"><span class="lineNum">    4042</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             m_database-&gt;Close();</span></span>
<span id="L4043"><span class="lineNum">    4043</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             fs::remove(m_database-&gt;Filename());</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L4044"><span class="lineNum">    4044</span>                 :<span class="tlaUNC">           0 :             assert(false); // This is a critical error, the new db could not be written to. The original db exists as a backup, but we should not continue execution.</span></span>
<span id="L4045"><span class="lineNum">    4045</span>                 :             :         }</span>
<span id="L4046"><span class="lineNum">    4046</span>                 :             :     }</span>
<span id="L4047"><span class="lineNum">    4047</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     bool committed = batch-&gt;TxnCommit();</span></span>
<span id="L4048"><span class="lineNum">    4048</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     assert(committed); // This is a critical error, the new db could not be written to. The original db exists as a backup, but we should not continue execution.</span></span>
<span id="L4049"><span class="lineNum">    4049</span>                 :<span class="tlaUNC">           0 :     return true;</span></span>
<span id="L4050"><span class="lineNum">    4050</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L4051"><span class="lineNum">    4051</span>                 :             : </span>
<span id="L4052"><span class="lineNum">    4052</span>                 :<span class="tlaUNC">           0 : std::optional&lt;MigrationData&gt; CWallet::GetDescriptorsForLegacy(bilingual_str&amp; error) const</span></span>
<span id="L4053"><span class="lineNum">    4053</span>                 :             : {</span>
<span id="L4054"><span class="lineNum">    4054</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L4055"><span class="lineNum">    4055</span>                 :             : </span>
<span id="L4056"><span class="lineNum">    4056</span>                 :<span class="tlaUNC">           0 :     LegacyDataSPKM* legacy_spkm = GetLegacyDataSPKM();</span></span>
<span id="L4057"><span class="lineNum">    4057</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!Assume(legacy_spkm)) {</span></span>
<span id="L4058"><span class="lineNum">    4058</span>                 :             :         // This shouldn't happen</span>
<span id="L4059"><span class="lineNum">    4059</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         error = Untranslated(STR_INTERNAL_BUG(&quot;Error: Legacy wallet data missing&quot;));</span></span>
<span id="L4060"><span class="lineNum">    4060</span>                 :<span class="tlaUNC">           0 :         return std::nullopt;</span></span>
<span id="L4061"><span class="lineNum">    4061</span>                 :             :     }</span>
<span id="L4062"><span class="lineNum">    4062</span>                 :             : </span>
<span id="L4063"><span class="lineNum">    4063</span>                 :<span class="tlaUNC">           0 :     std::optional&lt;MigrationData&gt; res = legacy_spkm-&gt;MigrateToDescriptor();</span></span>
<span id="L4064"><span class="lineNum">    4064</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (res == std::nullopt) {</span></span>
<span id="L4065"><span class="lineNum">    4065</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         error = _(&quot;Error: Unable to produce descriptors for this legacy wallet. Make sure to provide the wallet's passphrase if it is encrypted.&quot;);</span></span>
<span id="L4066"><span class="lineNum">    4066</span>                 :<span class="tlaUNC">           0 :         return std::nullopt;</span></span>
<span id="L4067"><span class="lineNum">    4067</span>                 :             :     }</span>
<span id="L4068"><span class="lineNum">    4068</span>                 :<span class="tlaUNC">           0 :     return res;</span></span>
<span id="L4069"><span class="lineNum">    4069</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L4070"><span class="lineNum">    4070</span>                 :             : </span>
<span id="L4071"><span class="lineNum">    4071</span>                 :<span class="tlaUNC">           0 : util::Result&lt;void&gt; CWallet::ApplyMigrationData(WalletBatch&amp; local_wallet_batch, MigrationData&amp; data)</span></span>
<span id="L4072"><span class="lineNum">    4072</span>                 :             : {</span>
<span id="L4073"><span class="lineNum">    4073</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L4074"><span class="lineNum">    4074</span>                 :             : </span>
<span id="L4075"><span class="lineNum">    4075</span>                 :<span class="tlaUNC">           0 :     LegacyDataSPKM* legacy_spkm = GetLegacyDataSPKM();</span></span>
<span id="L4076"><span class="lineNum">    4076</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!Assume(legacy_spkm)) {</span></span>
<span id="L4077"><span class="lineNum">    4077</span>                 :             :         // This shouldn't happen</span>
<span id="L4078"><span class="lineNum">    4078</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         return util::Error{Untranslated(STR_INTERNAL_BUG(&quot;Error: Legacy wallet data missing&quot;))};</span></span>
<span id="L4079"><span class="lineNum">    4079</span>                 :             :     }</span>
<span id="L4080"><span class="lineNum">    4080</span>                 :             : </span>
<span id="L4081"><span class="lineNum">    4081</span>                 :             :     // Get all invalid or non-watched scripts that will not be migrated</span>
<span id="L4082"><span class="lineNum">    4082</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     std::set&lt;CTxDestination&gt; not_migrated_dests;</span></span>
<span id="L4083"><span class="lineNum">    4083</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (const auto&amp; script : legacy_spkm-&gt;GetNotMineScriptPubKeys()) {</span></span>
<span id="L4084"><span class="lineNum">    4084</span>                 :<span class="tlaUNC">           0 :         CTxDestination dest;</span></span>
<span id="L4085"><span class="lineNum">    4085</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         if (ExtractDestination(script, dest)) not_migrated_dests.emplace(dest);</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L4086"><span class="lineNum">    4086</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L4087"><span class="lineNum">    4087</span>                 :             : </span>
<span id="L4088"><span class="lineNum">    4088</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     Assume(!m_cached_spks.empty());</span></span>
<span id="L4089"><span class="lineNum">    4089</span>                 :             : </span>
<span id="L4090"><span class="lineNum">    4090</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (auto&amp; desc_spkm : data.desc_spkms) {</span></span>
<span id="L4091"><span class="lineNum">    4091</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (m_spk_managers.count(desc_spkm-&gt;GetID()) &gt; 0) {</span></span>
<span id="L4092"><span class="lineNum">    4092</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             return util::Error{_(&quot;Error: Duplicate descriptors created during migration. Your wallet may be corrupted.&quot;)};</span></span>
<span id="L4093"><span class="lineNum">    4093</span>                 :             :         }</span>
<span id="L4094"><span class="lineNum">    4094</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         uint256 id = desc_spkm-&gt;GetID();</span></span>
<span id="L4095"><span class="lineNum">    4095</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         AddScriptPubKeyMan(id, std::move(desc_spkm));</span></span>
<span id="L4096"><span class="lineNum">    4096</span>                 :             :     }</span>
<span id="L4097"><span class="lineNum">    4097</span>                 :             : </span>
<span id="L4098"><span class="lineNum">    4098</span>                 :             :     // Remove the LegacyScriptPubKeyMan from disk</span>
<span id="L4099"><span class="lineNum">    4099</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!legacy_spkm-&gt;DeleteRecordsWithDB(local_wallet_batch)) {</span></span>
<span id="L4100"><span class="lineNum">    4100</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         return util::Error{_(&quot;Error: cannot remove legacy wallet records&quot;)};</span></span>
<span id="L4101"><span class="lineNum">    4101</span>                 :             :     }</span>
<span id="L4102"><span class="lineNum">    4102</span>                 :             : </span>
<span id="L4103"><span class="lineNum">    4103</span>                 :             :     // Remove the LegacyScriptPubKeyMan from memory</span>
<span id="L4104"><span class="lineNum">    4104</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     m_spk_managers.erase(legacy_spkm-&gt;GetID());</span></span>
<span id="L4105"><span class="lineNum">    4105</span>                 :<span class="tlaUNC">           0 :     m_external_spk_managers.clear();</span></span>
<span id="L4106"><span class="lineNum">    4106</span>                 :<span class="tlaUNC">           0 :     m_internal_spk_managers.clear();</span></span>
<span id="L4107"><span class="lineNum">    4107</span>                 :             : </span>
<span id="L4108"><span class="lineNum">    4108</span>                 :             :     // Setup new descriptors</span>
<span id="L4109"><span class="lineNum">    4109</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     SetWalletFlagWithDB(local_wallet_batch, WALLET_FLAG_DESCRIPTORS);</span></span>
<span id="L4110"><span class="lineNum">    4110</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS)) {</span></span>
<span id="L4111"><span class="lineNum">    4111</span>                 :             :         // Use the existing master key if we have it</span>
<span id="L4112"><span class="lineNum">    4112</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (data.master_key.key.IsValid()) {</span></span>
<span id="L4113"><span class="lineNum">    4113</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             SetupDescriptorScriptPubKeyMans(local_wallet_batch, data.master_key);</span></span>
<span id="L4114"><span class="lineNum">    4114</span>                 :             :         } else {</span>
<span id="L4115"><span class="lineNum">    4115</span>                 :             :             // Setup with a new seed if we don't.</span>
<span id="L4116"><span class="lineNum">    4116</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             SetupOwnDescriptorScriptPubKeyMans(local_wallet_batch);</span></span>
<span id="L4117"><span class="lineNum">    4117</span>                 :             :         }</span>
<span id="L4118"><span class="lineNum">    4118</span>                 :             :     }</span>
<span id="L4119"><span class="lineNum">    4119</span>                 :             : </span>
<span id="L4120"><span class="lineNum">    4120</span>                 :             :     // Get best block locator so that we can copy it to the watchonly and solvables</span>
<span id="L4121"><span class="lineNum">    4121</span>                 :<span class="tlaUNC">           0 :     CBlockLocator best_block_locator;</span></span>
<span id="L4122"><span class="lineNum">    4122</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!local_wallet_batch.ReadBestBlock(best_block_locator)) {</span></span>
<span id="L4123"><span class="lineNum">    4123</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         return util::Error{_(&quot;Error: Unable to read wallet's best block locator record&quot;)};</span></span>
<span id="L4124"><span class="lineNum">    4124</span>                 :             :     }</span>
<span id="L4125"><span class="lineNum">    4125</span>                 :             : </span>
<span id="L4126"><span class="lineNum">    4126</span>                 :             :     // Check if the transactions in the wallet are still ours. Either they belong here, or they belong in the watchonly wallet.</span>
<span id="L4127"><span class="lineNum">    4127</span>                 :             :     // We need to go through these in the tx insertion order so that lookups to spends works.</span>
<span id="L4128"><span class="lineNum">    4128</span>                 :<span class="tlaUNC">           0 :     std::vector&lt;uint256&gt; txids_to_delete;</span></span>
<span id="L4129"><span class="lineNum">    4129</span>                 :<span class="tlaUNC">           0 :     std::unique_ptr&lt;WalletBatch&gt; watchonly_batch;</span></span>
<span id="L4130"><span class="lineNum">    4130</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (data.watchonly_wallet) {</span></span>
<span id="L4131"><span class="lineNum">    4131</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         watchonly_batch = std::make_unique&lt;WalletBatch&gt;(data.watchonly_wallet-&gt;GetDatabase());</span></span>
<span id="L4132"><span class="lineNum">    4132</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         if (!watchonly_batch-&gt;TxnBegin()) return util::Error{strprintf(_(&quot;Error: database transaction cannot be executed for wallet %s&quot;), data.watchonly_wallet-&gt;GetName())};</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L4133"><span class="lineNum">    4133</span>                 :             :         // Copy the next tx order pos to the watchonly wallet</span>
<span id="L4134"><span class="lineNum">    4134</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LOCK(data.watchonly_wallet-&gt;cs_wallet);</span></span>
<span id="L4135"><span class="lineNum">    4135</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         data.watchonly_wallet-&gt;nOrderPosNext = nOrderPosNext;</span></span>
<span id="L4136"><span class="lineNum">    4136</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         watchonly_batch-&gt;WriteOrderPosNext(data.watchonly_wallet-&gt;nOrderPosNext);</span></span>
<span id="L4137"><span class="lineNum">    4137</span>                 :             :         // Write the best block locator to avoid rescanning on reload</span>
<span id="L4138"><span class="lineNum">    4138</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!watchonly_batch-&gt;WriteBestBlock(best_block_locator)) {</span></span>
<span id="L4139"><span class="lineNum">    4139</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             return util::Error{_(&quot;Error: Unable to write watchonly wallet best block locator record&quot;)};</span></span>
<span id="L4140"><span class="lineNum">    4140</span>                 :             :         }</span>
<span id="L4141"><span class="lineNum">    4141</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L4142"><span class="lineNum">    4142</span>                 :<span class="tlaUNC">           0 :     std::unique_ptr&lt;WalletBatch&gt; solvables_batch;</span></span>
<span id="L4143"><span class="lineNum">    4143</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (data.solvable_wallet) {</span></span>
<span id="L4144"><span class="lineNum">    4144</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         solvables_batch = std::make_unique&lt;WalletBatch&gt;(data.solvable_wallet-&gt;GetDatabase());</span></span>
<span id="L4145"><span class="lineNum">    4145</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         if (!solvables_batch-&gt;TxnBegin()) return util::Error{strprintf(_(&quot;Error: database transaction cannot be executed for wallet %s&quot;), data.solvable_wallet-&gt;GetName())};</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L4146"><span class="lineNum">    4146</span>                 :             :         // Write the best block locator to avoid rescanning on reload</span>
<span id="L4147"><span class="lineNum">    4147</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!solvables_batch-&gt;WriteBestBlock(best_block_locator)) {</span></span>
<span id="L4148"><span class="lineNum">    4148</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             return util::Error{_(&quot;Error: Unable to write solvable wallet best block locator record&quot;)};</span></span>
<span id="L4149"><span class="lineNum">    4149</span>                 :             :         }</span>
<span id="L4150"><span class="lineNum">    4150</span>                 :             :     }</span>
<span id="L4151"><span class="lineNum">    4151</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (const auto&amp; [_pos, wtx] : wtxOrdered) {</span></span>
<span id="L4152"><span class="lineNum">    4152</span>                 :             :         // Check it is the watchonly wallet's</span>
<span id="L4153"><span class="lineNum">    4153</span>                 :             :         // solvable_wallet doesn't need to be checked because transactions for those scripts weren't being watched for</span>
<span id="L4154"><span class="lineNum">    4154</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         bool is_mine = IsMine(*wtx-&gt;tx) || IsFromMe(*wtx-&gt;tx);</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L4155"><span class="lineNum">    4155</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (data.watchonly_wallet) {</span></span>
<span id="L4156"><span class="lineNum">    4156</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             LOCK(data.watchonly_wallet-&gt;cs_wallet);</span></span>
<span id="L4157"><span class="lineNum">    4157</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             if (data.watchonly_wallet-&gt;IsMine(*wtx-&gt;tx) || data.watchonly_wallet-&gt;IsFromMe(*wtx-&gt;tx)) {</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L4158"><span class="lineNum">    4158</span>                 :             :                 // Add to watchonly wallet</span>
<span id="L4159"><span class="lineNum">    4159</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 const uint256&amp; hash = wtx-&gt;GetHash();</span></span>
<span id="L4160"><span class="lineNum">    4160</span>                 :<span class="tlaUNC">           0 :                 const CWalletTx&amp; to_copy_wtx = *wtx;</span></span>
<span id="L4161"><span class="lineNum">    4161</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 if (!data.watchonly_wallet-&gt;LoadToWallet(hash, [&amp;](CWalletTx&amp; ins_wtx, bool new_tx) EXCLUSIVE_LOCKS_REQUIRED(data.watchonly_wallet-&gt;cs_wallet) {</span></span>
<span id="L4162"><span class="lineNum">    4162</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     if (!new_tx) return false;</span></span>
<span id="L4163"><span class="lineNum">    4163</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     ins_wtx.SetTx(to_copy_wtx.tx);</span></span>
<span id="L4164"><span class="lineNum">    4164</span>                 :<span class="tlaUNC">           0 :                     ins_wtx.CopyFrom(to_copy_wtx);</span></span>
<span id="L4165"><span class="lineNum">    4165</span>                 :<span class="tlaUNC">           0 :                     return true;</span></span>
<span id="L4166"><span class="lineNum">    4166</span>                 :             :                 })) {</span>
<span id="L4167"><span class="lineNum">    4167</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                     return util::Error{strprintf(_(&quot;Error: Could not add watchonly tx %s to watchonly wallet&quot;), wtx-&gt;GetHash().GetHex())};</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L4168"><span class="lineNum">    4168</span>                 :             :                 }</span>
<span id="L4169"><span class="lineNum">    4169</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 watchonly_batch-&gt;WriteTx(data.watchonly_wallet-&gt;mapWallet.at(hash));</span></span>
<span id="L4170"><span class="lineNum">    4170</span>                 :             :                 // Mark as to remove from the migrated wallet only if it does not also belong to it</span>
<span id="L4171"><span class="lineNum">    4171</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 if (!is_mine) {</span></span>
<span id="L4172"><span class="lineNum">    4172</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     txids_to_delete.push_back(hash);</span></span>
<span id="L4173"><span class="lineNum">    4173</span>                 :             :                 }</span>
<span id="L4174"><span class="lineNum">    4174</span>                 :<span class="tlaUNC">           0 :                 continue;</span></span>
<span id="L4175"><span class="lineNum">    4175</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             }</span></span>
<span id="L4176"><span class="lineNum">    4176</span>                 :<span class="tlaUNC">           0 :         }</span></span>
<span id="L4177"><span class="lineNum">    4177</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!is_mine) {</span></span>
<span id="L4178"><span class="lineNum">    4178</span>                 :             :             // Both not ours and not in the watchonly wallet</span>
<span id="L4179"><span class="lineNum">    4179</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             return util::Error{strprintf(_(&quot;Error: Transaction %s in wallet cannot be identified to belong to migrated wallets&quot;), wtx-&gt;GetHash().GetHex())};</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L4180"><span class="lineNum">    4180</span>                 :             :         }</span>
<span id="L4181"><span class="lineNum">    4181</span>                 :             :     }</span>
<span id="L4182"><span class="lineNum">    4182</span>                 :             : </span>
<span id="L4183"><span class="lineNum">    4183</span>                 :             :     // Do the removes</span>
<span id="L4184"><span class="lineNum">    4184</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (txids_to_delete.size() &gt; 0) {</span></span>
<span id="L4185"><span class="lineNum">    4185</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (auto res = RemoveTxs(local_wallet_batch, txids_to_delete); !res) {</span></span>
<span id="L4186"><span class="lineNum">    4186</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             return util::Error{_(&quot;Error: Could not delete watchonly transactions. &quot;) + util::ErrorString(res)};</span></span>
<span id="L4187"><span class="lineNum">    4187</span>                 :<span class="tlaUNC">           0 :         }</span></span>
<span id="L4188"><span class="lineNum">    4188</span>                 :             :     }</span>
<span id="L4189"><span class="lineNum">    4189</span>                 :             : </span>
<span id="L4190"><span class="lineNum">    4190</span>                 :             :     // Pair external wallets with their corresponding db handler</span>
<span id="L4191"><span class="lineNum">    4191</span>                 :<span class="tlaUNC">           0 :     std::vector&lt;std::pair&lt;std::shared_ptr&lt;CWallet&gt;, std::unique_ptr&lt;WalletBatch&gt;&gt;&gt; wallets_vec;</span></span>
<span id="L4192"><span class="lineNum">    4192</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (data.watchonly_wallet) wallets_vec.emplace_back(data.watchonly_wallet, std::move(watchonly_batch));</span></span>
<span id="L4193"><span class="lineNum">    4193</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (data.solvable_wallet) wallets_vec.emplace_back(data.solvable_wallet, std::move(solvables_batch));</span></span>
<span id="L4194"><span class="lineNum">    4194</span>                 :             : </span>
<span id="L4195"><span class="lineNum">    4195</span>                 :             :     // Write address book entry to disk</span>
<span id="L4196"><span class="lineNum">    4196</span>                 :<span class="tlaUNC">           0 :     auto func_store_addr = [](WalletBatch&amp; batch, const CTxDestination&amp; dest, const CAddressBookData&amp; entry) {</span></span>
<span id="L4197"><span class="lineNum">    4197</span>                 :<span class="tlaUNC">           0 :         auto address{EncodeDestination(dest)};</span></span>
<span id="L4198"><span class="lineNum">    4198</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         if (entry.purpose) batch.WritePurpose(address, PurposeToString(*entry.purpose));</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L4199"><span class="lineNum">    4199</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (entry.label) batch.WriteName(address, *entry.label);</span></span>
<span id="L4200"><span class="lineNum">    4200</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (const auto&amp; [id, request] : entry.receive_requests) {</span></span>
<span id="L4201"><span class="lineNum">    4201</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             batch.WriteAddressReceiveRequest(dest, id, request);</span></span>
<span id="L4202"><span class="lineNum">    4202</span>                 :             :         }</span>
<span id="L4203"><span class="lineNum">    4203</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (entry.previously_spent) batch.WriteAddressPreviouslySpent(dest, true);</span></span>
<span id="L4204"><span class="lineNum">    4204</span>                 :<span class="tlaUNC">           0 :     };</span></span>
<span id="L4205"><span class="lineNum">    4205</span>                 :             : </span>
<span id="L4206"><span class="lineNum">    4206</span>                 :             :     // Check the address book data in the same way we did for transactions</span>
<span id="L4207"><span class="lineNum">    4207</span>                 :<span class="tlaUNC">           0 :     std::vector&lt;CTxDestination&gt; dests_to_delete;</span></span>
<span id="L4208"><span class="lineNum">    4208</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (const auto&amp; [dest, record] : m_address_book) {</span></span>
<span id="L4209"><span class="lineNum">    4209</span>                 :             :         // Ensure &quot;receive&quot; entries that are no longer part of the original wallet are transferred to another wallet</span>
<span id="L4210"><span class="lineNum">    4210</span>                 :             :         // Entries for everything else (&quot;send&quot;) will be cloned to all wallets.</span>
<span id="L4211"><span class="lineNum">    4211</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         bool require_transfer = record.purpose == AddressPurpose::RECEIVE &amp;&amp; !IsMine(dest);</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L4212"><span class="lineNum">    4212</span>                 :<span class="tlaUNC">           0 :         bool copied = false;</span></span>
<span id="L4213"><span class="lineNum">    4213</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (auto&amp; [wallet, batch] : wallets_vec) {</span></span>
<span id="L4214"><span class="lineNum">    4214</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             LOCK(wallet-&gt;cs_wallet);</span></span>
<span id="L4215"><span class="lineNum">    4215</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             if (require_transfer &amp;&amp; !wallet-&gt;IsMine(dest)) continue;</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L4216"><span class="lineNum">    4216</span>                 :             : </span>
<span id="L4217"><span class="lineNum">    4217</span>                 :             :             // Copy the entire address book entry</span>
<span id="L4218"><span class="lineNum">    4218</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             wallet-&gt;m_address_book[dest] = record;</span></span>
<span id="L4219"><span class="lineNum">    4219</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             func_store_addr(*batch, dest, record);</span></span>
<span id="L4220"><span class="lineNum">    4220</span>                 :             : </span>
<span id="L4221"><span class="lineNum">    4221</span>                 :<span class="tlaUNC">           0 :             copied = true;</span></span>
<span id="L4222"><span class="lineNum">    4222</span>                 :             :             // Only delete 'receive' records that are no longer part of the original wallet</span>
<span id="L4223"><span class="lineNum">    4223</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (require_transfer) {</span></span>
<span id="L4224"><span class="lineNum">    4224</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 dests_to_delete.push_back(dest);</span></span>
<span id="L4225"><span class="lineNum">    4225</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 break;</span></span>
<span id="L4226"><span class="lineNum">    4226</span>                 :             :             }</span>
<span id="L4227"><span class="lineNum">    4227</span>                 :<span class="tlaUNC">           0 :         }</span></span>
<span id="L4228"><span class="lineNum">    4228</span>                 :             : </span>
<span id="L4229"><span class="lineNum">    4229</span>                 :             :         // Fail immediately if we ever found an entry that was ours and cannot be transferred</span>
<span id="L4230"><span class="lineNum">    4230</span>                 :             :         // to any of the created wallets (watch-only, solvable).</span>
<span id="L4231"><span class="lineNum">    4231</span>                 :             :         // Means that no inferred descriptor maps to the stored entry. Which mustn't happen.</span>
<span id="L4232"><span class="lineNum">    4232</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (require_transfer &amp;&amp; !copied) {</span></span>
<span id="L4233"><span class="lineNum">    4233</span>                 :             : </span>
<span id="L4234"><span class="lineNum">    4234</span>                 :             :             // Skip invalid/non-watched scripts that will not be migrated</span>
<span id="L4235"><span class="lineNum">    4235</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (not_migrated_dests.count(dest) &gt; 0) {</span></span>
<span id="L4236"><span class="lineNum">    4236</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 dests_to_delete.push_back(dest);</span></span>
<span id="L4237"><span class="lineNum">    4237</span>                 :<span class="tlaUNC">           0 :                 continue;</span></span>
<span id="L4238"><span class="lineNum">    4238</span>                 :             :             }</span>
<span id="L4239"><span class="lineNum">    4239</span>                 :             : </span>
<span id="L4240"><span class="lineNum">    4240</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             return util::Error{_(&quot;Error: Address book data in wallet cannot be identified to belong to migrated wallets&quot;)};</span></span>
<span id="L4241"><span class="lineNum">    4241</span>                 :             :         }</span>
<span id="L4242"><span class="lineNum">    4242</span>                 :             :     }</span>
<span id="L4243"><span class="lineNum">    4243</span>                 :             : </span>
<span id="L4244"><span class="lineNum">    4244</span>                 :             :     // Persist external wallets address book entries</span>
<span id="L4245"><span class="lineNum">    4245</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (auto&amp; [wallet, batch] : wallets_vec) {</span></span>
<span id="L4246"><span class="lineNum">    4246</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!batch-&gt;TxnCommit()) {</span></span>
<span id="L4247"><span class="lineNum">    4247</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             return util::Error{strprintf(_(&quot;Error: Unable to write data to disk for wallet %s&quot;), wallet-&gt;GetName())};</span></span>
<span id="L4248"><span class="lineNum">    4248</span>                 :             :         }</span>
<span id="L4249"><span class="lineNum">    4249</span>                 :             :     }</span>
<span id="L4250"><span class="lineNum">    4250</span>                 :             : </span>
<span id="L4251"><span class="lineNum">    4251</span>                 :             :     // Remove the things to delete in this wallet</span>
<span id="L4252"><span class="lineNum">    4252</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (dests_to_delete.size() &gt; 0) {</span></span>
<span id="L4253"><span class="lineNum">    4253</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (const auto&amp; dest : dests_to_delete) {</span></span>
<span id="L4254"><span class="lineNum">    4254</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (!DelAddressBookWithDB(local_wallet_batch, dest)) {</span></span>
<span id="L4255"><span class="lineNum">    4255</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 return util::Error{_(&quot;Error: Unable to remove watchonly address book data&quot;)};</span></span>
<span id="L4256"><span class="lineNum">    4256</span>                 :             :             }</span>
<span id="L4257"><span class="lineNum">    4257</span>                 :             :         }</span>
<span id="L4258"><span class="lineNum">    4258</span>                 :             :     }</span>
<span id="L4259"><span class="lineNum">    4259</span>                 :             : </span>
<span id="L4260"><span class="lineNum">    4260</span>                 :<span class="tlaUNC">           0 :     return {}; // all good</span></span>
<span id="L4261"><span class="lineNum">    4261</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L4262"><span class="lineNum">    4262</span>                 :             : </span>
<span id="L4263"><span class="lineNum">    4263</span>                 :<span class="tlaUNC">           0 : bool CWallet::CanGrindR() const</span></span>
<span id="L4264"><span class="lineNum">    4264</span>                 :             : {</span>
<span id="L4265"><span class="lineNum">    4265</span>                 :<span class="tlaUNC">           0 :     return !IsWalletFlagSet(WALLET_FLAG_EXTERNAL_SIGNER);</span></span>
<span id="L4266"><span class="lineNum">    4266</span>                 :             : }</span>
<span id="L4267"><span class="lineNum">    4267</span>                 :             : </span>
<span id="L4268"><span class="lineNum">    4268</span>                 :<span class="tlaUNC">           0 : bool DoMigration(CWallet&amp; wallet, WalletContext&amp; context, bilingual_str&amp; error, MigrationResult&amp; res) EXCLUSIVE_LOCKS_REQUIRED(wallet.cs_wallet)</span></span>
<span id="L4269"><span class="lineNum">    4269</span>                 :             : {</span>
<span id="L4270"><span class="lineNum">    4270</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(wallet.cs_wallet);</span></span>
<span id="L4271"><span class="lineNum">    4271</span>                 :             : </span>
<span id="L4272"><span class="lineNum">    4272</span>                 :             :     // Get all of the descriptors from the legacy wallet</span>
<span id="L4273"><span class="lineNum">    4273</span>                 :<span class="tlaUNC">           0 :     std::optional&lt;MigrationData&gt; data = wallet.GetDescriptorsForLegacy(error);</span></span>
<span id="L4274"><span class="lineNum">    4274</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (data == std::nullopt) return false;</span></span>
<span id="L4275"><span class="lineNum">    4275</span>                 :             : </span>
<span id="L4276"><span class="lineNum">    4276</span>                 :             :     // Create the watchonly and solvable wallets if necessary</span>
<span id="L4277"><span class="lineNum">    4277</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (data-&gt;watch_descs.size() &gt; 0 || data-&gt;solvable_descs.size() &gt; 0) {</span></span>
<span id="L4278"><span class="lineNum">    4278</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         DatabaseOptions options;</span></span>
<span id="L4279"><span class="lineNum">    4279</span>                 :<span class="tlaUNC">           0 :         options.require_existing = false;</span></span>
<span id="L4280"><span class="lineNum">    4280</span>                 :<span class="tlaUNC">           0 :         options.require_create = true;</span></span>
<span id="L4281"><span class="lineNum">    4281</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         options.require_format = DatabaseFormat::SQLITE;</span></span>
<span id="L4282"><span class="lineNum">    4282</span>                 :             : </span>
<span id="L4283"><span class="lineNum">    4283</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         WalletContext empty_context;</span></span>
<span id="L4284"><span class="lineNum">    4284</span>                 :<span class="tlaUNC">           0 :         empty_context.args = context.args;</span></span>
<span id="L4285"><span class="lineNum">    4285</span>                 :             : </span>
<span id="L4286"><span class="lineNum">    4286</span>                 :             :         // Make the wallets</span>
<span id="L4287"><span class="lineNum">    4287</span>                 :<span class="tlaUNC">           0 :         options.create_flags = WALLET_FLAG_DISABLE_PRIVATE_KEYS | WALLET_FLAG_BLANK_WALLET | WALLET_FLAG_DESCRIPTORS;</span></span>
<span id="L4288"><span class="lineNum">    4288</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (wallet.IsWalletFlagSet(WALLET_FLAG_AVOID_REUSE)) {</span></span>
<span id="L4289"><span class="lineNum">    4289</span>                 :<span class="tlaUNC">           0 :             options.create_flags |= WALLET_FLAG_AVOID_REUSE;</span></span>
<span id="L4290"><span class="lineNum">    4290</span>                 :             :         }</span>
<span id="L4291"><span class="lineNum">    4291</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (wallet.IsWalletFlagSet(WALLET_FLAG_KEY_ORIGIN_METADATA)) {</span></span>
<span id="L4292"><span class="lineNum">    4292</span>                 :<span class="tlaUNC">           0 :             options.create_flags |= WALLET_FLAG_KEY_ORIGIN_METADATA;</span></span>
<span id="L4293"><span class="lineNum">    4293</span>                 :             :         }</span>
<span id="L4294"><span class="lineNum">    4294</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (data-&gt;watch_descs.size() &gt; 0) {</span></span>
<span id="L4295"><span class="lineNum">    4295</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             wallet.WalletLogPrintf(&quot;Making a new watchonly wallet containing the watched scripts\n&quot;);</span></span>
<span id="L4296"><span class="lineNum">    4296</span>                 :             : </span>
<span id="L4297"><span class="lineNum">    4297</span>                 :<span class="tlaUNC">           0 :             DatabaseStatus status;</span></span>
<span id="L4298"><span class="lineNum">    4298</span>                 :<span class="tlaUNC">           0 :             std::vector&lt;bilingual_str&gt; warnings;</span></span>
<span id="L4299"><span class="lineNum">    4299</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             std::string wallet_name = wallet.GetName() + &quot;_watchonly&quot;;</span></span>
<span id="L4300"><span class="lineNum">    4300</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             std::unique_ptr&lt;WalletDatabase&gt; database = MakeWalletDatabase(wallet_name, options, status, error);</span></span>
<span id="L4301"><span class="lineNum">    4301</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (!database) {</span></span>
<span id="L4302"><span class="lineNum">    4302</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 error = strprintf(_(&quot;Wallet file creation failed: %s&quot;), error);</span></span>
<span id="L4303"><span class="lineNum">    4303</span>                 :<span class="tlaUNC">           0 :                 return false;</span></span>
<span id="L4304"><span class="lineNum">    4304</span>                 :             :             }</span>
<span id="L4305"><span class="lineNum">    4305</span>                 :             : </span>
<span id="L4306"><span class="lineNum">    4306</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             data-&gt;watchonly_wallet = CWallet::Create(empty_context, wallet_name, std::move(database), options.create_flags, error, warnings);</span></span>
<span id="L4307"><span class="lineNum">    4307</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (!data-&gt;watchonly_wallet) {</span></span>
<span id="L4308"><span class="lineNum">    4308</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 error = _(&quot;Error: Failed to create new watchonly wallet&quot;);</span></span>
<span id="L4309"><span class="lineNum">    4309</span>                 :<span class="tlaUNC">           0 :                 return false;</span></span>
<span id="L4310"><span class="lineNum">    4310</span>                 :             :             }</span>
<span id="L4311"><span class="lineNum">    4311</span>                 :<span class="tlaUNC">           0 :             res.watchonly_wallet = data-&gt;watchonly_wallet;</span></span>
<span id="L4312"><span class="lineNum">    4312</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             LOCK(data-&gt;watchonly_wallet-&gt;cs_wallet);</span></span>
<span id="L4313"><span class="lineNum">    4313</span>                 :             : </span>
<span id="L4314"><span class="lineNum">    4314</span>                 :             :             // Parse the descriptors and add them to the new wallet</span>
<span id="L4315"><span class="lineNum">    4315</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             for (const auto&amp; [desc_str, creation_time] : data-&gt;watch_descs) {</span></span>
<span id="L4316"><span class="lineNum">    4316</span>                 :             :                 // Parse the descriptor</span>
<span id="L4317"><span class="lineNum">    4317</span>                 :<span class="tlaUNC">           0 :                 FlatSigningProvider keys;</span></span>
<span id="L4318"><span class="lineNum">    4318</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 std::string parse_err;</span></span>
<span id="L4319"><span class="lineNum">    4319</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 std::vector&lt;std::unique_ptr&lt;Descriptor&gt;&gt; descs = Parse(desc_str, keys, parse_err, /* require_checksum */ true);</span></span>
<span id="L4320"><span class="lineNum">    4320</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 assert(descs.size() == 1); // It shouldn't be possible to have the LegacyScriptPubKeyMan make an invalid descriptor or a multipath descriptors</span></span>
<span id="L4321"><span class="lineNum">    4321</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                 assert(!descs.at(0)-&gt;IsRange()); // It shouldn't be possible to have LegacyScriptPubKeyMan make a ranged watchonly descriptor</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L4322"><span class="lineNum">    4322</span>                 :             : </span>
<span id="L4323"><span class="lineNum">    4323</span>                 :             :                 // Add to the wallet</span>
<span id="L4324"><span class="lineNum">    4324</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                 WalletDescriptor w_desc(std::move(descs.at(0)), creation_time, 0, 0, 0);</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L4325"><span class="lineNum">    4325</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 data-&gt;watchonly_wallet-&gt;AddWalletDescriptor(w_desc, keys, &quot;&quot;, false);</span></span>
<span id="L4326"><span class="lineNum">    4326</span>                 :<span class="tlaUNC">           0 :             }</span></span>
<span id="L4327"><span class="lineNum">    4327</span>                 :             : </span>
<span id="L4328"><span class="lineNum">    4328</span>                 :             :             // Add the wallet to settings</span>
<span id="L4329"><span class="lineNum">    4329</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             UpdateWalletSetting(*context.chain, wallet_name, /*load_on_startup=*/true, warnings);</span></span>
<span id="L4330"><span class="lineNum">    4330</span>                 :<span class="tlaUNC">           0 :         }</span></span>
<span id="L4331"><span class="lineNum">    4331</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (data-&gt;solvable_descs.size() &gt; 0) {</span></span>
<span id="L4332"><span class="lineNum">    4332</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             wallet.WalletLogPrintf(&quot;Making a new watchonly wallet containing the unwatched solvable scripts\n&quot;);</span></span>
<span id="L4333"><span class="lineNum">    4333</span>                 :             : </span>
<span id="L4334"><span class="lineNum">    4334</span>                 :<span class="tlaUNC">           0 :             DatabaseStatus status;</span></span>
<span id="L4335"><span class="lineNum">    4335</span>                 :<span class="tlaUNC">           0 :             std::vector&lt;bilingual_str&gt; warnings;</span></span>
<span id="L4336"><span class="lineNum">    4336</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             std::string wallet_name = wallet.GetName() + &quot;_solvables&quot;;</span></span>
<span id="L4337"><span class="lineNum">    4337</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             std::unique_ptr&lt;WalletDatabase&gt; database = MakeWalletDatabase(wallet_name, options, status, error);</span></span>
<span id="L4338"><span class="lineNum">    4338</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (!database) {</span></span>
<span id="L4339"><span class="lineNum">    4339</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 error = strprintf(_(&quot;Wallet file creation failed: %s&quot;), error);</span></span>
<span id="L4340"><span class="lineNum">    4340</span>                 :<span class="tlaUNC">           0 :                 return false;</span></span>
<span id="L4341"><span class="lineNum">    4341</span>                 :             :             }</span>
<span id="L4342"><span class="lineNum">    4342</span>                 :             : </span>
<span id="L4343"><span class="lineNum">    4343</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             data-&gt;solvable_wallet = CWallet::Create(empty_context, wallet_name, std::move(database), options.create_flags, error, warnings);</span></span>
<span id="L4344"><span class="lineNum">    4344</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (!data-&gt;solvable_wallet) {</span></span>
<span id="L4345"><span class="lineNum">    4345</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 error = _(&quot;Error: Failed to create new watchonly wallet&quot;);</span></span>
<span id="L4346"><span class="lineNum">    4346</span>                 :<span class="tlaUNC">           0 :                 return false;</span></span>
<span id="L4347"><span class="lineNum">    4347</span>                 :             :             }</span>
<span id="L4348"><span class="lineNum">    4348</span>                 :<span class="tlaUNC">           0 :             res.solvables_wallet = data-&gt;solvable_wallet;</span></span>
<span id="L4349"><span class="lineNum">    4349</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             LOCK(data-&gt;solvable_wallet-&gt;cs_wallet);</span></span>
<span id="L4350"><span class="lineNum">    4350</span>                 :             : </span>
<span id="L4351"><span class="lineNum">    4351</span>                 :             :             // Parse the descriptors and add them to the new wallet</span>
<span id="L4352"><span class="lineNum">    4352</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             for (const auto&amp; [desc_str, creation_time] : data-&gt;solvable_descs) {</span></span>
<span id="L4353"><span class="lineNum">    4353</span>                 :             :                 // Parse the descriptor</span>
<span id="L4354"><span class="lineNum">    4354</span>                 :<span class="tlaUNC">           0 :                 FlatSigningProvider keys;</span></span>
<span id="L4355"><span class="lineNum">    4355</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 std::string parse_err;</span></span>
<span id="L4356"><span class="lineNum">    4356</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 std::vector&lt;std::unique_ptr&lt;Descriptor&gt;&gt; descs = Parse(desc_str, keys, parse_err, /* require_checksum */ true);</span></span>
<span id="L4357"><span class="lineNum">    4357</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 assert(descs.size() == 1); // It shouldn't be possible to have the LegacyScriptPubKeyMan make an invalid descriptor or a multipath descriptors</span></span>
<span id="L4358"><span class="lineNum">    4358</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                 assert(!descs.at(0)-&gt;IsRange()); // It shouldn't be possible to have LegacyScriptPubKeyMan make a ranged watchonly descriptor</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L4359"><span class="lineNum">    4359</span>                 :             : </span>
<span id="L4360"><span class="lineNum">    4360</span>                 :             :                 // Add to the wallet</span>
<span id="L4361"><span class="lineNum">    4361</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                 WalletDescriptor w_desc(std::move(descs.at(0)), creation_time, 0, 0, 0);</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L4362"><span class="lineNum">    4362</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 data-&gt;solvable_wallet-&gt;AddWalletDescriptor(w_desc, keys, &quot;&quot;, false);</span></span>
<span id="L4363"><span class="lineNum">    4363</span>                 :<span class="tlaUNC">           0 :             }</span></span>
<span id="L4364"><span class="lineNum">    4364</span>                 :             : </span>
<span id="L4365"><span class="lineNum">    4365</span>                 :             :             // Add the wallet to settings</span>
<span id="L4366"><span class="lineNum">    4366</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             UpdateWalletSetting(*context.chain, wallet_name, /*load_on_startup=*/true, warnings);</span></span>
<span id="L4367"><span class="lineNum">    4367</span>                 :<span class="tlaUNC">           0 :         }</span></span>
<span id="L4368"><span class="lineNum">    4368</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L4369"><span class="lineNum">    4369</span>                 :             : </span>
<span id="L4370"><span class="lineNum">    4370</span>                 :             :     // Add the descriptors to wallet, remove LegacyScriptPubKeyMan, and cleanup txs and address book data</span>
<span id="L4371"><span class="lineNum">    4371</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     return RunWithinTxn(wallet.GetDatabase(), /*process_desc=*/&quot;apply migration process&quot;, [&amp;](WalletBatch&amp; batch) EXCLUSIVE_LOCKS_REQUIRED(wallet.cs_wallet){</span></span>
<span id="L4372"><span class="lineNum">    4372</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (auto res_migration = wallet.ApplyMigrationData(batch, *data); !res_migration) {</span></span>
<span id="L4373"><span class="lineNum">    4373</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             error = util::ErrorString(res_migration);</span></span>
<span id="L4374"><span class="lineNum">    4374</span>                 :<span class="tlaUNC">           0 :             return false;</span></span>
<span id="L4375"><span class="lineNum">    4375</span>                 :<span class="tlaUNC">           0 :         }</span></span>
<span id="L4376"><span class="lineNum">    4376</span>                 :<span class="tlaUNC">           0 :         wallet.WalletLogPrintf(&quot;Wallet migration complete.\n&quot;);</span></span>
<span id="L4377"><span class="lineNum">    4377</span>                 :<span class="tlaUNC">           0 :         return true;</span></span>
<span id="L4378"><span class="lineNum">    4378</span>                 :             :     });</span>
<span id="L4379"><span class="lineNum">    4379</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L4380"><span class="lineNum">    4380</span>                 :             : </span>
<span id="L4381"><span class="lineNum">    4381</span>                 :<span class="tlaUNC">           0 : util::Result&lt;MigrationResult&gt; MigrateLegacyToDescriptor(const std::string&amp; wallet_name, const SecureString&amp; passphrase, WalletContext&amp; context)</span></span>
<span id="L4382"><span class="lineNum">    4382</span>                 :             : {</span>
<span id="L4383"><span class="lineNum">    4383</span>                 :<span class="tlaUNC">           0 :     MigrationResult res;</span></span>
<span id="L4384"><span class="lineNum">    4384</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     bilingual_str error;</span></span>
<span id="L4385"><span class="lineNum">    4385</span>                 :<span class="tlaUNC">           0 :     std::vector&lt;bilingual_str&gt; warnings;</span></span>
<span id="L4386"><span class="lineNum">    4386</span>                 :             : </span>
<span id="L4387"><span class="lineNum">    4387</span>                 :             :     // If the wallet is still loaded, unload it so that nothing else tries to use it while we're changing it</span>
<span id="L4388"><span class="lineNum">    4388</span>                 :<span class="tlaUNC">           0 :     bool was_loaded = false;</span></span>
<span id="L4389"><span class="lineNum">    4389</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (auto wallet = GetWallet(context, wallet_name)) {</span></span>
<span id="L4390"><span class="lineNum">    4390</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (wallet-&gt;IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {</span></span>
<span id="L4391"><span class="lineNum">    4391</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             return util::Error{_(&quot;Error: This wallet is already a descriptor wallet&quot;)};</span></span>
<span id="L4392"><span class="lineNum">    4392</span>                 :             :         }</span>
<span id="L4393"><span class="lineNum">    4393</span>                 :             : </span>
<span id="L4394"><span class="lineNum">    4394</span>                 :             :         // Flush chain state before unloading wallet</span>
<span id="L4395"><span class="lineNum">    4395</span>                 :<span class="tlaUNC">           0 :         CBlockLocator locator;</span></span>
<span id="L4396"><span class="lineNum">    4396</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         WITH_LOCK(wallet-&gt;cs_wallet, context.chain-&gt;findBlock(wallet-&gt;GetLastBlockHash(), FoundBlock().locator(locator)));</span></span>
<span id="L4397"><span class="lineNum">    4397</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!locator.IsNull()) wallet-&gt;chainStateFlushed(ChainstateRole::NORMAL, locator);</span></span>
<span id="L4398"><span class="lineNum">    4398</span>                 :             : </span>
<span id="L4399"><span class="lineNum">    4399</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!RemoveWallet(context, wallet, /*load_on_start=*/std::nullopt, warnings)) {</span></span>
<span id="L4400"><span class="lineNum">    4400</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             return util::Error{_(&quot;Unable to unload the wallet before migrating&quot;)};</span></span>
<span id="L4401"><span class="lineNum">    4401</span>                 :             :         }</span>
<span id="L4402"><span class="lineNum">    4402</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         WaitForDeleteWallet(std::move(wallet));</span></span>
<span id="L4403"><span class="lineNum">    4403</span>                 :<span class="tlaUNC">           0 :         was_loaded = true;</span></span>
<span id="L4404"><span class="lineNum">    4404</span>                 :<span class="tlaUNC">           0 :     } else {</span></span>
<span id="L4405"><span class="lineNum">    4405</span>                 :             :         // Check if the wallet is BDB</span>
<span id="L4406"><span class="lineNum">    4406</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         const auto&amp; wallet_path = GetWalletPath(wallet_name);</span></span>
<span id="L4407"><span class="lineNum">    4407</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!wallet_path) {</span></span>
<span id="L4408"><span class="lineNum">    4408</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             return util::Error{util::ErrorString(wallet_path)};</span></span>
<span id="L4409"><span class="lineNum">    4409</span>                 :             :         }</span>
<span id="L4410"><span class="lineNum">    4410</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         if (!IsBDBFile(BDBDataFile(*wallet_path))) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L4411"><span class="lineNum">    4411</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             return util::Error{_(&quot;Error: This wallet is already a descriptor wallet&quot;)};</span></span>
<span id="L4412"><span class="lineNum">    4412</span>                 :             :         }</span>
<span id="L4413"><span class="lineNum">    4413</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L4414"><span class="lineNum">    4414</span>                 :             : </span>
<span id="L4415"><span class="lineNum">    4415</span>                 :             :     // Load the wallet but only in the context of this function.</span>
<span id="L4416"><span class="lineNum">    4416</span>                 :             :     // No signals should be connected nor should anything else be aware of this wallet</span>
<span id="L4417"><span class="lineNum">    4417</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     WalletContext empty_context;</span></span>
<span id="L4418"><span class="lineNum">    4418</span>                 :<span class="tlaUNC">           0 :     empty_context.args = context.args;</span></span>
<span id="L4419"><span class="lineNum">    4419</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     DatabaseOptions options;</span></span>
<span id="L4420"><span class="lineNum">    4420</span>                 :<span class="tlaUNC">           0 :     options.require_existing = true;</span></span>
<span id="L4421"><span class="lineNum">    4421</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     options.require_format = DatabaseFormat::BERKELEY_RO;</span></span>
<span id="L4422"><span class="lineNum">    4422</span>                 :<span class="tlaUNC">           0 :     DatabaseStatus status;</span></span>
<span id="L4423"><span class="lineNum">    4423</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     std::unique_ptr&lt;WalletDatabase&gt; database = MakeWalletDatabase(wallet_name, options, status, error);</span></span>
<span id="L4424"><span class="lineNum">    4424</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!database) {</span></span>
<span id="L4425"><span class="lineNum">    4425</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         return util::Error{Untranslated(&quot;Wallet file verification failed.&quot;) + Untranslated(&quot; &quot;) + error};</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not executed"> # </span>]
<span id="L4426"><span class="lineNum">    4426</span>                 :             :     }</span>
<span id="L4427"><span class="lineNum">    4427</span>                 :             : </span>
<span id="L4428"><span class="lineNum">    4428</span>                 :             :     // Make the local wallet</span>
<span id="L4429"><span class="lineNum">    4429</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     std::shared_ptr&lt;CWallet&gt; local_wallet = CWallet::Create(empty_context, wallet_name, std::move(database), options.create_flags, error, warnings);</span></span>
<span id="L4430"><span class="lineNum">    4430</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!local_wallet) {</span></span>
<span id="L4431"><span class="lineNum">    4431</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         return util::Error{Untranslated(&quot;Wallet loading failed.&quot;) + Untranslated(&quot; &quot;) + error};</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not executed"> # </span>]
<span id="L4432"><span class="lineNum">    4432</span>                 :             :     }</span>
<span id="L4433"><span class="lineNum">    4433</span>                 :             : </span>
<span id="L4434"><span class="lineNum">    4434</span>                 :             :     // Helper to reload as normal for some of our exit scenarios</span>
<span id="L4435"><span class="lineNum">    4435</span>                 :<span class="tlaUNC">           0 :     const auto&amp; reload_wallet = [&amp;](std::shared_ptr&lt;CWallet&gt;&amp; to_reload) {</span></span>
<span id="L4436"><span class="lineNum">    4436</span>                 :             :         // Reset options.require_format as wallets of any format may be reloaded.</span>
<span id="L4437"><span class="lineNum">    4437</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         options.require_format = std::nullopt;</span></span>
<span id="L4438"><span class="lineNum">    4438</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         assert(to_reload.use_count() == 1);</span></span>
<span id="L4439"><span class="lineNum">    4439</span>                 :<span class="tlaUNC">           0 :         std::string name = to_reload-&gt;GetName();</span></span>
<span id="L4440"><span class="lineNum">    4440</span>                 :<span class="tlaUNC">           0 :         to_reload.reset();</span></span>
<span id="L4441"><span class="lineNum">    4441</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         to_reload = LoadWallet(context, name, /*load_on_start=*/std::nullopt, options, status, error, warnings);</span></span>
<span id="L4442"><span class="lineNum">    4442</span>                 :<span class="tlaUNC">           0 :         return to_reload != nullptr;</span></span>
<span id="L4443"><span class="lineNum">    4443</span>                 :<span class="tlaUNC">           0 :     };</span></span>
<span id="L4444"><span class="lineNum">    4444</span>                 :             : </span>
<span id="L4445"><span class="lineNum">    4445</span>                 :             :     // Before anything else, check if there is something to migrate.</span>
<span id="L4446"><span class="lineNum">    4446</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (local_wallet-&gt;IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {</span></span>
<span id="L4447"><span class="lineNum">    4447</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (was_loaded) {</span></span>
<span id="L4448"><span class="lineNum">    4448</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             reload_wallet(local_wallet);</span></span>
<span id="L4449"><span class="lineNum">    4449</span>                 :             :         }</span>
<span id="L4450"><span class="lineNum">    4450</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         return util::Error{_(&quot;Error: This wallet is already a descriptor wallet&quot;)};</span></span>
<span id="L4451"><span class="lineNum">    4451</span>                 :             :     }</span>
<span id="L4452"><span class="lineNum">    4452</span>                 :             : </span>
<span id="L4453"><span class="lineNum">    4453</span>                 :             :     // Make a backup of the DB</span>
<span id="L4454"><span class="lineNum">    4454</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     fs::path this_wallet_dir = fs::absolute(fs::PathFromString(local_wallet-&gt;GetDatabase().Filename())).parent_path();</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L4455"><span class="lineNum">    4455</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     fs::path backup_filename = fs::PathFromString(strprintf(&quot;%s_%d.legacy.bak&quot;, (wallet_name.empty() ? &quot;default_wallet&quot; : wallet_name), GetTime()));</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span>       <span class="tlaUNC" title="Branch 9 was not executed"> # </span><span class="tlaUNC" title="Branch 10 was not executed"> # </span><span class="tlaUNC" title="Branch 11 was not executed"> # </span>]
<span id="L4456"><span class="lineNum">    4456</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     fs::path backup_path = this_wallet_dir / backup_filename;</span></span>
<span id="L4457"><span class="lineNum">    4457</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     if (!local_wallet-&gt;BackupWallet(fs::PathToString(backup_path))) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L4458"><span class="lineNum">    4458</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (was_loaded) {</span></span>
<span id="L4459"><span class="lineNum">    4459</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             reload_wallet(local_wallet);</span></span>
<span id="L4460"><span class="lineNum">    4460</span>                 :             :         }</span>
<span id="L4461"><span class="lineNum">    4461</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         return util::Error{_(&quot;Error: Unable to make a backup of your wallet&quot;)};</span></span>
<span id="L4462"><span class="lineNum">    4462</span>                 :             :     }</span>
<span id="L4463"><span class="lineNum">    4463</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     res.backup_path = backup_path;</span></span>
<span id="L4464"><span class="lineNum">    4464</span>                 :             : </span>
<span id="L4465"><span class="lineNum">    4465</span>                 :<span class="tlaUNC">           0 :     bool success = false;</span></span>
<span id="L4466"><span class="lineNum">    4466</span>                 :             : </span>
<span id="L4467"><span class="lineNum">    4467</span>                 :             :     // Unlock the wallet if needed</span>
<span id="L4468"><span class="lineNum">    4468</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     if (local_wallet-&gt;IsLocked() &amp;&amp; !local_wallet-&gt;Unlock(passphrase)) {</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L4469"><span class="lineNum">    4469</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (was_loaded) {</span></span>
<span id="L4470"><span class="lineNum">    4470</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             reload_wallet(local_wallet);</span></span>
<span id="L4471"><span class="lineNum">    4471</span>                 :             :         }</span>
<span id="L4472"><span class="lineNum">    4472</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (passphrase.find('\0') == std::string::npos) {</span></span>
<span id="L4473"><span class="lineNum">    4473</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             return util::Error{Untranslated(&quot;Error: Wallet decryption failed, the wallet passphrase was not provided or was incorrect.&quot;)};</span></span>
<span id="L4474"><span class="lineNum">    4474</span>                 :             :         } else {</span>
<span id="L4475"><span class="lineNum">    4475</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             return util::Error{Untranslated(&quot;Error: Wallet decryption failed, the wallet passphrase entered was incorrect. &quot;</span></span>
<span id="L4476"><span class="lineNum">    4476</span>                 :             :                                             &quot;The passphrase contains a null character (ie - a zero byte). &quot;</span>
<span id="L4477"><span class="lineNum">    4477</span>                 :             :                                             &quot;If this passphrase was set with a version of this software prior to 25.0, &quot;</span>
<span id="L4478"><span class="lineNum">    4478</span>                 :             :                                             &quot;please try again with only the characters up to  but not including  &quot;</span>
<span id="L4479"><span class="lineNum">    4479</span>                 :<span class="tlaUNC">           0 :                                             &quot;the first null character.&quot;)};</span></span>
<span id="L4480"><span class="lineNum">    4480</span>                 :             :         }</span>
<span id="L4481"><span class="lineNum">    4481</span>                 :             :     }</span>
<span id="L4482"><span class="lineNum">    4482</span>                 :             : </span>
<span id="L4483"><span class="lineNum">    4483</span>                 :<span class="tlaUNC">           0 :     {</span></span>
<span id="L4484"><span class="lineNum">    4484</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LOCK(local_wallet-&gt;cs_wallet);</span></span>
<span id="L4485"><span class="lineNum">    4485</span>                 :             :         // First change to using SQLite</span>
<span id="L4486"><span class="lineNum">    4486</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         if (!local_wallet-&gt;MigrateToSQLite(error)) return util::Error{error};</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L4487"><span class="lineNum">    4487</span>                 :             : </span>
<span id="L4488"><span class="lineNum">    4488</span>                 :             :         // Do the migration of keys and scripts for non-blank wallets, and cleanup if it fails</span>
<span id="L4489"><span class="lineNum">    4489</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         success = local_wallet-&gt;IsWalletFlagSet(WALLET_FLAG_BLANK_WALLET);</span></span>
<span id="L4490"><span class="lineNum">    4490</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!success) {</span></span>
<span id="L4491"><span class="lineNum">    4491</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             success = DoMigration(*local_wallet, context, error, res);</span></span>
<span id="L4492"><span class="lineNum">    4492</span>                 :             :         } else {</span>
<span id="L4493"><span class="lineNum">    4493</span>                 :             :             // Make sure that descriptors flag is actually set</span>
<span id="L4494"><span class="lineNum">    4494</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             local_wallet-&gt;SetWalletFlag(WALLET_FLAG_DESCRIPTORS);</span></span>
<span id="L4495"><span class="lineNum">    4495</span>                 :             :         }</span>
<span id="L4496"><span class="lineNum">    4496</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L4497"><span class="lineNum">    4497</span>                 :             : </span>
<span id="L4498"><span class="lineNum">    4498</span>                 :             :     // In case of reloading failure, we need to remember the wallet dirs to remove</span>
<span id="L4499"><span class="lineNum">    4499</span>                 :             :     // Set is used as it may be populated with the same wallet directory paths multiple times,</span>
<span id="L4500"><span class="lineNum">    4500</span>                 :             :     // both before and after reloading. This ensures the set is complete even if one of the wallets</span>
<span id="L4501"><span class="lineNum">    4501</span>                 :             :     // fails to reload.</span>
<span id="L4502"><span class="lineNum">    4502</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     std::set&lt;fs::path&gt; wallet_dirs;</span></span>
<span id="L4503"><span class="lineNum">    4503</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (success) {</span></span>
<span id="L4504"><span class="lineNum">    4504</span>                 :             :         // Migration successful, unload all wallets locally, then reload them.</span>
<span id="L4505"><span class="lineNum">    4505</span>                 :             :         // Reload the main wallet</span>
<span id="L4506"><span class="lineNum">    4506</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         wallet_dirs.insert(fs::PathFromString(local_wallet-&gt;GetDatabase().Filename()).parent_path());</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L4507"><span class="lineNum">    4507</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         success = reload_wallet(local_wallet);</span></span>
<span id="L4508"><span class="lineNum">    4508</span>                 :<span class="tlaUNC">           0 :         res.wallet = local_wallet;</span></span>
<span id="L4509"><span class="lineNum">    4509</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         res.wallet_name = wallet_name;</span></span>
<span id="L4510"><span class="lineNum">    4510</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (success &amp;&amp; res.watchonly_wallet) {</span></span>
<span id="L4511"><span class="lineNum">    4511</span>                 :             :             // Reload watchonly</span>
<span id="L4512"><span class="lineNum">    4512</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             wallet_dirs.insert(fs::PathFromString(res.watchonly_wallet-&gt;GetDatabase().Filename()).parent_path());</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L4513"><span class="lineNum">    4513</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             success = reload_wallet(res.watchonly_wallet);</span></span>
<span id="L4514"><span class="lineNum">    4514</span>                 :             :         }</span>
<span id="L4515"><span class="lineNum">    4515</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (success &amp;&amp; res.solvables_wallet) {</span></span>
<span id="L4516"><span class="lineNum">    4516</span>                 :             :             // Reload solvables</span>
<span id="L4517"><span class="lineNum">    4517</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             wallet_dirs.insert(fs::PathFromString(res.solvables_wallet-&gt;GetDatabase().Filename()).parent_path());</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L4518"><span class="lineNum">    4518</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             success = reload_wallet(res.solvables_wallet);</span></span>
<span id="L4519"><span class="lineNum">    4519</span>                 :             :         }</span>
<span id="L4520"><span class="lineNum">    4520</span>                 :             :     }</span>
<span id="L4521"><span class="lineNum">    4521</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!success) {</span></span>
<span id="L4522"><span class="lineNum">    4522</span>                 :             :         // Migration failed, cleanup</span>
<span id="L4523"><span class="lineNum">    4523</span>                 :             :         // Copy the backup to the actual wallet dir</span>
<span id="L4524"><span class="lineNum">    4524</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         fs::path temp_backup_location = fsbridge::AbsPathJoin(GetWalletDir(), backup_filename);</span></span>
<span id="L4525"><span class="lineNum">    4525</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         fs::copy_file(backup_path, temp_backup_location, fs::copy_options::none);</span></span>
<span id="L4526"><span class="lineNum">    4526</span>                 :             : </span>
<span id="L4527"><span class="lineNum">    4527</span>                 :             :         // Make list of wallets to cleanup</span>
<span id="L4528"><span class="lineNum">    4528</span>                 :<span class="tlaUNC">           0 :         std::vector&lt;std::shared_ptr&lt;CWallet&gt;&gt; created_wallets;</span></span>
<span id="L4529"><span class="lineNum">    4529</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (local_wallet) created_wallets.push_back(std::move(local_wallet));</span></span>
<span id="L4530"><span class="lineNum">    4530</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (res.watchonly_wallet) created_wallets.push_back(std::move(res.watchonly_wallet));</span></span>
<span id="L4531"><span class="lineNum">    4531</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (res.solvables_wallet) created_wallets.push_back(std::move(res.solvables_wallet));</span></span>
<span id="L4532"><span class="lineNum">    4532</span>                 :             : </span>
<span id="L4533"><span class="lineNum">    4533</span>                 :             :         // Get the directories to remove after unloading</span>
<span id="L4534"><span class="lineNum">    4534</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (std::shared_ptr&lt;CWallet&gt;&amp; w : created_wallets) {</span></span>
<span id="L4535"><span class="lineNum">    4535</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             wallet_dirs.emplace(fs::PathFromString(w-&gt;GetDatabase().Filename()).parent_path());</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L4536"><span class="lineNum">    4536</span>                 :             :         }</span>
<span id="L4537"><span class="lineNum">    4537</span>                 :             : </span>
<span id="L4538"><span class="lineNum">    4538</span>                 :             :         // Unload the wallets</span>
<span id="L4539"><span class="lineNum">    4539</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (std::shared_ptr&lt;CWallet&gt;&amp; w : created_wallets) {</span></span>
<span id="L4540"><span class="lineNum">    4540</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (w-&gt;HaveChain()) {</span></span>
<span id="L4541"><span class="lineNum">    4541</span>                 :             :                 // Unloading for wallets that were loaded for normal use</span>
<span id="L4542"><span class="lineNum">    4542</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 if (!RemoveWallet(context, w, /*load_on_start=*/false)) {</span></span>
<span id="L4543"><span class="lineNum">    4543</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     error += _(&quot;\nUnable to cleanup failed migration&quot;);</span></span>
<span id="L4544"><span class="lineNum">    4544</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     return util::Error{error};</span></span>
<span id="L4545"><span class="lineNum">    4545</span>                 :             :                 }</span>
<span id="L4546"><span class="lineNum">    4546</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 WaitForDeleteWallet(std::move(w));</span></span>
<span id="L4547"><span class="lineNum">    4547</span>                 :             :             } else {</span>
<span id="L4548"><span class="lineNum">    4548</span>                 :             :                 // Unloading for wallets in local context</span>
<span id="L4549"><span class="lineNum">    4549</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 assert(w.use_count() == 1);</span></span>
<span id="L4550"><span class="lineNum">    4550</span>                 :<span class="tlaUNC">           0 :                 w.reset();</span></span>
<span id="L4551"><span class="lineNum">    4551</span>                 :             :             }</span>
<span id="L4552"><span class="lineNum">    4552</span>                 :             :         }</span>
<span id="L4553"><span class="lineNum">    4553</span>                 :             : </span>
<span id="L4554"><span class="lineNum">    4554</span>                 :             :         // Delete the wallet directories</span>
<span id="L4555"><span class="lineNum">    4555</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (const fs::path&amp; dir : wallet_dirs) {</span></span>
<span id="L4556"><span class="lineNum">    4556</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             fs::remove_all(dir);</span></span>
<span id="L4557"><span class="lineNum">    4557</span>                 :             :         }</span>
<span id="L4558"><span class="lineNum">    4558</span>                 :             : </span>
<span id="L4559"><span class="lineNum">    4559</span>                 :             :         // Restore the backup</span>
<span id="L4560"><span class="lineNum">    4560</span>                 :<span class="tlaUNC">           0 :         DatabaseStatus status;</span></span>
<span id="L4561"><span class="lineNum">    4561</span>                 :<span class="tlaUNC">           0 :         std::vector&lt;bilingual_str&gt; warnings;</span></span>
<span id="L4562"><span class="lineNum">    4562</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         if (!RestoreWallet(context, temp_backup_location, wallet_name, /*load_on_start=*/std::nullopt, status, error, warnings)) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L4563"><span class="lineNum">    4563</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             error += _(&quot;\nUnable to restore backup of wallet.&quot;);</span></span>
<span id="L4564"><span class="lineNum">    4564</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             return util::Error{error};</span></span>
<span id="L4565"><span class="lineNum">    4565</span>                 :             :         }</span>
<span id="L4566"><span class="lineNum">    4566</span>                 :             : </span>
<span id="L4567"><span class="lineNum">    4567</span>                 :             :         // Move the backup to the wallet dir</span>
<span id="L4568"><span class="lineNum">    4568</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         fs::copy_file(temp_backup_location, backup_path, fs::copy_options::none);</span></span>
<span id="L4569"><span class="lineNum">    4569</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         fs::remove(temp_backup_location);</span></span>
<span id="L4570"><span class="lineNum">    4570</span>                 :             : </span>
<span id="L4571"><span class="lineNum">    4571</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         return util::Error{error};</span></span>
<span id="L4572"><span class="lineNum">    4572</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L4573"><span class="lineNum">    4573</span>                 :<span class="tlaUNC">           0 :     return res;</span></span>
<span id="L4574"><span class="lineNum">    4574</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L4575"><span class="lineNum">    4575</span>                 :             : </span>
<span id="L4576"><span class="lineNum">    4576</span>                 :<span class="tlaUNC">           0 : void CWallet::CacheNewScriptPubKeys(const std::set&lt;CScript&gt;&amp; spks, ScriptPubKeyMan* spkm)</span></span>
<span id="L4577"><span class="lineNum">    4577</span>                 :             : {</span>
<span id="L4578"><span class="lineNum">    4578</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (const auto&amp; script : spks) {</span></span>
<span id="L4579"><span class="lineNum">    4579</span>                 :<span class="tlaUNC">           0 :         m_cached_spks[script].push_back(spkm);</span></span>
<span id="L4580"><span class="lineNum">    4580</span>                 :             :     }</span>
<span id="L4581"><span class="lineNum">    4581</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L4582"><span class="lineNum">    4582</span>                 :             : </span>
<span id="L4583"><span class="lineNum">    4583</span>                 :<span class="tlaUNC">           0 : void CWallet::TopUpCallback(const std::set&lt;CScript&gt;&amp; spks, ScriptPubKeyMan* spkm)</span></span>
<span id="L4584"><span class="lineNum">    4584</span>                 :             : {</span>
<span id="L4585"><span class="lineNum">    4585</span>                 :             :     // Update scriptPubKey cache</span>
<span id="L4586"><span class="lineNum">    4586</span>                 :<span class="tlaUNC">           0 :     CacheNewScriptPubKeys(spks, spkm);</span></span>
<span id="L4587"><span class="lineNum">    4587</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L4588"><span class="lineNum">    4588</span>                 :             : </span>
<span id="L4589"><span class="lineNum">    4589</span>                 :<span class="tlaUNC">           0 : std::set&lt;CExtPubKey&gt; CWallet::GetActiveHDPubKeys() const</span></span>
<span id="L4590"><span class="lineNum">    4590</span>                 :             : {</span>
<span id="L4591"><span class="lineNum">    4591</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_wallet);</span></span>
<span id="L4592"><span class="lineNum">    4592</span>                 :             : </span>
<span id="L4593"><span class="lineNum">    4593</span>                 :<span class="tlaUNC">           0 :     Assert(IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS));</span></span>
<span id="L4594"><span class="lineNum">    4594</span>                 :             : </span>
<span id="L4595"><span class="lineNum">    4595</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     std::set&lt;CExtPubKey&gt; active_xpubs;</span></span>
<span id="L4596"><span class="lineNum">    4596</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (const auto&amp; spkm : GetActiveScriptPubKeyMans()) {</span></span>
<span id="L4597"><span class="lineNum">    4597</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         const DescriptorScriptPubKeyMan* desc_spkm = dynamic_cast&lt;DescriptorScriptPubKeyMan*&gt;(spkm);</span></span>
<span id="L4598"><span class="lineNum">    4598</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         assert(desc_spkm);</span></span>
<span id="L4599"><span class="lineNum">    4599</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LOCK(desc_spkm-&gt;cs_desc_man);</span></span>
<span id="L4600"><span class="lineNum">    4600</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         WalletDescriptor w_desc = desc_spkm-&gt;GetWalletDescriptor();</span></span>
<span id="L4601"><span class="lineNum">    4601</span>                 :             : </span>
<span id="L4602"><span class="lineNum">    4602</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         std::set&lt;CPubKey&gt; desc_pubkeys;</span></span>
<span id="L4603"><span class="lineNum">    4603</span>                 :<span class="tlaUNC">           0 :         std::set&lt;CExtPubKey&gt; desc_xpubs;</span></span>
<span id="L4604"><span class="lineNum">    4604</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         w_desc.descriptor-&gt;GetPubKeys(desc_pubkeys, desc_xpubs);</span></span>
<span id="L4605"><span class="lineNum">    4605</span>                 :<span class="tlaUNC">           0 :         active_xpubs.merge(std::move(desc_xpubs));</span></span>
<span id="L4606"><span class="lineNum">    4606</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     }</span></span>
<span id="L4607"><span class="lineNum">    4607</span>                 :<span class="tlaUNC">           0 :     return active_xpubs;</span></span>
<span id="L4608"><span class="lineNum">    4608</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L4609"><span class="lineNum">    4609</span>                 :             : </span>
<span id="L4610"><span class="lineNum">    4610</span>                 :<span class="tlaUNC">           0 : std::optional&lt;CKey&gt; CWallet::GetKey(const CKeyID&amp; keyid) const</span></span>
<span id="L4611"><span class="lineNum">    4611</span>                 :             : {</span>
<span id="L4612"><span class="lineNum">    4612</span>                 :<span class="tlaUNC">           0 :     Assert(IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS));</span></span>
<span id="L4613"><span class="lineNum">    4613</span>                 :             : </span>
<span id="L4614"><span class="lineNum">    4614</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (const auto&amp; spkm : GetAllScriptPubKeyMans()) {</span></span>
<span id="L4615"><span class="lineNum">    4615</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         const DescriptorScriptPubKeyMan* desc_spkm = dynamic_cast&lt;DescriptorScriptPubKeyMan*&gt;(spkm);</span></span>
<span id="L4616"><span class="lineNum">    4616</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         assert(desc_spkm);</span></span>
<span id="L4617"><span class="lineNum">    4617</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LOCK(desc_spkm-&gt;cs_desc_man);</span></span>
<span id="L4618"><span class="lineNum">    4618</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (std::optional&lt;CKey&gt; key = desc_spkm-&gt;GetKey(keyid)) {</span></span>
<span id="L4619"><span class="lineNum">    4619</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             return key;</span></span>
<span id="L4620"><span class="lineNum">    4620</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         }</span></span>
<span id="L4621"><span class="lineNum">    4621</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L4622"><span class="lineNum">    4622</span>                 :<span class="tlaUNC">           0 :     return std::nullopt;</span></span>
<span id="L4623"><span class="lineNum">    4623</span>                 :             : }</span>
<span id="L4624"><span class="lineNum">    4624</span>                 :             : } // namespace wallet</span>
        </pre>
              </td>
            </tr>
          </table>
          <br>

          <table width="100%" border=0 cellspacing=0 cellpadding=0>
            <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
            <tr><td class="versionInfo">Generated by: <a href="https://github.com//linux-test-project/lcov" target="_parent">LCOV version 2.0-1</a></td></tr>
          </table>
          <br>

</body>
</html>
