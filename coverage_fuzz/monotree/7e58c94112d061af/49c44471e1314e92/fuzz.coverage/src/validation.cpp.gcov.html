<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - fuzz_coverage.info - src/validation.cpp</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

          <table width="100%" border=0 cellspacing=0 cellpadding=0>
            <tr><td class="title">LCOV - code coverage report</td></tr>
            <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

            <tr>
              <td width="100%">
                <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="10%" class="headerValue"><a href="../index.html" title="Click to go to top-level">top level</a> - <a href="index.html" title="Click to go to directory src">src</a> - validation.cpp<span style="font-size: 80%;"> (source / <a href="validation.cpp.func-c.html" title="Click to go to function table">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="5%"></td>
            <td width="5%" class="headerCovTableHead">Coverage</td>
            <td width="5%" class="headerCovTableHead" title="Covered + Uncovered code">Total</td>
            <td width="5%" class="headerCovTableHead" title="Exercised code only">Hit</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">fuzz_coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntryLo">70.6&nbsp;%</td>
            <td class="headerCovTableEntry">2970</td>
            <td class="headerCovTableEntry">2098</td>
          </tr>
          <tr>
            <td class="headerItem">Test Date:</td>
            <td class="headerValue">2025-09-02 14:23:13</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntryMed">83.5&nbsp;%</td>
            <td class="headerCovTableEntry">164</td>
            <td class="headerCovTableEntry">137</td>
          </tr>
          <tr>
            <td></td>
            <td></td>
            <td></td>
            <td class="headerItem">Branches:</td>
            <td class="headerCovTableEntryLo">41.2&nbsp;%</td>
            <td class="headerCovTableEntry">5436</td>
            <td class="headerCovTableEntry">2237</td>
          </tr>
                  <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
                </table>
              </td>
            </tr>

            <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
          </table>

          <table cellpadding=0 cellspacing=0 border=0>
            <tr>
              <td><br></td>
            </tr>
            <tr>
              <td>
<pre class="sourceHeading">             Branch data     Line data    Source code</pre>
<pre class="source">
<span id="L1"><span class="lineNum">       1</span>                 :             : // Copyright (c) 2009-2010 Satoshi Nakamoto</span>
<span id="L2"><span class="lineNum">       2</span>                 :             : // Copyright (c) 2009-present The Bitcoin Core developers</span>
<span id="L3"><span class="lineNum">       3</span>                 :             : // Distributed under the MIT software license, see the accompanying</span>
<span id="L4"><span class="lineNum">       4</span>                 :             : // file COPYING or http://www.opensource.org/licenses/mit-license.php.</span>
<span id="L5"><span class="lineNum">       5</span>                 :             : </span>
<span id="L6"><span class="lineNum">       6</span>                 :             : #include &lt;bitcoin-build-config.h&gt; // IWYU pragma: keep</span>
<span id="L7"><span class="lineNum">       7</span>                 :             : </span>
<span id="L8"><span class="lineNum">       8</span>                 :             : #include &lt;validation.h&gt;</span>
<span id="L9"><span class="lineNum">       9</span>                 :             : </span>
<span id="L10"><span class="lineNum">      10</span>                 :             : #include &lt;arith_uint256.h&gt;</span>
<span id="L11"><span class="lineNum">      11</span>                 :             : #include &lt;chain.h&gt;</span>
<span id="L12"><span class="lineNum">      12</span>                 :             : #include &lt;checkqueue.h&gt;</span>
<span id="L13"><span class="lineNum">      13</span>                 :             : #include &lt;clientversion.h&gt;</span>
<span id="L14"><span class="lineNum">      14</span>                 :             : #include &lt;consensus/amount.h&gt;</span>
<span id="L15"><span class="lineNum">      15</span>                 :             : #include &lt;consensus/consensus.h&gt;</span>
<span id="L16"><span class="lineNum">      16</span>                 :             : #include &lt;consensus/merkle.h&gt;</span>
<span id="L17"><span class="lineNum">      17</span>                 :             : #include &lt;consensus/tx_check.h&gt;</span>
<span id="L18"><span class="lineNum">      18</span>                 :             : #include &lt;consensus/tx_verify.h&gt;</span>
<span id="L19"><span class="lineNum">      19</span>                 :             : #include &lt;consensus/validation.h&gt;</span>
<span id="L20"><span class="lineNum">      20</span>                 :             : #include &lt;cuckoocache.h&gt;</span>
<span id="L21"><span class="lineNum">      21</span>                 :             : #include &lt;flatfile.h&gt;</span>
<span id="L22"><span class="lineNum">      22</span>                 :             : #include &lt;hash.h&gt;</span>
<span id="L23"><span class="lineNum">      23</span>                 :             : #include &lt;kernel/chain.h&gt;</span>
<span id="L24"><span class="lineNum">      24</span>                 :             : #include &lt;kernel/chainparams.h&gt;</span>
<span id="L25"><span class="lineNum">      25</span>                 :             : #include &lt;kernel/coinstats.h&gt;</span>
<span id="L26"><span class="lineNum">      26</span>                 :             : #include &lt;kernel/disconnected_transactions.h&gt;</span>
<span id="L27"><span class="lineNum">      27</span>                 :             : #include &lt;kernel/mempool_entry.h&gt;</span>
<span id="L28"><span class="lineNum">      28</span>                 :             : #include &lt;kernel/messagestartchars.h&gt;</span>
<span id="L29"><span class="lineNum">      29</span>                 :             : #include &lt;kernel/notifications_interface.h&gt;</span>
<span id="L30"><span class="lineNum">      30</span>                 :             : #include &lt;kernel/warning.h&gt;</span>
<span id="L31"><span class="lineNum">      31</span>                 :             : #include &lt;logging.h&gt;</span>
<span id="L32"><span class="lineNum">      32</span>                 :             : #include &lt;logging/timer.h&gt;</span>
<span id="L33"><span class="lineNum">      33</span>                 :             : #include &lt;node/blockstorage.h&gt;</span>
<span id="L34"><span class="lineNum">      34</span>                 :             : #include &lt;node/utxo_snapshot.h&gt;</span>
<span id="L35"><span class="lineNum">      35</span>                 :             : #include &lt;policy/ephemeral_policy.h&gt;</span>
<span id="L36"><span class="lineNum">      36</span>                 :             : #include &lt;policy/policy.h&gt;</span>
<span id="L37"><span class="lineNum">      37</span>                 :             : #include &lt;policy/rbf.h&gt;</span>
<span id="L38"><span class="lineNum">      38</span>                 :             : #include &lt;policy/settings.h&gt;</span>
<span id="L39"><span class="lineNum">      39</span>                 :             : #include &lt;policy/truc_policy.h&gt;</span>
<span id="L40"><span class="lineNum">      40</span>                 :             : #include &lt;pow.h&gt;</span>
<span id="L41"><span class="lineNum">      41</span>                 :             : #include &lt;primitives/block.h&gt;</span>
<span id="L42"><span class="lineNum">      42</span>                 :             : #include &lt;primitives/transaction.h&gt;</span>
<span id="L43"><span class="lineNum">      43</span>                 :             : #include &lt;random.h&gt;</span>
<span id="L44"><span class="lineNum">      44</span>                 :             : #include &lt;script/script.h&gt;</span>
<span id="L45"><span class="lineNum">      45</span>                 :             : #include &lt;script/sigcache.h&gt;</span>
<span id="L46"><span class="lineNum">      46</span>                 :             : #include &lt;signet.h&gt;</span>
<span id="L47"><span class="lineNum">      47</span>                 :             : #include &lt;tinyformat.h&gt;</span>
<span id="L48"><span class="lineNum">      48</span>                 :             : #include &lt;txdb.h&gt;</span>
<span id="L49"><span class="lineNum">      49</span>                 :             : #include &lt;txmempool.h&gt;</span>
<span id="L50"><span class="lineNum">      50</span>                 :             : #include &lt;uint256.h&gt;</span>
<span id="L51"><span class="lineNum">      51</span>                 :             : #include &lt;undo.h&gt;</span>
<span id="L52"><span class="lineNum">      52</span>                 :             : #include &lt;util/check.h&gt;</span>
<span id="L53"><span class="lineNum">      53</span>                 :             : #include &lt;util/fs.h&gt;</span>
<span id="L54"><span class="lineNum">      54</span>                 :             : #include &lt;util/fs_helpers.h&gt;</span>
<span id="L55"><span class="lineNum">      55</span>                 :             : #include &lt;util/hasher.h&gt;</span>
<span id="L56"><span class="lineNum">      56</span>                 :             : #include &lt;util/moneystr.h&gt;</span>
<span id="L57"><span class="lineNum">      57</span>                 :             : #include &lt;util/rbf.h&gt;</span>
<span id="L58"><span class="lineNum">      58</span>                 :             : #include &lt;util/result.h&gt;</span>
<span id="L59"><span class="lineNum">      59</span>                 :             : #include &lt;util/signalinterrupt.h&gt;</span>
<span id="L60"><span class="lineNum">      60</span>                 :             : #include &lt;util/strencodings.h&gt;</span>
<span id="L61"><span class="lineNum">      61</span>                 :             : #include &lt;util/string.h&gt;</span>
<span id="L62"><span class="lineNum">      62</span>                 :             : #include &lt;util/time.h&gt;</span>
<span id="L63"><span class="lineNum">      63</span>                 :             : #include &lt;util/trace.h&gt;</span>
<span id="L64"><span class="lineNum">      64</span>                 :             : #include &lt;util/translation.h&gt;</span>
<span id="L65"><span class="lineNum">      65</span>                 :             : #include &lt;validationinterface.h&gt;</span>
<span id="L66"><span class="lineNum">      66</span>                 :             : </span>
<span id="L67"><span class="lineNum">      67</span>                 :             : #include &lt;algorithm&gt;</span>
<span id="L68"><span class="lineNum">      68</span>                 :             : #include &lt;cassert&gt;</span>
<span id="L69"><span class="lineNum">      69</span>                 :             : #include &lt;chrono&gt;</span>
<span id="L70"><span class="lineNum">      70</span>                 :             : #include &lt;deque&gt;</span>
<span id="L71"><span class="lineNum">      71</span>                 :             : #include &lt;numeric&gt;</span>
<span id="L72"><span class="lineNum">      72</span>                 :             : #include &lt;optional&gt;</span>
<span id="L73"><span class="lineNum">      73</span>                 :             : #include &lt;ranges&gt;</span>
<span id="L74"><span class="lineNum">      74</span>                 :             : #include &lt;span&gt;</span>
<span id="L75"><span class="lineNum">      75</span>                 :             : #include &lt;string&gt;</span>
<span id="L76"><span class="lineNum">      76</span>                 :             : #include &lt;tuple&gt;</span>
<span id="L77"><span class="lineNum">      77</span>                 :             : #include &lt;utility&gt;</span>
<span id="L78"><span class="lineNum">      78</span>                 :             : </span>
<span id="L79"><span class="lineNum">      79</span>                 :             : using kernel::CCoinsStats;</span>
<span id="L80"><span class="lineNum">      80</span>                 :             : using kernel::CoinStatsHashType;</span>
<span id="L81"><span class="lineNum">      81</span>                 :             : using kernel::ComputeUTXOStats;</span>
<span id="L82"><span class="lineNum">      82</span>                 :             : using kernel::Notifications;</span>
<span id="L83"><span class="lineNum">      83</span>                 :             : </span>
<span id="L84"><span class="lineNum">      84</span>                 :             : using fsbridge::FopenFn;</span>
<span id="L85"><span class="lineNum">      85</span>                 :             : using node::BlockManager;</span>
<span id="L86"><span class="lineNum">      86</span>                 :             : using node::BlockMap;</span>
<span id="L87"><span class="lineNum">      87</span>                 :             : using node::CBlockIndexHeightOnlyComparator;</span>
<span id="L88"><span class="lineNum">      88</span>                 :             : using node::CBlockIndexWorkComparator;</span>
<span id="L89"><span class="lineNum">      89</span>                 :             : using node::SnapshotMetadata;</span>
<span id="L90"><span class="lineNum">      90</span>                 :             : </span>
<span id="L91"><span class="lineNum">      91</span>                 :             : /** Size threshold for warning about slow UTXO set flush to disk. */</span>
<span id="L92"><span class="lineNum">      92</span>                 :             : static constexpr size_t WARN_FLUSH_COINS_SIZE = 1 &lt;&lt; 30; // 1 GiB</span>
<span id="L93"><span class="lineNum">      93</span>                 :             : /** Time window to wait between writing blocks/block index and chainstate to disk.</span>
<span id="L94"><span class="lineNum">      94</span>                 :             :  *  Randomize writing time inside the window to prevent a situation where the</span>
<span id="L95"><span class="lineNum">      95</span>                 :             :  *  network over time settles into a few cohorts of synchronized writers.</span>
<span id="L96"><span class="lineNum">      96</span>                 :             : */</span>
<span id="L97"><span class="lineNum">      97</span>                 :             : static constexpr auto DATABASE_WRITE_INTERVAL_MIN{50min};</span>
<span id="L98"><span class="lineNum">      98</span>                 :             : static constexpr auto DATABASE_WRITE_INTERVAL_MAX{70min};</span>
<span id="L99"><span class="lineNum">      99</span>                 :             : /** Maximum age of our tip for us to be considered current for fee estimation */</span>
<span id="L100"><span class="lineNum">     100</span>                 :             : static constexpr std::chrono::hours MAX_FEE_ESTIMATION_TIP_AGE{3};</span>
<span id="L101"><span class="lineNum">     101</span>                 :             : const std::vector&lt;std::string&gt; CHECKLEVEL_DOC {</span>
<span id="L102"><span class="lineNum">     102</span>                 :             :     &quot;level 0 reads the blocks from disk&quot;,</span>
<span id="L103"><span class="lineNum">     103</span>                 :             :     &quot;level 1 verifies block validity&quot;,</span>
<span id="L104"><span class="lineNum">     104</span>                 :             :     &quot;level 2 verifies undo data&quot;,</span>
<span id="L105"><span class="lineNum">     105</span>                 :             :     &quot;level 3 checks disconnection of tip blocks&quot;,</span>
<span id="L106"><span class="lineNum">     106</span>                 :             :     &quot;level 4 tries to reconnect the blocks&quot;,</span>
<span id="L107"><span class="lineNum">     107</span>                 :             :     &quot;each level includes the checks of the previous levels&quot;,</span>
<span id="L108"><span class="lineNum">     108</span>                 :             : };</span>
<span id="L109"><span class="lineNum">     109</span>                 :             : /** The number of blocks to keep below the deepest prune lock.</span>
<span id="L110"><span class="lineNum">     110</span>                 :             :  *  There is nothing special about this number. It is higher than what we</span>
<span id="L111"><span class="lineNum">     111</span>                 :             :  *  expect to see in regular mainnet reorgs, but not so high that it would</span>
<span id="L112"><span class="lineNum">     112</span>                 :             :  *  noticeably interfere with the pruning mechanism.</span>
<span id="L113"><span class="lineNum">     113</span>                 :             :  * */</span>
<span id="L114"><span class="lineNum">     114</span>                 :             : static constexpr int PRUNE_LOCK_BUFFER{10};</span>
<span id="L115"><span class="lineNum">     115</span>                 :             : </span>
<span id="L116"><span class="lineNum">     116</span>                 :             : TRACEPOINT_SEMAPHORE(validation, block_connected);</span>
<span id="L117"><span class="lineNum">     117</span>                 :             : TRACEPOINT_SEMAPHORE(utxocache, flush);</span>
<span id="L118"><span class="lineNum">     118</span>                 :             : TRACEPOINT_SEMAPHORE(mempool, replaced);</span>
<span id="L119"><span class="lineNum">     119</span>                 :             : TRACEPOINT_SEMAPHORE(mempool, rejected);</span>
<span id="L120"><span class="lineNum">     120</span>                 :             : </span>
<span id="L121"><span class="lineNum">     121</span>                 :<span class="tlaGNC">        1959 : const CBlockIndex* Chainstate::FindForkInGlobalIndex(const CBlockLocator&amp; locator) const</span></span>
<span id="L122"><span class="lineNum">     122</span>                 :             : {</span>
<span id="L123"><span class="lineNum">     123</span>                 :<span class="tlaGNC">        1959 :     AssertLockHeld(cs_main);</span></span>
<span id="L124"><span class="lineNum">     124</span>                 :             : </span>
<span id="L125"><span class="lineNum">     125</span>                 :             :     // Find the latest block common to locator and chain - we expect that</span>
<span id="L126"><span class="lineNum">     126</span>                 :             :     // locator.vHave is sorted descending by height.</span>
<span id="L127"><span class="lineNum">     127</span>         [<span class="tlaGBC" title="Branch 0 was taken 4402 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 1862 times"> + </span>]:<span class="tlaGNC">        6264 :     for (const uint256&amp; hash : locator.vHave) {</span></span>
<span id="L128"><span class="lineNum">     128</span>                 :<span class="tlaGNC">        4402 :         const CBlockIndex* pindex{m_blockman.LookupBlockIndex(hash)};</span></span>
<span id="L129"><span class="lineNum">     129</span>         [<span class="tlaGBC" title="Branch 0 was taken 97 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 4305 times"> + </span>]:<span class="tlaGNC">        4402 :         if (pindex) {</span></span>
<span id="L130"><span class="lineNum">     130</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 97 times"> + </span>]:<span class="tlaGNC">          97 :             if (m_chain.Contains(pindex)) {</span></span>
<span id="L131"><span class="lineNum">     131</span>                 :             :                 return pindex;</span>
<span id="L132"><span class="lineNum">     132</span>                 :             :             }</span>
<span id="L133"><span class="lineNum">     133</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             if (pindex-&gt;GetAncestor(m_chain.Height()) == m_chain.Tip()) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L134"><span class="lineNum">     134</span>                 :<span class="tlaGNC">        1959 :                 return m_chain.Tip();</span></span>
<span id="L135"><span class="lineNum">     135</span>                 :             :             }</span>
<span id="L136"><span class="lineNum">     136</span>                 :             :         }</span>
<span id="L137"><span class="lineNum">     137</span>                 :             :     }</span>
<span id="L138"><span class="lineNum">     138</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 1862 times"> + </span>]:<span class="tlaGNC">        1862 :     return m_chain.Genesis();</span></span>
<span id="L139"><span class="lineNum">     139</span>                 :             : }</span>
<span id="L140"><span class="lineNum">     140</span>                 :             : </span>
<span id="L141"><span class="lineNum">     141</span>                 :             : bool CheckInputScripts(const CTransaction&amp; tx, TxValidationState&amp; state,</span>
<span id="L142"><span class="lineNum">     142</span>                 :             :                        const CCoinsViewCache&amp; inputs, unsigned int flags, bool cacheSigStore,</span>
<span id="L143"><span class="lineNum">     143</span>                 :             :                        bool cacheFullScriptStore, PrecomputedTransactionData&amp; txdata,</span>
<span id="L144"><span class="lineNum">     144</span>                 :             :                        ValidationCache&amp; validation_cache,</span>
<span id="L145"><span class="lineNum">     145</span>                 :             :                        std::vector&lt;CScriptCheck&gt;* pvChecks = nullptr)</span>
<span id="L146"><span class="lineNum">     146</span>                 :             :                        EXCLUSIVE_LOCKS_REQUIRED(cs_main);</span>
<span id="L147"><span class="lineNum">     147</span>                 :             : </span>
<span id="L148"><span class="lineNum">     148</span>                 :<span class="tlaGNC">     2174858 : bool CheckFinalTxAtTip(const CBlockIndex&amp; active_chain_tip, const CTransaction&amp; tx)</span></span>
<span id="L149"><span class="lineNum">     149</span>                 :             : {</span>
<span id="L150"><span class="lineNum">     150</span>                 :<span class="tlaGNC">     2174858 :     AssertLockHeld(cs_main);</span></span>
<span id="L151"><span class="lineNum">     151</span>                 :             : </span>
<span id="L152"><span class="lineNum">     152</span>                 :             :     // CheckFinalTxAtTip() uses active_chain_tip.Height()+1 to evaluate</span>
<span id="L153"><span class="lineNum">     153</span>                 :             :     // nLockTime because when IsFinalTx() is called within</span>
<span id="L154"><span class="lineNum">     154</span>                 :             :     // AcceptBlock(), the height of the block *being*</span>
<span id="L155"><span class="lineNum">     155</span>                 :             :     // evaluated is what is used. Thus if we want to know if a</span>
<span id="L156"><span class="lineNum">     156</span>                 :             :     // transaction can be part of the *next* block, we need to call</span>
<span id="L157"><span class="lineNum">     157</span>                 :             :     // IsFinalTx() with one more than active_chain_tip.Height().</span>
<span id="L158"><span class="lineNum">     158</span>                 :<span class="tlaGNC">     2174858 :     const int nBlockHeight = active_chain_tip.nHeight + 1;</span></span>
<span id="L159"><span class="lineNum">     159</span>                 :             : </span>
<span id="L160"><span class="lineNum">     160</span>                 :             :     // BIP113 requires that time-locked transactions have nLockTime set to</span>
<span id="L161"><span class="lineNum">     161</span>                 :             :     // less than the median time of the previous block they're contained in.</span>
<span id="L162"><span class="lineNum">     162</span>                 :             :     // When the next block is created its previous block will be the current</span>
<span id="L163"><span class="lineNum">     163</span>                 :             :     // chain tip, so we use that to calculate the median time passed to</span>
<span id="L164"><span class="lineNum">     164</span>                 :             :     // IsFinalTx().</span>
<span id="L165"><span class="lineNum">     165</span>                 :<span class="tlaGNC">     2174858 :     const int64_t nBlockTime{active_chain_tip.GetMedianTimePast()};</span></span>
<span id="L166"><span class="lineNum">     166</span>                 :             : </span>
<span id="L167"><span class="lineNum">     167</span>                 :<span class="tlaGNC">     2174858 :     return IsFinalTx(tx, nBlockHeight, nBlockTime);</span></span>
<span id="L168"><span class="lineNum">     168</span>                 :             : }</span>
<span id="L169"><span class="lineNum">     169</span>                 :             : </span>
<span id="L170"><span class="lineNum">     170</span>                 :             : namespace {</span>
<span id="L171"><span class="lineNum">     171</span>                 :             : /**</span>
<span id="L172"><span class="lineNum">     172</span>                 :             :  * A helper which calculates heights of inputs of a given transaction.</span>
<span id="L173"><span class="lineNum">     173</span>                 :             :  *</span>
<span id="L174"><span class="lineNum">     174</span>                 :             :  * @param[in] tip    The current chain tip. If an input belongs to a mempool</span>
<span id="L175"><span class="lineNum">     175</span>                 :             :  *                   transaction, we assume it will be confirmed in the next block.</span>
<span id="L176"><span class="lineNum">     176</span>                 :             :  * @param[in] coins  Any CCoinsView that provides access to the relevant coins.</span>
<span id="L177"><span class="lineNum">     177</span>                 :             :  * @param[in] tx     The transaction being evaluated.</span>
<span id="L178"><span class="lineNum">     178</span>                 :             :  *</span>
<span id="L179"><span class="lineNum">     179</span>                 :             :  * @returns A vector of input heights or nullopt, in case of an error.</span>
<span id="L180"><span class="lineNum">     180</span>                 :             :  */</span>
<span id="L181"><span class="lineNum">     181</span>                 :<span class="tlaGNC">     1267937 : std::optional&lt;std::vector&lt;int&gt;&gt; CalculatePrevHeights(</span></span>
<span id="L182"><span class="lineNum">     182</span>                 :             :     const CBlockIndex&amp; tip,</span>
<span id="L183"><span class="lineNum">     183</span>                 :             :     const CCoinsView&amp; coins,</span>
<span id="L184"><span class="lineNum">     184</span>                 :             :     const CTransaction&amp; tx)</span>
<span id="L185"><span class="lineNum">     185</span>                 :             : {</span>
<span id="L186"><span class="lineNum">     186</span>                 :<span class="tlaGNC">     1267937 :     std::vector&lt;int&gt; prev_heights;</span></span>
<span id="L187"><span class="lineNum">     187</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 1267937 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 1267937 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">     1267937 :     prev_heights.resize(tx.vin.size());</span></span>
<span id="L188"><span class="lineNum">     188</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 8147226 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 6879289 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 1267937 times"> + </span>]:<span class="tlaGNC">     8147226 :     for (size_t i = 0; i &lt; tx.vin.size(); ++i) {</span></span>
<span id="L189"><span class="lineNum">     189</span>   [<span class="tlaGBC" title="Branch 0 was taken 6879289 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 6879289 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">     6879289 :         if (auto coin{coins.GetCoin(tx.vin[i].prevout)}) {</span></span>
<span id="L190"><span class="lineNum">     190</span>         [<span class="tlaGBC" title="Branch 0 was taken 3447355 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 3431934 times"> + </span>]:<span class="tlaGNC">    13758578 :             prev_heights[i] = coin-&gt;nHeight == MEMPOOL_HEIGHT</span></span>
<span id="L191"><span class="lineNum">     191</span>         [<span class="tlaGBC" title="Branch 0 was taken 3447355 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 3431934 times"> + </span>]:<span class="tlaGNC">     6879289 :                               ? tip.nHeight + 1 // Assume all mempool transaction confirm in the next block.</span></span>
<span id="L192"><span class="lineNum">     192</span>                 :<span class="tlaGNC">     3431934 :                               : coin-&gt;nHeight;</span></span>
<span id="L193"><span class="lineNum">     193</span>                 :             :         } else {</span>
<span id="L194"><span class="lineNum">     194</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             LogPrintf(&quot;ERROR: %s: Missing input %d in transaction \'%s\'\n&quot;, __func__, i, tx.GetHash().GetHex());</span></span>
<span id="L195"><span class="lineNum">     195</span>                 :<span class="tlaUNC">           0 :             return std::nullopt;</span></span>
<span id="L196"><span class="lineNum">     196</span>                 :<span class="tlaGNC">     6879289 :         }</span></span>
<span id="L197"><span class="lineNum">     197</span>                 :             :     }</span>
<span id="L198"><span class="lineNum">     198</span>                 :<span class="tlaGNC">     1267937 :     return prev_heights;</span></span>
<span id="L199"><span class="lineNum">     199</span>                 :<span class="tlaGNC">     1267937 : }</span></span>
<span id="L200"><span class="lineNum">     200</span>                 :             : } // namespace</span>
<span id="L201"><span class="lineNum">     201</span>                 :             : </span>
<span id="L202"><span class="lineNum">     202</span>                 :<span class="tlaGNC">     1267937 : std::optional&lt;LockPoints&gt; CalculateLockPointsAtTip(</span></span>
<span id="L203"><span class="lineNum">     203</span>                 :             :     CBlockIndex* tip,</span>
<span id="L204"><span class="lineNum">     204</span>                 :             :     const CCoinsView&amp; coins_view,</span>
<span id="L205"><span class="lineNum">     205</span>                 :             :     const CTransaction&amp; tx)</span>
<span id="L206"><span class="lineNum">     206</span>                 :             : {</span>
<span id="L207"><span class="lineNum">     207</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 1267937 times"> + </span>]:<span class="tlaGNC">     1267937 :     assert(tip);</span></span>
<span id="L208"><span class="lineNum">     208</span>                 :             : </span>
<span id="L209"><span class="lineNum">     209</span>                 :<span class="tlaGNC">     1267937 :     auto prev_heights{CalculatePrevHeights(*tip, coins_view, tx)};</span></span>
<span id="L210"><span class="lineNum">     210</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 1267937 times"> + </span>]:<span class="tlaGNC">     1267937 :     if (!prev_heights.has_value()) return std::nullopt;</span></span>
<span id="L211"><span class="lineNum">     211</span>                 :             : </span>
<span id="L212"><span class="lineNum">     212</span>                 :<span class="tlaGNC">     1267937 :     CBlockIndex next_tip;</span></span>
<span id="L213"><span class="lineNum">     213</span>                 :<span class="tlaGNC">     1267937 :     next_tip.pprev = tip;</span></span>
<span id="L214"><span class="lineNum">     214</span>                 :             :     // When SequenceLocks() is called within ConnectBlock(), the height</span>
<span id="L215"><span class="lineNum">     215</span>                 :             :     // of the block *being* evaluated is what is used.</span>
<span id="L216"><span class="lineNum">     216</span>                 :             :     // Thus if we want to know if a transaction can be part of the</span>
<span id="L217"><span class="lineNum">     217</span>                 :             :     // *next* block, we need to use one more than active_chainstate.m_chain.Height()</span>
<span id="L218"><span class="lineNum">     218</span>                 :<span class="tlaGNC">     1267937 :     next_tip.nHeight = tip-&gt;nHeight + 1;</span></span>
<span id="L219"><span class="lineNum">     219</span>   [<span class="tlaGBC" title="Branch 0 was taken 1267937 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 1267937 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">     1267937 :     const auto [min_height, min_time] = CalculateSequenceLocks(tx, STANDARD_LOCKTIME_VERIFY_FLAGS, prev_heights.value(), next_tip);</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 1267937 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L220"><span class="lineNum">     220</span>                 :             : </span>
<span id="L221"><span class="lineNum">     221</span>                 :             :     // Also store the hash of the block with the highest height of</span>
<span id="L222"><span class="lineNum">     222</span>                 :             :     // all the blocks which have sequence locked prevouts.</span>
<span id="L223"><span class="lineNum">     223</span>                 :             :     // This hash needs to still be on the chain</span>
<span id="L224"><span class="lineNum">     224</span>                 :             :     // for these LockPoint calculations to be valid</span>
<span id="L225"><span class="lineNum">     225</span>                 :             :     // Note: It is impossible to correctly calculate a maxInputBlock</span>
<span id="L226"><span class="lineNum">     226</span>                 :             :     // if any of the sequence locked inputs depend on unconfirmed txs,</span>
<span id="L227"><span class="lineNum">     227</span>                 :             :     // except in the special case where the relative lock time/height</span>
<span id="L228"><span class="lineNum">     228</span>                 :             :     // is 0, which is equivalent to no sequence lock. Since we assume</span>
<span id="L229"><span class="lineNum">     229</span>                 :             :     // input height of tip+1 for mempool txs and test the resulting</span>
<span id="L230"><span class="lineNum">     230</span>                 :             :     // min_height and min_time from CalculateSequenceLocks against tip+1.</span>
<span id="L231"><span class="lineNum">     231</span>                 :<span class="tlaGNC">     1267937 :     int max_input_height{0};</span></span>
<span id="L232"><span class="lineNum">     232</span>   [<span class="tlaGBC" title="Branch 0 was taken 1267937 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 6879289 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 1267937 times"> + </span>]:<span class="tlaGNC">     8147226 :     for (const int height : prev_heights.value()) {</span></span>
<span id="L233"><span class="lineNum">     233</span>                 :             :         // Can ignore mempool inputs since we'll fail if they had non-zero locks</span>
<span id="L234"><span class="lineNum">     234</span>         [<span class="tlaGBC" title="Branch 0 was taken 6362021 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 517268 times"> + </span>]:<span class="tlaGNC">     6879289 :         if (height != next_tip.nHeight) {</span></span>
<span id="L235"><span class="lineNum">     235</span>         [<span class="tlaGBC" title="Branch 0 was taken 6102930 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 259091 times"> + </span>]:<span class="tlaGNC">    12464951 :             max_input_height = std::max(max_input_height, height);</span></span>
<span id="L236"><span class="lineNum">     236</span>                 :             :         }</span>
<span id="L237"><span class="lineNum">     237</span>                 :             :     }</span>
<span id="L238"><span class="lineNum">     238</span>                 :             : </span>
<span id="L239"><span class="lineNum">     239</span>                 :             :     // tip-&gt;GetAncestor(max_input_height) should never return a nullptr</span>
<span id="L240"><span class="lineNum">     240</span>                 :             :     // because max_input_height is always less than the tip height.</span>
<span id="L241"><span class="lineNum">     241</span>                 :             :     // It would, however, be a bad bug to continue execution, since a</span>
<span id="L242"><span class="lineNum">     242</span>                 :             :     // LockPoints object with the maxInputBlock member set to nullptr</span>
<span id="L243"><span class="lineNum">     243</span>                 :             :     // signifies no relative lock time.</span>
<span id="L244"><span class="lineNum">     244</span>   [<span class="tlaGBC" title="Branch 0 was taken 1267937 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 1267937 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">     1267937 :     return LockPoints{min_height, min_time, Assert(tip-&gt;GetAncestor(max_input_height))};</span></span>
<span id="L245"><span class="lineNum">     245</span>                 :<span class="tlaGNC">     1267937 : }</span></span>
<span id="L246"><span class="lineNum">     246</span>                 :             : </span>
<span id="L247"><span class="lineNum">     247</span>                 :<span class="tlaGNC">     1267937 : bool CheckSequenceLocksAtTip(CBlockIndex* tip,</span></span>
<span id="L248"><span class="lineNum">     248</span>                 :             :                              const LockPoints&amp; lock_points)</span>
<span id="L249"><span class="lineNum">     249</span>                 :             : {</span>
<span id="L250"><span class="lineNum">     250</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 1267937 times"> + </span>]:<span class="tlaGNC">     1267937 :     assert(tip != nullptr);</span></span>
<span id="L251"><span class="lineNum">     251</span>                 :             : </span>
<span id="L252"><span class="lineNum">     252</span>                 :<span class="tlaGNC">     1267937 :     CBlockIndex index;</span></span>
<span id="L253"><span class="lineNum">     253</span>                 :<span class="tlaGNC">     1267937 :     index.pprev = tip;</span></span>
<span id="L254"><span class="lineNum">     254</span>                 :             :     // CheckSequenceLocksAtTip() uses active_chainstate.m_chain.Height()+1 to evaluate</span>
<span id="L255"><span class="lineNum">     255</span>                 :             :     // height based locks because when SequenceLocks() is called within</span>
<span id="L256"><span class="lineNum">     256</span>                 :             :     // ConnectBlock(), the height of the block *being*</span>
<span id="L257"><span class="lineNum">     257</span>                 :             :     // evaluated is what is used.</span>
<span id="L258"><span class="lineNum">     258</span>                 :             :     // Thus if we want to know if a transaction can be part of the</span>
<span id="L259"><span class="lineNum">     259</span>                 :             :     // *next* block, we need to use one more than active_chainstate.m_chain.Height()</span>
<span id="L260"><span class="lineNum">     260</span>                 :<span class="tlaGNC">     1267937 :     index.nHeight = tip-&gt;nHeight + 1;</span></span>
<span id="L261"><span class="lineNum">     261</span>                 :             : </span>
<span id="L262"><span class="lineNum">     262</span>                 :<span class="tlaGNC">     1267937 :     return EvaluateSequenceLocks(index, {lock_points.height, lock_points.time});</span></span>
<span id="L263"><span class="lineNum">     263</span>                 :             : }</span>
<span id="L264"><span class="lineNum">     264</span>                 :             : </span>
<span id="L265"><span class="lineNum">     265</span>                 :             : // Returns the script flags which should be checked for a given block</span>
<span id="L266"><span class="lineNum">     266</span>                 :             : static unsigned int GetBlockScriptFlags(const CBlockIndex&amp; block_index, const ChainstateManager&amp; chainman);</span>
<span id="L267"><span class="lineNum">     267</span>                 :             : </span>
<span id="L268"><span class="lineNum">     268</span>                 :<span class="tlaGNC">      461322 : static void LimitMempoolSize(CTxMemPool&amp; pool, CCoinsViewCache&amp; coins_cache)</span></span>
<span id="L269"><span class="lineNum">     269</span>                 :             :     EXCLUSIVE_LOCKS_REQUIRED(::cs_main, pool.cs)</span>
<span id="L270"><span class="lineNum">     270</span>                 :             : {</span>
<span id="L271"><span class="lineNum">     271</span>                 :<span class="tlaGNC">      461322 :     AssertLockHeld(::cs_main);</span></span>
<span id="L272"><span class="lineNum">     272</span>                 :<span class="tlaGNC">      461322 :     AssertLockHeld(pool.cs);</span></span>
<span id="L273"><span class="lineNum">     273</span>                 :<span class="tlaGNC">      461322 :     int expired = pool.Expire(GetTime&lt;std::chrono::seconds&gt;() - pool.m_opts.expiry);</span></span>
<span id="L274"><span class="lineNum">     274</span>         [<span class="tlaGBC" title="Branch 0 was taken 10255 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 451067 times"> + </span>]:<span class="tlaGNC">      461322 :     if (expired != 0) {</span></span>
<span id="L275"><span class="lineNum">     275</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 10255 times"> + </span>]:<span class="tlaGNC">       10255 :         LogDebug(BCLog::MEMPOOL, &quot;Expired %i transactions from the memory pool\n&quot;, expired);</span></span>
<span id="L276"><span class="lineNum">     276</span>                 :             :     }</span>
<span id="L277"><span class="lineNum">     277</span>                 :             : </span>
<span id="L278"><span class="lineNum">     278</span>                 :<span class="tlaGNC">      461322 :     std::vector&lt;COutPoint&gt; vNoSpendsRemaining;</span></span>
<span id="L279"><span class="lineNum">     279</span>         [<span class="tlaGBC" title="Branch 0 was taken 461322 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      461322 :     pool.TrimToSize(pool.m_opts.max_size_bytes, &amp;vNoSpendsRemaining);</span></span>
<span id="L280"><span class="lineNum">     280</span>         [<span class="tlaGBC" title="Branch 0 was taken 42642 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 461322 times"> + </span>]:<span class="tlaGNC">      503964 :     for (const COutPoint&amp; removed : vNoSpendsRemaining)</span></span>
<span id="L281"><span class="lineNum">     281</span>         [<span class="tlaGBC" title="Branch 0 was taken 42642 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       42642 :         coins_cache.Uncache(removed);</span></span>
<span id="L282"><span class="lineNum">     282</span>                 :<span class="tlaGNC">      461322 : }</span></span>
<span id="L283"><span class="lineNum">     283</span>                 :             : </span>
<span id="L284"><span class="lineNum">     284</span>                 :<span class="tlaGNC">      229876 : static bool IsCurrentForFeeEstimation(Chainstate&amp; active_chainstate) EXCLUSIVE_LOCKS_REQUIRED(cs_main)</span></span>
<span id="L285"><span class="lineNum">     285</span>                 :             : {</span>
<span id="L286"><span class="lineNum">     286</span>                 :<span class="tlaGNC">      229876 :     AssertLockHeld(cs_main);</span></span>
<span id="L287"><span class="lineNum">     287</span>         [<span class="tlaGBC" title="Branch 0 was taken 229876 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      229876 :     if (active_chainstate.m_chainman.IsInitialBlockDownload()) {</span></span>
<span id="L288"><span class="lineNum">     288</span>                 :             :         return false;</span>
<span id="L289"><span class="lineNum">     289</span>                 :             :     }</span>
<span id="L290"><span class="lineNum">     290</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 229876 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 19429 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 210447 times"> + </span>]:<span class="tlaGNC">      459752 :     if (active_chainstate.m_chain.Tip()-&gt;GetBlockTime() &lt; count_seconds(GetTime&lt;std::chrono::seconds&gt;() - MAX_FEE_ESTIMATION_TIP_AGE))</span></span>
<span id="L291"><span class="lineNum">     291</span>                 :             :         return false;</span>
<span id="L292"><span class="lineNum">     292</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 19429 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 19429 times"> + </span>]:<span class="tlaGNC">       19429 :     if (active_chainstate.m_chain.Height() &lt; active_chainstate.m_chainman.m_best_header-&gt;nHeight - 1) {</span></span>
<span id="L293"><span class="lineNum">     293</span>                 :<span class="tlaUNC">           0 :         return false;</span></span>
<span id="L294"><span class="lineNum">     294</span>                 :             :     }</span>
<span id="L295"><span class="lineNum">     295</span>                 :             :     return true;</span>
<span id="L296"><span class="lineNum">     296</span>                 :             : }</span>
<span id="L297"><span class="lineNum">     297</span>                 :             : </span>
<span id="L298"><span class="lineNum">     298</span>                 :<span class="tlaUNC">           0 : void Chainstate::MaybeUpdateMempoolForReorg(</span></span>
<span id="L299"><span class="lineNum">     299</span>                 :             :     DisconnectedBlockTransactions&amp; disconnectpool,</span>
<span id="L300"><span class="lineNum">     300</span>                 :             :     bool fAddToMempool)</span>
<span id="L301"><span class="lineNum">     301</span>                 :             : {</span>
<span id="L302"><span class="lineNum">     302</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!m_mempool) return;</span></span>
<span id="L303"><span class="lineNum">     303</span>                 :             : </span>
<span id="L304"><span class="lineNum">     304</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_main);</span></span>
<span id="L305"><span class="lineNum">     305</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(m_mempool-&gt;cs);</span></span>
<span id="L306"><span class="lineNum">     306</span>                 :<span class="tlaUNC">           0 :     std::vector&lt;Txid&gt; vHashUpdate;</span></span>
<span id="L307"><span class="lineNum">     307</span>                 :<span class="tlaUNC">           0 :     {</span></span>
<span id="L308"><span class="lineNum">     308</span>                 :             :         // disconnectpool is ordered so that the front is the most recently-confirmed</span>
<span id="L309"><span class="lineNum">     309</span>                 :             :         // transaction (the last tx of the block at the tip) in the disconnected chain.</span>
<span id="L310"><span class="lineNum">     310</span>                 :             :         // Iterate disconnectpool in reverse, so that we add transactions</span>
<span id="L311"><span class="lineNum">     311</span>                 :             :         // back to the mempool starting with the earliest transaction that had</span>
<span id="L312"><span class="lineNum">     312</span>                 :             :         // been previously seen in a block.</span>
<span id="L313"><span class="lineNum">     313</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         const auto queuedTx = disconnectpool.take();</span></span>
<span id="L314"><span class="lineNum">     314</span>                 :<span class="tlaUNC">           0 :         auto it = queuedTx.rbegin();</span></span>
<span id="L315"><span class="lineNum">     315</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         while (it != queuedTx.rend()) {</span></span>
<span id="L316"><span class="lineNum">     316</span>                 :             :             // ignore validation errors in resurrected transactions</span>
<span id="L317"><span class="lineNum">     317</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             if (!fAddToMempool || (*it)-&gt;IsCoinBase() ||</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L318"><span class="lineNum">     318</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 AcceptToMemoryPool(*this, *it, GetTime(),</span></span>
<span id="L319"><span class="lineNum">     319</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     /*bypass_limits=*/true, /*test_accept=*/false).m_result_type !=</span></span>
<span id="L320"><span class="lineNum">     320</span>                 :             :                         MempoolAcceptResult::ResultType::VALID) {</span>
<span id="L321"><span class="lineNum">     321</span>                 :             :                 // If the transaction doesn't make it in to the mempool, remove any</span>
<span id="L322"><span class="lineNum">     322</span>                 :             :                 // transactions that depend on it (which would now be orphans).</span>
<span id="L323"><span class="lineNum">     323</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 m_mempool-&gt;removeRecursive(**it, MemPoolRemovalReason::REORG);</span></span>
<span id="L324"><span class="lineNum">     324</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             } else if (m_mempool-&gt;exists((*it)-&gt;GetHash())) {</span></span>
<span id="L325"><span class="lineNum">     325</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 vHashUpdate.push_back((*it)-&gt;GetHash());</span></span>
<span id="L326"><span class="lineNum">     326</span>                 :             :             }</span>
<span id="L327"><span class="lineNum">     327</span>                 :<span class="tlaUNC">           0 :             ++it;</span></span>
<span id="L328"><span class="lineNum">     328</span>                 :             :         }</span>
<span id="L329"><span class="lineNum">     329</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L330"><span class="lineNum">     330</span>                 :             : </span>
<span id="L331"><span class="lineNum">     331</span>                 :             :     // AcceptToMemoryPool/addNewTransaction all assume that new mempool entries have</span>
<span id="L332"><span class="lineNum">     332</span>                 :             :     // no in-mempool children, which is generally not true when adding</span>
<span id="L333"><span class="lineNum">     333</span>                 :             :     // previously-confirmed transactions back to the mempool.</span>
<span id="L334"><span class="lineNum">     334</span>                 :             :     // UpdateTransactionsFromBlock finds descendants of any transactions in</span>
<span id="L335"><span class="lineNum">     335</span>                 :             :     // the disconnectpool that were added back and cleans up the mempool state.</span>
<span id="L336"><span class="lineNum">     336</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     m_mempool-&gt;UpdateTransactionsFromBlock(vHashUpdate);</span></span>
<span id="L337"><span class="lineNum">     337</span>                 :             : </span>
<span id="L338"><span class="lineNum">     338</span>                 :             :     // Predicate to use for filtering transactions in removeForReorg.</span>
<span id="L339"><span class="lineNum">     339</span>                 :             :     // Checks whether the transaction is still final and, if it spends a coinbase output, mature.</span>
<span id="L340"><span class="lineNum">     340</span>                 :             :     // Also updates valid entries' cached LockPoints if needed.</span>
<span id="L341"><span class="lineNum">     341</span>                 :             :     // If false, the tx is still valid and its lockpoints are updated.</span>
<span id="L342"><span class="lineNum">     342</span>                 :             :     // If true, the tx would be invalid in the next block; remove this entry and all of its descendants.</span>
<span id="L343"><span class="lineNum">     343</span>                 :             :     // Note that TRUC rules are not applied here, so reorgs may cause violations of TRUC inheritance or</span>
<span id="L344"><span class="lineNum">     344</span>                 :             :     // topology restrictions.</span>
<span id="L345"><span class="lineNum">     345</span>                 :<span class="tlaUNC">           0 :     const auto filter_final_and_mature = [&amp;](CTxMemPool::txiter it)</span></span>
<span id="L346"><span class="lineNum">     346</span>                 :             :         EXCLUSIVE_LOCKS_REQUIRED(m_mempool-&gt;cs, ::cs_main) {</span>
<span id="L347"><span class="lineNum">     347</span>                 :<span class="tlaUNC">           0 :         AssertLockHeld(m_mempool-&gt;cs);</span></span>
<span id="L348"><span class="lineNum">     348</span>                 :<span class="tlaUNC">           0 :         AssertLockHeld(::cs_main);</span></span>
<span id="L349"><span class="lineNum">     349</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         const CTransaction&amp; tx = it-&gt;GetTx();</span></span>
<span id="L350"><span class="lineNum">     350</span>                 :             : </span>
<span id="L351"><span class="lineNum">     351</span>                 :             :         // The transaction must be final.</span>
<span id="L352"><span class="lineNum">     352</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!CheckFinalTxAtTip(*Assert(m_chain.Tip()), tx)) return true;</span></span>
<span id="L353"><span class="lineNum">     353</span>                 :             : </span>
<span id="L354"><span class="lineNum">     354</span>                 :<span class="tlaUNC">           0 :         const LockPoints&amp; lp = it-&gt;GetLockPoints();</span></span>
<span id="L355"><span class="lineNum">     355</span>                 :             :         // CheckSequenceLocksAtTip checks if the transaction will be final in the next block to be</span>
<span id="L356"><span class="lineNum">     356</span>                 :             :         // created on top of the new chain.</span>
<span id="L357"><span class="lineNum">     357</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (TestLockPointValidity(m_chain, lp)) {</span></span>
<span id="L358"><span class="lineNum">     358</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (!CheckSequenceLocksAtTip(m_chain.Tip(), lp)) {</span></span>
<span id="L359"><span class="lineNum">     359</span>                 :             :                 return true;</span>
<span id="L360"><span class="lineNum">     360</span>                 :             :             }</span>
<span id="L361"><span class="lineNum">     361</span>                 :             :         } else {</span>
<span id="L362"><span class="lineNum">     362</span>                 :<span class="tlaUNC">           0 :             const CCoinsViewMemPool view_mempool{&amp;CoinsTip(), *m_mempool};</span></span>
<span id="L363"><span class="lineNum">     363</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             const std::optional&lt;LockPoints&gt; new_lock_points{CalculateLockPointsAtTip(m_chain.Tip(), view_mempool, tx)};</span></span>
<span id="L364"><span class="lineNum">     364</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             if (new_lock_points.has_value() &amp;&amp; CheckSequenceLocksAtTip(m_chain.Tip(), *new_lock_points)) {</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L365"><span class="lineNum">     365</span>                 :             :                 // Now update the mempool entry lockpoints as well.</span>
<span id="L366"><span class="lineNum">     366</span>                 :<span class="tlaUNC">           0 :                 it-&gt;UpdateLockPoints(*new_lock_points);</span></span>
<span id="L367"><span class="lineNum">     367</span>                 :             :             } else {</span>
<span id="L368"><span class="lineNum">     368</span>                 :<span class="tlaUNC">           0 :                 return true;</span></span>
<span id="L369"><span class="lineNum">     369</span>                 :             :             }</span>
<span id="L370"><span class="lineNum">     370</span>                 :<span class="tlaUNC">           0 :         }</span></span>
<span id="L371"><span class="lineNum">     371</span>                 :             : </span>
<span id="L372"><span class="lineNum">     372</span>                 :             :         // If the transaction spends any coinbase outputs, it must be mature.</span>
<span id="L373"><span class="lineNum">     373</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (it-&gt;GetSpendsCoinbase()) {</span></span>
<span id="L374"><span class="lineNum">     374</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             for (const CTxIn&amp; txin : tx.vin) {</span></span>
<span id="L375"><span class="lineNum">     375</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 if (m_mempool-&gt;exists(txin.prevout.hash)) continue;</span></span>
<span id="L376"><span class="lineNum">     376</span>                 :<span class="tlaUNC">           0 :                 const Coin&amp; coin{CoinsTip().AccessCoin(txin.prevout)};</span></span>
<span id="L377"><span class="lineNum">     377</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 assert(!coin.IsSpent());</span></span>
<span id="L378"><span class="lineNum">     378</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 const auto mempool_spend_height{m_chain.Tip()-&gt;nHeight + 1};</span></span>
<span id="L379"><span class="lineNum">     379</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 if (coin.IsCoinBase() &amp;&amp; mempool_spend_height - coin.nHeight &lt; COINBASE_MATURITY) {</span></span>
<span id="L380"><span class="lineNum">     380</span>                 :             :                     return true;</span>
<span id="L381"><span class="lineNum">     381</span>                 :             :                 }</span>
<span id="L382"><span class="lineNum">     382</span>                 :             :             }</span>
<span id="L383"><span class="lineNum">     383</span>                 :             :         }</span>
<span id="L384"><span class="lineNum">     384</span>                 :             :         // Transaction is still valid and cached LockPoints are updated.</span>
<span id="L385"><span class="lineNum">     385</span>                 :             :         return false;</span>
<span id="L386"><span class="lineNum">     386</span>                 :<span class="tlaUNC">           0 :     };</span></span>
<span id="L387"><span class="lineNum">     387</span>                 :             : </span>
<span id="L388"><span class="lineNum">     388</span>                 :             :     // We also need to remove any now-immature transactions</span>
<span id="L389"><span class="lineNum">     389</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     m_mempool-&gt;removeForReorg(m_chain, filter_final_and_mature);</span></span>
<span id="L390"><span class="lineNum">     390</span>                 :             :     // Re-limit mempool size, in case we added any transactions</span>
<span id="L391"><span class="lineNum">     391</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     LimitMempoolSize(*m_mempool, this-&gt;CoinsTip());</span></span>
<span id="L392"><span class="lineNum">     392</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L393"><span class="lineNum">     393</span>                 :             : </span>
<span id="L394"><span class="lineNum">     394</span>                 :             : /**</span>
<span id="L395"><span class="lineNum">     395</span>                 :             : * Checks to avoid mempool polluting consensus critical paths since cached</span>
<span id="L396"><span class="lineNum">     396</span>                 :             : * signature and script validity results will be reused if we validate this</span>
<span id="L397"><span class="lineNum">     397</span>                 :             : * transaction again during block validation.</span>
<span id="L398"><span class="lineNum">     398</span>                 :             : * */</span>
<span id="L399"><span class="lineNum">     399</span>                 :<span class="tlaGNC">      244331 : static bool CheckInputsFromMempoolAndCache(const CTransaction&amp; tx, TxValidationState&amp; state,</span></span>
<span id="L400"><span class="lineNum">     400</span>                 :             :                 const CCoinsViewCache&amp; view, const CTxMemPool&amp; pool,</span>
<span id="L401"><span class="lineNum">     401</span>                 :             :                 unsigned int flags, PrecomputedTransactionData&amp; txdata, CCoinsViewCache&amp; coins_tip,</span>
<span id="L402"><span class="lineNum">     402</span>                 :             :                 ValidationCache&amp; validation_cache)</span>
<span id="L403"><span class="lineNum">     403</span>                 :             :                 EXCLUSIVE_LOCKS_REQUIRED(cs_main, pool.cs)</span>
<span id="L404"><span class="lineNum">     404</span>                 :             : {</span>
<span id="L405"><span class="lineNum">     405</span>                 :<span class="tlaGNC">      244331 :     AssertLockHeld(cs_main);</span></span>
<span id="L406"><span class="lineNum">     406</span>                 :<span class="tlaGNC">      244331 :     AssertLockHeld(pool.cs);</span></span>
<span id="L407"><span class="lineNum">     407</span>                 :             : </span>
<span id="L408"><span class="lineNum">     408</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 244331 times"> + </span>]:<span class="tlaGNC">      244331 :     assert(!tx.IsCoinBase());</span></span>
<span id="L409"><span class="lineNum">     409</span>         [<span class="tlaGBC" title="Branch 0 was taken 397218 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 244331 times"> + </span>]:<span class="tlaGNC">      641549 :     for (const CTxIn&amp; txin : tx.vin) {</span></span>
<span id="L410"><span class="lineNum">     410</span>                 :<span class="tlaGNC">      397218 :         const Coin&amp; coin = view.AccessCoin(txin.prevout);</span></span>
<span id="L411"><span class="lineNum">     411</span>                 :             : </span>
<span id="L412"><span class="lineNum">     412</span>                 :             :         // This coin was checked in PreChecks and MemPoolAccept</span>
<span id="L413"><span class="lineNum">     413</span>                 :             :         // has been holding cs_main since then.</span>
<span id="L414"><span class="lineNum">     414</span>                 :<span class="tlaGNC">      397218 :         Assume(!coin.IsSpent());</span></span>
<span id="L415"><span class="lineNum">     415</span>         [<span class="tlaGBC" title="Branch 0 was taken 397218 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      397218 :         if (coin.IsSpent()) return false;</span></span>
<span id="L416"><span class="lineNum">     416</span>                 :             : </span>
<span id="L417"><span class="lineNum">     417</span>                 :             :         // If the Coin is available, there are 2 possibilities:</span>
<span id="L418"><span class="lineNum">     418</span>                 :             :         // it is available in our current ChainstateActive UTXO set,</span>
<span id="L419"><span class="lineNum">     419</span>                 :             :         // or it's a UTXO provided by a transaction in our mempool.</span>
<span id="L420"><span class="lineNum">     420</span>                 :             :         // Ensure the scriptPubKeys in Coins from CoinsView are correct.</span>
<span id="L421"><span class="lineNum">     421</span>                 :<span class="tlaGNC">      397218 :         const CTransactionRef&amp; txFrom = pool.get(txin.prevout.hash);</span></span>
<span id="L422"><span class="lineNum">     422</span>         [<span class="tlaGBC" title="Branch 0 was taken 131981 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 265237 times"> + </span>]:<span class="tlaGNC">      397218 :         if (txFrom) {</span></span>
<span id="L423"><span class="lineNum">     423</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 131981 times"> + </span>]:<span class="tlaGNC">      131981 :             assert(txFrom-&gt;GetHash() == txin.prevout.hash);</span></span>
<span id="L424"><span class="lineNum">     424</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 131981 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 131981 times"> + </span>]:<span class="tlaGNC">      131981 :             assert(txFrom-&gt;vout.size() &gt; txin.prevout.n);</span></span>
<span id="L425"><span class="lineNum">     425</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 131981 times"> + </span>]:<span class="tlaGNC">      131981 :             assert(txFrom-&gt;vout[txin.prevout.n] == coin.out);</span></span>
<span id="L426"><span class="lineNum">     426</span>                 :             :         } else {</span>
<span id="L427"><span class="lineNum">     427</span>         [<span class="tlaGBC" title="Branch 0 was taken 265237 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      265237 :             const Coin&amp; coinFromUTXOSet = coins_tip.AccessCoin(txin.prevout);</span></span>
<span id="L428"><span class="lineNum">     428</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 265237 times"> + </span>]:<span class="tlaGNC">      265237 :             assert(!coinFromUTXOSet.IsSpent());</span></span>
<span id="L429"><span class="lineNum">     429</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 265237 times"> + </span>]:<span class="tlaGNC">      265237 :             assert(coinFromUTXOSet.out == coin.out);</span></span>
<span id="L430"><span class="lineNum">     430</span>                 :             :         }</span>
<span id="L431"><span class="lineNum">     431</span>                 :<span class="tlaGNC">      397218 :     }</span></span>
<span id="L432"><span class="lineNum">     432</span>                 :             : </span>
<span id="L433"><span class="lineNum">     433</span>                 :             :     // Call CheckInputScripts() to cache signature and script validity against current tip consensus rules.</span>
<span id="L434"><span class="lineNum">     434</span>                 :<span class="tlaGNC">      244331 :     return CheckInputScripts(tx, state, view, flags, /* cacheSigStore= */ true, /* cacheFullScriptStore= */ true, txdata, validation_cache);</span></span>
<span id="L435"><span class="lineNum">     435</span>                 :             : }</span>
<span id="L436"><span class="lineNum">     436</span>                 :             : </span>
<span id="L437"><span class="lineNum">     437</span>                 :             : namespace {</span>
<span id="L438"><span class="lineNum">     438</span>                 :             : </span>
<span id="L439"><span class="lineNum">     439</span>                 :             : class MemPoolAccept</span>
<span id="L440"><span class="lineNum">     440</span>                 :             : {</span>
<span id="L441"><span class="lineNum">     441</span>                 :             : public:</span>
<span id="L442"><span class="lineNum">     442</span>                 :<span class="tlaGNC">     2482556 :     explicit MemPoolAccept(CTxMemPool&amp; mempool, Chainstate&amp; active_chainstate) :</span></span>
<span id="L443"><span class="lineNum">     443</span>                 :<span class="tlaGNC">     2482556 :         m_pool(mempool),</span></span>
<span id="L444"><span class="lineNum">     444</span>                 :<span class="tlaGNC">     2482556 :         m_view(&amp;m_dummy),</span></span>
<span id="L445"><span class="lineNum">     445</span>   [<span class="tlaGBC" title="Branch 0 was taken 2482556 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 2482556 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">     2482556 :         m_viewmempool(&amp;active_chainstate.CoinsTip(), m_pool),</span></span>
<span id="L446"><span class="lineNum">     446</span>                 :<span class="tlaGNC">     2482556 :         m_active_chainstate(active_chainstate)</span></span>
<span id="L447"><span class="lineNum">     447</span>                 :             :     {</span>
<span id="L448"><span class="lineNum">     448</span>                 :<span class="tlaGNC">     2482556 :     }</span></span>
<span id="L449"><span class="lineNum">     449</span>                 :             : </span>
<span id="L450"><span class="lineNum">     450</span>                 :             :     // We put the arguments we're handed into a struct, so we can pass them</span>
<span id="L451"><span class="lineNum">     451</span>                 :             :     // around easier.</span>
<span id="L452"><span class="lineNum">     452</span>                 :             :     struct ATMPArgs {</span>
<span id="L453"><span class="lineNum">     453</span>                 :             :         const CChainParams&amp; m_chainparams;</span>
<span id="L454"><span class="lineNum">     454</span>                 :             :         const int64_t m_accept_time;</span>
<span id="L455"><span class="lineNum">     455</span>                 :             :         const bool m_bypass_limits;</span>
<span id="L456"><span class="lineNum">     456</span>                 :             :         /*</span>
<span id="L457"><span class="lineNum">     457</span>                 :             :          * Return any outpoints which were not previously present in the coins</span>
<span id="L458"><span class="lineNum">     458</span>                 :             :          * cache, but were added as a result of validating the tx for mempool</span>
<span id="L459"><span class="lineNum">     459</span>                 :             :          * acceptance. This allows the caller to optionally remove the cache</span>
<span id="L460"><span class="lineNum">     460</span>                 :             :          * additions if the associated transaction ends up being rejected by</span>
<span id="L461"><span class="lineNum">     461</span>                 :             :          * the mempool.</span>
<span id="L462"><span class="lineNum">     462</span>                 :             :          */</span>
<span id="L463"><span class="lineNum">     463</span>                 :             :         std::vector&lt;COutPoint&gt;&amp; m_coins_to_uncache;</span>
<span id="L464"><span class="lineNum">     464</span>                 :             :         /** When true, the transaction or package will not be submitted to the mempool. */</span>
<span id="L465"><span class="lineNum">     465</span>                 :             :         const bool m_test_accept;</span>
<span id="L466"><span class="lineNum">     466</span>                 :             :         /** Whether we allow transactions to replace mempool transactions. If false,</span>
<span id="L467"><span class="lineNum">     467</span>                 :             :          * any transaction spending the same inputs as a transaction in the mempool is considered</span>
<span id="L468"><span class="lineNum">     468</span>                 :             :          * a conflict. */</span>
<span id="L469"><span class="lineNum">     469</span>                 :             :         const bool m_allow_replacement;</span>
<span id="L470"><span class="lineNum">     470</span>                 :             :         /** When true, allow sibling eviction. This only occurs in single transaction package settings. */</span>
<span id="L471"><span class="lineNum">     471</span>                 :             :         const bool m_allow_sibling_eviction;</span>
<span id="L472"><span class="lineNum">     472</span>                 :             :         /** Used to skip the LimitMempoolSize() call within AcceptSingleTransaction(). This should be used when multiple</span>
<span id="L473"><span class="lineNum">     473</span>                 :             :          * AcceptSubPackage calls are expected and the mempool will be trimmed at the end of AcceptPackage(). */</span>
<span id="L474"><span class="lineNum">     474</span>                 :             :         const bool m_package_submission;</span>
<span id="L475"><span class="lineNum">     475</span>                 :             :         /** When true, use package feerates instead of individual transaction feerates for fee-based</span>
<span id="L476"><span class="lineNum">     476</span>                 :             :          * policies such as mempool min fee and min relay fee.</span>
<span id="L477"><span class="lineNum">     477</span>                 :             :          */</span>
<span id="L478"><span class="lineNum">     478</span>                 :             :         const bool m_package_feerates;</span>
<span id="L479"><span class="lineNum">     479</span>                 :             :         /** Used for local submission of transactions to catch &quot;absurd&quot; fees</span>
<span id="L480"><span class="lineNum">     480</span>                 :             :          * due to fee miscalculation by wallets. std:nullopt implies unset, allowing any feerates.</span>
<span id="L481"><span class="lineNum">     481</span>                 :             :          * Any individual transaction failing this check causes immediate failure.</span>
<span id="L482"><span class="lineNum">     482</span>                 :             :          */</span>
<span id="L483"><span class="lineNum">     483</span>                 :             :         const std::optional&lt;CFeeRate&gt; m_client_maxfeerate;</span>
<span id="L484"><span class="lineNum">     484</span>                 :             : </span>
<span id="L485"><span class="lineNum">     485</span>                 :             :         /** Whether CPFP carveout and RBF carveout are granted. */</span>
<span id="L486"><span class="lineNum">     486</span>                 :             :         const bool m_allow_carveouts;</span>
<span id="L487"><span class="lineNum">     487</span>                 :             : </span>
<span id="L488"><span class="lineNum">     488</span>                 :             :         /** Parameters for single transaction mempool validation. */</span>
<span id="L489"><span class="lineNum">     489</span>                 :<span class="tlaGNC">     1650825 :         static ATMPArgs SingleAccept(const CChainParams&amp; chainparams, int64_t accept_time,</span></span>
<span id="L490"><span class="lineNum">     490</span>                 :             :                                      bool bypass_limits, std::vector&lt;COutPoint&gt;&amp; coins_to_uncache,</span>
<span id="L491"><span class="lineNum">     491</span>                 :             :                                      bool test_accept) {</span>
<span id="L492"><span class="lineNum">     492</span>                 :<span class="tlaGNC">     1650825 :             return ATMPArgs{/* m_chainparams */ chainparams,</span></span>
<span id="L493"><span class="lineNum">     493</span>                 :             :                             /* m_accept_time */ accept_time,</span>
<span id="L494"><span class="lineNum">     494</span>                 :             :                             /* m_bypass_limits */ bypass_limits,</span>
<span id="L495"><span class="lineNum">     495</span>                 :             :                             /* m_coins_to_uncache */ coins_to_uncache,</span>
<span id="L496"><span class="lineNum">     496</span>                 :             :                             /* m_test_accept */ test_accept,</span>
<span id="L497"><span class="lineNum">     497</span>                 :             :                             /* m_allow_replacement */ true,</span>
<span id="L498"><span class="lineNum">     498</span>                 :             :                             /* m_allow_sibling_eviction */ true,</span>
<span id="L499"><span class="lineNum">     499</span>                 :             :                             /* m_package_submission */ false,</span>
<span id="L500"><span class="lineNum">     500</span>                 :             :                             /* m_package_feerates */ false,</span>
<span id="L501"><span class="lineNum">     501</span>                 :             :                             /* m_client_maxfeerate */ {}, // checked by caller</span>
<span id="L502"><span class="lineNum">     502</span>                 :             :                             /* m_allow_carveouts */ true,</span>
<span id="L503"><span class="lineNum">     503</span>                 :<span class="tlaGNC">     1650825 :             };</span></span>
<span id="L504"><span class="lineNum">     504</span>                 :             :         }</span>
<span id="L505"><span class="lineNum">     505</span>                 :             : </span>
<span id="L506"><span class="lineNum">     506</span>                 :             :         /** Parameters for test package mempool validation through testmempoolaccept. */</span>
<span id="L507"><span class="lineNum">     507</span>                 :<span class="tlaGNC">      314297 :         static ATMPArgs PackageTestAccept(const CChainParams&amp; chainparams, int64_t accept_time,</span></span>
<span id="L508"><span class="lineNum">     508</span>                 :             :                                           std::vector&lt;COutPoint&gt;&amp; coins_to_uncache) {</span>
<span id="L509"><span class="lineNum">     509</span>                 :<span class="tlaGNC">      314297 :             return ATMPArgs{/* m_chainparams */ chainparams,</span></span>
<span id="L510"><span class="lineNum">     510</span>                 :             :                             /* m_accept_time */ accept_time,</span>
<span id="L511"><span class="lineNum">     511</span>                 :             :                             /* m_bypass_limits */ false,</span>
<span id="L512"><span class="lineNum">     512</span>                 :             :                             /* m_coins_to_uncache */ coins_to_uncache,</span>
<span id="L513"><span class="lineNum">     513</span>                 :             :                             /* m_test_accept */ true,</span>
<span id="L514"><span class="lineNum">     514</span>                 :             :                             /* m_allow_replacement */ false,</span>
<span id="L515"><span class="lineNum">     515</span>                 :             :                             /* m_allow_sibling_eviction */ false,</span>
<span id="L516"><span class="lineNum">     516</span>                 :             :                             /* m_package_submission */ false, // not submitting to mempool</span>
<span id="L517"><span class="lineNum">     517</span>                 :             :                             /* m_package_feerates */ false,</span>
<span id="L518"><span class="lineNum">     518</span>                 :             :                             /* m_client_maxfeerate */ {}, // checked by caller</span>
<span id="L519"><span class="lineNum">     519</span>                 :             :                             /* m_allow_carveouts */ false,</span>
<span id="L520"><span class="lineNum">     520</span>                 :<span class="tlaGNC">      314297 :             };</span></span>
<span id="L521"><span class="lineNum">     521</span>                 :             :         }</span>
<span id="L522"><span class="lineNum">     522</span>                 :             : </span>
<span id="L523"><span class="lineNum">     523</span>                 :             :         /** Parameters for child-with-parents package validation. */</span>
<span id="L524"><span class="lineNum">     524</span>                 :<span class="tlaGNC">      517434 :         static ATMPArgs PackageChildWithParents(const CChainParams&amp; chainparams, int64_t accept_time,</span></span>
<span id="L525"><span class="lineNum">     525</span>                 :             :                                                 std::vector&lt;COutPoint&gt;&amp; coins_to_uncache, const std::optional&lt;CFeeRate&gt;&amp; client_maxfeerate) {</span>
<span id="L526"><span class="lineNum">     526</span>                 :<span class="tlaGNC">      517434 :             return ATMPArgs{/* m_chainparams */ chainparams,</span></span>
<span id="L527"><span class="lineNum">     527</span>                 :             :                             /* m_accept_time */ accept_time,</span>
<span id="L528"><span class="lineNum">     528</span>                 :             :                             /* m_bypass_limits */ false,</span>
<span id="L529"><span class="lineNum">     529</span>                 :             :                             /* m_coins_to_uncache */ coins_to_uncache,</span>
<span id="L530"><span class="lineNum">     530</span>                 :             :                             /* m_test_accept */ false,</span>
<span id="L531"><span class="lineNum">     531</span>                 :             :                             /* m_allow_replacement */ true,</span>
<span id="L532"><span class="lineNum">     532</span>                 :             :                             /* m_allow_sibling_eviction */ false,</span>
<span id="L533"><span class="lineNum">     533</span>                 :             :                             /* m_package_submission */ true,</span>
<span id="L534"><span class="lineNum">     534</span>                 :             :                             /* m_package_feerates */ true,</span>
<span id="L535"><span class="lineNum">     535</span>                 :             :                             /* m_client_maxfeerate */ client_maxfeerate,</span>
<span id="L536"><span class="lineNum">     536</span>                 :             :                             /* m_allow_carveouts */ false,</span>
<span id="L537"><span class="lineNum">     537</span>                 :<span class="tlaGNC">      517434 :             };</span></span>
<span id="L538"><span class="lineNum">     538</span>                 :             :         }</span>
<span id="L539"><span class="lineNum">     539</span>                 :             : </span>
<span id="L540"><span class="lineNum">     540</span>                 :             :         /** Parameters for a single transaction within a package. */</span>
<span id="L541"><span class="lineNum">     541</span>                 :<span class="tlaGNC">      771623 :         static ATMPArgs SingleInPackageAccept(const ATMPArgs&amp; package_args) {</span></span>
<span id="L542"><span class="lineNum">     542</span>                 :<span class="tlaGNC">      771623 :             return ATMPArgs{/* m_chainparams */ package_args.m_chainparams,</span></span>
<span id="L543"><span class="lineNum">     543</span>                 :<span class="tlaGNC">      771623 :                             /* m_accept_time */ package_args.m_accept_time,</span></span>
<span id="L544"><span class="lineNum">     544</span>                 :             :                             /* m_bypass_limits */ false,</span>
<span id="L545"><span class="lineNum">     545</span>                 :             :                             /* m_coins_to_uncache */ package_args.m_coins_to_uncache,</span>
<span id="L546"><span class="lineNum">     546</span>                 :<span class="tlaGNC">      771623 :                             /* m_test_accept */ package_args.m_test_accept,</span></span>
<span id="L547"><span class="lineNum">     547</span>                 :             :                             /* m_allow_replacement */ true,</span>
<span id="L548"><span class="lineNum">     548</span>                 :             :                             /* m_allow_sibling_eviction */ true,</span>
<span id="L549"><span class="lineNum">     549</span>                 :             :                             /* m_package_submission */ true, // trim at the end of AcceptPackage()</span>
<span id="L550"><span class="lineNum">     550</span>                 :             :                             /* m_package_feerates */ false, // only 1 transaction</span>
<span id="L551"><span class="lineNum">     551</span>                 :             :                             /* m_client_maxfeerate */ package_args.m_client_maxfeerate,</span>
<span id="L552"><span class="lineNum">     552</span>                 :             :                             /* m_allow_carveouts */ false,</span>
<span id="L553"><span class="lineNum">     553</span>                 :<span class="tlaGNC">      771623 :             };</span></span>
<span id="L554"><span class="lineNum">     554</span>                 :             :         }</span>
<span id="L555"><span class="lineNum">     555</span>                 :             : </span>
<span id="L556"><span class="lineNum">     556</span>                 :             :     private:</span>
<span id="L557"><span class="lineNum">     557</span>                 :             :         // Private ctor to avoid exposing details to clients and allowing the possibility of</span>
<span id="L558"><span class="lineNum">     558</span>                 :             :         // mixing up the order of the arguments. Use static functions above instead.</span>
<span id="L559"><span class="lineNum">     559</span>                 :<span class="tlaGNC">     3254179 :         ATMPArgs(const CChainParams&amp; chainparams,</span></span>
<span id="L560"><span class="lineNum">     560</span>                 :             :                  int64_t accept_time,</span>
<span id="L561"><span class="lineNum">     561</span>                 :             :                  bool bypass_limits,</span>
<span id="L562"><span class="lineNum">     562</span>                 :             :                  std::vector&lt;COutPoint&gt;&amp; coins_to_uncache,</span>
<span id="L563"><span class="lineNum">     563</span>                 :             :                  bool test_accept,</span>
<span id="L564"><span class="lineNum">     564</span>                 :             :                  bool allow_replacement,</span>
<span id="L565"><span class="lineNum">     565</span>                 :             :                  bool allow_sibling_eviction,</span>
<span id="L566"><span class="lineNum">     566</span>                 :             :                  bool package_submission,</span>
<span id="L567"><span class="lineNum">     567</span>                 :             :                  bool package_feerates,</span>
<span id="L568"><span class="lineNum">     568</span>                 :             :                  std::optional&lt;CFeeRate&gt; client_maxfeerate,</span>
<span id="L569"><span class="lineNum">     569</span>                 :             :                  bool allow_carveouts)</span>
<span id="L570"><span class="lineNum">     570</span>                 :<span class="tlaGNC">     3254179 :             : m_chainparams{chainparams},</span></span>
<span id="L571"><span class="lineNum">     571</span>                 :<span class="tlaGNC">     3254179 :               m_accept_time{accept_time},</span></span>
<span id="L572"><span class="lineNum">     572</span>                 :<span class="tlaGNC">     3254179 :               m_bypass_limits{bypass_limits},</span></span>
<span id="L573"><span class="lineNum">     573</span>                 :<span class="tlaGNC">     3254179 :               m_coins_to_uncache{coins_to_uncache},</span></span>
<span id="L574"><span class="lineNum">     574</span>                 :<span class="tlaGNC">     3254179 :               m_test_accept{test_accept},</span></span>
<span id="L575"><span class="lineNum">     575</span>                 :<span class="tlaGNC">     3254179 :               m_allow_replacement{allow_replacement},</span></span>
<span id="L576"><span class="lineNum">     576</span>                 :<span class="tlaGNC">     3254179 :               m_allow_sibling_eviction{allow_sibling_eviction},</span></span>
<span id="L577"><span class="lineNum">     577</span>                 :<span class="tlaGNC">     3254179 :               m_package_submission{package_submission},</span></span>
<span id="L578"><span class="lineNum">     578</span>                 :<span class="tlaGNC">     3254179 :               m_package_feerates{package_feerates},</span></span>
<span id="L579"><span class="lineNum">     579</span>                 :<span class="tlaGNC">     3254179 :               m_client_maxfeerate{client_maxfeerate},</span></span>
<span id="L580"><span class="lineNum">     580</span>                 :<span class="tlaGNC">     3254179 :               m_allow_carveouts{allow_carveouts}</span></span>
<span id="L581"><span class="lineNum">     581</span>                 :             :         {</span>
<span id="L582"><span class="lineNum">     582</span>                 :             :             // If we are using package feerates, we must be doing package submission.</span>
<span id="L583"><span class="lineNum">     583</span>                 :             :             // It also means carveouts and sibling eviction are not permitted.</span>
<span id="L584"><span class="lineNum">     584</span>         [<span class="tlaGBC" title="Branch 0 was taken 517434 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 2736745 times"> + </span>]:<span class="tlaGNC">     3254179 :             if (m_package_feerates) {</span></span>
<span id="L585"><span class="lineNum">     585</span>                 :<span class="tlaGNC">      517434 :                 Assume(m_package_submission);</span></span>
<span id="L586"><span class="lineNum">     586</span>                 :<span class="tlaGNC">      517434 :                 Assume(!m_allow_carveouts);</span></span>
<span id="L587"><span class="lineNum">     587</span>                 :<span class="tlaGNC">      517434 :                 Assume(!m_allow_sibling_eviction);</span></span>
<span id="L588"><span class="lineNum">     588</span>                 :             :             }</span>
<span id="L589"><span class="lineNum">     589</span>         [<span class="tlaGBC" title="Branch 0 was taken 2422448 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 831731 times"> + </span>]:<span class="tlaGNC">     3254179 :             if (m_allow_sibling_eviction) Assume(m_allow_replacement);</span></span>
<span id="L590"><span class="lineNum">     590</span>                 :<span class="tlaGNC">     3254179 :         }</span></span>
<span id="L591"><span class="lineNum">     591</span>                 :             :     };</span>
<span id="L592"><span class="lineNum">     592</span>                 :             : </span>
<span id="L593"><span class="lineNum">     593</span>                 :             :     /** Clean up all non-chainstate coins from m_view and m_viewmempool. */</span>
<span id="L594"><span class="lineNum">     594</span>                 :             :     void CleanupTemporaryCoins() EXCLUSIVE_LOCKS_REQUIRED(cs_main, m_pool.cs);</span>
<span id="L595"><span class="lineNum">     595</span>                 :             : </span>
<span id="L596"><span class="lineNum">     596</span>                 :             :     // Single transaction acceptance</span>
<span id="L597"><span class="lineNum">     597</span>                 :             :     MempoolAcceptResult AcceptSingleTransaction(const CTransactionRef&amp; ptx, ATMPArgs&amp; args) EXCLUSIVE_LOCKS_REQUIRED(cs_main);</span>
<span id="L598"><span class="lineNum">     598</span>                 :             : </span>
<span id="L599"><span class="lineNum">     599</span>                 :             :     /**</span>
<span id="L600"><span class="lineNum">     600</span>                 :             :     * Multiple transaction acceptance. Transactions may or may not be interdependent, but must not</span>
<span id="L601"><span class="lineNum">     601</span>                 :             :     * conflict with each other, and the transactions cannot already be in the mempool. Parents must</span>
<span id="L602"><span class="lineNum">     602</span>                 :             :     * come before children if any dependencies exist.</span>
<span id="L603"><span class="lineNum">     603</span>                 :             :     */</span>
<span id="L604"><span class="lineNum">     604</span>                 :             :     PackageMempoolAcceptResult AcceptMultipleTransactions(const std::vector&lt;CTransactionRef&gt;&amp; txns, ATMPArgs&amp; args) EXCLUSIVE_LOCKS_REQUIRED(cs_main);</span>
<span id="L605"><span class="lineNum">     605</span>                 :             : </span>
<span id="L606"><span class="lineNum">     606</span>                 :             :     /**</span>
<span id="L607"><span class="lineNum">     607</span>                 :             :      * Submission of a subpackage.</span>
<span id="L608"><span class="lineNum">     608</span>                 :             :      * If subpackage size == 1, calls AcceptSingleTransaction() with adjusted ATMPArgs to avoid</span>
<span id="L609"><span class="lineNum">     609</span>                 :             :      * package policy restrictions like no CPFP carve out (PackageMempoolChecks)</span>
<span id="L610"><span class="lineNum">     610</span>                 :             :      * and creates a PackageMempoolAcceptResult wrapping the result.</span>
<span id="L611"><span class="lineNum">     611</span>                 :             :      *</span>
<span id="L612"><span class="lineNum">     612</span>                 :             :      * If subpackage size &gt; 1, calls AcceptMultipleTransactions() with the provided ATMPArgs.</span>
<span id="L613"><span class="lineNum">     613</span>                 :             :      *</span>
<span id="L614"><span class="lineNum">     614</span>                 :             :      * Also cleans up all non-chainstate coins from m_view at the end.</span>
<span id="L615"><span class="lineNum">     615</span>                 :             :     */</span>
<span id="L616"><span class="lineNum">     616</span>                 :             :     PackageMempoolAcceptResult AcceptSubPackage(const std::vector&lt;CTransactionRef&gt;&amp; subpackage, ATMPArgs&amp; args)</span>
<span id="L617"><span class="lineNum">     617</span>                 :             :         EXCLUSIVE_LOCKS_REQUIRED(cs_main, m_pool.cs);</span>
<span id="L618"><span class="lineNum">     618</span>                 :             : </span>
<span id="L619"><span class="lineNum">     619</span>                 :             :     /**</span>
<span id="L620"><span class="lineNum">     620</span>                 :             :      * Package (more specific than just multiple transactions) acceptance. Package must be a child</span>
<span id="L621"><span class="lineNum">     621</span>                 :             :      * with all of its unconfirmed parents, and topologically sorted.</span>
<span id="L622"><span class="lineNum">     622</span>                 :             :      */</span>
<span id="L623"><span class="lineNum">     623</span>                 :             :     PackageMempoolAcceptResult AcceptPackage(const Package&amp; package, ATMPArgs&amp; args) EXCLUSIVE_LOCKS_REQUIRED(cs_main);</span>
<span id="L624"><span class="lineNum">     624</span>                 :             : </span>
<span id="L625"><span class="lineNum">     625</span>                 :             : private:</span>
<span id="L626"><span class="lineNum">     626</span>                 :             :     // All the intermediate state that gets passed between the various levels</span>
<span id="L627"><span class="lineNum">     627</span>                 :             :     // of checking a given transaction.</span>
<span id="L628"><span class="lineNum">     628</span>                 :             :     struct Workspace {</span>
<span id="L629"><span class="lineNum">     629</span>                 :<span class="tlaGNC">     2922921 :         explicit Workspace(const CTransactionRef&amp; ptx) : m_ptx(ptx), m_hash(ptx-&gt;GetHash()) {}</span></span>
<span id="L630"><span class="lineNum">     630</span>                 :             :         /** Txids of mempool transactions that this transaction directly conflicts with or may</span>
<span id="L631"><span class="lineNum">     631</span>                 :             :          * replace via sibling eviction. */</span>
<span id="L632"><span class="lineNum">     632</span>                 :             :         std::set&lt;Txid&gt; m_conflicts;</span>
<span id="L633"><span class="lineNum">     633</span>                 :             :         /** Iterators to mempool entries that this transaction directly conflicts with or may</span>
<span id="L634"><span class="lineNum">     634</span>                 :             :          * replace via sibling eviction. */</span>
<span id="L635"><span class="lineNum">     635</span>                 :             :         CTxMemPool::setEntries m_iters_conflicting;</span>
<span id="L636"><span class="lineNum">     636</span>                 :             :         /** All mempool ancestors of this transaction. */</span>
<span id="L637"><span class="lineNum">     637</span>                 :             :         CTxMemPool::setEntries m_ancestors;</span>
<span id="L638"><span class="lineNum">     638</span>                 :             :         /* Handle to the tx in the changeset */</span>
<span id="L639"><span class="lineNum">     639</span>                 :             :         CTxMemPool::ChangeSet::TxHandle m_tx_handle;</span>
<span id="L640"><span class="lineNum">     640</span>                 :             :         /** Whether RBF-related data structures (m_conflicts, m_iters_conflicting,</span>
<span id="L641"><span class="lineNum">     641</span>                 :             :          * m_replaced_transactions) include a sibling in addition to txns with conflicting inputs. */</span>
<span id="L642"><span class="lineNum">     642</span>                 :             :         bool m_sibling_eviction{false};</span>
<span id="L643"><span class="lineNum">     643</span>                 :             : </span>
<span id="L644"><span class="lineNum">     644</span>                 :             :         /** Virtual size of the transaction as used by the mempool, calculated using serialized size</span>
<span id="L645"><span class="lineNum">     645</span>                 :             :          * of the transaction and sigops. */</span>
<span id="L646"><span class="lineNum">     646</span>                 :             :         int64_t m_vsize;</span>
<span id="L647"><span class="lineNum">     647</span>                 :             :         /** Fees paid by this transaction: total input amounts subtracted by total output amounts. */</span>
<span id="L648"><span class="lineNum">     648</span>                 :             :         CAmount m_base_fees;</span>
<span id="L649"><span class="lineNum">     649</span>                 :             :         /** Base fees + any fee delta set by the user with prioritisetransaction. */</span>
<span id="L650"><span class="lineNum">     650</span>                 :             :         CAmount m_modified_fees;</span>
<span id="L651"><span class="lineNum">     651</span>                 :             : </span>
<span id="L652"><span class="lineNum">     652</span>                 :             :         /** If we're doing package validation (i.e. m_package_feerates=true), the &quot;effective&quot;</span>
<span id="L653"><span class="lineNum">     653</span>                 :             :          * package feerate of this transaction is the total fees divided by the total size of</span>
<span id="L654"><span class="lineNum">     654</span>                 :             :          * transactions (which may include its ancestors and/or descendants). */</span>
<span id="L655"><span class="lineNum">     655</span>                 :             :         CFeeRate m_package_feerate{0};</span>
<span id="L656"><span class="lineNum">     656</span>                 :             : </span>
<span id="L657"><span class="lineNum">     657</span>                 :             :         const CTransactionRef&amp; m_ptx;</span>
<span id="L658"><span class="lineNum">     658</span>                 :             :         /** Txid. */</span>
<span id="L659"><span class="lineNum">     659</span>                 :             :         const Txid&amp; m_hash;</span>
<span id="L660"><span class="lineNum">     660</span>                 :             :         TxValidationState m_state;</span>
<span id="L661"><span class="lineNum">     661</span>                 :             :         /** A temporary cache containing serialized transaction data for signature verification.</span>
<span id="L662"><span class="lineNum">     662</span>                 :             :          * Reused across PolicyScriptChecks and ConsensusScriptChecks. */</span>
<span id="L663"><span class="lineNum">     663</span>                 :             :         PrecomputedTransactionData m_precomputed_txdata;</span>
<span id="L664"><span class="lineNum">     664</span>                 :             :     };</span>
<span id="L665"><span class="lineNum">     665</span>                 :             : </span>
<span id="L666"><span class="lineNum">     666</span>                 :             :     // Run the policy checks on a given transaction, excluding any script checks.</span>
<span id="L667"><span class="lineNum">     667</span>                 :             :     // Looks up inputs, calculates feerate, considers replacement, evaluates</span>
<span id="L668"><span class="lineNum">     668</span>                 :             :     // package limits, etc. As this function can be invoked for &quot;free&quot; by a peer,</span>
<span id="L669"><span class="lineNum">     669</span>                 :             :     // only tests that are fast should be done here (to avoid CPU DoS).</span>
<span id="L670"><span class="lineNum">     670</span>                 :             :     bool PreChecks(ATMPArgs&amp; args, Workspace&amp; ws) EXCLUSIVE_LOCKS_REQUIRED(cs_main, m_pool.cs);</span>
<span id="L671"><span class="lineNum">     671</span>                 :             : </span>
<span id="L672"><span class="lineNum">     672</span>                 :             :     // Run checks for mempool replace-by-fee, only used in AcceptSingleTransaction.</span>
<span id="L673"><span class="lineNum">     673</span>                 :             :     bool ReplacementChecks(Workspace&amp; ws) EXCLUSIVE_LOCKS_REQUIRED(cs_main, m_pool.cs);</span>
<span id="L674"><span class="lineNum">     674</span>                 :             : </span>
<span id="L675"><span class="lineNum">     675</span>                 :             :     // Enforce package mempool ancestor/descendant limits (distinct from individual</span>
<span id="L676"><span class="lineNum">     676</span>                 :             :     // ancestor/descendant limits done in PreChecks) and run Package RBF checks.</span>
<span id="L677"><span class="lineNum">     677</span>                 :             :     bool PackageMempoolChecks(const std::vector&lt;CTransactionRef&gt;&amp; txns,</span>
<span id="L678"><span class="lineNum">     678</span>                 :             :                               std::vector&lt;Workspace&gt;&amp; workspaces,</span>
<span id="L679"><span class="lineNum">     679</span>                 :             :                               int64_t total_vsize,</span>
<span id="L680"><span class="lineNum">     680</span>                 :             :                               PackageValidationState&amp; package_state) EXCLUSIVE_LOCKS_REQUIRED(cs_main, m_pool.cs);</span>
<span id="L681"><span class="lineNum">     681</span>                 :             : </span>
<span id="L682"><span class="lineNum">     682</span>                 :             :     // Run the script checks using our policy flags. As this can be slow, we should</span>
<span id="L683"><span class="lineNum">     683</span>                 :             :     // only invoke this on transactions that have otherwise passed policy checks.</span>
<span id="L684"><span class="lineNum">     684</span>                 :             :     bool PolicyScriptChecks(const ATMPArgs&amp; args, Workspace&amp; ws) EXCLUSIVE_LOCKS_REQUIRED(cs_main, m_pool.cs);</span>
<span id="L685"><span class="lineNum">     685</span>                 :             : </span>
<span id="L686"><span class="lineNum">     686</span>                 :             :     // Re-run the script checks, using consensus flags, and try to cache the</span>
<span id="L687"><span class="lineNum">     687</span>                 :             :     // result in the scriptcache. This should be done after</span>
<span id="L688"><span class="lineNum">     688</span>                 :             :     // PolicyScriptChecks(). This requires that all inputs either be in our</span>
<span id="L689"><span class="lineNum">     689</span>                 :             :     // utxo set or in the mempool.</span>
<span id="L690"><span class="lineNum">     690</span>                 :             :     bool ConsensusScriptChecks(const ATMPArgs&amp; args, Workspace&amp; ws) EXCLUSIVE_LOCKS_REQUIRED(cs_main, m_pool.cs);</span>
<span id="L691"><span class="lineNum">     691</span>                 :             : </span>
<span id="L692"><span class="lineNum">     692</span>                 :             :     // Try to add the transaction to the mempool, removing any conflicts first.</span>
<span id="L693"><span class="lineNum">     693</span>                 :             :     void FinalizeSubpackage(const ATMPArgs&amp; args) EXCLUSIVE_LOCKS_REQUIRED(cs_main, m_pool.cs);</span>
<span id="L694"><span class="lineNum">     694</span>                 :             : </span>
<span id="L695"><span class="lineNum">     695</span>                 :             :     // Submit all transactions to the mempool and call ConsensusScriptChecks to add to the script</span>
<span id="L696"><span class="lineNum">     696</span>                 :             :     // cache - should only be called after successful validation of all transactions in the package.</span>
<span id="L697"><span class="lineNum">     697</span>                 :             :     // Does not call LimitMempoolSize(), so mempool max_size_bytes may be temporarily exceeded.</span>
<span id="L698"><span class="lineNum">     698</span>                 :             :     bool SubmitPackage(const ATMPArgs&amp; args, std::vector&lt;Workspace&gt;&amp; workspaces, PackageValidationState&amp; package_state,</span>
<span id="L699"><span class="lineNum">     699</span>                 :             :                        std::map&lt;Wtxid, MempoolAcceptResult&gt;&amp; results)</span>
<span id="L700"><span class="lineNum">     700</span>                 :             :          EXCLUSIVE_LOCKS_REQUIRED(cs_main, m_pool.cs);</span>
<span id="L701"><span class="lineNum">     701</span>                 :             : </span>
<span id="L702"><span class="lineNum">     702</span>                 :             :     // Compare a package's feerate against minimum allowed.</span>
<span id="L703"><span class="lineNum">     703</span>                 :<span class="tlaGNC">      612668 :     bool CheckFeeRate(size_t package_size, CAmount package_fee, TxValidationState&amp; state) EXCLUSIVE_LOCKS_REQUIRED(::cs_main, m_pool.cs)</span></span>
<span id="L704"><span class="lineNum">     704</span>                 :             :     {</span>
<span id="L705"><span class="lineNum">     705</span>                 :<span class="tlaGNC">      612668 :         AssertLockHeld(::cs_main);</span></span>
<span id="L706"><span class="lineNum">     706</span>                 :<span class="tlaGNC">      612668 :         AssertLockHeld(m_pool.cs);</span></span>
<span id="L707"><span class="lineNum">     707</span>                 :<span class="tlaGNC">      612668 :         CAmount mempoolRejectFee = m_pool.GetMinFee().GetFee(package_size);</span></span>
<span id="L708"><span class="lineNum">     708</span>   [<span class="tlaGBC" title="Branch 0 was taken 62844 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 549824 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 46497 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 16347 times"> + </span>]:<span class="tlaGNC">      612668 :         if (mempoolRejectFee &gt; 0 &amp;&amp; package_fee &lt; mempoolRejectFee) {</span></span>
<span id="L709"><span class="lineNum">     709</span>   [<span class="tlaGBC" title="Branch 0 was taken 46497 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 46497 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">       46497 :             return state.Invalid(TxValidationResult::TX_RECONSIDERABLE, &quot;mempool min fee not met&quot;, strprintf(&quot;%d &lt; %d&quot;, package_fee, mempoolRejectFee));</span></span>
<span id="L710"><span class="lineNum">     710</span>                 :             :         }</span>
<span id="L711"><span class="lineNum">     711</span>                 :             : </span>
<span id="L712"><span class="lineNum">     712</span>         [<span class="tlaGBC" title="Branch 0 was taken 10684 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 555487 times"> + </span>]:<span class="tlaGNC">      566171 :         if (package_fee &lt; m_pool.m_opts.min_relay_feerate.GetFee(package_size)) {</span></span>
<span id="L713"><span class="lineNum">     713</span>   [<span class="tlaGBC" title="Branch 0 was taken 10684 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 10684 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">       10684 :             return state.Invalid(TxValidationResult::TX_RECONSIDERABLE, &quot;min relay fee not met&quot;,</span></span>
<span id="L714"><span class="lineNum">     714</span>                 :<span class="tlaGNC">       21368 :                                  strprintf(&quot;%d &lt; %d&quot;, package_fee, m_pool.m_opts.min_relay_feerate.GetFee(package_size)));</span></span>
<span id="L715"><span class="lineNum">     715</span>                 :             :         }</span>
<span id="L716"><span class="lineNum">     716</span>                 :             :         return true;</span>
<span id="L717"><span class="lineNum">     717</span>                 :             :     }</span>
<span id="L718"><span class="lineNum">     718</span>                 :             : </span>
<span id="L719"><span class="lineNum">     719</span>                 :<span class="tlaGNC">      597017 :     ValidationCache&amp; GetValidationCache()</span></span>
<span id="L720"><span class="lineNum">     720</span>                 :             :     {</span>
<span id="L721"><span class="lineNum">     721</span>                 :<span class="tlaGNC">      597017 :         return m_active_chainstate.m_chainman.m_validation_cache;</span></span>
<span id="L722"><span class="lineNum">     722</span>                 :             :     }</span>
<span id="L723"><span class="lineNum">     723</span>                 :             : </span>
<span id="L724"><span class="lineNum">     724</span>                 :             : private:</span>
<span id="L725"><span class="lineNum">     725</span>                 :             :     CTxMemPool&amp; m_pool;</span>
<span id="L726"><span class="lineNum">     726</span>                 :             : </span>
<span id="L727"><span class="lineNum">     727</span>                 :             :     /** Holds a cached view of available coins from the UTXO set, mempool, and artificial temporary coins (to enable package validation).</span>
<span id="L728"><span class="lineNum">     728</span>                 :             :      * The view doesn't track whether a coin previously existed but has now been spent. We detect conflicts in other ways:</span>
<span id="L729"><span class="lineNum">     729</span>                 :             :      * - conflicts within a transaction are checked in CheckTransaction (bad-txns-inputs-duplicate)</span>
<span id="L730"><span class="lineNum">     730</span>                 :             :      * - conflicts within a package are checked in IsWellFormedPackage (conflict-in-package)</span>
<span id="L731"><span class="lineNum">     731</span>                 :             :      * - conflicts with an existing mempool transaction are found in CTxMemPool::GetConflictTx and replacements are allowed</span>
<span id="L732"><span class="lineNum">     732</span>                 :             :      * The temporary coins should persist between individual transaction checks so that package validation is possible,</span>
<span id="L733"><span class="lineNum">     733</span>                 :             :      * but must be cleaned up when we finish validating a subpackage, whether accepted or rejected. The cache must also</span>
<span id="L734"><span class="lineNum">     734</span>                 :             :      * be cleared when mempool contents change (when a changeset is applied or when the mempool trims itself) because it</span>
<span id="L735"><span class="lineNum">     735</span>                 :             :      * can return cached coins that no longer exist in the backend. Use CleanupTemporaryCoins() anytime you are finished</span>
<span id="L736"><span class="lineNum">     736</span>                 :             :      * with a SubPackageState or call LimitMempoolSize().</span>
<span id="L737"><span class="lineNum">     737</span>                 :             :      */</span>
<span id="L738"><span class="lineNum">     738</span>                 :             :     CCoinsViewCache m_view;</span>
<span id="L739"><span class="lineNum">     739</span>                 :             : </span>
<span id="L740"><span class="lineNum">     740</span>                 :             :     // These are the two possible backends for m_view.</span>
<span id="L741"><span class="lineNum">     741</span>                 :             :     /** When m_view is connected to m_viewmempool as its backend, it can pull coins from the mempool and from the UTXO</span>
<span id="L742"><span class="lineNum">     742</span>                 :             :      * set. This is also where temporary coins are stored. */</span>
<span id="L743"><span class="lineNum">     743</span>                 :             :     CCoinsViewMemPool m_viewmempool;</span>
<span id="L744"><span class="lineNum">     744</span>                 :             :     /** When m_view is connected to m_dummy, it can no longer look up coins from the mempool or UTXO set (meaning no disk</span>
<span id="L745"><span class="lineNum">     745</span>                 :             :      * operations happen), but can still return coins it accessed previously. Useful for keeping track of which coins</span>
<span id="L746"><span class="lineNum">     746</span>                 :             :      * were pulled from disk. */</span>
<span id="L747"><span class="lineNum">     747</span>                 :             :     CCoinsView m_dummy;</span>
<span id="L748"><span class="lineNum">     748</span>                 :             : </span>
<span id="L749"><span class="lineNum">     749</span>                 :             :     Chainstate&amp; m_active_chainstate;</span>
<span id="L750"><span class="lineNum">     750</span>                 :             : </span>
<span id="L751"><span class="lineNum">     751</span>                 :             :     // Fields below are per *sub*package state and must be reset prior to subsequent</span>
<span id="L752"><span class="lineNum">     752</span>                 :             :     // AcceptSingleTransaction and AcceptMultipleTransactions invocations</span>
<span id="L753"><span class="lineNum">     753</span>                 :<span class="tlaGNC">     3743377 :     struct SubPackageState {</span></span>
<span id="L754"><span class="lineNum">     754</span>                 :             :         /** Aggregated modified fees of all transactions, used to calculate package feerate. */</span>
<span id="L755"><span class="lineNum">     755</span>                 :             :         CAmount m_total_modified_fees{0};</span>
<span id="L756"><span class="lineNum">     756</span>                 :             :         /** Aggregated virtual size of all transactions, used to calculate package feerate. */</span>
<span id="L757"><span class="lineNum">     757</span>                 :             :         int64_t m_total_vsize{0};</span>
<span id="L758"><span class="lineNum">     758</span>                 :             : </span>
<span id="L759"><span class="lineNum">     759</span>                 :             :         // RBF-related members</span>
<span id="L760"><span class="lineNum">     760</span>                 :             :         /** Whether the transaction(s) would replace any mempool transactions and/or evict any siblings.</span>
<span id="L761"><span class="lineNum">     761</span>                 :             :          * If so, RBF rules apply. */</span>
<span id="L762"><span class="lineNum">     762</span>                 :             :         bool m_rbf{false};</span>
<span id="L763"><span class="lineNum">     763</span>                 :             :         /** Mempool transactions that were replaced. */</span>
<span id="L764"><span class="lineNum">     764</span>                 :             :         std::list&lt;CTransactionRef&gt; m_replaced_transactions;</span>
<span id="L765"><span class="lineNum">     765</span>                 :             :         /* Changeset representing adding transactions and removing their conflicts. */</span>
<span id="L766"><span class="lineNum">     766</span>                 :             :         std::unique_ptr&lt;CTxMemPool::ChangeSet&gt; m_changeset;</span>
<span id="L767"><span class="lineNum">     767</span>                 :             : </span>
<span id="L768"><span class="lineNum">     768</span>                 :             :         /** Total modified fees of mempool transactions being replaced. */</span>
<span id="L769"><span class="lineNum">     769</span>                 :             :         CAmount m_conflicting_fees{0};</span>
<span id="L770"><span class="lineNum">     770</span>                 :             :         /** Total size (in virtual bytes) of mempool transactions being replaced. */</span>
<span id="L771"><span class="lineNum">     771</span>                 :             :         size_t m_conflicting_size{0};</span>
<span id="L772"><span class="lineNum">     772</span>                 :             :     };</span>
<span id="L773"><span class="lineNum">     773</span>                 :             : </span>
<span id="L774"><span class="lineNum">     774</span>                 :             :     struct SubPackageState m_subpackage;</span>
<span id="L775"><span class="lineNum">     775</span>                 :             : </span>
<span id="L776"><span class="lineNum">     776</span>                 :             :     /** Re-set sub-package state to not leak between evaluations */</span>
<span id="L777"><span class="lineNum">     777</span>                 :<span class="tlaGNC">     1260821 :     void ClearSubPackageState() EXCLUSIVE_LOCKS_REQUIRED(cs_main, m_pool.cs)</span></span>
<span id="L778"><span class="lineNum">     778</span>                 :             :     {</span>
<span id="L779"><span class="lineNum">     779</span>                 :<span class="tlaGNC">     1260821 :         m_subpackage = SubPackageState{};</span></span>
<span id="L780"><span class="lineNum">     780</span>                 :             : </span>
<span id="L781"><span class="lineNum">     781</span>                 :             :         // And clean coins while at it</span>
<span id="L782"><span class="lineNum">     782</span>                 :<span class="tlaGNC">     1260821 :         CleanupTemporaryCoins();</span></span>
<span id="L783"><span class="lineNum">     783</span>                 :<span class="tlaGNC">     1260821 :     }</span></span>
<span id="L784"><span class="lineNum">     784</span>                 :             : };</span>
<span id="L785"><span class="lineNum">     785</span>                 :             : </span>
<span id="L786"><span class="lineNum">     786</span>                 :<span class="tlaGNC">     2915454 : bool MemPoolAccept::PreChecks(ATMPArgs&amp; args, Workspace&amp; ws)</span></span>
<span id="L787"><span class="lineNum">     787</span>                 :             : {</span>
<span id="L788"><span class="lineNum">     788</span>                 :<span class="tlaGNC">     2915454 :     AssertLockHeld(cs_main);</span></span>
<span id="L789"><span class="lineNum">     789</span>                 :<span class="tlaGNC">     2915454 :     AssertLockHeld(m_pool.cs);</span></span>
<span id="L790"><span class="lineNum">     790</span>                 :<span class="tlaGNC">     2915454 :     const CTransactionRef&amp; ptx = ws.m_ptx;</span></span>
<span id="L791"><span class="lineNum">     791</span>                 :<span class="tlaGNC">     2915454 :     const CTransaction&amp; tx = *ws.m_ptx;</span></span>
<span id="L792"><span class="lineNum">     792</span>                 :<span class="tlaGNC">     2915454 :     const Txid&amp; hash = ws.m_hash;</span></span>
<span id="L793"><span class="lineNum">     793</span>                 :             : </span>
<span id="L794"><span class="lineNum">     794</span>                 :             :     // Copy/alias what we need out of args</span>
<span id="L795"><span class="lineNum">     795</span>                 :<span class="tlaGNC">     2915454 :     const int64_t nAcceptTime = args.m_accept_time;</span></span>
<span id="L796"><span class="lineNum">     796</span>                 :<span class="tlaGNC">     2915454 :     const bool bypass_limits = args.m_bypass_limits;</span></span>
<span id="L797"><span class="lineNum">     797</span>                 :<span class="tlaGNC">     2915454 :     std::vector&lt;COutPoint&gt;&amp; coins_to_uncache = args.m_coins_to_uncache;</span></span>
<span id="L798"><span class="lineNum">     798</span>                 :             : </span>
<span id="L799"><span class="lineNum">     799</span>                 :             :     // Alias what we need out of ws</span>
<span id="L800"><span class="lineNum">     800</span>                 :<span class="tlaGNC">     2915454 :     TxValidationState&amp; state = ws.m_state;</span></span>
<span id="L801"><span class="lineNum">     801</span>                 :             : </span>
<span id="L802"><span class="lineNum">     802</span>         [<span class="tlaGBC" title="Branch 0 was taken 2258352 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 657102 times"> + </span>]:<span class="tlaGNC">     2915454 :     if (!CheckTransaction(tx, state)) {</span></span>
<span id="L803"><span class="lineNum">     803</span>                 :             :         return false; // state filled in by CheckTransaction</span>
<span id="L804"><span class="lineNum">     804</span>                 :             :     }</span>
<span id="L805"><span class="lineNum">     805</span>                 :             : </span>
<span id="L806"><span class="lineNum">     806</span>                 :             :     // Coinbase is only valid in a block, not as a loose transaction</span>
<span id="L807"><span class="lineNum">     807</span>         [<span class="tlaGBC" title="Branch 0 was taken 173 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 2258179 times"> + </span>]:<span class="tlaGNC">     2258352 :     if (tx.IsCoinBase())</span></span>
<span id="L808"><span class="lineNum">     808</span>   [<span class="tlaGBC" title="Branch 0 was taken 173 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 173 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">         173 :         return state.Invalid(TxValidationResult::TX_CONSENSUS, &quot;coinbase&quot;);</span></span>
<span id="L809"><span class="lineNum">     809</span>                 :             : </span>
<span id="L810"><span class="lineNum">     810</span>                 :             :     // Rather not work on nonstandard transactions (unless -testnet/-regtest)</span>
<span id="L811"><span class="lineNum">     811</span>         [<span class="tlaGBC" title="Branch 0 was taken 1656411 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 601768 times"> + </span>]:<span class="tlaGNC">     2258179 :     std::string reason;</span></span>
<span id="L812"><span class="lineNum">     812</span>   [<span class="tlaGBC" title="Branch 0 was taken 1656411 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 601768 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 1656411 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">     2258179 :     if (m_pool.m_opts.require_standard &amp;&amp; !IsStandardTx(tx, m_pool.m_opts.max_datacarrier_bytes, m_pool.m_opts.permit_bare_multisig, m_pool.m_opts.dust_relay_feerate, reason)) {</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 81225 times"> + </span><span class="tlaGBC" title="Branch 5 was taken 1575186 times"> + </span>]
<span id="L813"><span class="lineNum">     813</span>   [<span class="tlaGBC" title="Branch 0 was taken 81225 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 81225 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">       81225 :         return state.Invalid(TxValidationResult::TX_NOT_STANDARD, reason);</span></span>
<span id="L814"><span class="lineNum">     814</span>                 :             :     }</span>
<span id="L815"><span class="lineNum">     815</span>                 :             : </span>
<span id="L816"><span class="lineNum">     816</span>                 :             :     // Transactions smaller than 65 non-witness bytes are not relayed to mitigate CVE-2017-12842.</span>
<span id="L817"><span class="lineNum">     817</span>         [<span class="tlaGBC" title="Branch 0 was taken 2096 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 2174858 times"> + </span>]:<span class="tlaGNC">     2176954 :     if (::GetSerializeSize(TX_NO_WITNESS(tx)) &lt; MIN_STANDARD_TX_NONWITNESS_SIZE)</span></span>
<span id="L818"><span class="lineNum">     818</span>   [<span class="tlaGBC" title="Branch 0 was taken 2096 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 2096 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">        2096 :         return state.Invalid(TxValidationResult::TX_NOT_STANDARD, &quot;tx-size-small&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 2096 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L819"><span class="lineNum">     819</span>                 :             : </span>
<span id="L820"><span class="lineNum">     820</span>                 :             :     // Only accept nLockTime-using transactions that can be mined in the next</span>
<span id="L821"><span class="lineNum">     821</span>                 :             :     // block; we don't want our mempool filled up with transactions that can't</span>
<span id="L822"><span class="lineNum">     822</span>                 :             :     // be mined yet.</span>
<span id="L823"><span class="lineNum">     823</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 2174858 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 2174858 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">     4349716 :     if (!CheckFinalTxAtTip(*Assert(m_active_chainstate.m_chain.Tip()), tx)) {</span></span>
<span class="lineNum">        </span>    <span class="tlaGBC" title="Branch 4 was taken 2174858 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaGBC" title="Branch 6 was taken 146802 times"> + </span><span class="tlaGBC" title="Branch 7 was taken 2028056 times"> + </span>]
<span id="L824"><span class="lineNum">     824</span>   [<span class="tlaGBC" title="Branch 0 was taken 146802 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 146802 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      146802 :         return state.Invalid(TxValidationResult::TX_PREMATURE_SPEND, &quot;non-final&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 146802 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L825"><span class="lineNum">     825</span>                 :             :     }</span>
<span id="L826"><span class="lineNum">     826</span>                 :             : </span>
<span id="L827"><span class="lineNum">     827</span>   [<span class="tlaGBC" title="Branch 0 was taken 2028056 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 105420 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 1922636 times"> + </span>]:<span class="tlaGNC">     2028056 :     if (m_pool.exists(tx.GetWitnessHash())) {</span></span>
<span id="L828"><span class="lineNum">     828</span>                 :             :         // Exact transaction already exists in the mempool.</span>
<span id="L829"><span class="lineNum">     829</span>   [<span class="tlaGBC" title="Branch 0 was taken 105420 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 105420 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      105420 :         return state.Invalid(TxValidationResult::TX_CONFLICT, &quot;txn-already-in-mempool&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 105420 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L830"><span class="lineNum">     830</span>   [<span class="tlaGBC" title="Branch 0 was taken 1922636 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 1124 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 1921512 times"> + </span>]:<span class="tlaGNC">     1922636 :     } else if (m_pool.exists(tx.GetHash())) {</span></span>
<span id="L831"><span class="lineNum">     831</span>                 :             :         // Transaction with the same non-witness data but different witness (same txid, different</span>
<span id="L832"><span class="lineNum">     832</span>                 :             :         // wtxid) already exists in the mempool.</span>
<span id="L833"><span class="lineNum">     833</span>   [<span class="tlaGBC" title="Branch 0 was taken 1124 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 1124 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">        1124 :         return state.Invalid(TxValidationResult::TX_CONFLICT, &quot;txn-same-nonwitness-data-in-mempool&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 1124 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L834"><span class="lineNum">     834</span>                 :             :     }</span>
<span id="L835"><span class="lineNum">     835</span>                 :             : </span>
<span id="L836"><span class="lineNum">     836</span>                 :             :     // Check for conflicts with in-memory transactions</span>
<span id="L837"><span class="lineNum">     837</span>         [<span class="tlaGBC" title="Branch 0 was taken 11613733 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 1766431 times"> + </span>]:<span class="tlaGNC">    13380164 :     for (const CTxIn &amp;txin : tx.vin)</span></span>
<span id="L838"><span class="lineNum">     838</span>                 :             :     {</span>
<span id="L839"><span class="lineNum">     839</span>         [<span class="tlaGBC" title="Branch 0 was taken 11613733 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">    11613733 :         const CTransaction* ptxConflicting = m_pool.GetConflictTx(txin.prevout);</span></span>
<span id="L840"><span class="lineNum">     840</span>         [<span class="tlaGBC" title="Branch 0 was taken 1440959 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 10172774 times"> + </span>]:<span class="tlaGNC">    11613733 :         if (ptxConflicting) {</span></span>
<span id="L841"><span class="lineNum">     841</span>         [<span class="tlaGBC" title="Branch 0 was taken 155081 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 1285878 times"> + </span>]:<span class="tlaGNC">     1440959 :             if (!args.m_allow_replacement) {</span></span>
<span id="L842"><span class="lineNum">     842</span>                 :             :                 // Transaction conflicts with a mempool tx, but we're not allowing replacements in this context.</span>
<span id="L843"><span class="lineNum">     843</span>   [<span class="tlaGBC" title="Branch 0 was taken 155081 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 155081 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      155081 :                 return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, &quot;bip125-replacement-disallowed&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 155081 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L844"><span class="lineNum">     844</span>                 :             :             }</span>
<span id="L845"><span class="lineNum">     845</span>         [<span class="tlaGBC" title="Branch 0 was taken 1285878 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">     1285878 :             ws.m_conflicts.insert(ptxConflicting-&gt;GetHash());</span></span>
<span id="L846"><span class="lineNum">     846</span>                 :             :         }</span>
<span id="L847"><span class="lineNum">     847</span>                 :             :     }</span>
<span id="L848"><span class="lineNum">     848</span>                 :             : </span>
<span id="L849"><span class="lineNum">     849</span>         [<span class="tlaGBC" title="Branch 0 was taken 1766431 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">     1766431 :     m_view.SetBackend(m_viewmempool);</span></span>
<span id="L850"><span class="lineNum">     850</span>                 :             : </span>
<span id="L851"><span class="lineNum">     851</span>         [<span class="tlaGBC" title="Branch 0 was taken 1766431 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">     1766431 :     const CCoinsViewCache&amp; coins_cache = m_active_chainstate.CoinsTip();</span></span>
<span id="L852"><span class="lineNum">     852</span>                 :             :     // do all inputs exist?</span>
<span id="L853"><span class="lineNum">     853</span>         [<span class="tlaGBC" title="Branch 0 was taken 7501101 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 1267937 times"> + </span>]:<span class="tlaGNC">     8769038 :     for (const CTxIn&amp; txin : tx.vin) {</span></span>
<span id="L854"><span class="lineNum">     854</span>   [<span class="tlaGBC" title="Branch 0 was taken 7501101 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 4183464 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 3317637 times"> + </span>]:<span class="tlaGNC">     7501101 :         if (!coins_cache.HaveCoinInCache(txin.prevout)) {</span></span>
<span id="L855"><span class="lineNum">     855</span>         [<span class="tlaGBC" title="Branch 0 was taken 4183464 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">     4183464 :             coins_to_uncache.push_back(txin.prevout);</span></span>
<span id="L856"><span class="lineNum">     856</span>                 :             :         }</span>
<span id="L857"><span class="lineNum">     857</span>                 :             : </span>
<span id="L858"><span class="lineNum">     858</span>                 :             :         // Note: this call may add txin.prevout to the coins cache</span>
<span id="L859"><span class="lineNum">     859</span>                 :             :         // (coins_cache.cacheCoins) by way of FetchCoin(). It should be removed</span>
<span id="L860"><span class="lineNum">     860</span>                 :             :         // later (via coins_to_uncache) if this tx turns out to be invalid.</span>
<span id="L861"><span class="lineNum">     861</span>   [<span class="tlaGBC" title="Branch 0 was taken 7501101 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 498494 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 7002607 times"> + </span>]:<span class="tlaGNC">     7501101 :         if (!m_view.HaveCoin(txin.prevout)) {</span></span>
<span id="L862"><span class="lineNum">     862</span>                 :             :             // Are inputs missing because we already have the tx?</span>
<span id="L863"><span class="lineNum">     863</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 3711542 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 3213048 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 498494 times"> + </span>]:<span class="tlaGNC">     3711542 :             for (size_t out = 0; out &lt; tx.vout.size(); out++) {</span></span>
<span id="L864"><span class="lineNum">     864</span>                 :             :                 // Optimistically just do efficient check of cache for outputs</span>
<span id="L865"><span class="lineNum">     865</span>   [<span class="tlaGBC" title="Branch 0 was taken 3213048 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 3213048 times"> + </span>]:<span class="tlaGNC">     3213048 :                 if (coins_cache.HaveCoinInCache(COutPoint(hash, out))) {</span></span>
<span id="L866"><span class="lineNum">     866</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                     return state.Invalid(TxValidationResult::TX_CONFLICT, &quot;txn-already-known&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L867"><span class="lineNum">     867</span>                 :             :                 }</span>
<span id="L868"><span class="lineNum">     868</span>                 :             :             }</span>
<span id="L869"><span class="lineNum">     869</span>                 :             :             // Otherwise assume this might be an orphan tx for which we just haven't seen parents yet</span>
<span id="L870"><span class="lineNum">     870</span>   [<span class="tlaGBC" title="Branch 0 was taken 498494 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 498494 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      498494 :             return state.Invalid(TxValidationResult::TX_MISSING_INPUTS, &quot;bad-txns-inputs-missingorspent&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 498494 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L871"><span class="lineNum">     871</span>                 :             :         }</span>
<span id="L872"><span class="lineNum">     872</span>                 :             :     }</span>
<span id="L873"><span class="lineNum">     873</span>                 :             : </span>
<span id="L874"><span class="lineNum">     874</span>                 :             :     // This is const, but calls into the back end CoinsViews. The CCoinsViewDB at the bottom of the</span>
<span id="L875"><span class="lineNum">     875</span>                 :             :     // hierarchy brings the best block into scope. See CCoinsViewDB::GetBestBlock().</span>
<span id="L876"><span class="lineNum">     876</span>         [<span class="tlaGBC" title="Branch 0 was taken 1267937 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">     1267937 :     m_view.GetBestBlock();</span></span>
<span id="L877"><span class="lineNum">     877</span>                 :             : </span>
<span id="L878"><span class="lineNum">     878</span>                 :             :     // we have all inputs cached now, so switch back to dummy (to protect</span>
<span id="L879"><span class="lineNum">     879</span>                 :             :     // against bugs where we pull more inputs from disk that miss being added</span>
<span id="L880"><span class="lineNum">     880</span>                 :             :     // to coins_to_uncache)</span>
<span id="L881"><span class="lineNum">     881</span>         [<span class="tlaGBC" title="Branch 0 was taken 1267937 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">     1267937 :     m_view.SetBackend(m_dummy);</span></span>
<span id="L882"><span class="lineNum">     882</span>                 :             : </span>
<span id="L883"><span class="lineNum">     883</span>   [<span class="tlaGBC" title="Branch 0 was taken 1267937 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 1267937 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">     2535874 :     assert(m_active_chainstate.m_blockman.LookupBlockIndex(m_view.GetBestBlock()) == m_active_chainstate.m_chain.Tip());</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaGBC" title="Branch 5 was taken 1267937 times"> + </span><span class="tlaUNC" title="Branch 6 was not taken"> - </span><span class="tlaGBC" title="Branch 7 was taken 1267937 times"> + </span>]
<span id="L884"><span class="lineNum">     884</span>                 :             : </span>
<span id="L885"><span class="lineNum">     885</span>                 :             :     // Only accept BIP68 sequence locked transactions that can be mined in the next</span>
<span id="L886"><span class="lineNum">     886</span>                 :             :     // block; we don't want our mempool filled up with transactions that can't</span>
<span id="L887"><span class="lineNum">     887</span>                 :             :     // be mined yet.</span>
<span id="L888"><span class="lineNum">     888</span>                 :             :     // Pass in m_view which has all of the relevant inputs cached. Note that, since m_view's</span>
<span id="L889"><span class="lineNum">     889</span>                 :             :     // backend was removed, it no longer pulls coins from the mempool.</span>
<span id="L890"><span class="lineNum">     890</span>         [<span class="tlaGBC" title="Branch 0 was taken 1267937 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">     1267937 :     const std::optional&lt;LockPoints&gt; lock_points{CalculateLockPointsAtTip(m_active_chainstate.m_chain.Tip(), m_view, tx)};</span></span>
<span id="L891"><span class="lineNum">     891</span>   [<span class="tlaGBC" title="Branch 0 was taken 1267937 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 1267937 times"> + </span> :<span class="tlaGNC">     2535874 :     if (!lock_points.has_value() || !CheckSequenceLocksAtTip(m_active_chainstate.m_chain.Tip(), *lock_points)) {</span></span>
<span class="lineNum">        </span>    <span class="tlaGBC" title="Branch 4 was taken 1267937 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaGBC" title="Branch 6 was taken 1202131 times"> + </span><span class="tlaGBC" title="Branch 7 was taken 65806 times"> + </span>]
<span id="L892"><span class="lineNum">     892</span>   [<span class="tlaGBC" title="Branch 0 was taken 65806 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 65806 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">       65806 :         return state.Invalid(TxValidationResult::TX_PREMATURE_SPEND, &quot;non-BIP68-final&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 65806 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L893"><span class="lineNum">     893</span>                 :             :     }</span>
<span id="L894"><span class="lineNum">     894</span>                 :             : </span>
<span id="L895"><span class="lineNum">     895</span>                 :             :     // The mempool holds txs for the next block, so pass height+1 to CheckTxInputs</span>
<span id="L896"><span class="lineNum">     896</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 1202131 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 1202131 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">     1202131 :     if (!Consensus::CheckTxInputs(tx, state, m_view, m_active_chainstate.m_chain.Height() + 1, ws.m_base_fees)) {</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 1190522 times"> + </span><span class="tlaGBC" title="Branch 5 was taken 11609 times"> + </span>]
<span id="L897"><span class="lineNum">     897</span>                 :             :         return false; // state filled in by CheckTxInputs</span>
<span id="L898"><span class="lineNum">     898</span>                 :             :     }</span>
<span id="L899"><span class="lineNum">     899</span>                 :             : </span>
<span id="L900"><span class="lineNum">     900</span>   [<span class="tlaGBC" title="Branch 0 was taken 872351 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 318171 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 872351 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">     1190522 :     if (m_pool.m_opts.require_standard &amp;&amp; !AreInputsStandard(tx, m_view)) {</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 872103 times"> + </span><span class="tlaGBC" title="Branch 5 was taken 248 times"> + </span>]
<span id="L901"><span class="lineNum">     901</span>   [<span class="tlaGBC" title="Branch 0 was taken 248 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 248 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">         248 :         return state.Invalid(TxValidationResult::TX_INPUTS_NOT_STANDARD, &quot;bad-txns-nonstandard-inputs&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 248 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L902"><span class="lineNum">     902</span>                 :             :     }</span>
<span id="L903"><span class="lineNum">     903</span>                 :             : </span>
<span id="L904"><span class="lineNum">     904</span>                 :             :     // Check for non-standard witnesses.</span>
<span id="L905"><span class="lineNum">     905</span>   [<span class="tlaGBC" title="Branch 0 was taken 1159857 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 30417 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 869587 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 290270 times"> + </span> :<span class="tlaGNC">     1190274 :     if (tx.HasWitness() &amp;&amp; m_pool.m_opts.require_standard &amp;&amp; !IsWitnessStandard(tx, m_view)) {</span></span>
<span class="lineNum">        </span>    <span class="tlaGBC" title="Branch 4 was taken 869587 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaGBC" title="Branch 6 was taken 866476 times"> + </span><span class="tlaGBC" title="Branch 7 was taken 3111 times"> + </span>]
<span id="L906"><span class="lineNum">     906</span>   [<span class="tlaGBC" title="Branch 0 was taken 3111 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 3111 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">        3111 :         return state.Invalid(TxValidationResult::TX_WITNESS_MUTATED, &quot;bad-witness-nonstandard&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 3111 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L907"><span class="lineNum">     907</span>                 :             :     }</span>
<span id="L908"><span class="lineNum">     908</span>                 :             : </span>
<span id="L909"><span class="lineNum">     909</span>         [<span class="tlaGBC" title="Branch 0 was taken 1187163 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">     1187163 :     int64_t nSigOpsCost = GetTransactionSigOpCost(tx, m_view, STANDARD_SCRIPT_VERIFY_FLAGS);</span></span>
<span id="L910"><span class="lineNum">     910</span>                 :             : </span>
<span id="L911"><span class="lineNum">     911</span>                 :             :     // Keep track of transactions that spend a coinbase, which we re-scan</span>
<span id="L912"><span class="lineNum">     912</span>                 :             :     // during reorgs to ensure COINBASE_MATURITY is still met.</span>
<span id="L913"><span class="lineNum">     913</span>                 :<span class="tlaGNC">     1187163 :     bool fSpendsCoinbase = false;</span></span>
<span id="L914"><span class="lineNum">     914</span>         [<span class="tlaGBC" title="Branch 0 was taken 1857734 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 328551 times"> + </span>]:<span class="tlaGNC">     2186285 :     for (const CTxIn &amp;txin : tx.vin) {</span></span>
<span id="L915"><span class="lineNum">     915</span>         [<span class="tlaGBC" title="Branch 0 was taken 1857734 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">     1857734 :         const Coin &amp;coin = m_view.AccessCoin(txin.prevout);</span></span>
<span id="L916"><span class="lineNum">     916</span>         [<span class="tlaGBC" title="Branch 0 was taken 999122 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 858612 times"> + </span>]:<span class="tlaGNC">     1857734 :         if (coin.IsCoinBase()) {</span></span>
<span id="L917"><span class="lineNum">     917</span>                 :             :             fSpendsCoinbase = true;</span>
<span id="L918"><span class="lineNum">     918</span>                 :             :             break;</span>
<span id="L919"><span class="lineNum">     919</span>                 :             :         }</span>
<span id="L920"><span class="lineNum">     920</span>                 :             :     }</span>
<span id="L921"><span class="lineNum">     921</span>                 :             : </span>
<span id="L922"><span class="lineNum">     922</span>                 :             :     // Set entry_sequence to 0 when bypass_limits is used; this allows txs from a block</span>
<span id="L923"><span class="lineNum">     923</span>                 :             :     // reorg to be marked earlier than any child txs that were already in the mempool.</span>
<span id="L924"><span class="lineNum">     924</span>         [<span class="tlaGBC" title="Branch 0 was taken 950230 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 236933 times"> + </span>]:<span class="tlaGNC">     1187163 :     const uint64_t entry_sequence = bypass_limits ? 0 : m_pool.GetSequence();</span></span>
<span id="L925"><span class="lineNum">     925</span>         [<span class="tlaGBC" title="Branch 0 was taken 1095665 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 91498 times"> + </span>]:<span class="tlaGNC">     1187163 :     if (!m_subpackage.m_changeset) {</span></span>
<span id="L926"><span class="lineNum">     926</span>         [<span class="tlaGBC" title="Branch 0 was taken 1095665 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">     1095665 :         m_subpackage.m_changeset = m_pool.GetChangeSet();</span></span>
<span id="L927"><span class="lineNum">     927</span>                 :             :     }</span>
<span id="L928"><span class="lineNum">     928</span>   [<span class="tlaGBC" title="Branch 0 was taken 1187163 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 1187163 times"> + </span> :<span class="tlaGNC">     1187163 :     ws.m_tx_handle = m_subpackage.m_changeset-&gt;StageAddition(ptx, ws.m_base_fees, nAcceptTime, m_active_chainstate.m_chain.Height(), entry_sequence, fSpendsCoinbase, nSigOpsCost, lock_points.value());</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 1187163 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L929"><span class="lineNum">     929</span>                 :             : </span>
<span id="L930"><span class="lineNum">     930</span>                 :             :     // ws.m_modified_fees includes any fee deltas from PrioritiseTransaction</span>
<span id="L931"><span class="lineNum">     931</span>         [<span class="tlaGBC" title="Branch 0 was taken 1187163 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">     1187163 :     ws.m_modified_fees = ws.m_tx_handle-&gt;GetModifiedFee();</span></span>
<span id="L932"><span class="lineNum">     932</span>                 :             : </span>
<span id="L933"><span class="lineNum">     933</span>         [<span class="tlaGBC" title="Branch 0 was taken 1187163 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">     1187163 :     ws.m_vsize = ws.m_tx_handle-&gt;GetTxSize();</span></span>
<span id="L934"><span class="lineNum">     934</span>                 :             : </span>
<span id="L935"><span class="lineNum">     935</span>                 :             :     // Enforces 0-fee for dust transactions, no incentive to be mined alone</span>
<span id="L936"><span class="lineNum">     936</span>         [<span class="tlaGBC" title="Branch 0 was taken 868992 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 318171 times"> + </span>]:<span class="tlaGNC">     1187163 :     if (m_pool.m_opts.require_standard) {</span></span>
<span id="L937"><span class="lineNum">     937</span>   [<span class="tlaGBC" title="Branch 0 was taken 868992 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 712447 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 156545 times"> + </span>]:<span class="tlaGNC">      868992 :         if (!PreCheckEphemeralTx(*ptx, m_pool.m_opts.dust_relay_feerate, ws.m_base_fees, ws.m_modified_fees, state)) {</span></span>
<span id="L938"><span class="lineNum">     938</span>                 :             :             return false; // state filled in by PreCheckEphemeralTx</span>
<span id="L939"><span class="lineNum">     939</span>                 :             :         }</span>
<span id="L940"><span class="lineNum">     940</span>                 :             :     }</span>
<span id="L941"><span class="lineNum">     941</span>                 :             : </span>
<span id="L942"><span class="lineNum">     942</span>         [<span class="tlaGBC" title="Branch 0 was taken 260 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 1030358 times"> + </span>]:<span class="tlaGNC">     1030618 :     if (nSigOpsCost &gt; MAX_STANDARD_TX_SIGOPS_COST)</span></span>
<span id="L943"><span class="lineNum">     943</span>   [<span class="tlaGBC" title="Branch 0 was taken 260 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 260 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">         260 :         return state.Invalid(TxValidationResult::TX_NOT_STANDARD, &quot;bad-txns-too-many-sigops&quot;,</span></span>
<span id="L944"><span class="lineNum">     944</span>         [<span class="tlaGBC" title="Branch 0 was taken 260 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">         520 :                 strprintf(&quot;%d&quot;, nSigOpsCost));</span></span>
<span id="L945"><span class="lineNum">     945</span>                 :             : </span>
<span id="L946"><span class="lineNum">     946</span>                 :             :     // No individual transactions are allowed below the min relay feerate except from disconnected blocks.</span>
<span id="L947"><span class="lineNum">     947</span>                 :             :     // This requirement, unlike CheckFeeRate, cannot be bypassed using m_package_feerates because,</span>
<span id="L948"><span class="lineNum">     948</span>                 :             :     // while a tx could be package CPFP'd when entering the mempool, we do not have a DoS-resistant</span>
<span id="L949"><span class="lineNum">     949</span>                 :             :     // method of ensuring the tx remains bumped. For example, the fee-bumping child could disappear</span>
<span id="L950"><span class="lineNum">     950</span>                 :             :     // due to a replacement.</span>
<span id="L951"><span class="lineNum">     951</span>                 :             :     // The only exception is TRUC transactions.</span>
<span id="L952"><span class="lineNum">     952</span>   [<span class="tlaGBC" title="Branch 0 was taken 808571 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 221787 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 724575 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 83996 times"> + </span> :<span class="tlaGNC">     1030358 :     if (!bypass_limits &amp;&amp; ws.m_ptx-&gt;version != TRUC_VERSION &amp;&amp; ws.m_modified_fees &lt; m_pool.m_opts.min_relay_feerate.GetFee(ws.m_vsize)) {</span></span>
<span class="lineNum">        </span>    <span class="tlaGBC" title="Branch 4 was taken 724575 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaGBC" title="Branch 6 was taken 625658 times"> + </span><span class="tlaGBC" title="Branch 7 was taken 98917 times"> + </span>]
<span id="L953"><span class="lineNum">     953</span>                 :             :         // Even though this is a fee-related failure, this result is TX_MEMPOOL_POLICY, not</span>
<span id="L954"><span class="lineNum">     954</span>                 :             :         // TX_RECONSIDERABLE, because it cannot be bypassed using package validation.</span>
<span id="L955"><span class="lineNum">     955</span>   [<span class="tlaGBC" title="Branch 0 was taken 98917 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 98917 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">       98917 :         return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, &quot;min relay fee not met&quot;,</span></span>
<span id="L956"><span class="lineNum">     956</span>   [<span class="tlaGBC" title="Branch 0 was taken 98917 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 98917 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      197834 :                              strprintf(&quot;%d &lt; %d&quot;, ws.m_modified_fees, m_pool.m_opts.min_relay_feerate.GetFee(ws.m_vsize)));</span></span>
<span id="L957"><span class="lineNum">     957</span>                 :             :     }</span>
<span id="L958"><span class="lineNum">     958</span>                 :             :     // No individual transactions are allowed below the mempool min feerate except from disconnected</span>
<span id="L959"><span class="lineNum">     959</span>                 :             :     // blocks and transactions in a package. Package transactions will be checked using package</span>
<span id="L960"><span class="lineNum">     960</span>                 :             :     // feerate later.</span>
<span id="L961"><span class="lineNum">     961</span>   [<span class="tlaGBC" title="Branch 0 was taken 709654 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 221787 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 555905 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 153749 times"> + </span> :<span class="tlaGNC">      931441 :     if (!bypass_limits &amp;&amp; !args.m_package_feerates &amp;&amp; !CheckFeeRate(ws.m_vsize, ws.m_modified_fees, state)) return false;</span></span>
<span class="lineNum">        </span>    <span class="tlaGBC" title="Branch 4 was taken 555905 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaGBC" title="Branch 6 was taken 500914 times"> + </span><span class="tlaGBC" title="Branch 7 was taken 54991 times"> + </span>]
<span id="L962"><span class="lineNum">     962</span>                 :             : </span>
<span id="L963"><span class="lineNum">     963</span>         [<span class="tlaGBC" title="Branch 0 was taken 876450 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      876450 :     ws.m_iters_conflicting = m_pool.GetIterSet(ws.m_conflicts);</span></span>
<span id="L964"><span class="lineNum">     964</span>                 :             : </span>
<span id="L965"><span class="lineNum">     965</span>                 :             :     // Note that these modifications are only applicable to single transaction scenarios;</span>
<span id="L966"><span class="lineNum">     966</span>                 :             :     // carve-outs are disabled for multi-transaction evaluations.</span>
<span id="L967"><span class="lineNum">     967</span>                 :<span class="tlaGNC">      876450 :     CTxMemPool::Limits maybe_rbf_limits = m_pool.m_opts.limits;</span></span>
<span id="L968"><span class="lineNum">     968</span>                 :             : </span>
<span id="L969"><span class="lineNum">     969</span>                 :             :     // Calculate in-mempool ancestors, up to a limit.</span>
<span id="L970"><span class="lineNum">     970</span>   [<span class="tlaGBC" title="Branch 0 was taken 324487 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 551963 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 156392 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 168095 times"> + </span>]:<span class="tlaGNC">      876450 :     if (ws.m_conflicts.size() == 1 &amp;&amp; args.m_allow_carveouts) {</span></span>
<span id="L971"><span class="lineNum">     971</span>                 :             :         // In general, when we receive an RBF transaction with mempool conflicts, we want to know whether we</span>
<span id="L972"><span class="lineNum">     972</span>                 :             :         // would meet the chain limits after the conflicts have been removed. However, there isn't a practical</span>
<span id="L973"><span class="lineNum">     973</span>                 :             :         // way to do this short of calculating the ancestor and descendant sets with an overlay cache of</span>
<span id="L974"><span class="lineNum">     974</span>                 :             :         // changed mempool entries. Due to both implementation and runtime complexity concerns, this isn't</span>
<span id="L975"><span class="lineNum">     975</span>                 :             :         // very realistic, thus we only ensure a limited set of transactions are RBF'able despite mempool</span>
<span id="L976"><span class="lineNum">     976</span>                 :             :         // conflicts here. Importantly, we need to ensure that some transactions which were accepted using</span>
<span id="L977"><span class="lineNum">     977</span>                 :             :         // the below carve-out are able to be RBF'ed, without impacting the security the carve-out provides</span>
<span id="L978"><span class="lineNum">     978</span>                 :             :         // for off-chain contract systems (see link in the comment below).</span>
<span id="L979"><span class="lineNum">     979</span>                 :             :         //</span>
<span id="L980"><span class="lineNum">     980</span>                 :             :         // Specifically, the subset of RBF transactions which we allow despite chain limits are those which</span>
<span id="L981"><span class="lineNum">     981</span>                 :             :         // conflict directly with exactly one other transaction (but may evict children of said transaction),</span>
<span id="L982"><span class="lineNum">     982</span>                 :             :         // and which are not adding any new mempool dependencies. Note that the &quot;no new mempool dependencies&quot;</span>
<span id="L983"><span class="lineNum">     983</span>                 :             :         // check is accomplished later, so we don't bother doing anything about it here, but if our</span>
<span id="L984"><span class="lineNum">     984</span>                 :             :         // policy changes, we may need to move that check to here instead of removing it wholesale.</span>
<span id="L985"><span class="lineNum">     985</span>                 :             :         //</span>
<span id="L986"><span class="lineNum">     986</span>                 :             :         // Such transactions are clearly not merging any existing packages, so we are only concerned with</span>
<span id="L987"><span class="lineNum">     987</span>                 :             :         // ensuring that (a) no package is growing past the package size (not count) limits and (b) we are</span>
<span id="L988"><span class="lineNum">     988</span>                 :             :         // not allowing something to effectively use the (below) carve-out spot when it shouldn't be allowed</span>
<span id="L989"><span class="lineNum">     989</span>                 :             :         // to.</span>
<span id="L990"><span class="lineNum">     990</span>                 :             :         //</span>
<span id="L991"><span class="lineNum">     991</span>                 :             :         // To check these we first check if we meet the RBF criteria, above, and increment the descendant</span>
<span id="L992"><span class="lineNum">     992</span>                 :             :         // limits by the direct conflict and its descendants (as these are recalculated in</span>
<span id="L993"><span class="lineNum">     993</span>                 :             :         // CalculateMempoolAncestors by assuming the new transaction being added is a new descendant, with no</span>
<span id="L994"><span class="lineNum">     994</span>                 :             :         // removals, of each parent's existing dependent set). The ancestor count limits are unmodified (as</span>
<span id="L995"><span class="lineNum">     995</span>                 :             :         // the ancestor limits should be the same for both our new transaction and any conflicts).</span>
<span id="L996"><span class="lineNum">     996</span>                 :             :         // We don't bother incrementing m_limit_descendants by the full removal count as that limit never comes</span>
<span id="L997"><span class="lineNum">     997</span>                 :             :         // into force here (as we're only adding a single transaction).</span>
<span id="L998"><span class="lineNum">     998</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 156392 times"> + </span>]:<span class="tlaGNC">      156392 :         assert(ws.m_iters_conflicting.size() == 1);</span></span>
<span id="L999"><span class="lineNum">     999</span>                 :<span class="tlaGNC">      156392 :         CTxMemPool::txiter conflict = *ws.m_iters_conflicting.begin();</span></span>
<span id="L1000"><span class="lineNum">    1000</span>                 :             : </span>
<span id="L1001"><span class="lineNum">    1001</span>                 :<span class="tlaGNC">      156392 :         maybe_rbf_limits.descendant_count += 1;</span></span>
<span id="L1002"><span class="lineNum">    1002</span>                 :<span class="tlaGNC">      156392 :         maybe_rbf_limits.descendant_size_vbytes += conflict-&gt;GetSizeWithDescendants();</span></span>
<span id="L1003"><span class="lineNum">    1003</span>                 :             :     }</span>
<span id="L1004"><span class="lineNum">    1004</span>                 :             : </span>
<span id="L1005"><span class="lineNum">    1005</span>   [<span class="tlaGBC" title="Branch 0 was taken 876450 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 819893 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 56557 times"> + </span>]:<span class="tlaGNC">      876450 :     if (auto ancestors{m_subpackage.m_changeset-&gt;CalculateMemPoolAncestors(ws.m_tx_handle, maybe_rbf_limits)}) {</span></span>
<span id="L1006"><span class="lineNum">    1006</span>                 :<span class="tlaGNC">      819893 :         ws.m_ancestors = std::move(*ancestors);</span></span>
<span id="L1007"><span class="lineNum">    1007</span>                 :             :     } else {</span>
<span id="L1008"><span class="lineNum">    1008</span>                 :             :         // If CalculateMemPoolAncestors fails second time, we want the original error string.</span>
<span id="L1009"><span class="lineNum">    1009</span>         [<span class="tlaGBC" title="Branch 0 was taken 56557 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       56557 :         const auto error_message{util::ErrorString(ancestors).original};</span></span>
<span id="L1010"><span class="lineNum">    1010</span>                 :             : </span>
<span id="L1011"><span class="lineNum">    1011</span>                 :             :         // Carve-out is not allowed in this context; fail</span>
<span id="L1012"><span class="lineNum">    1012</span>         [<span class="tlaGBC" title="Branch 0 was taken 11079 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 45478 times"> + </span>]:<span class="tlaGNC">       56557 :         if (!args.m_allow_carveouts) {</span></span>
<span id="L1013"><span class="lineNum">    1013</span>   [<span class="tlaGBC" title="Branch 0 was taken 11079 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 11079 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">       11079 :             return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, &quot;too-long-mempool-chain&quot;, error_message);</span></span>
<span id="L1014"><span class="lineNum">    1014</span>                 :             :         }</span>
<span id="L1015"><span class="lineNum">    1015</span>                 :             : </span>
<span id="L1016"><span class="lineNum">    1016</span>                 :             :         // Contracting/payment channels CPFP carve-out:</span>
<span id="L1017"><span class="lineNum">    1017</span>                 :             :         // If the new transaction is relatively small (up to 40k weight)</span>
<span id="L1018"><span class="lineNum">    1018</span>                 :             :         // and has at most one ancestor (ie ancestor limit of 2, including</span>
<span id="L1019"><span class="lineNum">    1019</span>                 :             :         // the new transaction), allow it if its parent has exactly the</span>
<span id="L1020"><span class="lineNum">    1020</span>                 :             :         // descendant limit descendants. The transaction also cannot be TRUC,</span>
<span id="L1021"><span class="lineNum">    1021</span>                 :             :         // as its topology restrictions do not allow a second child.</span>
<span id="L1022"><span class="lineNum">    1022</span>                 :             :         //</span>
<span id="L1023"><span class="lineNum">    1023</span>                 :             :         // This allows protocols which rely on distrusting counterparties</span>
<span id="L1024"><span class="lineNum">    1024</span>                 :             :         // being able to broadcast descendants of an unconfirmed transaction</span>
<span id="L1025"><span class="lineNum">    1025</span>                 :             :         // to be secure by simply only having two immediately-spendable</span>
<span id="L1026"><span class="lineNum">    1026</span>                 :             :         // outputs - one for each counterparty. For more info on the uses for</span>
<span id="L1027"><span class="lineNum">    1027</span>                 :             :         // this, see https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2018-November/016518.html</span>
<span id="L1028"><span class="lineNum">    1028</span>                 :<span class="tlaGNC">       45478 :         CTxMemPool::Limits cpfp_carve_out_limits{</span></span>
<span id="L1029"><span class="lineNum">    1029</span>                 :             :             .ancestor_count = 2,</span>
<span id="L1030"><span class="lineNum">    1030</span>                 :<span class="tlaGNC">       45478 :             .ancestor_size_vbytes = maybe_rbf_limits.ancestor_size_vbytes,</span></span>
<span id="L1031"><span class="lineNum">    1031</span>                 :<span class="tlaGNC">       45478 :             .descendant_count = maybe_rbf_limits.descendant_count + 1,</span></span>
<span id="L1032"><span class="lineNum">    1032</span>                 :<span class="tlaGNC">       45478 :             .descendant_size_vbytes = maybe_rbf_limits.descendant_size_vbytes + EXTRA_DESCENDANT_TX_SIZE_LIMIT,</span></span>
<span id="L1033"><span class="lineNum">    1033</span>                 :<span class="tlaGNC">       45478 :         };</span></span>
<span id="L1034"><span class="lineNum">    1034</span>   [<span class="tlaGBC" title="Branch 0 was taken 42010 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 3468 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 33505 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 8505 times"> + </span>]:<span class="tlaGNC">       45478 :         if (ws.m_vsize &gt; EXTRA_DESCENDANT_TX_SIZE_LIMIT || ws.m_ptx-&gt;version == TRUC_VERSION) {</span></span>
<span id="L1035"><span class="lineNum">    1035</span>   [<span class="tlaGBC" title="Branch 0 was taken 11973 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 11973 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">       11973 :             return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, &quot;too-long-mempool-chain&quot;, error_message);</span></span>
<span id="L1036"><span class="lineNum">    1036</span>                 :             :         }</span>
<span id="L1037"><span class="lineNum">    1037</span>   [<span class="tlaGBC" title="Branch 0 was taken 33505 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 25530 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 7975 times"> + </span>]:<span class="tlaGNC">       33505 :         if (auto ancestors_retry{m_subpackage.m_changeset-&gt;CalculateMemPoolAncestors(ws.m_tx_handle, cpfp_carve_out_limits)}) {</span></span>
<span id="L1038"><span class="lineNum">    1038</span>                 :<span class="tlaGNC">       25530 :             ws.m_ancestors = std::move(*ancestors_retry);</span></span>
<span id="L1039"><span class="lineNum">    1039</span>                 :             :         } else {</span>
<span id="L1040"><span class="lineNum">    1040</span>   [<span class="tlaGBC" title="Branch 0 was taken 7975 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 7975 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">        7975 :             return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, &quot;too-long-mempool-chain&quot;, error_message);</span></span>
<span id="L1041"><span class="lineNum">    1041</span>                 :<span class="tlaGNC">       33505 :         }</span></span>
<span id="L1042"><span class="lineNum">    1042</span>                 :<span class="tlaGNC">       56557 :     }</span></span>
<span id="L1043"><span class="lineNum">    1043</span>                 :             : </span>
<span id="L1044"><span class="lineNum">    1044</span>                 :             :     // Even though just checking direct mempool parents for inheritance would be sufficient, we</span>
<span id="L1045"><span class="lineNum">    1045</span>                 :             :     // check using the full ancestor set here because it's more convenient to use what we have</span>
<span id="L1046"><span class="lineNum">    1046</span>                 :             :     // already calculated.</span>
<span id="L1047"><span class="lineNum">    1047</span>   [<span class="tlaGBC" title="Branch 0 was taken 845423 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 47264 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 798159 times"> + </span>]:<span class="tlaGNC">      845423 :     if (const auto err{SingleTRUCChecks(ws.m_ptx, ws.m_ancestors, ws.m_conflicts, ws.m_vsize)}) {</span></span>
<span id="L1048"><span class="lineNum">    1048</span>                 :             :         // Single transaction contexts only.</span>
<span id="L1049"><span class="lineNum">    1049</span>   [<span class="tlaGBC" title="Branch 0 was taken 37455 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 9809 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 31118 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 6337 times"> + </span>]:<span class="tlaGNC">       47264 :         if (args.m_allow_sibling_eviction &amp;&amp; err-&gt;second != nullptr) {</span></span>
<span id="L1050"><span class="lineNum">    1050</span>                 :             :             // We should only be considering where replacement is considered valid as well.</span>
<span id="L1051"><span class="lineNum">    1051</span>         [<span class="tlaGBC" title="Branch 0 was taken 6337 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        6337 :             Assume(args.m_allow_replacement);</span></span>
<span id="L1052"><span class="lineNum">    1052</span>                 :             : </span>
<span id="L1053"><span class="lineNum">    1053</span>                 :             :             // Potential sibling eviction. Add the sibling to our list of mempool conflicts to be</span>
<span id="L1054"><span class="lineNum">    1054</span>                 :             :             // included in RBF checks.</span>
<span id="L1055"><span class="lineNum">    1055</span>         [<span class="tlaGBC" title="Branch 0 was taken 6337 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        6337 :             ws.m_conflicts.insert(err-&gt;second-&gt;GetHash());</span></span>
<span id="L1056"><span class="lineNum">    1056</span>                 :             :             // Adding the sibling to m_iters_conflicting here means that it doesn't count towards</span>
<span id="L1057"><span class="lineNum">    1057</span>                 :             :             // RBF Carve Out above. This is correct, since removing to-be-replaced transactions from</span>
<span id="L1058"><span class="lineNum">    1058</span>                 :             :             // the descendant count is done separately in SingleTRUCChecks for TRUC transactions.</span>
<span id="L1059"><span class="lineNum">    1059</span>   [<span class="tlaGBC" title="Branch 0 was taken 6337 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 6337 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">       12674 :             ws.m_iters_conflicting.insert(m_pool.GetIter(err-&gt;second-&gt;GetHash()).value());</span></span>
<span id="L1060"><span class="lineNum">    1060</span>                 :<span class="tlaGNC">        6337 :             ws.m_sibling_eviction = true;</span></span>
<span id="L1061"><span class="lineNum">    1061</span>                 :             :             // The sibling will be treated as part of the to-be-replaced set in ReplacementChecks.</span>
<span id="L1062"><span class="lineNum">    1062</span>                 :             :             // Note that we are not checking whether it opts in to replaceability via BIP125 or TRUC</span>
<span id="L1063"><span class="lineNum">    1063</span>                 :             :             // (which is normally done in PreChecks). However, the only way a TRUC transaction can</span>
<span id="L1064"><span class="lineNum">    1064</span>                 :             :             // have a non-TRUC and non-BIP125 descendant is due to a reorg.</span>
<span id="L1065"><span class="lineNum">    1065</span>                 :             :         } else {</span>
<span id="L1066"><span class="lineNum">    1066</span>   [<span class="tlaGBC" title="Branch 0 was taken 40927 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 40927 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">       40927 :             return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, &quot;TRUC-violation&quot;, err-&gt;first);</span></span>
<span id="L1067"><span class="lineNum">    1067</span>                 :             :         }</span>
<span id="L1068"><span class="lineNum">    1068</span>                 :<span class="tlaGNC">       40927 :     }</span></span>
<span id="L1069"><span class="lineNum">    1069</span>                 :             : </span>
<span id="L1070"><span class="lineNum">    1070</span>                 :             :     // A transaction that spends outputs that would be replaced by it is invalid. Now</span>
<span id="L1071"><span class="lineNum">    1071</span>                 :             :     // that we have the set of all ancestors we can detect this</span>
<span id="L1072"><span class="lineNum">    1072</span>                 :             :     // pathological case by making sure ws.m_conflicts and ws.m_ancestors don't</span>
<span id="L1073"><span class="lineNum">    1073</span>                 :             :     // intersect.</span>
<span id="L1074"><span class="lineNum">    1074</span>   [<span class="tlaGBC" title="Branch 0 was taken 804496 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 14999 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 789497 times"> + </span>]:<span class="tlaGNC">      804496 :     if (const auto err_string{EntriesAndTxidsDisjoint(ws.m_ancestors, ws.m_conflicts, hash)}) {</span></span>
<span id="L1075"><span class="lineNum">    1075</span>                 :             :         // We classify this as a consensus error because a transaction depending on something it</span>
<span id="L1076"><span class="lineNum">    1076</span>                 :             :         // conflicts with would be inconsistent.</span>
<span id="L1077"><span class="lineNum">    1077</span>   [<span class="tlaGBC" title="Branch 0 was taken 14999 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 14999 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">       14999 :         return state.Invalid(TxValidationResult::TX_CONSENSUS, &quot;bad-txns-spends-conflicting-tx&quot;, *err_string);</span></span>
<span id="L1078"><span class="lineNum">    1078</span>                 :<span class="tlaGNC">       14999 :     }</span></span>
<span id="L1079"><span class="lineNum">    1079</span>                 :             : </span>
<span id="L1080"><span class="lineNum">    1080</span>                 :             :     // We want to detect conflicts in any tx in a package to trigger package RBF logic</span>
<span id="L1081"><span class="lineNum">    1081</span>                 :<span class="tlaGNC">      789497 :     m_subpackage.m_rbf |= !ws.m_conflicts.empty();</span></span>
<span id="L1082"><span class="lineNum">    1082</span>                 :<span class="tlaGNC">      789497 :     return true;</span></span>
<span id="L1083"><span class="lineNum">    1083</span>                 :<span class="tlaGNC">     2258179 : }</span></span>
<span id="L1084"><span class="lineNum">    1084</span>                 :             : </span>
<span id="L1085"><span class="lineNum">    1085</span>                 :<span class="tlaGNC">      307587 : bool MemPoolAccept::ReplacementChecks(Workspace&amp; ws)</span></span>
<span id="L1086"><span class="lineNum">    1086</span>                 :             : {</span>
<span id="L1087"><span class="lineNum">    1087</span>                 :<span class="tlaGNC">      307587 :     AssertLockHeld(cs_main);</span></span>
<span id="L1088"><span class="lineNum">    1088</span>                 :<span class="tlaGNC">      307587 :     AssertLockHeld(m_pool.cs);</span></span>
<span id="L1089"><span class="lineNum">    1089</span>                 :             : </span>
<span id="L1090"><span class="lineNum">    1090</span>                 :<span class="tlaGNC">      307587 :     const CTransaction&amp; tx = *ws.m_ptx;</span></span>
<span id="L1091"><span class="lineNum">    1091</span>                 :<span class="tlaGNC">      307587 :     const Txid&amp; hash = ws.m_hash;</span></span>
<span id="L1092"><span class="lineNum">    1092</span>                 :<span class="tlaGNC">      307587 :     TxValidationState&amp; state = ws.m_state;</span></span>
<span id="L1093"><span class="lineNum">    1093</span>                 :             : </span>
<span id="L1094"><span class="lineNum">    1094</span>                 :<span class="tlaGNC">      307587 :     CFeeRate newFeeRate(ws.m_modified_fees, ws.m_vsize);</span></span>
<span id="L1095"><span class="lineNum">    1095</span>                 :             :     // Enforce Rule #6. The replacement transaction must have a higher feerate than its direct conflicts.</span>
<span id="L1096"><span class="lineNum">    1096</span>                 :             :     // - The motivation for this check is to ensure that the replacement transaction is preferable for</span>
<span id="L1097"><span class="lineNum">    1097</span>                 :             :     //   block-inclusion, compared to what would be removed from the mempool.</span>
<span id="L1098"><span class="lineNum">    1098</span>                 :             :     // - This logic predates ancestor feerate-based transaction selection, which is why it doesn't</span>
<span id="L1099"><span class="lineNum">    1099</span>                 :             :     //   consider feerates of descendants.</span>
<span id="L1100"><span class="lineNum">    1100</span>                 :             :     // - Note: Ancestor feerate-based transaction selection has made this comparison insufficient to</span>
<span id="L1101"><span class="lineNum">    1101</span>                 :             :     //   guarantee that this is incentive-compatible for miners, because it is possible for a</span>
<span id="L1102"><span class="lineNum">    1102</span>                 :             :     //   descendant transaction of a direct conflict to pay a higher feerate than the transaction that</span>
<span id="L1103"><span class="lineNum">    1103</span>                 :             :     //   might replace them, under these rules.</span>
<span id="L1104"><span class="lineNum">    1104</span>         [<span class="tlaGBC" title="Branch 0 was taken 227159 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 80428 times"> + </span>]:<span class="tlaGNC">      307587 :     if (const auto err_string{PaysMoreThanConflicts(ws.m_iters_conflicting, newFeeRate, hash)}) {</span></span>
<span id="L1105"><span class="lineNum">    1105</span>                 :             :         // This fee-related failure is TX_RECONSIDERABLE because validating in a package may change</span>
<span id="L1106"><span class="lineNum">    1106</span>                 :             :         // the result.</span>
<span id="L1107"><span class="lineNum">    1107</span>   [<span class="tlaGBC" title="Branch 0 was taken 224221 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 2938 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 227159 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      454318 :         return state.Invalid(TxValidationResult::TX_RECONSIDERABLE,</span></span>
<span id="L1108"><span class="lineNum">    1108</span>   [<span class="tlaGBC" title="Branch 0 was taken 224221 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 2938 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 227159 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      678539 :                              strprintf(&quot;insufficient fee%s&quot;, ws.m_sibling_eviction ? &quot; (including sibling eviction)&quot; : &quot;&quot;), *err_string);</span></span>
<span id="L1109"><span class="lineNum">    1109</span>                 :<span class="tlaGNC">      227159 :     }</span></span>
<span id="L1110"><span class="lineNum">    1110</span>                 :             : </span>
<span id="L1111"><span class="lineNum">    1111</span>         [<span class="tlaGBC" title="Branch 0 was taken 80428 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       80428 :     CTxMemPool::setEntries all_conflicts;</span></span>
<span id="L1112"><span class="lineNum">    1112</span>                 :             : </span>
<span id="L1113"><span class="lineNum">    1113</span>                 :             :     // Calculate all conflicting entries and enforce Rule #5.</span>
<span id="L1114"><span class="lineNum">    1114</span>   [<span class="tlaGBC" title="Branch 0 was taken 80428 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 80428 times"> + </span>]:<span class="tlaGNC">       80428 :     if (const auto err_string{GetEntriesForConflicts(tx, m_pool, ws.m_iters_conflicting, all_conflicts)}) {</span></span>
<span id="L1115"><span class="lineNum">    1115</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY,</span></span>
<span id="L1116"><span class="lineNum">    1116</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                              strprintf(&quot;too many potential replacements%s&quot;, ws.m_sibling_eviction ? &quot; (including sibling eviction)&quot; : &quot;&quot;), *err_string);</span></span>
<span id="L1117"><span class="lineNum">    1117</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L1118"><span class="lineNum">    1118</span>                 :             :     // Enforce Rule #2.</span>
<span id="L1119"><span class="lineNum">    1119</span>   [<span class="tlaGBC" title="Branch 0 was taken 80428 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 15775 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 64653 times"> + </span>]:<span class="tlaGNC">       80428 :     if (const auto err_string{HasNoNewUnconfirmed(tx, m_pool, all_conflicts)}) {</span></span>
<span id="L1120"><span class="lineNum">    1120</span>                 :             :         // Sibling eviction is only done for TRUC transactions, which cannot have multiple ancestors.</span>
<span id="L1121"><span class="lineNum">    1121</span>         [<span class="tlaGBC" title="Branch 0 was taken 15775 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       15775 :         Assume(!ws.m_sibling_eviction);</span></span>
<span id="L1122"><span class="lineNum">    1122</span>   [<span class="tlaGBC" title="Branch 0 was taken 15775 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 15775 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">       31550 :         return state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY,</span></span>
<span id="L1123"><span class="lineNum">    1123</span>   [<span class="tlaGBC" title="Branch 0 was taken 15775 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 15775 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">       47325 :                              strprintf(&quot;replacement-adds-unconfirmed%s&quot;, ws.m_sibling_eviction ? &quot; (including sibling eviction)&quot; : &quot;&quot;), *err_string);</span></span>
<span id="L1124"><span class="lineNum">    1124</span>                 :<span class="tlaGNC">       15775 :     }</span></span>
<span id="L1125"><span class="lineNum">    1125</span>                 :             : </span>
<span id="L1126"><span class="lineNum">    1126</span>                 :             :     // Check if it's economically rational to mine this transaction rather than the ones it</span>
<span id="L1127"><span class="lineNum">    1127</span>                 :             :     // replaces and pays for its own relay fees. Enforce Rules #3 and #4.</span>
<span id="L1128"><span class="lineNum">    1128</span>         [<span class="tlaGBC" title="Branch 0 was taken 135301 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 64653 times"> + </span>]:<span class="tlaGNC">      199954 :     for (CTxMemPool::txiter it : all_conflicts) {</span></span>
<span id="L1129"><span class="lineNum">    1129</span>         [<span class="tlaGBC" title="Branch 0 was taken 135301 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      135301 :         m_subpackage.m_conflicting_fees += it-&gt;GetModifiedFee();</span></span>
<span id="L1130"><span class="lineNum">    1130</span>         [<span class="tlaGBC" title="Branch 0 was taken 135301 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      135301 :         m_subpackage.m_conflicting_size += it-&gt;GetTxSize();</span></span>
<span id="L1131"><span class="lineNum">    1131</span>                 :             :     }</span>
<span id="L1132"><span class="lineNum">    1132</span>                 :<span class="tlaGNC">      129306 :     if (const auto err_string{PaysForRBF(m_subpackage.m_conflicting_fees, ws.m_modified_fees, ws.m_vsize,</span></span>
<span id="L1133"><span class="lineNum">    1133</span>   [<span class="tlaGBC" title="Branch 0 was taken 64653 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 35239 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 29414 times"> + </span>]:<span class="tlaGNC">       64653 :                                          m_pool.m_opts.incremental_relay_feerate, hash)}) {</span></span>
<span id="L1134"><span class="lineNum">    1134</span>                 :             :         // Result may change in a package context</span>
<span id="L1135"><span class="lineNum">    1135</span>   [<span class="tlaGBC" title="Branch 0 was taken 35090 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 149 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 35239 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">       70478 :         return state.Invalid(TxValidationResult::TX_RECONSIDERABLE,</span></span>
<span id="L1136"><span class="lineNum">    1136</span>   [<span class="tlaGBC" title="Branch 0 was taken 35090 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 149 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 35239 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      105568 :                              strprintf(&quot;insufficient fee%s&quot;, ws.m_sibling_eviction ? &quot; (including sibling eviction)&quot; : &quot;&quot;), *err_string);</span></span>
<span id="L1137"><span class="lineNum">    1137</span>                 :<span class="tlaGNC">       35239 :     }</span></span>
<span id="L1138"><span class="lineNum">    1138</span>                 :             : </span>
<span id="L1139"><span class="lineNum">    1139</span>                 :             :     // Add all the to-be-removed transactions to the changeset.</span>
<span id="L1140"><span class="lineNum">    1140</span>         [<span class="tlaGBC" title="Branch 0 was taken 38849 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 29414 times"> + </span>]:<span class="tlaGNC">       68263 :     for (auto it : all_conflicts) {</span></span>
<span id="L1141"><span class="lineNum">    1141</span>         [<span class="tlaGBC" title="Branch 0 was taken 38849 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       38849 :         m_subpackage.m_changeset-&gt;StageRemoval(it);</span></span>
<span id="L1142"><span class="lineNum">    1142</span>                 :             :     }</span>
<span id="L1143"><span class="lineNum">    1143</span>                 :             :     return true;</span>
<span id="L1144"><span class="lineNum">    1144</span>                 :<span class="tlaGNC">       80428 : }</span></span>
<span id="L1145"><span class="lineNum">    1145</span>                 :             : </span>
<span id="L1146"><span class="lineNum">    1146</span>                 :<span class="tlaGNC">       54573 : bool MemPoolAccept::PackageMempoolChecks(const std::vector&lt;CTransactionRef&gt;&amp; txns,</span></span>
<span id="L1147"><span class="lineNum">    1147</span>                 :             :                                          std::vector&lt;Workspace&gt;&amp; workspaces,</span>
<span id="L1148"><span class="lineNum">    1148</span>                 :             :                                          const int64_t total_vsize,</span>
<span id="L1149"><span class="lineNum">    1149</span>                 :             :                                          PackageValidationState&amp; package_state)</span>
<span id="L1150"><span class="lineNum">    1150</span>                 :             : {</span>
<span id="L1151"><span class="lineNum">    1151</span>                 :<span class="tlaGNC">       54573 :     AssertLockHeld(cs_main);</span></span>
<span id="L1152"><span class="lineNum">    1152</span>                 :<span class="tlaGNC">       54573 :     AssertLockHeld(m_pool.cs);</span></span>
<span id="L1153"><span class="lineNum">    1153</span>                 :             : </span>
<span id="L1154"><span class="lineNum">    1154</span>                 :             :     // CheckPackageLimits expects the package transactions to not already be in the mempool.</span>
<span id="L1155"><span class="lineNum">    1155</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 54573 times"> + </span>]:<span class="tlaGNC">      174692 :     assert(std::all_of(txns.cbegin(), txns.cend(), [this](const auto&amp; tx) { return !m_pool.exists(tx-&gt;GetHash()); }));</span></span>
<span id="L1156"><span class="lineNum">    1156</span>                 :             : </span>
<span id="L1157"><span class="lineNum">    1157</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 54573 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 54573 times"> + </span> :<span class="tlaGNC">       54573 :     assert(txns.size() == workspaces.size());</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaGBC" title="Branch 5 was taken 54573 times"> + </span>]
<span id="L1158"><span class="lineNum">    1158</span>                 :             : </span>
<span id="L1159"><span class="lineNum">    1159</span>                 :<span class="tlaGNC">       54573 :     auto result = m_pool.CheckPackageLimits(txns, total_vsize);</span></span>
<span id="L1160"><span class="lineNum">    1160</span>         [<span class="tlaGBC" title="Branch 0 was taken 3181 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 51392 times"> + </span>]:<span class="tlaGNC">       54573 :     if (!result) {</span></span>
<span id="L1161"><span class="lineNum">    1161</span>                 :             :         // This is a package-wide error, separate from an individual transaction error.</span>
<span id="L1162"><span class="lineNum">    1162</span>   [<span class="tlaGBC" title="Branch 0 was taken 3181 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 3181 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">        6362 :         return package_state.Invalid(PackageValidationResult::PCKG_POLICY, &quot;package-mempool-limits&quot;, util::ErrorString(result).original);</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 3181 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L1163"><span class="lineNum">    1163</span>                 :             :     }</span>
<span id="L1164"><span class="lineNum">    1164</span>                 :             : </span>
<span id="L1165"><span class="lineNum">    1165</span>                 :             :     // No conflicts means we're finished. Further checks are all RBF-only.</span>
<span id="L1166"><span class="lineNum">    1166</span>         [<span class="tlaGBC" title="Branch 0 was taken 49773 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 1619 times"> + </span>]:<span class="tlaGNC">       51392 :     if (!m_subpackage.m_rbf) return true;</span></span>
<span id="L1167"><span class="lineNum">    1167</span>                 :             : </span>
<span id="L1168"><span class="lineNum">    1168</span>                 :             :     // We're in package RBF context; replacement proposal must be size 2</span>
<span id="L1169"><span class="lineNum">    1169</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 49773 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 44085 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 5688 times"> + </span> :<span class="tlaGNC">       49773 :     if (workspaces.size() != 2 || !Assume(IsChildWithParents(txns))) {</span></span>
<span class="lineNum">        </span> <span class="tlaGBC" title="Branch 4 was taken 44085 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaGBC" title="Branch 6 was taken 44085 times"> + </span><span class="tlaUNC" title="Branch 7 was not taken"> - </span><span class="tlaUNC" title="Branch 8 was not taken"> - </span> 
<span class="lineNum">        </span>             <span class="tlaGBC" title="Branch 9 was taken 44085 times"> + </span>]
<span id="L1170"><span class="lineNum">    1170</span>   [<span class="tlaGBC" title="Branch 0 was taken 5688 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 5688 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">        5688 :         return package_state.Invalid(PackageValidationResult::PCKG_POLICY, &quot;package RBF failed: package must be 1-parent-1-child&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 5688 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L1171"><span class="lineNum">    1171</span>                 :             :     }</span>
<span id="L1172"><span class="lineNum">    1172</span>                 :             : </span>
<span id="L1173"><span class="lineNum">    1173</span>                 :             :     // If the package has in-mempool ancestors, we won't consider a package RBF</span>
<span id="L1174"><span class="lineNum">    1174</span>                 :             :     // since it would result in a cluster larger than 2.</span>
<span id="L1175"><span class="lineNum">    1175</span>                 :             :     // N.B. To relax this constraint we will need to revisit how CCoinsViewMemPool::PackageAddTransaction</span>
<span id="L1176"><span class="lineNum">    1176</span>                 :             :     // is being used inside AcceptMultipleTransactions to track available inputs while processing a package.</span>
<span id="L1177"><span class="lineNum">    1177</span>         [<span class="tlaGBC" title="Branch 0 was taken 76061 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 28176 times"> + </span>]:<span class="tlaGNC">      104237 :     for (const auto&amp; ws : workspaces) {</span></span>
<span id="L1178"><span class="lineNum">    1178</span>         [<span class="tlaGBC" title="Branch 0 was taken 15909 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 60152 times"> + </span>]:<span class="tlaGNC">       76061 :         if (!ws.m_ancestors.empty()) {</span></span>
<span id="L1179"><span class="lineNum">    1179</span>   [<span class="tlaGBC" title="Branch 0 was taken 15909 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 15909 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">       15909 :             return package_state.Invalid(PackageValidationResult::PCKG_POLICY, &quot;package RBF failed: new transaction cannot have mempool ancestors&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 15909 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L1180"><span class="lineNum">    1180</span>                 :             :         }</span>
<span id="L1181"><span class="lineNum">    1181</span>                 :             :     }</span>
<span id="L1182"><span class="lineNum">    1182</span>                 :             : </span>
<span id="L1183"><span class="lineNum">    1183</span>                 :             :     // Aggregate all conflicts into one set.</span>
<span id="L1184"><span class="lineNum">    1184</span>                 :<span class="tlaGNC">       28176 :     CTxMemPool::setEntries direct_conflict_iters;</span></span>
<span id="L1185"><span class="lineNum">    1185</span>         [<span class="tlaGBC" title="Branch 0 was taken 56352 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 28176 times"> + </span>]:<span class="tlaGNC">       84528 :     for (Workspace&amp; ws : workspaces) {</span></span>
<span id="L1186"><span class="lineNum">    1186</span>                 :             :         // Aggregate all conflicts into one set.</span>
<span id="L1187"><span class="lineNum">    1187</span>                 :<span class="tlaGNC">       56352 :         direct_conflict_iters.merge(ws.m_iters_conflicting);</span></span>
<span id="L1188"><span class="lineNum">    1188</span>                 :             :     }</span>
<span id="L1189"><span class="lineNum">    1189</span>                 :             : </span>
<span id="L1190"><span class="lineNum">    1190</span>         [<span class="tlaGBC" title="Branch 0 was taken 28176 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       28176 :     const auto&amp; parent_ws = workspaces[0];</span></span>
<span id="L1191"><span class="lineNum">    1191</span>                 :<span class="tlaGNC">       28176 :     const auto&amp; child_ws = workspaces[1];</span></span>
<span id="L1192"><span class="lineNum">    1192</span>                 :             : </span>
<span id="L1193"><span class="lineNum">    1193</span>                 :             :     // Don't consider replacements that would cause us to remove a large number of mempool entries.</span>
<span id="L1194"><span class="lineNum">    1194</span>                 :             :     // This limit is not increased in a package RBF. Use the aggregate number of transactions.</span>
<span id="L1195"><span class="lineNum">    1195</span>         [<span class="tlaGBC" title="Branch 0 was taken 28176 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       28176 :     CTxMemPool::setEntries all_conflicts;</span></span>
<span id="L1196"><span class="lineNum">    1196</span>                 :<span class="tlaGNC">       56352 :     if (const auto err_string{GetEntriesForConflicts(*child_ws.m_ptx, m_pool, direct_conflict_iters,</span></span>
<span id="L1197"><span class="lineNum">    1197</span>   [<span class="tlaGBC" title="Branch 0 was taken 28176 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 28176 times"> + </span>]:<span class="tlaGNC">       28176 :                                                      all_conflicts)}) {</span></span>
<span id="L1198"><span class="lineNum">    1198</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         return package_state.Invalid(PackageValidationResult::PCKG_POLICY,</span></span>
<span id="L1199"><span class="lineNum">    1199</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                                      &quot;package RBF failed: too many potential replacements&quot;, *err_string);</span></span>
<span id="L1200"><span class="lineNum">    1200</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L1201"><span class="lineNum">    1201</span>                 :             : </span>
<span id="L1202"><span class="lineNum">    1202</span>                 :             : </span>
<span id="L1203"><span class="lineNum">    1203</span>         [<span class="tlaGBC" title="Branch 0 was taken 87602 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 28176 times"> + </span>]:<span class="tlaGNC">      115778 :     for (CTxMemPool::txiter it : all_conflicts) {</span></span>
<span id="L1204"><span class="lineNum">    1204</span>         [<span class="tlaGBC" title="Branch 0 was taken 87602 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       87602 :         m_subpackage.m_changeset-&gt;StageRemoval(it);</span></span>
<span id="L1205"><span class="lineNum">    1205</span>         [<span class="tlaGBC" title="Branch 0 was taken 87602 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       87602 :         m_subpackage.m_conflicting_fees += it-&gt;GetModifiedFee();</span></span>
<span id="L1206"><span class="lineNum">    1206</span>         [<span class="tlaGBC" title="Branch 0 was taken 87602 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       87602 :         m_subpackage.m_conflicting_size += it-&gt;GetTxSize();</span></span>
<span id="L1207"><span class="lineNum">    1207</span>                 :             :     }</span>
<span id="L1208"><span class="lineNum">    1208</span>                 :             : </span>
<span id="L1209"><span class="lineNum">    1209</span>                 :             :     // Use the child as the transaction for attributing errors to.</span>
<span id="L1210"><span class="lineNum">    1210</span>         [<span class="tlaGBC" title="Branch 0 was taken 28176 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       28176 :     const Txid&amp; child_hash = child_ws.m_ptx-&gt;GetHash();</span></span>
<span id="L1211"><span class="lineNum">    1211</span>                 :<span class="tlaGNC">       56352 :     if (const auto err_string{PaysForRBF(/*original_fees=*/m_subpackage.m_conflicting_fees,</span></span>
<span id="L1212"><span class="lineNum">    1212</span>                 :             :                                          /*replacement_fees=*/m_subpackage.m_total_modified_fees,</span>
<span id="L1213"><span class="lineNum">    1213</span>                 :<span class="tlaGNC">       28176 :                                          /*replacement_vsize=*/m_subpackage.m_total_vsize,</span></span>
<span id="L1214"><span class="lineNum">    1214</span>   [<span class="tlaGBC" title="Branch 0 was taken 28176 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 14004 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 14172 times"> + </span>]:<span class="tlaGNC">       28176 :                                          m_pool.m_opts.incremental_relay_feerate, child_hash)}) {</span></span>
<span id="L1215"><span class="lineNum">    1215</span>   [<span class="tlaGBC" title="Branch 0 was taken 14004 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 14004 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">       14004 :         return package_state.Invalid(PackageValidationResult::PCKG_POLICY,</span></span>
<span id="L1216"><span class="lineNum">    1216</span>         [<span class="tlaGBC" title="Branch 0 was taken 14004 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       28008 :                                      &quot;package RBF failed: insufficient anti-DoS fees&quot;, *err_string);</span></span>
<span id="L1217"><span class="lineNum">    1217</span>                 :<span class="tlaGNC">       14004 :     }</span></span>
<span id="L1218"><span class="lineNum">    1218</span>                 :             : </span>
<span id="L1219"><span class="lineNum">    1219</span>                 :             :     // Ensure this two transaction package is a &quot;chunk&quot; on its own; we don't want the child</span>
<span id="L1220"><span class="lineNum">    1220</span>                 :             :     // to be only paying anti-DoS fees</span>
<span id="L1221"><span class="lineNum">    1221</span>         [<span class="tlaGBC" title="Branch 0 was taken 14172 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       14172 :     const CFeeRate parent_feerate(parent_ws.m_modified_fees, parent_ws.m_vsize);</span></span>
<span id="L1222"><span class="lineNum">    1222</span>         [<span class="tlaGBC" title="Branch 0 was taken 14172 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       14172 :     const CFeeRate package_feerate(m_subpackage.m_total_modified_fees, m_subpackage.m_total_vsize);</span></span>
<span id="L1223"><span class="lineNum">    1223</span>         [<span class="tlaGBC" title="Branch 0 was taken 990 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 13182 times"> + </span>]:<span class="tlaGNC">       14172 :     if (package_feerate &lt;= parent_feerate) {</span></span>
<span id="L1224"><span class="lineNum">    1224</span>   [<span class="tlaGBC" title="Branch 0 was taken 990 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 990 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">        1980 :         return package_state.Invalid(PackageValidationResult::PCKG_POLICY,</span></span>
<span id="L1225"><span class="lineNum">    1225</span>         [<span class="tlaGBC" title="Branch 0 was taken 990 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        1980 :                                      &quot;package RBF failed: package feerate is less than or equal to parent feerate&quot;,</span></span>
<span id="L1226"><span class="lineNum">    1226</span>   [<span class="tlaGBC" title="Branch 0 was taken 990 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 990 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">        1980 :                                      strprintf(&quot;package feerate %s &lt;= parent feerate is %s&quot;, package_feerate.ToString(), parent_feerate.ToString()));</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 990 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L1227"><span class="lineNum">    1227</span>                 :             :     }</span>
<span id="L1228"><span class="lineNum">    1228</span>                 :             : </span>
<span id="L1229"><span class="lineNum">    1229</span>                 :             :     // Check if it's economically rational to mine this package rather than the ones it replaces.</span>
<span id="L1230"><span class="lineNum">    1230</span>                 :             :     // This takes the place of ReplacementChecks()'s PaysMoreThanConflicts() in the package RBF setting.</span>
<span id="L1231"><span class="lineNum">    1231</span>   [<span class="tlaGBC" title="Branch 0 was taken 13182 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 11955 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 1227 times"> + </span>]:<span class="tlaGNC">       13182 :     if (const auto err_tup{ImprovesFeerateDiagram(*m_subpackage.m_changeset)}) {</span></span>
<span id="L1232"><span class="lineNum">    1232</span>         [<span class="tlaGBC" title="Branch 0 was taken 11955 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       11955 :         return package_state.Invalid(PackageValidationResult::PCKG_POLICY,</span></span>
<span id="L1233"><span class="lineNum">    1233</span>   [<span class="tlaGBC" title="Branch 0 was taken 11955 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 11955 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">       35865 :                                      &quot;package RBF failed: &quot; + err_tup.value().second, &quot;&quot;);</span></span>
<span id="L1234"><span class="lineNum">    1234</span>                 :<span class="tlaGNC">       11955 :     }</span></span>
<span id="L1235"><span class="lineNum">    1235</span>                 :             : </span>
<span id="L1236"><span class="lineNum">    1236</span>   [<span class="tlaGBC" title="Branch 0 was taken 1227 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 1227 times"> + </span> :<span class="tlaGNC">        1227 :     LogDebug(BCLog::TXPACKAGES, &quot;package RBF checks passed: parent %s (wtxid=%s), child %s (wtxid=%s), package hash (%s)\n&quot;,</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaUNC" title="Branch 6 was not taken"> - </span><span class="tlaUNC" title="Branch 7 was not taken"> - </span><span class="tlaUNC" title="Branch 8 was not taken"> - </span> 
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 9 was not taken"> - </span><span class="tlaUNC" title="Branch 10 was not taken"> - </span><span class="tlaUNC" title="Branch 11 was not taken"> - </span><span class="tlaUNC" title="Branch 12 was not taken"> - </span><span class="tlaUNC" title="Branch 13 was not taken"> - </span> 
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 14 was not taken"> - </span><span class="tlaUNC" title="Branch 15 was not taken"> - </span><span class="tlaUNC" title="Branch 16 was not taken"> - </span><span class="tlaUNC" title="Branch 17 was not taken"> - </span>]
<span id="L1237"><span class="lineNum">    1237</span>                 :             :         txns.front()-&gt;GetHash().ToString(), txns.front()-&gt;GetWitnessHash().ToString(),</span>
<span id="L1238"><span class="lineNum">    1238</span>                 :             :         txns.back()-&gt;GetHash().ToString(), txns.back()-&gt;GetWitnessHash().ToString(),</span>
<span id="L1239"><span class="lineNum">    1239</span>                 :             :         GetPackageHash(txns).ToString());</span>
<span id="L1240"><span class="lineNum">    1240</span>                 :             : </span>
<span id="L1241"><span class="lineNum">    1241</span>                 :             : </span>
<span id="L1242"><span class="lineNum">    1242</span>                 :             :     return true;</span>
<span id="L1243"><span class="lineNum">    1243</span>                 :<span class="tlaGNC">       82749 : }</span></span>
<span id="L1244"><span class="lineNum">    1244</span>                 :             : </span>
<span id="L1245"><span class="lineNum">    1245</span>                 :<span class="tlaGNC">      352686 : bool MemPoolAccept::PolicyScriptChecks(const ATMPArgs&amp; args, Workspace&amp; ws)</span></span>
<span id="L1246"><span class="lineNum">    1246</span>                 :             : {</span>
<span id="L1247"><span class="lineNum">    1247</span>                 :<span class="tlaGNC">      352686 :     AssertLockHeld(cs_main);</span></span>
<span id="L1248"><span class="lineNum">    1248</span>                 :<span class="tlaGNC">      352686 :     AssertLockHeld(m_pool.cs);</span></span>
<span id="L1249"><span class="lineNum">    1249</span>                 :<span class="tlaGNC">      352686 :     const CTransaction&amp; tx = *ws.m_ptx;</span></span>
<span id="L1250"><span class="lineNum">    1250</span>                 :<span class="tlaGNC">      352686 :     TxValidationState&amp; state = ws.m_state;</span></span>
<span id="L1251"><span class="lineNum">    1251</span>                 :             : </span>
<span id="L1252"><span class="lineNum">    1252</span>                 :<span class="tlaGNC">      352686 :     constexpr unsigned int scriptVerifyFlags = STANDARD_SCRIPT_VERIFY_FLAGS;</span></span>
<span id="L1253"><span class="lineNum">    1253</span>                 :             : </span>
<span id="L1254"><span class="lineNum">    1254</span>                 :             :     // Check input scripts and signatures.</span>
<span id="L1255"><span class="lineNum">    1255</span>                 :             :     // This is done last to help prevent CPU exhaustion denial-of-service attacks.</span>
<span id="L1256"><span class="lineNum">    1256</span>         [<span class="tlaGBC" title="Branch 0 was taken 51339 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 301347 times"> + </span>]:<span class="tlaGNC">      352686 :     if (!CheckInputScripts(tx, state, m_view, scriptVerifyFlags, true, false, ws.m_precomputed_txdata, GetValidationCache())) {</span></span>
<span id="L1257"><span class="lineNum">    1257</span>                 :             :         // Detect a failure due to a missing witness so that p2p code can handle rejection caching appropriately.</span>
<span id="L1258"><span class="lineNum">    1258</span>   [<span class="tlaGBC" title="Branch 0 was taken 27735 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 23604 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 23001 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 4734 times"> + </span>]:<span class="tlaGNC">       51339 :         if (!tx.HasWitness() &amp;&amp; SpendsNonAnchorWitnessProg(tx, m_view)) {</span></span>
<span id="L1259"><span class="lineNum">    1259</span>                 :<span class="tlaGNC">       46002 :             state.Invalid(TxValidationResult::TX_WITNESS_STRIPPED,</span></span>
<span id="L1260"><span class="lineNum">    1260</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 23001 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 23001 times"> + </span> :<span class="tlaGNC">       92004 :                     state.GetRejectReason(), state.GetDebugMessage());</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 23001 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L1261"><span class="lineNum">    1261</span>                 :             :         }</span>
<span id="L1262"><span class="lineNum">    1262</span>                 :<span class="tlaGNC">       51339 :         return false; // state filled in by CheckInputScripts</span></span>
<span id="L1263"><span class="lineNum">    1263</span>                 :             :     }</span>
<span id="L1264"><span class="lineNum">    1264</span>                 :             : </span>
<span id="L1265"><span class="lineNum">    1265</span>                 :             :     return true;</span>
<span id="L1266"><span class="lineNum">    1266</span>                 :             : }</span>
<span id="L1267"><span class="lineNum">    1267</span>                 :             : </span>
<span id="L1268"><span class="lineNum">    1268</span>                 :<span class="tlaGNC">      244331 : bool MemPoolAccept::ConsensusScriptChecks(const ATMPArgs&amp; args, Workspace&amp; ws)</span></span>
<span id="L1269"><span class="lineNum">    1269</span>                 :             : {</span>
<span id="L1270"><span class="lineNum">    1270</span>                 :<span class="tlaGNC">      244331 :     AssertLockHeld(cs_main);</span></span>
<span id="L1271"><span class="lineNum">    1271</span>                 :<span class="tlaGNC">      244331 :     AssertLockHeld(m_pool.cs);</span></span>
<span id="L1272"><span class="lineNum">    1272</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 244331 times"> + </span>]:<span class="tlaGNC">      244331 :     const CTransaction&amp; tx = *ws.m_ptx;</span></span>
<span id="L1273"><span class="lineNum">    1273</span>                 :<span class="tlaGNC">      244331 :     const Txid&amp; hash = ws.m_hash;</span></span>
<span id="L1274"><span class="lineNum">    1274</span>                 :<span class="tlaGNC">      244331 :     TxValidationState&amp; state = ws.m_state;</span></span>
<span id="L1275"><span class="lineNum">    1275</span>                 :             : </span>
<span id="L1276"><span class="lineNum">    1276</span>                 :             :     // Check again against the current block tip's script verification</span>
<span id="L1277"><span class="lineNum">    1277</span>                 :             :     // flags to cache our script execution flags. This is, of course,</span>
<span id="L1278"><span class="lineNum">    1278</span>                 :             :     // useless if the next block has different script flags from the</span>
<span id="L1279"><span class="lineNum">    1279</span>                 :             :     // previous one, but because the cache tracks script flags for us it</span>
<span id="L1280"><span class="lineNum">    1280</span>                 :             :     // will auto-invalidate and we'll just have a few blocks of extra</span>
<span id="L1281"><span class="lineNum">    1281</span>                 :             :     // misses on soft-fork activation.</span>
<span id="L1282"><span class="lineNum">    1282</span>                 :             :     //</span>
<span id="L1283"><span class="lineNum">    1283</span>                 :             :     // This is also useful in case of bugs in the standard flags that cause</span>
<span id="L1284"><span class="lineNum">    1284</span>                 :             :     // transactions to pass as valid when they're actually invalid. For</span>
<span id="L1285"><span class="lineNum">    1285</span>                 :             :     // instance the STRICTENC flag was incorrectly allowing certain</span>
<span id="L1286"><span class="lineNum">    1286</span>                 :             :     // CHECKSIG NOT scripts to pass, even though they were invalid.</span>
<span id="L1287"><span class="lineNum">    1287</span>                 :             :     //</span>
<span id="L1288"><span class="lineNum">    1288</span>                 :             :     // There is a similar check in CreateNewBlock() to prevent creating</span>
<span id="L1289"><span class="lineNum">    1289</span>                 :             :     // invalid blocks (using TestBlockValidity), however allowing such</span>
<span id="L1290"><span class="lineNum">    1290</span>                 :             :     // transactions into the mempool can be exploited as a DoS attack.</span>
<span id="L1291"><span class="lineNum">    1291</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 244331 times"> + </span>]:<span class="tlaGNC">      488662 :     unsigned int currentBlockScriptVerifyFlags{GetBlockScriptFlags(*m_active_chainstate.m_chain.Tip(), m_active_chainstate.m_chainman)};</span></span>
<span id="L1292"><span class="lineNum">    1292</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 244331 times"> + </span>]:<span class="tlaGNC">      488662 :     if (!CheckInputsFromMempoolAndCache(tx, state, m_view, m_pool, currentBlockScriptVerifyFlags,</span></span>
<span id="L1293"><span class="lineNum">    1293</span>                 :<span class="tlaGNC">      244331 :                                         ws.m_precomputed_txdata, m_active_chainstate.CoinsTip(), GetValidationCache())) {</span></span>
<span id="L1294"><span class="lineNum">    1294</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LogPrintf(&quot;BUG! PLEASE REPORT THIS! CheckInputScripts failed against latest-block but not STANDARD flags %s, %s\n&quot;, hash.ToString(), state.ToString());</span></span>
<span id="L1295"><span class="lineNum">    1295</span>                 :<span class="tlaUNC">           0 :         return Assume(false);</span></span>
<span id="L1296"><span class="lineNum">    1296</span>                 :             :     }</span>
<span id="L1297"><span class="lineNum">    1297</span>                 :             : </span>
<span id="L1298"><span class="lineNum">    1298</span>                 :             :     return true;</span>
<span id="L1299"><span class="lineNum">    1299</span>                 :             : }</span>
<span id="L1300"><span class="lineNum">    1300</span>                 :             : </span>
<span id="L1301"><span class="lineNum">    1301</span>                 :<span class="tlaGNC">      234965 : void MemPoolAccept::FinalizeSubpackage(const ATMPArgs&amp; args)</span></span>
<span id="L1302"><span class="lineNum">    1302</span>                 :             : {</span>
<span id="L1303"><span class="lineNum">    1303</span>                 :<span class="tlaGNC">      234965 :     AssertLockHeld(cs_main);</span></span>
<span id="L1304"><span class="lineNum">    1304</span>                 :<span class="tlaGNC">      234965 :     AssertLockHeld(m_pool.cs);</span></span>
<span id="L1305"><span class="lineNum">    1305</span>                 :             : </span>
<span id="L1306"><span class="lineNum">    1306</span>         [<span class="tlaGBC" title="Branch 0 was taken 28915 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 206050 times"> + </span>]:<span class="tlaGNC">      234965 :     if (!m_subpackage.m_changeset-&gt;GetRemovals().empty()) Assume(args.m_allow_replacement);</span></span>
<span id="L1307"><span class="lineNum">    1307</span>                 :             :     // Remove conflicting transactions from the mempool</span>
<span id="L1308"><span class="lineNum">    1308</span>         [<span class="tlaGBC" title="Branch 0 was taken 37580 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 234965 times"> + </span>]:<span class="tlaGNC">      272545 :     for (CTxMemPool::txiter it : m_subpackage.m_changeset-&gt;GetRemovals())</span></span>
<span id="L1309"><span class="lineNum">    1309</span>                 :             :     {</span>
<span id="L1310"><span class="lineNum">    1310</span>                 :<span class="tlaGNC">       37580 :         std::string log_string = strprintf(&quot;replacing mempool tx %s (wtxid=%s, fees=%s, vsize=%s). &quot;,</span></span>
<span id="L1311"><span class="lineNum">    1311</span>         [<span class="tlaGBC" title="Branch 0 was taken 37580 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       75160 :                                       it-&gt;GetTx().GetHash().ToString(),</span></span>
<span id="L1312"><span class="lineNum">    1312</span>         [<span class="tlaGBC" title="Branch 0 was taken 37580 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       37580 :                                       it-&gt;GetTx().GetWitnessHash().ToString(),</span></span>
<span id="L1313"><span class="lineNum">    1313</span>                 :<span class="tlaGNC">       37580 :                                       it-&gt;GetFee(),</span></span>
<span id="L1314"><span class="lineNum">    1314</span>         [<span class="tlaGBC" title="Branch 0 was taken 37580 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       75160 :                                       it-&gt;GetTxSize());</span></span>
<span id="L1315"><span class="lineNum">    1315</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 37580 times"> + </span>]:<span class="tlaGNC">       37580 :         FeeFrac feerate{m_subpackage.m_total_modified_fees, int32_t(m_subpackage.m_total_vsize)};</span></span>
<span id="L1316"><span class="lineNum">    1316</span>                 :<span class="tlaGNC">       37580 :         uint256 tx_or_package_hash{};</span></span>
<span id="L1317"><span class="lineNum">    1317</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 37580 times"> + </span>]:<span class="tlaGNC">       37580 :         const bool replaced_with_tx{m_subpackage.m_changeset-&gt;GetTxCount() == 1};</span></span>
<span id="L1318"><span class="lineNum">    1318</span>         [<span class="tlaGBC" title="Branch 0 was taken 35053 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 2527 times"> + </span>]:<span class="tlaGNC">       37580 :         if (replaced_with_tx) {</span></span>
<span id="L1319"><span class="lineNum">    1319</span>         [<span class="tlaGBC" title="Branch 0 was taken 35053 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       35053 :             const CTransaction&amp; tx = m_subpackage.m_changeset-&gt;GetAddedTxn(0);</span></span>
<span id="L1320"><span class="lineNum">    1320</span>                 :<span class="tlaGNC">       35053 :             tx_or_package_hash = tx.GetHash().ToUint256();</span></span>
<span id="L1321"><span class="lineNum">    1321</span>                 :<span class="tlaGNC">       35053 :             log_string += strprintf(&quot;New tx %s (wtxid=%s, fees=%s, vsize=%s)&quot;,</span></span>
<span id="L1322"><span class="lineNum">    1322</span>         [<span class="tlaGBC" title="Branch 0 was taken 35053 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       70106 :                                     tx.GetHash().ToString(),</span></span>
<span id="L1323"><span class="lineNum">    1323</span>   [<span class="tlaGBC" title="Branch 0 was taken 35053 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 35053 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">       70106 :                                     tx.GetWitnessHash().ToString(),</span></span>
<span id="L1324"><span class="lineNum">    1324</span>                 :             :                                     feerate.fee,</span>
<span id="L1325"><span class="lineNum">    1325</span>                 :<span class="tlaGNC">       35053 :                                     feerate.size);</span></span>
<span id="L1326"><span class="lineNum">    1326</span>                 :             :         } else {</span>
<span id="L1327"><span class="lineNum">    1327</span>   [<span class="tlaGBC" title="Branch 0 was taken 2527 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 2527 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">        2527 :             tx_or_package_hash = GetPackageHash(m_subpackage.m_changeset-&gt;GetAddedTxns());</span></span>
<span id="L1328"><span class="lineNum">    1328</span>         [<span class="tlaGBC" title="Branch 0 was taken 2527 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        5054 :             log_string += strprintf(&quot;New package %s with %lu txs, fees=%s, vsize=%s&quot;,</span></span>
<span id="L1329"><span class="lineNum">    1329</span>                 :<span class="tlaGNC">        2527 :                                     tx_or_package_hash.ToString(),</span></span>
<span id="L1330"><span class="lineNum">    1330</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 2527 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 2527 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">        2527 :                                     m_subpackage.m_changeset-&gt;GetTxCount(),</span></span>
<span id="L1331"><span class="lineNum">    1331</span>                 :             :                                     feerate.fee,</span>
<span id="L1332"><span class="lineNum">    1332</span>                 :<span class="tlaGNC">        2527 :                                     feerate.size);</span></span>
<span id="L1333"><span class="lineNum">    1333</span>                 :             : </span>
<span id="L1334"><span class="lineNum">    1334</span>                 :             :         }</span>
<span id="L1335"><span class="lineNum">    1335</span>   [<span class="tlaGBC" title="Branch 0 was taken 37580 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 37580 times"> + </span> :<span class="tlaGNC">       37580 :         LogDebug(BCLog::MEMPOOL, &quot;%s\n&quot;, log_string);</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L1336"><span class="lineNum">    1336</span>                 :             :         TRACEPOINT(mempool, replaced,</span>
<span id="L1337"><span class="lineNum">    1337</span>                 :             :                 it-&gt;GetTx().GetHash().data(),</span>
<span id="L1338"><span class="lineNum">    1338</span>                 :             :                 it-&gt;GetTxSize(),</span>
<span id="L1339"><span class="lineNum">    1339</span>                 :             :                 it-&gt;GetFee(),</span>
<span id="L1340"><span class="lineNum">    1340</span>                 :             :                 std::chrono::duration_cast&lt;std::chrono::duration&lt;std::uint64_t&gt;&gt;(it-&gt;GetTime()).count(),</span>
<span id="L1341"><span class="lineNum">    1341</span>                 :             :                 tx_or_package_hash.data(),</span>
<span id="L1342"><span class="lineNum">    1342</span>                 :             :                 feerate.size,</span>
<span id="L1343"><span class="lineNum">    1343</span>                 :             :                 feerate.fee,</span>
<span id="L1344"><span class="lineNum">    1344</span>                 :             :                 replaced_with_tx</span>
<span id="L1345"><span class="lineNum">    1345</span>                 :<span class="tlaGNC">       37580 :         );</span></span>
<span id="L1346"><span class="lineNum">    1346</span>   [<span class="tlaGBC" title="Branch 0 was taken 37580 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 37580 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      112740 :         m_subpackage.m_replaced_transactions.push_back(it-&gt;GetSharedTx());</span></span>
<span id="L1347"><span class="lineNum">    1347</span>                 :<span class="tlaGNC">       37580 :     }</span></span>
<span id="L1348"><span class="lineNum">    1348</span>                 :<span class="tlaGNC">      234965 :     m_subpackage.m_changeset-&gt;Apply();</span></span>
<span id="L1349"><span class="lineNum">    1349</span>         [<span class="tlaGBC" title="Branch 0 was taken 234965 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      234965 :     m_subpackage.m_changeset.reset();</span></span>
<span id="L1350"><span class="lineNum">    1350</span>                 :<span class="tlaGNC">      234965 : }</span></span>
<span id="L1351"><span class="lineNum">    1351</span>                 :             : </span>
<span id="L1352"><span class="lineNum">    1352</span>                 :<span class="tlaGNC">        2845 : bool MemPoolAccept::SubmitPackage(const ATMPArgs&amp; args, std::vector&lt;Workspace&gt;&amp; workspaces,</span></span>
<span id="L1353"><span class="lineNum">    1353</span>                 :             :                                   PackageValidationState&amp; package_state,</span>
<span id="L1354"><span class="lineNum">    1354</span>                 :             :                                   std::map&lt;Wtxid, MempoolAcceptResult&gt;&amp; results)</span>
<span id="L1355"><span class="lineNum">    1355</span>                 :             : {</span>
<span id="L1356"><span class="lineNum">    1356</span>                 :<span class="tlaGNC">        2845 :     AssertLockHeld(cs_main);</span></span>
<span id="L1357"><span class="lineNum">    1357</span>                 :<span class="tlaGNC">        2845 :     AssertLockHeld(m_pool.cs);</span></span>
<span id="L1358"><span class="lineNum">    1358</span>                 :             :     // Sanity check: none of the transactions should be in the mempool, and none of the transactions</span>
<span id="L1359"><span class="lineNum">    1359</span>                 :             :     // should have a same-txid-different-witness equivalent in the mempool.</span>
<span id="L1360"><span class="lineNum">    1360</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 2845 times"> + </span>]:<span class="tlaGNC">       10433 :     assert(std::all_of(workspaces.cbegin(), workspaces.cend(), [this](const auto&amp; ws) { return !m_pool.exists(ws.m_ptx-&gt;GetHash()); }));</span></span>
<span id="L1361"><span class="lineNum">    1361</span>                 :             : </span>
<span id="L1362"><span class="lineNum">    1362</span>                 :<span class="tlaGNC">        2845 :     bool all_submitted = true;</span></span>
<span id="L1363"><span class="lineNum">    1363</span>                 :<span class="tlaGNC">        2845 :     FinalizeSubpackage(args);</span></span>
<span id="L1364"><span class="lineNum">    1364</span>                 :             :     // ConsensusScriptChecks adds to the script cache and is therefore consensus-critical;</span>
<span id="L1365"><span class="lineNum">    1365</span>                 :             :     // CheckInputsFromMempoolAndCache asserts that transactions only spend coins available from the</span>
<span id="L1366"><span class="lineNum">    1366</span>                 :             :     // mempool or UTXO set. Submit each transaction to the mempool immediately after calling</span>
<span id="L1367"><span class="lineNum">    1367</span>                 :             :     // ConsensusScriptChecks to make the outputs available for subsequent transactions.</span>
<span id="L1368"><span class="lineNum">    1368</span>         [<span class="tlaGBC" title="Branch 0 was taken 7588 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 2845 times"> + </span>]:<span class="tlaGNC">       10433 :     for (Workspace&amp; ws : workspaces) {</span></span>
<span id="L1369"><span class="lineNum">    1369</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 7588 times"> + </span>]:<span class="tlaGNC">        7588 :         if (!ConsensusScriptChecks(args, ws)) {</span></span>
<span id="L1370"><span class="lineNum">    1370</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             results.emplace(ws.m_ptx-&gt;GetWitnessHash(), MempoolAcceptResult::Failure(ws.m_state));</span></span>
<span id="L1371"><span class="lineNum">    1371</span>                 :             :             // Since PolicyScriptChecks() passed, this should never fail.</span>
<span id="L1372"><span class="lineNum">    1372</span>                 :<span class="tlaUNC">           0 :             Assume(false);</span></span>
<span id="L1373"><span class="lineNum">    1373</span>                 :<span class="tlaUNC">           0 :             all_submitted = false;</span></span>
<span id="L1374"><span class="lineNum">    1374</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             package_state.Invalid(PackageValidationResult::PCKG_MEMPOOL_ERROR,</span></span>
<span id="L1375"><span class="lineNum">    1375</span>                 :<span class="tlaUNC">           0 :                                   strprintf(&quot;BUG! PolicyScriptChecks succeeded but ConsensusScriptChecks failed: %s&quot;,</span></span>
<span id="L1376"><span class="lineNum">    1376</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                                             ws.m_ptx-&gt;GetHash().ToString()));</span></span>
<span id="L1377"><span class="lineNum">    1377</span>                 :             :             // Remove the transaction from the mempool.</span>
<span id="L1378"><span class="lineNum">    1378</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (!m_subpackage.m_changeset) m_subpackage.m_changeset = m_pool.GetChangeSet();</span></span>
<span id="L1379"><span class="lineNum">    1379</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             m_subpackage.m_changeset-&gt;StageRemoval(m_pool.GetIter(ws.m_ptx-&gt;GetHash()).value());</span></span>
<span id="L1380"><span class="lineNum">    1380</span>                 :             :         }</span>
<span id="L1381"><span class="lineNum">    1381</span>                 :             :     }</span>
<span id="L1382"><span class="lineNum">    1382</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 2845 times"> + </span>]:<span class="tlaGNC">        2845 :     if (!all_submitted) {</span></span>
<span id="L1383"><span class="lineNum">    1383</span>                 :<span class="tlaUNC">           0 :         Assume(m_subpackage.m_changeset);</span></span>
<span id="L1384"><span class="lineNum">    1384</span>                 :             :         // This code should be unreachable; it's here as belt-and-suspenders</span>
<span id="L1385"><span class="lineNum">    1385</span>                 :             :         // to try to ensure we have no consensus-invalid transactions in the</span>
<span id="L1386"><span class="lineNum">    1386</span>                 :             :         // mempool.</span>
<span id="L1387"><span class="lineNum">    1387</span>                 :<span class="tlaUNC">           0 :         m_subpackage.m_changeset-&gt;Apply();</span></span>
<span id="L1388"><span class="lineNum">    1388</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         m_subpackage.m_changeset.reset();</span></span>
<span id="L1389"><span class="lineNum">    1389</span>                 :<span class="tlaUNC">           0 :         return false;</span></span>
<span id="L1390"><span class="lineNum">    1390</span>                 :             :     }</span>
<span id="L1391"><span class="lineNum">    1391</span>                 :             : </span>
<span id="L1392"><span class="lineNum">    1392</span>                 :<span class="tlaGNC">        2845 :     std::vector&lt;Wtxid&gt; all_package_wtxids;</span></span>
<span id="L1393"><span class="lineNum">    1393</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 2845 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 2845 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">        2845 :     all_package_wtxids.reserve(workspaces.size());</span></span>
<span id="L1394"><span class="lineNum">    1394</span>         [<span class="tlaGBC" title="Branch 0 was taken 2845 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        2845 :     std::transform(workspaces.cbegin(), workspaces.cend(), std::back_inserter(all_package_wtxids),</span></span>
<span id="L1395"><span class="lineNum">    1395</span>                 :<span class="tlaGNC">        7588 :                    [](const auto&amp; ws) { return ws.m_ptx-&gt;GetWitnessHash(); });</span></span>
<span id="L1396"><span class="lineNum">    1396</span>                 :             : </span>
<span id="L1397"><span class="lineNum">    1397</span>         [<span class="tlaGBC" title="Branch 0 was taken 1227 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 1618 times"> + </span>]:<span class="tlaGNC">        2845 :     if (!m_subpackage.m_replaced_transactions.empty()) {</span></span>
<span id="L1398"><span class="lineNum">    1398</span>   [<span class="tlaGBC" title="Branch 0 was taken 1227 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 1227 times"> + </span> :<span class="tlaGNC">        1227 :         LogDebug(BCLog::MEMPOOL, &quot;replaced %u mempool transactions with %u new one(s) for %s additional fees, %d delta bytes\n&quot;,</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaUNC" title="Branch 6 was not taken"> - </span><span class="tlaUNC" title="Branch 7 was not taken"> - </span>]
<span id="L1399"><span class="lineNum">    1399</span>                 :             :                  m_subpackage.m_replaced_transactions.size(), workspaces.size(),</span>
<span id="L1400"><span class="lineNum">    1400</span>                 :             :                  m_subpackage.m_total_modified_fees - m_subpackage.m_conflicting_fees,</span>
<span id="L1401"><span class="lineNum">    1401</span>                 :             :                  m_subpackage.m_total_vsize - static_cast&lt;int&gt;(m_subpackage.m_conflicting_size));</span>
<span id="L1402"><span class="lineNum">    1402</span>                 :             :     }</span>
<span id="L1403"><span class="lineNum">    1403</span>                 :             : </span>
<span id="L1404"><span class="lineNum">    1404</span>                 :             :     // Add successful results. The returned results may change later if LimitMempoolSize() evicts them.</span>
<span id="L1405"><span class="lineNum">    1405</span>         [<span class="tlaGBC" title="Branch 0 was taken 7588 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 2845 times"> + </span>]:<span class="tlaGNC">       10433 :     for (Workspace&amp; ws : workspaces) {</span></span>
<span id="L1406"><span class="lineNum">    1406</span>         [<span class="tlaGBC" title="Branch 0 was taken 7588 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        7588 :         auto iter = m_pool.GetIter(ws.m_ptx-&gt;GetHash());</span></span>
<span id="L1407"><span class="lineNum">    1407</span>         [<span class="tlaGBC" title="Branch 0 was taken 7588 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        7588 :         Assume(iter.has_value());</span></span>
<span id="L1408"><span class="lineNum">    1408</span>         [<span class="tlaGBC" title="Branch 0 was taken 7588 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        7588 :         const auto effective_feerate = args.m_package_feerates ? ws.m_package_feerate :</span></span>
<span id="L1409"><span class="lineNum">    1409</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        7588 :             CFeeRate{ws.m_modified_fees, static_cast&lt;int32_t&gt;(ws.m_vsize)};</span></span>
<span id="L1410"><span class="lineNum">    1410</span>         [<span class="tlaGBC" title="Branch 0 was taken 7588 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        7588 :         const auto effective_feerate_wtxids = args.m_package_feerates ? all_package_wtxids :</span></span>
<span id="L1411"><span class="lineNum">    1411</span>   [<span class="tlaGBC" title="Branch 0 was taken 7588 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">        7588 :             std::vector&lt;Wtxid&gt;{ws.m_ptx-&gt;GetWitnessHash()};</span></span>
<span id="L1412"><span class="lineNum">    1412</span>                 :<span class="tlaGNC">       15176 :         results.emplace(ws.m_ptx-&gt;GetWitnessHash(),</span></span>
<span id="L1413"><span class="lineNum">    1413</span>   [<span class="tlaGBC" title="Branch 0 was taken 7588 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 7588 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">        7588 :                         MempoolAcceptResult::Success(std::move(m_subpackage.m_replaced_transactions), ws.m_vsize,</span></span>
<span id="L1414"><span class="lineNum">    1414</span>                 :             :                                          ws.m_base_fees, effective_feerate, effective_feerate_wtxids));</span>
<span id="L1415"><span class="lineNum">    1415</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 7588 times"> + </span>]:<span class="tlaGNC">        7588 :         if (!m_pool.m_opts.signals) continue;</span></span>
<span id="L1416"><span class="lineNum">    1416</span>         [<span class="tlaGBC" title="Branch 0 was taken 7588 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        7588 :         const CTransaction&amp; tx = *ws.m_ptx;</span></span>
<span id="L1417"><span class="lineNum">    1417</span>         [<span class="tlaGBC" title="Branch 0 was taken 7588 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        7588 :         const auto tx_info = NewMempoolTransactionInfo(ws.m_ptx, ws.m_base_fees,</span></span>
<span id="L1418"><span class="lineNum">    1418</span>         [<span class="tlaGBC" title="Branch 0 was taken 7588 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        7588 :                                                        ws.m_vsize, (*iter)-&gt;GetHeight(),</span></span>
<span id="L1419"><span class="lineNum">    1419</span>                 :<span class="tlaGNC">        7588 :                                                        args.m_bypass_limits, args.m_package_submission,</span></span>
<span id="L1420"><span class="lineNum">    1420</span>         [<span class="tlaGBC" title="Branch 0 was taken 7588 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        7588 :                                                        IsCurrentForFeeEstimation(m_active_chainstate),</span></span>
<span id="L1421"><span class="lineNum">    1421</span>   [<span class="tlaGBC" title="Branch 0 was taken 7588 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 7588 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">       15176 :                                                        m_pool.HasNoInputsOf(tx));</span></span>
<span id="L1422"><span class="lineNum">    1422</span>         [<span class="tlaGBC" title="Branch 0 was taken 7588 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        7588 :         m_pool.m_opts.signals-&gt;TransactionAddedToMempool(tx_info, m_pool.GetAndIncrementSequence());</span></span>
<span id="L1423"><span class="lineNum">    1423</span>                 :<span class="tlaGNC">        7588 :     }</span></span>
<span id="L1424"><span class="lineNum">    1424</span>                 :<span class="tlaGNC">        2845 :     return all_submitted;</span></span>
<span id="L1425"><span class="lineNum">    1425</span>                 :<span class="tlaGNC">        2845 : }</span></span>
<span id="L1426"><span class="lineNum">    1426</span>                 :             : </span>
<span id="L1427"><span class="lineNum">    1427</span>                 :<span class="tlaGNC">     2422448 : MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef&amp; ptx, ATMPArgs&amp; args)</span></span>
<span id="L1428"><span class="lineNum">    1428</span>                 :             : {</span>
<span id="L1429"><span class="lineNum">    1429</span>                 :<span class="tlaGNC">     2422448 :     AssertLockHeld(cs_main);</span></span>
<span id="L1430"><span class="lineNum">    1430</span>                 :<span class="tlaGNC">     2422448 :     LOCK(m_pool.cs); // mempool &quot;read lock&quot; (held through m_pool.m_opts.signals-&gt;TransactionAddedToMempool())</span></span>
<span id="L1431"><span class="lineNum">    1431</span>                 :             : </span>
<span id="L1432"><span class="lineNum">    1432</span>                 :<span class="tlaGNC">     2422448 :     Workspace ws(ptx);</span></span>
<span id="L1433"><span class="lineNum">    1433</span>         [<span class="tlaGBC" title="Branch 0 was taken 2422448 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">     2422448 :     const std::vector&lt;Wtxid&gt; single_wtxid{ws.m_ptx-&gt;GetWitnessHash()};</span></span>
<span id="L1434"><span class="lineNum">    1434</span>                 :             : </span>
<span id="L1435"><span class="lineNum">    1435</span>   [<span class="tlaGBC" title="Branch 0 was taken 2422448 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 1844326 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 578122 times"> + </span>]:<span class="tlaGNC">     2422448 :     if (!PreChecks(args, ws)) {</span></span>
<span id="L1436"><span class="lineNum">    1436</span>         [<span class="tlaGBC" title="Branch 0 was taken 40035 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 1804291 times"> + </span>]:<span class="tlaGNC">     1844326 :         if (ws.m_state.GetResult() == TxValidationResult::TX_RECONSIDERABLE) {</span></span>
<span id="L1437"><span class="lineNum">    1437</span>                 :             :             // Failed for fee reasons. Provide the effective feerate and which tx was included.</span>
<span id="L1438"><span class="lineNum">    1438</span>   [<span class="tlaGBC" title="Branch 0 was taken 40035 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 40035 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      120105 :             return MempoolAcceptResult::FeeFailure(ws.m_state, CFeeRate(ws.m_modified_fees, ws.m_vsize), single_wtxid);</span></span>
<span id="L1439"><span class="lineNum">    1439</span>                 :             :         }</span>
<span id="L1440"><span class="lineNum">    1440</span>   [<span class="tlaGBC" title="Branch 0 was taken 1804291 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 1804291 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">     3608582 :         return MempoolAcceptResult::Failure(ws.m_state);</span></span>
<span id="L1441"><span class="lineNum">    1441</span>                 :             :     }</span>
<span id="L1442"><span class="lineNum">    1442</span>                 :             : </span>
<span id="L1443"><span class="lineNum">    1443</span>                 :<span class="tlaGNC">      578122 :     m_subpackage.m_total_vsize = ws.m_vsize;</span></span>
<span id="L1444"><span class="lineNum">    1444</span>                 :<span class="tlaGNC">      578122 :     m_subpackage.m_total_modified_fees = ws.m_modified_fees;</span></span>
<span id="L1445"><span class="lineNum">    1445</span>                 :             : </span>
<span id="L1446"><span class="lineNum">    1446</span>                 :             :     // Individual modified feerate exceeded caller-defined max; abort</span>
<span id="L1447"><span class="lineNum">    1447</span>   [<span class="tlaGBC" title="Branch 0 was taken 8515 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 569607 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 8515 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      578122 :     if (args.m_client_maxfeerate &amp;&amp; CFeeRate(ws.m_modified_fees, ws.m_vsize) &gt; args.m_client_maxfeerate.value()) {</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 3828 times"> + </span><span class="tlaGBC" title="Branch 5 was taken 4687 times"> + </span>]
<span id="L1448"><span class="lineNum">    1448</span>   [<span class="tlaGBC" title="Branch 0 was taken 3828 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 3828 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">        7656 :         ws.m_state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, &quot;max feerate exceeded&quot;, &quot;&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 3828 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L1449"><span class="lineNum">    1449</span>   [<span class="tlaGBC" title="Branch 0 was taken 3828 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 3828 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">        7656 :         return MempoolAcceptResult::Failure(ws.m_state);</span></span>
<span id="L1450"><span class="lineNum">    1450</span>                 :             :     }</span>
<span id="L1451"><span class="lineNum">    1451</span>                 :             : </span>
<span id="L1452"><span class="lineNum">    1452</span>         [<span class="tlaGBC" title="Branch 0 was taken 404433 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 169861 times"> + </span>]:<span class="tlaGNC">      574294 :     if (m_pool.m_opts.require_standard) {</span></span>
<span id="L1453"><span class="lineNum">    1453</span>         [<span class="tlaGBC" title="Branch 0 was taken 404433 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      404433 :         Wtxid dummy_wtxid;</span></span>
<span id="L1454"><span class="lineNum">    1454</span>   [<span class="tlaGBC" title="Branch 0 was taken 404433 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 404433 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 404433 times"> + </span> :<span class="tlaGNC">      808866 :         if (!CheckEphemeralSpends(/*package=*/{ptx}, m_pool.m_opts.dust_relay_feerate, m_pool, ws.m_state, dummy_wtxid)) {</span></span>
<span class="lineNum">        </span> <span class="tlaGBC" title="Branch 4 was taken 404433 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaGBC" title="Branch 6 was taken 8206 times"> + </span><span class="tlaGBC" title="Branch 7 was taken 396227 times"> + </span><span class="tlaUNC" title="Branch 8 was not taken"> - </span> 
<span class="lineNum">        </span>       <span class="tlaUNC" title="Branch 9 was not taken"> - </span><span class="tlaUNC" title="Branch 10 was not taken"> - </span><span class="tlaUNC" title="Branch 11 was not taken"> - </span>]
<span id="L1455"><span class="lineNum">    1455</span>   [<span class="tlaGBC" title="Branch 0 was taken 8206 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 8206 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">       16412 :             return MempoolAcceptResult::Failure(ws.m_state);</span></span>
<span id="L1456"><span class="lineNum">    1456</span>                 :             :         }</span>
<span id="L1457"><span class="lineNum">    1457</span>                 :             :     }</span>
<span id="L1458"><span class="lineNum">    1458</span>                 :             : </span>
<span id="L1459"><span class="lineNum">    1459</span>   [<span class="tlaGBC" title="Branch 0 was taken 307587 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 258501 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 307587 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      566088 :     if (m_subpackage.m_rbf &amp;&amp; !ReplacementChecks(ws)) {</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 29414 times"> + </span><span class="tlaGBC" title="Branch 5 was taken 278173 times"> + </span>]
<span id="L1460"><span class="lineNum">    1460</span>         [<span class="tlaGBC" title="Branch 0 was taken 262398 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 15775 times"> + </span>]:<span class="tlaGNC">      278173 :         if (ws.m_state.GetResult() == TxValidationResult::TX_RECONSIDERABLE) {</span></span>
<span id="L1461"><span class="lineNum">    1461</span>                 :             :             // Failed for incentives-based fee reasons. Provide the effective feerate and which tx was included.</span>
<span id="L1462"><span class="lineNum">    1462</span>   [<span class="tlaGBC" title="Branch 0 was taken 262398 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 262398 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      787194 :             return MempoolAcceptResult::FeeFailure(ws.m_state, CFeeRate(ws.m_modified_fees, ws.m_vsize), single_wtxid);</span></span>
<span id="L1463"><span class="lineNum">    1463</span>                 :             :         }</span>
<span id="L1464"><span class="lineNum">    1464</span>   [<span class="tlaGBC" title="Branch 0 was taken 15775 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 15775 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">       31550 :         return MempoolAcceptResult::Failure(ws.m_state);</span></span>
<span id="L1465"><span class="lineNum">    1465</span>                 :             :     }</span>
<span id="L1466"><span class="lineNum">    1466</span>                 :             : </span>
<span id="L1467"><span class="lineNum">    1467</span>                 :             :     // Perform the inexpensive checks first and avoid hashing and signature verification unless</span>
<span id="L1468"><span class="lineNum">    1468</span>                 :             :     // those checks pass, to mitigate CPU exhaustion denial-of-service attacks.</span>
<span id="L1469"><span class="lineNum">    1469</span>   [<span class="tlaGBC" title="Branch 0 was taken 287915 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 51172 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 236743 times"> + </span> :<span class="tlaGNC">      339087 :     if (!PolicyScriptChecks(args, ws)) return MempoolAcceptResult::Failure(ws.m_state);</span></span>
<span class="lineNum">        </span>    <span class="tlaGBC" title="Branch 4 was taken 51172 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaGBC" title="Branch 6 was taken 51172 times"> + </span><span class="tlaUNC" title="Branch 7 was not taken"> - </span>]
<span id="L1470"><span class="lineNum">    1470</span>                 :             : </span>
<span id="L1471"><span class="lineNum">    1471</span>   [<span class="tlaGBC" title="Branch 0 was taken 236743 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 236743 times"> + </span> :<span class="tlaGNC">      236743 :     if (!ConsensusScriptChecks(args, ws)) return MempoolAcceptResult::Failure(ws.m_state);</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaUNC" title="Branch 6 was not taken"> - </span><span class="tlaUNC" title="Branch 7 was not taken"> - </span>]
<span id="L1472"><span class="lineNum">    1472</span>                 :             : </span>
<span id="L1473"><span class="lineNum">    1473</span>         [<span class="tlaGBC" title="Branch 0 was taken 236743 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      236743 :     const CFeeRate effective_feerate{ws.m_modified_fees, static_cast&lt;int32_t&gt;(ws.m_vsize)};</span></span>
<span id="L1474"><span class="lineNum">    1474</span>                 :             :     // Tx was accepted, but not added</span>
<span id="L1475"><span class="lineNum">    1475</span>         [<span class="tlaGBC" title="Branch 0 was taken 4623 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 232120 times"> + </span>]:<span class="tlaGNC">      236743 :     if (args.m_test_accept) {</span></span>
<span id="L1476"><span class="lineNum">    1476</span>                 :<span class="tlaGNC">        4623 :         return MempoolAcceptResult::Success(std::move(m_subpackage.m_replaced_transactions), ws.m_vsize,</span></span>
<span id="L1477"><span class="lineNum">    1477</span>         [<span class="tlaGBC" title="Branch 0 was taken 4623 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        4623 :                                             ws.m_base_fees, effective_feerate, single_wtxid);</span></span>
<span id="L1478"><span class="lineNum">    1478</span>                 :             :     }</span>
<span id="L1479"><span class="lineNum">    1479</span>                 :             : </span>
<span id="L1480"><span class="lineNum">    1480</span>         [<span class="tlaGBC" title="Branch 0 was taken 232120 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      232120 :     FinalizeSubpackage(args);</span></span>
<span id="L1481"><span class="lineNum">    1481</span>                 :             : </span>
<span id="L1482"><span class="lineNum">    1482</span>                 :             :     // Limit the mempool, if appropriate.</span>
<span id="L1483"><span class="lineNum">    1483</span>   [<span class="tlaGBC" title="Branch 0 was taken 141288 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 90832 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 55606 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 85682 times"> + </span>]:<span class="tlaGNC">      232120 :     if (!args.m_package_submission &amp;&amp; !args.m_bypass_limits) {</span></span>
<span id="L1484"><span class="lineNum">    1484</span>   [<span class="tlaGBC" title="Branch 0 was taken 55606 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 55606 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">       55606 :         LimitMempoolSize(m_pool, m_active_chainstate.CoinsTip());</span></span>
<span id="L1485"><span class="lineNum">    1485</span>                 :             :         // If mempool contents change, then the m_view cache is dirty. Given this isn't a package</span>
<span id="L1486"><span class="lineNum">    1486</span>                 :             :         // submission, we won't be using the cache anymore, but clear it anyway for clarity.</span>
<span id="L1487"><span class="lineNum">    1487</span>         [<span class="tlaGBC" title="Branch 0 was taken 55606 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       55606 :         CleanupTemporaryCoins();</span></span>
<span id="L1488"><span class="lineNum">    1488</span>                 :             : </span>
<span id="L1489"><span class="lineNum">    1489</span>   [<span class="tlaGBC" title="Branch 0 was taken 55606 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 9832 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 45774 times"> + </span>]:<span class="tlaGNC">       55606 :         if (!m_pool.exists(ws.m_hash)) {</span></span>
<span id="L1490"><span class="lineNum">    1490</span>                 :             :             // The tx no longer meets our (new) mempool minimum feerate but could be reconsidered in a package.</span>
<span id="L1491"><span class="lineNum">    1491</span>   [<span class="tlaGBC" title="Branch 0 was taken 9832 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 9832 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">       19664 :             ws.m_state.Invalid(TxValidationResult::TX_RECONSIDERABLE, &quot;mempool full&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 9832 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L1492"><span class="lineNum">    1492</span>   [<span class="tlaGBC" title="Branch 0 was taken 9832 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 9832 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">       29496 :             return MempoolAcceptResult::FeeFailure(ws.m_state, CFeeRate(ws.m_modified_fees, ws.m_vsize), {ws.m_ptx-&gt;GetWitnessHash()});</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 9832 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L1493"><span class="lineNum">    1493</span>                 :             :         }</span>
<span id="L1494"><span class="lineNum">    1494</span>                 :             :     }</span>
<span id="L1495"><span class="lineNum">    1495</span>                 :             : </span>
<span id="L1496"><span class="lineNum">    1496</span>         [<span class="tlaGBC" title="Branch 0 was taken 222288 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      222288 :     if (m_pool.m_opts.signals) {</span></span>
<span id="L1497"><span class="lineNum">    1497</span>         [<span class="tlaGBC" title="Branch 0 was taken 222288 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      222288 :         const CTransaction&amp; tx = *ws.m_ptx;</span></span>
<span id="L1498"><span class="lineNum">    1498</span>         [<span class="tlaGBC" title="Branch 0 was taken 222288 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      222288 :         auto iter = m_pool.GetIter(tx.GetHash());</span></span>
<span id="L1499"><span class="lineNum">    1499</span>         [<span class="tlaGBC" title="Branch 0 was taken 222288 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      222288 :         Assume(iter.has_value());</span></span>
<span id="L1500"><span class="lineNum">    1500</span>                 :<span class="tlaGNC">      222288 :         const auto tx_info = NewMempoolTransactionInfo(ws.m_ptx, ws.m_base_fees,</span></span>
<span id="L1501"><span class="lineNum">    1501</span>         [<span class="tlaGBC" title="Branch 0 was taken 222288 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      222288 :                                                        ws.m_vsize, (*iter)-&gt;GetHeight(),</span></span>
<span id="L1502"><span class="lineNum">    1502</span>                 :<span class="tlaGNC">      222288 :                                                        args.m_bypass_limits, args.m_package_submission,</span></span>
<span id="L1503"><span class="lineNum">    1503</span>         [<span class="tlaGBC" title="Branch 0 was taken 222288 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      222288 :                                                        IsCurrentForFeeEstimation(m_active_chainstate),</span></span>
<span id="L1504"><span class="lineNum">    1504</span>   [<span class="tlaGBC" title="Branch 0 was taken 222288 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 222288 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      444576 :                                                        m_pool.HasNoInputsOf(tx));</span></span>
<span id="L1505"><span class="lineNum">    1505</span>         [<span class="tlaGBC" title="Branch 0 was taken 222288 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      222288 :         m_pool.m_opts.signals-&gt;TransactionAddedToMempool(tx_info, m_pool.GetAndIncrementSequence());</span></span>
<span id="L1506"><span class="lineNum">    1506</span>                 :<span class="tlaGNC">      222288 :     }</span></span>
<span id="L1507"><span class="lineNum">    1507</span>                 :             : </span>
<span id="L1508"><span class="lineNum">    1508</span>         [<span class="tlaGBC" title="Branch 0 was taken 27263 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 195025 times"> + </span>]:<span class="tlaGNC">      222288 :     if (!m_subpackage.m_replaced_transactions.empty()) {</span></span>
<span id="L1509"><span class="lineNum">    1509</span>   [<span class="tlaGBC" title="Branch 0 was taken 27263 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 27263 times"> + </span> :<span class="tlaGNC">       27263 :         LogDebug(BCLog::MEMPOOL, &quot;replaced %u mempool transactions with 1 new transaction for %s additional fees, %d delta bytes\n&quot;,</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L1510"><span class="lineNum">    1510</span>                 :             :                  m_subpackage.m_replaced_transactions.size(),</span>
<span id="L1511"><span class="lineNum">    1511</span>                 :             :                  ws.m_modified_fees - m_subpackage.m_conflicting_fees,</span>
<span id="L1512"><span class="lineNum">    1512</span>                 :             :                  ws.m_vsize - static_cast&lt;int&gt;(m_subpackage.m_conflicting_size));</span>
<span id="L1513"><span class="lineNum">    1513</span>                 :             :     }</span>
<span id="L1514"><span class="lineNum">    1514</span>                 :             : </span>
<span id="L1515"><span class="lineNum">    1515</span>                 :<span class="tlaGNC">      222288 :     return MempoolAcceptResult::Success(std::move(m_subpackage.m_replaced_transactions), ws.m_vsize, ws.m_base_fees,</span></span>
<span id="L1516"><span class="lineNum">    1516</span>         [<span class="tlaGBC" title="Branch 0 was taken 222288 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">     2422448 :                                         effective_feerate, single_wtxid);</span></span>
<span id="L1517"><span class="lineNum">    1517</span>   [<span class="tlaGBC" title="Branch 0 was taken 404433 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 404433 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">     5653762 : }</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 2422448 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L1518"><span class="lineNum">    1518</span>                 :             : </span>
<span id="L1519"><span class="lineNum">    1519</span>                 :<span class="tlaGNC">      397779 : PackageMempoolAcceptResult MemPoolAccept::AcceptMultipleTransactions(const std::vector&lt;CTransactionRef&gt;&amp; txns, ATMPArgs&amp; args)</span></span>
<span id="L1520"><span class="lineNum">    1520</span>                 :             : {</span>
<span id="L1521"><span class="lineNum">    1521</span>                 :<span class="tlaGNC">      397779 :     AssertLockHeld(cs_main);</span></span>
<span id="L1522"><span class="lineNum">    1522</span>                 :             : </span>
<span id="L1523"><span class="lineNum">    1523</span>                 :             :     // These context-free package limits can be done before taking the mempool lock.</span>
<span id="L1524"><span class="lineNum">    1524</span>         [<span class="tlaGBC" title="Branch 0 was taken 397779 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      397779 :     PackageValidationState package_state;</span></span>
<span id="L1525"><span class="lineNum">    1525</span>   [<span class="tlaGBC" title="Branch 0 was taken 397779 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 139 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 397640 times"> + </span> :<span class="tlaGNC">      398057 :     if (!IsWellFormedPackage(txns, package_state, /*require_sorted=*/true)) return PackageMempoolAcceptResult(package_state, {});</span></span>
<span class="lineNum">        </span>    <span class="tlaGBC" title="Branch 4 was taken 139 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaGBC" title="Branch 6 was taken 139 times"> + </span><span class="tlaUNC" title="Branch 7 was not taken"> - </span>]
<span id="L1526"><span class="lineNum">    1526</span>                 :             : </span>
<span id="L1527"><span class="lineNum">    1527</span>                 :<span class="tlaGNC">      397640 :     std::vector&lt;Workspace&gt; workspaces{};</span></span>
<span id="L1528"><span class="lineNum">    1528</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 397640 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 397640 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      397640 :     workspaces.reserve(txns.size());</span></span>
<span id="L1529"><span class="lineNum">    1529</span>         [<span class="tlaGBC" title="Branch 0 was taken 397640 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      397640 :     std::transform(txns.cbegin(), txns.cend(), std::back_inserter(workspaces),</span></span>
<span id="L1530"><span class="lineNum">    1530</span>                 :<span class="tlaGNC">      500473 :                    [](const auto&amp; tx) { return Workspace(tx); });</span></span>
<span id="L1531"><span class="lineNum">    1531</span>         [<span class="tlaGBC" title="Branch 0 was taken 397640 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      397640 :     std::map&lt;Wtxid, MempoolAcceptResult&gt; results;</span></span>
<span id="L1532"><span class="lineNum">    1532</span>                 :             : </span>
<span id="L1533"><span class="lineNum">    1533</span>         [<span class="tlaGBC" title="Branch 0 was taken 397640 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      397640 :     LOCK(m_pool.cs);</span></span>
<span id="L1534"><span class="lineNum">    1534</span>                 :             : </span>
<span id="L1535"><span class="lineNum">    1535</span>                 :             :     // Do all PreChecks first and fail fast to avoid running expensive script checks when unnecessary.</span>
<span id="L1536"><span class="lineNum">    1536</span>         [<span class="tlaGBC" title="Branch 0 was taken 493006 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 115808 times"> + </span>]:<span class="tlaGNC">      608814 :     for (Workspace&amp; ws : workspaces) {</span></span>
<span id="L1537"><span class="lineNum">    1537</span>   [<span class="tlaGBC" title="Branch 0 was taken 493006 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 281631 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 211375 times"> + </span>]:<span class="tlaGNC">      493006 :         if (!PreChecks(args, ws)) {</span></span>
<span id="L1538"><span class="lineNum">    1538</span>   [<span class="tlaGBC" title="Branch 0 was taken 281631 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 281631 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      563262 :             package_state.Invalid(PackageValidationResult::PCKG_TX, &quot;transaction failed&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 281631 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L1539"><span class="lineNum">    1539</span>                 :             :             // Exit early to avoid doing pointless work. Update the failed tx result; the rest are unfinished.</span>
<span id="L1540"><span class="lineNum">    1540</span>   [<span class="tlaGBC" title="Branch 0 was taken 281631 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 281631 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      281631 :             results.emplace(ws.m_ptx-&gt;GetWitnessHash(), MempoolAcceptResult::Failure(ws.m_state));</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 281631 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L1541"><span class="lineNum">    1541</span>   [<span class="tlaGBC" title="Branch 0 was taken 281631 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 281631 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      844893 :             return PackageMempoolAcceptResult(package_state, std::move(results));</span></span>
<span id="L1542"><span class="lineNum">    1542</span>                 :             :         }</span>
<span id="L1543"><span class="lineNum">    1543</span>                 :             : </span>
<span id="L1544"><span class="lineNum">    1544</span>                 :             :         // Individual modified feerate exceeded caller-defined max; abort</span>
<span id="L1545"><span class="lineNum">    1545</span>                 :             :         // N.B. this doesn't take into account CPFPs. Chunk-aware validation may be more robust.</span>
<span id="L1546"><span class="lineNum">    1546</span>   [<span class="tlaGBC" title="Branch 0 was taken 6128 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 205247 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 6128 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      211375 :         if (args.m_client_maxfeerate &amp;&amp; CFeeRate(ws.m_modified_fees, ws.m_vsize) &gt; args.m_client_maxfeerate.value()) {</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 201 times"> + </span><span class="tlaGBC" title="Branch 5 was taken 5927 times"> + </span>]
<span id="L1547"><span class="lineNum">    1547</span>                 :             :             // Need to set failure here both individually and at package level</span>
<span id="L1548"><span class="lineNum">    1548</span>   [<span class="tlaGBC" title="Branch 0 was taken 201 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 201 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">         402 :             ws.m_state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, &quot;max feerate exceeded&quot;, &quot;&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 201 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L1549"><span class="lineNum">    1549</span>   [<span class="tlaGBC" title="Branch 0 was taken 201 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 201 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">         402 :             package_state.Invalid(PackageValidationResult::PCKG_TX, &quot;transaction failed&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 201 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L1550"><span class="lineNum">    1550</span>                 :             :             // Exit early to avoid doing pointless work. Update the failed tx result; the rest are unfinished.</span>
<span id="L1551"><span class="lineNum">    1551</span>   [<span class="tlaGBC" title="Branch 0 was taken 201 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 201 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">         201 :             results.emplace(ws.m_ptx-&gt;GetWitnessHash(), MempoolAcceptResult::Failure(ws.m_state));</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 201 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L1552"><span class="lineNum">    1552</span>   [<span class="tlaGBC" title="Branch 0 was taken 201 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 201 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">         603 :             return PackageMempoolAcceptResult(package_state, std::move(results));</span></span>
<span id="L1553"><span class="lineNum">    1553</span>                 :             :         }</span>
<span id="L1554"><span class="lineNum">    1554</span>                 :             : </span>
<span id="L1555"><span class="lineNum">    1555</span>                 :             :         // Make the coins created by this transaction available for subsequent transactions in the</span>
<span id="L1556"><span class="lineNum">    1556</span>                 :             :         // package to spend. If there are no conflicts within the package, no transaction can spend a coin</span>
<span id="L1557"><span class="lineNum">    1557</span>                 :             :         // needed by another transaction in the package. We also need to make sure that no package</span>
<span id="L1558"><span class="lineNum">    1558</span>                 :             :         // tx replaces (or replaces the ancestor of) the parent of another package tx. As long as we</span>
<span id="L1559"><span class="lineNum">    1559</span>                 :             :         // check these two things, we don't need to track the coins spent.</span>
<span id="L1560"><span class="lineNum">    1560</span>                 :             :         // If a package tx conflicts with a mempool tx, PackageMempoolChecks() ensures later that any package RBF attempt</span>
<span id="L1561"><span class="lineNum">    1561</span>                 :             :         // has *no* in-mempool ancestors, so we don't have to worry about subsequent transactions in</span>
<span id="L1562"><span class="lineNum">    1562</span>                 :             :         // same package spending the same in-mempool outpoints. This needs to be revisited for general</span>
<span id="L1563"><span class="lineNum">    1563</span>                 :             :         // package RBF.</span>
<span id="L1564"><span class="lineNum">    1564</span>         [<span class="tlaGBC" title="Branch 0 was taken 211174 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      211174 :         m_viewmempool.PackageAddTransaction(ws.m_ptx);</span></span>
<span id="L1565"><span class="lineNum">    1565</span>                 :             :     }</span>
<span id="L1566"><span class="lineNum">    1566</span>                 :             : </span>
<span id="L1567"><span class="lineNum">    1567</span>                 :             :     // At this point we have all in-mempool ancestors, and we know every transaction's vsize.</span>
<span id="L1568"><span class="lineNum">    1568</span>                 :             :     // Run the TRUC checks on the package.</span>
<span id="L1569"><span class="lineNum">    1569</span>         [<span class="tlaGBC" title="Branch 0 was taken 186392 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 114893 times"> + </span>]:<span class="tlaGNC">      301285 :     for (Workspace&amp; ws : workspaces) {</span></span>
<span id="L1570"><span class="lineNum">    1570</span>   [<span class="tlaGBC" title="Branch 0 was taken 186392 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 915 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 185477 times"> + </span>]:<span class="tlaGNC">      186392 :         if (auto err{PackageTRUCChecks(ws.m_ptx, ws.m_vsize, txns, ws.m_ancestors)}) {</span></span>
<span id="L1571"><span class="lineNum">    1571</span>   [<span class="tlaGBC" title="Branch 0 was taken 915 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 915 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">         915 :             package_state.Invalid(PackageValidationResult::PCKG_POLICY, &quot;TRUC-violation&quot;, err.value());</span></span>
<span id="L1572"><span class="lineNum">    1572</span>   [<span class="tlaGBC" title="Branch 0 was taken 915 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 915 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">        2745 :             return PackageMempoolAcceptResult(package_state, {});</span></span>
<span id="L1573"><span class="lineNum">    1573</span>                 :<span class="tlaGNC">      186392 :         }</span></span>
<span id="L1574"><span class="lineNum">    1574</span>                 :             :     }</span>
<span id="L1575"><span class="lineNum">    1575</span>                 :             : </span>
<span id="L1576"><span class="lineNum">    1576</span>                 :             :     // Transactions must meet two minimum feerates: the mempool minimum fee and min relay fee.</span>
<span id="L1577"><span class="lineNum">    1577</span>                 :             :     // For transactions consisting of exactly one child and its parents, it suffices to use the</span>
<span id="L1578"><span class="lineNum">    1578</span>                 :             :     // package feerate (total modified fees / total virtual size) to check this requirement.</span>
<span id="L1579"><span class="lineNum">    1579</span>                 :             :     // Note that this is an aggregate feerate; this function has not checked that there are transactions</span>
<span id="L1580"><span class="lineNum">    1580</span>                 :             :     // too low feerate to pay for themselves, or that the child transactions are higher feerate than</span>
<span id="L1581"><span class="lineNum">    1581</span>                 :             :     // their parents. Using aggregate feerate may allow &quot;parents pay for child&quot; behavior and permit</span>
<span id="L1582"><span class="lineNum">    1582</span>                 :             :     // a child that is below mempool minimum feerate. To avoid these behaviors, callers of</span>
<span id="L1583"><span class="lineNum">    1583</span>                 :             :     // AcceptMultipleTransactions need to restrict txns topology (e.g. to ancestor sets) and check</span>
<span id="L1584"><span class="lineNum">    1584</span>                 :             :     // the feerates of individuals and subsets.</span>
<span id="L1585"><span class="lineNum">    1585</span>                 :<span class="tlaGNC">      114893 :     m_subpackage.m_total_vsize = std::accumulate(workspaces.cbegin(), workspaces.cend(), int64_t{0},</span></span>
<span id="L1586"><span class="lineNum">    1586</span>                 :<span class="tlaGNC">      184540 :         [](int64_t sum, auto&amp; ws) { return sum + ws.m_vsize; });</span></span>
<span id="L1587"><span class="lineNum">    1587</span>                 :<span class="tlaGNC">      114893 :     m_subpackage.m_total_modified_fees = std::accumulate(workspaces.cbegin(), workspaces.cend(), CAmount{0},</span></span>
<span id="L1588"><span class="lineNum">    1588</span>                 :<span class="tlaGNC">      184540 :         [](CAmount sum, auto&amp; ws) { return sum + ws.m_modified_fees; });</span></span>
<span id="L1589"><span class="lineNum">    1589</span>         [<span class="tlaGBC" title="Branch 0 was taken 114893 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      114893 :     const CFeeRate package_feerate(m_subpackage.m_total_modified_fees, m_subpackage.m_total_vsize);</span></span>
<span id="L1590"><span class="lineNum">    1590</span>                 :<span class="tlaGNC">      114893 :     std::vector&lt;Wtxid&gt; all_package_wtxids;</span></span>
<span id="L1591"><span class="lineNum">    1591</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 114893 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 114893 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      114893 :     all_package_wtxids.reserve(workspaces.size());</span></span>
<span id="L1592"><span class="lineNum">    1592</span>         [<span class="tlaGBC" title="Branch 0 was taken 114893 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      114893 :     std::transform(workspaces.cbegin(), workspaces.cend(), std::back_inserter(all_package_wtxids),</span></span>
<span id="L1593"><span class="lineNum">    1593</span>                 :<span class="tlaGNC">      184540 :                    [](const auto&amp; ws) { return ws.m_ptx-&gt;GetWitnessHash(); });</span></span>
<span id="L1594"><span class="lineNum">    1594</span>         [<span class="tlaGBC" title="Branch 0 was taken 56763 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 58130 times"> + </span>]:<span class="tlaGNC">      114893 :     TxValidationState placeholder_state;</span></span>
<span id="L1595"><span class="lineNum">    1595</span>   [<span class="tlaGBC" title="Branch 0 was taken 56763 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 58130 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 54573 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 2190 times"> + </span>]:<span class="tlaGNC">      171656 :     if (args.m_package_feerates &amp;&amp;</span></span>
<span id="L1596"><span class="lineNum">    1596</span>         [<span class="tlaGBC" title="Branch 0 was taken 56763 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       56763 :         !CheckFeeRate(m_subpackage.m_total_vsize, m_subpackage.m_total_modified_fees, placeholder_state)) {</span></span>
<span id="L1597"><span class="lineNum">    1597</span>   [<span class="tlaGBC" title="Branch 0 was taken 2190 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 2190 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">        4380 :         package_state.Invalid(PackageValidationResult::PCKG_TX, &quot;transaction failed&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 2190 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L1598"><span class="lineNum">    1598</span>         [<span class="tlaGBC" title="Branch 0 was taken 2190 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        2190 :         return PackageMempoolAcceptResult(package_state, {{workspaces.back().m_ptx-&gt;GetWitnessHash(),</span></span>
<span id="L1599"><span class="lineNum">    1599</span>   [<span class="tlaGBC" title="Branch 0 was taken 2190 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 2190 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">       15330 :             MempoolAcceptResult::FeeFailure(placeholder_state, CFeeRate(m_subpackage.m_total_modified_fees, m_subpackage.m_total_vsize), all_package_wtxids)}});</span></span>
<span class="lineNum">        </span> <span class="tlaGBC" title="Branch 4 was taken 2190 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaGBC" title="Branch 6 was taken 2190 times"> + </span><span class="tlaGBC" title="Branch 7 was taken 2190 times"> + </span><span class="tlaUNC" title="Branch 8 was not taken"> - </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not taken"> - </span>]
<span id="L1600"><span class="lineNum">    1600</span>                 :             :     }</span>
<span id="L1601"><span class="lineNum">    1601</span>                 :             : </span>
<span id="L1602"><span class="lineNum">    1602</span>                 :             :     // Apply package mempool ancestor/descendant limits. Skip if there is only one transaction,</span>
<span id="L1603"><span class="lineNum">    1603</span>                 :             :     // because it's unnecessary.</span>
<span id="L1604"><span class="lineNum">    1604</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 112703 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 54573 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 58130 times"> + </span> :<span class="tlaGNC">      112703 :     if (txns.size() &gt; 1 &amp;&amp; !PackageMempoolChecks(txns, workspaces, m_subpackage.m_total_vsize, package_state)) {</span></span>
<span class="lineNum">        </span>    <span class="tlaGBC" title="Branch 4 was taken 54573 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaGBC" title="Branch 6 was taken 2846 times"> + </span><span class="tlaGBC" title="Branch 7 was taken 51727 times"> + </span>]
<span id="L1605"><span class="lineNum">    1605</span>   [<span class="tlaGBC" title="Branch 0 was taken 51727 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 51727 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      155181 :         return PackageMempoolAcceptResult(package_state, std::move(results));</span></span>
<span id="L1606"><span class="lineNum">    1606</span>                 :             :     }</span>
<span id="L1607"><span class="lineNum">    1607</span>                 :             : </span>
<span id="L1608"><span class="lineNum">    1608</span>                 :             :     // Now that we've bounded the resulting possible ancestry count, check package for dust spends</span>
<span id="L1609"><span class="lineNum">    1609</span>         [<span class="tlaGBC" title="Branch 0 was taken 45821 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 15155 times"> + </span>]:<span class="tlaGNC">       60976 :     if (m_pool.m_opts.require_standard) {</span></span>
<span id="L1610"><span class="lineNum">    1610</span>         [<span class="tlaGBC" title="Branch 0 was taken 45821 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       45821 :         TxValidationState child_state;</span></span>
<span id="L1611"><span class="lineNum">    1611</span>         [<span class="tlaGBC" title="Branch 0 was taken 45821 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       45821 :         Wtxid child_wtxid;</span></span>
<span id="L1612"><span class="lineNum">    1612</span>   [<span class="tlaGBC" title="Branch 0 was taken 45821 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 948 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 44873 times"> + </span>]:<span class="tlaGNC">       45821 :         if (!CheckEphemeralSpends(txns, m_pool.m_opts.dust_relay_feerate, m_pool, child_state, child_wtxid)) {</span></span>
<span id="L1613"><span class="lineNum">    1613</span>   [<span class="tlaGBC" title="Branch 0 was taken 948 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 948 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">        1896 :             package_state.Invalid(PackageValidationResult::PCKG_TX, &quot;unspent-dust&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 948 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L1614"><span class="lineNum">    1614</span>   [<span class="tlaGBC" title="Branch 0 was taken 948 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 948 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">         948 :             results.emplace(child_wtxid, MempoolAcceptResult::Failure(child_state));</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 948 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L1615"><span class="lineNum">    1615</span>   [<span class="tlaGBC" title="Branch 0 was taken 948 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 948 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">        2844 :             return PackageMempoolAcceptResult(package_state, std::move(results));</span></span>
<span id="L1616"><span class="lineNum">    1616</span>                 :             :         }</span>
<span id="L1617"><span class="lineNum">    1617</span>                 :<span class="tlaGNC">       45821 :     }</span></span>
<span id="L1618"><span class="lineNum">    1618</span>                 :             : </span>
<span id="L1619"><span class="lineNum">    1619</span>         [<span class="tlaGBC" title="Branch 0 was taken 64771 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 59861 times"> + </span>]:<span class="tlaGNC">      124632 :     for (Workspace&amp; ws : workspaces) {</span></span>
<span id="L1620"><span class="lineNum">    1620</span>                 :<span class="tlaGNC">       64771 :         ws.m_package_feerate = package_feerate;</span></span>
<span id="L1621"><span class="lineNum">    1621</span>   [<span class="tlaGBC" title="Branch 0 was taken 64771 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 167 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 64604 times"> + </span>]:<span class="tlaGNC">       64771 :         if (!PolicyScriptChecks(args, ws)) {</span></span>
<span id="L1622"><span class="lineNum">    1622</span>                 :             :             // Exit early to avoid doing pointless work. Update the failed tx result; the rest are unfinished.</span>
<span id="L1623"><span class="lineNum">    1623</span>   [<span class="tlaGBC" title="Branch 0 was taken 167 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 167 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">         334 :             package_state.Invalid(PackageValidationResult::PCKG_TX, &quot;transaction failed&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 167 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L1624"><span class="lineNum">    1624</span>   [<span class="tlaGBC" title="Branch 0 was taken 167 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 167 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">         167 :             results.emplace(ws.m_ptx-&gt;GetWitnessHash(), MempoolAcceptResult::Failure(ws.m_state));</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 167 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L1625"><span class="lineNum">    1625</span>   [<span class="tlaGBC" title="Branch 0 was taken 167 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 167 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">         501 :             return PackageMempoolAcceptResult(package_state, std::move(results));</span></span>
<span id="L1626"><span class="lineNum">    1626</span>                 :             :         }</span>
<span id="L1627"><span class="lineNum">    1627</span>         [<span class="tlaGBC" title="Branch 0 was taken 57016 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 7588 times"> + </span>]:<span class="tlaGNC">       64604 :         if (args.m_test_accept) {</span></span>
<span id="L1628"><span class="lineNum">    1628</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 57016 times"> + </span>]:<span class="tlaGNC">       57016 :             const auto effective_feerate = args.m_package_feerates ? ws.m_package_feerate :</span></span>
<span id="L1629"><span class="lineNum">    1629</span>         [<span class="tlaGBC" title="Branch 0 was taken 57016 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       57016 :                 CFeeRate{ws.m_modified_fees, static_cast&lt;int32_t&gt;(ws.m_vsize)};</span></span>
<span id="L1630"><span class="lineNum">    1630</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 57016 times"> + </span>]:<span class="tlaGNC">       57016 :             const auto effective_feerate_wtxids = args.m_package_feerates ? all_package_wtxids :</span></span>
<span id="L1631"><span class="lineNum">    1631</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 57016 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">       57016 :                 std::vector&lt;Wtxid&gt;{ws.m_ptx-&gt;GetWitnessHash()};</span></span>
<span id="L1632"><span class="lineNum">    1632</span>                 :<span class="tlaGNC">      114032 :             results.emplace(ws.m_ptx-&gt;GetWitnessHash(),</span></span>
<span id="L1633"><span class="lineNum">    1633</span>   [<span class="tlaGBC" title="Branch 0 was taken 57016 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 57016 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">       57016 :                             MempoolAcceptResult::Success(std::move(m_subpackage.m_replaced_transactions),</span></span>
<span id="L1634"><span class="lineNum">    1634</span>                 :             :                                                          ws.m_vsize, ws.m_base_fees, effective_feerate,</span>
<span id="L1635"><span class="lineNum">    1635</span>                 :             :                                                          effective_feerate_wtxids));</span>
<span id="L1636"><span class="lineNum">    1636</span>                 :<span class="tlaGNC">       57016 :         }</span></span>
<span id="L1637"><span class="lineNum">    1637</span>                 :             :     }</span>
<span id="L1638"><span class="lineNum">    1638</span>                 :             : </span>
<span id="L1639"><span class="lineNum">    1639</span>   [<span class="tlaGBC" title="Branch 0 was taken 57016 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 2845 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 57016 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      173893 :     if (args.m_test_accept) return PackageMempoolAcceptResult(package_state, std::move(results));</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 57016 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L1640"><span class="lineNum">    1640</span>                 :             : </span>
<span id="L1641"><span class="lineNum">    1641</span>   [<span class="tlaGBC" title="Branch 0 was taken 2845 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 2845 times"> + </span>]:<span class="tlaGNC">        2845 :     if (!SubmitPackage(args, workspaces, package_state, results)) {</span></span>
<span id="L1642"><span class="lineNum">    1642</span>                 :             :         // PackageValidationState filled in by SubmitPackage().</span>
<span id="L1643"><span class="lineNum">    1643</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         return PackageMempoolAcceptResult(package_state, std::move(results));</span></span>
<span id="L1644"><span class="lineNum">    1644</span>                 :             :     }</span>
<span id="L1645"><span class="lineNum">    1645</span>                 :             : </span>
<span id="L1646"><span class="lineNum">    1646</span>   [<span class="tlaGBC" title="Branch 0 was taken 2845 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 2845 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">        8535 :     return PackageMempoolAcceptResult(package_state, std::move(results));</span></span>
<span id="L1647"><span class="lineNum">    1647</span>         [<span class="tlaGBC" title="Branch 0 was taken 2190 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      912502 : }</span></span>
<span id="L1648"><span class="lineNum">    1648</span>                 :             : </span>
<span id="L1649"><span class="lineNum">    1649</span>                 :<span class="tlaGNC">     1316427 : void MemPoolAccept::CleanupTemporaryCoins()</span></span>
<span id="L1650"><span class="lineNum">    1650</span>                 :             : {</span>
<span id="L1651"><span class="lineNum">    1651</span>                 :             :     // There are 3 kinds of coins in m_view:</span>
<span id="L1652"><span class="lineNum">    1652</span>                 :             :     // (1) Temporary coins from the transactions in subpackage, constructed by m_viewmempool.</span>
<span id="L1653"><span class="lineNum">    1653</span>                 :             :     // (2) Mempool coins from transactions in the mempool, constructed by m_viewmempool.</span>
<span id="L1654"><span class="lineNum">    1654</span>                 :             :     // (3) Confirmed coins fetched from our current UTXO set.</span>
<span id="L1655"><span class="lineNum">    1655</span>                 :             :     //</span>
<span id="L1656"><span class="lineNum">    1656</span>                 :             :     // (1) Temporary coins need to be removed, regardless of whether the transaction was submitted.</span>
<span id="L1657"><span class="lineNum">    1657</span>                 :             :     // If the transaction was submitted to the mempool, m_viewmempool will be able to fetch them from</span>
<span id="L1658"><span class="lineNum">    1658</span>                 :             :     // there. If it wasn't submitted to mempool, it is incorrect to keep them - future calls may try</span>
<span id="L1659"><span class="lineNum">    1659</span>                 :             :     // to spend those coins that don't actually exist.</span>
<span id="L1660"><span class="lineNum">    1660</span>                 :             :     // (2) Mempool coins also need to be removed. If the mempool contents have changed as a result</span>
<span id="L1661"><span class="lineNum">    1661</span>                 :             :     // of submitting or replacing transactions, coins previously fetched from mempool may now be</span>
<span id="L1662"><span class="lineNum">    1662</span>                 :             :     // spent or nonexistent. Those coins need to be deleted from m_view.</span>
<span id="L1663"><span class="lineNum">    1663</span>                 :             :     // (3) Confirmed coins don't need to be removed. The chainstate has not changed (we are</span>
<span id="L1664"><span class="lineNum">    1664</span>                 :             :     // holding cs_main and no blocks have been processed) so the confirmed tx cannot disappear like</span>
<span id="L1665"><span class="lineNum">    1665</span>                 :             :     // a mempool tx can. The coin may now be spent after we submitted a tx to mempool, but</span>
<span id="L1666"><span class="lineNum">    1666</span>                 :             :     // we have already checked that the package does not have 2 transactions spending the same coin</span>
<span id="L1667"><span class="lineNum">    1667</span>                 :             :     // and we check whether a mempool transaction spends conflicting coins (CTxMemPool::GetConflictTx).</span>
<span id="L1668"><span class="lineNum">    1668</span>                 :             :     // Keeping them in m_view is an optimization to not re-fetch confirmed coins if we later look up</span>
<span id="L1669"><span class="lineNum">    1669</span>                 :             :     // inputs for this transaction again.</span>
<span id="L1670"><span class="lineNum">    1670</span>         [<span class="tlaGBC" title="Branch 0 was taken 1316427 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 1383976 times"> + </span>]:<span class="tlaGNC">     2700403 :     for (const auto&amp; outpoint : m_viewmempool.GetNonBaseCoins()) {</span></span>
<span id="L1671"><span class="lineNum">    1671</span>                 :             :         // In addition to resetting m_viewmempool, we also need to manually delete these coins from</span>
<span id="L1672"><span class="lineNum">    1672</span>                 :             :         // m_view because it caches copies of the coins it fetched from m_viewmempool previously.</span>
<span id="L1673"><span class="lineNum">    1673</span>                 :<span class="tlaGNC">     1383976 :         m_view.Uncache(outpoint);</span></span>
<span id="L1674"><span class="lineNum">    1674</span>                 :             :     }</span>
<span id="L1675"><span class="lineNum">    1675</span>                 :             :     // This deletes the temporary and mempool coins.</span>
<span id="L1676"><span class="lineNum">    1676</span>                 :<span class="tlaGNC">     1316427 :     m_viewmempool.Reset();</span></span>
<span id="L1677"><span class="lineNum">    1677</span>                 :<span class="tlaGNC">     1316427 : }</span></span>
<span id="L1678"><span class="lineNum">    1678</span>                 :             : </span>
<span id="L1679"><span class="lineNum">    1679</span>                 :<span class="tlaGNC">      855105 : PackageMempoolAcceptResult MemPoolAccept::AcceptSubPackage(const std::vector&lt;CTransactionRef&gt;&amp; subpackage, ATMPArgs&amp; args)</span></span>
<span id="L1680"><span class="lineNum">    1680</span>                 :             : {</span>
<span id="L1681"><span class="lineNum">    1681</span>                 :<span class="tlaGNC">      855105 :     AssertLockHeld(::cs_main);</span></span>
<span id="L1682"><span class="lineNum">    1682</span>                 :<span class="tlaGNC">      855105 :     AssertLockHeld(m_pool.cs);</span></span>
<span id="L1683"><span class="lineNum">    1683</span>                 :<span class="tlaGNC">     1710210 :     auto result = [&amp;]() EXCLUSIVE_LOCKS_REQUIRED(::cs_main, m_pool.cs) {</span></span>
<span id="L1684"><span class="lineNum">    1684</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 855105 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 83482 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 771623 times"> + </span>]:<span class="tlaGNC">      855105 :         if (subpackage.size() &gt; 1) {</span></span>
<span id="L1685"><span class="lineNum">    1685</span>                 :<span class="tlaGNC">       83482 :             return AcceptMultipleTransactions(subpackage, args);</span></span>
<span id="L1686"><span class="lineNum">    1686</span>                 :             :         }</span>
<span id="L1687"><span class="lineNum">    1687</span>                 :<span class="tlaGNC">      771623 :         const auto&amp; tx = subpackage.front();</span></span>
<span id="L1688"><span class="lineNum">    1688</span>                 :<span class="tlaGNC">      771623 :         ATMPArgs single_args = ATMPArgs::SingleInPackageAccept(args);</span></span>
<span id="L1689"><span class="lineNum">    1689</span>                 :<span class="tlaGNC">      771623 :         const auto single_res = AcceptSingleTransaction(tx, single_args);</span></span>
<span id="L1690"><span class="lineNum">    1690</span>         [<span class="tlaGBC" title="Branch 0 was taken 680791 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 90832 times"> + </span>]:<span class="tlaGNC">      771623 :         PackageValidationState package_state_wrapped;</span></span>
<span id="L1691"><span class="lineNum">    1691</span>         [<span class="tlaGBC" title="Branch 0 was taken 680791 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 90832 times"> + </span>]:<span class="tlaGNC">      771623 :         if (single_res.m_result_type != MempoolAcceptResult::ResultType::VALID) {</span></span>
<span id="L1692"><span class="lineNum">    1692</span>   [<span class="tlaGBC" title="Branch 0 was taken 680791 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 680791 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">     1361582 :             package_state_wrapped.Invalid(PackageValidationResult::PCKG_TX, &quot;transaction failed&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 680791 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L1693"><span class="lineNum">    1693</span>                 :             :         }</span>
<span id="L1694"><span class="lineNum">    1694</span>   [<span class="tlaGBC" title="Branch 0 was taken 771623 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 771623 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 771623 times"> + </span> :<span class="tlaGNC">     3086492 :         return PackageMempoolAcceptResult(package_state_wrapped, {{tx-&gt;GetWitnessHash(), single_res}});</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L1695"><span class="lineNum">    1695</span>   [<span class="tlaGBC" title="Branch 0 was taken 771623 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 771623 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">     3169974 :     }();</span></span>
<span id="L1696"><span class="lineNum">    1696</span>                 :             : </span>
<span id="L1697"><span class="lineNum">    1697</span>                 :             :     // Clean up m_view and m_viewmempool so that other subpackage evaluations don't have access to</span>
<span id="L1698"><span class="lineNum">    1698</span>                 :             :     // coins they shouldn't. Keep some coins in order to minimize re-fetching coins from the UTXO set.</span>
<span id="L1699"><span class="lineNum">    1699</span>                 :             :     // Clean up package feerate and rbf calculations</span>
<span id="L1700"><span class="lineNum">    1700</span>         [<span class="tlaGBC" title="Branch 0 was taken 855105 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      855105 :     ClearSubPackageState();</span></span>
<span id="L1701"><span class="lineNum">    1701</span>                 :             : </span>
<span id="L1702"><span class="lineNum">    1702</span>                 :<span class="tlaGNC">      855105 :     return result;</span></span>
<span id="L1703"><span class="lineNum">    1703</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L1704"><span class="lineNum">    1704</span>                 :             : </span>
<span id="L1705"><span class="lineNum">    1705</span>                 :<span class="tlaGNC">      517434 : PackageMempoolAcceptResult MemPoolAccept::AcceptPackage(const Package&amp; package, ATMPArgs&amp; args)</span></span>
<span id="L1706"><span class="lineNum">    1706</span>                 :             : {</span>
<span id="L1707"><span class="lineNum">    1707</span>                 :<span class="tlaGNC">      517434 :     Assert(!package.empty());</span></span>
<span id="L1708"><span class="lineNum">    1708</span>                 :<span class="tlaGNC">      517434 :     AssertLockHeld(cs_main);</span></span>
<span id="L1709"><span class="lineNum">    1709</span>                 :             :     // Used if returning a PackageMempoolAcceptResult directly from this function.</span>
<span id="L1710"><span class="lineNum">    1710</span>         [<span class="tlaGBC" title="Branch 0 was taken 517434 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      517434 :     PackageValidationState package_state_quit_early;</span></span>
<span id="L1711"><span class="lineNum">    1711</span>                 :             : </span>
<span id="L1712"><span class="lineNum">    1712</span>                 :             :     // There are two topologies we are able to handle through this function:</span>
<span id="L1713"><span class="lineNum">    1713</span>                 :             :     // (1) A single transaction</span>
<span id="L1714"><span class="lineNum">    1714</span>                 :             :     // (2) A child-with-parents package.</span>
<span id="L1715"><span class="lineNum">    1715</span>                 :             :     // Check that the package is well-formed. If it isn't, we won't try to validate any of the</span>
<span id="L1716"><span class="lineNum">    1716</span>                 :             :     // transactions and thus won't return any MempoolAcceptResults, just a package-wide error.</span>
<span id="L1717"><span class="lineNum">    1717</span>                 :             : </span>
<span id="L1718"><span class="lineNum">    1718</span>                 :             :     // Context-free package checks.</span>
<span id="L1719"><span class="lineNum">    1719</span>   [<span class="tlaGBC" title="Branch 0 was taken 517434 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 100790 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 416644 times"> + </span>]:<span class="tlaGNC">      517434 :     if (!IsWellFormedPackage(package, package_state_quit_early, /*require_sorted=*/true)) {</span></span>
<span id="L1720"><span class="lineNum">    1720</span>   [<span class="tlaGBC" title="Branch 0 was taken 100790 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 100790 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      302370 :         return PackageMempoolAcceptResult(package_state_quit_early, {});</span></span>
<span id="L1721"><span class="lineNum">    1721</span>                 :             :     }</span>
<span id="L1722"><span class="lineNum">    1722</span>                 :             : </span>
<span id="L1723"><span class="lineNum">    1723</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 416644 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 275004 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 141640 times"> + </span> :<span class="tlaGNC">      416644 :     if (package.size() &gt; 1 &amp;&amp; !IsChildWithParents(package)) {</span></span>
<span class="lineNum">        </span>    <span class="tlaGBC" title="Branch 4 was taken 275004 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaGBC" title="Branch 6 was taken 10928 times"> + </span><span class="tlaGBC" title="Branch 7 was taken 264076 times"> + </span>]
<span id="L1724"><span class="lineNum">    1724</span>                 :             :         // All transactions in the package must be a parent of the last transaction. This is just an</span>
<span id="L1725"><span class="lineNum">    1725</span>                 :             :         // opportunity for us to fail fast on a context-free check without taking the mempool lock.</span>
<span id="L1726"><span class="lineNum">    1726</span>   [<span class="tlaGBC" title="Branch 0 was taken 10928 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 10928 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">       21856 :         package_state_quit_early.Invalid(PackageValidationResult::PCKG_POLICY, &quot;package-not-child-with-parents&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 10928 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L1727"><span class="lineNum">    1727</span>   [<span class="tlaGBC" title="Branch 0 was taken 10928 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 10928 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">       32784 :         return PackageMempoolAcceptResult(package_state_quit_early, {});</span></span>
<span id="L1728"><span class="lineNum">    1728</span>                 :             :     }</span>
<span id="L1729"><span class="lineNum">    1729</span>                 :             : </span>
<span id="L1730"><span class="lineNum">    1730</span>         [<span class="tlaGBC" title="Branch 0 was taken 405716 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      405716 :     LOCK(m_pool.cs);</span></span>
<span id="L1731"><span class="lineNum">    1731</span>                 :             :     // Stores results from which we will create the returned PackageMempoolAcceptResult.</span>
<span id="L1732"><span class="lineNum">    1732</span>                 :             :     // A result may be changed if a mempool transaction is evicted later due to LimitMempoolSize().</span>
<span id="L1733"><span class="lineNum">    1733</span>                 :<span class="tlaGNC">      405716 :     std::map&lt;Wtxid, MempoolAcceptResult&gt; results_final;</span></span>
<span id="L1734"><span class="lineNum">    1734</span>                 :             :     // Results from individual validation which will be returned if no other result is available for</span>
<span id="L1735"><span class="lineNum">    1735</span>                 :             :     // this transaction. &quot;Nonfinal&quot; because if a transaction fails by itself but succeeds later</span>
<span id="L1736"><span class="lineNum">    1736</span>                 :             :     // (i.e. when evaluated with a fee-bumping child), the result in this map may be discarded.</span>
<span id="L1737"><span class="lineNum">    1737</span>                 :<span class="tlaGNC">      405716 :     std::map&lt;Wtxid, MempoolAcceptResult&gt; individual_results_nonfinal;</span></span>
<span id="L1738"><span class="lineNum">    1738</span>                 :             :     // Tracks whether we think package submission could result in successful entry to the mempool</span>
<span id="L1739"><span class="lineNum">    1739</span>                 :<span class="tlaGNC">      405716 :     bool quit_early{false};</span></span>
<span id="L1740"><span class="lineNum">    1740</span>                 :<span class="tlaGNC">      405716 :     std::vector&lt;CTransactionRef&gt; txns_package_eval;</span></span>
<span id="L1741"><span class="lineNum">    1741</span>         [<span class="tlaGBC" title="Branch 0 was taken 795271 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 405716 times"> + </span>]:<span class="tlaGNC">     1200987 :     for (const auto&amp; tx : package) {</span></span>
<span id="L1742"><span class="lineNum">    1742</span>         [<span class="tlaGBC" title="Branch 0 was taken 795271 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      795271 :         const auto&amp; wtxid = tx-&gt;GetWitnessHash();</span></span>
<span id="L1743"><span class="lineNum">    1743</span>         [<span class="tlaGBC" title="Branch 0 was taken 795271 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      795271 :         const auto&amp; txid = tx-&gt;GetHash();</span></span>
<span id="L1744"><span class="lineNum">    1744</span>                 :             :         // There are 3 possibilities: already in mempool, same-txid-diff-wtxid already in mempool,</span>
<span id="L1745"><span class="lineNum">    1745</span>                 :             :         // or not in mempool. An already confirmed tx is treated as one not in mempool, because all</span>
<span id="L1746"><span class="lineNum">    1746</span>                 :             :         // we know is that the inputs aren't available.</span>
<span id="L1747"><span class="lineNum">    1747</span>   [<span class="tlaGBC" title="Branch 0 was taken 795271 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 25819 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 769452 times"> + </span>]:<span class="tlaGNC">      795271 :         if (m_pool.exists(wtxid)) {</span></span>
<span id="L1748"><span class="lineNum">    1748</span>                 :             :             // Exact transaction already exists in the mempool.</span>
<span id="L1749"><span class="lineNum">    1749</span>                 :             :             // Node operators are free to set their mempool policies however they please, nodes may receive</span>
<span id="L1750"><span class="lineNum">    1750</span>                 :             :             // transactions in different orders, and malicious counterparties may try to take advantage of</span>
<span id="L1751"><span class="lineNum">    1751</span>                 :             :             // policy differences to pin or delay propagation of transactions. As such, it's possible for</span>
<span id="L1752"><span class="lineNum">    1752</span>                 :             :             // some package transaction(s) to already be in the mempool, and we don't want to reject the</span>
<span id="L1753"><span class="lineNum">    1753</span>                 :             :             // entire package in that case (as that could be a censorship vector). De-duplicate the</span>
<span id="L1754"><span class="lineNum">    1754</span>                 :             :             // transactions that are already in the mempool, and only call AcceptMultipleTransactions() with</span>
<span id="L1755"><span class="lineNum">    1755</span>                 :             :             // the new transactions. This ensures we don't double-count transaction counts and sizes when</span>
<span id="L1756"><span class="lineNum">    1756</span>                 :             :             // checking ancestor/descendant limits, or double-count transaction fees for fee-related policy.</span>
<span id="L1757"><span class="lineNum">    1757</span>   [<span class="tlaGBC" title="Branch 0 was taken 25819 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 25819 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">       25819 :             const auto&amp; entry{*Assert(m_pool.GetEntry(txid))};</span></span>
<span id="L1758"><span class="lineNum">    1758</span>   [<span class="tlaGBC" title="Branch 0 was taken 25819 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 25819 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">       25819 :             results_final.emplace(wtxid, MempoolAcceptResult::MempoolTx(entry.GetTxSize(), entry.GetFee()));</span></span>
<span id="L1759"><span class="lineNum">    1759</span>   [<span class="tlaGBC" title="Branch 0 was taken 769452 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 888 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 768564 times"> + </span>]:<span class="tlaGNC">      769452 :         } else if (m_pool.exists(txid)) {</span></span>
<span id="L1760"><span class="lineNum">    1760</span>                 :             :             // Transaction with the same non-witness data but different witness (same txid,</span>
<span id="L1761"><span class="lineNum">    1761</span>                 :             :             // different wtxid) already exists in the mempool.</span>
<span id="L1762"><span class="lineNum">    1762</span>                 :             :             //</span>
<span id="L1763"><span class="lineNum">    1763</span>                 :             :             // We don't allow replacement transactions right now, so just swap the package</span>
<span id="L1764"><span class="lineNum">    1764</span>                 :             :             // transaction for the mempool one. Note that we are ignoring the validity of the</span>
<span id="L1765"><span class="lineNum">    1765</span>                 :             :             // package transaction passed in.</span>
<span id="L1766"><span class="lineNum">    1766</span>                 :             :             // TODO: allow witness replacement in packages.</span>
<span id="L1767"><span class="lineNum">    1767</span>   [<span class="tlaGBC" title="Branch 0 was taken 888 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 888 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">         888 :             const auto&amp; entry{*Assert(m_pool.GetEntry(txid))};</span></span>
<span id="L1768"><span class="lineNum">    1768</span>                 :             :             // Provide the wtxid of the mempool tx so that the caller can look it up in the mempool.</span>
<span id="L1769"><span class="lineNum">    1769</span>         [<span class="tlaGBC" title="Branch 0 was taken 888 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">         888 :             results_final.emplace(wtxid, MempoolAcceptResult::MempoolTxDifferentWitness(entry.GetTx().GetWitnessHash()));</span></span>
<span id="L1770"><span class="lineNum">    1770</span>                 :             :         } else {</span>
<span id="L1771"><span class="lineNum">    1771</span>                 :             :             // Transaction does not already exist in the mempool.</span>
<span id="L1772"><span class="lineNum">    1772</span>                 :             :             // Try submitting the transaction on its own.</span>
<span id="L1773"><span class="lineNum">    1773</span>   [<span class="tlaGBC" title="Branch 0 was taken 768564 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 768564 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 768564 times"> + </span> :<span class="tlaGNC">     1537128 :             const auto single_package_res = AcceptSubPackage({tx}, args);</span></span>
<span class="lineNum">        </span> <span class="tlaGBC" title="Branch 4 was taken 768564 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaUNC" title="Branch 6 was not taken"> - </span><span class="tlaUNC" title="Branch 7 was not taken"> - </span><span class="tlaUNC" title="Branch 8 was not taken"> - </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not taken"> - </span>]
<span id="L1774"><span class="lineNum">    1774</span>         [<span class="tlaGBC" title="Branch 0 was taken 768564 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      768564 :             const auto&amp; single_res = single_package_res.m_tx_results.at(wtxid);</span></span>
<span id="L1775"><span class="lineNum">    1775</span>         [<span class="tlaGBC" title="Branch 0 was taken 90832 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 677732 times"> + </span>]:<span class="tlaGNC">      768564 :             if (single_res.m_result_type == MempoolAcceptResult::ResultType::VALID) {</span></span>
<span id="L1776"><span class="lineNum">    1776</span>                 :             :                 // The transaction succeeded on its own and is now in the mempool. Don't include it</span>
<span id="L1777"><span class="lineNum">    1777</span>                 :             :                 // in package validation, because its fees should only be &quot;used&quot; once.</span>
<span id="L1778"><span class="lineNum">    1778</span>   [<span class="tlaGBC" title="Branch 0 was taken 90832 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 90832 times"> + </span>]:<span class="tlaGNC">       90832 :                 assert(m_pool.exists(wtxid));</span></span>
<span id="L1779"><span class="lineNum">    1779</span>         [<span class="tlaGBC" title="Branch 0 was taken 90832 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       90832 :                 results_final.emplace(wtxid, single_res);</span></span>
<span id="L1780"><span class="lineNum">    1780</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 677732 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 561259 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 116473 times"> + </span> :<span class="tlaGNC">      677732 :             } else if (package.size() == 1 || // If there is only one transaction, no need to retry it &quot;as a package&quot;</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 424113 times"> + </span><span class="tlaGBC" title="Branch 5 was taken 137146 times"> + </span>]
<span id="L1781"><span class="lineNum">    1781</span>         [<span class="tlaGBC" title="Branch 0 was taken 424113 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 137146 times"> + </span>]:<span class="tlaGNC">      561259 :                        (single_res.m_state.GetResult() != TxValidationResult::TX_RECONSIDERABLE &amp;&amp;</span></span>
<span id="L1782"><span class="lineNum">    1782</span>         [<span class="tlaGBC" title="Branch 0 was taken 237378 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 186735 times"> + </span>]:<span class="tlaGNC">      424113 :                        single_res.m_state.GetResult() != TxValidationResult::TX_MISSING_INPUTS)) {</span></span>
<span id="L1783"><span class="lineNum">    1783</span>                 :             :                 // Package validation policy only differs from individual policy in its evaluation</span>
<span id="L1784"><span class="lineNum">    1784</span>                 :             :                 // of feerate. For example, if a transaction fails here due to violation of a</span>
<span id="L1785"><span class="lineNum">    1785</span>                 :             :                 // consensus rule, the result will not change when it is submitted as part of a</span>
<span id="L1786"><span class="lineNum">    1786</span>                 :             :                 // package. To minimize the amount of repeated work, unless the transaction fails</span>
<span id="L1787"><span class="lineNum">    1787</span>                 :             :                 // due to feerate or missing inputs (its parent is a previous transaction in the</span>
<span id="L1788"><span class="lineNum">    1788</span>                 :             :                 // package that failed due to feerate), don't run package validation. Note that this</span>
<span id="L1789"><span class="lineNum">    1789</span>                 :             :                 // decision might not make sense if different types of packages are allowed in the</span>
<span id="L1790"><span class="lineNum">    1790</span>                 :             :                 // future.  Continue individually validating the rest of the transactions, because</span>
<span id="L1791"><span class="lineNum">    1791</span>                 :             :                 // some of them may still be valid.</span>
<span id="L1792"><span class="lineNum">    1792</span>                 :<span class="tlaGNC">      353851 :                 quit_early = true;</span></span>
<span id="L1793"><span class="lineNum">    1793</span>   [<span class="tlaGBC" title="Branch 0 was taken 353851 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 353851 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      707702 :                 package_state_quit_early.Invalid(PackageValidationResult::PCKG_TX, &quot;transaction failed&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 353851 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L1794"><span class="lineNum">    1794</span>         [<span class="tlaGBC" title="Branch 0 was taken 353851 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      353851 :                 individual_results_nonfinal.emplace(wtxid, single_res);</span></span>
<span id="L1795"><span class="lineNum">    1795</span>                 :             :             } else {</span>
<span id="L1796"><span class="lineNum">    1796</span>         [<span class="tlaGBC" title="Branch 0 was taken 323881 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      323881 :                 individual_results_nonfinal.emplace(wtxid, single_res);</span></span>
<span id="L1797"><span class="lineNum">    1797</span>         [<span class="tlaGBC" title="Branch 0 was taken 323881 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      323881 :                 txns_package_eval.push_back(tx);</span></span>
<span id="L1798"><span class="lineNum">    1798</span>                 :             :             }</span>
<span id="L1799"><span class="lineNum">    1799</span>                 :<span class="tlaGNC">      768564 :         }</span></span>
<span id="L1800"><span class="lineNum">    1800</span>                 :             :     }</span>
<span id="L1801"><span class="lineNum">    1801</span>                 :             : </span>
<span id="L1802"><span class="lineNum">    1802</span>   [<span class="tlaGBC" title="Branch 0 was taken 128115 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 277601 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 41574 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 86541 times"> + </span> :<span class="tlaGNC">     1130607 :     auto multi_submission_result = quit_early || txns_package_eval.empty() ? PackageMempoolAcceptResult(package_state_quit_early, {}) :</span></span>
<span class="lineNum">        </span> <span class="tlaGBC" title="Branch 4 was taken 319175 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaGBC" title="Branch 6 was taken 86541 times"> + </span><span class="tlaGBC" title="Branch 7 was taken 319175 times"> + </span><span class="tlaUNC" title="Branch 8 was not taken"> - </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not taken"> - </span>]
<span id="L1803"><span class="lineNum">    1803</span>   [<span class="tlaGBC" title="Branch 0 was taken 319175 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 319175 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      724891 :         AcceptSubPackage(txns_package_eval, args);</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 86541 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L1804"><span class="lineNum">    1804</span>                 :<span class="tlaGNC">      405716 :     PackageValidationState&amp; package_state_final = multi_submission_result.m_state;</span></span>
<span id="L1805"><span class="lineNum">    1805</span>                 :             : </span>
<span id="L1806"><span class="lineNum">    1806</span>                 :             :     // This is invoked by AcceptSubPackage() already, so this is just here for</span>
<span id="L1807"><span class="lineNum">    1807</span>                 :             :     // clarity (since it's not permitted to invoke LimitMempoolSize() while a</span>
<span id="L1808"><span class="lineNum">    1808</span>                 :             :     // changeset is outstanding).</span>
<span id="L1809"><span class="lineNum">    1809</span>         [<span class="tlaGBC" title="Branch 0 was taken 405716 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      405716 :     ClearSubPackageState();</span></span>
<span id="L1810"><span class="lineNum">    1810</span>                 :             : </span>
<span id="L1811"><span class="lineNum">    1811</span>                 :             :     // Make sure we haven't exceeded max mempool size.</span>
<span id="L1812"><span class="lineNum">    1812</span>                 :             :     // Package transactions that were submitted to mempool or already in mempool may be evicted.</span>
<span id="L1813"><span class="lineNum">    1813</span>                 :             :     // If mempool contents change, then the m_view cache is dirty. It has already been cleared above.</span>
<span id="L1814"><span class="lineNum">    1814</span>   [<span class="tlaGBC" title="Branch 0 was taken 405716 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 405716 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      405716 :     LimitMempoolSize(m_pool, m_active_chainstate.CoinsTip());</span></span>
<span id="L1815"><span class="lineNum">    1815</span>                 :             : </span>
<span id="L1816"><span class="lineNum">    1816</span>         [<span class="tlaGBC" title="Branch 0 was taken 795271 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 405716 times"> + </span>]:<span class="tlaGNC">     1200987 :     for (const auto&amp; tx : package) {</span></span>
<span id="L1817"><span class="lineNum">    1817</span>                 :<span class="tlaGNC">      795271 :         const auto&amp; wtxid = tx-&gt;GetWitnessHash();</span></span>
<span id="L1818"><span class="lineNum">    1818</span>         [<span class="tlaGBC" title="Branch 0 was taken 38642 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 756629 times"> + </span>]:<span class="tlaGNC">      795271 :         if (multi_submission_result.m_tx_results.count(wtxid) &gt; 0) {</span></span>
<span id="L1819"><span class="lineNum">    1819</span>                 :             :             // We shouldn't have re-submitted if the tx result was already in results_final.</span>
<span id="L1820"><span class="lineNum">    1820</span>         [<span class="tlaGBC" title="Branch 0 was taken 38642 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       38642 :             Assume(results_final.count(wtxid) == 0);</span></span>
<span id="L1821"><span class="lineNum">    1821</span>                 :             :             // If it was submitted, check to see if the tx is still in the mempool. It could have</span>
<span id="L1822"><span class="lineNum">    1822</span>                 :             :             // been evicted due to LimitMempoolSize() above.</span>
<span id="L1823"><span class="lineNum">    1823</span>         [<span class="tlaGBC" title="Branch 0 was taken 38642 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       38642 :             const auto&amp; txresult = multi_submission_result.m_tx_results.at(wtxid);</span></span>
<span id="L1824"><span class="lineNum">    1824</span>   [<span class="tlaGBC" title="Branch 0 was taken 7588 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 31054 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 7588 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">       38642 :             if (txresult.m_result_type == MempoolAcceptResult::ResultType::VALID &amp;&amp; !m_pool.exists(wtxid)) {</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 2800 times"> + </span><span class="tlaGBC" title="Branch 5 was taken 4788 times"> + </span>]
<span id="L1825"><span class="lineNum">    1825</span>   [<span class="tlaGBC" title="Branch 0 was taken 4788 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 4788 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">        9576 :                 package_state_final.Invalid(PackageValidationResult::PCKG_TX, &quot;transaction failed&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 4788 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L1826"><span class="lineNum">    1826</span>         [<span class="tlaGBC" title="Branch 0 was taken 4788 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        4788 :                 TxValidationState mempool_full_state;</span></span>
<span id="L1827"><span class="lineNum">    1827</span>   [<span class="tlaGBC" title="Branch 0 was taken 4788 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 4788 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">        9576 :                 mempool_full_state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, &quot;mempool full&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 4788 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L1828"><span class="lineNum">    1828</span>   [<span class="tlaGBC" title="Branch 0 was taken 4788 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 4788 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">        9576 :                 results_final.emplace(wtxid, MempoolAcceptResult::Failure(mempool_full_state));</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 4788 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L1829"><span class="lineNum">    1829</span>                 :<span class="tlaGNC">        4788 :             } else {</span></span>
<span id="L1830"><span class="lineNum">    1830</span>         [<span class="tlaGBC" title="Branch 0 was taken 33854 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       33854 :                 results_final.emplace(wtxid, txresult);</span></span>
<span id="L1831"><span class="lineNum">    1831</span>                 :             :             }</span>
<span id="L1832"><span class="lineNum">    1832</span>         [<span class="tlaGBC" title="Branch 0 was taken 117539 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 639090 times"> + </span>]:<span class="tlaGNC">      756629 :         } else if (const auto it{results_final.find(wtxid)}; it != results_final.end()) {</span></span>
<span id="L1833"><span class="lineNum">    1833</span>                 :             :             // Already-in-mempool transaction. Check to see if it's still there, as it could have</span>
<span id="L1834"><span class="lineNum">    1834</span>                 :             :             // been evicted when LimitMempoolSize() was called.</span>
<span id="L1835"><span class="lineNum">    1835</span>         [<span class="tlaGBC" title="Branch 0 was taken 117539 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      117539 :             Assume(it-&gt;second.m_result_type != MempoolAcceptResult::ResultType::INVALID);</span></span>
<span id="L1836"><span class="lineNum">    1836</span>         [<span class="tlaGBC" title="Branch 0 was taken 117539 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      117539 :             Assume(individual_results_nonfinal.count(wtxid) == 0);</span></span>
<span id="L1837"><span class="lineNum">    1837</span>                 :             :             // Query by txid to include the same-txid-different-witness ones.</span>
<span id="L1838"><span class="lineNum">    1838</span>   [<span class="tlaGBC" title="Branch 0 was taken 117539 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 4477 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 113062 times"> + </span>]:<span class="tlaGNC">      117539 :             if (!m_pool.exists(tx-&gt;GetHash())) {</span></span>
<span id="L1839"><span class="lineNum">    1839</span>   [<span class="tlaGBC" title="Branch 0 was taken 4477 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 4477 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">        8954 :                 package_state_final.Invalid(PackageValidationResult::PCKG_TX, &quot;transaction failed&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 4477 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L1840"><span class="lineNum">    1840</span>         [<span class="tlaGBC" title="Branch 0 was taken 4477 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        4477 :                 TxValidationState mempool_full_state;</span></span>
<span id="L1841"><span class="lineNum">    1841</span>   [<span class="tlaGBC" title="Branch 0 was taken 4477 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 4477 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">        8954 :                 mempool_full_state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, &quot;mempool full&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 4477 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L1842"><span class="lineNum">    1842</span>                 :             :                 // Replace the previous result.</span>
<span id="L1843"><span class="lineNum">    1843</span>                 :<span class="tlaGNC">        4477 :                 results_final.erase(wtxid);</span></span>
<span id="L1844"><span class="lineNum">    1844</span>   [<span class="tlaGBC" title="Branch 0 was taken 4477 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 4477 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">        8954 :                 results_final.emplace(wtxid, MempoolAcceptResult::Failure(mempool_full_state));</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 4477 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L1845"><span class="lineNum">    1845</span>                 :<span class="tlaGNC">        4477 :             }</span></span>
<span id="L1846"><span class="lineNum">    1846</span>         [<span class="tlaGBC" title="Branch 0 was taken 639090 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      639090 :         } else if (const auto it{individual_results_nonfinal.find(wtxid)}; it != individual_results_nonfinal.end()) {</span></span>
<span id="L1847"><span class="lineNum">    1847</span>         [<span class="tlaGBC" title="Branch 0 was taken 639090 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      639090 :             Assume(it-&gt;second.m_result_type == MempoolAcceptResult::ResultType::INVALID);</span></span>
<span id="L1848"><span class="lineNum">    1848</span>                 :             :             // Interesting result from previous processing.</span>
<span id="L1849"><span class="lineNum">    1849</span>         [<span class="tlaGBC" title="Branch 0 was taken 639090 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      639090 :             results_final.emplace(wtxid, it-&gt;second);</span></span>
<span id="L1850"><span class="lineNum">    1850</span>                 :             :         }</span>
<span id="L1851"><span class="lineNum">    1851</span>                 :             :     }</span>
<span id="L1852"><span class="lineNum">    1852</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 405716 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 405716 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      405716 :     Assume(results_final.size() == package.size());</span></span>
<span id="L1853"><span class="lineNum">    1853</span>   [<span class="tlaGBC" title="Branch 0 was taken 405716 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 405716 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      811432 :     return PackageMempoolAcceptResult(package_state_final, std::move(results_final));</span></span>
<span id="L1854"><span class="lineNum">    1854</span>   [<span class="tlaGBC" title="Branch 0 was taken 768564 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 768564 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">     2865994 : }</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 405716 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L1855"><span class="lineNum">    1855</span>                 :             : </span>
<span id="L1856"><span class="lineNum">    1856</span>                 :             : } // anon namespace</span>
<span id="L1857"><span class="lineNum">    1857</span>                 :             : </span>
<span id="L1858"><span class="lineNum">    1858</span>                 :<span class="tlaGNC">     1650825 : MempoolAcceptResult AcceptToMemoryPool(Chainstate&amp; active_chainstate, const CTransactionRef&amp; tx,</span></span>
<span id="L1859"><span class="lineNum">    1859</span>                 :             :                                        int64_t accept_time, bool bypass_limits, bool test_accept)</span>
<span id="L1860"><span class="lineNum">    1860</span>                 :             : {</span>
<span id="L1861"><span class="lineNum">    1861</span>                 :<span class="tlaGNC">     1650825 :     AssertLockHeld(::cs_main);</span></span>
<span id="L1862"><span class="lineNum">    1862</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 1650825 times"> + </span>]:<span class="tlaGNC">     1650825 :     const CChainParams&amp; chainparams{active_chainstate.m_chainman.GetParams()};</span></span>
<span id="L1863"><span class="lineNum">    1863</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 1650825 times"> + </span>]:<span class="tlaGNC">     1650825 :     assert(active_chainstate.GetMempool() != nullptr);</span></span>
<span id="L1864"><span class="lineNum">    1864</span>                 :<span class="tlaGNC">     1650825 :     CTxMemPool&amp; pool{*active_chainstate.GetMempool()};</span></span>
<span id="L1865"><span class="lineNum">    1865</span>                 :             : </span>
<span id="L1866"><span class="lineNum">    1866</span>                 :<span class="tlaGNC">     1650825 :     std::vector&lt;COutPoint&gt; coins_to_uncache;</span></span>
<span id="L1867"><span class="lineNum">    1867</span>         [<span class="tlaGBC" title="Branch 0 was taken 1650825 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">     1650825 :     auto args = MemPoolAccept::ATMPArgs::SingleAccept(chainparams, accept_time, bypass_limits, coins_to_uncache, test_accept);</span></span>
<span id="L1868"><span class="lineNum">    1868</span>   [<span class="tlaGBC" title="Branch 0 was taken 1650825 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 1650825 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">     1650825 :     MempoolAcceptResult result = MemPoolAccept(pool, active_chainstate).AcceptSingleTransaction(tx, args);</span></span>
<span id="L1869"><span class="lineNum">    1869</span>         [<span class="tlaGBC" title="Branch 0 was taken 1514746 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 136079 times"> + </span>]:<span class="tlaGNC">     1650825 :     if (result.m_result_type != MempoolAcceptResult::ResultType::VALID) {</span></span>
<span id="L1870"><span class="lineNum">    1870</span>                 :             :         // Remove coins that were not present in the coins cache before calling</span>
<span id="L1871"><span class="lineNum">    1871</span>                 :             :         // AcceptSingleTransaction(); this is to prevent memory DoS in case we receive a large</span>
<span id="L1872"><span class="lineNum">    1872</span>                 :             :         // number of invalid transactions that attempt to overrun the in-memory coins cache</span>
<span id="L1873"><span class="lineNum">    1873</span>                 :             :         // (`CCoinsViewCache::cacheCoins`).</span>
<span id="L1874"><span class="lineNum">    1874</span>                 :             : </span>
<span id="L1875"><span class="lineNum">    1875</span>         [<span class="tlaGBC" title="Branch 0 was taken 2694313 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 1514746 times"> + </span>]:<span class="tlaGNC">     4209059 :         for (const COutPoint&amp; hashTx : coins_to_uncache)</span></span>
<span id="L1876"><span class="lineNum">    1876</span>   [<span class="tlaGBC" title="Branch 0 was taken 2694313 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 2694313 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">     2694313 :             active_chainstate.CoinsTip().Uncache(hashTx);</span></span>
<span id="L1877"><span class="lineNum">    1877</span>                 :             :         TRACEPOINT(mempool, rejected,</span>
<span id="L1878"><span class="lineNum">    1878</span>                 :             :                 tx-&gt;GetHash().data(),</span>
<span id="L1879"><span class="lineNum">    1879</span>                 :             :                 result.m_state.GetRejectReason().c_str()</span>
<span id="L1880"><span class="lineNum">    1880</span>                 :             :         );</span>
<span id="L1881"><span class="lineNum">    1881</span>                 :             :     }</span>
<span id="L1882"><span class="lineNum">    1882</span>                 :             :     // After we've (potentially) uncached entries, ensure our coins cache is still within its size limits</span>
<span id="L1883"><span class="lineNum">    1883</span>         [<span class="tlaGBC" title="Branch 0 was taken 1650825 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">     1650825 :     BlockValidationState state_dummy;</span></span>
<span id="L1884"><span class="lineNum">    1884</span>         [<span class="tlaGBC" title="Branch 0 was taken 1650825 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">     1650825 :     active_chainstate.FlushStateToDisk(state_dummy, FlushStateMode::PERIODIC);</span></span>
<span id="L1885"><span class="lineNum">    1885</span>                 :<span class="tlaGNC">     1650825 :     return result;</span></span>
<span id="L1886"><span class="lineNum">    1886</span>                 :<span class="tlaGNC">     1650825 : }</span></span>
<span id="L1887"><span class="lineNum">    1887</span>                 :             : </span>
<span id="L1888"><span class="lineNum">    1888</span>                 :<span class="tlaGNC">      831731 : PackageMempoolAcceptResult ProcessNewPackage(Chainstate&amp; active_chainstate, CTxMemPool&amp; pool,</span></span>
<span id="L1889"><span class="lineNum">    1889</span>                 :             :                                                    const Package&amp; package, bool test_accept, const std::optional&lt;CFeeRate&gt;&amp; client_maxfeerate)</span>
<span id="L1890"><span class="lineNum">    1890</span>                 :             : {</span>
<span id="L1891"><span class="lineNum">    1891</span>                 :<span class="tlaGNC">      831731 :     AssertLockHeld(cs_main);</span></span>
<span id="L1892"><span class="lineNum">    1892</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 831731 times"> + </span>]:<span class="tlaGNC">      831731 :     assert(!package.empty());</span></span>
<span id="L1893"><span class="lineNum">    1893</span>   [<span class="tlaGBC" title="Branch 0 was taken 1998435 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 831731 times"> + </span>]:<span class="tlaGNC">     2830166 :     assert(std::all_of(package.cbegin(), package.cend(), [](const auto&amp; tx){return tx != nullptr;}));</span></span>
<span id="L1894"><span class="lineNum">    1894</span>                 :             : </span>
<span id="L1895"><span class="lineNum">    1895</span>                 :<span class="tlaGNC">      831731 :     std::vector&lt;COutPoint&gt; coins_to_uncache;</span></span>
<span id="L1896"><span class="lineNum">    1896</span>         [<span class="tlaGBC" title="Branch 0 was taken 831731 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      831731 :     const CChainParams&amp; chainparams = active_chainstate.m_chainman.GetParams();</span></span>
<span id="L1897"><span class="lineNum">    1897</span>                 :<span class="tlaGNC">     1663462 :     auto result = [&amp;]() EXCLUSIVE_LOCKS_REQUIRED(cs_main) {</span></span>
<span id="L1898"><span class="lineNum">    1898</span>                 :<span class="tlaGNC">      831731 :         AssertLockHeld(cs_main);</span></span>
<span id="L1899"><span class="lineNum">    1899</span>         [<span class="tlaGBC" title="Branch 0 was taken 314297 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 517434 times"> + </span>]:<span class="tlaGNC">      831731 :         if (test_accept) {</span></span>
<span id="L1900"><span class="lineNum">    1900</span>                 :<span class="tlaGNC">      314297 :             auto args = MemPoolAccept::ATMPArgs::PackageTestAccept(chainparams, GetTime(), coins_to_uncache);</span></span>
<span id="L1901"><span class="lineNum">    1901</span>         [<span class="tlaGBC" title="Branch 0 was taken 314297 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      314297 :             return MemPoolAccept(pool, active_chainstate).AcceptMultipleTransactions(package, args);</span></span>
<span id="L1902"><span class="lineNum">    1902</span>                 :             :         } else {</span>
<span id="L1903"><span class="lineNum">    1903</span>                 :<span class="tlaGNC">      517434 :             auto args = MemPoolAccept::ATMPArgs::PackageChildWithParents(chainparams, GetTime(), coins_to_uncache, client_maxfeerate);</span></span>
<span id="L1904"><span class="lineNum">    1904</span>         [<span class="tlaGBC" title="Branch 0 was taken 517434 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      517434 :             return MemPoolAccept(pool, active_chainstate).AcceptPackage(package, args);</span></span>
<span id="L1905"><span class="lineNum">    1905</span>                 :             :         }</span>
<span id="L1906"><span class="lineNum">    1906</span>         [<span class="tlaGBC" title="Branch 0 was taken 831731 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      831731 :     }();</span></span>
<span id="L1907"><span class="lineNum">    1907</span>                 :             : </span>
<span id="L1908"><span class="lineNum">    1908</span>                 :             :     // Uncache coins pertaining to transactions that were not submitted to the mempool.</span>
<span id="L1909"><span class="lineNum">    1909</span>   [<span class="tlaGBC" title="Branch 0 was taken 517434 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 314297 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 476335 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 41099 times"> + </span>]:<span class="tlaGNC">      831731 :     if (test_accept || result.m_state.IsInvalid()) {</span></span>
<span id="L1910"><span class="lineNum">    1910</span>         [<span class="tlaGBC" title="Branch 0 was taken 1383634 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 790632 times"> + </span>]:<span class="tlaGNC">     2174266 :         for (const COutPoint&amp; hashTx : coins_to_uncache) {</span></span>
<span id="L1911"><span class="lineNum">    1911</span>   [<span class="tlaGBC" title="Branch 0 was taken 1383634 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 1383634 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">     1383634 :             active_chainstate.CoinsTip().Uncache(hashTx);</span></span>
<span id="L1912"><span class="lineNum">    1912</span>                 :             :         }</span>
<span id="L1913"><span class="lineNum">    1913</span>                 :             :     }</span>
<span id="L1914"><span class="lineNum">    1914</span>                 :             :     // Ensure the coins cache is still within limits.</span>
<span id="L1915"><span class="lineNum">    1915</span>         [<span class="tlaGBC" title="Branch 0 was taken 831731 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      831731 :     BlockValidationState state_dummy;</span></span>
<span id="L1916"><span class="lineNum">    1916</span>         [<span class="tlaGBC" title="Branch 0 was taken 831731 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      831731 :     active_chainstate.FlushStateToDisk(state_dummy, FlushStateMode::PERIODIC);</span></span>
<span id="L1917"><span class="lineNum">    1917</span>                 :<span class="tlaGNC">      831731 :     return result;</span></span>
<span id="L1918"><span class="lineNum">    1918</span>                 :<span class="tlaGNC">      831731 : }</span></span>
<span id="L1919"><span class="lineNum">    1919</span>                 :             : </span>
<span id="L1920"><span class="lineNum">    1920</span>                 :<span class="tlaGNC">      834710 : CAmount GetBlockSubsidy(int nHeight, const Consensus::Params&amp; consensusParams)</span></span>
<span id="L1921"><span class="lineNum">    1921</span>                 :             : {</span>
<span id="L1922"><span class="lineNum">    1922</span>                 :<span class="tlaGNC">      834710 :     int halvings = nHeight / consensusParams.nSubsidyHalvingInterval;</span></span>
<span id="L1923"><span class="lineNum">    1923</span>                 :             :     // Force block reward to zero when right shift is undefined.</span>
<span id="L1924"><span class="lineNum">    1924</span>         [<span class="tlaGBC" title="Branch 0 was taken 834710 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      834710 :     if (halvings &gt;= 64)</span></span>
<span id="L1925"><span class="lineNum">    1925</span>                 :             :         return 0;</span>
<span id="L1926"><span class="lineNum">    1926</span>                 :             : </span>
<span id="L1927"><span class="lineNum">    1927</span>                 :<span class="tlaGNC">      834710 :     CAmount nSubsidy = 50 * COIN;</span></span>
<span id="L1928"><span class="lineNum">    1928</span>                 :             :     // Subsidy is cut in half every 210,000 blocks which will occur approximately every 4 years.</span>
<span id="L1929"><span class="lineNum">    1929</span>                 :<span class="tlaGNC">      834710 :     nSubsidy &gt;&gt;= halvings;</span></span>
<span id="L1930"><span class="lineNum">    1930</span>                 :<span class="tlaGNC">      834710 :     return nSubsidy;</span></span>
<span id="L1931"><span class="lineNum">    1931</span>                 :             : }</span>
<span id="L1932"><span class="lineNum">    1932</span>                 :             : </span>
<span id="L1933"><span class="lineNum">    1933</span>                 :<span class="tlaGNC">        5244 : CoinsViews::CoinsViews(DBParams db_params, CoinsViewOptions options)</span></span>
<span id="L1934"><span class="lineNum">    1934</span>         [<span class="tlaGBC" title="Branch 0 was taken 5244 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        5244 :     : m_dbview{std::move(db_params), std::move(options)},</span></span>
<span id="L1935"><span class="lineNum">    1935</span>         [<span class="tlaGBC" title="Branch 0 was taken 5244 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        5244 :       m_catcherview(&amp;m_dbview) {}</span></span>
<span id="L1936"><span class="lineNum">    1936</span>                 :             : </span>
<span id="L1937"><span class="lineNum">    1937</span>                 :<span class="tlaGNC">        5244 : void CoinsViews::InitCache()</span></span>
<span id="L1938"><span class="lineNum">    1938</span>                 :             : {</span>
<span id="L1939"><span class="lineNum">    1939</span>                 :<span class="tlaGNC">        5244 :     AssertLockHeld(::cs_main);</span></span>
<span id="L1940"><span class="lineNum">    1940</span>                 :<span class="tlaGNC">        5244 :     m_cacheview = std::make_unique&lt;CCoinsViewCache&gt;(&amp;m_catcherview);</span></span>
<span id="L1941"><span class="lineNum">    1941</span>                 :<span class="tlaGNC">        5244 : }</span></span>
<span id="L1942"><span class="lineNum">    1942</span>                 :             : </span>
<span id="L1943"><span class="lineNum">    1943</span>                 :<span class="tlaGNC">        5244 : Chainstate::Chainstate(</span></span>
<span id="L1944"><span class="lineNum">    1944</span>                 :             :     CTxMemPool* mempool,</span>
<span id="L1945"><span class="lineNum">    1945</span>                 :             :     BlockManager&amp; blockman,</span>
<span id="L1946"><span class="lineNum">    1946</span>                 :             :     ChainstateManager&amp; chainman,</span>
<span id="L1947"><span class="lineNum">    1947</span>                 :<span class="tlaGNC">        5244 :     std::optional&lt;uint256&gt; from_snapshot_blockhash)</span></span>
<span id="L1948"><span class="lineNum">    1948</span>                 :<span class="tlaGNC">        5244 :     : m_mempool(mempool),</span></span>
<span id="L1949"><span class="lineNum">    1949</span>                 :<span class="tlaGNC">        5244 :       m_blockman(blockman),</span></span>
<span id="L1950"><span class="lineNum">    1950</span>                 :<span class="tlaGNC">        5244 :       m_chainman(chainman),</span></span>
<span id="L1951"><span class="lineNum">    1951</span>                 :<span class="tlaGNC">        5244 :       m_from_snapshot_blockhash(from_snapshot_blockhash) {}</span></span>
<span id="L1952"><span class="lineNum">    1952</span>                 :             : </span>
<span id="L1953"><span class="lineNum">    1953</span>                 :<span class="tlaGNC">      942565 : const CBlockIndex* Chainstate::SnapshotBase() const</span></span>
<span id="L1954"><span class="lineNum">    1954</span>                 :             : {</span>
<span id="L1955"><span class="lineNum">    1955</span>         [<span class="tlaGBC" title="Branch 0 was taken 11256 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 931309 times"> + </span>]:<span class="tlaGNC">      942565 :     if (!m_from_snapshot_blockhash) return nullptr;</span></span>
<span id="L1956"><span class="lineNum">    1956</span>         [<span class="tlaGBC" title="Branch 0 was taken 56 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 11200 times"> + </span>]:<span class="tlaGNC">       11256 :     if (!m_cached_snapshot_base) m_cached_snapshot_base = Assert(m_chainman.m_blockman.LookupBlockIndex(*m_from_snapshot_blockhash));</span></span>
<span id="L1957"><span class="lineNum">    1957</span>                 :<span class="tlaGNC">       11256 :     return m_cached_snapshot_base;</span></span>
<span id="L1958"><span class="lineNum">    1958</span>                 :             : }</span>
<span id="L1959"><span class="lineNum">    1959</span>                 :             : </span>
<span id="L1960"><span class="lineNum">    1960</span>                 :<span class="tlaGNC">        5244 : void Chainstate::InitCoinsDB(</span></span>
<span id="L1961"><span class="lineNum">    1961</span>                 :             :     size_t cache_size_bytes,</span>
<span id="L1962"><span class="lineNum">    1962</span>                 :             :     bool in_memory,</span>
<span id="L1963"><span class="lineNum">    1963</span>                 :             :     bool should_wipe,</span>
<span id="L1964"><span class="lineNum">    1964</span>                 :             :     fs::path leveldb_name)</span>
<span id="L1965"><span class="lineNum">    1965</span>                 :             : {</span>
<span id="L1966"><span class="lineNum">    1966</span>         [<span class="tlaGBC" title="Branch 0 was taken 2284 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 2960 times"> + </span>]:<span class="tlaGNC">        5244 :     if (m_from_snapshot_blockhash) {</span></span>
<span id="L1967"><span class="lineNum">    1967</span>                 :<span class="tlaGNC">        2284 :         leveldb_name += node::SNAPSHOT_CHAINSTATE_SUFFIX;</span></span>
<span id="L1968"><span class="lineNum">    1968</span>                 :             :     }</span>
<span id="L1969"><span class="lineNum">    1969</span>                 :             : </span>
<span id="L1970"><span class="lineNum">    1970</span>                 :<span class="tlaGNC">        5244 :     m_coins_views = std::make_unique&lt;CoinsViews&gt;(</span></span>
<span id="L1971"><span class="lineNum">    1971</span>                 :<span class="tlaGNC">        5244 :         DBParams{</span></span>
<span id="L1972"><span class="lineNum">    1972</span>         [<span class="tlaGBC" title="Branch 0 was taken 5244 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        5244 :             .path = m_chainman.m_options.datadir / leveldb_name,</span></span>
<span id="L1973"><span class="lineNum">    1973</span>                 :             :             .cache_bytes = cache_size_bytes,</span>
<span id="L1974"><span class="lineNum">    1974</span>                 :             :             .memory_only = in_memory,</span>
<span id="L1975"><span class="lineNum">    1975</span>                 :             :             .wipe_data = should_wipe,</span>
<span id="L1976"><span class="lineNum">    1976</span>                 :             :             .obfuscate = true,</span>
<span id="L1977"><span class="lineNum">    1977</span>         [<span class="tlaGBC" title="Branch 0 was taken 5244 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        5244 :             .options = m_chainman.m_options.coins_db},</span></span>
<span id="L1978"><span class="lineNum">    1978</span>                 :<span class="tlaGNC">       10488 :         m_chainman.m_options.coins_view);</span></span>
<span id="L1979"><span class="lineNum">    1979</span>                 :             : </span>
<span id="L1980"><span class="lineNum">    1980</span>                 :<span class="tlaGNC">        5244 :     m_coinsdb_cache_size_bytes = cache_size_bytes;</span></span>
<span id="L1981"><span class="lineNum">    1981</span>                 :<span class="tlaGNC">        5244 : }</span></span>
<span id="L1982"><span class="lineNum">    1982</span>                 :             : </span>
<span id="L1983"><span class="lineNum">    1983</span>                 :<span class="tlaGNC">        5244 : void Chainstate::InitCoinsCache(size_t cache_size_bytes)</span></span>
<span id="L1984"><span class="lineNum">    1984</span>                 :             : {</span>
<span id="L1985"><span class="lineNum">    1985</span>                 :<span class="tlaGNC">        5244 :     AssertLockHeld(::cs_main);</span></span>
<span id="L1986"><span class="lineNum">    1986</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 5244 times"> + </span>]:<span class="tlaGNC">        5244 :     assert(m_coins_views != nullptr);</span></span>
<span id="L1987"><span class="lineNum">    1987</span>                 :<span class="tlaGNC">        5244 :     m_coinstip_cache_size_bytes = cache_size_bytes;</span></span>
<span id="L1988"><span class="lineNum">    1988</span>                 :<span class="tlaGNC">        5244 :     m_coins_views-&gt;InitCache();</span></span>
<span id="L1989"><span class="lineNum">    1989</span>                 :<span class="tlaGNC">        5244 : }</span></span>
<span id="L1990"><span class="lineNum">    1990</span>                 :             : </span>
<span id="L1991"><span class="lineNum">    1991</span>                 :             : // Note that though this is marked const, we may end up modifying `m_cached_finished_ibd`, which</span>
<span id="L1992"><span class="lineNum">    1992</span>                 :             : // is a performance-related implementation detail. This function must be marked</span>
<span id="L1993"><span class="lineNum">    1993</span>                 :             : // `const` so that `CValidationInterface` clients (which are given a `const Chainstate*`)</span>
<span id="L1994"><span class="lineNum">    1994</span>                 :             : // can call it.</span>
<span id="L1995"><span class="lineNum">    1995</span>                 :             : //</span>
<span id="L1996"><span class="lineNum">    1996</span>                 :<span class="tlaGNC">     2692903 : bool ChainstateManager::IsInitialBlockDownload() const</span></span>
<span id="L1997"><span class="lineNum">    1997</span>                 :             : {</span>
<span id="L1998"><span class="lineNum">    1998</span>                 :             :     // Optimization: pre-test latch before taking the lock.</span>
<span id="L1999"><span class="lineNum">    1999</span>         [<span class="tlaGBC" title="Branch 0 was taken 1259466 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 1433437 times"> + </span>]:<span class="tlaGNC">     2692903 :     if (m_cached_finished_ibd.load(std::memory_order_relaxed))</span></span>
<span id="L2000"><span class="lineNum">    2000</span>                 :             :         return false;</span>
<span id="L2001"><span class="lineNum">    2001</span>                 :             : </span>
<span id="L2002"><span class="lineNum">    2002</span>                 :<span class="tlaGNC">     1259466 :     LOCK(cs_main);</span></span>
<span id="L2003"><span class="lineNum">    2003</span>         [<span class="tlaGBC" title="Branch 0 was taken 1259466 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">     1259466 :     if (m_cached_finished_ibd.load(std::memory_order_relaxed))</span></span>
<span id="L2004"><span class="lineNum">    2004</span>                 :             :         return false;</span>
<span id="L2005"><span class="lineNum">    2005</span>         [<span class="tlaGBC" title="Branch 0 was taken 1259466 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">     1259466 :     if (m_blockman.LoadingBlocks()) {</span></span>
<span id="L2006"><span class="lineNum">    2006</span>                 :             :         return true;</span>
<span id="L2007"><span class="lineNum">    2007</span>                 :             :     }</span>
<span id="L2008"><span class="lineNum">    2008</span>         [<span class="tlaGBC" title="Branch 0 was taken 1259466 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">     1259466 :     CChain&amp; chain{ActiveChain()};</span></span>
<span id="L2009"><span class="lineNum">    2009</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 1259466 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 1256506 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">     3775438 :     if (chain.Tip() == nullptr) {</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 1259466 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L2010"><span class="lineNum">    2010</span>                 :             :         return true;</span>
<span id="L2011"><span class="lineNum">    2011</span>                 :             :     }</span>
<span id="L2012"><span class="lineNum">    2012</span>   [<span class="tlaGBC" title="Branch 0 was taken 1256506 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 1256506 times"> + </span> :<span class="tlaGNC">     2513012 :     if (chain.Tip()-&gt;nChainWork &lt; MinimumChainWork()) {</span></span>
<span class="lineNum">        </span>    <span class="tlaGBC" title="Branch 4 was taken 1256506 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaGBC" title="Branch 6 was taken 1232331 times"> + </span><span class="tlaGBC" title="Branch 7 was taken 24175 times"> + </span>]
<span id="L2013"><span class="lineNum">    2013</span>                 :             :         return true;</span>
<span id="L2014"><span class="lineNum">    2014</span>                 :             :     }</span>
<span id="L2015"><span class="lineNum">    2015</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 1232331 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 4898 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 1227433 times"> + </span>]:<span class="tlaGNC">     2464662 :     if (chain.Tip()-&gt;Time() &lt; Now&lt;NodeSeconds&gt;() - m_options.max_tip_age) {</span></span>
<span id="L2016"><span class="lineNum">    2016</span>                 :             :         return true;</span>
<span id="L2017"><span class="lineNum">    2017</span>                 :             :     }</span>
<span id="L2018"><span class="lineNum">    2018</span>         [<span class="tlaGBC" title="Branch 0 was taken 4898 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        4898 :     LogInfo(&quot;Leaving InitialBlockDownload (latching to false)&quot;);</span></span>
<span id="L2019"><span class="lineNum">    2019</span>                 :<span class="tlaGNC">        4898 :     m_cached_finished_ibd.store(true, std::memory_order_relaxed);</span></span>
<span id="L2020"><span class="lineNum">    2020</span>                 :<span class="tlaGNC">        4898 :     return false;</span></span>
<span id="L2021"><span class="lineNum">    2021</span>                 :<span class="tlaGNC">     1259466 : }</span></span>
<span id="L2022"><span class="lineNum">    2022</span>                 :             : </span>
<span id="L2023"><span class="lineNum">    2023</span>                 :<span class="tlaGNC">      246925 : void Chainstate::CheckForkWarningConditions()</span></span>
<span id="L2024"><span class="lineNum">    2024</span>                 :             : {</span>
<span id="L2025"><span class="lineNum">    2025</span>                 :<span class="tlaGNC">      246925 :     AssertLockHeld(cs_main);</span></span>
<span id="L2026"><span class="lineNum">    2026</span>                 :             : </span>
<span id="L2027"><span class="lineNum">    2027</span>                 :             :     // Before we get past initial download, we cannot reliably alert about forks</span>
<span id="L2028"><span class="lineNum">    2028</span>                 :             :     // (we assume we don't get stuck on a fork before finishing our initial sync)</span>
<span id="L2029"><span class="lineNum">    2029</span>                 :             :     // Also not applicable to the background chainstate</span>
<span id="L2030"><span class="lineNum">    2030</span>   [<span class="tlaGBC" title="Branch 0 was taken 91945 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 154980 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 91945 times"> + </span>]:<span class="tlaGNC">      246925 :     if (m_chainman.IsInitialBlockDownload() || this-&gt;GetRole() == ChainstateRole::BACKGROUND) {</span></span>
<span id="L2031"><span class="lineNum">    2031</span>                 :<span class="tlaGNC">      154980 :         return;</span></span>
<span id="L2032"><span class="lineNum">    2032</span>                 :             :     }</span>
<span id="L2033"><span class="lineNum">    2033</span>                 :             : </span>
<span id="L2034"><span class="lineNum">    2034</span>   [<span class="tlaGBC" title="Branch 0 was taken 10252 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 81693 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 10252 times"> + </span> :<span class="tlaGNC">      112449 :     if (m_chainman.m_best_invalid &amp;&amp; m_chainman.m_best_invalid-&gt;nChainWork &gt; m_chain.Tip()-&gt;nChainWork + (GetBlockProof(*m_chain.Tip()) * 6)) {</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaGBC" title="Branch 5 was taken 10252 times"> + </span><span class="tlaGBC" title="Branch 6 was taken 10252 times"> + </span><span class="tlaUNC" title="Branch 7 was not taken"> - </span>]
<span id="L2035"><span class="lineNum">    2035</span>                 :<span class="tlaUNC">           0 :         LogPrintf(&quot;%s: Warning: Found invalid chain at least ~6 blocks longer than our best chain.\nChain state database corruption likely.\n&quot;, __func__);</span></span>
<span id="L2036"><span class="lineNum">    2036</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         m_chainman.GetNotifications().warningSet(</span></span>
<span id="L2037"><span class="lineNum">    2037</span>                 :             :             kernel::Warning::LARGE_WORK_INVALID_CHAIN,</span>
<span id="L2038"><span class="lineNum">    2038</span>                 :<span class="tlaUNC">           0 :             _(&quot;Warning: We do not appear to fully agree with our peers! You may need to upgrade, or other nodes may need to upgrade.&quot;));</span></span>
<span id="L2039"><span class="lineNum">    2039</span>                 :             :     } else {</span>
<span id="L2040"><span class="lineNum">    2040</span>                 :<span class="tlaGNC">       91945 :         m_chainman.GetNotifications().warningUnset(kernel::Warning::LARGE_WORK_INVALID_CHAIN);</span></span>
<span id="L2041"><span class="lineNum">    2041</span>                 :             :     }</span>
<span id="L2042"><span class="lineNum">    2042</span>                 :             : }</span>
<span id="L2043"><span class="lineNum">    2043</span>                 :             : </span>
<span id="L2044"><span class="lineNum">    2044</span>                 :             : // Called both upon regular invalid block discovery *and* InvalidateBlock</span>
<span id="L2045"><span class="lineNum">    2045</span>                 :<span class="tlaGNC">       30839 : void Chainstate::InvalidChainFound(CBlockIndex* pindexNew)</span></span>
<span id="L2046"><span class="lineNum">    2046</span>                 :             : {</span>
<span id="L2047"><span class="lineNum">    2047</span>                 :<span class="tlaGNC">       30839 :     AssertLockHeld(cs_main);</span></span>
<span id="L2048"><span class="lineNum">    2048</span>   [<span class="tlaGBC" title="Branch 0 was taken 29344 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 1495 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 7004 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 22340 times"> + </span>]:<span class="tlaGNC">       30839 :     if (!m_chainman.m_best_invalid || pindexNew-&gt;nChainWork &gt; m_chainman.m_best_invalid-&gt;nChainWork) {</span></span>
<span id="L2049"><span class="lineNum">    2049</span>                 :<span class="tlaGNC">        8499 :         m_chainman.m_best_invalid = pindexNew;</span></span>
<span id="L2050"><span class="lineNum">    2050</span>                 :             :     }</span>
<span id="L2051"><span class="lineNum">    2051</span>                 :<span class="tlaGNC">       30839 :     SetBlockFailureFlags(pindexNew);</span></span>
<span id="L2052"><span class="lineNum">    2052</span>   [<span class="tlaGBC" title="Branch 0 was taken 30839 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 15368 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 15471 times"> + </span>]:<span class="tlaGNC">       30839 :     if (m_chainman.m_best_header != nullptr &amp;&amp; m_chainman.m_best_header-&gt;GetAncestor(pindexNew-&gt;nHeight) == pindexNew) {</span></span>
<span id="L2053"><span class="lineNum">    2053</span>                 :<span class="tlaGNC">       15368 :         m_chainman.RecalculateBestHeader();</span></span>
<span id="L2054"><span class="lineNum">    2054</span>                 :             :     }</span>
<span id="L2055"><span class="lineNum">    2055</span>                 :             : </span>
<span id="L2056"><span class="lineNum">    2056</span>   [<span class="tlaGBC" title="Branch 0 was taken 30839 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 30839 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">       61678 :     LogPrintf(&quot;%s: invalid block=%s  height=%d  log2_work=%f  date=%s\n&quot;, __func__,</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 30839 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L2057"><span class="lineNum">    2057</span>                 :             :       pindexNew-&gt;GetBlockHash().ToString(), pindexNew-&gt;nHeight,</span>
<span id="L2058"><span class="lineNum">    2058</span>                 :             :       log(pindexNew-&gt;nChainWork.getdouble())/log(2.0), FormatISO8601DateTime(pindexNew-&gt;GetBlockTime()));</span>
<span id="L2059"><span class="lineNum">    2059</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 30839 times"> + </span>]:<span class="tlaGNC">       30839 :     CBlockIndex *tip = m_chain.Tip();</span></span>
<span id="L2060"><span class="lineNum">    2060</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 30839 times"> + </span>]:<span class="tlaGNC">       30839 :     assert (tip);</span></span>
<span id="L2061"><span class="lineNum">    2061</span>   [<span class="tlaGBC" title="Branch 0 was taken 30839 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 30839 times"> + </span> :<span class="tlaGNC">       61678 :     LogPrintf(&quot;%s:  current best=%s  height=%d  log2_work=%f  date=%s\n&quot;, __func__,</span></span>
<span class="lineNum">        </span>    <span class="tlaGBC" title="Branch 4 was taken 30839 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaGBC" title="Branch 6 was taken 30839 times"> + </span><span class="tlaUNC" title="Branch 7 was not taken"> - </span>]
<span id="L2062"><span class="lineNum">    2062</span>                 :             :       tip-&gt;GetBlockHash().ToString(), m_chain.Height(), log(tip-&gt;nChainWork.getdouble())/log(2.0),</span>
<span id="L2063"><span class="lineNum">    2063</span>                 :             :       FormatISO8601DateTime(tip-&gt;GetBlockTime()));</span>
<span id="L2064"><span class="lineNum">    2064</span>                 :<span class="tlaGNC">       30839 :     CheckForkWarningConditions();</span></span>
<span id="L2065"><span class="lineNum">    2065</span>                 :<span class="tlaGNC">       30839 : }</span></span>
<span id="L2066"><span class="lineNum">    2066</span>                 :             : </span>
<span id="L2067"><span class="lineNum">    2067</span>                 :             : // Same as InvalidChainFound, above, except not called directly from InvalidateBlock,</span>
<span id="L2068"><span class="lineNum">    2068</span>                 :             : // which does its own setBlockIndexCandidates management.</span>
<span id="L2069"><span class="lineNum">    2069</span>                 :<span class="tlaGNC">       39977 : void Chainstate::InvalidBlockFound(CBlockIndex* pindex, const BlockValidationState&amp; state)</span></span>
<span id="L2070"><span class="lineNum">    2070</span>                 :             : {</span>
<span id="L2071"><span class="lineNum">    2071</span>                 :<span class="tlaGNC">       39977 :     AssertLockHeld(cs_main);</span></span>
<span id="L2072"><span class="lineNum">    2072</span>         [<span class="tlaGBC" title="Branch 0 was taken 15471 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 24506 times"> + </span>]:<span class="tlaGNC">       39977 :     if (state.GetResult() != BlockValidationResult::BLOCK_MUTATED) {</span></span>
<span id="L2073"><span class="lineNum">    2073</span>                 :<span class="tlaGNC">       15471 :         pindex-&gt;nStatus |= BLOCK_FAILED_VALID;</span></span>
<span id="L2074"><span class="lineNum">    2074</span>                 :<span class="tlaGNC">       15471 :         m_blockman.m_dirty_blockindex.insert(pindex);</span></span>
<span id="L2075"><span class="lineNum">    2075</span>                 :<span class="tlaGNC">       15471 :         setBlockIndexCandidates.erase(pindex);</span></span>
<span id="L2076"><span class="lineNum">    2076</span>                 :<span class="tlaGNC">       15471 :         InvalidChainFound(pindex);</span></span>
<span id="L2077"><span class="lineNum">    2077</span>                 :             :     }</span>
<span id="L2078"><span class="lineNum">    2078</span>                 :<span class="tlaGNC">       39977 : }</span></span>
<span id="L2079"><span class="lineNum">    2079</span>                 :             : </span>
<span id="L2080"><span class="lineNum">    2080</span>                 :<span class="tlaGNC">      489319 : void UpdateCoins(const CTransaction&amp; tx, CCoinsViewCache&amp; inputs, CTxUndo &amp;txundo, int nHeight)</span></span>
<span id="L2081"><span class="lineNum">    2081</span>                 :             : {</span>
<span id="L2082"><span class="lineNum">    2082</span>                 :             :     // mark inputs spent</span>
<span id="L2083"><span class="lineNum">    2083</span>         [<span class="tlaGBC" title="Branch 0 was taken 27529 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 461790 times"> + </span>]:<span class="tlaGNC">      489319 :     if (!tx.IsCoinBase()) {</span></span>
<span id="L2084"><span class="lineNum">    2084</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 27529 times"> + </span>]:<span class="tlaGNC">       27529 :         txundo.vprevout.reserve(tx.vin.size());</span></span>
<span id="L2085"><span class="lineNum">    2085</span>         [<span class="tlaGBC" title="Branch 0 was taken 43270 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 27529 times"> + </span>]:<span class="tlaGNC">       70799 :         for (const CTxIn &amp;txin : tx.vin) {</span></span>
<span id="L2086"><span class="lineNum">    2086</span>                 :<span class="tlaGNC">       43270 :             txundo.vprevout.emplace_back();</span></span>
<span id="L2087"><span class="lineNum">    2087</span>                 :<span class="tlaGNC">       43270 :             bool is_spent = inputs.SpendCoin(txin.prevout, &amp;txundo.vprevout.back());</span></span>
<span id="L2088"><span class="lineNum">    2088</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 43270 times"> + </span>]:<span class="tlaGNC">       43270 :             assert(is_spent);</span></span>
<span id="L2089"><span class="lineNum">    2089</span>                 :             :         }</span>
<span id="L2090"><span class="lineNum">    2090</span>                 :             :     }</span>
<span id="L2091"><span class="lineNum">    2091</span>                 :             :     // add outputs</span>
<span id="L2092"><span class="lineNum">    2092</span>                 :<span class="tlaGNC">      489319 :     AddCoins(inputs, tx, nHeight);</span></span>
<span id="L2093"><span class="lineNum">    2093</span>                 :<span class="tlaGNC">      489319 : }</span></span>
<span id="L2094"><span class="lineNum">    2094</span>                 :             : </span>
<span id="L2095"><span class="lineNum">    2095</span>                 :<span class="tlaGNC">      691748 : std::optional&lt;std::pair&lt;ScriptError, std::string&gt;&gt; CScriptCheck::operator()() {</span></span>
<span id="L2096"><span class="lineNum">    2096</span>         [<span class="tlaGBC" title="Branch 0 was taken 691748 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      691748 :     const CScript &amp;scriptSig = ptxTo-&gt;vin[nIn].scriptSig;</span></span>
<span id="L2097"><span class="lineNum">    2097</span>                 :<span class="tlaGNC">      691748 :     const CScriptWitness *witness = &amp;ptxTo-&gt;vin[nIn].scriptWitness;</span></span>
<span id="L2098"><span class="lineNum">    2098</span>                 :<span class="tlaGNC">      691748 :     ScriptError error{SCRIPT_ERR_UNKNOWN_ERROR};</span></span>
<span id="L2099"><span class="lineNum">    2099</span>   [<span class="tlaGBC" title="Branch 0 was taken 691748 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 640409 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 51339 times"> + </span>]:<span class="tlaGNC">      691748 :     if (VerifyScript(scriptSig, m_tx_out.scriptPubKey, witness, nFlags, CachingTransactionSignatureChecker(ptxTo, nIn, m_tx_out.nValue, cacheStore, *m_signature_cache, *txdata), &amp;error)) {</span></span>
<span id="L2100"><span class="lineNum">    2100</span>                 :<span class="tlaGNC">      640409 :         return std::nullopt;</span></span>
<span id="L2101"><span class="lineNum">    2101</span>                 :             :     } else {</span>
<span id="L2102"><span class="lineNum">    2102</span>   [<span class="tlaGBC" title="Branch 0 was taken 51339 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 51339 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      102678 :         auto debug_str = strprintf(&quot;input %i of %s (wtxid %s), spending %s:%i&quot;, nIn, ptxTo-&gt;GetHash().ToString(), ptxTo-&gt;GetWitnessHash().ToString(), ptxTo-&gt;vin[nIn].prevout.hash.ToString(), ptxTo-&gt;vin[nIn].prevout.n);</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 51339 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L2103"><span class="lineNum">    2103</span>                 :<span class="tlaGNC">       51339 :         return std::make_pair(error, std::move(debug_str));</span></span>
<span id="L2104"><span class="lineNum">    2104</span>                 :<span class="tlaGNC">       51339 :     }</span></span>
<span id="L2105"><span class="lineNum">    2105</span>                 :             : }</span>
<span id="L2106"><span class="lineNum">    2106</span>                 :             : </span>
<span id="L2107"><span class="lineNum">    2107</span>                 :<span class="tlaGNC">        2960 : ValidationCache::ValidationCache(const size_t script_execution_cache_bytes, const size_t signature_cache_bytes)</span></span>
<span id="L2108"><span class="lineNum">    2108</span>         [<span class="tlaGBC" title="Branch 0 was taken 2960 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        2960 :     : m_signature_cache{signature_cache_bytes}</span></span>
<span id="L2109"><span class="lineNum">    2109</span>                 :             : {</span>
<span id="L2110"><span class="lineNum">    2110</span>                 :             :     // Setup the salted hasher</span>
<span id="L2111"><span class="lineNum">    2111</span>                 :<span class="tlaGNC">        2960 :     uint256 nonce = GetRandHash();</span></span>
<span id="L2112"><span class="lineNum">    2112</span>                 :             :     // We want the nonce to be 64 bytes long to force the hasher to process</span>
<span id="L2113"><span class="lineNum">    2113</span>                 :             :     // this chunk, which makes later hash computations more efficient. We</span>
<span id="L2114"><span class="lineNum">    2114</span>                 :             :     // just write our 32-byte entropy twice to fill the 64 bytes.</span>
<span id="L2115"><span class="lineNum">    2115</span>         [<span class="tlaGBC" title="Branch 0 was taken 2960 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        2960 :     m_script_execution_cache_hasher.Write(nonce.begin(), 32);</span></span>
<span id="L2116"><span class="lineNum">    2116</span>         [<span class="tlaGBC" title="Branch 0 was taken 2960 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        2960 :     m_script_execution_cache_hasher.Write(nonce.begin(), 32);</span></span>
<span id="L2117"><span class="lineNum">    2117</span>                 :             : </span>
<span id="L2118"><span class="lineNum">    2118</span>   [<span class="tlaGBC" title="Branch 0 was taken 2960 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 2960 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">        2960 :     const auto [num_elems, approx_size_bytes] = m_script_execution_cache.setup_bytes(script_execution_cache_bytes);</span></span>
<span id="L2119"><span class="lineNum">    2119</span>         [<span class="tlaGBC" title="Branch 0 was taken 2960 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        2960 :     LogInfo(&quot;Using %zu MiB out of %zu MiB requested for script execution cache, able to store %zu elements&quot;,</span></span>
<span id="L2120"><span class="lineNum">    2120</span>                 :             :               approx_size_bytes &gt;&gt; 20, script_execution_cache_bytes &gt;&gt; 20, num_elems);</span>
<span id="L2121"><span class="lineNum">    2121</span>                 :<span class="tlaGNC">        2960 : }</span></span>
<span id="L2122"><span class="lineNum">    2122</span>                 :             : </span>
<span id="L2123"><span class="lineNum">    2123</span>                 :             : /**</span>
<span id="L2124"><span class="lineNum">    2124</span>                 :             :  * Check whether all of this transaction's input scripts succeed.</span>
<span id="L2125"><span class="lineNum">    2125</span>                 :             :  *</span>
<span id="L2126"><span class="lineNum">    2126</span>                 :             :  * This involves ECDSA signature checks so can be computationally intensive. This function should</span>
<span id="L2127"><span class="lineNum">    2127</span>                 :             :  * only be called after the cheap sanity checks in CheckTxInputs passed.</span>
<span id="L2128"><span class="lineNum">    2128</span>                 :             :  *</span>
<span id="L2129"><span class="lineNum">    2129</span>                 :             :  * If pvChecks is not nullptr, script checks are pushed onto it instead of being performed inline. Any</span>
<span id="L2130"><span class="lineNum">    2130</span>                 :             :  * script checks which are not necessary (eg due to script execution cache hits) are, obviously,</span>
<span id="L2131"><span class="lineNum">    2131</span>                 :             :  * not pushed onto pvChecks/run.</span>
<span id="L2132"><span class="lineNum">    2132</span>                 :             :  *</span>
<span id="L2133"><span class="lineNum">    2133</span>                 :             :  * Setting cacheSigStore/cacheFullScriptStore to false will remove elements from the corresponding cache</span>
<span id="L2134"><span class="lineNum">    2134</span>                 :             :  * which are matched. This is useful for checking blocks where we will likely never need the cache</span>
<span id="L2135"><span class="lineNum">    2135</span>                 :             :  * entry again.</span>
<span id="L2136"><span class="lineNum">    2136</span>                 :             :  *</span>
<span id="L2137"><span class="lineNum">    2137</span>                 :             :  * Note that we may set state.reason to NOT_STANDARD for extra soft-fork flags in flags, block-checking</span>
<span id="L2138"><span class="lineNum">    2138</span>                 :             :  * callers should probably reset it to CONSENSUS in such cases.</span>
<span id="L2139"><span class="lineNum">    2139</span>                 :             :  *</span>
<span id="L2140"><span class="lineNum">    2140</span>                 :             :  * Non-static (and redeclared) in src/test/txvalidationcache_tests.cpp</span>
<span id="L2141"><span class="lineNum">    2141</span>                 :             :  */</span>
<span id="L2142"><span class="lineNum">    2142</span>                 :<span class="tlaGNC">      624546 : bool CheckInputScripts(const CTransaction&amp; tx, TxValidationState&amp; state,</span></span>
<span id="L2143"><span class="lineNum">    2143</span>                 :             :                        const CCoinsViewCache&amp; inputs, unsigned int flags, bool cacheSigStore,</span>
<span id="L2144"><span class="lineNum">    2144</span>                 :             :                        bool cacheFullScriptStore, PrecomputedTransactionData&amp; txdata,</span>
<span id="L2145"><span class="lineNum">    2145</span>                 :             :                        ValidationCache&amp; validation_cache,</span>
<span id="L2146"><span class="lineNum">    2146</span>                 :             :                        std::vector&lt;CScriptCheck&gt;* pvChecks)</span>
<span id="L2147"><span class="lineNum">    2147</span>                 :             : {</span>
<span id="L2148"><span class="lineNum">    2148</span>         [<span class="tlaGBC" title="Branch 0 was taken 624546 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      624546 :     if (tx.IsCoinBase()) return true;</span></span>
<span id="L2149"><span class="lineNum">    2149</span>                 :             : </span>
<span id="L2150"><span class="lineNum">    2150</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 624546 times"> + </span>]:<span class="tlaGNC">      624546 :     if (pvChecks) {</span></span>
<span id="L2151"><span class="lineNum">    2151</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         pvChecks-&gt;reserve(tx.vin.size());</span></span>
<span id="L2152"><span class="lineNum">    2152</span>                 :             :     }</span>
<span id="L2153"><span class="lineNum">    2153</span>                 :             : </span>
<span id="L2154"><span class="lineNum">    2154</span>                 :             :     // First check if script executions have been cached with the same</span>
<span id="L2155"><span class="lineNum">    2155</span>                 :             :     // flags. Note that this assumes that the inputs provided are</span>
<span id="L2156"><span class="lineNum">    2156</span>                 :             :     // correct (ie that the transaction hash which is in tx's prevouts</span>
<span id="L2157"><span class="lineNum">    2157</span>                 :             :     // properly commits to the scriptPubKey in the inputs view of that</span>
<span id="L2158"><span class="lineNum">    2158</span>                 :             :     // transaction).</span>
<span id="L2159"><span class="lineNum">    2159</span>                 :<span class="tlaGNC">      624546 :     uint256 hashCacheEntry;</span></span>
<span id="L2160"><span class="lineNum">    2160</span>                 :<span class="tlaGNC">      624546 :     CSHA256 hasher = validation_cache.ScriptExecutionCacheHasher();</span></span>
<span id="L2161"><span class="lineNum">    2161</span>                 :<span class="tlaGNC">      624546 :     hasher.Write(UCharCast(tx.GetWitnessHash().begin()), 32).Write((unsigned char*)&amp;flags, sizeof(flags)).Finalize(hashCacheEntry.begin());</span></span>
<span id="L2162"><span class="lineNum">    2162</span>                 :<span class="tlaGNC">      624546 :     AssertLockHeld(cs_main); //TODO: Remove this requirement by making CuckooCache not require external locks</span></span>
<span id="L2163"><span class="lineNum">    2163</span>         [<span class="tlaGBC" title="Branch 0 was taken 426068 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 198478 times"> + </span>]:<span class="tlaGNC">      624546 :     if (validation_cache.m_script_execution_cache.contains(hashCacheEntry, !cacheFullScriptStore)) {</span></span>
<span id="L2164"><span class="lineNum">    2164</span>                 :             :         return true;</span>
<span id="L2165"><span class="lineNum">    2165</span>                 :             :     }</span>
<span id="L2166"><span class="lineNum">    2166</span>                 :             : </span>
<span id="L2167"><span class="lineNum">    2167</span>         [<span class="tlaGBC" title="Branch 0 was taken 353648 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 72420 times"> + </span>]:<span class="tlaGNC">      426068 :     if (!txdata.m_spent_outputs_ready) {</span></span>
<span id="L2168"><span class="lineNum">    2168</span>                 :<span class="tlaGNC">      353648 :         std::vector&lt;CTxOut&gt; spent_outputs;</span></span>
<span id="L2169"><span class="lineNum">    2169</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 353648 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 353648 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      353648 :         spent_outputs.reserve(tx.vin.size());</span></span>
<span id="L2170"><span class="lineNum">    2170</span>                 :             : </span>
<span id="L2171"><span class="lineNum">    2171</span>         [<span class="tlaGBC" title="Branch 0 was taken 546408 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 353648 times"> + </span>]:<span class="tlaGNC">      900056 :         for (const auto&amp; txin : tx.vin) {</span></span>
<span id="L2172"><span class="lineNum">    2172</span>                 :<span class="tlaGNC">      546408 :             const COutPoint&amp; prevout = txin.prevout;</span></span>
<span id="L2173"><span class="lineNum">    2173</span>         [<span class="tlaGBC" title="Branch 0 was taken 546408 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      546408 :             const Coin&amp; coin = inputs.AccessCoin(prevout);</span></span>
<span id="L2174"><span class="lineNum">    2174</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 546408 times"> + </span>]:<span class="tlaGNC">      546408 :             assert(!coin.IsSpent());</span></span>
<span id="L2175"><span class="lineNum">    2175</span>         [<span class="tlaGBC" title="Branch 0 was taken 546408 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      546408 :             spent_outputs.emplace_back(coin.out);</span></span>
<span id="L2176"><span class="lineNum">    2176</span>                 :             :         }</span>
<span id="L2177"><span class="lineNum">    2177</span>         [<span class="tlaGBC" title="Branch 0 was taken 353648 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      353648 :         txdata.Init(tx, std::move(spent_outputs));</span></span>
<span id="L2178"><span class="lineNum">    2178</span>                 :<span class="tlaGNC">      353648 :     }</span></span>
<span id="L2179"><span class="lineNum">    2179</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 426068 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 426068 times"> + </span> :<span class="tlaGNC">      426068 :     assert(txdata.m_spent_outputs.size() == tx.vin.size());</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaGBC" title="Branch 5 was taken 426068 times"> + </span>]
<span id="L2180"><span class="lineNum">    2180</span>                 :             : </span>
<span id="L2181"><span class="lineNum">    2181</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 1066477 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 691748 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 374729 times"> + </span>]:<span class="tlaGNC">     1066477 :     for (unsigned int i = 0; i &lt; tx.vin.size(); i++) {</span></span>
<span id="L2182"><span class="lineNum">    2182</span>                 :             : </span>
<span id="L2183"><span class="lineNum">    2183</span>                 :             :         // We very carefully only pass in things to CScriptCheck which</span>
<span id="L2184"><span class="lineNum">    2184</span>                 :             :         // are clearly committed to by tx' witness hash. This provides</span>
<span id="L2185"><span class="lineNum">    2185</span>                 :             :         // a sanity check that our caching is not introducing consensus</span>
<span id="L2186"><span class="lineNum">    2186</span>                 :             :         // failures through additional data in, eg, the coins being</span>
<span id="L2187"><span class="lineNum">    2187</span>                 :             :         // spent being checked as a part of CScriptCheck.</span>
<span id="L2188"><span class="lineNum">    2188</span>                 :             : </span>
<span id="L2189"><span class="lineNum">    2189</span>                 :             :         // Verify signature</span>
<span id="L2190"><span class="lineNum">    2190</span>                 :<span class="tlaGNC">      691748 :         CScriptCheck check(txdata.m_spent_outputs[i], tx, validation_cache.m_signature_cache, i, flags, cacheSigStore, &amp;txdata);</span></span>
<span id="L2191"><span class="lineNum">    2191</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 691748 times"> + </span>]:<span class="tlaGNC">      691748 :         if (pvChecks) {</span></span>
<span id="L2192"><span class="lineNum">    2192</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             pvChecks-&gt;emplace_back(std::move(check));</span></span>
<span id="L2193"><span class="lineNum">    2193</span>   [<span class="tlaGBC" title="Branch 0 was taken 691748 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 51339 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 640409 times"> + </span>]:<span class="tlaGNC">      691748 :         } else if (auto result = check(); result.has_value()) {</span></span>
<span id="L2194"><span class="lineNum">    2194</span>                 :             :             // Tx failures never trigger disconnections/bans.</span>
<span id="L2195"><span class="lineNum">    2195</span>                 :             :             // This is so that network splits aren't triggered</span>
<span id="L2196"><span class="lineNum">    2196</span>                 :             :             // either due to non-consensus relay policies (such as</span>
<span id="L2197"><span class="lineNum">    2197</span>                 :             :             // non-standard DER encodings or non-null dummy</span>
<span id="L2198"><span class="lineNum">    2198</span>                 :             :             // arguments) or due to new consensus rules introduced in</span>
<span id="L2199"><span class="lineNum">    2199</span>                 :             :             // soft forks.</span>
<span id="L2200"><span class="lineNum">    2200</span>         [<span class="tlaGBC" title="Branch 0 was taken 51339 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       51339 :             if (flags &amp; STANDARD_NOT_MANDATORY_VERIFY_FLAGS) {</span></span>
<span id="L2201"><span class="lineNum">    2201</span>   [<span class="tlaGBC" title="Branch 0 was taken 51339 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 51339 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">       51339 :                 return state.Invalid(TxValidationResult::TX_NOT_STANDARD, strprintf(&quot;mempool-script-verify-flag-failed (%s)&quot;, ScriptErrorString(result-&gt;first)), result-&gt;second);</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 51339 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L2202"><span class="lineNum">    2202</span>                 :             :             } else {</span>
<span id="L2203"><span class="lineNum">    2203</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                 return state.Invalid(TxValidationResult::TX_CONSENSUS, strprintf(&quot;block-script-verify-flag-failed (%s)&quot;, ScriptErrorString(result-&gt;first)), result-&gt;second);</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L2204"><span class="lineNum">    2204</span>                 :             :             }</span>
<span id="L2205"><span class="lineNum">    2205</span>                 :<span class="tlaGNC">      691748 :         }</span></span>
<span id="L2206"><span class="lineNum">    2206</span>                 :<span class="tlaGNC">      691748 :     }</span></span>
<span id="L2207"><span class="lineNum">    2207</span>                 :             : </span>
<span id="L2208"><span class="lineNum">    2208</span>         [<span class="tlaGBC" title="Branch 0 was taken 72420 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 302309 times"> + </span>]:<span class="tlaGNC">      374729 :     if (cacheFullScriptStore &amp;&amp; !pvChecks) {</span></span>
<span id="L2209"><span class="lineNum">    2209</span>                 :             :         // We executed all of the provided scripts, and were told to</span>
<span id="L2210"><span class="lineNum">    2210</span>                 :             :         // cache the result. Do so now.</span>
<span id="L2211"><span class="lineNum">    2211</span>                 :<span class="tlaGNC">       72420 :         validation_cache.m_script_execution_cache.insert(hashCacheEntry);</span></span>
<span id="L2212"><span class="lineNum">    2212</span>                 :             :     }</span>
<span id="L2213"><span class="lineNum">    2213</span>                 :             : </span>
<span id="L2214"><span class="lineNum">    2214</span>                 :             :     return true;</span>
<span id="L2215"><span class="lineNum">    2215</span>                 :             : }</span>
<span id="L2216"><span class="lineNum">    2216</span>                 :             : </span>
<span id="L2217"><span class="lineNum">    2217</span>                 :<span class="tlaUNC">           0 : bool FatalError(Notifications&amp; notifications, BlockValidationState&amp; state, const bilingual_str&amp; message)</span></span>
<span id="L2218"><span class="lineNum">    2218</span>                 :             : {</span>
<span id="L2219"><span class="lineNum">    2219</span>                 :<span class="tlaUNC">           0 :     notifications.fatalError(message);</span></span>
<span id="L2220"><span class="lineNum">    2220</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     return state.Error(message.original);</span></span>
<span id="L2221"><span class="lineNum">    2221</span>                 :             : }</span>
<span id="L2222"><span class="lineNum">    2222</span>                 :             : </span>
<span id="L2223"><span class="lineNum">    2223</span>                 :             : /**</span>
<span id="L2224"><span class="lineNum">    2224</span>                 :             :  * Restore the UTXO in a Coin at a given COutPoint</span>
<span id="L2225"><span class="lineNum">    2225</span>                 :             :  * @param undo The Coin to be restored.</span>
<span id="L2226"><span class="lineNum">    2226</span>                 :             :  * @param view The coins view to which to apply the changes.</span>
<span id="L2227"><span class="lineNum">    2227</span>                 :             :  * @param out The out point that corresponds to the tx input.</span>
<span id="L2228"><span class="lineNum">    2228</span>                 :             :  * @return A DisconnectResult as an int</span>
<span id="L2229"><span class="lineNum">    2229</span>                 :             :  */</span>
<span id="L2230"><span class="lineNum">    2230</span>                 :<span class="tlaUNC">           0 : int ApplyTxInUndo(Coin&amp;&amp; undo, CCoinsViewCache&amp; view, const COutPoint&amp; out)</span></span>
<span id="L2231"><span class="lineNum">    2231</span>                 :             : {</span>
<span id="L2232"><span class="lineNum">    2232</span>                 :<span class="tlaUNC">           0 :     bool fClean = true;</span></span>
<span id="L2233"><span class="lineNum">    2233</span>                 :             : </span>
<span id="L2234"><span class="lineNum">    2234</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (view.HaveCoin(out)) fClean = false; // overwriting transaction output</span></span>
<span id="L2235"><span class="lineNum">    2235</span>                 :             : </span>
<span id="L2236"><span class="lineNum">    2236</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (undo.nHeight == 0) {</span></span>
<span id="L2237"><span class="lineNum">    2237</span>                 :             :         // Missing undo metadata (height and coinbase). Older versions included this</span>
<span id="L2238"><span class="lineNum">    2238</span>                 :             :         // information only in undo records for the last spend of a transactions'</span>
<span id="L2239"><span class="lineNum">    2239</span>                 :             :         // outputs. This implies that it must be present for some other output of the same tx.</span>
<span id="L2240"><span class="lineNum">    2240</span>                 :<span class="tlaUNC">           0 :         const Coin&amp; alternate = AccessByTxid(view, out.hash);</span></span>
<span id="L2241"><span class="lineNum">    2241</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!alternate.IsSpent()) {</span></span>
<span id="L2242"><span class="lineNum">    2242</span>                 :<span class="tlaUNC">           0 :             undo.nHeight = alternate.nHeight;</span></span>
<span id="L2243"><span class="lineNum">    2243</span>                 :<span class="tlaUNC">           0 :             undo.fCoinBase = alternate.fCoinBase;</span></span>
<span id="L2244"><span class="lineNum">    2244</span>                 :             :         } else {</span>
<span id="L2245"><span class="lineNum">    2245</span>                 :             :             return DISCONNECT_FAILED; // adding output for transaction without known metadata</span>
<span id="L2246"><span class="lineNum">    2246</span>                 :             :         }</span>
<span id="L2247"><span class="lineNum">    2247</span>                 :             :     }</span>
<span id="L2248"><span class="lineNum">    2248</span>                 :             :     // If the coin already exists as an unspent coin in the cache, then the</span>
<span id="L2249"><span class="lineNum">    2249</span>                 :             :     // possible_overwrite parameter to AddCoin must be set to true. We have</span>
<span id="L2250"><span class="lineNum">    2250</span>                 :             :     // already checked whether an unspent coin exists above using HaveCoin, so</span>
<span id="L2251"><span class="lineNum">    2251</span>                 :             :     // we don't need to guess. When fClean is false, an unspent coin already</span>
<span id="L2252"><span class="lineNum">    2252</span>                 :             :     // existed and it is an overwrite.</span>
<span id="L2253"><span class="lineNum">    2253</span>                 :<span class="tlaUNC">           0 :     view.AddCoin(out, std::move(undo), !fClean);</span></span>
<span id="L2254"><span class="lineNum">    2254</span>                 :             : </span>
<span id="L2255"><span class="lineNum">    2255</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     return fClean ? DISCONNECT_OK : DISCONNECT_UNCLEAN;</span></span>
<span id="L2256"><span class="lineNum">    2256</span>                 :             : }</span>
<span id="L2257"><span class="lineNum">    2257</span>                 :             : </span>
<span id="L2258"><span class="lineNum">    2258</span>                 :             : /** Undo the effects of this block (with given index) on the UTXO set represented by coins.</span>
<span id="L2259"><span class="lineNum">    2259</span>                 :             :  *  When FAILED is returned, view is left in an indeterminate state. */</span>
<span id="L2260"><span class="lineNum">    2260</span>                 :<span class="tlaUNC">           0 : DisconnectResult Chainstate::DisconnectBlock(const CBlock&amp; block, const CBlockIndex* pindex, CCoinsViewCache&amp; view)</span></span>
<span id="L2261"><span class="lineNum">    2261</span>                 :             : {</span>
<span id="L2262"><span class="lineNum">    2262</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(::cs_main);</span></span>
<span id="L2263"><span class="lineNum">    2263</span>                 :<span class="tlaUNC">           0 :     bool fClean = true;</span></span>
<span id="L2264"><span class="lineNum">    2264</span>                 :             : </span>
<span id="L2265"><span class="lineNum">    2265</span>                 :<span class="tlaUNC">           0 :     CBlockUndo blockUndo;</span></span>
<span id="L2266"><span class="lineNum">    2266</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!m_blockman.ReadBlockUndo(blockUndo, *pindex)) {</span></span>
<span id="L2267"><span class="lineNum">    2267</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LogError(&quot;DisconnectBlock(): failure reading undo data\n&quot;);</span></span>
<span id="L2268"><span class="lineNum">    2268</span>                 :             :         return DISCONNECT_FAILED;</span>
<span id="L2269"><span class="lineNum">    2269</span>                 :             :     }</span>
<span id="L2270"><span class="lineNum">    2270</span>                 :             : </span>
<span id="L2271"><span class="lineNum">    2271</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     if (blockUndo.vtxundo.size() + 1 != block.vtx.size()) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L2272"><span class="lineNum">    2272</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LogError(&quot;DisconnectBlock(): block and undo data inconsistent\n&quot;);</span></span>
<span id="L2273"><span class="lineNum">    2273</span>                 :             :         return DISCONNECT_FAILED;</span>
<span id="L2274"><span class="lineNum">    2274</span>                 :             :     }</span>
<span id="L2275"><span class="lineNum">    2275</span>                 :             : </span>
<span id="L2276"><span class="lineNum">    2276</span>                 :             :     // Ignore blocks that contain transactions which are 'overwritten' by later transactions,</span>
<span id="L2277"><span class="lineNum">    2277</span>                 :             :     // unless those are already completely spent.</span>
<span id="L2278"><span class="lineNum">    2278</span>                 :             :     // See https://github.com/bitcoin/bitcoin/issues/22596 for additional information.</span>
<span id="L2279"><span class="lineNum">    2279</span>                 :             :     // Note: the blocks specified here are different than the ones used in ConnectBlock because DisconnectBlock</span>
<span id="L2280"><span class="lineNum">    2280</span>                 :             :     // unwinds the blocks in reverse. As a result, the inconsistency is not discovered until the earlier</span>
<span id="L2281"><span class="lineNum">    2281</span>                 :             :     // blocks with the duplicate coinbase transactions are disconnected.</span>
<span id="L2282"><span class="lineNum">    2282</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     bool fEnforceBIP30 = !((pindex-&gt;nHeight==91722 &amp;&amp; pindex-&gt;GetBlockHash() == uint256{&quot;00000000000271a2dc26e7667f8419f2e15416dc6955e5a6c6cdf3f2574dd08e&quot;}) ||</span></span>
<span id="L2283"><span class="lineNum">    2283</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                            (pindex-&gt;nHeight==91812 &amp;&amp; pindex-&gt;GetBlockHash() == uint256{&quot;00000000000af0aed4792b1acee3d966af36cf5def14935db8de83d6f9306f2f&quot;}));</span></span>
<span id="L2284"><span class="lineNum">    2284</span>                 :             : </span>
<span id="L2285"><span class="lineNum">    2285</span>                 :             :     // undo transactions in reverse order</span>
<span id="L2286"><span class="lineNum">    2286</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (int i = block.vtx.size() - 1; i &gt;= 0; i--) {</span></span>
<span id="L2287"><span class="lineNum">    2287</span>                 :<span class="tlaUNC">           0 :         const CTransaction &amp;tx = *(block.vtx[i]);</span></span>
<span id="L2288"><span class="lineNum">    2288</span>                 :<span class="tlaUNC">           0 :         Txid hash = tx.GetHash();</span></span>
<span id="L2289"><span class="lineNum">    2289</span>                 :<span class="tlaUNC">           0 :         bool is_coinbase = tx.IsCoinBase();</span></span>
<span id="L2290"><span class="lineNum">    2290</span>                 :<span class="tlaUNC">           0 :         bool is_bip30_exception = (is_coinbase &amp;&amp; !fEnforceBIP30);</span></span>
<span id="L2291"><span class="lineNum">    2291</span>                 :             : </span>
<span id="L2292"><span class="lineNum">    2292</span>                 :             :         // Check that all outputs are available and match the outputs in the block itself</span>
<span id="L2293"><span class="lineNum">    2293</span>                 :             :         // exactly.</span>
<span id="L2294"><span class="lineNum">    2294</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (size_t o = 0; o &lt; tx.vout.size(); o++) {</span></span>
<span id="L2295"><span class="lineNum">    2295</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (!tx.vout[o].scriptPubKey.IsUnspendable()) {</span></span>
<span id="L2296"><span class="lineNum">    2296</span>                 :<span class="tlaUNC">           0 :                 COutPoint out(hash, o);</span></span>
<span id="L2297"><span class="lineNum">    2297</span>                 :<span class="tlaUNC">           0 :                 Coin coin;</span></span>
<span id="L2298"><span class="lineNum">    2298</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 bool is_spent = view.SpendCoin(out, &amp;coin);</span></span>
<span id="L2299"><span class="lineNum">    2299</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                 if (!is_spent || tx.vout[o] != coin.out || pindex-&gt;nHeight != coin.nHeight || is_coinbase != coin.fCoinBase) {</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L2300"><span class="lineNum">    2300</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     if (!is_bip30_exception) {</span></span>
<span id="L2301"><span class="lineNum">    2301</span>                 :<span class="tlaUNC">           0 :                         fClean = false; // transaction output mismatch</span></span>
<span id="L2302"><span class="lineNum">    2302</span>                 :             :                     }</span>
<span id="L2303"><span class="lineNum">    2303</span>                 :             :                 }</span>
<span id="L2304"><span class="lineNum">    2304</span>                 :<span class="tlaUNC">           0 :             }</span></span>
<span id="L2305"><span class="lineNum">    2305</span>                 :             :         }</span>
<span id="L2306"><span class="lineNum">    2306</span>                 :             : </span>
<span id="L2307"><span class="lineNum">    2307</span>                 :             :         // restore inputs</span>
<span id="L2308"><span class="lineNum">    2308</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (i &gt; 0) { // not coinbases</span></span>
<span id="L2309"><span class="lineNum">    2309</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             CTxUndo &amp;txundo = blockUndo.vtxundo[i-1];</span></span>
<span id="L2310"><span class="lineNum">    2310</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             if (txundo.vprevout.size() != tx.vin.size()) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L2311"><span class="lineNum">    2311</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 LogError(&quot;DisconnectBlock(): transaction and undo data inconsistent\n&quot;);</span></span>
<span id="L2312"><span class="lineNum">    2312</span>                 :             :                 return DISCONNECT_FAILED;</span>
<span id="L2313"><span class="lineNum">    2313</span>                 :             :             }</span>
<span id="L2314"><span class="lineNum">    2314</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             for (unsigned int j = tx.vin.size(); j &gt; 0;) {</span></span>
<span id="L2315"><span class="lineNum">    2315</span>                 :<span class="tlaUNC">           0 :                 --j;</span></span>
<span id="L2316"><span class="lineNum">    2316</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 const COutPoint&amp; out = tx.vin[j].prevout;</span></span>
<span id="L2317"><span class="lineNum">    2317</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 int res = ApplyTxInUndo(std::move(txundo.vprevout[j]), view, out);</span></span>
<span id="L2318"><span class="lineNum">    2318</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 if (res == DISCONNECT_FAILED) return DISCONNECT_FAILED;</span></span>
<span id="L2319"><span class="lineNum">    2319</span>                 :<span class="tlaUNC">           0 :                 fClean = fClean &amp;&amp; res != DISCONNECT_UNCLEAN;</span></span>
<span id="L2320"><span class="lineNum">    2320</span>                 :             :             }</span>
<span id="L2321"><span class="lineNum">    2321</span>                 :             :             // At this point, all of txundo.vprevout should have been moved out.</span>
<span id="L2322"><span class="lineNum">    2322</span>                 :             :         }</span>
<span id="L2323"><span class="lineNum">    2323</span>                 :             :     }</span>
<span id="L2324"><span class="lineNum">    2324</span>                 :             : </span>
<span id="L2325"><span class="lineNum">    2325</span>                 :             :     // move best block pointer to prevout block</span>
<span id="L2326"><span class="lineNum">    2326</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     view.SetBestBlock(pindex-&gt;pprev-&gt;GetBlockHash());</span></span>
<span id="L2327"><span class="lineNum">    2327</span>                 :             : </span>
<span id="L2328"><span class="lineNum">    2328</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     return fClean ? DISCONNECT_OK : DISCONNECT_UNCLEAN;</span></span>
<span id="L2329"><span class="lineNum">    2329</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L2330"><span class="lineNum">    2330</span>                 :             : </span>
<span id="L2331"><span class="lineNum">    2331</span>                 :<span class="tlaGNC">      706540 : static unsigned int GetBlockScriptFlags(const CBlockIndex&amp; block_index, const ChainstateManager&amp; chainman)</span></span>
<span id="L2332"><span class="lineNum">    2332</span>                 :             : {</span>
<span id="L2333"><span class="lineNum">    2333</span>                 :<span class="tlaGNC">      706540 :     const Consensus::Params&amp; consensusparams = chainman.GetConsensus();</span></span>
<span id="L2334"><span class="lineNum">    2334</span>                 :             : </span>
<span id="L2335"><span class="lineNum">    2335</span>                 :             :     // BIP16 didn't become active until Apr 1 2012 (on mainnet, and</span>
<span id="L2336"><span class="lineNum">    2336</span>                 :             :     // retroactively applied to testnet)</span>
<span id="L2337"><span class="lineNum">    2337</span>                 :             :     // However, only one historical block violated the P2SH rules (on both</span>
<span id="L2338"><span class="lineNum">    2338</span>                 :             :     // mainnet and testnet).</span>
<span id="L2339"><span class="lineNum">    2339</span>                 :             :     // Similarly, only one historical block violated the TAPROOT rules on</span>
<span id="L2340"><span class="lineNum">    2340</span>                 :             :     // mainnet.</span>
<span id="L2341"><span class="lineNum">    2341</span>                 :             :     // For simplicity, always leave P2SH+WITNESS+TAPROOT on except for the two</span>
<span id="L2342"><span class="lineNum">    2342</span>                 :             :     // violating blocks.</span>
<span id="L2343"><span class="lineNum">    2343</span>                 :<span class="tlaGNC">      706540 :     uint32_t flags{SCRIPT_VERIFY_P2SH | SCRIPT_VERIFY_WITNESS | SCRIPT_VERIFY_TAPROOT};</span></span>
<span id="L2344"><span class="lineNum">    2344</span>                 :<span class="tlaGNC">      706540 :     const auto it{consensusparams.script_flag_exceptions.find(*Assert(block_index.phashBlock))};</span></span>
<span id="L2345"><span class="lineNum">    2345</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 706540 times"> + </span>]:<span class="tlaGNC">      706540 :     if (it != consensusparams.script_flag_exceptions.end()) {</span></span>
<span id="L2346"><span class="lineNum">    2346</span>                 :<span class="tlaUNC">           0 :         flags = it-&gt;second;</span></span>
<span id="L2347"><span class="lineNum">    2347</span>                 :             :     }</span>
<span id="L2348"><span class="lineNum">    2348</span>                 :             : </span>
<span id="L2349"><span class="lineNum">    2349</span>                 :             :     // Enforce the DERSIG (BIP66) rule</span>
<span id="L2350"><span class="lineNum">    2350</span>         [<span class="tlaGBC" title="Branch 0 was taken 706540 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      706540 :     if (DeploymentActiveAt(block_index, chainman, Consensus::DEPLOYMENT_DERSIG)) {</span></span>
<span id="L2351"><span class="lineNum">    2351</span>                 :<span class="tlaGNC">      706540 :         flags |= SCRIPT_VERIFY_DERSIG;</span></span>
<span id="L2352"><span class="lineNum">    2352</span>                 :             :     }</span>
<span id="L2353"><span class="lineNum">    2353</span>                 :             : </span>
<span id="L2354"><span class="lineNum">    2354</span>                 :             :     // Enforce CHECKLOCKTIMEVERIFY (BIP65)</span>
<span id="L2355"><span class="lineNum">    2355</span>         [<span class="tlaGBC" title="Branch 0 was taken 706540 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      706540 :     if (DeploymentActiveAt(block_index, chainman, Consensus::DEPLOYMENT_CLTV)) {</span></span>
<span id="L2356"><span class="lineNum">    2356</span>                 :<span class="tlaGNC">      706540 :         flags |= SCRIPT_VERIFY_CHECKLOCKTIMEVERIFY;</span></span>
<span id="L2357"><span class="lineNum">    2357</span>                 :             :     }</span>
<span id="L2358"><span class="lineNum">    2358</span>                 :             : </span>
<span id="L2359"><span class="lineNum">    2359</span>                 :             :     // Enforce CHECKSEQUENCEVERIFY (BIP112)</span>
<span id="L2360"><span class="lineNum">    2360</span>         [<span class="tlaGBC" title="Branch 0 was taken 706540 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      706540 :     if (DeploymentActiveAt(block_index, chainman, Consensus::DEPLOYMENT_CSV)) {</span></span>
<span id="L2361"><span class="lineNum">    2361</span>                 :<span class="tlaGNC">      706540 :         flags |= SCRIPT_VERIFY_CHECKSEQUENCEVERIFY;</span></span>
<span id="L2362"><span class="lineNum">    2362</span>                 :             :     }</span>
<span id="L2363"><span class="lineNum">    2363</span>                 :             : </span>
<span id="L2364"><span class="lineNum">    2364</span>                 :             :     // Enforce BIP147 NULLDUMMY (activated simultaneously with segwit)</span>
<span id="L2365"><span class="lineNum">    2365</span>         [<span class="tlaGBC" title="Branch 0 was taken 706540 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      706540 :     if (DeploymentActiveAt(block_index, chainman, Consensus::DEPLOYMENT_SEGWIT)) {</span></span>
<span id="L2366"><span class="lineNum">    2366</span>                 :<span class="tlaGNC">      706540 :         flags |= SCRIPT_VERIFY_NULLDUMMY;</span></span>
<span id="L2367"><span class="lineNum">    2367</span>                 :             :     }</span>
<span id="L2368"><span class="lineNum">    2368</span>                 :             : </span>
<span id="L2369"><span class="lineNum">    2369</span>                 :<span class="tlaGNC">      706540 :     return flags;</span></span>
<span id="L2370"><span class="lineNum">    2370</span>                 :             : }</span>
<span id="L2371"><span class="lineNum">    2371</span>                 :             : </span>
<span id="L2372"><span class="lineNum">    2372</span>                 :             : </span>
<span id="L2373"><span class="lineNum">    2373</span>                 :             : /** Apply the effects of this block (with given index) on the UTXO set represented by coins.</span>
<span id="L2374"><span class="lineNum">    2374</span>                 :             :  *  Validity checks that depend on the UTXO set are also done; ConnectBlock()</span>
<span id="L2375"><span class="lineNum">    2375</span>                 :             :  *  can fail if those validity checks fail (among other reasons). */</span>
<span id="L2376"><span class="lineNum">    2376</span>                 :<span class="tlaGNC">      465169 : bool Chainstate::ConnectBlock(const CBlock&amp; block, BlockValidationState&amp; state, CBlockIndex* pindex,</span></span>
<span id="L2377"><span class="lineNum">    2377</span>                 :             :                                CCoinsViewCache&amp; view, bool fJustCheck)</span>
<span id="L2378"><span class="lineNum">    2378</span>                 :             : {</span>
<span id="L2379"><span class="lineNum">    2379</span>                 :<span class="tlaGNC">      465169 :     AssertLockHeld(cs_main);</span></span>
<span id="L2380"><span class="lineNum">    2380</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 465169 times"> + </span>]:<span class="tlaGNC">      465169 :     assert(pindex);</span></span>
<span id="L2381"><span class="lineNum">    2381</span>                 :             : </span>
<span id="L2382"><span class="lineNum">    2382</span>                 :<span class="tlaGNC">      465169 :     uint256 block_hash{block.GetHash()};</span></span>
<span id="L2383"><span class="lineNum">    2383</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 465169 times"> + </span>]:<span class="tlaGNC">      465169 :     assert(*pindex-&gt;phashBlock == block_hash);</span></span>
<span id="L2384"><span class="lineNum">    2384</span>                 :             : </span>
<span id="L2385"><span class="lineNum">    2385</span>                 :<span class="tlaGNC">      465169 :     const auto time_start{SteadyClock::now()};</span></span>
<span id="L2386"><span class="lineNum">    2386</span>                 :<span class="tlaGNC">      465169 :     const CChainParams&amp; params{m_chainman.GetParams()};</span></span>
<span id="L2387"><span class="lineNum">    2387</span>                 :             : </span>
<span id="L2388"><span class="lineNum">    2388</span>                 :             :     // Check it again in case a previous version let a bad block in</span>
<span id="L2389"><span class="lineNum">    2389</span>                 :             :     // NOTE: We don't currently (re-)invoke ContextualCheckBlock() or</span>
<span id="L2390"><span class="lineNum">    2390</span>                 :             :     // ContextualCheckBlockHeader() here. This means that if we add a new</span>
<span id="L2391"><span class="lineNum">    2391</span>                 :             :     // consensus rule that is enforced in one of those two functions, then we</span>
<span id="L2392"><span class="lineNum">    2392</span>                 :             :     // may have let in a block that violates the rule prior to updating the</span>
<span id="L2393"><span class="lineNum">    2393</span>                 :             :     // software, and we would NOT be enforcing the rule here. Fully solving</span>
<span id="L2394"><span class="lineNum">    2394</span>                 :             :     // upgrade from one software version to the next after a consensus rule</span>
<span id="L2395"><span class="lineNum">    2395</span>                 :             :     // change is potentially tricky and issue-specific (see NeedsRedownload()</span>
<span id="L2396"><span class="lineNum">    2396</span>                 :             :     // for one approach that was used for BIP 141 deployment).</span>
<span id="L2397"><span class="lineNum">    2397</span>                 :             :     // Also, currently the rule against blocks more than 2 hours in the future</span>
<span id="L2398"><span class="lineNum">    2398</span>                 :             :     // is enforced in ContextualCheckBlockHeader(); we wouldn't want to</span>
<span id="L2399"><span class="lineNum">    2399</span>                 :             :     // re-enforce that rule here (at least until we make it impossible for</span>
<span id="L2400"><span class="lineNum">    2400</span>                 :             :     // the clock to go backward).</span>
<span id="L2401"><span class="lineNum">    2401</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 465169 times"> + </span>]:<span class="tlaGNC">      465169 :     if (!CheckBlock(block, state, params.GetConsensus(), !fJustCheck, !fJustCheck)) {</span></span>
<span id="L2402"><span class="lineNum">    2402</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (state.GetResult() == BlockValidationResult::BLOCK_MUTATED) {</span></span>
<span id="L2403"><span class="lineNum">    2403</span>                 :             :             // We don't write down blocks to disk if they may have been</span>
<span id="L2404"><span class="lineNum">    2404</span>                 :             :             // corrupted, so this should be impossible unless we're having hardware</span>
<span id="L2405"><span class="lineNum">    2405</span>                 :             :             // problems.</span>
<span id="L2406"><span class="lineNum">    2406</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             return FatalError(m_chainman.GetNotifications(), state, _(&quot;Corrupt block found indicating potential hardware failure.&quot;));</span></span>
<span id="L2407"><span class="lineNum">    2407</span>                 :             :         }</span>
<span id="L2408"><span class="lineNum">    2408</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LogError(&quot;%s: Consensus::CheckBlock: %s\n&quot;, __func__, state.ToString());</span></span>
<span id="L2409"><span class="lineNum">    2409</span>                 :<span class="tlaUNC">           0 :         return false;</span></span>
<span id="L2410"><span class="lineNum">    2410</span>                 :             :     }</span>
<span id="L2411"><span class="lineNum">    2411</span>                 :             : </span>
<span id="L2412"><span class="lineNum">    2412</span>                 :             :     // verify that the view's current state corresponds to the previous block</span>
<span id="L2413"><span class="lineNum">    2413</span>         [<span class="tlaGBC" title="Branch 0 was taken 2960 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 462209 times"> + </span>]:<span class="tlaGNC">      465169 :     uint256 hashPrevBlock = pindex-&gt;pprev == nullptr ? uint256() : pindex-&gt;pprev-&gt;GetBlockHash();</span></span>
<span id="L2414"><span class="lineNum">    2414</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 465169 times"> + </span>]:<span class="tlaGNC">      465169 :     assert(hashPrevBlock == view.GetBestBlock());</span></span>
<span id="L2415"><span class="lineNum">    2415</span>                 :             : </span>
<span id="L2416"><span class="lineNum">    2416</span>                 :<span class="tlaGNC">      465169 :     m_chainman.num_blocks_total++;</span></span>
<span id="L2417"><span class="lineNum">    2417</span>                 :             : </span>
<span id="L2418"><span class="lineNum">    2418</span>                 :             :     // Special case for the genesis block, skipping connection of its transactions</span>
<span id="L2419"><span class="lineNum">    2419</span>                 :             :     // (its coinbase is unspendable)</span>
<span id="L2420"><span class="lineNum">    2420</span>         [<span class="tlaGBC" title="Branch 0 was taken 2960 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 462209 times"> + </span>]:<span class="tlaGNC">      465169 :     if (block_hash == params.GetConsensus().hashGenesisBlock) {</span></span>
<span id="L2421"><span class="lineNum">    2421</span>         [<span class="tlaGBC" title="Branch 0 was taken 2960 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        2960 :         if (!fJustCheck)</span></span>
<span id="L2422"><span class="lineNum">    2422</span>                 :<span class="tlaGNC">        2960 :             view.SetBestBlock(pindex-&gt;GetBlockHash());</span></span>
<span id="L2423"><span class="lineNum">    2423</span>                 :<span class="tlaGNC">        2960 :         return true;</span></span>
<span id="L2424"><span class="lineNum">    2424</span>                 :             :     }</span>
<span id="L2425"><span class="lineNum">    2425</span>                 :             : </span>
<span id="L2426"><span class="lineNum">    2426</span>                 :<span class="tlaGNC">      462209 :     bool fScriptChecks = true;</span></span>
<span id="L2427"><span class="lineNum">    2427</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 462209 times"> + </span>]:<span class="tlaGNC">      924418 :     if (!m_chainman.AssumedValidBlock().IsNull()) {</span></span>
<span id="L2428"><span class="lineNum">    2428</span>                 :             :         // We've been configured with the hash of a block which has been externally verified to have a valid history.</span>
<span id="L2429"><span class="lineNum">    2429</span>                 :             :         // A suitable default value is included with the software and updated from time to time.  Because validity</span>
<span id="L2430"><span class="lineNum">    2430</span>                 :             :         //  relative to a piece of software is an objective fact these defaults can be easily reviewed.</span>
<span id="L2431"><span class="lineNum">    2431</span>                 :             :         // This setting doesn't force the selection of any particular chain but makes validating some faster by</span>
<span id="L2432"><span class="lineNum">    2432</span>                 :             :         //  effectively caching the result of part of the verification.</span>
<span id="L2433"><span class="lineNum">    2433</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         BlockMap::const_iterator it{m_blockman.m_block_index.find(m_chainman.AssumedValidBlock())};</span></span>
<span id="L2434"><span class="lineNum">    2434</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (it != m_blockman.m_block_index.end()) {</span></span>
<span id="L2435"><span class="lineNum">    2435</span>                 :<span class="tlaUNC">           0 :             if (it-&gt;second.GetAncestor(pindex-&gt;nHeight) == pindex &amp;&amp;</span></span>
<span id="L2436"><span class="lineNum">    2436</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                 m_chainman.m_best_header-&gt;GetAncestor(pindex-&gt;nHeight) == pindex &amp;&amp;</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L2437"><span class="lineNum">    2437</span>                 :<span class="tlaUNC">           0 :                 m_chainman.m_best_header-&gt;nChainWork &gt;= m_chainman.MinimumChainWork()) {</span></span>
<span id="L2438"><span class="lineNum">    2438</span>                 :             :                 // This block is a member of the assumed verified chain and an ancestor of the best header.</span>
<span id="L2439"><span class="lineNum">    2439</span>                 :             :                 // Script verification is skipped when connecting blocks under the</span>
<span id="L2440"><span class="lineNum">    2440</span>                 :             :                 // assumevalid block. Assuming the assumevalid block is valid this</span>
<span id="L2441"><span class="lineNum">    2441</span>                 :             :                 // is safe because block merkle hashes are still computed and checked,</span>
<span id="L2442"><span class="lineNum">    2442</span>                 :             :                 // Of course, if an assumed valid block is invalid due to false scriptSigs</span>
<span id="L2443"><span class="lineNum">    2443</span>                 :             :                 // this optimization would allow an invalid chain to be accepted.</span>
<span id="L2444"><span class="lineNum">    2444</span>                 :             :                 // The equivalent time check discourages hash power from extorting the network via DOS attack</span>
<span id="L2445"><span class="lineNum">    2445</span>                 :             :                 //  into accepting an invalid block through telling users they must manually set assumevalid.</span>
<span id="L2446"><span class="lineNum">    2446</span>                 :             :                 //  Requiring a software change or burying the invalid block, regardless of the setting, makes</span>
<span id="L2447"><span class="lineNum">    2447</span>                 :             :                 //  it hard to hide the implication of the demand.  This also avoids having release candidates</span>
<span id="L2448"><span class="lineNum">    2448</span>                 :             :                 //  that are hardly doing any signature verification at all in testing without having to</span>
<span id="L2449"><span class="lineNum">    2449</span>                 :             :                 //  artificially set the default assumed verified block further back.</span>
<span id="L2450"><span class="lineNum">    2450</span>                 :             :                 // The test against the minimum chain work prevents the skipping when denied access to any chain at</span>
<span id="L2451"><span class="lineNum">    2451</span>                 :             :                 //  least as good as the expected chain.</span>
<span id="L2452"><span class="lineNum">    2452</span>                 :<span class="tlaUNC">           0 :                 fScriptChecks = (GetBlockProofEquivalentTime(*m_chainman.m_best_header, *pindex, *m_chainman.m_best_header, params.GetConsensus()) &lt;= 60 * 60 * 24 * 7 * 2);</span></span>
<span id="L2453"><span class="lineNum">    2453</span>                 :             :             }</span>
<span id="L2454"><span class="lineNum">    2454</span>                 :             :         }</span>
<span id="L2455"><span class="lineNum">    2455</span>                 :             :     }</span>
<span id="L2456"><span class="lineNum">    2456</span>                 :             : </span>
<span id="L2457"><span class="lineNum">    2457</span>                 :<span class="tlaGNC">      462209 :     const auto time_1{SteadyClock::now()};</span></span>
<span id="L2458"><span class="lineNum">    2458</span>                 :<span class="tlaGNC">      462209 :     m_chainman.time_check += time_1 - time_start;</span></span>
<span id="L2459"><span class="lineNum">    2459</span>         [<span class="tlaGBC" title="Branch 0 was taken 301167 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 161042 times"> + </span>]:<span class="tlaGNC">      462209 :     LogDebug(BCLog::BENCH, &quot;    - Sanity checks: %.2fms [%.2fs (%.2fms/blk)]\n&quot;,</span></span>
<span id="L2460"><span class="lineNum">    2460</span>                 :             :              Ticks&lt;MillisecondsDouble&gt;(time_1 - time_start),</span>
<span id="L2461"><span class="lineNum">    2461</span>                 :             :              Ticks&lt;SecondsDouble&gt;(m_chainman.time_check),</span>
<span id="L2462"><span class="lineNum">    2462</span>                 :             :              Ticks&lt;MillisecondsDouble&gt;(m_chainman.time_check) / m_chainman.num_blocks_total);</span>
<span id="L2463"><span class="lineNum">    2463</span>                 :             : </span>
<span id="L2464"><span class="lineNum">    2464</span>                 :             :     // Do not allow blocks that contain transactions which 'overwrite' older transactions,</span>
<span id="L2465"><span class="lineNum">    2465</span>                 :             :     // unless those are already completely spent.</span>
<span id="L2466"><span class="lineNum">    2466</span>                 :             :     // If such overwrites are allowed, coinbases and transactions depending upon those</span>
<span id="L2467"><span class="lineNum">    2467</span>                 :             :     // can be duplicated to remove the ability to spend the first instance -- even after</span>
<span id="L2468"><span class="lineNum">    2468</span>                 :             :     // being sent to another address.</span>
<span id="L2469"><span class="lineNum">    2469</span>                 :             :     // See BIP30, CVE-2012-1909, and https://r6.ca/blog/20120206T005236Z.html for more information.</span>
<span id="L2470"><span class="lineNum">    2470</span>                 :             :     // This rule was originally applied to all blocks with a timestamp after March 15, 2012, 0:00 UTC.</span>
<span id="L2471"><span class="lineNum">    2471</span>                 :             :     // Now that the whole chain is irreversibly beyond that time it is applied to all blocks except the</span>
<span id="L2472"><span class="lineNum">    2472</span>                 :             :     // two in the chain that violate it. This prevents exploiting the issue against nodes during their</span>
<span id="L2473"><span class="lineNum">    2473</span>                 :             :     // initial block download.</span>
<span id="L2474"><span class="lineNum">    2474</span>                 :<span class="tlaGNC">      462209 :     bool fEnforceBIP30 = !IsBIP30Repeat(*pindex);</span></span>
<span id="L2475"><span class="lineNum">    2475</span>                 :             : </span>
<span id="L2476"><span class="lineNum">    2476</span>                 :             :     // Once BIP34 activated it was not possible to create new duplicate coinbases and thus other than starting</span>
<span id="L2477"><span class="lineNum">    2477</span>                 :             :     // with the 2 existing duplicate coinbase pairs, not possible to create overwriting txs.  But by the</span>
<span id="L2478"><span class="lineNum">    2478</span>                 :             :     // time BIP34 activated, in each of the existing pairs the duplicate coinbase had overwritten the first</span>
<span id="L2479"><span class="lineNum">    2479</span>                 :             :     // before the first had been spent.  Since those coinbases are sufficiently buried it's no longer possible to create further</span>
<span id="L2480"><span class="lineNum">    2480</span>                 :             :     // duplicate transactions descending from the known pairs either.</span>
<span id="L2481"><span class="lineNum">    2481</span>                 :             :     // If we're on the known chain at height greater than where BIP34 activated, we can save the db accesses needed for the BIP30 check.</span>
<span id="L2482"><span class="lineNum">    2482</span>                 :             : </span>
<span id="L2483"><span class="lineNum">    2483</span>                 :             :     // BIP34 requires that a block at height X (block X) has its coinbase</span>
<span id="L2484"><span class="lineNum">    2484</span>                 :             :     // scriptSig start with a CScriptNum of X (indicated height X).  The above</span>
<span id="L2485"><span class="lineNum">    2485</span>                 :             :     // logic of no longer requiring BIP30 once BIP34 activates is flawed in the</span>
<span id="L2486"><span class="lineNum">    2486</span>                 :             :     // case that there is a block X before the BIP34 height of 227,931 which has</span>
<span id="L2487"><span class="lineNum">    2487</span>                 :             :     // an indicated height Y where Y is greater than X.  The coinbase for block</span>
<span id="L2488"><span class="lineNum">    2488</span>                 :             :     // X would also be a valid coinbase for block Y, which could be a BIP30</span>
<span id="L2489"><span class="lineNum">    2489</span>                 :             :     // violation.  An exhaustive search of all mainnet coinbases before the</span>
<span id="L2490"><span class="lineNum">    2490</span>                 :             :     // BIP34 height which have an indicated height greater than the block height</span>
<span id="L2491"><span class="lineNum">    2491</span>                 :             :     // reveals many occurrences. The 3 lowest indicated heights found are</span>
<span id="L2492"><span class="lineNum">    2492</span>                 :             :     // 209,921, 490,897, and 1,983,702 and thus coinbases for blocks at these 3</span>
<span id="L2493"><span class="lineNum">    2493</span>                 :             :     // heights would be the first opportunity for BIP30 to be violated.</span>
<span id="L2494"><span class="lineNum">    2494</span>                 :             : </span>
<span id="L2495"><span class="lineNum">    2495</span>                 :             :     // The search reveals a great many blocks which have an indicated height</span>
<span id="L2496"><span class="lineNum">    2496</span>                 :             :     // greater than 1,983,702, so we simply remove the optimization to skip</span>
<span id="L2497"><span class="lineNum">    2497</span>                 :             :     // BIP30 checking for blocks at height 1,983,702 or higher.  Before we reach</span>
<span id="L2498"><span class="lineNum">    2498</span>                 :             :     // that block in another 25 years or so, we should take advantage of a</span>
<span id="L2499"><span class="lineNum">    2499</span>                 :             :     // future consensus change to do a new and improved version of BIP34 that</span>
<span id="L2500"><span class="lineNum">    2500</span>                 :             :     // will actually prevent ever creating any duplicate coinbases in the</span>
<span id="L2501"><span class="lineNum">    2501</span>                 :             :     // future.</span>
<span id="L2502"><span class="lineNum">    2502</span>                 :<span class="tlaGNC">      462209 :     static constexpr int BIP34_IMPLIES_BIP30_LIMIT = 1983702;</span></span>
<span id="L2503"><span class="lineNum">    2503</span>                 :             : </span>
<span id="L2504"><span class="lineNum">    2504</span>                 :             :     // There is no potential to create a duplicate coinbase at block 209,921</span>
<span id="L2505"><span class="lineNum">    2505</span>                 :             :     // because this is still before the BIP34 height and so explicit BIP30</span>
<span id="L2506"><span class="lineNum">    2506</span>                 :             :     // checking is still active.</span>
<span id="L2507"><span class="lineNum">    2507</span>                 :             : </span>
<span id="L2508"><span class="lineNum">    2508</span>                 :             :     // The final case is block 176,684 which has an indicated height of</span>
<span id="L2509"><span class="lineNum">    2509</span>                 :             :     // 490,897. Unfortunately, this issue was not discovered until about 2 weeks</span>
<span id="L2510"><span class="lineNum">    2510</span>                 :             :     // before block 490,897 so there was not much opportunity to address this</span>
<span id="L2511"><span class="lineNum">    2511</span>                 :             :     // case other than to carefully analyze it and determine it would not be a</span>
<span id="L2512"><span class="lineNum">    2512</span>                 :             :     // problem. Block 490,897 was, in fact, mined with a different coinbase than</span>
<span id="L2513"><span class="lineNum">    2513</span>                 :             :     // block 176,684, but it is important to note that even if it hadn't been or</span>
<span id="L2514"><span class="lineNum">    2514</span>                 :             :     // is remined on an alternate fork with a duplicate coinbase, we would still</span>
<span id="L2515"><span class="lineNum">    2515</span>                 :             :     // not run into a BIP30 violation.  This is because the coinbase for 176,684</span>
<span id="L2516"><span class="lineNum">    2516</span>                 :             :     // is spent in block 185,956 in transaction</span>
<span id="L2517"><span class="lineNum">    2517</span>                 :             :     // d4f7fbbf92f4a3014a230b2dc70b8058d02eb36ac06b4a0736d9d60eaa9e8781.  This</span>
<span id="L2518"><span class="lineNum">    2518</span>                 :             :     // spending transaction can't be duplicated because it also spends coinbase</span>
<span id="L2519"><span class="lineNum">    2519</span>                 :             :     // 0328dd85c331237f18e781d692c92de57649529bd5edf1d01036daea32ffde29.  This</span>
<span id="L2520"><span class="lineNum">    2520</span>                 :             :     // coinbase has an indicated height of over 4.2 billion, and wouldn't be</span>
<span id="L2521"><span class="lineNum">    2521</span>                 :             :     // duplicatable until that height, and it's currently impossible to create a</span>
<span id="L2522"><span class="lineNum">    2522</span>                 :             :     // chain that long. Nevertheless we may wish to consider a future soft fork</span>
<span id="L2523"><span class="lineNum">    2523</span>                 :             :     // which retroactively prevents block 490,897 from creating a duplicate</span>
<span id="L2524"><span class="lineNum">    2524</span>                 :             :     // coinbase. The two historical BIP30 violations often provide a confusing</span>
<span id="L2525"><span class="lineNum">    2525</span>                 :             :     // edge case when manipulating the UTXO and it would be simpler not to have</span>
<span id="L2526"><span class="lineNum">    2526</span>                 :             :     // another edge case to deal with.</span>
<span id="L2527"><span class="lineNum">    2527</span>                 :             : </span>
<span id="L2528"><span class="lineNum">    2528</span>                 :             :     // testnet3 has no blocks before the BIP34 height with indicated heights</span>
<span id="L2529"><span class="lineNum">    2529</span>                 :             :     // post BIP34 before approximately height 486,000,000. After block</span>
<span id="L2530"><span class="lineNum">    2530</span>                 :             :     // 1,983,702 testnet3 starts doing unnecessary BIP30 checking again.</span>
<span id="L2531"><span class="lineNum">    2531</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 462209 times"> + </span>]:<span class="tlaGNC">      462209 :     assert(pindex-&gt;pprev);</span></span>
<span id="L2532"><span class="lineNum">    2532</span>                 :<span class="tlaGNC">      462209 :     CBlockIndex* pindexBIP34height = pindex-&gt;pprev-&gt;GetAncestor(params.GetConsensus().BIP34Height);</span></span>
<span id="L2533"><span class="lineNum">    2533</span>                 :             :     //Only continue to enforce if we're below BIP34 activation height or the block hash at that height doesn't correspond.</span>
<span id="L2534"><span class="lineNum">    2534</span>   [<span class="tlaGBC" title="Branch 0 was taken 462209 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 448509 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 13700 times"> + </span> :<span class="tlaGNC">      462209 :     fEnforceBIP30 = fEnforceBIP30 &amp;&amp; (!pindexBIP34height || !(pindexBIP34height-&gt;GetBlockHash() == params.GetConsensus().BIP34Hash));</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaGBC" title="Branch 5 was taken 448509 times"> + </span>]
<span id="L2535"><span class="lineNum">    2535</span>                 :             : </span>
<span id="L2536"><span class="lineNum">    2536</span>                 :             :     // TODO: Remove BIP30 checking from block height 1,983,702 on, once we have a</span>
<span id="L2537"><span class="lineNum">    2537</span>                 :             :     // consensus change that ensures coinbases at those heights cannot</span>
<span id="L2538"><span class="lineNum">    2538</span>                 :             :     // duplicate earlier coinbases.</span>
<span id="L2539"><span class="lineNum">    2539</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (fEnforceBIP30 || pindex-&gt;nHeight &gt;= BIP34_IMPLIES_BIP30_LIMIT) {</span></span>
<span id="L2540"><span class="lineNum">    2540</span>         [<span class="tlaGBC" title="Branch 0 was taken 510251 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 462209 times"> + </span>]:<span class="tlaGNC">      972460 :         for (const auto&amp; tx : block.vtx) {</span></span>
<span id="L2541"><span class="lineNum">    2541</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 1768508 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 1258257 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 510251 times"> + </span>]:<span class="tlaGNC">     1768508 :             for (size_t o = 0; o &lt; tx-&gt;vout.size(); o++) {</span></span>
<span id="L2542"><span class="lineNum">    2542</span>         [<span class="tlaGBC" title="Branch 0 was taken 429 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 1257828 times"> + </span>]:<span class="tlaGNC">     1258257 :                 if (view.HaveCoin(COutPoint(tx-&gt;GetHash(), o))) {</span></span>
<span id="L2543"><span class="lineNum">    2543</span>   [<span class="tlaGBC" title="Branch 0 was taken 429 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 429 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">         858 :                     state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, &quot;bad-txns-BIP30&quot;,</span></span>
<span id="L2544"><span class="lineNum">    2544</span>                 :<span class="tlaGNC">         858 :                                   &quot;tried to overwrite transaction&quot;);</span></span>
<span id="L2545"><span class="lineNum">    2545</span>                 :             :                 }</span>
<span id="L2546"><span class="lineNum">    2546</span>                 :             :             }</span>
<span id="L2547"><span class="lineNum">    2547</span>                 :             :         }</span>
<span id="L2548"><span class="lineNum">    2548</span>                 :             :     }</span>
<span id="L2549"><span class="lineNum">    2549</span>                 :             : </span>
<span id="L2550"><span class="lineNum">    2550</span>                 :             :     // Enforce BIP68 (sequence locks)</span>
<span id="L2551"><span class="lineNum">    2551</span>                 :<span class="tlaGNC">      462209 :     int nLockTimeFlags = 0;</span></span>
<span id="L2552"><span class="lineNum">    2552</span>         [<span class="tlaGBC" title="Branch 0 was taken 462209 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      462209 :     if (DeploymentActiveAt(*pindex, m_chainman, Consensus::DEPLOYMENT_CSV)) {</span></span>
<span id="L2553"><span class="lineNum">    2553</span>                 :<span class="tlaGNC">      462209 :         nLockTimeFlags |= LOCKTIME_VERIFY_SEQUENCE;</span></span>
<span id="L2554"><span class="lineNum">    2554</span>                 :             :     }</span>
<span id="L2555"><span class="lineNum">    2555</span>                 :             : </span>
<span id="L2556"><span class="lineNum">    2556</span>                 :             :     // Get the script flags for this block</span>
<span id="L2557"><span class="lineNum">    2557</span>                 :<span class="tlaGNC">      462209 :     unsigned int flags{GetBlockScriptFlags(*pindex, m_chainman)};</span></span>
<span id="L2558"><span class="lineNum">    2558</span>                 :             : </span>
<span id="L2559"><span class="lineNum">    2559</span>                 :<span class="tlaGNC">      462209 :     const auto time_2{SteadyClock::now()};</span></span>
<span id="L2560"><span class="lineNum">    2560</span>                 :<span class="tlaGNC">      462209 :     m_chainman.time_forks += time_2 - time_1;</span></span>
<span id="L2561"><span class="lineNum">    2561</span>         [<span class="tlaGBC" title="Branch 0 was taken 301167 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 161042 times"> + </span>]:<span class="tlaGNC">      462209 :     LogDebug(BCLog::BENCH, &quot;    - Fork checks: %.2fms [%.2fs (%.2fms/blk)]\n&quot;,</span></span>
<span id="L2562"><span class="lineNum">    2562</span>                 :             :              Ticks&lt;MillisecondsDouble&gt;(time_2 - time_1),</span>
<span id="L2563"><span class="lineNum">    2563</span>                 :             :              Ticks&lt;SecondsDouble&gt;(m_chainman.time_forks),</span>
<span id="L2564"><span class="lineNum">    2564</span>                 :             :              Ticks&lt;MillisecondsDouble&gt;(m_chainman.time_forks) / m_chainman.num_blocks_total);</span>
<span id="L2565"><span class="lineNum">    2565</span>                 :             : </span>
<span id="L2566"><span class="lineNum">    2566</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 462209 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      462209 :     if (fScriptChecks != m_prev_script_checks_logged &amp;&amp; GetRole() == ChainstateRole::NORMAL) {</span></span>
<span id="L2567"><span class="lineNum">    2567</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LogInfo(&quot;%s signature validations at block #%d (%s).&quot;, fScriptChecks ? &quot;Enabling&quot; : &quot;Disabling&quot;, pindex-&gt;nHeight, block_hash.ToString());</span></span>
<span id="L2568"><span class="lineNum">    2568</span>                 :<span class="tlaUNC">           0 :         m_prev_script_checks_logged = fScriptChecks;</span></span>
<span id="L2569"><span class="lineNum">    2569</span>                 :             :     }</span>
<span id="L2570"><span class="lineNum">    2570</span>                 :             : </span>
<span id="L2571"><span class="lineNum">    2571</span>                 :<span class="tlaGNC">      462209 :     CBlockUndo blockundo;</span></span>
<span id="L2572"><span class="lineNum">    2572</span>                 :             : </span>
<span id="L2573"><span class="lineNum">    2573</span>                 :             :     // Precomputed transaction data pointers must not be invalidated</span>
<span id="L2574"><span class="lineNum">    2574</span>                 :             :     // until after `control` has run the script checks (potentially</span>
<span id="L2575"><span class="lineNum">    2575</span>                 :             :     // in multiple threads). Preallocate the vector size so a new allocation</span>
<span id="L2576"><span class="lineNum">    2576</span>                 :             :     // doesn't invalidate pointers into the vector, and keep txsdata in scope</span>
<span id="L2577"><span class="lineNum">    2577</span>                 :             :     // for as long as `control`.</span>
<span id="L2578"><span class="lineNum">    2578</span>                 :<span class="tlaGNC">      462209 :     std::optional&lt;CCheckQueueControl&lt;CScriptCheck&gt;&gt; control;</span></span>
<span id="L2579"><span class="lineNum">    2579</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 462209 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      462209 :     if (auto&amp; queue = m_chainman.GetCheckQueue(); queue.HasThreads() &amp;&amp; fScriptChecks) control.emplace(queue);</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L2580"><span class="lineNum">    2580</span>                 :             : </span>
<span id="L2581"><span class="lineNum">    2581</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 462209 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 462209 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      462209 :     std::vector&lt;PrecomputedTransactionData&gt; txsdata(block.vtx.size());</span></span>
<span id="L2582"><span class="lineNum">    2582</span>                 :             : </span>
<span id="L2583"><span class="lineNum">    2583</span>                 :<span class="tlaGNC">      462209 :     std::vector&lt;int&gt; prevheights;</span></span>
<span id="L2584"><span class="lineNum">    2584</span>                 :<span class="tlaGNC">      462209 :     CAmount nFees = 0;</span></span>
<span id="L2585"><span class="lineNum">    2585</span>                 :<span class="tlaGNC">      462209 :     int nInputs = 0;</span></span>
<span id="L2586"><span class="lineNum">    2586</span>                 :<span class="tlaGNC">      462209 :     int64_t nSigOpsCost = 0;</span></span>
<span id="L2587"><span class="lineNum">    2587</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 462209 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 462209 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      462209 :     blockundo.vtxundo.reserve(block.vtx.size() - 1);</span></span>
<span id="L2588"><span class="lineNum">    2588</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 951528 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 504687 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 446841 times"> + </span>]:<span class="tlaGNC">      951528 :     for (unsigned int i = 0; i &lt; block.vtx.size(); i++)</span></span>
<span id="L2589"><span class="lineNum">    2589</span>                 :             :     {</span>
<span id="L2590"><span class="lineNum">    2590</span>         [<span class="tlaGBC" title="Branch 0 was taken 504268 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 419 times"> + </span>]:<span class="tlaGNC">      504687 :         if (!state.IsValid()) break;</span></span>
<span id="L2591"><span class="lineNum">    2591</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 504268 times"> + </span>]:<span class="tlaGNC">      504268 :         const CTransaction &amp;tx = *(block.vtx[i]);</span></span>
<span id="L2592"><span class="lineNum">    2592</span>                 :             : </span>
<span id="L2593"><span class="lineNum">    2593</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 504268 times"> + </span>]:<span class="tlaGNC">      504268 :         nInputs += tx.vin.size();</span></span>
<span id="L2594"><span class="lineNum">    2594</span>                 :             : </span>
<span id="L2595"><span class="lineNum">    2595</span>         [<span class="tlaGBC" title="Branch 0 was taken 42478 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 461790 times"> + </span>]:<span class="tlaGNC">      504268 :         if (!tx.IsCoinBase())</span></span>
<span id="L2596"><span class="lineNum">    2596</span>                 :             :         {</span>
<span id="L2597"><span class="lineNum">    2597</span>                 :<span class="tlaGNC">       42478 :             CAmount txfee = 0;</span></span>
<span id="L2598"><span class="lineNum">    2598</span>         [<span class="tlaGBC" title="Branch 0 was taken 42478 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       42478 :             TxValidationState tx_state;</span></span>
<span id="L2599"><span class="lineNum">    2599</span>   [<span class="tlaGBC" title="Branch 0 was taken 42478 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 14949 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 27529 times"> + </span>]:<span class="tlaGNC">       42478 :             if (!Consensus::CheckTxInputs(tx, tx_state, view, pindex-&gt;nHeight, txfee)) {</span></span>
<span id="L2600"><span class="lineNum">    2600</span>                 :             :                 // Any transaction validation failure in ConnectBlock is a block consensus failure</span>
<span id="L2601"><span class="lineNum">    2601</span>                 :<span class="tlaGNC">       29898 :                 state.Invalid(BlockValidationResult::BLOCK_CONSENSUS,</span></span>
<span id="L2602"><span class="lineNum">    2602</span>         [<span class="tlaGBC" title="Branch 0 was taken 14949 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       29898 :                               tx_state.GetRejectReason(),</span></span>
<span id="L2603"><span class="lineNum">    2603</span>   [<span class="tlaGBC" title="Branch 0 was taken 14949 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 14949 times"> + </span> :<span class="tlaGNC">       59796 :                               tx_state.GetDebugMessage() + &quot; in transaction &quot; + tx.GetHash().ToString());</span></span>
<span class="lineNum">        </span>    <span class="tlaGBC" title="Branch 4 was taken 14949 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaGBC" title="Branch 6 was taken 14949 times"> + </span><span class="tlaUNC" title="Branch 7 was not taken"> - </span>]
<span id="L2604"><span class="lineNum">    2604</span>                 :<span class="tlaGNC">       14949 :                 break;</span></span>
<span id="L2605"><span class="lineNum">    2605</span>                 :             :             }</span>
<span id="L2606"><span class="lineNum">    2606</span>                 :<span class="tlaGNC">       27529 :             nFees += txfee;</span></span>
<span id="L2607"><span class="lineNum">    2607</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 27529 times"> + </span>]:<span class="tlaGNC">       27529 :             if (!MoneyRange(nFees)) {</span></span>
<span id="L2608"><span class="lineNum">    2608</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, &quot;bad-txns-accumulated-fee-outofrange&quot;,</span></span>
<span id="L2609"><span class="lineNum">    2609</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                               &quot;accumulated fee in the block out of range&quot;);</span></span>
<span id="L2610"><span class="lineNum">    2610</span>                 :<span class="tlaUNC">           0 :                 break;</span></span>
<span id="L2611"><span class="lineNum">    2611</span>                 :             :             }</span>
<span id="L2612"><span class="lineNum">    2612</span>                 :             : </span>
<span id="L2613"><span class="lineNum">    2613</span>                 :             :             // Check that transaction is BIP68 final</span>
<span id="L2614"><span class="lineNum">    2614</span>                 :             :             // BIP68 lock checks (as opposed to nLockTime checks) must</span>
<span id="L2615"><span class="lineNum">    2615</span>                 :             :             // be in ConnectBlock because they require the UTXO set</span>
<span id="L2616"><span class="lineNum">    2616</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 27529 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 27529 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">       27529 :             prevheights.resize(tx.vin.size());</span></span>
<span id="L2617"><span class="lineNum">    2617</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 70799 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 43270 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 27529 times"> + </span>]:<span class="tlaGNC">       70799 :             for (size_t j = 0; j &lt; tx.vin.size(); j++) {</span></span>
<span id="L2618"><span class="lineNum">    2618</span>         [<span class="tlaGBC" title="Branch 0 was taken 43270 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       43270 :                 prevheights[j] = view.AccessCoin(tx.vin[j].prevout).nHeight;</span></span>
<span id="L2619"><span class="lineNum">    2619</span>                 :             :             }</span>
<span id="L2620"><span class="lineNum">    2620</span>                 :             : </span>
<span id="L2621"><span class="lineNum">    2621</span>   [<span class="tlaGBC" title="Branch 0 was taken 27529 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 27529 times"> + </span>]:<span class="tlaGNC">       27529 :             if (!SequenceLocks(tx, nLockTimeFlags, prevheights, *pindex)) {</span></span>
<span id="L2622"><span class="lineNum">    2622</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, &quot;bad-txns-nonfinal&quot;,</span></span>
<span id="L2623"><span class="lineNum">    2623</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                               &quot;contains a non-BIP68-final transaction &quot; + tx.GetHash().ToString());</span></span>
<span id="L2624"><span class="lineNum">    2624</span>                 :<span class="tlaUNC">           0 :                 break;</span></span>
<span id="L2625"><span class="lineNum">    2625</span>                 :             :             }</span>
<span id="L2626"><span class="lineNum">    2626</span>                 :<span class="tlaGNC">       42478 :         }</span></span>
<span id="L2627"><span class="lineNum">    2627</span>                 :             : </span>
<span id="L2628"><span class="lineNum">    2628</span>                 :             :         // GetTransactionSigOpCost counts 3 types of sigops:</span>
<span id="L2629"><span class="lineNum">    2629</span>                 :             :         // * legacy (always)</span>
<span id="L2630"><span class="lineNum">    2630</span>                 :             :         // * p2sh (when P2SH enabled in flags and excludes coinbase)</span>
<span id="L2631"><span class="lineNum">    2631</span>                 :             :         // * witness (when witness enabled in flags and excludes coinbase)</span>
<span id="L2632"><span class="lineNum">    2632</span>         [<span class="tlaGBC" title="Branch 0 was taken 489319 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      489319 :         nSigOpsCost += GetTransactionSigOpCost(tx, view, flags);</span></span>
<span id="L2633"><span class="lineNum">    2633</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 489319 times"> + </span>]:<span class="tlaGNC">      489319 :         if (nSigOpsCost &gt; MAX_BLOCK_SIGOPS_COST) {</span></span>
<span id="L2634"><span class="lineNum">    2634</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, &quot;bad-blk-sigops&quot;, &quot;too many sigops&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L2635"><span class="lineNum">    2635</span>                 :<span class="tlaUNC">           0 :             break;</span></span>
<span id="L2636"><span class="lineNum">    2636</span>                 :             :         }</span>
<span id="L2637"><span class="lineNum">    2637</span>                 :             : </span>
<span id="L2638"><span class="lineNum">    2638</span>   [<span class="tlaGBC" title="Branch 0 was taken 27529 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 461790 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 27529 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      489319 :         if (!tx.IsCoinBase() &amp;&amp; fScriptChecks)</span></span>
<span id="L2639"><span class="lineNum">    2639</span>                 :             :         {</span>
<span id="L2640"><span class="lineNum">    2640</span>                 :<span class="tlaGNC">       27529 :             bool fCacheResults = fJustCheck; /* Don't cache results if we're actually connecting blocks (still consult the cache, though) */</span></span>
<span id="L2641"><span class="lineNum">    2641</span>                 :<span class="tlaGNC">       27529 :             bool tx_ok;</span></span>
<span id="L2642"><span class="lineNum">    2642</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 27529 times"> + </span>]:<span class="tlaGNC">       27529 :             TxValidationState tx_state;</span></span>
<span id="L2643"><span class="lineNum">    2643</span>                 :             :             // If CheckInputScripts is called with a pointer to a checks vector, the resulting checks are appended to it. In that case</span>
<span id="L2644"><span class="lineNum">    2644</span>                 :             :             // they need to be added to control which runs them asynchronously. Otherwise, CheckInputScripts runs the checks before returning.</span>
<span id="L2645"><span class="lineNum">    2645</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 27529 times"> + </span>]:<span class="tlaGNC">       27529 :             if (control) {</span></span>
<span id="L2646"><span class="lineNum">    2646</span>                 :<span class="tlaUNC">           0 :                 std::vector&lt;CScriptCheck&gt; vChecks;</span></span>
<span id="L2647"><span class="lineNum">    2647</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 tx_ok = CheckInputScripts(tx, tx_state, view, flags, fCacheResults, fCacheResults, txsdata[i], m_chainman.m_validation_cache, &amp;vChecks);</span></span>
<span id="L2648"><span class="lineNum">    2648</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 if (tx_ok) control-&gt;Add(std::move(vChecks));</span></span>
<span id="L2649"><span class="lineNum">    2649</span>                 :<span class="tlaUNC">           0 :             } else {</span></span>
<span id="L2650"><span class="lineNum">    2650</span>         [<span class="tlaGBC" title="Branch 0 was taken 27529 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       27529 :                 tx_ok = CheckInputScripts(tx, tx_state, view, flags, fCacheResults, fCacheResults, txsdata[i], m_chainman.m_validation_cache);</span></span>
<span id="L2651"><span class="lineNum">    2651</span>                 :             :             }</span>
<span id="L2652"><span class="lineNum">    2652</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 27529 times"> + </span>]:<span class="tlaGNC">       27529 :             if (!tx_ok) {</span></span>
<span id="L2653"><span class="lineNum">    2653</span>                 :             :                 // Any transaction validation failure in ConnectBlock is a block consensus failure</span>
<span id="L2654"><span class="lineNum">    2654</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 state.Invalid(BlockValidationResult::BLOCK_CONSENSUS,</span></span>
<span id="L2655"><span class="lineNum">    2655</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                               tx_state.GetRejectReason(), tx_state.GetDebugMessage());</span></span>
<span id="L2656"><span class="lineNum">    2656</span>                 :<span class="tlaUNC">           0 :                 break;</span></span>
<span id="L2657"><span class="lineNum">    2657</span>                 :             :             }</span>
<span id="L2658"><span class="lineNum">    2658</span>                 :<span class="tlaGNC">       27529 :         }</span></span>
<span id="L2659"><span class="lineNum">    2659</span>                 :             : </span>
<span id="L2660"><span class="lineNum">    2660</span>                 :<span class="tlaGNC">      489319 :         CTxUndo undoDummy;</span></span>
<span id="L2661"><span class="lineNum">    2661</span>         [<span class="tlaGBC" title="Branch 0 was taken 27529 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 461790 times"> + </span>]:<span class="tlaGNC">      489319 :         if (i &gt; 0) {</span></span>
<span id="L2662"><span class="lineNum">    2662</span>         [<span class="tlaGBC" title="Branch 0 was taken 27529 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       27529 :             blockundo.vtxundo.emplace_back();</span></span>
<span id="L2663"><span class="lineNum">    2663</span>                 :             :         }</span>
<span id="L2664"><span class="lineNum">    2664</span>   [<span class="tlaGBC" title="Branch 0 was taken 27529 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 461790 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 489319 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      489319 :         UpdateCoins(tx, view, i == 0 ? undoDummy : blockundo.vtxundo.back(), pindex-&gt;nHeight);</span></span>
<span id="L2665"><span class="lineNum">    2665</span>                 :<span class="tlaGNC">      489319 :     }</span></span>
<span id="L2666"><span class="lineNum">    2666</span>                 :<span class="tlaGNC">      462209 :     const auto time_3{SteadyClock::now()};</span></span>
<span id="L2667"><span class="lineNum">    2667</span>         [<span class="tlaGBC" title="Branch 0 was taken 462209 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      462209 :     m_chainman.time_connect += time_3 - time_2;</span></span>
<span id="L2668"><span class="lineNum">    2668</span>   [<span class="tlaGBC" title="Branch 0 was taken 462209 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 301167 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 161042 times"> + </span> :<span class="tlaGNC">      462209 :     LogDebug(BCLog::BENCH, &quot;      - Connect %u transactions: %.2fms (%.3fms/tx, %.3fms/txin) [%.2fs (%.2fms/blk)]\n&quot;, (unsigned)block.vtx.size(),</span></span>
<span class="lineNum">        </span> <span class="tlaGBC" title="Branch 4 was taken 15526 times"> + </span><span class="tlaGBC" title="Branch 5 was taken 285641 times"> + </span><span class="tlaUNC" title="Branch 6 was not taken"> - </span><span class="tlaGBC" title="Branch 7 was taken 301167 times"> + </span><span class="tlaGBC" title="Branch 8 was taken 301167 times"> + </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not taken"> - </span>]
<span id="L2669"><span class="lineNum">    2669</span>                 :             :              Ticks&lt;MillisecondsDouble&gt;(time_3 - time_2), Ticks&lt;MillisecondsDouble&gt;(time_3 - time_2) / block.vtx.size(),</span>
<span id="L2670"><span class="lineNum">    2670</span>                 :             :              nInputs &lt;= 1 ? 0 : Ticks&lt;MillisecondsDouble&gt;(time_3 - time_2) / (nInputs - 1),</span>
<span id="L2671"><span class="lineNum">    2671</span>                 :             :              Ticks&lt;SecondsDouble&gt;(m_chainman.time_connect),</span>
<span id="L2672"><span class="lineNum">    2672</span>                 :             :              Ticks&lt;MillisecondsDouble&gt;(m_chainman.time_connect) / m_chainman.num_blocks_total);</span>
<span id="L2673"><span class="lineNum">    2673</span>                 :             : </span>
<span id="L2674"><span class="lineNum">    2674</span>         [<span class="tlaGBC" title="Branch 0 was taken 462209 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      462209 :     CAmount blockReward = nFees + GetBlockSubsidy(pindex-&gt;nHeight, params.GetConsensus());</span></span>
<span id="L2675"><span class="lineNum">    2675</span>   [<span class="tlaGBC" title="Branch 0 was taken 462209 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 462209 times"> + </span> :<span class="tlaGNC">      462209 :     if (block.vtx[0]-&gt;GetValueOut() &gt; blockReward &amp;&amp; state.IsValid()) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L2676"><span class="lineNum">    2676</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, &quot;bad-cb-amount&quot;,</span></span>
<span id="L2677"><span class="lineNum">    2677</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                       strprintf(&quot;coinbase pays too much (actual=%d vs limit=%d)&quot;, block.vtx[0]-&gt;GetValueOut(), blockReward));</span></span>
<span id="L2678"><span class="lineNum">    2678</span>                 :             :     }</span>
<span id="L2679"><span class="lineNum">    2679</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 462209 times"> + </span>]:<span class="tlaGNC">      462209 :     if (control) {</span></span>
<span id="L2680"><span class="lineNum">    2680</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         auto parallel_result = control-&gt;Complete();</span></span>
<span id="L2681"><span class="lineNum">    2681</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (parallel_result.has_value() &amp;&amp; state.IsValid()) {</span></span>
<span id="L2682"><span class="lineNum">    2682</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, strprintf(&quot;block-script-verify-flag-failed (%s)&quot;, ScriptErrorString(parallel_result-&gt;first)), parallel_result-&gt;second);</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L2683"><span class="lineNum">    2683</span>                 :             :         }</span>
<span id="L2684"><span class="lineNum">    2684</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L2685"><span class="lineNum">    2685</span>         [<span class="tlaGBC" title="Branch 0 was taken 15368 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 446841 times"> + </span>]:<span class="tlaGNC">      462209 :     if (!state.IsValid()) {</span></span>
<span id="L2686"><span class="lineNum">    2686</span>   [<span class="tlaGBC" title="Branch 0 was taken 15368 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 15368 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">       15368 :         LogInfo(&quot;Block validation error: %s&quot;, state.ToString());</span></span>
<span id="L2687"><span class="lineNum">    2687</span>                 :<span class="tlaGNC">       15368 :         return false;</span></span>
<span id="L2688"><span class="lineNum">    2688</span>                 :             :     }</span>
<span id="L2689"><span class="lineNum">    2689</span>                 :<span class="tlaGNC">      446841 :     const auto time_4{SteadyClock::now()};</span></span>
<span id="L2690"><span class="lineNum">    2690</span>         [<span class="tlaGBC" title="Branch 0 was taken 446841 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      446841 :     m_chainman.time_verify += time_4 - time_2;</span></span>
<span id="L2691"><span class="lineNum">    2691</span>   [<span class="tlaGBC" title="Branch 0 was taken 446841 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 285799 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 161042 times"> + </span> :<span class="tlaGNC">      446841 :     LogDebug(BCLog::BENCH, &quot;    - Verify %u txins: %.2fms (%.3fms/txin) [%.2fs (%.2fms/blk)]\n&quot;, nInputs - 1,</span></span>
<span class="lineNum">        </span>    <span class="tlaGBC" title="Branch 4 was taken 577 times"> + </span><span class="tlaGBC" title="Branch 5 was taken 285222 times"> + </span><span class="tlaGBC" title="Branch 6 was taken 285799 times"> + </span><span class="tlaUNC" title="Branch 7 was not taken"> - </span>]
<span id="L2692"><span class="lineNum">    2692</span>                 :             :              Ticks&lt;MillisecondsDouble&gt;(time_4 - time_2),</span>
<span id="L2693"><span class="lineNum">    2693</span>                 :             :              nInputs &lt;= 1 ? 0 : Ticks&lt;MillisecondsDouble&gt;(time_4 - time_2) / (nInputs - 1),</span>
<span id="L2694"><span class="lineNum">    2694</span>                 :             :              Ticks&lt;SecondsDouble&gt;(m_chainman.time_verify),</span>
<span id="L2695"><span class="lineNum">    2695</span>                 :             :              Ticks&lt;MillisecondsDouble&gt;(m_chainman.time_verify) / m_chainman.num_blocks_total);</span>
<span id="L2696"><span class="lineNum">    2696</span>                 :             : </span>
<span id="L2697"><span class="lineNum">    2697</span>         [<span class="tlaGBC" title="Branch 0 was taken 197758 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 249083 times"> + </span>]:<span class="tlaGNC">      446841 :     if (fJustCheck) {</span></span>
<span id="L2698"><span class="lineNum">    2698</span>                 :             :         return true;</span>
<span id="L2699"><span class="lineNum">    2699</span>                 :             :     }</span>
<span id="L2700"><span class="lineNum">    2700</span>                 :             : </span>
<span id="L2701"><span class="lineNum">    2701</span>   [<span class="tlaGBC" title="Branch 0 was taken 197758 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 197758 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      197758 :     if (!m_blockman.WriteBlockUndo(blockundo, state, *pindex)) {</span></span>
<span id="L2702"><span class="lineNum">    2702</span>                 :             :         return false;</span>
<span id="L2703"><span class="lineNum">    2703</span>                 :             :     }</span>
<span id="L2704"><span class="lineNum">    2704</span>                 :             : </span>
<span id="L2705"><span class="lineNum">    2705</span>                 :<span class="tlaGNC">      197758 :     const auto time_5{SteadyClock::now()};</span></span>
<span id="L2706"><span class="lineNum">    2706</span>         [<span class="tlaGBC" title="Branch 0 was taken 197758 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      197758 :     m_chainman.time_undo += time_5 - time_4;</span></span>
<span id="L2707"><span class="lineNum">    2707</span>   [<span class="tlaGBC" title="Branch 0 was taken 197758 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 121758 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 76000 times"> + </span> :<span class="tlaGNC">      197758 :     LogDebug(BCLog::BENCH, &quot;    - Write undo data: %.2fms [%.2fs (%.2fms/blk)]\n&quot;,</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 121758 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L2708"><span class="lineNum">    2708</span>                 :             :              Ticks&lt;MillisecondsDouble&gt;(time_5 - time_4),</span>
<span id="L2709"><span class="lineNum">    2709</span>                 :             :              Ticks&lt;SecondsDouble&gt;(m_chainman.time_undo),</span>
<span id="L2710"><span class="lineNum">    2710</span>                 :             :              Ticks&lt;MillisecondsDouble&gt;(m_chainman.time_undo) / m_chainman.num_blocks_total);</span>
<span id="L2711"><span class="lineNum">    2711</span>                 :             : </span>
<span id="L2712"><span class="lineNum">    2712</span>   [<span class="tlaGBC" title="Branch 0 was taken 197758 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 197758 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      197758 :     if (!pindex-&gt;IsValid(BLOCK_VALID_SCRIPTS)) {</span></span>
<span id="L2713"><span class="lineNum">    2713</span>                 :<span class="tlaGNC">      197758 :         pindex-&gt;RaiseValidity(BLOCK_VALID_SCRIPTS);</span></span>
<span id="L2714"><span class="lineNum">    2714</span>         [<span class="tlaGBC" title="Branch 0 was taken 197758 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      197758 :         m_blockman.m_dirty_blockindex.insert(pindex);</span></span>
<span id="L2715"><span class="lineNum">    2715</span>                 :             :     }</span>
<span id="L2716"><span class="lineNum">    2716</span>                 :             : </span>
<span id="L2717"><span class="lineNum">    2717</span>                 :             :     // add this block to the view's block chain</span>
<span id="L2718"><span class="lineNum">    2718</span>         [<span class="tlaGBC" title="Branch 0 was taken 197758 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      197758 :     view.SetBestBlock(pindex-&gt;GetBlockHash());</span></span>
<span id="L2719"><span class="lineNum">    2719</span>                 :             : </span>
<span id="L2720"><span class="lineNum">    2720</span>                 :<span class="tlaGNC">      197758 :     const auto time_6{SteadyClock::now()};</span></span>
<span id="L2721"><span class="lineNum">    2721</span>         [<span class="tlaGBC" title="Branch 0 was taken 197758 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      197758 :     m_chainman.time_index += time_6 - time_5;</span></span>
<span id="L2722"><span class="lineNum">    2722</span>   [<span class="tlaGBC" title="Branch 0 was taken 197758 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 121758 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 76000 times"> + </span> :<span class="tlaGNC">      197758 :     LogDebug(BCLog::BENCH, &quot;    - Index writing: %.2fms [%.2fs (%.2fms/blk)]\n&quot;,</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 121758 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L2723"><span class="lineNum">    2723</span>                 :             :              Ticks&lt;MillisecondsDouble&gt;(time_6 - time_5),</span>
<span id="L2724"><span class="lineNum">    2724</span>                 :             :              Ticks&lt;SecondsDouble&gt;(m_chainman.time_index),</span>
<span id="L2725"><span class="lineNum">    2725</span>                 :             :              Ticks&lt;MillisecondsDouble&gt;(m_chainman.time_index) / m_chainman.num_blocks_total);</span>
<span id="L2726"><span class="lineNum">    2726</span>                 :             : </span>
<span id="L2727"><span class="lineNum">    2727</span>                 :             :     TRACEPOINT(validation, block_connected,</span>
<span id="L2728"><span class="lineNum">    2728</span>                 :             :         block_hash.data(),</span>
<span id="L2729"><span class="lineNum">    2729</span>                 :             :         pindex-&gt;nHeight,</span>
<span id="L2730"><span class="lineNum">    2730</span>                 :             :         block.vtx.size(),</span>
<span id="L2731"><span class="lineNum">    2731</span>                 :             :         nInputs,</span>
<span id="L2732"><span class="lineNum">    2732</span>                 :             :         nSigOpsCost,</span>
<span id="L2733"><span class="lineNum">    2733</span>                 :             :         Ticks&lt;std::chrono::nanoseconds&gt;(time_5 - time_start)</span>
<span id="L2734"><span class="lineNum">    2734</span>                 :             :     );</span>
<span id="L2735"><span class="lineNum">    2735</span>                 :             : </span>
<span id="L2736"><span class="lineNum">    2736</span>                 :             :     return true;</span>
<span id="L2737"><span class="lineNum">    2737</span>                 :<span class="tlaGNC">      462209 : }</span></span>
<span id="L2738"><span class="lineNum">    2738</span>                 :             : </span>
<span id="L2739"><span class="lineNum">    2739</span>                 :<span class="tlaGNC">     3264304 : CoinsCacheSizeState Chainstate::GetCoinsCacheSizeState()</span></span>
<span id="L2740"><span class="lineNum">    2740</span>                 :             : {</span>
<span id="L2741"><span class="lineNum">    2741</span>                 :<span class="tlaGNC">     3264304 :     AssertLockHeld(::cs_main);</span></span>
<span id="L2742"><span class="lineNum">    2742</span>                 :<span class="tlaGNC">     3264304 :     return this-&gt;GetCoinsCacheSizeState(</span></span>
<span id="L2743"><span class="lineNum">    2743</span>                 :             :         m_coinstip_cache_size_bytes,</span>
<span id="L2744"><span class="lineNum">    2744</span>         [<span class="tlaGBC" title="Branch 0 was taken 3264248 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 56 times"> + </span>]:<span class="tlaGNC">     3264304 :         m_mempool ? m_mempool-&gt;m_opts.max_size_bytes : 0);</span></span>
<span id="L2745"><span class="lineNum">    2745</span>                 :             : }</span>
<span id="L2746"><span class="lineNum">    2746</span>                 :             : </span>
<span id="L2747"><span class="lineNum">    2747</span>                 :<span class="tlaGNC">     3264304 : CoinsCacheSizeState Chainstate::GetCoinsCacheSizeState(</span></span>
<span id="L2748"><span class="lineNum">    2748</span>                 :             :     size_t max_coins_cache_size_bytes,</span>
<span id="L2749"><span class="lineNum">    2749</span>                 :             :     size_t max_mempool_size_bytes)</span>
<span id="L2750"><span class="lineNum">    2750</span>                 :             : {</span>
<span id="L2751"><span class="lineNum">    2751</span>                 :<span class="tlaGNC">     3264304 :     AssertLockHeld(::cs_main);</span></span>
<span id="L2752"><span class="lineNum">    2752</span>         [<span class="tlaGBC" title="Branch 0 was taken 3264248 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 56 times"> + </span>]:<span class="tlaGNC">     3264304 :     const int64_t nMempoolUsage = m_mempool ? m_mempool-&gt;DynamicMemoryUsage() : 0;</span></span>
<span id="L2753"><span class="lineNum">    2753</span>                 :<span class="tlaGNC">     3264304 :     int64_t cacheSize = CoinsTip().DynamicMemoryUsage();</span></span>
<span id="L2754"><span class="lineNum">    2754</span>                 :<span class="tlaGNC">     3264304 :     int64_t nTotalSpace =</span></span>
<span id="L2755"><span class="lineNum">    2755</span>         [<span class="tlaGBC" title="Branch 0 was taken 3002568 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 261736 times"> + </span>]:<span class="tlaGNC">     3264304 :         max_coins_cache_size_bytes + std::max&lt;int64_t&gt;(int64_t(max_mempool_size_bytes) - nMempoolUsage, 0);</span></span>
<span id="L2756"><span class="lineNum">    2756</span>                 :             : </span>
<span id="L2757"><span class="lineNum">    2757</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 3264304 times"> + </span>]:<span class="tlaGNC">     3264304 :     if (cacheSize &gt; nTotalSpace) {</span></span>
<span id="L2758"><span class="lineNum">    2758</span>                 :<span class="tlaUNC">           0 :         LogPrintf(&quot;Cache size (%s) exceeds total space (%s)\n&quot;, cacheSize, nTotalSpace);</span></span>
<span id="L2759"><span class="lineNum">    2759</span>                 :<span class="tlaUNC">           0 :         return CoinsCacheSizeState::CRITICAL;</span></span>
<span id="L2760"><span class="lineNum">    2760</span>   [<span class="tlaGBC" title="Branch 0 was taken 42 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 3264262 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 3264304 times"> + </span>]:<span class="tlaGNC">     3264346 :     } else if (cacheSize &gt; LargeCoinsCacheThreshold(nTotalSpace)) {</span></span>
<span id="L2761"><span class="lineNum">    2761</span>                 :<span class="tlaUNC">           0 :         return CoinsCacheSizeState::LARGE;</span></span>
<span id="L2762"><span class="lineNum">    2762</span>                 :             :     }</span>
<span id="L2763"><span class="lineNum">    2763</span>                 :             :     return CoinsCacheSizeState::OK;</span>
<span id="L2764"><span class="lineNum">    2764</span>                 :             : }</span>
<span id="L2765"><span class="lineNum">    2765</span>                 :             : </span>
<span id="L2766"><span class="lineNum">    2766</span>                 :<span class="tlaGNC">     3264304 : bool Chainstate::FlushStateToDisk(</span></span>
<span id="L2767"><span class="lineNum">    2767</span>                 :             :     BlockValidationState &amp;state,</span>
<span id="L2768"><span class="lineNum">    2768</span>                 :             :     FlushStateMode mode,</span>
<span id="L2769"><span class="lineNum">    2769</span>                 :             :     int nManualPruneHeight)</span>
<span id="L2770"><span class="lineNum">    2770</span>                 :             : {</span>
<span id="L2771"><span class="lineNum">    2771</span>                 :<span class="tlaGNC">     3264304 :     LOCK(cs_main);</span></span>
<span id="L2772"><span class="lineNum">    2772</span>         [<span class="tlaGBC" title="Branch 0 was taken 3264304 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">     3264304 :     assert(this-&gt;CanFlushToDisk());</span></span>
<span id="L2773"><span class="lineNum">    2773</span>         [<span class="tlaGBC" title="Branch 0 was taken 3264304 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">     3264304 :     std::set&lt;int&gt; setFilesToPrune;</span></span>
<span id="L2774"><span class="lineNum">    2774</span>                 :<span class="tlaGNC">     3264304 :     bool full_flush_completed = false;</span></span>
<span id="L2775"><span class="lineNum">    2775</span>                 :             : </span>
<span id="L2776"><span class="lineNum">    2776</span>   [<span class="tlaGBC" title="Branch 0 was taken 3264304 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 3264304 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">     3264304 :     const size_t coins_count = CoinsTip().GetCacheSize();</span></span>
<span id="L2777"><span class="lineNum">    2777</span>   [<span class="tlaGBC" title="Branch 0 was taken 3264304 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 3264304 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">     3264304 :     const size_t coins_mem_usage = CoinsTip().DynamicMemoryUsage();</span></span>
<span id="L2778"><span class="lineNum">    2778</span>                 :             : </span>
<span id="L2779"><span class="lineNum">    2779</span>                 :<span class="tlaGNC">     3264304 :     try {</span></span>
<span id="L2780"><span class="lineNum">    2780</span>                 :<span class="tlaGNC">     3264304 :     {</span></span>
<span id="L2781"><span class="lineNum">    2781</span>                 :<span class="tlaGNC">     3264304 :         bool fFlushForPrune = false;</span></span>
<span id="L2782"><span class="lineNum">    2782</span>                 :             : </span>
<span id="L2783"><span class="lineNum">    2783</span>         [<span class="tlaGBC" title="Branch 0 was taken 3264304 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">     3264304 :         CoinsCacheSizeState cache_state = GetCoinsCacheSizeState();</span></span>
<span id="L2784"><span class="lineNum">    2784</span>         [<span class="tlaGBC" title="Branch 0 was taken 3264304 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">     3264304 :         LOCK(m_blockman.cs_LastBlockFile);</span></span>
<span id="L2785"><span class="lineNum">    2785</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 3264304 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">     3264304 :         if (m_blockman.IsPruneMode() &amp;&amp; (m_blockman.m_check_for_pruning || nManualPruneHeight &gt; 0) &amp;&amp; m_chainman.m_blockman.m_blockfiles_indexed) {</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaUNC" title="Branch 6 was not taken"> - </span><span class="tlaUNC" title="Branch 7 was not taken"> - </span>]
<span id="L2786"><span class="lineNum">    2786</span>                 :             :             // make sure we don't prune above any of the prune locks bestblocks</span>
<span id="L2787"><span class="lineNum">    2787</span>                 :             :             // pruning is height-based</span>
<span id="L2788"><span class="lineNum">    2788</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             int last_prune{m_chain.Height()}; // last height we can prune</span></span>
<span id="L2789"><span class="lineNum">    2789</span>                 :<span class="tlaUNC">           0 :             std::optional&lt;std::string&gt; limiting_lock; // prune lock that actually was the limiting factor, only used for logging</span></span>
<span id="L2790"><span class="lineNum">    2790</span>                 :             : </span>
<span id="L2791"><span class="lineNum">    2791</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             for (const auto&amp; prune_lock : m_blockman.m_prune_locks) {</span></span>
<span id="L2792"><span class="lineNum">    2792</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 if (prune_lock.second.height_first == std::numeric_limits&lt;int&gt;::max()) continue;</span></span>
<span id="L2793"><span class="lineNum">    2793</span>                 :             :                 // Remove the buffer and one additional block here to get actual height that is outside of the buffer</span>
<span id="L2794"><span class="lineNum">    2794</span>                 :<span class="tlaUNC">           0 :                 const int lock_height{prune_lock.second.height_first - PRUNE_LOCK_BUFFER - 1};</span></span>
<span id="L2795"><span class="lineNum">    2795</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 last_prune = std::max(1, std::min(last_prune, lock_height));</span></span>
<span id="L2796"><span class="lineNum">    2796</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 if (last_prune == lock_height) {</span></span>
<span id="L2797"><span class="lineNum">    2797</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     limiting_lock = prune_lock.first;</span></span>
<span id="L2798"><span class="lineNum">    2798</span>                 :             :                 }</span>
<span id="L2799"><span class="lineNum">    2799</span>                 :             :             }</span>
<span id="L2800"><span class="lineNum">    2800</span>                 :             : </span>
<span id="L2801"><span class="lineNum">    2801</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (limiting_lock) {</span></span>
<span id="L2802"><span class="lineNum">    2802</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                 LogDebug(BCLog::PRUNE, &quot;%s limited pruning to height %d\n&quot;, limiting_lock.value(), last_prune);</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L2803"><span class="lineNum">    2803</span>                 :             :             }</span>
<span id="L2804"><span class="lineNum">    2804</span>                 :             : </span>
<span id="L2805"><span class="lineNum">    2805</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (nManualPruneHeight &gt; 0) {</span></span>
<span id="L2806"><span class="lineNum">    2806</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                 LOG_TIME_MILLIS_WITH_CATEGORY(&quot;find files to prune (manual)&quot;, BCLog::BENCH);</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L2807"><span class="lineNum">    2807</span>                 :             : </span>
<span id="L2808"><span class="lineNum">    2808</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 m_blockman.FindFilesToPruneManual(</span></span>
<span id="L2809"><span class="lineNum">    2809</span>                 :             :                     setFilesToPrune,</span>
<span id="L2810"><span class="lineNum">    2810</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     std::min(last_prune, nManualPruneHeight),</span></span>
<span id="L2811"><span class="lineNum">    2811</span>                 :             :                     *this, m_chainman);</span>
<span id="L2812"><span class="lineNum">    2812</span>                 :<span class="tlaUNC">           0 :             } else {</span></span>
<span id="L2813"><span class="lineNum">    2813</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                 LOG_TIME_MILLIS_WITH_CATEGORY(&quot;find files to prune&quot;, BCLog::BENCH);</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L2814"><span class="lineNum">    2814</span>                 :             : </span>
<span id="L2815"><span class="lineNum">    2815</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 m_blockman.FindFilesToPrune(setFilesToPrune, last_prune, *this, m_chainman);</span></span>
<span id="L2816"><span class="lineNum">    2816</span>                 :<span class="tlaUNC">           0 :                 m_blockman.m_check_for_pruning = false;</span></span>
<span id="L2817"><span class="lineNum">    2817</span>                 :<span class="tlaUNC">           0 :             }</span></span>
<span id="L2818"><span class="lineNum">    2818</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (!setFilesToPrune.empty()) {</span></span>
<span id="L2819"><span class="lineNum">    2819</span>                 :<span class="tlaUNC">           0 :                 fFlushForPrune = true;</span></span>
<span id="L2820"><span class="lineNum">    2820</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 if (!m_blockman.m_have_pruned) {</span></span>
<span id="L2821"><span class="lineNum">    2821</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     m_blockman.m_block_tree_db-&gt;WriteFlag(&quot;prunedblockfiles&quot;, true);</span></span>
<span id="L2822"><span class="lineNum">    2822</span>                 :<span class="tlaUNC">           0 :                     m_blockman.m_have_pruned = true;</span></span>
<span id="L2823"><span class="lineNum">    2823</span>                 :             :                 }</span>
<span id="L2824"><span class="lineNum">    2824</span>                 :             :             }</span>
<span id="L2825"><span class="lineNum">    2825</span>                 :<span class="tlaUNC">           0 :         }</span></span>
<span id="L2826"><span class="lineNum">    2826</span>                 :<span class="tlaGNC">     3264304 :         const auto nNow{NodeClock::now()};</span></span>
<span id="L2827"><span class="lineNum">    2827</span>                 :             :         // The cache is large and we're within 10% and 10 MiB of the limit, but we have time now (not in the middle of a block processing).</span>
<span id="L2828"><span class="lineNum">    2828</span>                 :<span class="tlaGNC">     3264304 :         bool fCacheLarge = mode == FlushStateMode::PERIODIC &amp;&amp; cache_state &gt;= CoinsCacheSizeState::LARGE;</span></span>
<span id="L2829"><span class="lineNum">    2829</span>                 :             :         // The cache is over the limit, we have to write now.</span>
<span id="L2830"><span class="lineNum">    2830</span>                 :<span class="tlaGNC">     3264304 :         bool fCacheCritical = mode == FlushStateMode::IF_NEEDED &amp;&amp; cache_state &gt;= CoinsCacheSizeState::CRITICAL;</span></span>
<span id="L2831"><span class="lineNum">    2831</span>                 :             :         // It's been a while since we wrote the block index and chain state to disk. Do this frequently, so we don't need to redownload or reindex after a crash.</span>
<span id="L2832"><span class="lineNum">    2832</span>   [<span class="tlaGBC" title="Branch 0 was taken 2683274 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 581030 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 2683147 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 127 times"> + </span>]:<span class="tlaGNC">     3264304 :         bool fPeriodicWrite = mode == FlushStateMode::PERIODIC &amp;&amp; nNow &gt;= m_next_write;</span></span>
<span id="L2833"><span class="lineNum">    2833</span>                 :             :         // Combine all conditions that result in a write to disk.</span>
<span id="L2834"><span class="lineNum">    2834</span>   [<span class="tlaGBC" title="Branch 0 was taken 3099402 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 164902 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 3099275 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 127 times"> + </span> :<span class="tlaGNC">     3264304 :         bool should_write = (mode == FlushStateMode::ALWAYS) || fCacheLarge || fCacheCritical || fPeriodicWrite || fFlushForPrune;</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaGBC" title="Branch 5 was taken 3099275 times"> + </span>]
<span id="L2835"><span class="lineNum">    2835</span>                 :             :         // Write blocks, block index and best chain related state to disk.</span>
<span id="L2836"><span class="lineNum">    2836</span>                 :<span class="tlaGNC">     3099275 :         if (should_write) {</span></span>
<span id="L2837"><span class="lineNum">    2837</span>   [<span class="tlaGBC" title="Branch 0 was taken 165029 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 162486 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 2543 times"> + </span> :<span class="tlaGNC">      165029 :             LogDebug(BCLog::COINDB, &quot;Writing chainstate to disk: flush mode=%s, prune=%d, large=%d, critical=%d, periodic=%d&quot;,</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 162486 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L2838"><span class="lineNum">    2838</span>                 :             :                      FlushStateModeNames[size_t(mode)], fFlushForPrune, fCacheLarge, fCacheCritical, fPeriodicWrite);</span>
<span id="L2839"><span class="lineNum">    2839</span>                 :             : </span>
<span id="L2840"><span class="lineNum">    2840</span>                 :             :             // Ensure we can write block index</span>
<span id="L2841"><span class="lineNum">    2841</span>   [<span class="tlaGBC" title="Branch 0 was taken 165029 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 165029 times"> + </span>]:<span class="tlaGNC">      165029 :             if (!CheckDiskSpace(m_blockman.m_opts.blocks_dir)) {</span></span>
<span id="L2842"><span class="lineNum">    2842</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 return FatalError(m_chainman.GetNotifications(), state, _(&quot;Disk space is too low!&quot;));</span></span>
<span id="L2843"><span class="lineNum">    2843</span>                 :             :             }</span>
<span id="L2844"><span class="lineNum">    2844</span>                 :<span class="tlaGNC">      165029 :             {</span></span>
<span id="L2845"><span class="lineNum">    2845</span>   [<span class="tlaGBC" title="Branch 0 was taken 165029 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 165029 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      330058 :                 LOG_TIME_MILLIS_WITH_CATEGORY(&quot;write block and undo data to disk&quot;, BCLog::BENCH);</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 165029 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L2846"><span class="lineNum">    2846</span>                 :             : </span>
<span id="L2847"><span class="lineNum">    2847</span>                 :             :                 // First make sure all block and undo data is flushed to disk.</span>
<span id="L2848"><span class="lineNum">    2848</span>                 :             :                 // TODO: Handle return error, or add detailed comment why it is</span>
<span id="L2849"><span class="lineNum">    2849</span>                 :             :                 // safe to not return an error upon failure.</span>
<span id="L2850"><span class="lineNum">    2850</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 165029 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 165029 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      165029 :                 if (!m_blockman.FlushChainstateBlockFile(m_chain.Height())) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaGBC" title="Branch 5 was taken 165029 times"> + </span>]
<span id="L2851"><span class="lineNum">    2851</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                     LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, &quot;%s: Failed to flush block file.\n&quot;, __func__);</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L2852"><span class="lineNum">    2852</span>                 :             :                 }</span>
<span id="L2853"><span class="lineNum">    2853</span>                 :<span class="tlaGNC">      165029 :             }</span></span>
<span id="L2854"><span class="lineNum">    2854</span>                 :             : </span>
<span id="L2855"><span class="lineNum">    2855</span>                 :             :             // Then update all block file information (which may refer to block and undo files).</span>
<span id="L2856"><span class="lineNum">    2856</span>                 :<span class="tlaGNC">      165029 :             {</span></span>
<span id="L2857"><span class="lineNum">    2857</span>   [<span class="tlaGBC" title="Branch 0 was taken 165029 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 165029 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      330058 :                 LOG_TIME_MILLIS_WITH_CATEGORY(&quot;write block index to disk&quot;, BCLog::BENCH);</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 165029 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L2858"><span class="lineNum">    2858</span>                 :             : </span>
<span id="L2859"><span class="lineNum">    2859</span>   [<span class="tlaGBC" title="Branch 0 was taken 165029 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 165029 times"> + </span>]:<span class="tlaGNC">      165029 :                 if (!m_blockman.WriteBlockIndexDB()) {</span></span>
<span id="L2860"><span class="lineNum">    2860</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     return FatalError(m_chainman.GetNotifications(), state, _(&quot;Failed to write to block index database.&quot;));</span></span>
<span id="L2861"><span class="lineNum">    2861</span>                 :             :                 }</span>
<span id="L2862"><span class="lineNum">    2862</span>                 :<span class="tlaGNC">      165029 :             }</span></span>
<span id="L2863"><span class="lineNum">    2863</span>                 :             :             // Finally remove any pruned files</span>
<span id="L2864"><span class="lineNum">    2864</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 165029 times"> + </span>]:<span class="tlaGNC">      165029 :             if (fFlushForPrune) {</span></span>
<span id="L2865"><span class="lineNum">    2865</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                 LOG_TIME_MILLIS_WITH_CATEGORY(&quot;unlink pruned files&quot;, BCLog::BENCH);</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L2866"><span class="lineNum">    2866</span>                 :             : </span>
<span id="L2867"><span class="lineNum">    2867</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 m_blockman.UnlinkPrunedFiles(setFilesToPrune);</span></span>
<span id="L2868"><span class="lineNum">    2868</span>                 :<span class="tlaUNC">           0 :             }</span></span>
<span id="L2869"><span class="lineNum">    2869</span>                 :             : </span>
<span id="L2870"><span class="lineNum">    2870</span>   [<span class="tlaGBC" title="Branch 0 was taken 165029 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 165029 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      330058 :             if (!CoinsTip().GetBestBlock().IsNull()) {</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 165029 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L2871"><span class="lineNum">    2871</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 165029 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      165029 :                 if (coins_mem_usage &gt;= WARN_FLUSH_COINS_SIZE) LogWarning(&quot;Flushing large (%d GiB) UTXO set to disk, it may take several minutes&quot;, coins_mem_usage &gt;&gt; 30);</span></span>
<span id="L2872"><span class="lineNum">    2872</span>   [<span class="tlaGBC" title="Branch 0 was taken 165029 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 165029 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      330058 :                 LOG_TIME_MILLIS_WITH_CATEGORY(strprintf(&quot;write coins cache to disk (%d coins, %.2fKiB)&quot;,</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 165029 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L2873"><span class="lineNum">    2873</span>                 :             :                     coins_count, coins_mem_usage &gt;&gt; 10), BCLog::BENCH);</span>
<span id="L2874"><span class="lineNum">    2874</span>                 :             : </span>
<span id="L2875"><span class="lineNum">    2875</span>                 :             :                 // Typical Coin structures on disk are around 48 bytes in size.</span>
<span id="L2876"><span class="lineNum">    2876</span>                 :             :                 // Pushing a new one to the database can cause it to be written</span>
<span id="L2877"><span class="lineNum">    2877</span>                 :             :                 // twice (once in the log, and once in the tables). This is already</span>
<span id="L2878"><span class="lineNum">    2878</span>                 :             :                 // an overestimation, as most will delete an existing entry or</span>
<span id="L2879"><span class="lineNum">    2879</span>                 :             :                 // overwrite one. Still, use a conservative safety factor of 2.</span>
<span id="L2880"><span class="lineNum">    2880</span>   [<span class="tlaGBC" title="Branch 0 was taken 165029 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 165029 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      165029 :                 if (!CheckDiskSpace(m_chainman.m_options.datadir, 48 * 2 * 2 * CoinsTip().GetCacheSize())) {</span></span>
<span class="lineNum">        </span>    <span class="tlaGBC" title="Branch 4 was taken 165029 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaUNC" title="Branch 6 was not taken"> - </span><span class="tlaGBC" title="Branch 7 was taken 165029 times"> + </span>]
<span id="L2881"><span class="lineNum">    2881</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     return FatalError(m_chainman.GetNotifications(), state, _(&quot;Disk space is too low!&quot;));</span></span>
<span id="L2882"><span class="lineNum">    2882</span>                 :             :                 }</span>
<span id="L2883"><span class="lineNum">    2883</span>                 :             :                 // Flush the chainstate (which may refer to block index entries).</span>
<span id="L2884"><span class="lineNum">    2884</span>   [<span class="tlaGBC" title="Branch 0 was taken 127 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 164902 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 127 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      165029 :                 const auto empty_cache{(mode == FlushStateMode::ALWAYS) || fCacheLarge || fCacheCritical};</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 127 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L2885"><span class="lineNum">    2885</span>   [<span class="tlaGBC" title="Branch 0 was taken 127 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 164902 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      165029 :                 if (empty_cache ? !CoinsTip().Flush() : !CoinsTip().Sync()) {</span></span>
<span class="lineNum">        </span> <span class="tlaGBC" title="Branch 4 was taken 164902 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaGBC" title="Branch 6 was taken 127 times"> + </span><span class="tlaUNC" title="Branch 7 was not taken"> - </span><span class="tlaUNC" title="Branch 8 was not taken"> - </span> 
<span class="lineNum">        </span>             <span class="tlaGBC" title="Branch 9 was taken 165029 times"> + </span>]
<span id="L2886"><span class="lineNum">    2886</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     return FatalError(m_chainman.GetNotifications(), state, _(&quot;Failed to write to coin database.&quot;));</span></span>
<span id="L2887"><span class="lineNum">    2887</span>                 :             :                 }</span>
<span id="L2888"><span class="lineNum">    2888</span>                 :<span class="tlaGNC">      165029 :                 full_flush_completed = true;</span></span>
<span id="L2889"><span class="lineNum">    2889</span>                 :             :                 TRACEPOINT(utxocache, flush,</span>
<span id="L2890"><span class="lineNum">    2890</span>                 :             :                     int64_t{Ticks&lt;std::chrono::microseconds&gt;(NodeClock::now() - nNow)},</span>
<span id="L2891"><span class="lineNum">    2891</span>                 :             :                     (uint32_t)mode,</span>
<span id="L2892"><span class="lineNum">    2892</span>                 :             :                     (uint64_t)coins_count,</span>
<span id="L2893"><span class="lineNum">    2893</span>                 :             :                     (uint64_t)coins_mem_usage,</span>
<span id="L2894"><span class="lineNum">    2894</span>                 :<span class="tlaGNC">      165029 :                     (bool)fFlushForPrune);</span></span>
<span id="L2895"><span class="lineNum">    2895</span>                 :<span class="tlaGNC">      165029 :             }</span></span>
<span id="L2896"><span class="lineNum">    2896</span>                 :             :         }</span>
<span id="L2897"><span class="lineNum">    2897</span>                 :             : </span>
<span id="L2898"><span class="lineNum">    2898</span>         [<span class="tlaGBC" title="Branch 0 was taken 2960 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 3096315 times"> + </span>]:<span class="tlaGNC">     3099275 :         if (should_write || m_next_write == NodeClock::time_point::max()) {</span></span>
<span id="L2899"><span class="lineNum">    2899</span>                 :<span class="tlaGNC">      167989 :             constexpr auto range{DATABASE_WRITE_INTERVAL_MAX - DATABASE_WRITE_INTERVAL_MIN};</span></span>
<span id="L2900"><span class="lineNum">    2900</span>                 :<span class="tlaGNC">      167989 :             m_next_write = FastRandomContext().rand_uniform_delay(NodeClock::now() + DATABASE_WRITE_INTERVAL_MIN, range);</span></span>
<span id="L2901"><span class="lineNum">    2901</span>                 :             :         }</span>
<span id="L2902"><span class="lineNum">    2902</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L2903"><span class="lineNum">    2903</span>   [<span class="tlaGBC" title="Branch 0 was taken 165029 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 3099275 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 162689 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 2340 times"> + </span>]:<span class="tlaGNC">     3264304 :     if (full_flush_completed &amp;&amp; m_chainman.m_options.signals) {</span></span>
<span id="L2904"><span class="lineNum">    2904</span>                 :             :         // Update best block in wallet (so we can detect restored wallets).</span>
<span id="L2905"><span class="lineNum">    2905</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 162689 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 162689 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      488067 :         m_chainman.m_options.signals-&gt;ChainStateFlushed(this-&gt;GetRole(), GetLocator(m_chain.Tip()));</span></span>
<span class="lineNum">        </span>    <span class="tlaGBC" title="Branch 4 was taken 162689 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaGBC" title="Branch 6 was taken 162689 times"> + </span><span class="tlaUNC" title="Branch 7 was not taken"> - </span>]
<span id="L2906"><span class="lineNum">    2906</span>                 :             :     }</span>
<span id="L2907"><span class="lineNum">    2907</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaUNC">           0 :     } catch (const std::runtime_error&amp; e) {</span></span>
<span id="L2908"><span class="lineNum">    2908</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaUNC">           0 :         return FatalError(m_chainman.GetNotifications(), state, strprintf(_(&quot;System error while flushing: %s&quot;), e.what()));</span></span>
<span id="L2909"><span class="lineNum">    2909</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L2910"><span class="lineNum">    2910</span>                 :             :     return true;</span>
<span id="L2911"><span class="lineNum">    2911</span>         [<span class="tlaGBC" title="Branch 0 was taken 3264304 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">     6528608 : }</span></span>
<span id="L2912"><span class="lineNum">    2912</span>                 :             : </span>
<span id="L2913"><span class="lineNum">    2913</span>                 :<span class="tlaGNC">      162562 : void Chainstate::ForceFlushStateToDisk()</span></span>
<span id="L2914"><span class="lineNum">    2914</span>                 :             : {</span>
<span id="L2915"><span class="lineNum">    2915</span>         [<span class="tlaGBC" title="Branch 0 was taken 162562 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      162562 :     BlockValidationState state;</span></span>
<span id="L2916"><span class="lineNum">    2916</span>   [<span class="tlaGBC" title="Branch 0 was taken 162562 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 162562 times"> + </span>]:<span class="tlaGNC">      162562 :     if (!this-&gt;FlushStateToDisk(state, FlushStateMode::ALWAYS)) {</span></span>
<span id="L2917"><span class="lineNum">    2917</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LogPrintf(&quot;%s: failed to flush state (%s)\n&quot;, __func__, state.ToString());</span></span>
<span id="L2918"><span class="lineNum">    2918</span>                 :             :     }</span>
<span id="L2919"><span class="lineNum">    2919</span>                 :<span class="tlaGNC">      162562 : }</span></span>
<span id="L2920"><span class="lineNum">    2920</span>                 :             : </span>
<span id="L2921"><span class="lineNum">    2921</span>                 :<span class="tlaUNC">           0 : void Chainstate::PruneAndFlush()</span></span>
<span id="L2922"><span class="lineNum">    2922</span>                 :             : {</span>
<span id="L2923"><span class="lineNum">    2923</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     BlockValidationState state;</span></span>
<span id="L2924"><span class="lineNum">    2924</span>                 :<span class="tlaUNC">           0 :     m_blockman.m_check_for_pruning = true;</span></span>
<span id="L2925"><span class="lineNum">    2925</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!this-&gt;FlushStateToDisk(state, FlushStateMode::NONE)) {</span></span>
<span id="L2926"><span class="lineNum">    2926</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LogPrintf(&quot;%s: failed to flush state (%s)\n&quot;, __func__, state.ToString());</span></span>
<span id="L2927"><span class="lineNum">    2927</span>                 :             :     }</span>
<span id="L2928"><span class="lineNum">    2928</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L2929"><span class="lineNum">    2929</span>                 :             : </span>
<span id="L2930"><span class="lineNum">    2930</span>                 :<span class="tlaGNC">      200718 : static void UpdateTipLog(</span></span>
<span id="L2931"><span class="lineNum">    2931</span>                 :             :     const ChainstateManager&amp; chainman,</span>
<span id="L2932"><span class="lineNum">    2932</span>                 :             :     const CCoinsViewCache&amp; coins_tip,</span>
<span id="L2933"><span class="lineNum">    2933</span>                 :             :     const CBlockIndex* tip,</span>
<span id="L2934"><span class="lineNum">    2934</span>                 :             :     const std::string&amp; func_name,</span>
<span id="L2935"><span class="lineNum">    2935</span>                 :             :     const std::string&amp; prefix,</span>
<span id="L2936"><span class="lineNum">    2936</span>                 :             :     const std::string&amp; warning_messages) EXCLUSIVE_LOCKS_REQUIRED(::cs_main)</span>
<span id="L2937"><span class="lineNum">    2937</span>                 :             : {</span>
<span id="L2938"><span class="lineNum">    2938</span>                 :             : </span>
<span id="L2939"><span class="lineNum">    2939</span>                 :<span class="tlaGNC">      200718 :     AssertLockHeld(::cs_main);</span></span>
<span id="L2940"><span class="lineNum">    2940</span>                 :             : </span>
<span id="L2941"><span class="lineNum">    2941</span>                 :             :     // Disable rate limiting in LogPrintLevel_ so this source location may log during IBD.</span>
<span id="L2942"><span class="lineNum">    2942</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 200718 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 200718 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      401436 :     LogPrintLevel_(BCLog::LogFlags::ALL, BCLog::Level::Info, /*should_ratelimit=*/false, &quot;%s%s: new best=%s height=%d version=0x%08x log2_work=%f tx=%lu date='%s' progress=%f cache=%.1fMiB(%utxo)%s\n&quot;,</span></span>
<span class="lineNum">        </span> <span class="tlaGBC" title="Branch 4 was taken 200718 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaGBC" title="Branch 6 was taken 200718 times"> + </span><span class="tlaUNC" title="Branch 7 was not taken"> - </span><span class="tlaGBC" title="Branch 8 was taken 200718 times"> + </span> 
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 9 was not taken"> - </span><span class="tlaGBC" title="Branch 10 was taken 200718 times"> + </span><span class="tlaUNC" title="Branch 11 was not taken"> - </span><span class="tlaGBC" title="Branch 12 was taken 200718 times"> + </span><span class="tlaUNC" title="Branch 13 was not taken"> - </span> 
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 14 was taken 200718 times"> + </span><span class="tlaUNC" title="Branch 15 was not taken"> - </span>]
<span id="L2943"><span class="lineNum">    2943</span>                 :             :                    prefix, func_name,</span>
<span id="L2944"><span class="lineNum">    2944</span>                 :             :                    tip-&gt;GetBlockHash().ToString(), tip-&gt;nHeight, tip-&gt;nVersion,</span>
<span id="L2945"><span class="lineNum">    2945</span>                 :             :                    log(tip-&gt;nChainWork.getdouble()) / log(2.0), tip-&gt;m_chain_tx_count,</span>
<span id="L2946"><span class="lineNum">    2946</span>                 :             :                    FormatISO8601DateTime(tip-&gt;GetBlockTime()),</span>
<span id="L2947"><span class="lineNum">    2947</span>                 :             :                    chainman.GuessVerificationProgress(tip),</span>
<span id="L2948"><span class="lineNum">    2948</span>                 :             :                    coins_tip.DynamicMemoryUsage() * (1.0 / (1 &lt;&lt; 20)),</span>
<span id="L2949"><span class="lineNum">    2949</span>                 :             :                    coins_tip.GetCacheSize(),</span>
<span id="L2950"><span class="lineNum">    2950</span>                 :             :                    !warning_messages.empty() ? strprintf(&quot; warning='%s'&quot;, warning_messages) : &quot;&quot;);</span>
<span id="L2951"><span class="lineNum">    2951</span>                 :<span class="tlaGNC">      200718 : }</span></span>
<span id="L2952"><span class="lineNum">    2952</span>                 :             : </span>
<span id="L2953"><span class="lineNum">    2953</span>                 :<span class="tlaGNC">      200718 : void Chainstate::UpdateTip(const CBlockIndex* pindexNew)</span></span>
<span id="L2954"><span class="lineNum">    2954</span>                 :             : {</span>
<span id="L2955"><span class="lineNum">    2955</span>                 :<span class="tlaGNC">      200718 :     AssertLockHeld(::cs_main);</span></span>
<span id="L2956"><span class="lineNum">    2956</span>                 :<span class="tlaGNC">      200718 :     const auto&amp; coins_tip = this-&gt;CoinsTip();</span></span>
<span id="L2957"><span class="lineNum">    2957</span>                 :             : </span>
<span id="L2958"><span class="lineNum">    2958</span>                 :             :     // The remainder of the function isn't relevant if we are not acting on</span>
<span id="L2959"><span class="lineNum">    2959</span>                 :             :     // the active chainstate, so return if need be.</span>
<span id="L2960"><span class="lineNum">    2960</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 200718 times"> + </span>]:<span class="tlaGNC">      200718 :     if (this != &amp;m_chainman.ActiveChainstate()) {</span></span>
<span id="L2961"><span class="lineNum">    2961</span>                 :             :         // Only log every so often so that we don't bury log messages at the tip.</span>
<span id="L2962"><span class="lineNum">    2962</span>                 :<span class="tlaUNC">           0 :         constexpr int BACKGROUND_LOG_INTERVAL = 2000;</span></span>
<span id="L2963"><span class="lineNum">    2963</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (pindexNew-&gt;nHeight % BACKGROUND_LOG_INTERVAL == 0) {</span></span>
<span id="L2964"><span class="lineNum">    2964</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             UpdateTipLog(m_chainman, coins_tip, pindexNew, __func__, &quot;[background validation] &quot;, &quot;&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L2965"><span class="lineNum">    2965</span>                 :             :         }</span>
<span id="L2966"><span class="lineNum">    2966</span>                 :<span class="tlaUNC">           0 :         return;</span></span>
<span id="L2967"><span class="lineNum">    2967</span>                 :             :     }</span>
<span id="L2968"><span class="lineNum">    2968</span>                 :             : </span>
<span id="L2969"><span class="lineNum">    2969</span>                 :             :     // New best block</span>
<span id="L2970"><span class="lineNum">    2970</span>         [<span class="tlaGBC" title="Branch 0 was taken 200718 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      200718 :     if (m_mempool) {</span></span>
<span id="L2971"><span class="lineNum">    2971</span>                 :<span class="tlaGNC">      200718 :         m_mempool-&gt;AddTransactionsUpdated(1);</span></span>
<span id="L2972"><span class="lineNum">    2972</span>                 :             :     }</span>
<span id="L2973"><span class="lineNum">    2973</span>                 :             : </span>
<span id="L2974"><span class="lineNum">    2974</span>                 :<span class="tlaGNC">      200718 :     std::vector&lt;bilingual_str&gt; warning_messages;</span></span>
<span id="L2975"><span class="lineNum">    2975</span>   [<span class="tlaGBC" title="Branch 0 was taken 200718 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 88338 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 112380 times"> + </span>]:<span class="tlaGNC">      200718 :     if (!m_chainman.IsInitialBlockDownload()) {</span></span>
<span id="L2976"><span class="lineNum">    2976</span>         [<span class="tlaGBC" title="Branch 0 was taken 88338 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       88338 :         auto bits = m_chainman.m_versionbitscache.CheckUnknownActivations(pindexNew, m_chainman.GetParams());</span></span>
<span id="L2977"><span class="lineNum">    2977</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 88338 times"> + </span>]:<span class="tlaGNC">       88338 :         for (auto [bit, active] : bits) {</span></span>
<span id="L2978"><span class="lineNum">    2978</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             const bilingual_str warning = strprintf(_(&quot;Unknown new rules activated (versionbit %i)&quot;), bit);</span></span>
<span id="L2979"><span class="lineNum">    2979</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (active) {</span></span>
<span id="L2980"><span class="lineNum">    2980</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 m_chainman.GetNotifications().warningSet(kernel::Warning::UNKNOWN_NEW_RULES_ACTIVATED, warning);</span></span>
<span id="L2981"><span class="lineNum">    2981</span>                 :             :             } else {</span>
<span id="L2982"><span class="lineNum">    2982</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 warning_messages.push_back(warning);</span></span>
<span id="L2983"><span class="lineNum">    2983</span>                 :             :             }</span>
<span id="L2984"><span class="lineNum">    2984</span>                 :<span class="tlaUNC">           0 :         }</span></span>
<span id="L2985"><span class="lineNum">    2985</span>                 :<span class="tlaGNC">       88338 :     }</span></span>
<span id="L2986"><span class="lineNum">    2986</span>   [<span class="tlaGBC" title="Branch 0 was taken 200718 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 200718 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      401436 :     UpdateTipLog(m_chainman, coins_tip, pindexNew, __func__, &quot;&quot;,</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 200718 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L2987"><span class="lineNum">    2987</span>   [<span class="tlaGBC" title="Branch 0 was taken 200718 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 200718 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      602154 :                  util::Join(warning_messages, Untranslated(&quot;, &quot;)).original);</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 200718 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L2988"><span class="lineNum">    2988</span>                 :<span class="tlaGNC">      200718 : }</span></span>
<span id="L2989"><span class="lineNum">    2989</span>                 :             : </span>
<span id="L2990"><span class="lineNum">    2990</span>                 :             : /** Disconnect m_chain's tip.</span>
<span id="L2991"><span class="lineNum">    2991</span>                 :             :   * After calling, the mempool will be in an inconsistent state, with</span>
<span id="L2992"><span class="lineNum">    2992</span>                 :             :   * transactions from disconnected blocks being added to disconnectpool.  You</span>
<span id="L2993"><span class="lineNum">    2993</span>                 :             :   * should make the mempool consistent again by calling MaybeUpdateMempoolForReorg.</span>
<span id="L2994"><span class="lineNum">    2994</span>                 :             :   * with cs_main held.</span>
<span id="L2995"><span class="lineNum">    2995</span>                 :             :   *</span>
<span id="L2996"><span class="lineNum">    2996</span>                 :             :   * If disconnectpool is nullptr, then no disconnected transactions are added to</span>
<span id="L2997"><span class="lineNum">    2997</span>                 :             :   * disconnectpool (note that the caller is responsible for mempool consistency</span>
<span id="L2998"><span class="lineNum">    2998</span>                 :             :   * in any case).</span>
<span id="L2999"><span class="lineNum">    2999</span>                 :             :   */</span>
<span id="L3000"><span class="lineNum">    3000</span>                 :<span class="tlaUNC">           0 : bool Chainstate::DisconnectTip(BlockValidationState&amp; state, DisconnectedBlockTransactions* disconnectpool)</span></span>
<span id="L3001"><span class="lineNum">    3001</span>                 :             : {</span>
<span id="L3002"><span class="lineNum">    3002</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_main);</span></span>
<span id="L3003"><span class="lineNum">    3003</span>                 :<span class="tlaUNC">           0 :     if (m_mempool) AssertLockHeld(m_mempool-&gt;cs);</span></span>
<span id="L3004"><span class="lineNum">    3004</span>                 :             : </span>
<span id="L3005"><span class="lineNum">    3005</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     CBlockIndex *pindexDelete = m_chain.Tip();</span></span>
<span id="L3006"><span class="lineNum">    3006</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     assert(pindexDelete);</span></span>
<span id="L3007"><span class="lineNum">    3007</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     assert(pindexDelete-&gt;pprev);</span></span>
<span id="L3008"><span class="lineNum">    3008</span>                 :             :     // Read block from disk.</span>
<span id="L3009"><span class="lineNum">    3009</span>                 :<span class="tlaUNC">           0 :     std::shared_ptr&lt;CBlock&gt; pblock = std::make_shared&lt;CBlock&gt;();</span></span>
<span id="L3010"><span class="lineNum">    3010</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     CBlock&amp; block = *pblock;</span></span>
<span id="L3011"><span class="lineNum">    3011</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!m_blockman.ReadBlock(block, *pindexDelete)) {</span></span>
<span id="L3012"><span class="lineNum">    3012</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LogError(&quot;DisconnectTip(): Failed to read block\n&quot;);</span></span>
<span id="L3013"><span class="lineNum">    3013</span>                 :             :         return false;</span>
<span id="L3014"><span class="lineNum">    3014</span>                 :             :     }</span>
<span id="L3015"><span class="lineNum">    3015</span>                 :             :     // Apply the block atomically to the chain state.</span>
<span id="L3016"><span class="lineNum">    3016</span>                 :<span class="tlaUNC">           0 :     const auto time_start{SteadyClock::now()};</span></span>
<span id="L3017"><span class="lineNum">    3017</span>                 :<span class="tlaUNC">           0 :     {</span></span>
<span id="L3018"><span class="lineNum">    3018</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         CCoinsViewCache view(&amp;CoinsTip());</span></span>
<span id="L3019"><span class="lineNum">    3019</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         assert(view.GetBestBlock() == pindexDelete-&gt;GetBlockHash());</span></span>
<span id="L3020"><span class="lineNum">    3020</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (DisconnectBlock(block, pindexDelete, view) != DISCONNECT_OK) {</span></span>
<span id="L3021"><span class="lineNum">    3021</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             LogError(&quot;DisconnectTip(): DisconnectBlock %s failed\n&quot;, pindexDelete-&gt;GetBlockHash().ToString());</span></span>
<span id="L3022"><span class="lineNum">    3022</span>                 :<span class="tlaUNC">           0 :             return false;</span></span>
<span id="L3023"><span class="lineNum">    3023</span>                 :             :         }</span>
<span id="L3024"><span class="lineNum">    3024</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         bool flushed = view.Flush();</span></span>
<span id="L3025"><span class="lineNum">    3025</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         assert(flushed);</span></span>
<span id="L3026"><span class="lineNum">    3026</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L3027"><span class="lineNum">    3027</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     LogDebug(BCLog::BENCH, &quot;- Disconnect block: %.2fms\n&quot;,</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L3028"><span class="lineNum">    3028</span>                 :             :              Ticks&lt;MillisecondsDouble&gt;(SteadyClock::now() - time_start));</span>
<span id="L3029"><span class="lineNum">    3029</span>                 :             : </span>
<span id="L3030"><span class="lineNum">    3030</span>                 :<span class="tlaUNC">           0 :     {</span></span>
<span id="L3031"><span class="lineNum">    3031</span>                 :             :         // Prune locks that began at or after the tip should be moved backward so they get a chance to reorg</span>
<span id="L3032"><span class="lineNum">    3032</span>                 :<span class="tlaUNC">           0 :         const int max_height_first{pindexDelete-&gt;nHeight - 1};</span></span>
<span id="L3033"><span class="lineNum">    3033</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (auto&amp; prune_lock : m_blockman.m_prune_locks) {</span></span>
<span id="L3034"><span class="lineNum">    3034</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (prune_lock.second.height_first &lt;= max_height_first) continue;</span></span>
<span id="L3035"><span class="lineNum">    3035</span>                 :             : </span>
<span id="L3036"><span class="lineNum">    3036</span>                 :<span class="tlaUNC">           0 :             prune_lock.second.height_first = max_height_first;</span></span>
<span id="L3037"><span class="lineNum">    3037</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             LogDebug(BCLog::PRUNE, &quot;%s prune lock moved back to %d\n&quot;, prune_lock.first, max_height_first);</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L3038"><span class="lineNum">    3038</span>                 :             :         }</span>
<span id="L3039"><span class="lineNum">    3039</span>                 :             :     }</span>
<span id="L3040"><span class="lineNum">    3040</span>                 :             : </span>
<span id="L3041"><span class="lineNum">    3041</span>                 :             :     // Write the chain state to disk, if necessary.</span>
<span id="L3042"><span class="lineNum">    3042</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!FlushStateToDisk(state, FlushStateMode::IF_NEEDED)) {</span></span>
<span id="L3043"><span class="lineNum">    3043</span>                 :             :         return false;</span>
<span id="L3044"><span class="lineNum">    3044</span>                 :             :     }</span>
<span id="L3045"><span class="lineNum">    3045</span>                 :             : </span>
<span id="L3046"><span class="lineNum">    3046</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (disconnectpool &amp;&amp; m_mempool) {</span></span>
<span id="L3047"><span class="lineNum">    3047</span>                 :             :         // Save transactions to re-add to mempool at end of reorg. If any entries are evicted for</span>
<span id="L3048"><span class="lineNum">    3048</span>                 :             :         // exceeding memory limits, remove them and their descendants from the mempool.</span>
<span id="L3049"><span class="lineNum">    3049</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (auto&amp;&amp; evicted_tx : disconnectpool-&gt;AddTransactionsFromBlock(block.vtx)) {</span></span>
<span id="L3050"><span class="lineNum">    3050</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             m_mempool-&gt;removeRecursive(*evicted_tx, MemPoolRemovalReason::REORG);</span></span>
<span id="L3051"><span class="lineNum">    3051</span>                 :             :         }</span>
<span id="L3052"><span class="lineNum">    3052</span>                 :             :     }</span>
<span id="L3053"><span class="lineNum">    3053</span>                 :             : </span>
<span id="L3054"><span class="lineNum">    3054</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     m_chain.SetTip(*pindexDelete-&gt;pprev);</span></span>
<span id="L3055"><span class="lineNum">    3055</span>                 :             : </span>
<span id="L3056"><span class="lineNum">    3056</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     UpdateTip(pindexDelete-&gt;pprev);</span></span>
<span id="L3057"><span class="lineNum">    3057</span>                 :             :     // Let wallets know transactions went from 1-confirmed to</span>
<span id="L3058"><span class="lineNum">    3058</span>                 :             :     // 0-confirmed or conflicted:</span>
<span id="L3059"><span class="lineNum">    3059</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (m_chainman.m_options.signals) {</span></span>
<span id="L3060"><span class="lineNum">    3060</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         m_chainman.m_options.signals-&gt;BlockDisconnected(pblock, pindexDelete);</span></span>
<span id="L3061"><span class="lineNum">    3061</span>                 :             :     }</span>
<span id="L3062"><span class="lineNum">    3062</span>                 :             :     return true;</span>
<span id="L3063"><span class="lineNum">    3063</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L3064"><span class="lineNum">    3064</span>                 :             : </span>
<span id="L3065"><span class="lineNum">    3065</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 200718 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 200718 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 22785 times"> + </span> :<span class="tlaGNC">      841025 : struct PerBlockConnectTrace {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaGBC" title="Branch 5 was taken 216086 times"> + </span>]
<span id="L3066"><span class="lineNum">    3066</span>                 :             :     CBlockIndex* pindex = nullptr;</span>
<span id="L3067"><span class="lineNum">    3067</span>                 :             :     std::shared_ptr&lt;const CBlock&gt; pblock;</span>
<span id="L3068"><span class="lineNum">    3068</span>                 :<span class="tlaGNC">      439589 :     PerBlockConnectTrace() = default;</span></span>
<span id="L3069"><span class="lineNum">    3069</span>                 :             : };</span>
<span id="L3070"><span class="lineNum">    3070</span>                 :             : /**</span>
<span id="L3071"><span class="lineNum">    3071</span>                 :             :  * Used to track blocks whose transactions were applied to the UTXO state as a</span>
<span id="L3072"><span class="lineNum">    3072</span>                 :             :  * part of a single ActivateBestChainStep call.</span>
<span id="L3073"><span class="lineNum">    3073</span>                 :             :  *</span>
<span id="L3074"><span class="lineNum">    3074</span>                 :             :  * This class is single-use, once you call GetBlocksConnected() you have to throw</span>
<span id="L3075"><span class="lineNum">    3075</span>                 :             :  * it away and make a new one.</span>
<span id="L3076"><span class="lineNum">    3076</span>                 :             :  */</span>
<span id="L3077"><span class="lineNum">    3077</span>                 :<span class="tlaGNC">       22785 : class ConnectTrace {</span></span>
<span id="L3078"><span class="lineNum">    3078</span>                 :             : private:</span>
<span id="L3079"><span class="lineNum">    3079</span>                 :             :     std::vector&lt;PerBlockConnectTrace&gt; blocksConnected;</span>
<span id="L3080"><span class="lineNum">    3080</span>                 :             : </span>
<span id="L3081"><span class="lineNum">    3081</span>                 :             : public:</span>
<span id="L3082"><span class="lineNum">    3082</span>                 :<span class="tlaGNC">      238871 :     explicit ConnectTrace() : blocksConnected(1) {}</span></span>
<span id="L3083"><span class="lineNum">    3083</span>                 :             : </span>
<span id="L3084"><span class="lineNum">    3084</span>                 :<span class="tlaGNC">      200718 :     void BlockConnected(CBlockIndex* pindex, std::shared_ptr&lt;const CBlock&gt; pblock) {</span></span>
<span id="L3085"><span class="lineNum">    3085</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 200718 times"> + </span>]:<span class="tlaGNC">      200718 :         assert(!blocksConnected.back().pindex);</span></span>
<span id="L3086"><span class="lineNum">    3086</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 200718 times"> + </span>]:<span class="tlaGNC">      200718 :         assert(pindex);</span></span>
<span id="L3087"><span class="lineNum">    3087</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 200718 times"> + </span>]:<span class="tlaGNC">      200718 :         assert(pblock);</span></span>
<span id="L3088"><span class="lineNum">    3088</span>                 :<span class="tlaGNC">      200718 :         blocksConnected.back().pindex = pindex;</span></span>
<span id="L3089"><span class="lineNum">    3089</span>                 :<span class="tlaGNC">      200718 :         blocksConnected.back().pblock = std::move(pblock);</span></span>
<span id="L3090"><span class="lineNum">    3090</span>                 :<span class="tlaGNC">      200718 :         blocksConnected.emplace_back();</span></span>
<span id="L3091"><span class="lineNum">    3091</span>                 :<span class="tlaGNC">      200718 :     }</span></span>
<span id="L3092"><span class="lineNum">    3092</span>                 :             : </span>
<span id="L3093"><span class="lineNum">    3093</span>                 :<span class="tlaGNC">      216086 :     std::vector&lt;PerBlockConnectTrace&gt;&amp; GetBlocksConnected() {</span></span>
<span id="L3094"><span class="lineNum">    3094</span>                 :             :         // We always keep one extra block at the end of our list because</span>
<span id="L3095"><span class="lineNum">    3095</span>                 :             :         // blocks are added after all the conflicted transactions have</span>
<span id="L3096"><span class="lineNum">    3096</span>                 :             :         // been filled in. Thus, the last entry should always be an empty</span>
<span id="L3097"><span class="lineNum">    3097</span>                 :             :         // one waiting for the transactions from the next block. We pop</span>
<span id="L3098"><span class="lineNum">    3098</span>                 :             :         // the last entry here to make sure the list we return is sane.</span>
<span id="L3099"><span class="lineNum">    3099</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 216086 times"> + </span>]:<span class="tlaGNC">      216086 :         assert(!blocksConnected.back().pindex);</span></span>
<span id="L3100"><span class="lineNum">    3100</span>                 :<span class="tlaGNC">      216086 :         blocksConnected.pop_back();</span></span>
<span id="L3101"><span class="lineNum">    3101</span>                 :<span class="tlaGNC">      216086 :         return blocksConnected;</span></span>
<span id="L3102"><span class="lineNum">    3102</span>                 :             :     }</span>
<span id="L3103"><span class="lineNum">    3103</span>                 :             : };</span>
<span id="L3104"><span class="lineNum">    3104</span>                 :             : </span>
<span id="L3105"><span class="lineNum">    3105</span>                 :             : /**</span>
<span id="L3106"><span class="lineNum">    3106</span>                 :             :  * Connect a new block to m_chain. block_to_connect is either nullptr or a pointer to a CBlock</span>
<span id="L3107"><span class="lineNum">    3107</span>                 :             :  * corresponding to pindexNew, to bypass loading it again from disk.</span>
<span id="L3108"><span class="lineNum">    3108</span>                 :             :  *</span>
<span id="L3109"><span class="lineNum">    3109</span>                 :             :  * The block is added to connectTrace if connection succeeds.</span>
<span id="L3110"><span class="lineNum">    3110</span>                 :             :  */</span>
<span id="L3111"><span class="lineNum">    3111</span>                 :<span class="tlaGNC">      216086 : bool Chainstate::ConnectTip(</span></span>
<span id="L3112"><span class="lineNum">    3112</span>                 :             :     BlockValidationState&amp; state,</span>
<span id="L3113"><span class="lineNum">    3113</span>                 :             :     CBlockIndex* pindexNew,</span>
<span id="L3114"><span class="lineNum">    3114</span>                 :             :     std::shared_ptr&lt;const CBlock&gt; block_to_connect,</span>
<span id="L3115"><span class="lineNum">    3115</span>                 :             :     ConnectTrace&amp; connectTrace,</span>
<span id="L3116"><span class="lineNum">    3116</span>                 :             :     DisconnectedBlockTransactions&amp; disconnectpool)</span>
<span id="L3117"><span class="lineNum">    3117</span>                 :             : {</span>
<span id="L3118"><span class="lineNum">    3118</span>                 :<span class="tlaGNC">      216086 :     AssertLockHeld(cs_main);</span></span>
<span id="L3119"><span class="lineNum">    3119</span>                 :<span class="tlaGNC">      216086 :     if (m_mempool) AssertLockHeld(m_mempool-&gt;cs);</span></span>
<span id="L3120"><span class="lineNum">    3120</span>                 :             : </span>
<span id="L3121"><span class="lineNum">    3121</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 216086 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 216086 times"> + </span>]:<span class="tlaGNC">      432172 :     assert(pindexNew-&gt;pprev == m_chain.Tip());</span></span>
<span id="L3122"><span class="lineNum">    3122</span>                 :             :     // Read block from disk.</span>
<span id="L3123"><span class="lineNum">    3123</span>                 :<span class="tlaGNC">      216086 :     const auto time_1{SteadyClock::now()};</span></span>
<span id="L3124"><span class="lineNum">    3124</span>         [<span class="tlaGBC" title="Branch 0 was taken 2960 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 213126 times"> + </span>]:<span class="tlaGNC">      216086 :     if (!block_to_connect) {</span></span>
<span id="L3125"><span class="lineNum">    3125</span>                 :<span class="tlaGNC">        2960 :         std::shared_ptr&lt;CBlock&gt; pblockNew = std::make_shared&lt;CBlock&gt;();</span></span>
<span id="L3126"><span class="lineNum">    3126</span>   [<span class="tlaGBC" title="Branch 0 was taken 2960 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 2960 times"> + </span>]:<span class="tlaGNC">        2960 :         if (!m_blockman.ReadBlock(*pblockNew, *pindexNew)) {</span></span>
<span id="L3127"><span class="lineNum">    3127</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             return FatalError(m_chainman.GetNotifications(), state, _(&quot;Failed to read block.&quot;));</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L3128"><span class="lineNum">    3128</span>                 :             :         }</span>
<span id="L3129"><span class="lineNum">    3129</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 2960 times"> + </span>]:<span class="tlaGNC">        2960 :         block_to_connect = std::move(pblockNew);</span></span>
<span id="L3130"><span class="lineNum">    3130</span>                 :<span class="tlaGNC">        2960 :     } else {</span></span>
<span id="L3131"><span class="lineNum">    3131</span>         [<span class="tlaGBC" title="Branch 0 was taken 137126 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 76000 times"> + </span>]:<span class="tlaGNC">      213126 :         LogDebug(BCLog::BENCH, &quot;  - Using cached block\n&quot;);</span></span>
<span id="L3132"><span class="lineNum">    3132</span>                 :             :     }</span>
<span id="L3133"><span class="lineNum">    3133</span>                 :             :     // Apply the block atomically to the chain state.</span>
<span id="L3134"><span class="lineNum">    3134</span>                 :<span class="tlaGNC">      216086 :     const auto time_2{SteadyClock::now()};</span></span>
<span id="L3135"><span class="lineNum">    3135</span>                 :<span class="tlaGNC">      216086 :     SteadyClock::time_point time_3;</span></span>
<span id="L3136"><span class="lineNum">    3136</span>                 :             :     // When adding aggregate statistics in the future, keep in mind that</span>
<span id="L3137"><span class="lineNum">    3137</span>                 :             :     // num_blocks_total may be zero until the ConnectBlock() call below.</span>
<span id="L3138"><span class="lineNum">    3138</span>         [<span class="tlaGBC" title="Branch 0 was taken 138878 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 77208 times"> + </span>]:<span class="tlaGNC">      216086 :     LogDebug(BCLog::BENCH, &quot;  - Load block from disk: %.2fms\n&quot;,</span></span>
<span id="L3139"><span class="lineNum">    3139</span>                 :             :              Ticks&lt;MillisecondsDouble&gt;(time_2 - time_1));</span>
<span id="L3140"><span class="lineNum">    3140</span>                 :<span class="tlaGNC">      216086 :     {</span></span>
<span id="L3141"><span class="lineNum">    3141</span>                 :<span class="tlaGNC">      216086 :         CCoinsViewCache view(&amp;CoinsTip());</span></span>
<span id="L3142"><span class="lineNum">    3142</span>         [<span class="tlaGBC" title="Branch 0 was taken 216086 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      216086 :         bool rv = ConnectBlock(*block_to_connect, state, pindexNew, view);</span></span>
<span id="L3143"><span class="lineNum">    3143</span>         [<span class="tlaGBC" title="Branch 0 was taken 215276 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 810 times"> + </span>]:<span class="tlaGNC">      216086 :         if (m_chainman.m_options.signals) {</span></span>
<span id="L3144"><span class="lineNum">    3144</span>         [<span class="tlaGBC" title="Branch 0 was taken 215276 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      215276 :             m_chainman.m_options.signals-&gt;BlockChecked(block_to_connect, state);</span></span>
<span id="L3145"><span class="lineNum">    3145</span>                 :             :         }</span>
<span id="L3146"><span class="lineNum">    3146</span>         [<span class="tlaGBC" title="Branch 0 was taken 15368 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 200718 times"> + </span>]:<span class="tlaGNC">      216086 :         if (!rv) {</span></span>
<span id="L3147"><span class="lineNum">    3147</span>         [<span class="tlaGBC" title="Branch 0 was taken 15368 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       15368 :             if (state.IsInvalid())</span></span>
<span id="L3148"><span class="lineNum">    3148</span>         [<span class="tlaGBC" title="Branch 0 was taken 15368 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       15368 :                 InvalidBlockFound(pindexNew, state);</span></span>
<span id="L3149"><span class="lineNum">    3149</span>   [<span class="tlaGBC" title="Branch 0 was taken 15368 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 15368 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">       30736 :             LogError(&quot;%s: ConnectBlock %s failed, %s\n&quot;, __func__, pindexNew-&gt;GetBlockHash().ToString(), state.ToString());</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 15368 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L3150"><span class="lineNum">    3150</span>                 :<span class="tlaGNC">       15368 :             return false;</span></span>
<span id="L3151"><span class="lineNum">    3151</span>                 :             :         }</span>
<span id="L3152"><span class="lineNum">    3152</span>                 :<span class="tlaGNC">      200718 :         time_3 = SteadyClock::now();</span></span>
<span id="L3153"><span class="lineNum">    3153</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 200718 times"> + </span>]:<span class="tlaGNC">      200718 :         m_chainman.time_connect_total += time_3 - time_2;</span></span>
<span id="L3154"><span class="lineNum">    3154</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 200718 times"> + </span>]:<span class="tlaGNC">      200718 :         assert(m_chainman.num_blocks_total &gt; 0);</span></span>
<span id="L3155"><span class="lineNum">    3155</span>   [<span class="tlaGBC" title="Branch 0 was taken 200718 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 123510 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 77208 times"> + </span> :<span class="tlaGNC">      200718 :         LogDebug(BCLog::BENCH, &quot;  - Connect total: %.2fms [%.2fs (%.2fms/blk)]\n&quot;,</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 123510 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L3156"><span class="lineNum">    3156</span>                 :             :                  Ticks&lt;MillisecondsDouble&gt;(time_3 - time_2),</span>
<span id="L3157"><span class="lineNum">    3157</span>                 :             :                  Ticks&lt;SecondsDouble&gt;(m_chainman.time_connect_total),</span>
<span id="L3158"><span class="lineNum">    3158</span>                 :             :                  Ticks&lt;MillisecondsDouble&gt;(m_chainman.time_connect_total) / m_chainman.num_blocks_total);</span>
<span id="L3159"><span class="lineNum">    3159</span>         [<span class="tlaGBC" title="Branch 0 was taken 200718 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      200718 :         bool flushed = view.Flush();</span></span>
<span id="L3160"><span class="lineNum">    3160</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 200718 times"> + </span>]:<span class="tlaGNC">      200718 :         assert(flushed);</span></span>
<span id="L3161"><span class="lineNum">    3161</span>                 :<span class="tlaGNC">      216086 :     }</span></span>
<span id="L3162"><span class="lineNum">    3162</span>                 :<span class="tlaGNC">      200718 :     const auto time_4{SteadyClock::now()};</span></span>
<span id="L3163"><span class="lineNum">    3163</span>                 :<span class="tlaGNC">      200718 :     m_chainman.time_flush += time_4 - time_3;</span></span>
<span id="L3164"><span class="lineNum">    3164</span>         [<span class="tlaGBC" title="Branch 0 was taken 123510 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 77208 times"> + </span>]:<span class="tlaGNC">      200718 :     LogDebug(BCLog::BENCH, &quot;  - Flush: %.2fms [%.2fs (%.2fms/blk)]\n&quot;,</span></span>
<span id="L3165"><span class="lineNum">    3165</span>                 :             :              Ticks&lt;MillisecondsDouble&gt;(time_4 - time_3),</span>
<span id="L3166"><span class="lineNum">    3166</span>                 :             :              Ticks&lt;SecondsDouble&gt;(m_chainman.time_flush),</span>
<span id="L3167"><span class="lineNum">    3167</span>                 :             :              Ticks&lt;MillisecondsDouble&gt;(m_chainman.time_flush) / m_chainman.num_blocks_total);</span>
<span id="L3168"><span class="lineNum">    3168</span>                 :             :     // Write the chain state to disk, if necessary.</span>
<span id="L3169"><span class="lineNum">    3169</span>         [<span class="tlaGBC" title="Branch 0 was taken 200718 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      200718 :     if (!FlushStateToDisk(state, FlushStateMode::IF_NEEDED)) {</span></span>
<span id="L3170"><span class="lineNum">    3170</span>                 :             :         return false;</span>
<span id="L3171"><span class="lineNum">    3171</span>                 :             :     }</span>
<span id="L3172"><span class="lineNum">    3172</span>                 :<span class="tlaGNC">      200718 :     const auto time_5{SteadyClock::now()};</span></span>
<span id="L3173"><span class="lineNum">    3173</span>                 :<span class="tlaGNC">      200718 :     m_chainman.time_chainstate += time_5 - time_4;</span></span>
<span id="L3174"><span class="lineNum">    3174</span>         [<span class="tlaGBC" title="Branch 0 was taken 123510 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 77208 times"> + </span>]:<span class="tlaGNC">      200718 :     LogDebug(BCLog::BENCH, &quot;  - Writing chainstate: %.2fms [%.2fs (%.2fms/blk)]\n&quot;,</span></span>
<span id="L3175"><span class="lineNum">    3175</span>                 :             :              Ticks&lt;MillisecondsDouble&gt;(time_5 - time_4),</span>
<span id="L3176"><span class="lineNum">    3176</span>                 :             :              Ticks&lt;SecondsDouble&gt;(m_chainman.time_chainstate),</span>
<span id="L3177"><span class="lineNum">    3177</span>                 :             :              Ticks&lt;MillisecondsDouble&gt;(m_chainman.time_chainstate) / m_chainman.num_blocks_total);</span>
<span id="L3178"><span class="lineNum">    3178</span>                 :             :     // Remove conflicting transactions from the mempool.;</span>
<span id="L3179"><span class="lineNum">    3179</span>         [<span class="tlaGBC" title="Branch 0 was taken 200718 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      200718 :     if (m_mempool) {</span></span>
<span id="L3180"><span class="lineNum">    3180</span>                 :<span class="tlaGNC">      200718 :         m_mempool-&gt;removeForBlock(block_to_connect-&gt;vtx, pindexNew-&gt;nHeight);</span></span>
<span id="L3181"><span class="lineNum">    3181</span>                 :<span class="tlaGNC">      200718 :         disconnectpool.removeForBlock(block_to_connect-&gt;vtx);</span></span>
<span id="L3182"><span class="lineNum">    3182</span>                 :             :     }</span>
<span id="L3183"><span class="lineNum">    3183</span>                 :             :     // Update m_chain &amp; related variables.</span>
<span id="L3184"><span class="lineNum">    3184</span>                 :<span class="tlaGNC">      200718 :     m_chain.SetTip(*pindexNew);</span></span>
<span id="L3185"><span class="lineNum">    3185</span>                 :<span class="tlaGNC">      200718 :     UpdateTip(pindexNew);</span></span>
<span id="L3186"><span class="lineNum">    3186</span>                 :             : </span>
<span id="L3187"><span class="lineNum">    3187</span>                 :<span class="tlaGNC">      200718 :     const auto time_6{SteadyClock::now()};</span></span>
<span id="L3188"><span class="lineNum">    3188</span>                 :<span class="tlaGNC">      200718 :     m_chainman.time_post_connect += time_6 - time_5;</span></span>
<span id="L3189"><span class="lineNum">    3189</span>                 :<span class="tlaGNC">      200718 :     m_chainman.time_total += time_6 - time_1;</span></span>
<span id="L3190"><span class="lineNum">    3190</span>         [<span class="tlaGBC" title="Branch 0 was taken 123510 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 77208 times"> + </span>]:<span class="tlaGNC">      200718 :     LogDebug(BCLog::BENCH, &quot;  - Connect postprocess: %.2fms [%.2fs (%.2fms/blk)]\n&quot;,</span></span>
<span id="L3191"><span class="lineNum">    3191</span>                 :             :              Ticks&lt;MillisecondsDouble&gt;(time_6 - time_5),</span>
<span id="L3192"><span class="lineNum">    3192</span>                 :             :              Ticks&lt;SecondsDouble&gt;(m_chainman.time_post_connect),</span>
<span id="L3193"><span class="lineNum">    3193</span>                 :             :              Ticks&lt;MillisecondsDouble&gt;(m_chainman.time_post_connect) / m_chainman.num_blocks_total);</span>
<span id="L3194"><span class="lineNum">    3194</span>         [<span class="tlaGBC" title="Branch 0 was taken 123510 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 77208 times"> + </span>]:<span class="tlaGNC">      200718 :     LogDebug(BCLog::BENCH, &quot;- Connect block: %.2fms [%.2fs (%.2fms/blk)]\n&quot;,</span></span>
<span id="L3195"><span class="lineNum">    3195</span>                 :             :              Ticks&lt;MillisecondsDouble&gt;(time_6 - time_1),</span>
<span id="L3196"><span class="lineNum">    3196</span>                 :             :              Ticks&lt;SecondsDouble&gt;(m_chainman.time_total),</span>
<span id="L3197"><span class="lineNum">    3197</span>                 :             :              Ticks&lt;MillisecondsDouble&gt;(m_chainman.time_total) / m_chainman.num_blocks_total);</span>
<span id="L3198"><span class="lineNum">    3198</span>                 :             : </span>
<span id="L3199"><span class="lineNum">    3199</span>                 :             :     // If we are the background validation chainstate, check to see if we are done</span>
<span id="L3200"><span class="lineNum">    3200</span>                 :             :     // validating the snapshot (i.e. our tip has reached the snapshot's base block).</span>
<span id="L3201"><span class="lineNum">    3201</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 200718 times"> + </span>]:<span class="tlaGNC">      200718 :     if (this != &amp;m_chainman.ActiveChainstate()) {</span></span>
<span id="L3202"><span class="lineNum">    3202</span>                 :             :         // This call may set `m_disabled`, which is referenced immediately afterwards in</span>
<span id="L3203"><span class="lineNum">    3203</span>                 :             :         // ActivateBestChain, so that we stop connecting blocks past the snapshot base.</span>
<span id="L3204"><span class="lineNum">    3204</span>                 :<span class="tlaUNC">           0 :         m_chainman.MaybeCompleteSnapshotValidation();</span></span>
<span id="L3205"><span class="lineNum">    3205</span>                 :             :     }</span>
<span id="L3206"><span class="lineNum">    3206</span>                 :             : </span>
<span id="L3207"><span class="lineNum">    3207</span>         [<span class="tlaGBC" title="Branch 0 was taken 200718 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      200718 :     connectTrace.BlockConnected(pindexNew, std::move(block_to_connect));</span></span>
<span id="L3208"><span class="lineNum">    3208</span>                 :<span class="tlaGNC">      200718 :     return true;</span></span>
<span id="L3209"><span class="lineNum">    3209</span>                 :             : }</span>
<span id="L3210"><span class="lineNum">    3210</span>                 :             : </span>
<span id="L3211"><span class="lineNum">    3211</span>                 :             : /**</span>
<span id="L3212"><span class="lineNum">    3212</span>                 :             :  * Return the tip of the chain with the most work in it, that isn't</span>
<span id="L3213"><span class="lineNum">    3213</span>                 :             :  * known to be invalid (it's however far from certain to be valid).</span>
<span id="L3214"><span class="lineNum">    3214</span>                 :             :  */</span>
<span id="L3215"><span class="lineNum">    3215</span>                 :<span class="tlaGNC">      238871 : CBlockIndex* Chainstate::FindMostWorkChain()</span></span>
<span id="L3216"><span class="lineNum">    3216</span>                 :             : {</span>
<span id="L3217"><span class="lineNum">    3217</span>                 :<span class="tlaGNC">      238871 :     AssertLockHeld(::cs_main);</span></span>
<span id="L3218"><span class="lineNum">    3218</span>                 :<span class="tlaGNC">      238871 :     do {</span></span>
<span id="L3219"><span class="lineNum">    3219</span>                 :<span class="tlaGNC">      238871 :         CBlockIndex *pindexNew = nullptr;</span></span>
<span id="L3220"><span class="lineNum">    3220</span>                 :             : </span>
<span id="L3221"><span class="lineNum">    3221</span>                 :             :         // Find the best candidate header.</span>
<span id="L3222"><span class="lineNum">    3222</span>                 :<span class="tlaGNC">      238871 :         {</span></span>
<span id="L3223"><span class="lineNum">    3223</span>         [<span class="tlaGBC" title="Branch 0 was taken 238871 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      238871 :             std::set&lt;CBlockIndex*, CBlockIndexWorkComparator&gt;::reverse_iterator it = setBlockIndexCandidates.rbegin();</span></span>
<span id="L3224"><span class="lineNum">    3224</span>         [<span class="tlaGBC" title="Branch 0 was taken 238871 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      238871 :             if (it == setBlockIndexCandidates.rend())</span></span>
<span id="L3225"><span class="lineNum">    3225</span>                 :             :                 return nullptr;</span>
<span id="L3226"><span class="lineNum">    3226</span>                 :<span class="tlaGNC">      238871 :             pindexNew = *it;</span></span>
<span id="L3227"><span class="lineNum">    3227</span>                 :             :         }</span>
<span id="L3228"><span class="lineNum">    3228</span>                 :             : </span>
<span id="L3229"><span class="lineNum">    3229</span>                 :             :         // Check whether all blocks on the path between the currently active chain and the candidate are valid.</span>
<span id="L3230"><span class="lineNum">    3230</span>                 :             :         // Just going until the active chain is an optimization, as we know all blocks in it are valid already.</span>
<span id="L3231"><span class="lineNum">    3231</span>                 :<span class="tlaGNC">      238871 :         CBlockIndex *pindexTest = pindexNew;</span></span>
<span id="L3232"><span class="lineNum">    3232</span>                 :<span class="tlaGNC">      238871 :         bool fInvalidAncestor = false;</span></span>
<span id="L3233"><span class="lineNum">    3233</span>   [<span class="tlaGBC" title="Branch 0 was taken 451997 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 2960 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 216086 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 235911 times"> + </span>]:<span class="tlaGNC">      454957 :         while (pindexTest &amp;&amp; !m_chain.Contains(pindexTest)) {</span></span>
<span id="L3234"><span class="lineNum">    3234</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 216086 times"> + </span>]:<span class="tlaGNC">      216086 :             assert(pindexTest-&gt;HaveNumChainTxs() || pindexTest-&gt;nHeight == 0);</span></span>
<span id="L3235"><span class="lineNum">    3235</span>                 :             : </span>
<span id="L3236"><span class="lineNum">    3236</span>                 :             :             // Pruned nodes may have entries in setBlockIndexCandidates for</span>
<span id="L3237"><span class="lineNum">    3237</span>                 :             :             // which block files have been deleted.  Remove those as candidates</span>
<span id="L3238"><span class="lineNum">    3238</span>                 :             :             // for the most work chain if we come across them; we can't switch</span>
<span id="L3239"><span class="lineNum">    3239</span>                 :             :             // to a chain unless we have all the non-active-chain parent blocks.</span>
<span id="L3240"><span class="lineNum">    3240</span>                 :<span class="tlaGNC">      216086 :             bool fFailedChain = pindexTest-&gt;nStatus &amp; BLOCK_FAILED_MASK;</span></span>
<span id="L3241"><span class="lineNum">    3241</span>                 :<span class="tlaGNC">      216086 :             bool fMissingData = !(pindexTest-&gt;nStatus &amp; BLOCK_HAVE_DATA);</span></span>
<span id="L3242"><span class="lineNum">    3242</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 216086 times"> + </span>]:<span class="tlaGNC">      216086 :             if (fFailedChain || fMissingData) {</span></span>
<span id="L3243"><span class="lineNum">    3243</span>                 :             :                 // Candidate chain is not usable (either invalid or missing data)</span>
<span id="L3244"><span class="lineNum">    3244</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                 if (fFailedChain &amp;&amp; (m_chainman.m_best_invalid == nullptr || pindexNew-&gt;nChainWork &gt; m_chainman.m_best_invalid-&gt;nChainWork)) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L3245"><span class="lineNum">    3245</span>                 :<span class="tlaUNC">           0 :                     m_chainman.m_best_invalid = pindexNew;</span></span>
<span id="L3246"><span class="lineNum">    3246</span>                 :             :                 }</span>
<span id="L3247"><span class="lineNum">    3247</span>                 :<span class="tlaUNC">           0 :                 CBlockIndex *pindexFailed = pindexNew;</span></span>
<span id="L3248"><span class="lineNum">    3248</span>                 :             :                 // Remove the entire chain from the set.</span>
<span id="L3249"><span class="lineNum">    3249</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 while (pindexTest != pindexFailed) {</span></span>
<span id="L3250"><span class="lineNum">    3250</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     if (fFailedChain) {</span></span>
<span id="L3251"><span class="lineNum">    3251</span>                 :<span class="tlaUNC">           0 :                         pindexFailed-&gt;nStatus |= BLOCK_FAILED_CHILD;</span></span>
<span id="L3252"><span class="lineNum">    3252</span>                 :<span class="tlaUNC">           0 :                         m_blockman.m_dirty_blockindex.insert(pindexFailed);</span></span>
<span id="L3253"><span class="lineNum">    3253</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     } else if (fMissingData) {</span></span>
<span id="L3254"><span class="lineNum">    3254</span>                 :             :                         // If we're missing data, then add back to m_blocks_unlinked,</span>
<span id="L3255"><span class="lineNum">    3255</span>                 :             :                         // so that if the block arrives in the future we can try adding</span>
<span id="L3256"><span class="lineNum">    3256</span>                 :             :                         // to setBlockIndexCandidates again.</span>
<span id="L3257"><span class="lineNum">    3257</span>                 :<span class="tlaUNC">           0 :                         m_blockman.m_blocks_unlinked.insert(</span></span>
<span id="L3258"><span class="lineNum">    3258</span>                 :<span class="tlaUNC">           0 :                             std::make_pair(pindexFailed-&gt;pprev, pindexFailed));</span></span>
<span id="L3259"><span class="lineNum">    3259</span>                 :             :                     }</span>
<span id="L3260"><span class="lineNum">    3260</span>                 :<span class="tlaUNC">           0 :                     setBlockIndexCandidates.erase(pindexFailed);</span></span>
<span id="L3261"><span class="lineNum">    3261</span>                 :<span class="tlaUNC">           0 :                     pindexFailed = pindexFailed-&gt;pprev;</span></span>
<span id="L3262"><span class="lineNum">    3262</span>                 :             :                 }</span>
<span id="L3263"><span class="lineNum">    3263</span>                 :<span class="tlaUNC">           0 :                 setBlockIndexCandidates.erase(pindexTest);</span></span>
<span id="L3264"><span class="lineNum">    3264</span>                 :<span class="tlaUNC">           0 :                 fInvalidAncestor = true;</span></span>
<span id="L3265"><span class="lineNum">    3265</span>                 :<span class="tlaUNC">           0 :                 break;</span></span>
<span id="L3266"><span class="lineNum">    3266</span>                 :             :             }</span>
<span id="L3267"><span class="lineNum">    3267</span>                 :<span class="tlaGNC">      216086 :             pindexTest = pindexTest-&gt;pprev;</span></span>
<span id="L3268"><span class="lineNum">    3268</span>                 :             :         }</span>
<span id="L3269"><span class="lineNum">    3269</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 238871 times"> + </span>]:<span class="tlaGNC">      238871 :         if (!fInvalidAncestor)</span></span>
<span id="L3270"><span class="lineNum">    3270</span>                 :             :             return pindexNew;</span>
<span id="L3271"><span class="lineNum">    3271</span>                 :             :     } while(true);</span>
<span id="L3272"><span class="lineNum">    3272</span>                 :             : }</span>
<span id="L3273"><span class="lineNum">    3273</span>                 :             : </span>
<span id="L3274"><span class="lineNum">    3274</span>                 :             : /** Delete all entries in setBlockIndexCandidates that are worse than the current tip. */</span>
<span id="L3275"><span class="lineNum">    3275</span>                 :<span class="tlaGNC">      200721 : void Chainstate::PruneBlockIndexCandidates() {</span></span>
<span id="L3276"><span class="lineNum">    3276</span>                 :             :     // Note that we can't delete the current block itself, as we may need to return to it later in case a</span>
<span id="L3277"><span class="lineNum">    3277</span>                 :             :     // reorganization to a better block fails.</span>
<span id="L3278"><span class="lineNum">    3278</span>                 :<span class="tlaGNC">      200721 :     std::set&lt;CBlockIndex*, CBlockIndexWorkComparator&gt;::iterator it = setBlockIndexCandidates.begin();</span></span>
<span id="L3279"><span class="lineNum">    3279</span>   [<span class="tlaGBC" title="Branch 0 was taken 398479 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 398479 times"> + </span> :<span class="tlaGNC">      796958 :     while (it != setBlockIndexCandidates.end() &amp;&amp; setBlockIndexCandidates.value_comp()(*it, m_chain.Tip())) {</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 197758 times"> + </span><span class="tlaGBC" title="Branch 5 was taken 200721 times"> + </span>]
<span id="L3280"><span class="lineNum">    3280</span>                 :<span class="tlaGNC">      197758 :         setBlockIndexCandidates.erase(it++);</span></span>
<span id="L3281"><span class="lineNum">    3281</span>                 :             :     }</span>
<span id="L3282"><span class="lineNum">    3282</span>                 :             :     // Either the current tip or a successor of it we're working towards is left in setBlockIndexCandidates.</span>
<span id="L3283"><span class="lineNum">    3283</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 200721 times"> + </span>]:<span class="tlaGNC">      200721 :     assert(!setBlockIndexCandidates.empty());</span></span>
<span id="L3284"><span class="lineNum">    3284</span>                 :<span class="tlaGNC">      200721 : }</span></span>
<span id="L3285"><span class="lineNum">    3285</span>                 :             : </span>
<span id="L3286"><span class="lineNum">    3286</span>                 :             : /**</span>
<span id="L3287"><span class="lineNum">    3287</span>                 :             :  * Try to make some progress towards making pindexMostWork the active block.</span>
<span id="L3288"><span class="lineNum">    3288</span>                 :             :  * pblock is either nullptr or a pointer to a CBlock corresponding to pindexMostWork.</span>
<span id="L3289"><span class="lineNum">    3289</span>                 :             :  *</span>
<span id="L3290"><span class="lineNum">    3290</span>                 :             :  * @returns true unless a system error occurred</span>
<span id="L3291"><span class="lineNum">    3291</span>                 :             :  */</span>
<span id="L3292"><span class="lineNum">    3292</span>                 :<span class="tlaGNC">      216086 : bool Chainstate::ActivateBestChainStep(BlockValidationState&amp; state, CBlockIndex* pindexMostWork, const std::shared_ptr&lt;const CBlock&gt;&amp; pblock, bool&amp; fInvalidFound, ConnectTrace&amp; connectTrace)</span></span>
<span id="L3293"><span class="lineNum">    3293</span>                 :             : {</span>
<span id="L3294"><span class="lineNum">    3294</span>                 :<span class="tlaGNC">      216086 :     AssertLockHeld(cs_main);</span></span>
<span id="L3295"><span class="lineNum">    3295</span>                 :<span class="tlaGNC">      216086 :     if (m_mempool) AssertLockHeld(m_mempool-&gt;cs);</span></span>
<span id="L3296"><span class="lineNum">    3296</span>                 :             : </span>
<span id="L3297"><span class="lineNum">    3297</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 216086 times"> + </span>]:<span class="tlaGNC">      216086 :     const CBlockIndex* pindexOldTip = m_chain.Tip();</span></span>
<span id="L3298"><span class="lineNum">    3298</span>                 :<span class="tlaGNC">      216086 :     const CBlockIndex* pindexFork = m_chain.FindFork(pindexMostWork);</span></span>
<span id="L3299"><span class="lineNum">    3299</span>                 :             : </span>
<span id="L3300"><span class="lineNum">    3300</span>                 :             :     // Disconnect active blocks which are no longer in the best chain.</span>
<span id="L3301"><span class="lineNum">    3301</span>                 :<span class="tlaGNC">      216086 :     bool fBlocksDisconnected = false;</span></span>
<span id="L3302"><span class="lineNum">    3302</span>                 :<span class="tlaGNC">      216086 :     DisconnectedBlockTransactions disconnectpool{MAX_DISCONNECTED_TX_POOL_BYTES};</span></span>
<span id="L3303"><span class="lineNum">    3303</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 216086 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 213126 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      645298 :     while (m_chain.Tip() &amp;&amp; m_chain.Tip() != pindexFork) {</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 213126 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L3304"><span class="lineNum">    3304</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!DisconnectTip(state, &amp;disconnectpool)) {</span></span>
<span id="L3305"><span class="lineNum">    3305</span>                 :             :             // This is likely a fatal error, but keep the mempool consistent,</span>
<span id="L3306"><span class="lineNum">    3306</span>                 :             :             // just in case. Only remove from the mempool in this case.</span>
<span id="L3307"><span class="lineNum">    3307</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             MaybeUpdateMempoolForReorg(disconnectpool, false);</span></span>
<span id="L3308"><span class="lineNum">    3308</span>                 :             : </span>
<span id="L3309"><span class="lineNum">    3309</span>                 :             :             // If we're unable to disconnect a block during normal operation,</span>
<span id="L3310"><span class="lineNum">    3310</span>                 :             :             // then that is a failure of our local system -- we should abort</span>
<span id="L3311"><span class="lineNum">    3311</span>                 :             :             // rather than stay on a less work chain.</span>
<span id="L3312"><span class="lineNum">    3312</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             FatalError(m_chainman.GetNotifications(), state, _(&quot;Failed to disconnect block.&quot;));</span></span>
<span id="L3313"><span class="lineNum">    3313</span>                 :<span class="tlaUNC">           0 :             return false;</span></span>
<span id="L3314"><span class="lineNum">    3314</span>                 :             :         }</span>
<span id="L3315"><span class="lineNum">    3315</span>                 :             :         fBlocksDisconnected = true;</span>
<span id="L3316"><span class="lineNum">    3316</span>                 :             :     }</span>
<span id="L3317"><span class="lineNum">    3317</span>                 :             : </span>
<span id="L3318"><span class="lineNum">    3318</span>                 :             :     // Build list of new blocks to connect (in descending height order).</span>
<span id="L3319"><span class="lineNum">    3319</span>                 :<span class="tlaGNC">      216086 :     std::vector&lt;CBlockIndex*&gt; vpindexToConnect;</span></span>
<span id="L3320"><span class="lineNum">    3320</span>                 :<span class="tlaGNC">      216086 :     bool fContinue = true;</span></span>
<span id="L3321"><span class="lineNum">    3321</span>         [<span class="tlaGBC" title="Branch 0 was taken 213126 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 2960 times"> + </span>]:<span class="tlaGNC">      216086 :     int nHeight = pindexFork ? pindexFork-&gt;nHeight : -1;</span></span>
<span id="L3322"><span class="lineNum">    3322</span>   [<span class="tlaGBC" title="Branch 0 was taken 216086 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 200718 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 216086 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      416804 :     while (fContinue &amp;&amp; nHeight != pindexMostWork-&gt;nHeight) {</span></span>
<span id="L3323"><span class="lineNum">    3323</span>                 :             :         // Don't iterate the entire list of potential improvements toward the best tip, as we likely only need</span>
<span id="L3324"><span class="lineNum">    3324</span>                 :             :         // a few blocks along the way.</span>
<span id="L3325"><span class="lineNum">    3325</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 216086 times"> + </span>]:<span class="tlaGNC">      216086 :         int nTargetHeight = std::min(nHeight + 32, pindexMostWork-&gt;nHeight);</span></span>
<span id="L3326"><span class="lineNum">    3326</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 216086 times"> + </span>]:<span class="tlaGNC">      216086 :         vpindexToConnect.clear();</span></span>
<span id="L3327"><span class="lineNum">    3327</span>         [<span class="tlaGBC" title="Branch 0 was taken 216086 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      216086 :         vpindexToConnect.reserve(nTargetHeight - nHeight);</span></span>
<span id="L3328"><span class="lineNum">    3328</span>         [<span class="tlaGBC" title="Branch 0 was taken 216086 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      216086 :         CBlockIndex* pindexIter = pindexMostWork-&gt;GetAncestor(nTargetHeight);</span></span>
<span id="L3329"><span class="lineNum">    3329</span>   [<span class="tlaGBC" title="Branch 0 was taken 429212 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 2960 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 216086 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 213126 times"> + </span>]:<span class="tlaGNC">      432172 :         while (pindexIter &amp;&amp; pindexIter-&gt;nHeight != nHeight) {</span></span>
<span id="L3330"><span class="lineNum">    3330</span>         [<span class="tlaGBC" title="Branch 0 was taken 216086 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      216086 :             vpindexToConnect.push_back(pindexIter);</span></span>
<span id="L3331"><span class="lineNum">    3331</span>                 :<span class="tlaGNC">      216086 :             pindexIter = pindexIter-&gt;pprev;</span></span>
<span id="L3332"><span class="lineNum">    3332</span>                 :             :         }</span>
<span id="L3333"><span class="lineNum">    3333</span>                 :<span class="tlaGNC">      216086 :         nHeight = nTargetHeight;</span></span>
<span id="L3334"><span class="lineNum">    3334</span>                 :             : </span>
<span id="L3335"><span class="lineNum">    3335</span>                 :             :         // Connect new blocks.</span>
<span id="L3336"><span class="lineNum">    3336</span>         [<span class="tlaGBC" title="Branch 0 was taken 216086 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      216086 :         for (CBlockIndex* pindexConnect : vpindexToConnect | std::views::reverse) {</span></span>
<span id="L3337"><span class="lineNum">    3337</span>   [<span class="tlaGBC" title="Branch 0 was taken 216086 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 216086 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      447540 :             if (!ConnectTip(state, pindexConnect, pindexConnect == pindexMostWork ? pblock : std::shared_ptr&lt;const CBlock&gt;(), connectTrace, disconnectpool)) {</span></span>
<span class="lineNum">        </span>    <span class="tlaGBC" title="Branch 4 was taken 15368 times"> + </span><span class="tlaGBC" title="Branch 5 was taken 200718 times"> + </span><span class="tlaGBC" title="Branch 6 was taken 15368 times"> + </span><span class="tlaGBC" title="Branch 7 was taken 200718 times"> + </span>]
<span id="L3338"><span class="lineNum">    3338</span>         [<span class="tlaGBC" title="Branch 0 was taken 15368 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       15368 :                 if (state.IsInvalid()) {</span></span>
<span id="L3339"><span class="lineNum">    3339</span>                 :             :                     // The block violates a consensus rule.</span>
<span id="L3340"><span class="lineNum">    3340</span>         [<span class="tlaGBC" title="Branch 0 was taken 15368 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       15368 :                     if (state.GetResult() != BlockValidationResult::BLOCK_MUTATED) {</span></span>
<span id="L3341"><span class="lineNum">    3341</span>         [<span class="tlaGBC" title="Branch 0 was taken 15368 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       15368 :                         InvalidChainFound(vpindexToConnect.front());</span></span>
<span id="L3342"><span class="lineNum">    3342</span>                 :             :                     }</span>
<span id="L3343"><span class="lineNum">    3343</span>                 :<span class="tlaGNC">       15368 :                     state = BlockValidationState();</span></span>
<span id="L3344"><span class="lineNum">    3344</span>                 :<span class="tlaGNC">       15368 :                     fInvalidFound = true;</span></span>
<span id="L3345"><span class="lineNum">    3345</span>                 :<span class="tlaGNC">       15368 :                     fContinue = false;</span></span>
<span id="L3346"><span class="lineNum">    3346</span>                 :<span class="tlaGNC">       15368 :                     break;</span></span>
<span id="L3347"><span class="lineNum">    3347</span>                 :             :                 } else {</span>
<span id="L3348"><span class="lineNum">    3348</span>                 :             :                     // A system error occurred (disk space, database error, ...).</span>
<span id="L3349"><span class="lineNum">    3349</span>                 :             :                     // Make the mempool consistent with the current tip, just in case</span>
<span id="L3350"><span class="lineNum">    3350</span>                 :             :                     // any observers try to use it before shutdown.</span>
<span id="L3351"><span class="lineNum">    3351</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     MaybeUpdateMempoolForReorg(disconnectpool, false);</span></span>
<span id="L3352"><span class="lineNum">    3352</span>                 :             :                     return false;</span>
<span id="L3353"><span class="lineNum">    3353</span>                 :             :                 }</span>
<span id="L3354"><span class="lineNum">    3354</span>                 :             :             } else {</span>
<span id="L3355"><span class="lineNum">    3355</span>         [<span class="tlaGBC" title="Branch 0 was taken 200718 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      200718 :                 PruneBlockIndexCandidates();</span></span>
<span id="L3356"><span class="lineNum">    3356</span>   [<span class="tlaGBC" title="Branch 0 was taken 197758 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 2960 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 197758 times"> + </span> :<span class="tlaGNC">      398476 :                 if (!pindexOldTip || m_chain.Tip()-&gt;nChainWork &gt; pindexOldTip-&gt;nChainWork) {</span></span>
<span class="lineNum">        </span>    <span class="tlaGBC" title="Branch 4 was taken 197758 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaUNC" title="Branch 6 was not taken"> - </span><span class="tlaGBC" title="Branch 7 was taken 197758 times"> + </span>]
<span id="L3357"><span class="lineNum">    3357</span>                 :             :                     // We're in a better position than we were. Return temporarily to release the lock.</span>
<span id="L3358"><span class="lineNum">    3358</span>                 :             :                     fContinue = false;</span>
<span id="L3359"><span class="lineNum">    3359</span>                 :             :                     break;</span>
<span id="L3360"><span class="lineNum">    3360</span>                 :             :                 }</span>
<span id="L3361"><span class="lineNum">    3361</span>                 :             :             }</span>
<span id="L3362"><span class="lineNum">    3362</span>                 :             :         }</span>
<span id="L3363"><span class="lineNum">    3363</span>                 :             :     }</span>
<span id="L3364"><span class="lineNum">    3364</span>                 :             : </span>
<span id="L3365"><span class="lineNum">    3365</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 216086 times"> + </span>]:<span class="tlaGNC">      216086 :     if (fBlocksDisconnected) {</span></span>
<span id="L3366"><span class="lineNum">    3366</span>                 :             :         // If any blocks were disconnected, disconnectpool may be non empty.  Add</span>
<span id="L3367"><span class="lineNum">    3367</span>                 :             :         // any disconnected transactions back to the mempool.</span>
<span id="L3368"><span class="lineNum">    3368</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         MaybeUpdateMempoolForReorg(disconnectpool, true);</span></span>
<span id="L3369"><span class="lineNum">    3369</span>                 :             :     }</span>
<span id="L3370"><span class="lineNum">    3370</span>   [<span class="tlaGBC" title="Branch 0 was taken 216086 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 216086 times"> + </span> :<span class="tlaGNC">      216086 :     if (m_mempool) m_mempool-&gt;check(this-&gt;CoinsTip(), this-&gt;m_chain.Height() + 1);</span></span>
<span class="lineNum">        </span>    <span class="tlaGBC" title="Branch 4 was taken 216086 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaGBC" title="Branch 6 was taken 216086 times"> + </span><span class="tlaUNC" title="Branch 7 was not taken"> - </span>]
<span id="L3371"><span class="lineNum">    3371</span>                 :             : </span>
<span id="L3372"><span class="lineNum">    3372</span>         [<span class="tlaGBC" title="Branch 0 was taken 216086 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      216086 :     CheckForkWarningConditions();</span></span>
<span id="L3373"><span class="lineNum">    3373</span>                 :             : </span>
<span id="L3374"><span class="lineNum">    3374</span>                 :             :     return true;</span>
<span id="L3375"><span class="lineNum">    3375</span>                 :<span class="tlaGNC">      216086 : }</span></span>
<span id="L3376"><span class="lineNum">    3376</span>                 :             : </span>
<span id="L3377"><span class="lineNum">    3377</span>                 :<span class="tlaGNC">      575471 : static SynchronizationState GetSynchronizationState(bool init, bool blockfiles_indexed)</span></span>
<span id="L3378"><span class="lineNum">    3378</span>                 :             : {</span>
<span id="L3379"><span class="lineNum">    3379</span>         [<span class="tlaGBC" title="Branch 0 was taken 375673 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 199798 times"> + </span>]:<span class="tlaGNC">      575471 :     if (!init) return SynchronizationState::POST_INIT;</span></span>
<span id="L3380"><span class="lineNum">    3380</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 375673 times"> + </span>]:<span class="tlaGNC">      375673 :     if (!blockfiles_indexed) return SynchronizationState::INIT_REINDEX;</span></span>
<span id="L3381"><span class="lineNum">    3381</span>                 :             :     return SynchronizationState::INIT_DOWNLOAD;</span>
<span id="L3382"><span class="lineNum">    3382</span>                 :             : }</span>
<span id="L3383"><span class="lineNum">    3383</span>                 :             : </span>
<span id="L3384"><span class="lineNum">    3384</span>                 :<span class="tlaGNC">      509779 : bool ChainstateManager::NotifyHeaderTip()</span></span>
<span id="L3385"><span class="lineNum">    3385</span>                 :             : {</span>
<span id="L3386"><span class="lineNum">    3386</span>                 :<span class="tlaGNC">      509779 :     bool fNotify = false;</span></span>
<span id="L3387"><span class="lineNum">    3387</span>                 :<span class="tlaGNC">      509779 :     bool fInitialBlockDownload = false;</span></span>
<span id="L3388"><span class="lineNum">    3388</span>                 :<span class="tlaGNC">      509779 :     CBlockIndex* pindexHeader = nullptr;</span></span>
<span id="L3389"><span class="lineNum">    3389</span>                 :<span class="tlaGNC">      509779 :     {</span></span>
<span id="L3390"><span class="lineNum">    3390</span>                 :<span class="tlaGNC">      509779 :         LOCK(GetMutex());</span></span>
<span id="L3391"><span class="lineNum">    3391</span>                 :<span class="tlaGNC">      509779 :         pindexHeader = m_best_header;</span></span>
<span id="L3392"><span class="lineNum">    3392</span>                 :             : </span>
<span id="L3393"><span class="lineNum">    3393</span>         [<span class="tlaGBC" title="Branch 0 was taken 374753 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 135026 times"> + </span>]:<span class="tlaGNC">      509779 :         if (pindexHeader != m_last_notified_header) {</span></span>
<span id="L3394"><span class="lineNum">    3394</span>                 :<span class="tlaGNC">      374753 :             fNotify = true;</span></span>
<span id="L3395"><span class="lineNum">    3395</span>         [<span class="tlaGBC" title="Branch 0 was taken 374753 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      374753 :             fInitialBlockDownload = IsInitialBlockDownload();</span></span>
<span id="L3396"><span class="lineNum">    3396</span>                 :<span class="tlaGNC">      374753 :             m_last_notified_header = pindexHeader;</span></span>
<span id="L3397"><span class="lineNum">    3397</span>                 :             :         }</span>
<span id="L3398"><span class="lineNum">    3398</span>                 :<span class="tlaGNC">      509779 :     }</span></span>
<span id="L3399"><span class="lineNum">    3399</span>                 :             :     // Send block tip changed notifications without the lock held</span>
<span id="L3400"><span class="lineNum">    3400</span>         [<span class="tlaGBC" title="Branch 0 was taken 374753 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 135026 times"> + </span>]:<span class="tlaGNC">      509779 :     if (fNotify) {</span></span>
<span id="L3401"><span class="lineNum">    3401</span>                 :<span class="tlaGNC">      374753 :         GetNotifications().headerTip(GetSynchronizationState(fInitialBlockDownload, m_blockman.m_blockfiles_indexed), pindexHeader-&gt;nHeight, pindexHeader-&gt;nTime, false);</span></span>
<span id="L3402"><span class="lineNum">    3402</span>                 :             :     }</span>
<span id="L3403"><span class="lineNum">    3403</span>                 :<span class="tlaGNC">      509779 :     return fNotify;</span></span>
<span id="L3404"><span class="lineNum">    3404</span>                 :             : }</span>
<span id="L3405"><span class="lineNum">    3405</span>                 :             : </span>
<span id="L3406"><span class="lineNum">    3406</span>                 :<span class="tlaGNC">      238061 : static void LimitValidationInterfaceQueue(ValidationSignals&amp; signals) LOCKS_EXCLUDED(cs_main) {</span></span>
<span id="L3407"><span class="lineNum">    3407</span>                 :<span class="tlaGNC">      238061 :     AssertLockNotHeld(cs_main);</span></span>
<span id="L3408"><span class="lineNum">    3408</span>                 :             : </span>
<span id="L3409"><span class="lineNum">    3409</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 238061 times"> + </span>]:<span class="tlaGNC">      238061 :     if (signals.CallbacksPending() &gt; 10) {</span></span>
<span id="L3410"><span class="lineNum">    3410</span>                 :<span class="tlaUNC">           0 :         signals.SyncWithValidationInterfaceQueue();</span></span>
<span id="L3411"><span class="lineNum">    3411</span>                 :             :     }</span>
<span id="L3412"><span class="lineNum">    3412</span>                 :<span class="tlaGNC">      238061 : }</span></span>
<span id="L3413"><span class="lineNum">    3413</span>                 :             : </span>
<span id="L3414"><span class="lineNum">    3414</span>                 :<span class="tlaGNC">      223503 : bool Chainstate::ActivateBestChain(BlockValidationState&amp; state, std::shared_ptr&lt;const CBlock&gt; pblock)</span></span>
<span id="L3415"><span class="lineNum">    3415</span>                 :             : {</span>
<span id="L3416"><span class="lineNum">    3416</span>                 :<span class="tlaGNC">      223503 :     AssertLockNotHeld(m_chainstate_mutex);</span></span>
<span id="L3417"><span class="lineNum">    3417</span>                 :             : </span>
<span id="L3418"><span class="lineNum">    3418</span>                 :             :     // Note that while we're often called here from ProcessNewBlock, this is</span>
<span id="L3419"><span class="lineNum">    3419</span>                 :             :     // far from a guarantee. Things in the P2P/RPC will often end up calling</span>
<span id="L3420"><span class="lineNum">    3420</span>                 :             :     // us in the middle of ProcessNewBlock - do not assume pblock is set</span>
<span id="L3421"><span class="lineNum">    3421</span>                 :             :     // sanely for performance or correctness!</span>
<span id="L3422"><span class="lineNum">    3422</span>                 :<span class="tlaGNC">      223503 :     AssertLockNotHeld(::cs_main);</span></span>
<span id="L3423"><span class="lineNum">    3423</span>                 :             : </span>
<span id="L3424"><span class="lineNum">    3424</span>                 :             :     // ABC maintains a fair degree of expensive-to-calculate internal state</span>
<span id="L3425"><span class="lineNum">    3425</span>                 :             :     // because this function periodically releases cs_main so that it does not lock up other threads for too long</span>
<span id="L3426"><span class="lineNum">    3426</span>                 :             :     // during large connects - and to allow for e.g. the callback queue to drain</span>
<span id="L3427"><span class="lineNum">    3427</span>                 :             :     // we use m_chainstate_mutex to enforce mutual exclusion so that only one caller may execute this function at a time</span>
<span id="L3428"><span class="lineNum">    3428</span>                 :<span class="tlaGNC">      223503 :     LOCK(m_chainstate_mutex);</span></span>
<span id="L3429"><span class="lineNum">    3429</span>                 :             : </span>
<span id="L3430"><span class="lineNum">    3430</span>                 :             :     // Belt-and-suspenders check that we aren't attempting to advance the background</span>
<span id="L3431"><span class="lineNum">    3431</span>                 :             :     // chainstate past the snapshot base block.</span>
<span id="L3432"><span class="lineNum">    3432</span>   [<span class="tlaGBC" title="Branch 0 was taken 223503 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 223503 times"> + </span> :<span class="tlaGNC">      447006 :     if (WITH_LOCK(::cs_main, return m_disabled)) {</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 223503 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L3433"><span class="lineNum">    3433</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LogPrintf(&quot;m_disabled is set - this chainstate should not be in operation. &quot;</span></span>
<span id="L3434"><span class="lineNum">    3434</span>                 :             :             &quot;Please report this as a bug. %s\n&quot;, CLIENT_BUGREPORT);</span>
<span id="L3435"><span class="lineNum">    3435</span>                 :             :         return false;</span>
<span id="L3436"><span class="lineNum">    3436</span>                 :             :     }</span>
<span id="L3437"><span class="lineNum">    3437</span>                 :             : </span>
<span id="L3438"><span class="lineNum">    3438</span>                 :<span class="tlaGNC">      223503 :     CBlockIndex *pindexMostWork = nullptr;</span></span>
<span id="L3439"><span class="lineNum">    3439</span>                 :<span class="tlaGNC">      223503 :     CBlockIndex *pindexNewTip = nullptr;</span></span>
<span id="L3440"><span class="lineNum">    3440</span>                 :<span class="tlaGNC">      223503 :     bool exited_ibd{false};</span></span>
<span id="L3441"><span class="lineNum">    3441</span>                 :<span class="tlaGNC">      238871 :     do {</span></span>
<span id="L3442"><span class="lineNum">    3442</span>                 :             :         // Block until the validation queue drains. This should largely</span>
<span id="L3443"><span class="lineNum">    3443</span>                 :             :         // never happen in normal operation, however may happen during</span>
<span id="L3444"><span class="lineNum">    3444</span>                 :             :         // reindex, causing memory blowup if we run too far ahead.</span>
<span id="L3445"><span class="lineNum">    3445</span>                 :             :         // Note that if a validationinterface callback ends up calling</span>
<span id="L3446"><span class="lineNum">    3446</span>                 :             :         // ActivateBestChain this may lead to a deadlock! We should</span>
<span id="L3447"><span class="lineNum">    3447</span>                 :             :         // probably have a DEBUG_LOCKORDER test for this in the future.</span>
<span id="L3448"><span class="lineNum">    3448</span>   [<span class="tlaGBC" title="Branch 0 was taken 238061 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 810 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 238061 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      238871 :         if (m_chainman.m_options.signals) LimitValidationInterfaceQueue(*m_chainman.m_options.signals);</span></span>
<span id="L3449"><span class="lineNum">    3449</span>                 :             : </span>
<span id="L3450"><span class="lineNum">    3450</span>                 :<span class="tlaGNC">      238871 :         {</span></span>
<span id="L3451"><span class="lineNum">    3451</span>         [<span class="tlaGBC" title="Branch 0 was taken 238871 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      238871 :             LOCK(cs_main);</span></span>
<span id="L3452"><span class="lineNum">    3452</span>                 :<span class="tlaGNC">      238871 :             {</span></span>
<span id="L3453"><span class="lineNum">    3453</span>                 :             :             // Lock transaction pool for at least as long as it takes for connectTrace to be consumed</span>
<span id="L3454"><span class="lineNum">    3454</span>   [<span class="tlaGBC" title="Branch 0 was taken 238871 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 238871 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      477742 :             LOCK(MempoolMutex());</span></span>
<span id="L3455"><span class="lineNum">    3455</span>         [<span class="tlaGBC" title="Branch 0 was taken 238871 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      238871 :             const bool was_in_ibd = m_chainman.IsInitialBlockDownload();</span></span>
<span id="L3456"><span class="lineNum">    3456</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 238871 times"> + </span>]:<span class="tlaGNC">      238871 :             CBlockIndex* starting_tip = m_chain.Tip();</span></span>
<span id="L3457"><span class="lineNum">    3457</span>                 :<span class="tlaGNC">      238871 :             bool blocks_connected = false;</span></span>
<span id="L3458"><span class="lineNum">    3458</span>                 :<span class="tlaGNC">      238871 :             do {</span></span>
<span id="L3459"><span class="lineNum">    3459</span>                 :             :                 // We absolutely may not unlock cs_main until we've made forward progress</span>
<span id="L3460"><span class="lineNum">    3460</span>                 :             :                 // (with the exception of shutdown due to hardware issues, low disk space, etc).</span>
<span id="L3461"><span class="lineNum">    3461</span>         [<span class="tlaGBC" title="Branch 0 was taken 238871 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      238871 :                 ConnectTrace connectTrace; // Destructed before cs_main is unlocked</span></span>
<span id="L3462"><span class="lineNum">    3462</span>                 :             : </span>
<span id="L3463"><span class="lineNum">    3463</span>         [<span class="tlaGBC" title="Branch 0 was taken 238871 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      238871 :                 if (pindexMostWork == nullptr) {</span></span>
<span id="L3464"><span class="lineNum">    3464</span>         [<span class="tlaGBC" title="Branch 0 was taken 238871 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      238871 :                     pindexMostWork = FindMostWorkChain();</span></span>
<span id="L3465"><span class="lineNum">    3465</span>                 :             :                 }</span>
<span id="L3466"><span class="lineNum">    3466</span>                 :             : </span>
<span id="L3467"><span class="lineNum">    3467</span>                 :             :                 // Whether we have anything to do at all.</span>
<span id="L3468"><span class="lineNum">    3468</span>   [<span class="tlaGBC" title="Branch 0 was taken 238871 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 238871 times"> + </span> :<span class="tlaGNC">      477742 :                 if (pindexMostWork == nullptr || pindexMostWork == m_chain.Tip()) {</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 216086 times"> + </span><span class="tlaGBC" title="Branch 5 was taken 22785 times"> + </span>]
<span id="L3469"><span class="lineNum">    3469</span>                 :             :                     break;</span>
<span id="L3470"><span class="lineNum">    3470</span>                 :             :                 }</span>
<span id="L3471"><span class="lineNum">    3471</span>                 :             : </span>
<span id="L3472"><span class="lineNum">    3472</span>                 :<span class="tlaGNC">      216086 :                 bool fInvalidFound = false;</span></span>
<span id="L3473"><span class="lineNum">    3473</span>                 :<span class="tlaGNC">      216086 :                 std::shared_ptr&lt;const CBlock&gt; nullBlockPtr;</span></span>
<span id="L3474"><span class="lineNum">    3474</span>                 :             :                 // BlockConnected signals must be sent for the original role;</span>
<span id="L3475"><span class="lineNum">    3475</span>                 :             :                 // in case snapshot validation is completed during ActivateBestChainStep, the</span>
<span id="L3476"><span class="lineNum">    3476</span>                 :             :                 // result of GetRole() changes from BACKGROUND to NORMAL.</span>
<span id="L3477"><span class="lineNum">    3477</span>         [<span class="tlaGBC" title="Branch 0 was taken 216086 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      216086 :                const ChainstateRole chainstate_role{this-&gt;GetRole()};</span></span>
<span id="L3478"><span class="lineNum">    3478</span>   [<span class="tlaGBC" title="Branch 0 was taken 213126 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 2960 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 213126 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      216086 :                 if (!ActivateBestChainStep(state, pindexMostWork, pblock &amp;&amp; pblock-&gt;GetHash() == pindexMostWork-&gt;GetBlockHash() ? pblock : nullBlockPtr, fInvalidFound, connectTrace)) {</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaGBC" title="Branch 5 was taken 213126 times"> + </span><span class="tlaGBC" title="Branch 6 was taken 216086 times"> + </span><span class="tlaUNC" title="Branch 7 was not taken"> - </span><span class="tlaUNC" title="Branch 8 was not taken"> - </span> 
<span class="lineNum">        </span>             <span class="tlaGBC" title="Branch 9 was taken 216086 times"> + </span>]
<span id="L3479"><span class="lineNum">    3479</span>                 :             :                     // A system error occurred</span>
<span id="L3480"><span class="lineNum">    3480</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     return false;</span></span>
<span id="L3481"><span class="lineNum">    3481</span>                 :             :                 }</span>
<span id="L3482"><span class="lineNum">    3482</span>                 :<span class="tlaGNC">      216086 :                 blocks_connected = true;</span></span>
<span id="L3483"><span class="lineNum">    3483</span>                 :             : </span>
<span id="L3484"><span class="lineNum">    3484</span>         [<span class="tlaGBC" title="Branch 0 was taken 15368 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 200718 times"> + </span>]:<span class="tlaGNC">      216086 :                 if (fInvalidFound) {</span></span>
<span id="L3485"><span class="lineNum">    3485</span>                 :             :                     // Wipe cache, we may need another branch now.</span>
<span id="L3486"><span class="lineNum">    3486</span>                 :<span class="tlaGNC">       15368 :                     pindexMostWork = nullptr;</span></span>
<span id="L3487"><span class="lineNum">    3487</span>                 :             :                 }</span>
<span id="L3488"><span class="lineNum">    3488</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 216086 times"> + </span>]:<span class="tlaGNC">      216086 :                 pindexNewTip = m_chain.Tip();</span></span>
<span id="L3489"><span class="lineNum">    3489</span>                 :             : </span>
<span id="L3490"><span class="lineNum">    3490</span>         [<span class="tlaGBC" title="Branch 0 was taken 200718 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 216086 times"> + </span>]:<span class="tlaGNC">      416804 :                 for (const PerBlockConnectTrace&amp; trace : connectTrace.GetBlocksConnected()) {</span></span>
<span id="L3491"><span class="lineNum">    3491</span>   [<span class="tlaGBC" title="Branch 0 was taken 200718 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 200718 times"> + </span>]:<span class="tlaGNC">      200718 :                     assert(trace.pblock &amp;&amp; trace.pindex);</span></span>
<span id="L3492"><span class="lineNum">    3492</span>         [<span class="tlaGBC" title="Branch 0 was taken 199908 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 810 times"> + </span>]:<span class="tlaGNC">      200718 :                     if (m_chainman.m_options.signals) {</span></span>
<span id="L3493"><span class="lineNum">    3493</span>         [<span class="tlaGBC" title="Branch 0 was taken 199908 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      199908 :                         m_chainman.m_options.signals-&gt;BlockConnected(chainstate_role, trace.pblock, trace.pindex);</span></span>
<span id="L3494"><span class="lineNum">    3494</span>                 :             :                     }</span>
<span id="L3495"><span class="lineNum">    3495</span>                 :             :                 }</span>
<span id="L3496"><span class="lineNum">    3496</span>                 :             : </span>
<span id="L3497"><span class="lineNum">    3497</span>                 :             :                 // This will have been toggled in</span>
<span id="L3498"><span class="lineNum">    3498</span>                 :             :                 // ActivateBestChainStep -&gt; ConnectTip -&gt; MaybeCompleteSnapshotValidation,</span>
<span id="L3499"><span class="lineNum">    3499</span>                 :             :                 // if at all, so we should catch it here.</span>
<span id="L3500"><span class="lineNum">    3500</span>                 :             :                 //</span>
<span id="L3501"><span class="lineNum">    3501</span>                 :             :                 // Break this do-while to ensure we don't advance past the base snapshot.</span>
<span id="L3502"><span class="lineNum">    3502</span>         [<span class="tlaGBC" title="Branch 0 was taken 216086 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      216086 :                 if (m_disabled) {</span></span>
<span id="L3503"><span class="lineNum">    3503</span>                 :             :                     break;</span>
<span id="L3504"><span class="lineNum">    3504</span>                 :             :                 }</span>
<span id="L3505"><span class="lineNum">    3505</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 216086 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 216086 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      454957 :             } while (!m_chain.Tip() || (starting_tip &amp;&amp; CBlockIndexWorkComparator()(m_chain.Tip(), starting_tip)));</span></span>
<span class="lineNum">        </span> <span class="tlaGBC" title="Branch 4 was taken 213126 times"> + </span><span class="tlaGBC" title="Branch 5 was taken 2960 times"> + </span><span class="tlaGBC" title="Branch 6 was taken 213126 times"> + </span><span class="tlaUNC" title="Branch 7 was not taken"> - </span><span class="tlaUNC" title="Branch 8 was not taken"> - </span> 
<span class="lineNum">        </span>       <span class="tlaGBC" title="Branch 9 was taken 213126 times"> + </span><span class="tlaUNC" title="Branch 10 was not taken"> - </span><span class="tlaGBC" title="Branch 11 was taken 216086 times"> + </span>]
<span id="L3506"><span class="lineNum">    3506</span>         [<span class="tlaGBC" title="Branch 0 was taken 216086 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 22785 times"> + </span>]:<span class="tlaGNC">      238871 :             if (!blocks_connected) return true;</span></span>
<span id="L3507"><span class="lineNum">    3507</span>                 :             : </span>
<span id="L3508"><span class="lineNum">    3508</span>         [<span class="tlaGBC" title="Branch 0 was taken 216086 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      216086 :             const CBlockIndex* pindexFork = m_chain.FindFork(starting_tip);</span></span>
<span id="L3509"><span class="lineNum">    3509</span>         [<span class="tlaGBC" title="Branch 0 was taken 216086 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      216086 :             bool still_in_ibd = m_chainman.IsInitialBlockDownload();</span></span>
<span id="L3510"><span class="lineNum">    3510</span>                 :             : </span>
<span id="L3511"><span class="lineNum">    3511</span>         [<span class="tlaGBC" title="Branch 0 was taken 673 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 215413 times"> + </span>]:<span class="tlaGNC">      216086 :             if (was_in_ibd &amp;&amp; !still_in_ibd) {</span></span>
<span id="L3512"><span class="lineNum">    3512</span>                 :             :                 // Active chainstate has exited IBD.</span>
<span id="L3513"><span class="lineNum">    3513</span>                 :<span class="tlaGNC">         673 :                 exited_ibd = true;</span></span>
<span id="L3514"><span class="lineNum">    3514</span>                 :             :             }</span>
<span id="L3515"><span class="lineNum">    3515</span>                 :             : </span>
<span id="L3516"><span class="lineNum">    3516</span>                 :             :             // Notify external listeners about the new tip.</span>
<span id="L3517"><span class="lineNum">    3517</span>                 :             :             // Enqueue while holding cs_main to ensure that UpdatedBlockTip is called in the order in which blocks are connected</span>
<span id="L3518"><span class="lineNum">    3518</span>   [<span class="tlaGBC" title="Branch 0 was taken 216086 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 216086 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      216086 :             if (this == &amp;m_chainman.ActiveChainstate() &amp;&amp; pindexFork != pindexNewTip) {</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 200718 times"> + </span><span class="tlaGBC" title="Branch 5 was taken 15368 times"> + </span>]
<span id="L3519"><span class="lineNum">    3519</span>                 :             :                 // Notify ValidationInterface subscribers</span>
<span id="L3520"><span class="lineNum">    3520</span>         [<span class="tlaGBC" title="Branch 0 was taken 199908 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 810 times"> + </span>]:<span class="tlaGNC">      200718 :                 if (m_chainman.m_options.signals) {</span></span>
<span id="L3521"><span class="lineNum">    3521</span>         [<span class="tlaGBC" title="Branch 0 was taken 199908 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      199908 :                     m_chainman.m_options.signals-&gt;UpdatedBlockTip(pindexNewTip, pindexFork, still_in_ibd);</span></span>
<span id="L3522"><span class="lineNum">    3522</span>                 :             :                 }</span>
<span id="L3523"><span class="lineNum">    3523</span>                 :             : </span>
<span id="L3524"><span class="lineNum">    3524</span>   [<span class="tlaGBC" title="Branch 0 was taken 200718 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 200718 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      401436 :                 if (kernel::IsInterrupted(m_chainman.GetNotifications().blockTip(</span></span>
<span id="L3525"><span class="lineNum">    3525</span>         [<span class="tlaGBC" title="Branch 0 was taken 200718 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      200718 :                         /*state=*/GetSynchronizationState(still_in_ibd, m_chainman.m_blockman.m_blockfiles_indexed),</span></span>
<span id="L3526"><span class="lineNum">    3526</span>                 :             :                         /*index=*/*pindexNewTip,</span>
<span id="L3527"><span class="lineNum">    3527</span>                 :             :                         /*verification_progress=*/m_chainman.GuessVerificationProgress(pindexNewTip))))</span>
<span id="L3528"><span class="lineNum">    3528</span>                 :             :                 {</span>
<span id="L3529"><span class="lineNum">    3529</span>                 :             :                     // Just breaking and returning success for now. This could</span>
<span id="L3530"><span class="lineNum">    3530</span>                 :             :                     // be changed to bubble up the kernel::Interrupted value to</span>
<span id="L3531"><span class="lineNum">    3531</span>                 :             :                     // the caller so the caller could distinguish between</span>
<span id="L3532"><span class="lineNum">    3532</span>                 :             :                     // completed and interrupted operations.</span>
<span id="L3533"><span class="lineNum">    3533</span>                 :             :                     break;</span>
<span id="L3534"><span class="lineNum">    3534</span>                 :             :                 }</span>
<span id="L3535"><span class="lineNum">    3535</span>                 :             :             }</span>
<span id="L3536"><span class="lineNum">    3536</span>   [<span class="tlaGBC" title="Branch 0 was taken 22785 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">       22785 :             } // release MempoolMutex</span></span>
<span id="L3537"><span class="lineNum">    3537</span>                 :             :             // Notify external listeners about the new tip, even if pindexFork == pindexNewTip.</span>
<span id="L3538"><span class="lineNum">    3538</span>   [<span class="tlaGBC" title="Branch 0 was taken 215276 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 810 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 215276 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      216086 :             if (m_chainman.m_options.signals &amp;&amp; this == &amp;m_chainman.ActiveChainstate()) {</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 215276 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L3539"><span class="lineNum">    3539</span>   [<span class="tlaGBC" title="Branch 0 was taken 215276 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 215276 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      215276 :                 m_chainman.m_options.signals-&gt;ActiveTipChange(*Assert(pindexNewTip), m_chainman.IsInitialBlockDownload());</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 215276 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L3540"><span class="lineNum">    3540</span>                 :             :             }</span>
<span id="L3541"><span class="lineNum">    3541</span>                 :<span class="tlaGNC">       22785 :         } // release cs_main</span></span>
<span id="L3542"><span class="lineNum">    3542</span>                 :             :         // When we reach this point, we switched to a new tip (stored in pindexNewTip).</span>
<span id="L3543"><span class="lineNum">    3543</span>                 :             : </span>
<span id="L3544"><span class="lineNum">    3544</span>         [<span class="tlaGBC" title="Branch 0 was taken 673 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 215413 times"> + </span>]:<span class="tlaGNC">      216086 :         if (exited_ibd) {</span></span>
<span id="L3545"><span class="lineNum">    3545</span>                 :             :             // If a background chainstate is in use, we may need to rebalance our</span>
<span id="L3546"><span class="lineNum">    3546</span>                 :             :             // allocation of caches once a chainstate exits initial block download.</span>
<span id="L3547"><span class="lineNum">    3547</span>         [<span class="tlaGBC" title="Branch 0 was taken 673 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">         673 :             LOCK(::cs_main);</span></span>
<span id="L3548"><span class="lineNum">    3548</span>         [<span class="tlaGBC" title="Branch 0 was taken 673 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">         673 :             m_chainman.MaybeRebalanceCaches();</span></span>
<span id="L3549"><span class="lineNum">    3549</span>                 :<span class="tlaGNC">         673 :         }</span></span>
<span id="L3550"><span class="lineNum">    3550</span>                 :             : </span>
<span id="L3551"><span class="lineNum">    3551</span>   [<span class="tlaGBC" title="Branch 0 was taken 216086 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 216086 times"> + </span> :<span class="tlaGNC">      432172 :         if (WITH_LOCK(::cs_main, return m_disabled)) {</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 216086 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L3552"><span class="lineNum">    3552</span>                 :             :             // Background chainstate has reached the snapshot base block, so exit.</span>
<span id="L3553"><span class="lineNum">    3553</span>                 :             : </span>
<span id="L3554"><span class="lineNum">    3554</span>                 :             :             // Restart indexes to resume indexing for all blocks unique to the snapshot</span>
<span id="L3555"><span class="lineNum">    3555</span>                 :             :             // chain. This resumes indexing &quot;in order&quot; from where the indexing on the</span>
<span id="L3556"><span class="lineNum">    3556</span>                 :             :             // background validation chain left off.</span>
<span id="L3557"><span class="lineNum">    3557</span>                 :             :             //</span>
<span id="L3558"><span class="lineNum">    3558</span>                 :             :             // This cannot be done while holding cs_main (within</span>
<span id="L3559"><span class="lineNum">    3559</span>                 :             :             // MaybeCompleteSnapshotValidation) or a cs_main deadlock will occur.</span>
<span id="L3560"><span class="lineNum">    3560</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (m_chainman.snapshot_download_completed) {</span></span>
<span id="L3561"><span class="lineNum">    3561</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 m_chainman.snapshot_download_completed();</span></span>
<span id="L3562"><span class="lineNum">    3562</span>                 :             :             }</span>
<span id="L3563"><span class="lineNum">    3563</span>                 :             :             break;</span>
<span id="L3564"><span class="lineNum">    3564</span>                 :             :         }</span>
<span id="L3565"><span class="lineNum">    3565</span>                 :             : </span>
<span id="L3566"><span class="lineNum">    3566</span>                 :             :         // We check interrupt only after giving ActivateBestChainStep a chance to run once so that we</span>
<span id="L3567"><span class="lineNum">    3567</span>                 :             :         // never interrupt before connecting the genesis block during LoadChainTip(). Previously this</span>
<span id="L3568"><span class="lineNum">    3568</span>                 :             :         // caused an assert() failure during interrupt in such cases as the UTXO DB flushing checks</span>
<span id="L3569"><span class="lineNum">    3569</span>                 :             :         // that the best block hash is non-null.</span>
<span id="L3570"><span class="lineNum">    3570</span>   [<span class="tlaGBC" title="Branch 0 was taken 216086 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 216086 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      216086 :         if (m_chainman.m_interrupt) break;</span></span>
<span id="L3571"><span class="lineNum">    3571</span>         [<span class="tlaGBC" title="Branch 0 was taken 15368 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 200718 times"> + </span>]:<span class="tlaGNC">      216086 :     } while (pindexNewTip != pindexMostWork);</span></span>
<span id="L3572"><span class="lineNum">    3572</span>                 :             : </span>
<span id="L3573"><span class="lineNum">    3573</span>         [<span class="tlaGBC" title="Branch 0 was taken 200718 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      200718 :     m_chainman.CheckBlockIndex();</span></span>
<span id="L3574"><span class="lineNum">    3574</span>                 :             : </span>
<span id="L3575"><span class="lineNum">    3575</span>                 :             :     // Write changes periodically to disk, after relay.</span>
<span id="L3576"><span class="lineNum">    3576</span>   [<span class="tlaGBC" title="Branch 0 was taken 200718 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 200718 times"> + </span>]:<span class="tlaGNC">      200718 :     if (!FlushStateToDisk(state, FlushStateMode::PERIODIC)) {</span></span>
<span id="L3577"><span class="lineNum">    3577</span>                 :<span class="tlaUNC">           0 :         return false;</span></span>
<span id="L3578"><span class="lineNum">    3578</span>                 :             :     }</span>
<span id="L3579"><span class="lineNum">    3579</span>                 :             : </span>
<span id="L3580"><span class="lineNum">    3580</span>                 :             :     return true;</span>
<span id="L3581"><span class="lineNum">    3581</span>                 :<span class="tlaGNC">      223503 : }</span></span>
<span id="L3582"><span class="lineNum">    3582</span>                 :             : </span>
<span id="L3583"><span class="lineNum">    3583</span>                 :<span class="tlaGNC">           3 : bool Chainstate::PreciousBlock(BlockValidationState&amp; state, CBlockIndex* pindex)</span></span>
<span id="L3584"><span class="lineNum">    3584</span>                 :             : {</span>
<span id="L3585"><span class="lineNum">    3585</span>                 :<span class="tlaGNC">           3 :     AssertLockNotHeld(m_chainstate_mutex);</span></span>
<span id="L3586"><span class="lineNum">    3586</span>                 :<span class="tlaGNC">           3 :     AssertLockNotHeld(::cs_main);</span></span>
<span id="L3587"><span class="lineNum">    3587</span>                 :<span class="tlaGNC">           3 :     {</span></span>
<span id="L3588"><span class="lineNum">    3588</span>                 :<span class="tlaGNC">           3 :         LOCK(cs_main);</span></span>
<span id="L3589"><span class="lineNum">    3589</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 3 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 3 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">           6 :         if (pindex-&gt;nChainWork &lt; m_chain.Tip()-&gt;nChainWork) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaGBC" title="Branch 5 was taken 3 times"> + </span>]
<span id="L3590"><span class="lineNum">    3590</span>                 :             :             // Nothing to do, this block is not at the tip.</span>
<span id="L3591"><span class="lineNum">    3591</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             return true;</span></span>
<span id="L3592"><span class="lineNum">    3592</span>                 :             :         }</span>
<span id="L3593"><span class="lineNum">    3593</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 3 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 3 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">           6 :         if (m_chain.Tip()-&gt;nChainWork &gt; m_chainman.nLastPreciousChainwork) {</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 1 time"> + </span><span class="tlaGBC" title="Branch 5 was taken 2 times"> + </span>]
<span id="L3594"><span class="lineNum">    3594</span>                 :             :             // The chain has been extended since the last call, reset the counter.</span>
<span id="L3595"><span class="lineNum">    3595</span>                 :<span class="tlaGNC">           1 :             m_chainman.nBlockReverseSequenceId = -1;</span></span>
<span id="L3596"><span class="lineNum">    3596</span>                 :             :         }</span>
<span id="L3597"><span class="lineNum">    3597</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 3 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 3 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">           6 :         m_chainman.nLastPreciousChainwork = m_chain.Tip()-&gt;nChainWork;</span></span>
<span id="L3598"><span class="lineNum">    3598</span>         [<span class="tlaGBC" title="Branch 0 was taken 3 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">           3 :         setBlockIndexCandidates.erase(pindex);</span></span>
<span id="L3599"><span class="lineNum">    3599</span>                 :<span class="tlaGNC">           3 :         pindex-&gt;nSequenceId = m_chainman.nBlockReverseSequenceId;</span></span>
<span id="L3600"><span class="lineNum">    3600</span>         [<span class="tlaGBC" title="Branch 0 was taken 3 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">           3 :         if (m_chainman.nBlockReverseSequenceId &gt; std::numeric_limits&lt;int32_t&gt;::min()) {</span></span>
<span id="L3601"><span class="lineNum">    3601</span>                 :             :             // We can't keep reducing the counter if somebody really wants to</span>
<span id="L3602"><span class="lineNum">    3602</span>                 :             :             // call preciousblock 2**31-1 times on the same set of tips...</span>
<span id="L3603"><span class="lineNum">    3603</span>                 :<span class="tlaGNC">           3 :             m_chainman.nBlockReverseSequenceId--;</span></span>
<span id="L3604"><span class="lineNum">    3604</span>                 :             :         }</span>
<span id="L3605"><span class="lineNum">    3605</span>   [<span class="tlaGBC" title="Branch 0 was taken 3 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 3 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">           6 :         if (pindex-&gt;IsValid(BLOCK_VALID_TRANSACTIONS) &amp;&amp; pindex-&gt;HaveNumChainTxs()) {</span></span>
<span class="lineNum">        </span>    <span class="tlaGBC" title="Branch 4 was taken 3 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaGBC" title="Branch 6 was taken 3 times"> + </span><span class="tlaUNC" title="Branch 7 was not taken"> - </span>]
<span id="L3606"><span class="lineNum">    3606</span>         [<span class="tlaGBC" title="Branch 0 was taken 3 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">           3 :             setBlockIndexCandidates.insert(pindex);</span></span>
<span id="L3607"><span class="lineNum">    3607</span>         [<span class="tlaGBC" title="Branch 0 was taken 3 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">           3 :             PruneBlockIndexCandidates();</span></span>
<span id="L3608"><span class="lineNum">    3608</span>                 :             :         }</span>
<span id="L3609"><span class="lineNum">    3609</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L3610"><span class="lineNum">    3610</span>                 :             : </span>
<span id="L3611"><span class="lineNum">    3611</span>   [<span class="tlaGBC" title="Branch 0 was taken 3 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 3 times"> + </span>]:<span class="tlaGNC">           3 :     return ActivateBestChain(state, std::shared_ptr&lt;const CBlock&gt;());</span></span>
<span id="L3612"><span class="lineNum">    3612</span>                 :             : }</span>
<span id="L3613"><span class="lineNum">    3613</span>                 :             : </span>
<span id="L3614"><span class="lineNum">    3614</span>                 :<span class="tlaGNC">           1 : bool Chainstate::InvalidateBlock(BlockValidationState&amp; state, CBlockIndex* pindex)</span></span>
<span id="L3615"><span class="lineNum">    3615</span>                 :             : {</span>
<span id="L3616"><span class="lineNum">    3616</span>                 :<span class="tlaGNC">           1 :     AssertLockNotHeld(m_chainstate_mutex);</span></span>
<span id="L3617"><span class="lineNum">    3617</span>                 :<span class="tlaGNC">           1 :     AssertLockNotHeld(::cs_main);</span></span>
<span id="L3618"><span class="lineNum">    3618</span>                 :             : </span>
<span id="L3619"><span class="lineNum">    3619</span>                 :             :     // Genesis block can't be invalidated</span>
<span id="L3620"><span class="lineNum">    3620</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 1 time"> + </span>]:<span class="tlaGNC">           1 :     assert(pindex);</span></span>
<span id="L3621"><span class="lineNum">    3621</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 1 time"> + </span>]:<span class="tlaGNC">           1 :     if (pindex-&gt;nHeight == 0) return false;</span></span>
<span id="L3622"><span class="lineNum">    3622</span>                 :             : </span>
<span id="L3623"><span class="lineNum">    3623</span>                 :<span class="tlaUNC">           0 :     CBlockIndex* to_mark_failed = pindex;</span></span>
<span id="L3624"><span class="lineNum">    3624</span>                 :<span class="tlaUNC">           0 :     bool pindex_was_in_chain = false;</span></span>
<span id="L3625"><span class="lineNum">    3625</span>                 :<span class="tlaUNC">           0 :     int disconnected = 0;</span></span>
<span id="L3626"><span class="lineNum">    3626</span>                 :             : </span>
<span id="L3627"><span class="lineNum">    3627</span>                 :             :     // We do not allow ActivateBestChain() to run while InvalidateBlock() is</span>
<span id="L3628"><span class="lineNum">    3628</span>                 :             :     // running, as that could cause the tip to change while we disconnect</span>
<span id="L3629"><span class="lineNum">    3629</span>                 :             :     // blocks.</span>
<span id="L3630"><span class="lineNum">    3630</span>                 :<span class="tlaUNC">           0 :     LOCK(m_chainstate_mutex);</span></span>
<span id="L3631"><span class="lineNum">    3631</span>                 :             : </span>
<span id="L3632"><span class="lineNum">    3632</span>                 :             :     // We'll be acquiring and releasing cs_main below, to allow the validation</span>
<span id="L3633"><span class="lineNum">    3633</span>                 :             :     // callbacks to run. However, we should keep the block index in a</span>
<span id="L3634"><span class="lineNum">    3634</span>                 :             :     // consistent state as we disconnect blocks -- in particular we need to</span>
<span id="L3635"><span class="lineNum">    3635</span>                 :             :     // add equal-work blocks to setBlockIndexCandidates as we disconnect.</span>
<span id="L3636"><span class="lineNum">    3636</span>                 :             :     // To avoid walking the block index repeatedly in search of candidates,</span>
<span id="L3637"><span class="lineNum">    3637</span>                 :             :     // build a map once so that we can look up candidate blocks by chain</span>
<span id="L3638"><span class="lineNum">    3638</span>                 :             :     // work as we go.</span>
<span id="L3639"><span class="lineNum">    3639</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     std::multimap&lt;const arith_uint256, CBlockIndex*&gt; highpow_outofchain_headers;</span></span>
<span id="L3640"><span class="lineNum">    3640</span>                 :             : </span>
<span id="L3641"><span class="lineNum">    3641</span>                 :<span class="tlaUNC">           0 :     {</span></span>
<span id="L3642"><span class="lineNum">    3642</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LOCK(cs_main);</span></span>
<span id="L3643"><span class="lineNum">    3643</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         for (auto&amp; entry : m_blockman.m_block_index) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L3644"><span class="lineNum">    3644</span>                 :<span class="tlaUNC">           0 :             CBlockIndex* candidate = &amp;entry.second;</span></span>
<span id="L3645"><span class="lineNum">    3645</span>                 :             :             // We don't need to put anything in our active chain into the</span>
<span id="L3646"><span class="lineNum">    3646</span>                 :             :             // multimap, because those candidates will be found and considered</span>
<span id="L3647"><span class="lineNum">    3647</span>                 :             :             // as we disconnect.</span>
<span id="L3648"><span class="lineNum">    3648</span>                 :             :             // Instead, consider only non-active-chain blocks that score</span>
<span id="L3649"><span class="lineNum">    3649</span>                 :             :             // at least as good with CBlockIndexWorkComparator as the new tip.</span>
<span id="L3650"><span class="lineNum">    3650</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (!m_chain.Contains(candidate) &amp;&amp;</span></span>
<span id="L3651"><span class="lineNum">    3651</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 !CBlockIndexWorkComparator()(candidate, pindex-&gt;pprev) &amp;&amp;</span></span>
<span id="L3652"><span class="lineNum">    3652</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 !(candidate-&gt;nStatus &amp; BLOCK_FAILED_MASK)) {</span></span>
<span id="L3653"><span class="lineNum">    3653</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 highpow_outofchain_headers.insert({candidate-&gt;nChainWork, candidate});</span></span>
<span id="L3654"><span class="lineNum">    3654</span>                 :             :             }</span>
<span id="L3655"><span class="lineNum">    3655</span>                 :             :         }</span>
<span id="L3656"><span class="lineNum">    3656</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L3657"><span class="lineNum">    3657</span>                 :             : </span>
<span id="L3658"><span class="lineNum">    3658</span>                 :             :     // Disconnect (descendants of) pindex, and mark them invalid.</span>
<span id="L3659"><span class="lineNum">    3659</span>                 :<span class="tlaUNC">           0 :     while (true) {</span></span>
<span id="L3660"><span class="lineNum">    3660</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (m_chainman.m_interrupt) break;</span></span>
<span id="L3661"><span class="lineNum">    3661</span>                 :             : </span>
<span id="L3662"><span class="lineNum">    3662</span>                 :             :         // Make sure the queue of validation callbacks doesn't grow unboundedly.</span>
<span id="L3663"><span class="lineNum">    3663</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (m_chainman.m_options.signals) LimitValidationInterfaceQueue(*m_chainman.m_options.signals);</span></span>
<span id="L3664"><span class="lineNum">    3664</span>                 :             : </span>
<span id="L3665"><span class="lineNum">    3665</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LOCK(cs_main);</span></span>
<span id="L3666"><span class="lineNum">    3666</span>                 :             :         // Lock for as long as disconnectpool is in scope to make sure MaybeUpdateMempoolForReorg is</span>
<span id="L3667"><span class="lineNum">    3667</span>                 :             :         // called after DisconnectTip without unlocking in between</span>
<span id="L3668"><span class="lineNum">    3668</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LOCK(MempoolMutex());</span></span>
<span id="L3669"><span class="lineNum">    3669</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!m_chain.Contains(pindex)) break;</span></span>
<span id="L3670"><span class="lineNum">    3670</span>                 :<span class="tlaUNC">           0 :         pindex_was_in_chain = true;</span></span>
<span id="L3671"><span class="lineNum">    3671</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         CBlockIndex *invalid_walk_tip = m_chain.Tip();</span></span>
<span id="L3672"><span class="lineNum">    3672</span>                 :             : </span>
<span id="L3673"><span class="lineNum">    3673</span>                 :             :         // ActivateBestChain considers blocks already in m_chain</span>
<span id="L3674"><span class="lineNum">    3674</span>                 :             :         // unconditionally valid already, so force disconnect away from it.</span>
<span id="L3675"><span class="lineNum">    3675</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         DisconnectedBlockTransactions disconnectpool{MAX_DISCONNECTED_TX_POOL_BYTES};</span></span>
<span id="L3676"><span class="lineNum">    3676</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         bool ret = DisconnectTip(state, &amp;disconnectpool);</span></span>
<span id="L3677"><span class="lineNum">    3677</span>                 :             :         // DisconnectTip will add transactions to disconnectpool.</span>
<span id="L3678"><span class="lineNum">    3678</span>                 :             :         // Adjust the mempool to be consistent with the new tip, adding</span>
<span id="L3679"><span class="lineNum">    3679</span>                 :             :         // transactions back to the mempool if disconnecting was successful,</span>
<span id="L3680"><span class="lineNum">    3680</span>                 :             :         // and we're not doing a very deep invalidation (in which case</span>
<span id="L3681"><span class="lineNum">    3681</span>                 :             :         // keeping the mempool up to date is probably futile anyway).</span>
<span id="L3682"><span class="lineNum">    3682</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         MaybeUpdateMempoolForReorg(disconnectpool, /* fAddToMempool = */ (++disconnected &lt;= 10) &amp;&amp; ret);</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L3683"><span class="lineNum">    3683</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!ret) return false;</span></span>
<span id="L3684"><span class="lineNum">    3684</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         assert(invalid_walk_tip-&gt;pprev == m_chain.Tip());</span></span>
<span id="L3685"><span class="lineNum">    3685</span>                 :             : </span>
<span id="L3686"><span class="lineNum">    3686</span>                 :             :         // We immediately mark the disconnected blocks as invalid.</span>
<span id="L3687"><span class="lineNum">    3687</span>                 :             :         // This prevents a case where pruned nodes may fail to invalidateblock</span>
<span id="L3688"><span class="lineNum">    3688</span>                 :             :         // and be left unable to start as they have no tip candidates (as there</span>
<span id="L3689"><span class="lineNum">    3689</span>                 :             :         // are no blocks that meet the &quot;have data and are not invalid per</span>
<span id="L3690"><span class="lineNum">    3690</span>                 :             :         // nStatus&quot; criteria for inclusion in setBlockIndexCandidates).</span>
<span id="L3691"><span class="lineNum">    3691</span>                 :<span class="tlaUNC">           0 :         invalid_walk_tip-&gt;nStatus |= BLOCK_FAILED_VALID;</span></span>
<span id="L3692"><span class="lineNum">    3692</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         m_blockman.m_dirty_blockindex.insert(invalid_walk_tip);</span></span>
<span id="L3693"><span class="lineNum">    3693</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         setBlockIndexCandidates.erase(invalid_walk_tip);</span></span>
<span id="L3694"><span class="lineNum">    3694</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         setBlockIndexCandidates.insert(invalid_walk_tip-&gt;pprev);</span></span>
<span id="L3695"><span class="lineNum">    3695</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (invalid_walk_tip == to_mark_failed-&gt;pprev &amp;&amp; (to_mark_failed-&gt;nStatus &amp; BLOCK_FAILED_VALID)) {</span></span>
<span id="L3696"><span class="lineNum">    3696</span>                 :             :             // We only want to mark the last disconnected block as BLOCK_FAILED_VALID; its children</span>
<span id="L3697"><span class="lineNum">    3697</span>                 :             :             // need to be BLOCK_FAILED_CHILD instead.</span>
<span id="L3698"><span class="lineNum">    3698</span>                 :<span class="tlaUNC">           0 :             to_mark_failed-&gt;nStatus = (to_mark_failed-&gt;nStatus ^ BLOCK_FAILED_VALID) | BLOCK_FAILED_CHILD;</span></span>
<span id="L3699"><span class="lineNum">    3699</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             m_blockman.m_dirty_blockindex.insert(to_mark_failed);</span></span>
<span id="L3700"><span class="lineNum">    3700</span>                 :             :         }</span>
<span id="L3701"><span class="lineNum">    3701</span>                 :             : </span>
<span id="L3702"><span class="lineNum">    3702</span>                 :             :         // Mark out-of-chain descendants of the invalidated block as invalid</span>
<span id="L3703"><span class="lineNum">    3703</span>                 :             :         // (possibly replacing a pre-existing BLOCK_FAILED_VALID with BLOCK_FAILED_CHILD)</span>
<span id="L3704"><span class="lineNum">    3704</span>                 :             :         // Add any equal or more work headers that are not invalidated to setBlockIndexCandidates</span>
<span id="L3705"><span class="lineNum">    3705</span>                 :             :         // Recalculate m_best_header if it became invalid.</span>
<span id="L3706"><span class="lineNum">    3706</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         auto candidate_it = highpow_outofchain_headers.lower_bound(invalid_walk_tip-&gt;pprev-&gt;nChainWork);</span></span>
<span id="L3707"><span class="lineNum">    3707</span>                 :             : </span>
<span id="L3708"><span class="lineNum">    3708</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         const bool best_header_needs_update{m_chainman.m_best_header-&gt;GetAncestor(invalid_walk_tip-&gt;nHeight) == invalid_walk_tip};</span></span>
<span id="L3709"><span class="lineNum">    3709</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (best_header_needs_update) {</span></span>
<span id="L3710"><span class="lineNum">    3710</span>                 :             :             // pprev is definitely still valid at this point, but there may be better ones</span>
<span id="L3711"><span class="lineNum">    3711</span>                 :<span class="tlaUNC">           0 :             m_chainman.m_best_header = invalid_walk_tip-&gt;pprev;</span></span>
<span id="L3712"><span class="lineNum">    3712</span>                 :             :         }</span>
<span id="L3713"><span class="lineNum">    3713</span>                 :             : </span>
<span id="L3714"><span class="lineNum">    3714</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         while (candidate_it != highpow_outofchain_headers.end()) {</span></span>
<span id="L3715"><span class="lineNum">    3715</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             CBlockIndex* candidate{candidate_it-&gt;second};</span></span>
<span id="L3716"><span class="lineNum">    3716</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (candidate-&gt;GetAncestor(invalid_walk_tip-&gt;nHeight) == invalid_walk_tip) {</span></span>
<span id="L3717"><span class="lineNum">    3717</span>                 :             :                 // Children of failed blocks should be marked as BLOCK_FAILED_CHILD instead.</span>
<span id="L3718"><span class="lineNum">    3718</span>                 :<span class="tlaUNC">           0 :                 candidate-&gt;nStatus &amp;= ~BLOCK_FAILED_VALID;</span></span>
<span id="L3719"><span class="lineNum">    3719</span>                 :<span class="tlaUNC">           0 :                 candidate-&gt;nStatus |= BLOCK_FAILED_CHILD;</span></span>
<span id="L3720"><span class="lineNum">    3720</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 m_blockman.m_dirty_blockindex.insert(candidate);</span></span>
<span id="L3721"><span class="lineNum">    3721</span>                 :             :                 // If invalidated, the block is irrelevant for setBlockIndexCandidates</span>
<span id="L3722"><span class="lineNum">    3722</span>                 :             :                 // and for m_best_header and can be removed from the cache.</span>
<span id="L3723"><span class="lineNum">    3723</span>                 :<span class="tlaUNC">           0 :                 candidate_it = highpow_outofchain_headers.erase(candidate_it);</span></span>
<span id="L3724"><span class="lineNum">    3724</span>                 :<span class="tlaUNC">           0 :                 continue;</span></span>
<span id="L3725"><span class="lineNum">    3725</span>                 :             :             }</span>
<span id="L3726"><span class="lineNum">    3726</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (!CBlockIndexWorkComparator()(candidate, invalid_walk_tip-&gt;pprev) &amp;&amp;</span></span>
<span id="L3727"><span class="lineNum">    3727</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                 candidate-&gt;IsValid(BLOCK_VALID_TRANSACTIONS) &amp;&amp;</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L3728"><span class="lineNum">    3728</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 candidate-&gt;HaveNumChainTxs()) {</span></span>
<span id="L3729"><span class="lineNum">    3729</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 setBlockIndexCandidates.insert(candidate);</span></span>
<span id="L3730"><span class="lineNum">    3730</span>                 :             :                 // Do not remove candidate from the highpow_outofchain_headers cache, because it might be a descendant of the block being invalidated</span>
<span id="L3731"><span class="lineNum">    3731</span>                 :             :                 // which needs to be marked failed later.</span>
<span id="L3732"><span class="lineNum">    3732</span>                 :             :             }</span>
<span id="L3733"><span class="lineNum">    3733</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (best_header_needs_update &amp;&amp;</span></span>
<span id="L3734"><span class="lineNum">    3734</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 m_chainman.m_best_header-&gt;nChainWork &lt; candidate-&gt;nChainWork) {</span></span>
<span id="L3735"><span class="lineNum">    3735</span>                 :<span class="tlaUNC">           0 :                 m_chainman.m_best_header = candidate;</span></span>
<span id="L3736"><span class="lineNum">    3736</span>                 :             :             }</span>
<span id="L3737"><span class="lineNum">    3737</span>                 :<span class="tlaUNC">           0 :             ++candidate_it;</span></span>
<span id="L3738"><span class="lineNum">    3738</span>                 :             :         }</span>
<span id="L3739"><span class="lineNum">    3739</span>                 :             : </span>
<span id="L3740"><span class="lineNum">    3740</span>                 :             :         // Track the last disconnected block, so we can correct its BLOCK_FAILED_CHILD status in future</span>
<span id="L3741"><span class="lineNum">    3741</span>                 :             :         // iterations, or, if it's the last one, call InvalidChainFound on it.</span>
<span id="L3742"><span class="lineNum">    3742</span>                 :<span class="tlaUNC">           0 :         to_mark_failed = invalid_walk_tip;</span></span>
<span id="L3743"><span class="lineNum">    3743</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     }</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not executed"> # </span>]
<span id="L3744"><span class="lineNum">    3744</span>                 :             : </span>
<span id="L3745"><span class="lineNum">    3745</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     m_chainman.CheckBlockIndex();</span></span>
<span id="L3746"><span class="lineNum">    3746</span>                 :             : </span>
<span id="L3747"><span class="lineNum">    3747</span>                 :<span class="tlaUNC">           0 :     {</span></span>
<span id="L3748"><span class="lineNum">    3748</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LOCK(cs_main);</span></span>
<span id="L3749"><span class="lineNum">    3749</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (m_chain.Contains(to_mark_failed)) {</span></span>
<span id="L3750"><span class="lineNum">    3750</span>                 :             :             // If the to-be-marked invalid block is in the active chain, something is interfering and we can't proceed.</span>
<span id="L3751"><span class="lineNum">    3751</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             return false;</span></span>
<span id="L3752"><span class="lineNum">    3752</span>                 :             :         }</span>
<span id="L3753"><span class="lineNum">    3753</span>                 :             : </span>
<span id="L3754"><span class="lineNum">    3754</span>                 :             :         // Mark pindex as invalid if it never was in the main chain</span>
<span id="L3755"><span class="lineNum">    3755</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!pindex_was_in_chain &amp;&amp; !(pindex-&gt;nStatus &amp; BLOCK_FAILED_MASK)) {</span></span>
<span id="L3756"><span class="lineNum">    3756</span>                 :<span class="tlaUNC">           0 :             pindex-&gt;nStatus |= BLOCK_FAILED_VALID;</span></span>
<span id="L3757"><span class="lineNum">    3757</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             m_blockman.m_dirty_blockindex.insert(pindex);</span></span>
<span id="L3758"><span class="lineNum">    3758</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             setBlockIndexCandidates.erase(pindex);</span></span>
<span id="L3759"><span class="lineNum">    3759</span>                 :             :         }</span>
<span id="L3760"><span class="lineNum">    3760</span>                 :             : </span>
<span id="L3761"><span class="lineNum">    3761</span>                 :             :         // If any new blocks somehow arrived while we were disconnecting</span>
<span id="L3762"><span class="lineNum">    3762</span>                 :             :         // (above), then the pre-calculation of what should go into</span>
<span id="L3763"><span class="lineNum">    3763</span>                 :             :         // setBlockIndexCandidates may have missed entries. This would</span>
<span id="L3764"><span class="lineNum">    3764</span>                 :             :         // technically be an inconsistency in the block index, but if we clean</span>
<span id="L3765"><span class="lineNum">    3765</span>                 :             :         // it up here, this should be an essentially unobservable error.</span>
<span id="L3766"><span class="lineNum">    3766</span>                 :             :         // Loop back over all block index entries and add any missing entries</span>
<span id="L3767"><span class="lineNum">    3767</span>                 :             :         // to setBlockIndexCandidates.</span>
<span id="L3768"><span class="lineNum">    3768</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         for (auto&amp; [_, block_index] : m_blockman.m_block_index) {</span></span>
<span id="L3769"><span class="lineNum">    3769</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             if (block_index.IsValid(BLOCK_VALID_TRANSACTIONS) &amp;&amp; block_index.HaveNumChainTxs() &amp;&amp; !setBlockIndexCandidates.value_comp()(&amp;block_index, m_chain.Tip())) {</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span>       <span class="tlaUNC" title="Branch 9 was not executed"> # </span><span class="tlaUNC" title="Branch 10 was not executed"> # </span><span class="tlaUNC" title="Branch 11 was not executed"> # </span>]
<span id="L3770"><span class="lineNum">    3770</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 setBlockIndexCandidates.insert(&amp;block_index);</span></span>
<span id="L3771"><span class="lineNum">    3771</span>                 :             :             }</span>
<span id="L3772"><span class="lineNum">    3772</span>                 :             :         }</span>
<span id="L3773"><span class="lineNum">    3773</span>                 :             : </span>
<span id="L3774"><span class="lineNum">    3774</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         InvalidChainFound(to_mark_failed);</span></span>
<span id="L3775"><span class="lineNum">    3775</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L3776"><span class="lineNum">    3776</span>                 :             : </span>
<span id="L3777"><span class="lineNum">    3777</span>                 :             :     // Only notify about a new block tip if the active chain was modified.</span>
<span id="L3778"><span class="lineNum">    3778</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (pindex_was_in_chain) {</span></span>
<span id="L3779"><span class="lineNum">    3779</span>                 :             :         // Ignoring return value for now, this could be changed to bubble up</span>
<span id="L3780"><span class="lineNum">    3780</span>                 :             :         // kernel::Interrupted value to the caller so the caller could</span>
<span id="L3781"><span class="lineNum">    3781</span>                 :             :         // distinguish between completed and interrupted operations. It might</span>
<span id="L3782"><span class="lineNum">    3782</span>                 :             :         // also make sense for the blockTip notification to have an enum</span>
<span id="L3783"><span class="lineNum">    3783</span>                 :             :         // parameter indicating the source of the tip change so hooks can</span>
<span id="L3784"><span class="lineNum">    3784</span>                 :             :         // distinguish user-initiated invalidateblock changes from other</span>
<span id="L3785"><span class="lineNum">    3785</span>                 :             :         // changes.</span>
<span id="L3786"><span class="lineNum">    3786</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         (void)m_chainman.GetNotifications().blockTip(</span></span>
<span id="L3787"><span class="lineNum">    3787</span>                 :<span class="tlaUNC">           0 :             /*state=*/GetSynchronizationState(m_chainman.IsInitialBlockDownload(), m_chainman.m_blockman.m_blockfiles_indexed),</span></span>
<span id="L3788"><span class="lineNum">    3788</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             /*index=*/*to_mark_failed-&gt;pprev,</span></span>
<span id="L3789"><span class="lineNum">    3789</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             /*verification_progress=*/WITH_LOCK(m_chainman.GetMutex(), return m_chainman.GuessVerificationProgress(to_mark_failed-&gt;pprev)));</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L3790"><span class="lineNum">    3790</span>                 :             : </span>
<span id="L3791"><span class="lineNum">    3791</span>                 :             :         // Fire ActiveTipChange now for the current chain tip to make sure clients are notified.</span>
<span id="L3792"><span class="lineNum">    3792</span>                 :             :         // ActivateBestChain may call this as well, but not necessarily.</span>
<span id="L3793"><span class="lineNum">    3793</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (m_chainman.m_options.signals) {</span></span>
<span id="L3794"><span class="lineNum">    3794</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             m_chainman.m_options.signals-&gt;ActiveTipChange(*Assert(m_chain.Tip()), m_chainman.IsInitialBlockDownload());</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L3795"><span class="lineNum">    3795</span>                 :             :         }</span>
<span id="L3796"><span class="lineNum">    3796</span>                 :             :     }</span>
<span id="L3797"><span class="lineNum">    3797</span>                 :             :     return true;</span>
<span id="L3798"><span class="lineNum">    3798</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 : }</span></span>
<span id="L3799"><span class="lineNum">    3799</span>                 :             : </span>
<span id="L3800"><span class="lineNum">    3800</span>                 :<span class="tlaGNC">       30839 : void Chainstate::SetBlockFailureFlags(CBlockIndex* invalid_block)</span></span>
<span id="L3801"><span class="lineNum">    3801</span>                 :             : {</span>
<span id="L3802"><span class="lineNum">    3802</span>                 :<span class="tlaGNC">       30839 :     AssertLockHeld(cs_main);</span></span>
<span id="L3803"><span class="lineNum">    3803</span>                 :             : </span>
<span id="L3804"><span class="lineNum">    3804</span>   [<span class="tlaGBC" title="Branch 0 was taken 1718628 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 30839 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 1687789 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 30839 times"> + </span>]:<span class="tlaGNC">     1749467 :     for (auto&amp; [_, block_index] : m_blockman.m_block_index) {</span></span>
<span id="L3805"><span class="lineNum">    3805</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 1687789 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 1687789 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 30839 times"> + </span>]:<span class="tlaGNC">     1718628 :         if (invalid_block != &amp;block_index &amp;&amp; block_index.GetAncestor(invalid_block-&gt;nHeight) == invalid_block) {</span></span>
<span id="L3806"><span class="lineNum">    3806</span>                 :<span class="tlaUNC">           0 :             block_index.nStatus = (block_index.nStatus &amp; ~BLOCK_FAILED_VALID) | BLOCK_FAILED_CHILD;</span></span>
<span id="L3807"><span class="lineNum">    3807</span>                 :<span class="tlaUNC">           0 :             m_blockman.m_dirty_blockindex.insert(&amp;block_index);</span></span>
<span id="L3808"><span class="lineNum">    3808</span>                 :             :         }</span>
<span id="L3809"><span class="lineNum">    3809</span>                 :             :     }</span>
<span id="L3810"><span class="lineNum">    3810</span>                 :<span class="tlaGNC">       30839 : }</span></span>
<span id="L3811"><span class="lineNum">    3811</span>                 :             : </span>
<span id="L3812"><span class="lineNum">    3812</span>                 :<span class="tlaGNC">          33 : void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {</span></span>
<span id="L3813"><span class="lineNum">    3813</span>                 :<span class="tlaGNC">          33 :     AssertLockHeld(cs_main);</span></span>
<span id="L3814"><span class="lineNum">    3814</span>                 :             : </span>
<span id="L3815"><span class="lineNum">    3815</span>                 :<span class="tlaGNC">          33 :     int nHeight = pindex-&gt;nHeight;</span></span>
<span id="L3816"><span class="lineNum">    3816</span>                 :             : </span>
<span id="L3817"><span class="lineNum">    3817</span>                 :             :     // Remove the invalidity flag from this block and all its descendants and ancestors.</span>
<span id="L3818"><span class="lineNum">    3818</span>   [<span class="tlaGBC" title="Branch 0 was taken 2066 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 33 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 2066 times"> + </span>]:<span class="tlaGNC">        2099 :     for (auto&amp; [_, block_index] : m_blockman.m_block_index) {</span></span>
<span id="L3819"><span class="lineNum">    3819</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">        2066 :         if ((block_index.nStatus &amp; BLOCK_FAILED_MASK) &amp;&amp; (block_index.GetAncestor(nHeight) == pindex || pindex-&gt;GetAncestor(block_index.nHeight) == &amp;block_index)) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaGBC" title="Branch 5 was taken 2066 times"> + </span>]
<span id="L3820"><span class="lineNum">    3820</span>                 :<span class="tlaUNC">           0 :             block_index.nStatus &amp;= ~BLOCK_FAILED_MASK;</span></span>
<span id="L3821"><span class="lineNum">    3821</span>                 :<span class="tlaUNC">           0 :             m_blockman.m_dirty_blockindex.insert(&amp;block_index);</span></span>
<span id="L3822"><span class="lineNum">    3822</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             if (block_index.IsValid(BLOCK_VALID_TRANSACTIONS) &amp;&amp; block_index.HaveNumChainTxs() &amp;&amp; setBlockIndexCandidates.value_comp()(m_chain.Tip(), &amp;block_index)) {</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not executed"> # </span>]
<span id="L3823"><span class="lineNum">    3823</span>                 :<span class="tlaUNC">           0 :                 setBlockIndexCandidates.insert(&amp;block_index);</span></span>
<span id="L3824"><span class="lineNum">    3824</span>                 :             :             }</span>
<span id="L3825"><span class="lineNum">    3825</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (&amp;block_index == m_chainman.m_best_invalid) {</span></span>
<span id="L3826"><span class="lineNum">    3826</span>                 :             :                 // Reset invalid block marker if it was pointing to one of those.</span>
<span id="L3827"><span class="lineNum">    3827</span>                 :<span class="tlaUNC">           0 :                 m_chainman.m_best_invalid = nullptr;</span></span>
<span id="L3828"><span class="lineNum">    3828</span>                 :             :             }</span>
<span id="L3829"><span class="lineNum">    3829</span>                 :             :         }</span>
<span id="L3830"><span class="lineNum">    3830</span>                 :             :     }</span>
<span id="L3831"><span class="lineNum">    3831</span>                 :<span class="tlaGNC">          33 : }</span></span>
<span id="L3832"><span class="lineNum">    3832</span>                 :             : </span>
<span id="L3833"><span class="lineNum">    3833</span>                 :<span class="tlaGNC">      216086 : void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)</span></span>
<span id="L3834"><span class="lineNum">    3834</span>                 :             : {</span>
<span id="L3835"><span class="lineNum">    3835</span>                 :<span class="tlaGNC">      216086 :     AssertLockHeld(cs_main);</span></span>
<span id="L3836"><span class="lineNum">    3836</span>                 :             :     // The block only is a candidate for the most-work-chain if it has the same</span>
<span id="L3837"><span class="lineNum">    3837</span>                 :             :     // or more work than our current tip.</span>
<span id="L3838"><span class="lineNum">    3838</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 216086 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 213126 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      429212 :     if (m_chain.Tip() != nullptr &amp;&amp; setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 213126 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L3839"><span class="lineNum">    3839</span>                 :             :         return;</span>
<span id="L3840"><span class="lineNum">    3840</span>                 :             :     }</span>
<span id="L3841"><span class="lineNum">    3841</span>                 :             : </span>
<span id="L3842"><span class="lineNum">    3842</span>                 :<span class="tlaGNC">      216086 :     bool is_active_chainstate = this == &amp;m_chainman.ActiveChainstate();</span></span>
<span id="L3843"><span class="lineNum">    3843</span>         [<span class="tlaGBC" title="Branch 0 was taken 216086 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      216086 :     if (is_active_chainstate) {</span></span>
<span id="L3844"><span class="lineNum">    3844</span>                 :             :         // The active chainstate should always add entries that have more</span>
<span id="L3845"><span class="lineNum">    3845</span>                 :             :         // work than the tip.</span>
<span id="L3846"><span class="lineNum">    3846</span>                 :<span class="tlaGNC">      216086 :         setBlockIndexCandidates.insert(pindex);</span></span>
<span id="L3847"><span class="lineNum">    3847</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     } else if (!m_disabled) {</span></span>
<span id="L3848"><span class="lineNum">    3848</span>                 :             :         // For the background chainstate, we only consider connecting blocks</span>
<span id="L3849"><span class="lineNum">    3849</span>                 :             :         // towards the snapshot base (which can't be nullptr or else we'll</span>
<span id="L3850"><span class="lineNum">    3850</span>                 :             :         // never make progress).</span>
<span id="L3851"><span class="lineNum">    3851</span>                 :<span class="tlaUNC">           0 :         const CBlockIndex* snapshot_base{Assert(m_chainman.GetSnapshotBaseBlock())};</span></span>
<span id="L3852"><span class="lineNum">    3852</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (snapshot_base-&gt;GetAncestor(pindex-&gt;nHeight) == pindex) {</span></span>
<span id="L3853"><span class="lineNum">    3853</span>                 :<span class="tlaUNC">           0 :             setBlockIndexCandidates.insert(pindex);</span></span>
<span id="L3854"><span class="lineNum">    3854</span>                 :             :         }</span>
<span id="L3855"><span class="lineNum">    3855</span>                 :             :     }</span>
<span id="L3856"><span class="lineNum">    3856</span>                 :             : }</span>
<span id="L3857"><span class="lineNum">    3857</span>                 :             : </span>
<span id="L3858"><span class="lineNum">    3858</span>                 :             : /** Mark a block as having its data received and checked (up to BLOCK_VALID_TRANSACTIONS). */</span>
<span id="L3859"><span class="lineNum">    3859</span>                 :<span class="tlaGNC">      216086 : void ChainstateManager::ReceivedBlockTransactions(const CBlock&amp; block, CBlockIndex* pindexNew, const FlatFilePos&amp; pos)</span></span>
<span id="L3860"><span class="lineNum">    3860</span>                 :             : {</span>
<span id="L3861"><span class="lineNum">    3861</span>                 :<span class="tlaGNC">      216086 :     AssertLockHeld(cs_main);</span></span>
<span id="L3862"><span class="lineNum">    3862</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 216086 times"> + </span>]:<span class="tlaGNC">      216086 :     pindexNew-&gt;nTx = block.vtx.size();</span></span>
<span id="L3863"><span class="lineNum">    3863</span>                 :             :     // Typically m_chain_tx_count will be 0 at this point, but it can be nonzero if this</span>
<span id="L3864"><span class="lineNum">    3864</span>                 :             :     // is a pruned block which is being downloaded again, or if this is an</span>
<span id="L3865"><span class="lineNum">    3865</span>                 :             :     // assumeutxo snapshot block which has a hardcoded m_chain_tx_count value from the</span>
<span id="L3866"><span class="lineNum">    3866</span>                 :             :     // snapshot metadata. If the pindex is not the snapshot block and the</span>
<span id="L3867"><span class="lineNum">    3867</span>                 :             :     // m_chain_tx_count value is not zero, assert that value is actually correct.</span>
<span id="L3868"><span class="lineNum">    3868</span>                 :<span class="tlaGNC">      213126 :     auto prev_tx_sum = [](CBlockIndex&amp; block) { return block.nTx + (block.pprev ? block.pprev-&gt;m_chain_tx_count : 0); };</span></span>
<span id="L3869"><span class="lineNum">    3869</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 216086 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      216086 :     if (!Assume(pindexNew-&gt;m_chain_tx_count == 0 || pindexNew-&gt;m_chain_tx_count == prev_tx_sum(*pindexNew) ||</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaUNC" title="Branch 6 was not taken"> - </span><span class="tlaUNC" title="Branch 7 was not taken"> - </span><span class="tlaUNC" title="Branch 8 was not taken"> - </span> 
<span class="lineNum">        </span>             <span class="tlaGBC" title="Branch 9 was taken 216086 times"> + </span>]
<span id="L3870"><span class="lineNum">    3870</span>                 :             :                 pindexNew == GetSnapshotBaseBlock())) {</span>
<span id="L3871"><span class="lineNum">    3871</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LogWarning(&quot;Internal bug detected: block %d has unexpected m_chain_tx_count %i that should be %i (%s %s). Please report this issue here: %s\n&quot;,</span></span>
<span id="L3872"><span class="lineNum">    3872</span>                 :             :             pindexNew-&gt;nHeight, pindexNew-&gt;m_chain_tx_count, prev_tx_sum(*pindexNew), CLIENT_NAME, FormatFullVersion(), CLIENT_BUGREPORT);</span>
<span id="L3873"><span class="lineNum">    3873</span>                 :<span class="tlaUNC">           0 :         pindexNew-&gt;m_chain_tx_count = 0;</span></span>
<span id="L3874"><span class="lineNum">    3874</span>                 :             :     }</span>
<span id="L3875"><span class="lineNum">    3875</span>                 :<span class="tlaGNC">      216086 :     pindexNew-&gt;nFile = pos.nFile;</span></span>
<span id="L3876"><span class="lineNum">    3876</span>                 :<span class="tlaGNC">      216086 :     pindexNew-&gt;nDataPos = pos.nPos;</span></span>
<span id="L3877"><span class="lineNum">    3877</span>                 :<span class="tlaGNC">      216086 :     pindexNew-&gt;nUndoPos = 0;</span></span>
<span id="L3878"><span class="lineNum">    3878</span>                 :<span class="tlaGNC">      216086 :     pindexNew-&gt;nStatus |= BLOCK_HAVE_DATA;</span></span>
<span id="L3879"><span class="lineNum">    3879</span>         [<span class="tlaGBC" title="Branch 0 was taken 216085 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 1 time"> + </span>]:<span class="tlaGNC">      216086 :     if (DeploymentActiveAt(*pindexNew, *this, Consensus::DEPLOYMENT_SEGWIT)) {</span></span>
<span id="L3880"><span class="lineNum">    3880</span>                 :<span class="tlaGNC">      216085 :         pindexNew-&gt;nStatus |= BLOCK_OPT_WITNESS;</span></span>
<span id="L3881"><span class="lineNum">    3881</span>                 :             :     }</span>
<span id="L3882"><span class="lineNum">    3882</span>                 :<span class="tlaGNC">      216086 :     pindexNew-&gt;RaiseValidity(BLOCK_VALID_TRANSACTIONS);</span></span>
<span id="L3883"><span class="lineNum">    3883</span>                 :<span class="tlaGNC">      216086 :     m_blockman.m_dirty_blockindex.insert(pindexNew);</span></span>
<span id="L3884"><span class="lineNum">    3884</span>                 :             : </span>
<span id="L3885"><span class="lineNum">    3885</span>   [<span class="tlaGBC" title="Branch 0 was taken 213126 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 2960 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 213126 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      216086 :     if (pindexNew-&gt;pprev == nullptr || pindexNew-&gt;pprev-&gt;HaveNumChainTxs()) {</span></span>
<span id="L3886"><span class="lineNum">    3886</span>                 :             :         // If pindexNew is the genesis block or all parents are BLOCK_VALID_TRANSACTIONS.</span>
<span id="L3887"><span class="lineNum">    3887</span>                 :<span class="tlaGNC">      216086 :         std::deque&lt;CBlockIndex*&gt; queue;</span></span>
<span id="L3888"><span class="lineNum">    3888</span>         [<span class="tlaGBC" title="Branch 0 was taken 216086 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      216086 :         queue.push_back(pindexNew);</span></span>
<span id="L3889"><span class="lineNum">    3889</span>                 :             : </span>
<span id="L3890"><span class="lineNum">    3890</span>                 :             :         // Recursively process any descendant blocks that now may be eligible to be connected.</span>
<span id="L3891"><span class="lineNum">    3891</span>         [<span class="tlaGBC" title="Branch 0 was taken 216086 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 216086 times"> + </span>]:<span class="tlaGNC">      432172 :         while (!queue.empty()) {</span></span>
<span id="L3892"><span class="lineNum">    3892</span>                 :<span class="tlaGNC">      216086 :             CBlockIndex *pindex = queue.front();</span></span>
<span id="L3893"><span class="lineNum">    3893</span>                 :<span class="tlaGNC">      216086 :             queue.pop_front();</span></span>
<span id="L3894"><span class="lineNum">    3894</span>                 :             :             // Before setting m_chain_tx_count, assert that it is 0 or already set to</span>
<span id="L3895"><span class="lineNum">    3895</span>                 :             :             // the correct value. This assert will fail after receiving the</span>
<span id="L3896"><span class="lineNum">    3896</span>                 :             :             // assumeutxo snapshot block if assumeutxo snapshot metadata has an</span>
<span id="L3897"><span class="lineNum">    3897</span>                 :             :             // incorrect hardcoded AssumeutxoData::m_chain_tx_count value.</span>
<span id="L3898"><span class="lineNum">    3898</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 216086 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      216086 :             if (!Assume(pindex-&gt;m_chain_tx_count == 0 || pindex-&gt;m_chain_tx_count == prev_tx_sum(*pindex))) {</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaGBC" title="Branch 6 was taken 216086 times"> + </span><span class="tlaUNC" title="Branch 7 was not taken"> - </span><span class="tlaUNC" title="Branch 8 was not taken"> - </span> 
<span class="lineNum">        </span>             <span class="tlaGBC" title="Branch 9 was taken 216086 times"> + </span>]
<span id="L3899"><span class="lineNum">    3899</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                 LogWarning(&quot;Internal bug detected: block %d has unexpected m_chain_tx_count %i that should be %i (%s %s). Please report this issue here: %s\n&quot;,</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L3900"><span class="lineNum">    3900</span>                 :             :                    pindex-&gt;nHeight, pindex-&gt;m_chain_tx_count, prev_tx_sum(*pindex), CLIENT_NAME, FormatFullVersion(), CLIENT_BUGREPORT);</span>
<span id="L3901"><span class="lineNum">    3901</span>                 :             :             }</span>
<span id="L3902"><span class="lineNum">    3902</span>         [<span class="tlaGBC" title="Branch 0 was taken 213126 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 2960 times"> + </span>]:<span class="tlaGNC">      216086 :             pindex-&gt;m_chain_tx_count = prev_tx_sum(*pindex);</span></span>
<span id="L3903"><span class="lineNum">    3903</span>                 :<span class="tlaGNC">      216086 :             pindex-&gt;nSequenceId = nBlockSequenceId++;</span></span>
<span id="L3904"><span class="lineNum">    3904</span>   [<span class="tlaGBC" title="Branch 0 was taken 216086 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 216086 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 216086 times"> + </span>]:<span class="tlaGNC">      432172 :             for (Chainstate *c : GetAll()) {</span></span>
<span id="L3905"><span class="lineNum">    3905</span>         [<span class="tlaGBC" title="Branch 0 was taken 216086 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      216086 :                 c-&gt;TryAddBlockIndexCandidate(pindex);</span></span>
<span id="L3906"><span class="lineNum">    3906</span>                 :<span class="tlaUNC">           0 :             }</span></span>
<span id="L3907"><span class="lineNum">    3907</span>                 :<span class="tlaGNC">      216086 :             std::pair&lt;std::multimap&lt;CBlockIndex*, CBlockIndex*&gt;::iterator, std::multimap&lt;CBlockIndex*, CBlockIndex*&gt;::iterator&gt; range = m_blockman.m_blocks_unlinked.equal_range(pindex);</span></span>
<span id="L3908"><span class="lineNum">    3908</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 216086 times"> + </span>]:<span class="tlaGNC">      216086 :             while (range.first != range.second) {</span></span>
<span id="L3909"><span class="lineNum">    3909</span>                 :<span class="tlaUNC">           0 :                 std::multimap&lt;CBlockIndex*, CBlockIndex*&gt;::iterator it = range.first;</span></span>
<span id="L3910"><span class="lineNum">    3910</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 queue.push_back(it-&gt;second);</span></span>
<span id="L3911"><span class="lineNum">    3911</span>                 :<span class="tlaUNC">           0 :                 range.first++;</span></span>
<span id="L3912"><span class="lineNum">    3912</span>                 :<span class="tlaUNC">           0 :                 m_blockman.m_blocks_unlinked.erase(it);</span></span>
<span id="L3913"><span class="lineNum">    3913</span>                 :             :             }</span>
<span id="L3914"><span class="lineNum">    3914</span>                 :             :         }</span>
<span id="L3915"><span class="lineNum">    3915</span>                 :<span class="tlaGNC">      216086 :     } else {</span></span>
<span id="L3916"><span class="lineNum">    3916</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (pindexNew-&gt;pprev &amp;&amp; pindexNew-&gt;pprev-&gt;IsValid(BLOCK_VALID_TREE)) {</span></span>
<span id="L3917"><span class="lineNum">    3917</span>                 :<span class="tlaUNC">           0 :             m_blockman.m_blocks_unlinked.insert(std::make_pair(pindexNew-&gt;pprev, pindexNew));</span></span>
<span id="L3918"><span class="lineNum">    3918</span>                 :             :         }</span>
<span id="L3919"><span class="lineNum">    3919</span>                 :             :     }</span>
<span id="L3920"><span class="lineNum">    3920</span>                 :<span class="tlaGNC">      216086 : }</span></span>
<span id="L3921"><span class="lineNum">    3921</span>                 :             : </span>
<span id="L3922"><span class="lineNum">    3922</span>                 :<span class="tlaGNC">     1260460 : static bool CheckBlockHeader(const CBlockHeader&amp; block, BlockValidationState&amp; state, const Consensus::Params&amp; consensusParams, bool fCheckPOW = true)</span></span>
<span id="L3923"><span class="lineNum">    3923</span>                 :             : {</span>
<span id="L3924"><span class="lineNum">    3924</span>                 :             :     // Check proof of work matches claimed amount</span>
<span id="L3925"><span class="lineNum">    3925</span>   [<span class="tlaGBC" title="Branch 0 was taken 760196 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 500264 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 27407 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 732789 times"> + </span>]:<span class="tlaGNC">     1260460 :     if (fCheckPOW &amp;&amp; !CheckProofOfWork(block.GetHash(), block.nBits, consensusParams))</span></span>
<span id="L3926"><span class="lineNum">    3926</span>   [<span class="tlaGBC" title="Branch 0 was taken 27407 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 27407 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">       27407 :         return state.Invalid(BlockValidationResult::BLOCK_INVALID_HEADER, &quot;high-hash&quot;, &quot;proof of work failed&quot;);</span></span>
<span id="L3927"><span class="lineNum">    3927</span>                 :             : </span>
<span id="L3928"><span class="lineNum">    3928</span>                 :             :     return true;</span>
<span id="L3929"><span class="lineNum">    3929</span>                 :             : }</span>
<span id="L3930"><span class="lineNum">    3930</span>                 :             : </span>
<span id="L3931"><span class="lineNum">    3931</span>                 :<span class="tlaGNC">      298966 : static bool CheckMerkleRoot(const CBlock&amp; block, BlockValidationState&amp; state)</span></span>
<span id="L3932"><span class="lineNum">    3932</span>                 :             : {</span>
<span id="L3933"><span class="lineNum">    3933</span>         [<span class="tlaGBC" title="Branch 0 was taken 287346 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 11620 times"> + </span>]:<span class="tlaGNC">      298966 :     if (block.m_checked_merkle_root) return true;</span></span>
<span id="L3934"><span class="lineNum">    3934</span>                 :             : </span>
<span id="L3935"><span class="lineNum">    3935</span>                 :<span class="tlaGNC">      287346 :     bool mutated;</span></span>
<span id="L3936"><span class="lineNum">    3936</span>                 :<span class="tlaGNC">      287346 :     uint256 merkle_root = BlockMerkleRoot(block, &amp;mutated);</span></span>
<span id="L3937"><span class="lineNum">    3937</span>         [<span class="tlaGBC" title="Branch 0 was taken 22427 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 264919 times"> + </span>]:<span class="tlaGNC">      287346 :     if (block.hashMerkleRoot != merkle_root) {</span></span>
<span id="L3938"><span class="lineNum">    3938</span>         [<span class="tlaGBC" title="Branch 0 was taken 22427 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       22427 :         return state.Invalid(</span></span>
<span id="L3939"><span class="lineNum">    3939</span>                 :             :             /*result=*/BlockValidationResult::BLOCK_MUTATED,</span>
<span id="L3940"><span class="lineNum">    3940</span>         [<span class="tlaGBC" title="Branch 0 was taken 22427 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       44854 :             /*reject_reason=*/&quot;bad-txnmrklroot&quot;,</span></span>
<span id="L3941"><span class="lineNum">    3941</span>                 :<span class="tlaGNC">       44854 :             /*debug_message=*/&quot;hashMerkleRoot mismatch&quot;);</span></span>
<span id="L3942"><span class="lineNum">    3942</span>                 :             :     }</span>
<span id="L3943"><span class="lineNum">    3943</span>                 :             : </span>
<span id="L3944"><span class="lineNum">    3944</span>                 :             :     // Check for merkle tree malleability (CVE-2012-2459): repeating sequences</span>
<span id="L3945"><span class="lineNum">    3945</span>                 :             :     // of transactions in a block without affecting the merkle root of a block,</span>
<span id="L3946"><span class="lineNum">    3946</span>                 :             :     // while still invalidating it.</span>
<span id="L3947"><span class="lineNum">    3947</span>         [<span class="tlaGBC" title="Branch 0 was taken 4904 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 260015 times"> + </span>]:<span class="tlaGNC">      264919 :     if (mutated) {</span></span>
<span id="L3948"><span class="lineNum">    3948</span>         [<span class="tlaGBC" title="Branch 0 was taken 4904 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        4904 :         return state.Invalid(</span></span>
<span id="L3949"><span class="lineNum">    3949</span>                 :             :             /*result=*/BlockValidationResult::BLOCK_MUTATED,</span>
<span id="L3950"><span class="lineNum">    3950</span>         [<span class="tlaGBC" title="Branch 0 was taken 4904 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        9808 :             /*reject_reason=*/&quot;bad-txns-duplicate&quot;,</span></span>
<span id="L3951"><span class="lineNum">    3951</span>                 :<span class="tlaGNC">        9808 :             /*debug_message=*/&quot;duplicate transaction&quot;);</span></span>
<span id="L3952"><span class="lineNum">    3952</span>                 :             :     }</span>
<span id="L3953"><span class="lineNum">    3953</span>                 :             : </span>
<span id="L3954"><span class="lineNum">    3954</span>                 :<span class="tlaGNC">      260015 :     block.m_checked_merkle_root = true;</span></span>
<span id="L3955"><span class="lineNum">    3955</span>                 :<span class="tlaGNC">      260015 :     return true;</span></span>
<span id="L3956"><span class="lineNum">    3956</span>                 :             : }</span>
<span id="L3957"><span class="lineNum">    3957</span>                 :             : </span>
<span id="L3958"><span class="lineNum">    3958</span>                 :             : /** CheckWitnessMalleation performs checks for block malleation with regard to</span>
<span id="L3959"><span class="lineNum">    3959</span>                 :             :  * its witnesses.</span>
<span id="L3960"><span class="lineNum">    3960</span>                 :             :  *</span>
<span id="L3961"><span class="lineNum">    3961</span>                 :             :  * Note: If the witness commitment is expected (i.e. `expect_witness_commitment</span>
<span id="L3962"><span class="lineNum">    3962</span>                 :             :  * = true`), then the block is required to have at least one transaction and the</span>
<span id="L3963"><span class="lineNum">    3963</span>                 :             :  * first transaction needs to have at least one input. */</span>
<span id="L3964"><span class="lineNum">    3964</span>                 :<span class="tlaGNC">      472978 : static bool CheckWitnessMalleation(const CBlock&amp; block, bool expect_witness_commitment, BlockValidationState&amp; state)</span></span>
<span id="L3965"><span class="lineNum">    3965</span>                 :             : {</span>
<span id="L3966"><span class="lineNum">    3966</span>         [<span class="tlaGBC" title="Branch 0 was taken 462255 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 10723 times"> + </span>]:<span class="tlaGNC">      472978 :     if (expect_witness_commitment) {</span></span>
<span id="L3967"><span class="lineNum">    3967</span>         [<span class="tlaGBC" title="Branch 0 was taken 249529 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 212726 times"> + </span>]:<span class="tlaGNC">      462255 :         if (block.m_checked_witness_commitment) return true;</span></span>
<span id="L3968"><span class="lineNum">    3968</span>                 :             : </span>
<span id="L3969"><span class="lineNum">    3969</span>                 :<span class="tlaGNC">      249529 :         int commitpos = GetWitnessCommitmentIndex(block);</span></span>
<span id="L3970"><span class="lineNum">    3970</span>         [<span class="tlaGBC" title="Branch 0 was taken 249093 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 436 times"> + </span>]:<span class="tlaGNC">      249529 :         if (commitpos != NO_WITNESS_COMMITMENT) {</span></span>
<span id="L3971"><span class="lineNum">    3971</span>   [<span class="tlaGBC" title="Branch 0 was taken 249093 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 249093 times"> + </span>]:<span class="tlaGNC">      249093 :             assert(!block.vtx.empty() &amp;&amp; !block.vtx[0]-&gt;vin.empty());</span></span>
<span id="L3972"><span class="lineNum">    3972</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 249093 times"> + </span>]:<span class="tlaGNC">      249093 :             const auto&amp; witness_stack{block.vtx[0]-&gt;vin[0].scriptWitness.stack};</span></span>
<span id="L3973"><span class="lineNum">    3973</span>                 :             : </span>
<span id="L3974"><span class="lineNum">    3974</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 249093 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 249091 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 2 times"> + </span> :<span class="tlaGNC">      249093 :             if (witness_stack.size() != 1 || witness_stack[0].size() != 32) {</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaGBC" title="Branch 5 was taken 249091 times"> + </span><span class="tlaGBC" title="Branch 6 was taken 3 times"> + </span><span class="tlaGBC" title="Branch 7 was taken 249088 times"> + </span>]
<span id="L3975"><span class="lineNum">    3975</span>         [<span class="tlaGBC" title="Branch 0 was taken 5 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">           5 :                 return state.Invalid(</span></span>
<span id="L3976"><span class="lineNum">    3976</span>                 :             :                     /*result=*/BlockValidationResult::BLOCK_MUTATED,</span>
<span id="L3977"><span class="lineNum">    3977</span>         [<span class="tlaGBC" title="Branch 0 was taken 5 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">          10 :                     /*reject_reason=*/&quot;bad-witness-nonce-size&quot;,</span></span>
<span id="L3978"><span class="lineNum">    3978</span>                 :<span class="tlaGNC">          10 :                     /*debug_message=*/strprintf(&quot;%s : invalid witness reserved value size&quot;, __func__));</span></span>
<span id="L3979"><span class="lineNum">    3979</span>                 :             :             }</span>
<span id="L3980"><span class="lineNum">    3980</span>                 :             : </span>
<span id="L3981"><span class="lineNum">    3981</span>                 :             :             // The malleation check is ignored; as the transaction tree itself</span>
<span id="L3982"><span class="lineNum">    3982</span>                 :             :             // already does not permit it, it is impossible to trigger in the</span>
<span id="L3983"><span class="lineNum">    3983</span>                 :             :             // witness tree.</span>
<span id="L3984"><span class="lineNum">    3984</span>                 :<span class="tlaGNC">      249088 :             uint256 hash_witness = BlockWitnessMerkleRoot(block, /*mutated=*/nullptr);</span></span>
<span id="L3985"><span class="lineNum">    3985</span>                 :             : </span>
<span id="L3986"><span class="lineNum">    3986</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 249088 times"> + </span>]:<span class="tlaGNC">      249088 :             CHash256().Write(hash_witness).Write(witness_stack[0]).Finalize(hash_witness);</span></span>
<span id="L3987"><span class="lineNum">    3987</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 249088 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 5 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 249083 times"> + </span>]:<span class="tlaGNC">      498176 :             if (memcmp(hash_witness.begin(), &amp;block.vtx[0]-&gt;vout[commitpos].scriptPubKey[6], 32)) {</span></span>
<span id="L3988"><span class="lineNum">    3988</span>         [<span class="tlaGBC" title="Branch 0 was taken 5 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">           5 :                 return state.Invalid(</span></span>
<span id="L3989"><span class="lineNum">    3989</span>                 :             :                     /*result=*/BlockValidationResult::BLOCK_MUTATED,</span>
<span id="L3990"><span class="lineNum">    3990</span>         [<span class="tlaGBC" title="Branch 0 was taken 5 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">          10 :                     /*reject_reason=*/&quot;bad-witness-merkle-match&quot;,</span></span>
<span id="L3991"><span class="lineNum">    3991</span>                 :<span class="tlaGNC">          10 :                     /*debug_message=*/strprintf(&quot;%s : witness merkle commitment mismatch&quot;, __func__));</span></span>
<span id="L3992"><span class="lineNum">    3992</span>                 :             :             }</span>
<span id="L3993"><span class="lineNum">    3993</span>                 :             : </span>
<span id="L3994"><span class="lineNum">    3994</span>                 :<span class="tlaGNC">      249083 :             block.m_checked_witness_commitment = true;</span></span>
<span id="L3995"><span class="lineNum">    3995</span>                 :<span class="tlaGNC">      249083 :             return true;</span></span>
<span id="L3996"><span class="lineNum">    3996</span>                 :             :         }</span>
<span id="L3997"><span class="lineNum">    3997</span>                 :             :     }</span>
<span id="L3998"><span class="lineNum">    3998</span>                 :             : </span>
<span id="L3999"><span class="lineNum">    3999</span>                 :             :     // No witness data is allowed in blocks that don't commit to witness data, as this would otherwise leave room for spam</span>
<span id="L4000"><span class="lineNum">    4000</span>         [<span class="tlaGBC" title="Branch 0 was taken 11159 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 11150 times"> + </span>]:<span class="tlaGNC">       22309 :     for (const auto&amp; tx : block.vtx) {</span></span>
<span id="L4001"><span class="lineNum">    4001</span>         [<span class="tlaGBC" title="Branch 0 was taken 9 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 11150 times"> + </span>]:<span class="tlaGNC">       11159 :         if (tx-&gt;HasWitness()) {</span></span>
<span id="L4002"><span class="lineNum">    4002</span>         [<span class="tlaGBC" title="Branch 0 was taken 9 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">           9 :             return state.Invalid(</span></span>
<span id="L4003"><span class="lineNum">    4003</span>                 :             :                 /*result=*/BlockValidationResult::BLOCK_MUTATED,</span>
<span id="L4004"><span class="lineNum">    4004</span>         [<span class="tlaGBC" title="Branch 0 was taken 9 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">          18 :                 /*reject_reason=*/&quot;unexpected-witness&quot;,</span></span>
<span id="L4005"><span class="lineNum">    4005</span>                 :<span class="tlaGNC">          18 :                 /*debug_message=*/strprintf(&quot;%s : unexpected witness data found&quot;, __func__));</span></span>
<span id="L4006"><span class="lineNum">    4006</span>                 :             :         }</span>
<span id="L4007"><span class="lineNum">    4007</span>                 :             :     }</span>
<span id="L4008"><span class="lineNum">    4008</span>                 :             : </span>
<span id="L4009"><span class="lineNum">    4009</span>                 :             :     return true;</span>
<span id="L4010"><span class="lineNum">    4010</span>                 :             : }</span>
<span id="L4011"><span class="lineNum">    4011</span>                 :             : </span>
<span id="L4012"><span class="lineNum">    4012</span>                 :<span class="tlaGNC">     1214495 : bool CheckBlock(const CBlock&amp; block, BlockValidationState&amp; state, const Consensus::Params&amp; consensusParams, bool fCheckPOW, bool fCheckMerkleRoot)</span></span>
<span id="L4013"><span class="lineNum">    4013</span>                 :             : {</span>
<span id="L4014"><span class="lineNum">    4014</span>                 :             :     // These are checks that are independent of context.</span>
<span id="L4015"><span class="lineNum">    4015</span>                 :             : </span>
<span id="L4016"><span class="lineNum">    4016</span>         [<span class="tlaGBC" title="Branch 0 was taken 788216 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 426279 times"> + </span>]:<span class="tlaGNC">     1214495 :     if (block.fChecked)</span></span>
<span id="L4017"><span class="lineNum">    4017</span>                 :             :         return true;</span>
<span id="L4018"><span class="lineNum">    4018</span>                 :             : </span>
<span id="L4019"><span class="lineNum">    4019</span>                 :             :     // Check that the header is valid (particularly PoW).  This is mostly</span>
<span id="L4020"><span class="lineNum">    4020</span>                 :             :     // redundant with the call in AcceptBlockHeader.</span>
<span id="L4021"><span class="lineNum">    4021</span>         [<span class="tlaGBC" title="Branch 0 was taken 786263 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 1953 times"> + </span>]:<span class="tlaGNC">      788216 :     if (!CheckBlockHeader(block, state, consensusParams, fCheckPOW))</span></span>
<span id="L4022"><span class="lineNum">    4022</span>                 :             :         return false;</span>
<span id="L4023"><span class="lineNum">    4023</span>                 :             : </span>
<span id="L4024"><span class="lineNum">    4024</span>                 :             :     // Signet only: check block solution</span>
<span id="L4025"><span class="lineNum">    4025</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 786263 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      786263 :     if (consensusParams.signet_blocks &amp;&amp; fCheckPOW &amp;&amp; !CheckSignetBlockSolution(block, consensusParams)) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L4026"><span class="lineNum">    4026</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         return state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, &quot;bad-signet-blksig&quot;, &quot;signet block signature validation failure&quot;);</span></span>
<span id="L4027"><span class="lineNum">    4027</span>                 :             :     }</span>
<span id="L4028"><span class="lineNum">    4028</span>                 :             : </span>
<span id="L4029"><span class="lineNum">    4029</span>                 :             :     // Check the merkle root.</span>
<span id="L4030"><span class="lineNum">    4030</span>   [<span class="tlaGBC" title="Branch 0 was taken 286518 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 499745 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 259355 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 27163 times"> + </span>]:<span class="tlaGNC">      786263 :     if (fCheckMerkleRoot &amp;&amp; !CheckMerkleRoot(block, state)) {</span></span>
<span id="L4031"><span class="lineNum">    4031</span>                 :             :         return false;</span>
<span id="L4032"><span class="lineNum">    4032</span>                 :             :     }</span>
<span id="L4033"><span class="lineNum">    4033</span>                 :             : </span>
<span id="L4034"><span class="lineNum">    4034</span>                 :             :     // All potential-corruption validation must be done before we do any</span>
<span id="L4035"><span class="lineNum">    4035</span>                 :             :     // transaction validation, as otherwise we may mark the header as invalid</span>
<span id="L4036"><span class="lineNum">    4036</span>                 :             :     // because we receive the wrong transactions for it.</span>
<span id="L4037"><span class="lineNum">    4037</span>                 :             :     // Note that witness malleability is checked in ContextualCheckBlock, so no</span>
<span id="L4038"><span class="lineNum">    4038</span>                 :             :     // checks that use witness data may be performed here.</span>
<span id="L4039"><span class="lineNum">    4039</span>                 :             : </span>
<span id="L4040"><span class="lineNum">    4040</span>                 :             :     // Size limits</span>
<span id="L4041"><span class="lineNum">    4041</span>   [<span class="tlaGBC" title="Branch 0 was taken 758480 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 620 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 758480 times"> + </span> :<span class="tlaGNC">      759100 :     if (block.vtx.empty() || block.vtx.size() * WITNESS_SCALE_FACTOR &gt; MAX_BLOCK_WEIGHT || ::GetSerializeSize(TX_NO_WITNESS(block)) * WITNESS_SCALE_FACTOR &gt; MAX_BLOCK_WEIGHT)</span></span>
<span class="lineNum">        </span>    <span class="tlaGBC" title="Branch 4 was taken 758480 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaGBC" title="Branch 6 was taken 758470 times"> + </span><span class="tlaGBC" title="Branch 7 was taken 10 times"> + </span>]
<span id="L4042"><span class="lineNum">    4042</span>   [<span class="tlaGBC" title="Branch 0 was taken 630 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 630 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">         630 :         return state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, &quot;bad-blk-length&quot;, &quot;size limits failed&quot;);</span></span>
<span id="L4043"><span class="lineNum">    4043</span>                 :             : </span>
<span id="L4044"><span class="lineNum">    4044</span>                 :             :     // First transaction must be coinbase, the rest must not be</span>
<span id="L4045"><span class="lineNum">    4045</span>   [<span class="tlaGBC" title="Branch 0 was taken 758470 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 6170 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 752300 times"> + </span>]:<span class="tlaGNC">      758470 :     if (block.vtx.empty() || !block.vtx[0]-&gt;IsCoinBase())</span></span>
<span id="L4046"><span class="lineNum">    4046</span>   [<span class="tlaGBC" title="Branch 0 was taken 6170 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 6170 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">        6170 :         return state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, &quot;bad-cb-missing&quot;, &quot;first tx is not coinbase&quot;);</span></span>
<span id="L4047"><span class="lineNum">    4047</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 1032484 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 280210 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 752274 times"> + </span>]:<span class="tlaGNC">     1032484 :     for (unsigned int i = 1; i &lt; block.vtx.size(); i++)</span></span>
<span id="L4048"><span class="lineNum">    4048</span>         [<span class="tlaGBC" title="Branch 0 was taken 26 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 280184 times"> + </span>]:<span class="tlaGNC">      280210 :         if (block.vtx[i]-&gt;IsCoinBase())</span></span>
<span id="L4049"><span class="lineNum">    4049</span>   [<span class="tlaGBC" title="Branch 0 was taken 26 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 26 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">          26 :             return state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, &quot;bad-cb-multiple&quot;, &quot;more than one coinbase&quot;);</span></span>
<span id="L4050"><span class="lineNum">    4050</span>                 :             : </span>
<span id="L4051"><span class="lineNum">    4051</span>                 :             :     // Check transactions</span>
<span id="L4052"><span class="lineNum">    4052</span>                 :             :     // Must check for duplicate inputs (see CVE-2018-17144)</span>
<span id="L4053"><span class="lineNum">    4053</span>         [<span class="tlaGBC" title="Branch 0 was taken 865258 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 751057 times"> + </span>]:<span class="tlaGNC">     1616315 :     for (const auto&amp; tx : block.vtx) {</span></span>
<span id="L4054"><span class="lineNum">    4054</span>         [<span class="tlaGBC" title="Branch 0 was taken 865258 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      865258 :         TxValidationState tx_state;</span></span>
<span id="L4055"><span class="lineNum">    4055</span>   [<span class="tlaGBC" title="Branch 0 was taken 865258 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 1217 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 864041 times"> + </span>]:<span class="tlaGNC">      865258 :         if (!CheckTransaction(*tx, tx_state)) {</span></span>
<span id="L4056"><span class="lineNum">    4056</span>                 :             :             // CheckBlock() does context-free validation checks. The only</span>
<span id="L4057"><span class="lineNum">    4057</span>                 :             :             // possible failures are consensus failures.</span>
<span id="L4058"><span class="lineNum">    4058</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 1217 times"> + </span>]:<span class="tlaGNC">        1217 :             assert(tx_state.GetResult() == TxValidationResult::TX_CONSENSUS);</span></span>
<span id="L4059"><span class="lineNum">    4059</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 1217 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 1217 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">        2434 :             return state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, tx_state.GetRejectReason(),</span></span>
<span id="L4060"><span class="lineNum">    4060</span>   [<span class="tlaGBC" title="Branch 0 was taken 1217 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 1217 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">        2434 :                                  strprintf(&quot;Transaction check failed (tx hash %s) %s&quot;, tx-&gt;GetHash().ToString(), tx_state.GetDebugMessage()));</span></span>
<span id="L4061"><span class="lineNum">    4061</span>                 :             :         }</span>
<span id="L4062"><span class="lineNum">    4062</span>                 :<span class="tlaGNC">      865258 :     }</span></span>
<span id="L4063"><span class="lineNum">    4063</span>                 :             :     // This underestimates the number of sigops, because unlike ConnectBlock it</span>
<span id="L4064"><span class="lineNum">    4064</span>                 :             :     // does not count witness and p2sh sigops.</span>
<span id="L4065"><span class="lineNum">    4065</span>                 :<span class="tlaGNC">      751057 :     unsigned int nSigOps = 0;</span></span>
<span id="L4066"><span class="lineNum">    4066</span>         [<span class="tlaGBC" title="Branch 0 was taken 853284 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 751057 times"> + </span>]:<span class="tlaGNC">     1604341 :     for (const auto&amp; tx : block.vtx)</span></span>
<span id="L4067"><span class="lineNum">    4067</span>                 :             :     {</span>
<span id="L4068"><span class="lineNum">    4068</span>                 :<span class="tlaGNC">      853284 :         nSigOps += GetLegacySigOpCount(*tx);</span></span>
<span id="L4069"><span class="lineNum">    4069</span>                 :             :     }</span>
<span id="L4070"><span class="lineNum">    4070</span>         [<span class="tlaGBC" title="Branch 0 was taken 23 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 751034 times"> + </span>]:<span class="tlaGNC">      751057 :     if (nSigOps * WITNESS_SCALE_FACTOR &gt; MAX_BLOCK_SIGOPS_COST)</span></span>
<span id="L4071"><span class="lineNum">    4071</span>   [<span class="tlaGBC" title="Branch 0 was taken 23 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 23 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">          23 :         return state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, &quot;bad-blk-sigops&quot;, &quot;out-of-bounds SigOpCount&quot;);</span></span>
<span id="L4072"><span class="lineNum">    4072</span>                 :             : </span>
<span id="L4073"><span class="lineNum">    4073</span>         [<span class="tlaGBC" title="Branch 0 was taken 252623 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 498411 times"> + </span>]:<span class="tlaGNC">      751034 :     if (fCheckPOW &amp;&amp; fCheckMerkleRoot)</span></span>
<span id="L4074"><span class="lineNum">    4074</span>                 :<span class="tlaGNC">      252623 :         block.fChecked = true;</span></span>
<span id="L4075"><span class="lineNum">    4075</span>                 :             : </span>
<span id="L4076"><span class="lineNum">    4076</span>                 :             :     return true;</span>
<span id="L4077"><span class="lineNum">    4077</span>                 :             : }</span>
<span id="L4078"><span class="lineNum">    4078</span>                 :             : </span>
<span id="L4079"><span class="lineNum">    4079</span>                 :<span class="tlaGNC">      409048 : void ChainstateManager::UpdateUncommittedBlockStructures(CBlock&amp; block, const CBlockIndex* pindexPrev) const</span></span>
<span id="L4080"><span class="lineNum">    4080</span>                 :             : {</span>
<span id="L4081"><span class="lineNum">    4081</span>                 :<span class="tlaGNC">      409048 :     int commitpos = GetWitnessCommitmentIndex(block);</span></span>
<span id="L4082"><span class="lineNum">    4082</span>   [<span class="tlaGBC" title="Branch 0 was taken 9 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 409039 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 9 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      409048 :     static const std::vector&lt;unsigned char&gt; nonce(32, 0x00);</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 9 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L4083"><span class="lineNum">    4083</span>   [<span class="tlaGBC" title="Branch 0 was taken 409001 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 47 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 409001 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      409048 :     if (commitpos != NO_WITNESS_COMMITMENT &amp;&amp; DeploymentActiveAfter(pindexPrev, *this, Consensus::DEPLOYMENT_SEGWIT) &amp;&amp; !block.vtx[0]-&gt;HasWitness()) {</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 250216 times"> + </span><span class="tlaGBC" title="Branch 5 was taken 158785 times"> + </span>]
<span id="L4084"><span class="lineNum">    4084</span>                 :<span class="tlaGNC">      250216 :         CMutableTransaction tx(*block.vtx[0]);</span></span>
<span id="L4085"><span class="lineNum">    4085</span>         [<span class="tlaGBC" title="Branch 0 was taken 250216 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      250216 :         tx.vin[0].scriptWitness.stack.resize(1);</span></span>
<span id="L4086"><span class="lineNum">    4086</span>         [<span class="tlaGBC" title="Branch 0 was taken 250216 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      250216 :         tx.vin[0].scriptWitness.stack[0] = nonce;</span></span>
<span id="L4087"><span class="lineNum">    4087</span>   [<span class="tlaGBC" title="Branch 0 was taken 250216 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 250216 times"> + </span>]:<span class="tlaGNC">      500432 :         block.vtx[0] = MakeTransactionRef(std::move(tx));</span></span>
<span id="L4088"><span class="lineNum">    4088</span>                 :<span class="tlaGNC">      250216 :     }</span></span>
<span id="L4089"><span class="lineNum">    4089</span>                 :<span class="tlaGNC">      409048 : }</span></span>
<span id="L4090"><span class="lineNum">    4090</span>                 :             : </span>
<span id="L4091"><span class="lineNum">    4091</span>                 :<span class="tlaGNC">      409001 : std::vector&lt;unsigned char&gt; ChainstateManager::GenerateCoinbaseCommitment(CBlock&amp; block, const CBlockIndex* pindexPrev) const</span></span>
<span id="L4092"><span class="lineNum">    4092</span>                 :             : {</span>
<span id="L4093"><span class="lineNum">    4093</span>                 :<span class="tlaGNC">      409001 :     std::vector&lt;unsigned char&gt; commitment;</span></span>
<span id="L4094"><span class="lineNum">    4094</span>                 :<span class="tlaGNC">      409001 :     int commitpos = GetWitnessCommitmentIndex(block);</span></span>
<span id="L4095"><span class="lineNum">    4095</span>         [<span class="tlaGBC" title="Branch 0 was taken 409001 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      409001 :     std::vector&lt;unsigned char&gt; ret(32, 0x00);</span></span>
<span id="L4096"><span class="lineNum">    4096</span>         [<span class="tlaGBC" title="Branch 0 was taken 405905 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 3096 times"> + </span>]:<span class="tlaGNC">      409001 :     if (commitpos == NO_WITNESS_COMMITMENT) {</span></span>
<span id="L4097"><span class="lineNum">    4097</span>         [<span class="tlaGBC" title="Branch 0 was taken 405905 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      405905 :         uint256 witnessroot = BlockWitnessMerkleRoot(block, nullptr);</span></span>
<span id="L4098"><span class="lineNum">    4098</span>   [<span class="tlaGBC" title="Branch 0 was taken 405905 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 405905 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      405905 :         CHash256().Write(witnessroot).Write(ret).Finalize(witnessroot);</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaGBC" title="Branch 5 was taken 405905 times"> + </span><span class="tlaGBC" title="Branch 6 was taken 405905 times"> + </span><span class="tlaUNC" title="Branch 7 was not taken"> - </span><span class="tlaGBC" title="Branch 8 was taken 405905 times"> + </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not taken"> - </span>]
<span id="L4099"><span class="lineNum">    4099</span>                 :<span class="tlaGNC">      405905 :         CTxOut out;</span></span>
<span id="L4100"><span class="lineNum">    4100</span>                 :<span class="tlaGNC">      405905 :         out.nValue = 0;</span></span>
<span id="L4101"><span class="lineNum">    4101</span>                 :<span class="tlaGNC">      405905 :         out.scriptPubKey.resize(MINIMUM_WITNESS_COMMITMENT);</span></span>
<span id="L4102"><span class="lineNum">    4102</span>         [<span class="tlaGBC" title="Branch 0 was taken 405905 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      405905 :         out.scriptPubKey[0] = OP_RETURN;</span></span>
<span id="L4103"><span class="lineNum">    4103</span>         [<span class="tlaGBC" title="Branch 0 was taken 405905 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      405905 :         out.scriptPubKey[1] = 0x24;</span></span>
<span id="L4104"><span class="lineNum">    4104</span>         [<span class="tlaGBC" title="Branch 0 was taken 405905 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      405905 :         out.scriptPubKey[2] = 0xaa;</span></span>
<span id="L4105"><span class="lineNum">    4105</span>         [<span class="tlaGBC" title="Branch 0 was taken 405905 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      405905 :         out.scriptPubKey[3] = 0x21;</span></span>
<span id="L4106"><span class="lineNum">    4106</span>         [<span class="tlaGBC" title="Branch 0 was taken 405905 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      405905 :         out.scriptPubKey[4] = 0xa9;</span></span>
<span id="L4107"><span class="lineNum">    4107</span>         [<span class="tlaGBC" title="Branch 0 was taken 405905 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      405905 :         out.scriptPubKey[5] = 0xed;</span></span>
<span id="L4108"><span class="lineNum">    4108</span>   [<span class="tlaGBC" title="Branch 0 was taken 405905 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 405905 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      811810 :         memcpy(&amp;out.scriptPubKey[6], witnessroot.begin(), 32);</span></span>
<span id="L4109"><span class="lineNum">    4109</span>   [<span class="tlaGBC" title="Branch 0 was taken 405905 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 405905 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">     1217715 :         commitment = std::vector&lt;unsigned char&gt;(out.scriptPubKey.begin(), out.scriptPubKey.end());</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 405905 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L4110"><span class="lineNum">    4110</span>         [<span class="tlaGBC" title="Branch 0 was taken 405905 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      405905 :         CMutableTransaction tx(*block.vtx[0]);</span></span>
<span id="L4111"><span class="lineNum">    4111</span>         [<span class="tlaGBC" title="Branch 0 was taken 405905 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      405905 :         tx.vout.push_back(out);</span></span>
<span id="L4112"><span class="lineNum">    4112</span>   [<span class="tlaGBC" title="Branch 0 was taken 405905 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 405905 times"> + </span>]:<span class="tlaGNC">      811810 :         block.vtx[0] = MakeTransactionRef(std::move(tx));</span></span>
<span id="L4113"><span class="lineNum">    4113</span>                 :<span class="tlaGNC">      405905 :     }</span></span>
<span id="L4114"><span class="lineNum">    4114</span>         [<span class="tlaGBC" title="Branch 0 was taken 409001 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      409001 :     UpdateUncommittedBlockStructures(block, pindexPrev);</span></span>
<span id="L4115"><span class="lineNum">    4115</span>                 :<span class="tlaGNC">      409001 :     return commitment;</span></span>
<span id="L4116"><span class="lineNum">    4116</span>                 :<span class="tlaGNC">      409001 : }</span></span>
<span id="L4117"><span class="lineNum">    4117</span>                 :             : </span>
<span id="L4118"><span class="lineNum">    4118</span>                 :<span class="tlaGNC">       25348 : bool HasValidProofOfWork(const std::vector&lt;CBlockHeader&gt;&amp; headers, const Consensus::Params&amp; consensusParams)</span></span>
<span id="L4119"><span class="lineNum">    4119</span>                 :             : {</span>
<span id="L4120"><span class="lineNum">    4120</span>                 :<span class="tlaGNC">       25348 :     return std::all_of(headers.cbegin(), headers.cend(),</span></span>
<span id="L4121"><span class="lineNum">    4121</span>                 :<span class="tlaGNC">      293310 :             [&amp;](const auto&amp; header) { return CheckProofOfWork(header.GetHash(), header.nBits, consensusParams);});</span></span>
<span id="L4122"><span class="lineNum">    4122</span>                 :             : }</span>
<span id="L4123"><span class="lineNum">    4123</span>                 :             : </span>
<span id="L4124"><span class="lineNum">    4124</span>                 :<span class="tlaGNC">       12448 : bool IsBlockMutated(const CBlock&amp; block, bool check_witness_root)</span></span>
<span id="L4125"><span class="lineNum">    4125</span>                 :             : {</span>
<span id="L4126"><span class="lineNum">    4126</span>         [<span class="tlaGBC" title="Branch 0 was taken 12448 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       12448 :     BlockValidationState state;</span></span>
<span id="L4127"><span class="lineNum">    4127</span>   [<span class="tlaGBC" title="Branch 0 was taken 12448 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 168 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 12280 times"> + </span>]:<span class="tlaGNC">       12448 :     if (!CheckMerkleRoot(block, state)) {</span></span>
<span id="L4128"><span class="lineNum">    4128</span>   [<span class="tlaGBC" title="Branch 0 was taken 168 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 168 times"> + </span> :<span class="tlaGNC">         168 :         LogDebug(BCLog::VALIDATION, &quot;Block mutated: %s\n&quot;, state.ToString());</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaUNC" title="Branch 6 was not taken"> - </span><span class="tlaUNC" title="Branch 7 was not taken"> - </span>]
<span id="L4129"><span class="lineNum">    4129</span>                 :<span class="tlaGNC">         168 :         return true;</span></span>
<span id="L4130"><span class="lineNum">    4130</span>                 :             :     }</span>
<span id="L4131"><span class="lineNum">    4131</span>                 :             : </span>
<span id="L4132"><span class="lineNum">    4132</span>   [<span class="tlaGBC" title="Branch 0 was taken 11169 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 1111 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 400 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 10769 times"> + </span>]:<span class="tlaGNC">       12280 :     if (block.vtx.empty() || !block.vtx[0]-&gt;IsCoinBase()) {</span></span>
<span id="L4133"><span class="lineNum">    4133</span>                 :             :         // Consider the block mutated if any transaction is 64 bytes in size (see 3.1</span>
<span id="L4134"><span class="lineNum">    4134</span>                 :             :         // in &quot;Weaknesses in Bitcoins Merkle Root Construction&quot;:</span>
<span id="L4135"><span class="lineNum">    4135</span>                 :             :         // https://lists.linuxfoundation.org/pipermail/bitcoin-dev/attachments/20190225/a27d8837/attachment-0001.pdf).</span>
<span id="L4136"><span class="lineNum">    4136</span>                 :             :         //</span>
<span id="L4137"><span class="lineNum">    4137</span>                 :             :         // Note: This is not a consensus change as this only applies to blocks that</span>
<span id="L4138"><span class="lineNum">    4138</span>                 :             :         // don't have a coinbase transaction and would therefore already be invalid.</span>
<span id="L4139"><span class="lineNum">    4139</span>                 :<span class="tlaGNC">        1511 :         return std::any_of(block.vtx.begin(), block.vtx.end(),</span></span>
<span id="L4140"><span class="lineNum">    4140</span>                 :<span class="tlaGNC">        3606 :                            [](auto&amp; tx) { return GetSerializeSize(TX_NO_WITNESS(tx)) == 64; });</span></span>
<span id="L4141"><span class="lineNum">    4141</span>                 :             :     } else {</span>
<span id="L4142"><span class="lineNum">    4142</span>                 :             :         // Theoretically it is still possible for a block with a 64 byte</span>
<span id="L4143"><span class="lineNum">    4143</span>                 :             :         // coinbase transaction to be mutated but we neglect that possibility</span>
<span id="L4144"><span class="lineNum">    4144</span>                 :             :         // here as it requires at least 224 bits of work.</span>
<span id="L4145"><span class="lineNum">    4145</span>                 :             :     }</span>
<span id="L4146"><span class="lineNum">    4146</span>                 :             : </span>
<span id="L4147"><span class="lineNum">    4147</span>   [<span class="tlaGBC" title="Branch 0 was taken 10769 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 19 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 10750 times"> + </span>]:<span class="tlaGNC">       10769 :     if (!CheckWitnessMalleation(block, check_witness_root, state)) {</span></span>
<span id="L4148"><span class="lineNum">    4148</span>   [<span class="tlaGBC" title="Branch 0 was taken 19 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 19 times"> + </span> :<span class="tlaGNC">          19 :         LogDebug(BCLog::VALIDATION, &quot;Block mutated: %s\n&quot;, state.ToString());</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaUNC" title="Branch 6 was not taken"> - </span><span class="tlaUNC" title="Branch 7 was not taken"> - </span>]
<span id="L4149"><span class="lineNum">    4149</span>                 :<span class="tlaGNC">          19 :         return true;</span></span>
<span id="L4150"><span class="lineNum">    4150</span>                 :             :     }</span>
<span id="L4151"><span class="lineNum">    4151</span>                 :             : </span>
<span id="L4152"><span class="lineNum">    4152</span>                 :             :     return false;</span>
<span id="L4153"><span class="lineNum">    4153</span>                 :<span class="tlaGNC">       12448 : }</span></span>
<span id="L4154"><span class="lineNum">    4154</span>                 :             : </span>
<span id="L4155"><span class="lineNum">    4155</span>                 :<span class="tlaGNC">       19316 : arith_uint256 CalculateClaimedHeadersWork(std::span&lt;const CBlockHeader&gt; headers)</span></span>
<span id="L4156"><span class="lineNum">    4156</span>                 :             : {</span>
<span id="L4157"><span class="lineNum">    4157</span>                 :<span class="tlaGNC">       19316 :     arith_uint256 total_work{0};</span></span>
<span id="L4158"><span class="lineNum">    4158</span>         [<span class="tlaGBC" title="Branch 0 was taken 348156 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 19316 times"> + </span>]:<span class="tlaGNC">      367472 :     for (const CBlockHeader&amp; header : headers) {</span></span>
<span id="L4159"><span class="lineNum">    4159</span>                 :<span class="tlaGNC">      348156 :         CBlockIndex dummy(header);</span></span>
<span id="L4160"><span class="lineNum">    4160</span>                 :<span class="tlaGNC">      348156 :         total_work += GetBlockProof(dummy);</span></span>
<span id="L4161"><span class="lineNum">    4161</span>                 :             :     }</span>
<span id="L4162"><span class="lineNum">    4162</span>                 :<span class="tlaGNC">       19316 :     return total_work;</span></span>
<span id="L4163"><span class="lineNum">    4163</span>                 :             : }</span>
<span id="L4164"><span class="lineNum">    4164</span>                 :             : </span>
<span id="L4165"><span class="lineNum">    4165</span>                 :             : /** Context-dependent validity checks.</span>
<span id="L4166"><span class="lineNum">    4166</span>                 :             :  *  By &quot;context&quot;, we mean only the previous block headers, but not the UTXO</span>
<span id="L4167"><span class="lineNum">    4167</span>                 :             :  *  set; UTXO-related validity checks are done in ConnectBlock().</span>
<span id="L4168"><span class="lineNum">    4168</span>                 :             :  *  NOTE: This function is not currently invoked by ConnectBlock(), so we</span>
<span id="L4169"><span class="lineNum">    4169</span>                 :             :  *  should consider upgrade issues if we change which consensus rules are</span>
<span id="L4170"><span class="lineNum">    4170</span>                 :             :  *  enforced in this function (eg by adding a new consensus rule). See comment</span>
<span id="L4171"><span class="lineNum">    4171</span>                 :             :  *  in ConnectBlock().</span>
<span id="L4172"><span class="lineNum">    4172</span>                 :             :  *  Note that -reindex-chainstate skips the validation that happens here!</span>
<span id="L4173"><span class="lineNum">    4173</span>                 :             :  *</span>
<span id="L4174"><span class="lineNum">    4174</span>                 :             :  *  NOTE: failing to check the header's height against the last checkpoint's opened a DoS vector between</span>
<span id="L4175"><span class="lineNum">    4175</span>                 :             :  *  v0.12 and v0.15 (when no additional protection was in place) whereby an attacker could unboundedly</span>
<span id="L4176"><span class="lineNum">    4176</span>                 :             :  *  grow our in-memory block index. See https://bitcoincore.org/en/2024/07/03/disclose-header-spam.</span>
<span id="L4177"><span class="lineNum">    4177</span>                 :             :  */</span>
<span id="L4178"><span class="lineNum">    4178</span>                 :<span class="tlaGNC">      684796 : static bool ContextualCheckBlockHeader(const CBlockHeader&amp; block, BlockValidationState&amp; state, BlockManager&amp; blockman, const ChainstateManager&amp; chainman, const CBlockIndex* pindexPrev) EXCLUSIVE_LOCKS_REQUIRED(::cs_main)</span></span>
<span id="L4179"><span class="lineNum">    4179</span>                 :             : {</span>
<span id="L4180"><span class="lineNum">    4180</span>                 :<span class="tlaGNC">      684796 :     AssertLockHeld(::cs_main);</span></span>
<span id="L4181"><span class="lineNum">    4181</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 684796 times"> + </span>]:<span class="tlaGNC">      684796 :     assert(pindexPrev != nullptr);</span></span>
<span id="L4182"><span class="lineNum">    4182</span>                 :<span class="tlaGNC">      684796 :     const int nHeight = pindexPrev-&gt;nHeight + 1;</span></span>
<span id="L4183"><span class="lineNum">    4183</span>                 :             : </span>
<span id="L4184"><span class="lineNum">    4184</span>                 :             :     // Check proof of work</span>
<span id="L4185"><span class="lineNum">    4185</span>                 :<span class="tlaGNC">      684796 :     const Consensus::Params&amp; consensusParams = chainman.GetConsensus();</span></span>
<span id="L4186"><span class="lineNum">    4186</span>         [<span class="tlaGBC" title="Branch 0 was taken 15635 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 669161 times"> + </span>]:<span class="tlaGNC">      684796 :     if (block.nBits != GetNextWorkRequired(pindexPrev, &amp;block, consensusParams))</span></span>
<span id="L4187"><span class="lineNum">    4187</span>   [<span class="tlaGBC" title="Branch 0 was taken 15635 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 15635 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">       15635 :         return state.Invalid(BlockValidationResult::BLOCK_INVALID_HEADER, &quot;bad-diffbits&quot;, &quot;incorrect proof of work&quot;);</span></span>
<span id="L4188"><span class="lineNum">    4188</span>                 :             : </span>
<span id="L4189"><span class="lineNum">    4189</span>                 :             :     // Check timestamp against prev</span>
<span id="L4190"><span class="lineNum">    4190</span>         [<span class="tlaGBC" title="Branch 0 was taken 5030 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 664131 times"> + </span>]:<span class="tlaGNC">      669161 :     if (block.GetBlockTime() &lt;= pindexPrev-&gt;GetMedianTimePast())</span></span>
<span id="L4191"><span class="lineNum">    4191</span>   [<span class="tlaGBC" title="Branch 0 was taken 5030 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 5030 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">        5030 :         return state.Invalid(BlockValidationResult::BLOCK_INVALID_HEADER, &quot;time-too-old&quot;, &quot;block's timestamp is too early&quot;);</span></span>
<span id="L4192"><span class="lineNum">    4192</span>                 :             : </span>
<span id="L4193"><span class="lineNum">    4193</span>                 :             :     // Testnet4 and regtest only: Check timestamp against prev for difficulty-adjustment</span>
<span id="L4194"><span class="lineNum">    4194</span>                 :             :     // blocks to prevent timewarp attacks (see https://github.com/bitcoin/bitcoin/pull/15482).</span>
<span id="L4195"><span class="lineNum">    4195</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 664131 times"> + </span>]:<span class="tlaGNC">      664131 :     if (consensusParams.enforce_BIP94) {</span></span>
<span id="L4196"><span class="lineNum">    4196</span>                 :             :         // Check timestamp for the first block of each difficulty adjustment</span>
<span id="L4197"><span class="lineNum">    4197</span>                 :             :         // interval, except the genesis block.</span>
<span id="L4198"><span class="lineNum">    4198</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (nHeight % consensusParams.DifficultyAdjustmentInterval() == 0) {</span></span>
<span id="L4199"><span class="lineNum">    4199</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (block.GetBlockTime() &lt; pindexPrev-&gt;GetBlockTime() - MAX_TIMEWARP) {</span></span>
<span id="L4200"><span class="lineNum">    4200</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 return state.Invalid(BlockValidationResult::BLOCK_INVALID_HEADER, &quot;time-timewarp-attack&quot;, &quot;block's timestamp is too early on diff adjustment block&quot;);</span></span>
<span id="L4201"><span class="lineNum">    4201</span>                 :             :             }</span>
<span id="L4202"><span class="lineNum">    4202</span>                 :             :         }</span>
<span id="L4203"><span class="lineNum">    4203</span>                 :             :     }</span>
<span id="L4204"><span class="lineNum">    4204</span>                 :             : </span>
<span id="L4205"><span class="lineNum">    4205</span>                 :             :     // Check timestamp</span>
<span id="L4206"><span class="lineNum">    4206</span>         [<span class="tlaGBC" title="Branch 0 was taken 24619 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 639512 times"> + </span>]:<span class="tlaGNC">      664131 :     if (block.Time() &gt; NodeClock::now() + std::chrono::seconds{MAX_FUTURE_BLOCK_TIME}) {</span></span>
<span id="L4207"><span class="lineNum">    4207</span>   [<span class="tlaGBC" title="Branch 0 was taken 24619 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 24619 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">       24619 :         return state.Invalid(BlockValidationResult::BLOCK_TIME_FUTURE, &quot;time-too-new&quot;, &quot;block timestamp too far in the future&quot;);</span></span>
<span id="L4208"><span class="lineNum">    4208</span>                 :             :     }</span>
<span id="L4209"><span class="lineNum">    4209</span>                 :             : </span>
<span id="L4210"><span class="lineNum">    4210</span>                 :             :     // Reject blocks with outdated version</span>
<span id="L4211"><span class="lineNum">    4211</span>   [<span class="tlaGBC" title="Branch 0 was taken 261 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 9959 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 1941 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 627612 times"> + </span>]:<span class="tlaGNC">      639512 :     if ((block.nVersion &lt; 2 &amp;&amp; DeploymentActiveAfter(pindexPrev, chainman, Consensus::DEPLOYMENT_HEIGHTINCB)) ||</span></span>
<span id="L4212"><span class="lineNum">    4212</span>   [<span class="tlaGBC" title="Branch 0 was taken 10220 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 629292 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 385 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 1556 times"> + </span> :<span class="tlaGNC">     1269065 :         (block.nVersion &lt; 3 &amp;&amp; DeploymentActiveAfter(pindexPrev, chainman, Consensus::DEPLOYMENT_DERSIG)) ||</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 2497 times"> + </span><span class="tlaGBC" title="Branch 5 was taken 625500 times"> + </span>]
<span id="L4213"><span class="lineNum">    4213</span>         [<span class="tlaGBC" title="Branch 0 was taken 1917 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 580 times"> + </span>]:<span class="tlaGNC">        2497 :         (block.nVersion &lt; 4 &amp;&amp; DeploymentActiveAfter(pindexPrev, chainman, Consensus::DEPLOYMENT_CLTV))) {</span></span>
<span id="L4214"><span class="lineNum">    4214</span>   [<span class="tlaGBC" title="Branch 0 was taken 13432 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 13432 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">       13432 :             return state.Invalid(BlockValidationResult::BLOCK_INVALID_HEADER, strprintf(&quot;bad-version(0x%08x)&quot;, block.nVersion),</span></span>
<span id="L4215"><span class="lineNum">    4215</span>                 :<span class="tlaGNC">       26864 :                                  strprintf(&quot;rejected nVersion=0x%08x block&quot;, block.nVersion));</span></span>
<span id="L4216"><span class="lineNum">    4216</span>                 :             :     }</span>
<span id="L4217"><span class="lineNum">    4217</span>                 :             : </span>
<span id="L4218"><span class="lineNum">    4218</span>                 :             :     return true;</span>
<span id="L4219"><span class="lineNum">    4219</span>                 :             : }</span>
<span id="L4220"><span class="lineNum">    4220</span>                 :             : </span>
<span id="L4221"><span class="lineNum">    4221</span>                 :             : /** NOTE: This function is not currently invoked by ConnectBlock(), so we</span>
<span id="L4222"><span class="lineNum">    4222</span>                 :             :  *  should consider upgrade issues if we change which consensus rules are</span>
<span id="L4223"><span class="lineNum">    4223</span>                 :             :  *  enforced in this function (eg by adding a new consensus rule). See comment</span>
<span id="L4224"><span class="lineNum">    4224</span>                 :             :  *  in ConnectBlock().</span>
<span id="L4225"><span class="lineNum">    4225</span>                 :             :  *  Note that -reindex-chainstate skips the validation that happens here!</span>
<span id="L4226"><span class="lineNum">    4226</span>                 :             :  */</span>
<span id="L4227"><span class="lineNum">    4227</span>                 :<span class="tlaGNC">      462209 : static bool ContextualCheckBlock(const CBlock&amp; block, BlockValidationState&amp; state, const ChainstateManager&amp; chainman, const CBlockIndex* pindexPrev)</span></span>
<span id="L4228"><span class="lineNum">    4228</span>                 :             : {</span>
<span id="L4229"><span class="lineNum">    4229</span>         [<span class="tlaGBC" title="Branch 0 was taken 462209 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      462209 :     const int nHeight = pindexPrev == nullptr ? 0 : pindexPrev-&gt;nHeight + 1;</span></span>
<span id="L4230"><span class="lineNum">    4230</span>                 :             : </span>
<span id="L4231"><span class="lineNum">    4231</span>                 :             :     // Enforce BIP113 (Median Time Past).</span>
<span id="L4232"><span class="lineNum">    4232</span>                 :<span class="tlaGNC">      462209 :     bool enforce_locktime_median_time_past{false};</span></span>
<span id="L4233"><span class="lineNum">    4233</span>         [<span class="tlaGBC" title="Branch 0 was taken 462209 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      462209 :     if (DeploymentActiveAfter(pindexPrev, chainman, Consensus::DEPLOYMENT_CSV)) {</span></span>
<span id="L4234"><span class="lineNum">    4234</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 462209 times"> + </span>]:<span class="tlaGNC">      462209 :         assert(pindexPrev != nullptr);</span></span>
<span id="L4235"><span class="lineNum">    4235</span>                 :             :         enforce_locktime_median_time_past = true;</span>
<span id="L4236"><span class="lineNum">    4236</span>                 :             :     }</span>
<span id="L4237"><span class="lineNum">    4237</span>                 :             : </span>
<span id="L4238"><span class="lineNum">    4238</span>                 :<span class="tlaGNC">      462209 :     const int64_t nLockTimeCutoff{enforce_locktime_median_time_past ?</span></span>
<span id="L4239"><span class="lineNum">    4239</span>                 :<span class="tlaGNC">      462209 :                                       pindexPrev-&gt;GetMedianTimePast() :</span></span>
<span id="L4240"><span class="lineNum">    4240</span>                 :<span class="tlaUNC">           0 :                                       block.GetBlockTime()};</span></span>
<span id="L4241"><span class="lineNum">    4241</span>                 :             : </span>
<span id="L4242"><span class="lineNum">    4242</span>                 :             :     // Check that all transactions are finalized</span>
<span id="L4243"><span class="lineNum">    4243</span>         [<span class="tlaGBC" title="Branch 0 was taken 510251 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 462209 times"> + </span>]:<span class="tlaGNC">      972460 :     for (const auto&amp; tx : block.vtx) {</span></span>
<span id="L4244"><span class="lineNum">    4244</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 510251 times"> + </span>]:<span class="tlaGNC">      510251 :         if (!IsFinalTx(*tx, nHeight, nLockTimeCutoff)) {</span></span>
<span id="L4245"><span class="lineNum">    4245</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             return state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, &quot;bad-txns-nonfinal&quot;, &quot;non-final transaction&quot;);</span></span>
<span id="L4246"><span class="lineNum">    4246</span>                 :             :         }</span>
<span id="L4247"><span class="lineNum">    4247</span>                 :             :     }</span>
<span id="L4248"><span class="lineNum">    4248</span>                 :             : </span>
<span id="L4249"><span class="lineNum">    4249</span>                 :             :     // Enforce rule that the coinbase starts with serialized block height</span>
<span id="L4250"><span class="lineNum">    4250</span>         [<span class="tlaGBC" title="Branch 0 was taken 456953 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 5256 times"> + </span>]:<span class="tlaGNC">      462209 :     if (DeploymentActiveAfter(pindexPrev, chainman, Consensus::DEPLOYMENT_HEIGHTINCB))</span></span>
<span id="L4251"><span class="lineNum">    4251</span>                 :             :     {</span>
<span id="L4252"><span class="lineNum">    4252</span>         [<span class="tlaGBC" title="Branch 0 was taken 456953 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      456953 :         CScript expect = CScript() &lt;&lt; nHeight;</span></span>
<span id="L4253"><span class="lineNum">    4253</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 456953 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 456953 times"> + </span> :<span class="tlaGNC">      913906 :         if (block.vtx[0]-&gt;vin[0].scriptSig.size() &lt; expect.size() ||</span></span>
<span class="lineNum">        </span>    <span class="tlaGBC" title="Branch 4 was taken 456953 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaGBC" title="Branch 6 was taken 456953 times"> + </span><span class="tlaUNC" title="Branch 7 was not taken"> - </span>]
<span id="L4254"><span class="lineNum">    4254</span>   [<span class="tlaGBC" title="Branch 0 was taken 456953 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 456953 times"> + </span>]:<span class="tlaGNC">      913906 :             !std::equal(expect.begin(), expect.end(), block.vtx[0]-&gt;vin[0].scriptSig.begin())) {</span></span>
<span id="L4255"><span class="lineNum">    4255</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             return state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, &quot;bad-cb-height&quot;, &quot;block height mismatch in coinbase&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L4256"><span class="lineNum">    4256</span>                 :             :         }</span>
<span id="L4257"><span class="lineNum">    4257</span>                 :<span class="tlaGNC">      456953 :     }</span></span>
<span id="L4258"><span class="lineNum">    4258</span>                 :             : </span>
<span id="L4259"><span class="lineNum">    4259</span>                 :             :     // Validation for witness commitments.</span>
<span id="L4260"><span class="lineNum">    4260</span>                 :             :     // * We compute the witness hash (which is the hash including witnesses) of all the block's transactions, except the</span>
<span id="L4261"><span class="lineNum">    4261</span>                 :             :     //   coinbase (where 0x0000....0000 is used instead).</span>
<span id="L4262"><span class="lineNum">    4262</span>                 :             :     // * The coinbase scriptWitness is a stack of a single 32-byte vector, containing a witness reserved value (unconstrained).</span>
<span id="L4263"><span class="lineNum">    4263</span>                 :             :     // * We build a merkle tree with all those witness hashes as leaves (similar to the hashMerkleRoot in the block header).</span>
<span id="L4264"><span class="lineNum">    4264</span>                 :             :     // * There must be at least one output whose scriptPubKey is a single 36-byte push, the first 4 bytes of which are</span>
<span id="L4265"><span class="lineNum">    4265</span>                 :             :     //   {0xaa, 0x21, 0xa9, 0xed}, and the following 32 bytes are SHA256^2(witness root, witness reserved value). In case there are</span>
<span id="L4266"><span class="lineNum">    4266</span>                 :             :     //   multiple, the last one is used.</span>
<span id="L4267"><span class="lineNum">    4267</span>         [<span class="tlaGBC" title="Branch 0 was taken 462209 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      462209 :     if (!CheckWitnessMalleation(block, DeploymentActiveAfter(pindexPrev, chainman, Consensus::DEPLOYMENT_SEGWIT), state)) {</span></span>
<span id="L4268"><span class="lineNum">    4268</span>                 :             :         return false;</span>
<span id="L4269"><span class="lineNum">    4269</span>                 :             :     }</span>
<span id="L4270"><span class="lineNum">    4270</span>                 :             : </span>
<span id="L4271"><span class="lineNum">    4271</span>                 :             :     // After the coinbase witness reserved value and commitment are verified,</span>
<span id="L4272"><span class="lineNum">    4272</span>                 :             :     // we can check if the block weight passes (before we've checked the</span>
<span id="L4273"><span class="lineNum">    4273</span>                 :             :     // coinbase witness, it would be possible for the weight to be too</span>
<span id="L4274"><span class="lineNum">    4274</span>                 :             :     // large by filling up the coinbase witness, which doesn't change</span>
<span id="L4275"><span class="lineNum">    4275</span>                 :             :     // the block hash, so we couldn't mark the block as permanently</span>
<span id="L4276"><span class="lineNum">    4276</span>                 :             :     // failed).</span>
<span id="L4277"><span class="lineNum">    4277</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 462209 times"> + </span>]:<span class="tlaGNC">      462209 :     if (GetBlockWeight(block) &gt; MAX_BLOCK_WEIGHT) {</span></span>
<span id="L4278"><span class="lineNum">    4278</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         return state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, &quot;bad-blk-weight&quot;, strprintf(&quot;%s : weight limit failed&quot;, __func__));</span></span>
<span id="L4279"><span class="lineNum">    4279</span>                 :             :     }</span>
<span id="L4280"><span class="lineNum">    4280</span>                 :             : </span>
<span id="L4281"><span class="lineNum">    4281</span>                 :             :     return true;</span>
<span id="L4282"><span class="lineNum">    4282</span>                 :             : }</span>
<span id="L4283"><span class="lineNum">    4283</span>                 :             : </span>
<span id="L4284"><span class="lineNum">    4284</span>                 :<span class="tlaGNC">      517465 : bool ChainstateManager::AcceptBlockHeader(const CBlockHeader&amp; block, BlockValidationState&amp; state, CBlockIndex** ppindex, bool min_pow_checked)</span></span>
<span id="L4285"><span class="lineNum">    4285</span>                 :             : {</span>
<span id="L4286"><span class="lineNum">    4286</span>                 :<span class="tlaGNC">      517465 :     AssertLockHeld(cs_main);</span></span>
<span id="L4287"><span class="lineNum">    4287</span>                 :             : </span>
<span id="L4288"><span class="lineNum">    4288</span>                 :             :     // Check for duplicate</span>
<span id="L4289"><span class="lineNum">    4289</span>                 :<span class="tlaGNC">      517465 :     uint256 hash = block.GetHash();</span></span>
<span id="L4290"><span class="lineNum">    4290</span>                 :<span class="tlaGNC">      517465 :     BlockMap::iterator miSelf{m_blockman.m_block_index.find(hash)};</span></span>
<span id="L4291"><span class="lineNum">    4291</span>         [<span class="tlaGBC" title="Branch 0 was taken 517465 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      517465 :     if (hash != GetConsensus().hashGenesisBlock) {</span></span>
<span id="L4292"><span class="lineNum">    4292</span>         [<span class="tlaGBC" title="Branch 0 was taken 472244 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 45221 times"> + </span>]:<span class="tlaGNC">      517465 :         if (miSelf != m_blockman.m_block_index.end()) {</span></span>
<span id="L4293"><span class="lineNum">    4293</span>                 :             :             // Block header is already known.</span>
<span id="L4294"><span class="lineNum">    4294</span>         [<span class="tlaGBC" title="Branch 0 was taken 45221 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       45221 :             CBlockIndex* pindex = &amp;(miSelf-&gt;second);</span></span>
<span id="L4295"><span class="lineNum">    4295</span>         [<span class="tlaGBC" title="Branch 0 was taken 45221 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       45221 :             if (ppindex)</span></span>
<span id="L4296"><span class="lineNum">    4296</span>                 :<span class="tlaGNC">       45221 :                 *ppindex = pindex;</span></span>
<span id="L4297"><span class="lineNum">    4297</span>         [<span class="tlaGBC" title="Branch 0 was taken 20474 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 24747 times"> + </span>]:<span class="tlaGNC">       45221 :             if (pindex-&gt;nStatus &amp; BLOCK_FAILED_MASK) {</span></span>
<span id="L4298"><span class="lineNum">    4298</span>   [<span class="tlaGBC" title="Branch 0 was taken 17495 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 2979 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 17495 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">       37969 :                 LogDebug(BCLog::VALIDATION, &quot;%s: block %s is marked invalid\n&quot;, __func__, hash.ToString());</span></span>
<span id="L4299"><span class="lineNum">    4299</span>   [<span class="tlaGBC" title="Branch 0 was taken 20474 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 20474 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">       20474 :                 return state.Invalid(BlockValidationResult::BLOCK_CACHED_INVALID, &quot;duplicate-invalid&quot;);</span></span>
<span id="L4300"><span class="lineNum">    4300</span>                 :             :             }</span>
<span id="L4301"><span class="lineNum">    4301</span>                 :             :             return true;</span>
<span id="L4302"><span class="lineNum">    4302</span>                 :             :         }</span>
<span id="L4303"><span class="lineNum">    4303</span>                 :             : </span>
<span id="L4304"><span class="lineNum">    4304</span>         [<span class="tlaGBC" title="Branch 0 was taken 25454 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 446790 times"> + </span>]:<span class="tlaGNC">      472244 :         if (!CheckBlockHeader(block, state, GetConsensus())) {</span></span>
<span id="L4305"><span class="lineNum">    4305</span>   [<span class="tlaGBC" title="Branch 0 was taken 5 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 25449 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 5 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">       25459 :             LogDebug(BCLog::VALIDATION, &quot;%s: Consensus::CheckBlockHeader: %s, %s\n&quot;, __func__, hash.ToString(), state.ToString());</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 5 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L4306"><span class="lineNum">    4306</span>                 :<span class="tlaGNC">       25454 :             return false;</span></span>
<span id="L4307"><span class="lineNum">    4307</span>                 :             :         }</span>
<span id="L4308"><span class="lineNum">    4308</span>                 :             : </span>
<span id="L4309"><span class="lineNum">    4309</span>                 :             :         // Get prev block index</span>
<span id="L4310"><span class="lineNum">    4310</span>                 :<span class="tlaGNC">      446790 :         CBlockIndex* pindexPrev = nullptr;</span></span>
<span id="L4311"><span class="lineNum">    4311</span>                 :<span class="tlaGNC">      446790 :         BlockMap::iterator mi{m_blockman.m_block_index.find(block.hashPrevBlock)};</span></span>
<span id="L4312"><span class="lineNum">    4312</span>         [<span class="tlaGBC" title="Branch 0 was taken 438499 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 8291 times"> + </span>]:<span class="tlaGNC">      446790 :         if (mi == m_blockman.m_block_index.end()) {</span></span>
<span id="L4313"><span class="lineNum">    4313</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 8291 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">        8291 :             LogDebug(BCLog::VALIDATION, &quot;header %s has prev block not found: %s\n&quot;, hash.ToString(), block.hashPrevBlock.ToString());</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L4314"><span class="lineNum">    4314</span>   [<span class="tlaGBC" title="Branch 0 was taken 8291 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 8291 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">        8291 :             return state.Invalid(BlockValidationResult::BLOCK_MISSING_PREV, &quot;prev-blk-not-found&quot;);</span></span>
<span id="L4315"><span class="lineNum">    4315</span>                 :             :         }</span>
<span id="L4316"><span class="lineNum">    4316</span>         [<span class="tlaGBC" title="Branch 0 was taken 2786 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 435713 times"> + </span>]:<span class="tlaGNC">      438499 :         pindexPrev = &amp;((*mi).second);</span></span>
<span id="L4317"><span class="lineNum">    4317</span>         [<span class="tlaGBC" title="Branch 0 was taken 2786 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 435713 times"> + </span>]:<span class="tlaGNC">      438499 :         if (pindexPrev-&gt;nStatus &amp; BLOCK_FAILED_MASK) {</span></span>
<span id="L4318"><span class="lineNum">    4318</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 2786 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">        2786 :             LogDebug(BCLog::VALIDATION, &quot;header %s has prev block invalid: %s\n&quot;, hash.ToString(), block.hashPrevBlock.ToString());</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L4319"><span class="lineNum">    4319</span>   [<span class="tlaGBC" title="Branch 0 was taken 2786 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 2786 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">        2786 :             return state.Invalid(BlockValidationResult::BLOCK_INVALID_PREV, &quot;bad-prevblk&quot;);</span></span>
<span id="L4320"><span class="lineNum">    4320</span>                 :             :         }</span>
<span id="L4321"><span class="lineNum">    4321</span>         [<span class="tlaGBC" title="Branch 0 was taken 58716 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 376997 times"> + </span>]:<span class="tlaGNC">      435713 :         if (!ContextualCheckBlockHeader(block, state, m_blockman, *this, pindexPrev)) {</span></span>
<span id="L4322"><span class="lineNum">    4322</span>   [<span class="tlaGBC" title="Branch 0 was taken 9 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 58707 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 9 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">       58725 :             LogDebug(BCLog::VALIDATION, &quot;%s: Consensus::ContextualCheckBlockHeader: %s, %s\n&quot;, __func__, hash.ToString(), state.ToString());</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 9 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L4323"><span class="lineNum">    4323</span>                 :<span class="tlaGNC">       58716 :             return false;</span></span>
<span id="L4324"><span class="lineNum">    4324</span>                 :             :         }</span>
<span id="L4325"><span class="lineNum">    4325</span>                 :             :     }</span>
<span id="L4326"><span class="lineNum">    4326</span>         [<span class="tlaGBC" title="Branch 0 was taken 779 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 376218 times"> + </span>]:<span class="tlaGNC">      376997 :     if (!min_pow_checked) {</span></span>
<span id="L4327"><span class="lineNum">    4327</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 779 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">         779 :         LogDebug(BCLog::VALIDATION, &quot;%s: not adding new block header %s, missing anti-dos proof-of-work validation\n&quot;, __func__, hash.ToString());</span></span>
<span id="L4328"><span class="lineNum">    4328</span>   [<span class="tlaGBC" title="Branch 0 was taken 779 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 779 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">         779 :         return state.Invalid(BlockValidationResult::BLOCK_HEADER_LOW_WORK, &quot;too-little-chainwork&quot;);</span></span>
<span id="L4329"><span class="lineNum">    4329</span>                 :             :     }</span>
<span id="L4330"><span class="lineNum">    4330</span>                 :<span class="tlaGNC">      376218 :     CBlockIndex* pindex{m_blockman.AddToBlockIndex(block, m_best_header)};</span></span>
<span id="L4331"><span class="lineNum">    4331</span>                 :             : </span>
<span id="L4332"><span class="lineNum">    4332</span>         [<span class="tlaGBC" title="Branch 0 was taken 376218 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      376218 :     if (ppindex)</span></span>
<span id="L4333"><span class="lineNum">    4333</span>                 :<span class="tlaGNC">      376218 :         *ppindex = pindex;</span></span>
<span id="L4334"><span class="lineNum">    4334</span>                 :             : </span>
<span id="L4335"><span class="lineNum">    4335</span>                 :             :     return true;</span>
<span id="L4336"><span class="lineNum">    4336</span>                 :             : }</span>
<span id="L4337"><span class="lineNum">    4337</span>                 :             : </span>
<span id="L4338"><span class="lineNum">    4338</span>                 :             : // Exposed wrapper for AcceptBlockHeader</span>
<span id="L4339"><span class="lineNum">    4339</span>                 :<span class="tlaGNC">      164786 : bool ChainstateManager::ProcessNewBlockHeaders(std::span&lt;const CBlockHeader&gt; headers, bool min_pow_checked, BlockValidationState&amp; state, const CBlockIndex** ppindex)</span></span>
<span id="L4340"><span class="lineNum">    4340</span>                 :             : {</span>
<span id="L4341"><span class="lineNum">    4341</span>                 :<span class="tlaGNC">      164786 :     AssertLockNotHeld(cs_main);</span></span>
<span id="L4342"><span class="lineNum">    4342</span>                 :<span class="tlaGNC">      164786 :     {</span></span>
<span id="L4343"><span class="lineNum">    4343</span>                 :<span class="tlaGNC">      164786 :         LOCK(cs_main);</span></span>
<span id="L4344"><span class="lineNum">    4344</span>         [<span class="tlaGBC" title="Branch 0 was taken 164855 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 163161 times"> + </span>]:<span class="tlaGNC">      328016 :         for (const CBlockHeader&amp; header : headers) {</span></span>
<span id="L4345"><span class="lineNum">    4345</span>                 :<span class="tlaGNC">      164855 :             CBlockIndex *pindex = nullptr; // Use a temp pindex instead of ppindex to avoid a const_cast</span></span>
<span id="L4346"><span class="lineNum">    4346</span>         [<span class="tlaGBC" title="Branch 0 was taken 164855 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      164855 :             bool accepted{AcceptBlockHeader(header, state, &amp;pindex, min_pow_checked)};</span></span>
<span id="L4347"><span class="lineNum">    4347</span>         [<span class="tlaGBC" title="Branch 0 was taken 164855 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      164855 :             CheckBlockIndex();</span></span>
<span id="L4348"><span class="lineNum">    4348</span>                 :             : </span>
<span id="L4349"><span class="lineNum">    4349</span>         [<span class="tlaGBC" title="Branch 0 was taken 1625 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 163230 times"> + </span>]:<span class="tlaGNC">      164855 :             if (!accepted) {</span></span>
<span id="L4350"><span class="lineNum">    4350</span>         [<span class="tlaGBC" title="Branch 0 was taken 1625 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        1625 :                 return false;</span></span>
<span id="L4351"><span class="lineNum">    4351</span>                 :             :             }</span>
<span id="L4352"><span class="lineNum">    4352</span>         [<span class="tlaGBC" title="Branch 0 was taken 1512 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 161718 times"> + </span>]:<span class="tlaGNC">      163230 :             if (ppindex) {</span></span>
<span id="L4353"><span class="lineNum">    4353</span>                 :<span class="tlaGNC">        1512 :                 *ppindex = pindex;</span></span>
<span id="L4354"><span class="lineNum">    4354</span>                 :             :             }</span>
<span id="L4355"><span class="lineNum">    4355</span>                 :             :         }</span>
<span id="L4356"><span class="lineNum">    4356</span>                 :<span class="tlaGNC">        1625 :     }</span></span>
<span id="L4357"><span class="lineNum">    4357</span>         [<span class="tlaGBC" title="Branch 0 was taken 161624 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 1537 times"> + </span>]:<span class="tlaGNC">      163161 :     if (NotifyHeaderTip()) {</span></span>
<span id="L4358"><span class="lineNum">    4358</span>   [<span class="tlaGBC" title="Branch 0 was taken 139000 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 22624 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 139000 times"> + </span> :<span class="tlaGNC">      161624 :         if (IsInitialBlockDownload() &amp;&amp; ppindex &amp;&amp; *ppindex) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L4359"><span class="lineNum">    4359</span>                 :<span class="tlaUNC">           0 :             const CBlockIndex&amp; last_accepted{**ppindex};</span></span>
<span id="L4360"><span class="lineNum">    4360</span>                 :<span class="tlaUNC">           0 :             int64_t blocks_left{(NodeClock::now() - last_accepted.Time()) / GetConsensus().PowTargetSpacing()};</span></span>
<span id="L4361"><span class="lineNum">    4361</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             blocks_left = std::max&lt;int64_t&gt;(0, blocks_left);</span></span>
<span id="L4362"><span class="lineNum">    4362</span>                 :<span class="tlaUNC">           0 :             const double progress{100.0 * last_accepted.nHeight / (last_accepted.nHeight + blocks_left)};</span></span>
<span id="L4363"><span class="lineNum">    4363</span>                 :<span class="tlaUNC">           0 :             LogInfo(&quot;Synchronizing blockheaders, height: %d (~%.2f%%)\n&quot;, last_accepted.nHeight, progress);</span></span>
<span id="L4364"><span class="lineNum">    4364</span>                 :             :         }</span>
<span id="L4365"><span class="lineNum">    4365</span>                 :             :     }</span>
<span id="L4366"><span class="lineNum">    4366</span>                 :             :     return true;</span>
<span id="L4367"><span class="lineNum">    4367</span>                 :             : }</span>
<span id="L4368"><span class="lineNum">    4368</span>                 :             : </span>
<span id="L4369"><span class="lineNum">    4369</span>                 :<span class="tlaGNC">        8972 : void ChainstateManager::ReportHeadersPresync(const arith_uint256&amp; work, int64_t height, int64_t timestamp)</span></span>
<span id="L4370"><span class="lineNum">    4370</span>                 :             : {</span>
<span id="L4371"><span class="lineNum">    4371</span>                 :<span class="tlaGNC">        8972 :     AssertLockNotHeld(GetMutex());</span></span>
<span id="L4372"><span class="lineNum">    4372</span>                 :<span class="tlaGNC">        8972 :     {</span></span>
<span id="L4373"><span class="lineNum">    4373</span>                 :<span class="tlaGNC">        8972 :         LOCK(GetMutex());</span></span>
<span id="L4374"><span class="lineNum">    4374</span>                 :             :         // Don't report headers presync progress if we already have a post-minchainwork header chain.</span>
<span id="L4375"><span class="lineNum">    4375</span>                 :             :         // This means we lose reporting for potentially legitimate, but unlikely, deep reorgs, but</span>
<span id="L4376"><span class="lineNum">    4376</span>                 :             :         // prevent attackers that spam low-work headers from filling our logs.</span>
<span id="L4377"><span class="lineNum">    4377</span>   [<span class="tlaGBC" title="Branch 0 was taken 8972 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 8972 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">        8972 :         if (m_best_header-&gt;nChainWork &gt;= UintToArith256(GetConsensus().nMinimumChainWork)) return;</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 8972 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L4378"><span class="lineNum">    4378</span>                 :             :         // Rate limit headers presync updates to 4 per second, as these are not subject to DoS</span>
<span id="L4379"><span class="lineNum">    4379</span>                 :             :         // protection.</span>
<span id="L4380"><span class="lineNum">    4380</span>                 :<span class="tlaGNC">        8972 :         auto now = MockableSteadyClock::now();</span></span>
<span id="L4381"><span class="lineNum">    4381</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 8972 times"> + </span>]:<span class="tlaGNC">        8972 :         if (now &lt; m_last_presync_update + std::chrono::milliseconds{250}) return;</span></span>
<span id="L4382"><span class="lineNum">    4382</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         m_last_presync_update = now;</span></span>
<span id="L4383"><span class="lineNum">    4383</span>                 :<span class="tlaGNC">        8972 :     }</span></span>
<span id="L4384"><span class="lineNum">    4384</span>                 :<span class="tlaUNC">           0 :     bool initial_download = IsInitialBlockDownload();</span></span>
<span id="L4385"><span class="lineNum">    4385</span>                 :<span class="tlaUNC">           0 :     GetNotifications().headerTip(GetSynchronizationState(initial_download, m_blockman.m_blockfiles_indexed), height, timestamp, /*presync=*/true);</span></span>
<span id="L4386"><span class="lineNum">    4386</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (initial_download) {</span></span>
<span id="L4387"><span class="lineNum">    4387</span>                 :<span class="tlaUNC">           0 :         int64_t blocks_left{(NodeClock::now() - NodeSeconds{std::chrono::seconds{timestamp}}) / GetConsensus().PowTargetSpacing()};</span></span>
<span id="L4388"><span class="lineNum">    4388</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         blocks_left = std::max&lt;int64_t&gt;(0, blocks_left);</span></span>
<span id="L4389"><span class="lineNum">    4389</span>                 :<span class="tlaUNC">           0 :         const double progress{100.0 * height / (height + blocks_left)};</span></span>
<span id="L4390"><span class="lineNum">    4390</span>                 :<span class="tlaUNC">           0 :         LogInfo(&quot;Pre-synchronizing blockheaders, height: %d (~%.2f%%)\n&quot;, height, progress);</span></span>
<span id="L4391"><span class="lineNum">    4391</span>                 :             :     }</span>
<span id="L4392"><span class="lineNum">    4392</span>                 :             : }</span>
<span id="L4393"><span class="lineNum">    4393</span>                 :             : </span>
<span id="L4394"><span class="lineNum">    4394</span>                 :             : /** Store block on disk. If dbp is non-nullptr, the file is known to already reside on disk */</span>
<span id="L4395"><span class="lineNum">    4395</span>                 :<span class="tlaGNC">      352610 : bool ChainstateManager::AcceptBlock(const std::shared_ptr&lt;const CBlock&gt;&amp; pblock, BlockValidationState&amp; state, CBlockIndex** ppindex, bool fRequested, const FlatFilePos* dbp, bool* fNewBlock, bool min_pow_checked)</span></span>
<span id="L4396"><span class="lineNum">    4396</span>                 :             : {</span>
<span id="L4397"><span class="lineNum">    4397</span>         [<span class="tlaGBC" title="Branch 0 was taken 249654 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 102956 times"> + </span>]:<span class="tlaGNC">      352610 :     const CBlock&amp; block = *pblock;</span></span>
<span id="L4398"><span class="lineNum">    4398</span>                 :             : </span>
<span id="L4399"><span class="lineNum">    4399</span>         [<span class="tlaGBC" title="Branch 0 was taken 249654 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 102956 times"> + </span>]:<span class="tlaGNC">      352610 :     if (fNewBlock) *fNewBlock = false;</span></span>
<span id="L4400"><span class="lineNum">    4400</span>                 :<span class="tlaGNC">      352610 :     AssertLockHeld(cs_main);</span></span>
<span id="L4401"><span class="lineNum">    4401</span>                 :             : </span>
<span id="L4402"><span class="lineNum">    4402</span>                 :<span class="tlaGNC">      352610 :     CBlockIndex *pindexDummy = nullptr;</span></span>
<span id="L4403"><span class="lineNum">    4403</span>         [<span class="tlaGBC" title="Branch 0 was taken 249654 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 102956 times"> + </span>]:<span class="tlaGNC">      352610 :     CBlockIndex *&amp;pindex = ppindex ? *ppindex : pindexDummy;</span></span>
<span id="L4404"><span class="lineNum">    4404</span>                 :             : </span>
<span id="L4405"><span class="lineNum">    4405</span>                 :<span class="tlaGNC">      352610 :     bool accepted_header{AcceptBlockHeader(block, state, &amp;pindex, min_pow_checked)};</span></span>
<span id="L4406"><span class="lineNum">    4406</span>                 :<span class="tlaGNC">      352610 :     CheckBlockIndex();</span></span>
<span id="L4407"><span class="lineNum">    4407</span>                 :             : </span>
<span id="L4408"><span class="lineNum">    4408</span>         [<span class="tlaGBC" title="Branch 0 was taken 237735 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 114875 times"> + </span>]:<span class="tlaGNC">      352610 :     if (!accepted_header)</span></span>
<span id="L4409"><span class="lineNum">    4409</span>                 :             :         return false;</span>
<span id="L4410"><span class="lineNum">    4410</span>                 :             : </span>
<span id="L4411"><span class="lineNum">    4411</span>                 :             :     // Check all requested blocks that we do not already have for validity and</span>
<span id="L4412"><span class="lineNum">    4412</span>                 :             :     // save them to disk. Skip processing of unrequested blocks as an anti-DoS</span>
<span id="L4413"><span class="lineNum">    4413</span>                 :             :     // measure, unless the blocks have more work than the active chain tip, and</span>
<span id="L4414"><span class="lineNum">    4414</span>                 :             :     // aren't too far ahead of it, so are likely to be attached soon.</span>
<span id="L4415"><span class="lineNum">    4415</span>                 :<span class="tlaGNC">      237735 :     bool fAlreadyHave = pindex-&gt;nStatus &amp; BLOCK_HAVE_DATA;</span></span>
<span id="L4416"><span class="lineNum">    4416</span>   [<span class="tlaGBC" title="Branch 0 was taken 237735 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 237735 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      237735 :     bool fHasMoreOrSameWork = (ActiveTip() ? pindex-&gt;nChainWork &gt;= ActiveTip()-&gt;nChainWork : true);</span></span>
<span id="L4417"><span class="lineNum">    4417</span>                 :             :     // Blocks that are too out-of-order needlessly limit the effectiveness of</span>
<span id="L4418"><span class="lineNum">    4418</span>                 :             :     // pruning, because pruning will not delete block files that contain any</span>
<span id="L4419"><span class="lineNum">    4419</span>                 :             :     // blocks which are too close in height to the tip.  Apply this test</span>
<span id="L4420"><span class="lineNum">    4420</span>                 :             :     // regardless of whether pruning is enabled; it should generally be safe to</span>
<span id="L4421"><span class="lineNum">    4421</span>                 :             :     // not process unrequested blocks.</span>
<span id="L4422"><span class="lineNum">    4422</span>                 :<span class="tlaGNC">      237735 :     bool fTooFarAhead{pindex-&gt;nHeight &gt; ActiveHeight() + int(MIN_BLOCKS_TO_KEEP)};</span></span>
<span id="L4423"><span class="lineNum">    4423</span>                 :             : </span>
<span id="L4424"><span class="lineNum">    4424</span>                 :             :     // TODO: Decouple this function from the block download logic by removing fRequested</span>
<span id="L4425"><span class="lineNum">    4425</span>                 :             :     // This requires some new chain data structure to efficiently look up if a</span>
<span id="L4426"><span class="lineNum">    4426</span>                 :             :     // block is in a chain leading to a candidate for best tip, despite not</span>
<span id="L4427"><span class="lineNum">    4427</span>                 :             :     // being such a candidate itself.</span>
<span id="L4428"><span class="lineNum">    4428</span>                 :             :     // Note that this would break the getblockfrompeer RPC</span>
<span id="L4429"><span class="lineNum">    4429</span>                 :             : </span>
<span id="L4430"><span class="lineNum">    4430</span>                 :             :     // TODO: deal better with return value and error conditions for duplicate</span>
<span id="L4431"><span class="lineNum">    4431</span>                 :             :     // and unrequested blocks.</span>
<span id="L4432"><span class="lineNum">    4432</span>         [<span class="tlaGBC" title="Branch 0 was taken 237735 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      237735 :     if (fAlreadyHave) return true;</span></span>
<span id="L4433"><span class="lineNum">    4433</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 237735 times"> + </span>]:<span class="tlaGNC">      237735 :     if (!fRequested) {  // If we didn't ask for it:</span></span>
<span id="L4434"><span class="lineNum">    4434</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (pindex-&gt;nTx != 0) return true;    // This is a previously-processed block that was pruned</span></span>
<span id="L4435"><span class="lineNum">    4435</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!fHasMoreOrSameWork) return true; // Don't process less-work chains</span></span>
<span id="L4436"><span class="lineNum">    4436</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (fTooFarAhead) return true;        // Block height is too high</span></span>
<span id="L4437"><span class="lineNum">    4437</span>                 :             : </span>
<span id="L4438"><span class="lineNum">    4438</span>                 :             :         // Protect against DoS attacks from low-work chains.</span>
<span id="L4439"><span class="lineNum">    4439</span>                 :             :         // If our tip is behind, a peer could try to send us</span>
<span id="L4440"><span class="lineNum">    4440</span>                 :             :         // low-work blocks on a fake chain that we would never</span>
<span id="L4441"><span class="lineNum">    4441</span>                 :             :         // request; don't process these.</span>
<span id="L4442"><span class="lineNum">    4442</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (pindex-&gt;nChainWork &lt; MinimumChainWork()) return true;</span></span>
<span id="L4443"><span class="lineNum">    4443</span>                 :             :     }</span>
<span id="L4444"><span class="lineNum">    4444</span>                 :             : </span>
<span id="L4445"><span class="lineNum">    4445</span>                 :<span class="tlaGNC">      237735 :     const CChainParams&amp; params{GetParams()};</span></span>
<span id="L4446"><span class="lineNum">    4446</span>                 :             : </span>
<span id="L4447"><span class="lineNum">    4447</span>   [<span class="tlaGBC" title="Branch 0 was taken 213126 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 24609 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 213126 times"> + </span>]:<span class="tlaGNC">      450861 :     if (!CheckBlock(block, state, params.GetConsensus()) ||</span></span>
<span id="L4448"><span class="lineNum">    4448</span>                 :<span class="tlaGNC">      213126 :         !ContextualCheckBlock(block, state, *this, pindex-&gt;pprev)) {</span></span>
<span id="L4449"><span class="lineNum">    4449</span>         [<span class="tlaGBC" title="Branch 0 was taken 24609 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       24609 :         if (Assume(state.IsInvalid())) {</span></span>
<span id="L4450"><span class="lineNum">    4450</span>                 :<span class="tlaGNC">       24609 :             ActiveChainstate().InvalidBlockFound(pindex, state);</span></span>
<span id="L4451"><span class="lineNum">    4451</span>                 :             :         }</span>
<span id="L4452"><span class="lineNum">    4452</span>         [<span class="tlaGBC" title="Branch 0 was taken 24609 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       24609 :         LogError(&quot;%s: %s\n&quot;, __func__, state.ToString());</span></span>
<span id="L4453"><span class="lineNum">    4453</span>                 :<span class="tlaGNC">       24609 :         return false;</span></span>
<span id="L4454"><span class="lineNum">    4454</span>                 :             :     }</span>
<span id="L4455"><span class="lineNum">    4455</span>                 :             : </span>
<span id="L4456"><span class="lineNum">    4456</span>                 :             :     // Header is valid/has work, merkle tree and segwit merkle tree are good...RELAY NOW</span>
<span id="L4457"><span class="lineNum">    4457</span>                 :             :     // (but if it does not build on our best tip, let the SendMessages loop relay it)</span>
<span id="L4458"><span class="lineNum">    4458</span>   [<span class="tlaGBC" title="Branch 0 was taken 88833 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 124293 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 88833 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      213126 :     if (!IsInitialBlockDownload() &amp;&amp; ActiveTip() == pindex-&gt;pprev &amp;&amp; m_options.signals) {</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 88833 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L4459"><span class="lineNum">    4459</span>                 :<span class="tlaGNC">       88833 :         m_options.signals-&gt;NewPoWValidBlock(pindex, pblock);</span></span>
<span id="L4460"><span class="lineNum">    4460</span>                 :             :     }</span>
<span id="L4461"><span class="lineNum">    4461</span>                 :             : </span>
<span id="L4462"><span class="lineNum">    4462</span>                 :             :     // Write block to history file</span>
<span id="L4463"><span class="lineNum">    4463</span>         [<span class="tlaGBC" title="Branch 0 was taken 213126 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      213126 :     if (fNewBlock) *fNewBlock = true;</span></span>
<span id="L4464"><span class="lineNum">    4464</span>                 :<span class="tlaGNC">      213126 :     try {</span></span>
<span id="L4465"><span class="lineNum">    4465</span>                 :<span class="tlaGNC">      213126 :         FlatFilePos blockPos{};</span></span>
<span id="L4466"><span class="lineNum">    4466</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 213126 times"> + </span>]:<span class="tlaGNC">      213126 :         if (dbp) {</span></span>
<span id="L4467"><span class="lineNum">    4467</span>                 :<span class="tlaUNC">           0 :             blockPos = *dbp;</span></span>
<span id="L4468"><span class="lineNum">    4468</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             m_blockman.UpdateBlockInfo(block, pindex-&gt;nHeight, blockPos);</span></span>
<span id="L4469"><span class="lineNum">    4469</span>                 :             :         } else {</span>
<span id="L4470"><span class="lineNum">    4470</span>         [<span class="tlaGBC" title="Branch 0 was taken 213126 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      213126 :             blockPos = m_blockman.WriteBlock(block, pindex-&gt;nHeight);</span></span>
<span id="L4471"><span class="lineNum">    4471</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 213126 times"> + </span>]:<span class="tlaGNC">      213126 :             if (blockPos.IsNull()) {</span></span>
<span id="L4472"><span class="lineNum">    4472</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 state.Error(strprintf(&quot;%s: Failed to find position to write new block to disk&quot;, __func__));</span></span>
<span id="L4473"><span class="lineNum">    4473</span>                 :<span class="tlaUNC">           0 :                 return false;</span></span>
<span id="L4474"><span class="lineNum">    4474</span>                 :             :             }</span>
<span id="L4475"><span class="lineNum">    4475</span>                 :             :         }</span>
<span id="L4476"><span class="lineNum">    4476</span>         [<span class="tlaGBC" title="Branch 0 was taken 213126 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      213126 :         ReceivedBlockTransactions(block, pindex, blockPos);</span></span>
<span id="L4477"><span class="lineNum">    4477</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaUNC">           0 :     } catch (const std::runtime_error&amp; e) {</span></span>
<span id="L4478"><span class="lineNum">    4478</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaUNC">           0 :         return FatalError(GetNotifications(), state, strprintf(_(&quot;System error while saving block to disk: %s&quot;), e.what()));</span></span>
<span id="L4479"><span class="lineNum">    4479</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L4480"><span class="lineNum">    4480</span>                 :             : </span>
<span id="L4481"><span class="lineNum">    4481</span>                 :             :     // TODO: FlushStateToDisk() handles flushing of both block and chainstate</span>
<span id="L4482"><span class="lineNum">    4482</span>                 :             :     // data, so we should move this to ChainstateManager so that we can be more</span>
<span id="L4483"><span class="lineNum">    4483</span>                 :             :     // intelligent about how we flush.</span>
<span id="L4484"><span class="lineNum">    4484</span>                 :             :     // For now, since FlushStateMode::NONE is used, all that can happen is that</span>
<span id="L4485"><span class="lineNum">    4485</span>                 :             :     // the block files may be pruned, so we can just call this on one</span>
<span id="L4486"><span class="lineNum">    4486</span>                 :             :     // chainstate (particularly if we haven't implemented pruning with</span>
<span id="L4487"><span class="lineNum">    4487</span>                 :             :     // background validation yet).</span>
<span id="L4488"><span class="lineNum">    4488</span>                 :<span class="tlaGNC">      213126 :     ActiveChainstate().FlushStateToDisk(state, FlushStateMode::NONE);</span></span>
<span id="L4489"><span class="lineNum">    4489</span>                 :             : </span>
<span id="L4490"><span class="lineNum">    4490</span>                 :<span class="tlaGNC">      213126 :     CheckBlockIndex();</span></span>
<span id="L4491"><span class="lineNum">    4491</span>                 :             : </span>
<span id="L4492"><span class="lineNum">    4492</span>                 :<span class="tlaGNC">      213126 :     return true;</span></span>
<span id="L4493"><span class="lineNum">    4493</span>                 :             : }</span>
<span id="L4494"><span class="lineNum">    4494</span>                 :             : </span>
<span id="L4495"><span class="lineNum">    4495</span>                 :<span class="tlaGNC">      258276 : bool ChainstateManager::ProcessNewBlock(const std::shared_ptr&lt;const CBlock&gt;&amp; block, bool force_processing, bool min_pow_checked, bool* new_block)</span></span>
<span id="L4496"><span class="lineNum">    4496</span>                 :             : {</span>
<span id="L4497"><span class="lineNum">    4497</span>                 :<span class="tlaGNC">      258276 :     AssertLockNotHeld(cs_main);</span></span>
<span id="L4498"><span class="lineNum">    4498</span>                 :             : </span>
<span id="L4499"><span class="lineNum">    4499</span>                 :<span class="tlaGNC">      258276 :     {</span></span>
<span id="L4500"><span class="lineNum">    4500</span>                 :<span class="tlaGNC">      258276 :         CBlockIndex *pindex = nullptr;</span></span>
<span id="L4501"><span class="lineNum">    4501</span>         [<span class="tlaGBC" title="Branch 0 was taken 258276 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      258276 :         if (new_block) *new_block = false;</span></span>
<span id="L4502"><span class="lineNum">    4502</span>         [<span class="tlaGBC" title="Branch 0 was taken 258276 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      258276 :         BlockValidationState state;</span></span>
<span id="L4503"><span class="lineNum">    4503</span>                 :             : </span>
<span id="L4504"><span class="lineNum">    4504</span>                 :             :         // CheckBlock() does not support multi-threaded block validation because CBlock::fChecked can cause data race.</span>
<span id="L4505"><span class="lineNum">    4505</span>                 :             :         // Therefore, the following critical section must include the CheckBlock() call as well.</span>
<span id="L4506"><span class="lineNum">    4506</span>         [<span class="tlaGBC" title="Branch 0 was taken 258276 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      258276 :         LOCK(cs_main);</span></span>
<span id="L4507"><span class="lineNum">    4507</span>                 :             : </span>
<span id="L4508"><span class="lineNum">    4508</span>                 :             :         // Skipping AcceptBlock() for CheckBlock() failures means that we will never mark a block as invalid if</span>
<span id="L4509"><span class="lineNum">    4509</span>                 :             :         // CheckBlock() fails.  This is protective against consensus failure if there are any unknown forms of block</span>
<span id="L4510"><span class="lineNum">    4510</span>                 :             :         // malleability that cause CheckBlock() to fail; see e.g. CVE-2012-2459 and</span>
<span id="L4511"><span class="lineNum">    4511</span>                 :             :         // https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2019-February/016697.html.  Because CheckBlock() is</span>
<span id="L4512"><span class="lineNum">    4512</span>                 :             :         // not very expensive, the anti-DoS benefits of caching failure (of a definitely-invalid block) are not substantial.</span>
<span id="L4513"><span class="lineNum">    4513</span>         [<span class="tlaGBC" title="Branch 0 was taken 258276 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      258276 :         bool ret = CheckBlock(*block, state, GetConsensus());</span></span>
<span id="L4514"><span class="lineNum">    4514</span>         [<span class="tlaGBC" title="Branch 0 was taken 249654 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 8622 times"> + </span>]:<span class="tlaGNC">      258276 :         if (ret) {</span></span>
<span id="L4515"><span class="lineNum">    4515</span>                 :             :             // Store to disk</span>
<span id="L4516"><span class="lineNum">    4516</span>         [<span class="tlaGBC" title="Branch 0 was taken 249654 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      249654 :             ret = AcceptBlock(block, state, &amp;pindex, force_processing, nullptr, new_block, min_pow_checked);</span></span>
<span id="L4517"><span class="lineNum">    4517</span>                 :             :         }</span>
<span id="L4518"><span class="lineNum">    4518</span>         [<span class="tlaGBC" title="Branch 0 was taken 36528 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 213126 times"> + </span>]:<span class="tlaGNC">      249654 :         if (!ret) {</span></span>
<span id="L4519"><span class="lineNum">    4519</span>         [<span class="tlaGBC" title="Branch 0 was taken 26170 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 18980 times"> + </span>]:<span class="tlaGNC">       45150 :             if (m_options.signals) {</span></span>
<span id="L4520"><span class="lineNum">    4520</span>         [<span class="tlaGBC" title="Branch 0 was taken 26170 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       26170 :                 m_options.signals-&gt;BlockChecked(block, state);</span></span>
<span id="L4521"><span class="lineNum">    4521</span>                 :             :             }</span>
<span id="L4522"><span class="lineNum">    4522</span>   [<span class="tlaGBC" title="Branch 0 was taken 45150 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 45150 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">       45150 :             LogError(&quot;%s: AcceptBlock FAILED (%s)\n&quot;, __func__, state.ToString());</span></span>
<span id="L4523"><span class="lineNum">    4523</span>         [<span class="tlaGBC" title="Branch 0 was taken 45150 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       45150 :             return false;</span></span>
<span id="L4524"><span class="lineNum">    4524</span>                 :             :         }</span>
<span id="L4525"><span class="lineNum">    4525</span>                 :<span class="tlaGNC">      303426 :     }</span></span>
<span id="L4526"><span class="lineNum">    4526</span>                 :             : </span>
<span id="L4527"><span class="lineNum">    4527</span>                 :<span class="tlaGNC">      213126 :     NotifyHeaderTip();</span></span>
<span id="L4528"><span class="lineNum">    4528</span>                 :             : </span>
<span id="L4529"><span class="lineNum">    4529</span>         [<span class="tlaGBC" title="Branch 0 was taken 213126 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      213126 :     BlockValidationState state; // Only used to report errors, not invalidity - ignore it</span></span>
<span id="L4530"><span class="lineNum">    4530</span>   [<span class="tlaGBC" title="Branch 0 was taken 213126 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 213126 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      639378 :     if (!ActiveChainstate().ActivateBestChain(state, block)) {</span></span>
<span class="lineNum">        </span> <span class="tlaGBC" title="Branch 4 was taken 213126 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaGBC" title="Branch 6 was taken 213126 times"> + </span><span class="tlaUNC" title="Branch 7 was not taken"> - </span><span class="tlaUNC" title="Branch 8 was not taken"> - </span> 
<span class="lineNum">        </span>             <span class="tlaGBC" title="Branch 9 was taken 213126 times"> + </span>]
<span id="L4531"><span class="lineNum">    4531</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LogError(&quot;%s: ActivateBestChain failed (%s)\n&quot;, __func__, state.ToString());</span></span>
<span id="L4532"><span class="lineNum">    4532</span>                 :<span class="tlaUNC">           0 :         return false;</span></span>
<span id="L4533"><span class="lineNum">    4533</span>                 :             :     }</span>
<span id="L4534"><span class="lineNum">    4534</span>                 :             : </span>
<span id="L4535"><span class="lineNum">    4535</span>   [<span class="tlaGBC" title="Branch 0 was taken 213126 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 213126 times"> + </span>]:<span class="tlaGNC">      426252 :     Chainstate* bg_chain{WITH_LOCK(cs_main, return BackgroundSyncInProgress() ? m_ibd_chainstate.get() : nullptr)};</span></span>
<span id="L4536"><span class="lineNum">    4536</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 213126 times"> + </span>]:<span class="tlaGNC">      213126 :     BlockValidationState bg_state;</span></span>
<span id="L4537"><span class="lineNum">    4537</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 213126 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      213126 :     if (bg_chain &amp;&amp; !bg_chain-&gt;ActivateBestChain(bg_state, block)) {</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaUNC" title="Branch 6 was not taken"> - </span><span class="tlaUNC" title="Branch 7 was not taken"> - </span><span class="tlaUNC" title="Branch 8 was not taken"> - </span> 
<span class="lineNum">        </span>             <span class="tlaGBC" title="Branch 9 was taken 213126 times"> + </span>]
<span id="L4538"><span class="lineNum">    4538</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LogError(&quot;%s: [background] ActivateBestChain failed (%s)\n&quot;, __func__, bg_state.ToString());</span></span>
<span id="L4539"><span class="lineNum">    4539</span>                 :<span class="tlaUNC">           0 :         return false;</span></span>
<span id="L4540"><span class="lineNum">    4540</span>                 :             :      }</span>
<span id="L4541"><span class="lineNum">    4541</span>                 :             : </span>
<span id="L4542"><span class="lineNum">    4542</span>                 :             :     return true;</span>
<span id="L4543"><span class="lineNum">    4543</span>                 :<span class="tlaGNC">      426252 : }</span></span>
<span id="L4544"><span class="lineNum">    4544</span>                 :             : </span>
<span id="L4545"><span class="lineNum">    4545</span>                 :<span class="tlaGNC">       10283 : MempoolAcceptResult ChainstateManager::ProcessTransaction(const CTransactionRef&amp; tx, bool test_accept)</span></span>
<span id="L4546"><span class="lineNum">    4546</span>                 :             : {</span>
<span id="L4547"><span class="lineNum">    4547</span>                 :<span class="tlaGNC">       10283 :     AssertLockHeld(cs_main);</span></span>
<span id="L4548"><span class="lineNum">    4548</span>                 :<span class="tlaGNC">       10283 :     Chainstate&amp; active_chainstate = ActiveChainstate();</span></span>
<span id="L4549"><span class="lineNum">    4549</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 10283 times"> + </span>]:<span class="tlaGNC">       10283 :     if (!active_chainstate.GetMempool()) {</span></span>
<span id="L4550"><span class="lineNum">    4550</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         TxValidationState state;</span></span>
<span id="L4551"><span class="lineNum">    4551</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         state.Invalid(TxValidationResult::TX_NO_MEMPOOL, &quot;no-mempool&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L4552"><span class="lineNum">    4552</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         return MempoolAcceptResult::Failure(state);</span></span>
<span id="L4553"><span class="lineNum">    4553</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L4554"><span class="lineNum">    4554</span>                 :<span class="tlaGNC">       10283 :     auto result = AcceptToMemoryPool(active_chainstate, tx, GetTime(), /*bypass_limits=*/ false, test_accept);</span></span>
<span id="L4555"><span class="lineNum">    4555</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 10283 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 10283 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">       10283 :     active_chainstate.GetMempool()-&gt;check(active_chainstate.CoinsTip(), active_chainstate.m_chain.Height() + 1);</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 10283 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L4556"><span class="lineNum">    4556</span>         [<span class="tlaGBC" title="Branch 0 was taken 10283 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       10283 :     return result;</span></span>
<span id="L4557"><span class="lineNum">    4557</span>                 :<span class="tlaGNC">       10283 : }</span></span>
<span id="L4558"><span class="lineNum">    4558</span>                 :             : </span>
<span id="L4559"><span class="lineNum">    4559</span>                 :             : </span>
<span id="L4560"><span class="lineNum">    4560</span>                 :<span class="tlaGNC">      249083 : BlockValidationState TestBlockValidity(</span></span>
<span id="L4561"><span class="lineNum">    4561</span>                 :             :     Chainstate&amp; chainstate,</span>
<span id="L4562"><span class="lineNum">    4562</span>                 :             :     const CBlock&amp; block,</span>
<span id="L4563"><span class="lineNum">    4563</span>                 :             :     const bool check_pow,</span>
<span id="L4564"><span class="lineNum">    4564</span>                 :             :     const bool check_merkle_root)</span>
<span id="L4565"><span class="lineNum">    4565</span>                 :             : {</span>
<span id="L4566"><span class="lineNum">    4566</span>                 :             :     // Lock must be held throughout this function for two reasons:</span>
<span id="L4567"><span class="lineNum">    4567</span>                 :             :     // 1. We don't want the tip to change during several of the validation steps</span>
<span id="L4568"><span class="lineNum">    4568</span>                 :             :     // 2. To prevent a CheckBlock() race condition for fChecked, see ProcessNewBlock()</span>
<span id="L4569"><span class="lineNum">    4569</span>                 :<span class="tlaGNC">      249083 :     AssertLockHeld(chainstate.m_chainman.GetMutex());</span></span>
<span id="L4570"><span class="lineNum">    4570</span>                 :             : </span>
<span id="L4571"><span class="lineNum">    4571</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 249083 times"> + </span>]:<span class="tlaGNC">      249083 :     BlockValidationState state;</span></span>
<span id="L4572"><span class="lineNum">    4572</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 249083 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 249083 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      498166 :     CBlockIndex* tip{Assert(chainstate.m_chain.Tip())};</span></span>
<span id="L4573"><span class="lineNum">    4573</span>                 :             : </span>
<span id="L4574"><span class="lineNum">    4574</span>   [<span class="tlaGBC" title="Branch 0 was taken 249083 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 249083 times"> + </span>]:<span class="tlaGNC">      249083 :     if (block.hashPrevBlock != *Assert(tip-&gt;phashBlock)) {</span></span>
<span id="L4575"><span class="lineNum">    4575</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         state.Invalid({}, &quot;inconclusive-not-best-prevblk&quot;);</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L4576"><span class="lineNum">    4576</span>                 :<span class="tlaUNC">           0 :         return state;</span></span>
<span id="L4577"><span class="lineNum">    4577</span>                 :             :     }</span>
<span id="L4578"><span class="lineNum">    4578</span>                 :             : </span>
<span id="L4579"><span class="lineNum">    4579</span>                 :             :     // For signets CheckBlock() verifies the challenge iff fCheckPow is set.</span>
<span id="L4580"><span class="lineNum">    4580</span>   [<span class="tlaGBC" title="Branch 0 was taken 249083 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 249083 times"> + </span>]:<span class="tlaGNC">      249083 :     if (!CheckBlock(block, state, chainstate.m_chainman.GetConsensus(), /*fCheckPow=*/check_pow, /*fCheckMerkleRoot=*/check_merkle_root)) {</span></span>
<span id="L4581"><span class="lineNum">    4581</span>                 :             :         // This should never happen, but belt-and-suspenders don't approve the</span>
<span id="L4582"><span class="lineNum">    4582</span>                 :             :         // block if it does.</span>
<span id="L4583"><span class="lineNum">    4583</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (state.IsValid()) NONFATAL_UNREACHABLE();</span></span>
<span id="L4584"><span class="lineNum">    4584</span>                 :             :         return state;</span>
<span id="L4585"><span class="lineNum">    4585</span>                 :             :     }</span>
<span id="L4586"><span class="lineNum">    4586</span>                 :             : </span>
<span id="L4587"><span class="lineNum">    4587</span>                 :             :     /**</span>
<span id="L4588"><span class="lineNum">    4588</span>                 :             :      * At this point ProcessNewBlock would call AcceptBlock(), but we</span>
<span id="L4589"><span class="lineNum">    4589</span>                 :             :      * don't want to store the block or its header. Run individual checks</span>
<span id="L4590"><span class="lineNum">    4590</span>                 :             :      * instead:</span>
<span id="L4591"><span class="lineNum">    4591</span>                 :             :      * - skip AcceptBlockHeader() because:</span>
<span id="L4592"><span class="lineNum">    4592</span>                 :             :      *   - we don't want to update the block index</span>
<span id="L4593"><span class="lineNum">    4593</span>                 :             :      *   - we do not care about duplicates</span>
<span id="L4594"><span class="lineNum">    4594</span>                 :             :      *   - we already ran CheckBlockHeader() via CheckBlock()</span>
<span id="L4595"><span class="lineNum">    4595</span>                 :             :      *   - we already checked for prev-blk-not-found</span>
<span id="L4596"><span class="lineNum">    4596</span>                 :             :      *   - we know the tip is valid, so no need to check bad-prevblk</span>
<span id="L4597"><span class="lineNum">    4597</span>                 :             :      * - we already ran CheckBlock()</span>
<span id="L4598"><span class="lineNum">    4598</span>                 :             :      * - do run ContextualCheckBlockHeader()</span>
<span id="L4599"><span class="lineNum">    4599</span>                 :             :      * - do run ContextualCheckBlock()</span>
<span id="L4600"><span class="lineNum">    4600</span>                 :             :      */</span>
<span id="L4601"><span class="lineNum">    4601</span>                 :             : </span>
<span id="L4602"><span class="lineNum">    4602</span>   [<span class="tlaGBC" title="Branch 0 was taken 249083 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 249083 times"> + </span>]:<span class="tlaGNC">      249083 :     if (!ContextualCheckBlockHeader(block, state, chainstate.m_blockman, chainstate.m_chainman, tip)) {</span></span>
<span id="L4603"><span class="lineNum">    4603</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (state.IsValid()) NONFATAL_UNREACHABLE();</span></span>
<span id="L4604"><span class="lineNum">    4604</span>                 :             :         return state;</span>
<span id="L4605"><span class="lineNum">    4605</span>                 :             :     }</span>
<span id="L4606"><span class="lineNum">    4606</span>                 :             : </span>
<span id="L4607"><span class="lineNum">    4607</span>   [<span class="tlaGBC" title="Branch 0 was taken 249083 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 249083 times"> + </span>]:<span class="tlaGNC">      249083 :     if (!ContextualCheckBlock(block, state, chainstate.m_chainman, tip)) {</span></span>
<span id="L4608"><span class="lineNum">    4608</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (state.IsValid()) NONFATAL_UNREACHABLE();</span></span>
<span id="L4609"><span class="lineNum">    4609</span>                 :             :         return state;</span>
<span id="L4610"><span class="lineNum">    4610</span>                 :             :     }</span>
<span id="L4611"><span class="lineNum">    4611</span>                 :             : </span>
<span id="L4612"><span class="lineNum">    4612</span>                 :             :     // We don't want ConnectBlock to update the actual chainstate, so create</span>
<span id="L4613"><span class="lineNum">    4613</span>                 :             :     // a cache on top of it, along with a dummy block index.</span>
<span id="L4614"><span class="lineNum">    4614</span>                 :<span class="tlaGNC">      249083 :     CBlockIndex index_dummy{block};</span></span>
<span id="L4615"><span class="lineNum">    4615</span>         [<span class="tlaGBC" title="Branch 0 was taken 249083 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      249083 :     uint256 block_hash(block.GetHash());</span></span>
<span id="L4616"><span class="lineNum">    4616</span>                 :<span class="tlaGNC">      249083 :     index_dummy.pprev = tip;</span></span>
<span id="L4617"><span class="lineNum">    4617</span>                 :<span class="tlaGNC">      249083 :     index_dummy.nHeight = tip-&gt;nHeight + 1;</span></span>
<span id="L4618"><span class="lineNum">    4618</span>                 :<span class="tlaGNC">      249083 :     index_dummy.phashBlock = &amp;block_hash;</span></span>
<span id="L4619"><span class="lineNum">    4619</span>   [<span class="tlaGBC" title="Branch 0 was taken 249083 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 249083 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      249083 :     CCoinsViewCache view_dummy(&amp;chainstate.CoinsTip());</span></span>
<span id="L4620"><span class="lineNum">    4620</span>                 :             : </span>
<span id="L4621"><span class="lineNum">    4621</span>                 :             :     // Set fJustCheck to true in order to update, and not clear, validation caches.</span>
<span id="L4622"><span class="lineNum">    4622</span>   [<span class="tlaGBC" title="Branch 0 was taken 249083 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 249083 times"> + </span>]:<span class="tlaGNC">      249083 :     if(!chainstate.ConnectBlock(block, state, &amp;index_dummy, view_dummy, /*fJustCheck=*/true)) {</span></span>
<span id="L4623"><span class="lineNum">    4623</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (state.IsValid()) NONFATAL_UNREACHABLE();</span></span>
<span id="L4624"><span class="lineNum">    4624</span>                 :             :         return state;</span>
<span id="L4625"><span class="lineNum">    4625</span>                 :             :     }</span>
<span id="L4626"><span class="lineNum">    4626</span>                 :             : </span>
<span id="L4627"><span class="lineNum">    4627</span>                 :             :     // Ensure no check returned successfully while also setting an invalid state.</span>
<span id="L4628"><span class="lineNum">    4628</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 249083 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      249083 :     if (!state.IsValid()) NONFATAL_UNREACHABLE();</span></span>
<span id="L4629"><span class="lineNum">    4629</span>                 :             : </span>
<span id="L4630"><span class="lineNum">    4630</span>                 :             :     return state;</span>
<span id="L4631"><span class="lineNum">    4631</span>                 :<span class="tlaGNC">      249083 : }</span></span>
<span id="L4632"><span class="lineNum">    4632</span>                 :             : </span>
<span id="L4633"><span class="lineNum">    4633</span>                 :             : /* This function is called from the RPC code for pruneblockchain */</span>
<span id="L4634"><span class="lineNum">    4634</span>                 :<span class="tlaUNC">           0 : void PruneBlockFilesManual(Chainstate&amp; active_chainstate, int nManualPruneHeight)</span></span>
<span id="L4635"><span class="lineNum">    4635</span>                 :             : {</span>
<span id="L4636"><span class="lineNum">    4636</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     BlockValidationState state;</span></span>
<span id="L4637"><span class="lineNum">    4637</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!active_chainstate.FlushStateToDisk(</span></span>
<span id="L4638"><span class="lineNum">    4638</span>                 :             :             state, FlushStateMode::NONE, nManualPruneHeight)) {</span>
<span id="L4639"><span class="lineNum">    4639</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LogPrintf(&quot;%s: failed to flush state (%s)\n&quot;, __func__, state.ToString());</span></span>
<span id="L4640"><span class="lineNum">    4640</span>                 :             :     }</span>
<span id="L4641"><span class="lineNum">    4641</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L4642"><span class="lineNum">    4642</span>                 :             : </span>
<span id="L4643"><span class="lineNum">    4643</span>                 :<span class="tlaGNC">          56 : bool Chainstate::LoadChainTip()</span></span>
<span id="L4644"><span class="lineNum">    4644</span>                 :             : {</span>
<span id="L4645"><span class="lineNum">    4645</span>                 :<span class="tlaGNC">          56 :     AssertLockHeld(cs_main);</span></span>
<span id="L4646"><span class="lineNum">    4646</span>                 :<span class="tlaGNC">          56 :     const CCoinsViewCache&amp; coins_cache = CoinsTip();</span></span>
<span id="L4647"><span class="lineNum">    4647</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 56 times"> + </span>]:<span class="tlaGNC">         112 :     assert(!coins_cache.GetBestBlock().IsNull()); // Never called when the coins view is empty</span></span>
<span id="L4648"><span class="lineNum">    4648</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 56 times"> + </span>]:<span class="tlaGNC">          56 :     const CBlockIndex* tip = m_chain.Tip();</span></span>
<span id="L4649"><span class="lineNum">    4649</span>                 :             : </span>
<span id="L4650"><span class="lineNum">    4650</span>   [<span class="tlaGBC" title="Branch 0 was taken 56 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 56 times"> + </span>]:<span class="tlaGNC">          56 :     if (tip &amp;&amp; tip-&gt;GetBlockHash() == coins_cache.GetBestBlock()) {</span></span>
<span id="L4651"><span class="lineNum">    4651</span>                 :             :         return true;</span>
<span id="L4652"><span class="lineNum">    4652</span>                 :             :     }</span>
<span id="L4653"><span class="lineNum">    4653</span>                 :             : </span>
<span id="L4654"><span class="lineNum">    4654</span>                 :             :     // Load pointer to end of best chain</span>
<span id="L4655"><span class="lineNum">    4655</span>                 :<span class="tlaUNC">           0 :     CBlockIndex* pindex = m_blockman.LookupBlockIndex(coins_cache.GetBestBlock());</span></span>
<span id="L4656"><span class="lineNum">    4656</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!pindex) {</span></span>
<span id="L4657"><span class="lineNum">    4657</span>                 :             :         return false;</span>
<span id="L4658"><span class="lineNum">    4658</span>                 :             :     }</span>
<span id="L4659"><span class="lineNum">    4659</span>                 :<span class="tlaUNC">           0 :     m_chain.SetTip(*pindex);</span></span>
<span id="L4660"><span class="lineNum">    4660</span>                 :<span class="tlaUNC">           0 :     PruneBlockIndexCandidates();</span></span>
<span id="L4661"><span class="lineNum">    4661</span>                 :             : </span>
<span id="L4662"><span class="lineNum">    4662</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     tip = m_chain.Tip();</span></span>
<span id="L4663"><span class="lineNum">    4663</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     LogInfo(&quot;Loaded best chain: hashBestChain=%s height=%d date=%s progress=%f&quot;,</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L4664"><span class="lineNum">    4664</span>                 :             :               tip-&gt;GetBlockHash().ToString(),</span>
<span id="L4665"><span class="lineNum">    4665</span>                 :             :               m_chain.Height(),</span>
<span id="L4666"><span class="lineNum">    4666</span>                 :             :               FormatISO8601DateTime(tip-&gt;GetBlockTime()),</span>
<span id="L4667"><span class="lineNum">    4667</span>                 :             :               m_chainman.GuessVerificationProgress(tip));</span>
<span id="L4668"><span class="lineNum">    4668</span>                 :             : </span>
<span id="L4669"><span class="lineNum">    4669</span>                 :             :     // Ensure KernelNotifications m_tip_block is set even if no new block arrives.</span>
<span id="L4670"><span class="lineNum">    4670</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (this-&gt;GetRole() != ChainstateRole::BACKGROUND) {</span></span>
<span id="L4671"><span class="lineNum">    4671</span>                 :             :         // Ignoring return value for now.</span>
<span id="L4672"><span class="lineNum">    4672</span>                 :<span class="tlaUNC">           0 :         (void)m_chainman.GetNotifications().blockTip(</span></span>
<span id="L4673"><span class="lineNum">    4673</span>                 :<span class="tlaUNC">           0 :             /*state=*/GetSynchronizationState(/*init=*/true, m_chainman.m_blockman.m_blockfiles_indexed),</span></span>
<span id="L4674"><span class="lineNum">    4674</span>                 :             :             /*index=*/*pindex,</span>
<span id="L4675"><span class="lineNum">    4675</span>                 :             :             /*verification_progress=*/m_chainman.GuessVerificationProgress(tip));</span>
<span id="L4676"><span class="lineNum">    4676</span>                 :             :     }</span>
<span id="L4677"><span class="lineNum">    4677</span>                 :             : </span>
<span id="L4678"><span class="lineNum">    4678</span>                 :             :     return true;</span>
<span id="L4679"><span class="lineNum">    4679</span>                 :             : }</span>
<span id="L4680"><span class="lineNum">    4680</span>                 :             : </span>
<span id="L4681"><span class="lineNum">    4681</span>                 :<span class="tlaGNC">           6 : CVerifyDB::CVerifyDB(Notifications&amp; notifications)</span></span>
<span id="L4682"><span class="lineNum">    4682</span>                 :<span class="tlaGNC">           6 :     : m_notifications{notifications}</span></span>
<span id="L4683"><span class="lineNum">    4683</span>                 :             : {</span>
<span id="L4684"><span class="lineNum">    4684</span>         [<span class="tlaGBC" title="Branch 0 was taken 6 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">           6 :     m_notifications.progress(_(&quot;Verifying blocks&quot;), 0, false);</span></span>
<span id="L4685"><span class="lineNum">    4685</span>                 :<span class="tlaGNC">           6 : }</span></span>
<span id="L4686"><span class="lineNum">    4686</span>                 :             : </span>
<span id="L4687"><span class="lineNum">    4687</span>                 :<span class="tlaGNC">           6 : CVerifyDB::~CVerifyDB()</span></span>
<span id="L4688"><span class="lineNum">    4688</span>                 :             : {</span>
<span id="L4689"><span class="lineNum">    4689</span>                 :<span class="tlaGNC">           6 :     m_notifications.progress(bilingual_str{}, 100, false);</span></span>
<span id="L4690"><span class="lineNum">    4690</span>                 :<span class="tlaGNC">           6 : }</span></span>
<span id="L4691"><span class="lineNum">    4691</span>                 :             : </span>
<span id="L4692"><span class="lineNum">    4692</span>                 :<span class="tlaGNC">           6 : VerifyDBResult CVerifyDB::VerifyDB(</span></span>
<span id="L4693"><span class="lineNum">    4693</span>                 :             :     Chainstate&amp; chainstate,</span>
<span id="L4694"><span class="lineNum">    4694</span>                 :             :     const Consensus::Params&amp; consensus_params,</span>
<span id="L4695"><span class="lineNum">    4695</span>                 :             :     CCoinsView&amp; coinsview,</span>
<span id="L4696"><span class="lineNum">    4696</span>                 :             :     int nCheckLevel, int nCheckDepth)</span>
<span id="L4697"><span class="lineNum">    4697</span>                 :             : {</span>
<span id="L4698"><span class="lineNum">    4698</span>                 :<span class="tlaGNC">           6 :     AssertLockHeld(cs_main);</span></span>
<span id="L4699"><span class="lineNum">    4699</span>                 :             : </span>
<span id="L4700"><span class="lineNum">    4700</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 6 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 6 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">          12 :     if (chainstate.m_chain.Tip() == nullptr || chainstate.m_chain.Tip()-&gt;pprev == nullptr) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaGBC" title="Branch 5 was taken 6 times"> + </span>]
<span id="L4701"><span class="lineNum">    4701</span>                 :             :         return VerifyDBResult::SUCCESS;</span>
<span id="L4702"><span class="lineNum">    4702</span>                 :             :     }</span>
<span id="L4703"><span class="lineNum">    4703</span>                 :             : </span>
<span id="L4704"><span class="lineNum">    4704</span>                 :             :     // Verify blocks in the best chain</span>
<span id="L4705"><span class="lineNum">    4705</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (nCheckDepth &lt;= 0 || nCheckDepth &gt; chainstate.m_chain.Height()) {</span></span>
<span id="L4706"><span class="lineNum">    4706</span>                 :<span class="tlaUNC">           0 :         nCheckDepth = chainstate.m_chain.Height();</span></span>
<span id="L4707"><span class="lineNum">    4707</span>                 :             :     }</span>
<span id="L4708"><span class="lineNum">    4708</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     nCheckLevel = std::max(0, std::min(4, nCheckLevel));</span></span>
<span id="L4709"><span class="lineNum">    4709</span>                 :<span class="tlaUNC">           0 :     LogInfo(&quot;Verifying last %i blocks at level %i&quot;, nCheckDepth, nCheckLevel);</span></span>
<span id="L4710"><span class="lineNum">    4710</span>                 :<span class="tlaUNC">           0 :     CCoinsViewCache coins(&amp;coinsview);</span></span>
<span id="L4711"><span class="lineNum">    4711</span>                 :<span class="tlaUNC">           0 :     CBlockIndex* pindex;</span></span>
<span id="L4712"><span class="lineNum">    4712</span>                 :<span class="tlaUNC">           0 :     CBlockIndex* pindexFailure = nullptr;</span></span>
<span id="L4713"><span class="lineNum">    4713</span>                 :<span class="tlaUNC">           0 :     int nGoodTransactions = 0;</span></span>
<span id="L4714"><span class="lineNum">    4714</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     BlockValidationState state;</span></span>
<span id="L4715"><span class="lineNum">    4715</span>                 :<span class="tlaUNC">           0 :     int reportDone = 0;</span></span>
<span id="L4716"><span class="lineNum">    4716</span>                 :<span class="tlaUNC">           0 :     bool skipped_no_block_data{false};</span></span>
<span id="L4717"><span class="lineNum">    4717</span>                 :<span class="tlaUNC">           0 :     bool skipped_l3_checks{false};</span></span>
<span id="L4718"><span class="lineNum">    4718</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     LogInfo(&quot;Verification progress: 0%%&quot;);</span></span>
<span id="L4719"><span class="lineNum">    4719</span>                 :             : </span>
<span id="L4720"><span class="lineNum">    4720</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     const bool is_snapshot_cs{chainstate.m_from_snapshot_blockhash};</span></span>
<span id="L4721"><span class="lineNum">    4721</span>                 :             : </span>
<span id="L4722"><span class="lineNum">    4722</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     for (pindex = chainstate.m_chain.Tip(); pindex &amp;&amp; pindex-&gt;pprev; pindex = pindex-&gt;pprev) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L4723"><span class="lineNum">    4723</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         const int percentageDone = std::max(1, std::min(99, (int)(((double)(chainstate.m_chain.Height() - pindex-&gt;nHeight)) / (double)nCheckDepth * (nCheckLevel &gt;= 4 ? 50 : 100))));</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L4724"><span class="lineNum">    4724</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (reportDone &lt; percentageDone / 10) {</span></span>
<span id="L4725"><span class="lineNum">    4725</span>                 :             :             // report every 10% step</span>
<span id="L4726"><span class="lineNum">    4726</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             LogInfo(&quot;Verification progress: %d%%&quot;, percentageDone);</span></span>
<span id="L4727"><span class="lineNum">    4727</span>                 :<span class="tlaUNC">           0 :             reportDone = percentageDone / 10;</span></span>
<span id="L4728"><span class="lineNum">    4728</span>                 :             :         }</span>
<span id="L4729"><span class="lineNum">    4729</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         m_notifications.progress(_(&quot;Verifying blocks&quot;), percentageDone, false);</span></span>
<span id="L4730"><span class="lineNum">    4730</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (pindex-&gt;nHeight &lt;= chainstate.m_chain.Height() - nCheckDepth) {</span></span>
<span id="L4731"><span class="lineNum">    4731</span>                 :             :             break;</span>
<span id="L4732"><span class="lineNum">    4732</span>                 :             :         }</span>
<span id="L4733"><span class="lineNum">    4733</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         if ((chainstate.m_blockman.IsPruneMode() || is_snapshot_cs) &amp;&amp; !(pindex-&gt;nStatus &amp; BLOCK_HAVE_DATA)) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L4734"><span class="lineNum">    4734</span>                 :             :             // If pruning or running under an assumeutxo snapshot, only go</span>
<span id="L4735"><span class="lineNum">    4735</span>                 :             :             // back as far as we have data.</span>
<span id="L4736"><span class="lineNum">    4736</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             LogInfo(&quot;Block verification stopping at height %d (no data). This could be due to pruning or use of an assumeutxo snapshot.&quot;, pindex-&gt;nHeight);</span></span>
<span id="L4737"><span class="lineNum">    4737</span>                 :             :             skipped_no_block_data = true;</span>
<span id="L4738"><span class="lineNum">    4738</span>                 :             :             break;</span>
<span id="L4739"><span class="lineNum">    4739</span>                 :             :         }</span>
<span id="L4740"><span class="lineNum">    4740</span>                 :<span class="tlaUNC">           0 :         CBlock block;</span></span>
<span id="L4741"><span class="lineNum">    4741</span>                 :             :         // check level 0: read from disk</span>
<span id="L4742"><span class="lineNum">    4742</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!chainstate.m_blockman.ReadBlock(block, *pindex)) {</span></span>
<span id="L4743"><span class="lineNum">    4743</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             LogPrintf(&quot;Verification error: ReadBlock failed at %d, hash=%s\n&quot;, pindex-&gt;nHeight, pindex-&gt;GetBlockHash().ToString());</span></span>
<span id="L4744"><span class="lineNum">    4744</span>                 :<span class="tlaUNC">           0 :             return VerifyDBResult::CORRUPTED_BLOCK_DB;</span></span>
<span id="L4745"><span class="lineNum">    4745</span>                 :             :         }</span>
<span id="L4746"><span class="lineNum">    4746</span>                 :             :         // check level 1: verify block validity</span>
<span id="L4747"><span class="lineNum">    4747</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         if (nCheckLevel &gt;= 1 &amp;&amp; !CheckBlock(block, state, consensus_params)) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L4748"><span class="lineNum">    4748</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             LogPrintf(&quot;Verification error: found bad block at %d, hash=%s (%s)\n&quot;,</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L4749"><span class="lineNum">    4749</span>                 :             :                       pindex-&gt;nHeight, pindex-&gt;GetBlockHash().ToString(), state.ToString());</span>
<span id="L4750"><span class="lineNum">    4750</span>                 :<span class="tlaUNC">           0 :             return VerifyDBResult::CORRUPTED_BLOCK_DB;</span></span>
<span id="L4751"><span class="lineNum">    4751</span>                 :             :         }</span>
<span id="L4752"><span class="lineNum">    4752</span>                 :             :         // check level 2: verify undo validity</span>
<span id="L4753"><span class="lineNum">    4753</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (nCheckLevel &gt;= 2 &amp;&amp; pindex) {</span></span>
<span id="L4754"><span class="lineNum">    4754</span>                 :<span class="tlaUNC">           0 :             CBlockUndo undo;</span></span>
<span id="L4755"><span class="lineNum">    4755</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (!pindex-&gt;GetUndoPos().IsNull()) {</span></span>
<span id="L4756"><span class="lineNum">    4756</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 if (!chainstate.m_blockman.ReadBlockUndo(undo, *pindex)) {</span></span>
<span id="L4757"><span class="lineNum">    4757</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     LogPrintf(&quot;Verification error: found bad undo data at %d, hash=%s\n&quot;, pindex-&gt;nHeight, pindex-&gt;GetBlockHash().ToString());</span></span>
<span id="L4758"><span class="lineNum">    4758</span>                 :<span class="tlaUNC">           0 :                     return VerifyDBResult::CORRUPTED_BLOCK_DB;</span></span>
<span id="L4759"><span class="lineNum">    4759</span>                 :             :                 }</span>
<span id="L4760"><span class="lineNum">    4760</span>                 :             :             }</span>
<span id="L4761"><span class="lineNum">    4761</span>                 :<span class="tlaUNC">           0 :         }</span></span>
<span id="L4762"><span class="lineNum">    4762</span>                 :             :         // check level 3: check for inconsistencies during memory-only disconnect of tip blocks</span>
<span id="L4763"><span class="lineNum">    4763</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         size_t curr_coins_usage = coins.DynamicMemoryUsage() + chainstate.CoinsTip().DynamicMemoryUsage();</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L4764"><span class="lineNum">    4764</span>                 :             : </span>
<span id="L4765"><span class="lineNum">    4765</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (nCheckLevel &gt;= 3) {</span></span>
<span id="L4766"><span class="lineNum">    4766</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (curr_coins_usage &lt;= chainstate.m_coinstip_cache_size_bytes) {</span></span>
<span id="L4767"><span class="lineNum">    4767</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 assert(coins.GetBestBlock() == pindex-&gt;GetBlockHash());</span></span>
<span id="L4768"><span class="lineNum">    4768</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 DisconnectResult res = chainstate.DisconnectBlock(block, pindex, coins);</span></span>
<span id="L4769"><span class="lineNum">    4769</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 if (res == DISCONNECT_FAILED) {</span></span>
<span id="L4770"><span class="lineNum">    4770</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     LogPrintf(&quot;Verification error: irrecoverable inconsistency in block data at %d, hash=%s\n&quot;, pindex-&gt;nHeight, pindex-&gt;GetBlockHash().ToString());</span></span>
<span id="L4771"><span class="lineNum">    4771</span>                 :<span class="tlaUNC">           0 :                     return VerifyDBResult::CORRUPTED_BLOCK_DB;</span></span>
<span id="L4772"><span class="lineNum">    4772</span>                 :             :                 }</span>
<span id="L4773"><span class="lineNum">    4773</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 if (res == DISCONNECT_UNCLEAN) {</span></span>
<span id="L4774"><span class="lineNum">    4774</span>                 :<span class="tlaUNC">           0 :                     nGoodTransactions = 0;</span></span>
<span id="L4775"><span class="lineNum">    4775</span>                 :<span class="tlaUNC">           0 :                     pindexFailure = pindex;</span></span>
<span id="L4776"><span class="lineNum">    4776</span>                 :             :                 } else {</span>
<span id="L4777"><span class="lineNum">    4777</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     nGoodTransactions += block.vtx.size();</span></span>
<span id="L4778"><span class="lineNum">    4778</span>                 :             :                 }</span>
<span id="L4779"><span class="lineNum">    4779</span>                 :             :             } else {</span>
<span id="L4780"><span class="lineNum">    4780</span>                 :             :                 skipped_l3_checks = true;</span>
<span id="L4781"><span class="lineNum">    4781</span>                 :             :             }</span>
<span id="L4782"><span class="lineNum">    4782</span>                 :             :         }</span>
<span id="L4783"><span class="lineNum">    4783</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (chainstate.m_chainman.m_interrupt) return VerifyDBResult::INTERRUPTED;</span></span>
<span id="L4784"><span class="lineNum">    4784</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L4785"><span class="lineNum">    4785</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (pindexFailure) {</span></span>
<span id="L4786"><span class="lineNum">    4786</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LogPrintf(&quot;Verification error: coin database inconsistencies found (last %i blocks, %i good transactions before that)\n&quot;, chainstate.m_chain.Height() - pindexFailure-&gt;nHeight + 1, nGoodTransactions);</span></span>
<span id="L4787"><span class="lineNum">    4787</span>                 :             :         return VerifyDBResult::CORRUPTED_BLOCK_DB;</span>
<span id="L4788"><span class="lineNum">    4788</span>                 :             :     }</span>
<span id="L4789"><span class="lineNum">    4789</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (skipped_l3_checks) {</span></span>
<span id="L4790"><span class="lineNum">    4790</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LogPrintf(&quot;Skipped verification of level &gt;=3 (insufficient database cache size). Consider increasing -dbcache.\n&quot;);</span></span>
<span id="L4791"><span class="lineNum">    4791</span>                 :             :     }</span>
<span id="L4792"><span class="lineNum">    4792</span>                 :             : </span>
<span id="L4793"><span class="lineNum">    4793</span>                 :             :     // store block count as we move pindex at check level &gt;= 4</span>
<span id="L4794"><span class="lineNum">    4794</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     int block_count = chainstate.m_chain.Height() - pindex-&gt;nHeight;</span></span>
<span id="L4795"><span class="lineNum">    4795</span>                 :             : </span>
<span id="L4796"><span class="lineNum">    4796</span>                 :             :     // check level 4: try reconnecting blocks</span>
<span id="L4797"><span class="lineNum">    4797</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (nCheckLevel &gt;= 4 &amp;&amp; !skipped_l3_checks) {</span></span>
<span id="L4798"><span class="lineNum">    4798</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         while (pindex != chainstate.m_chain.Tip()) {</span></span>
<span id="L4799"><span class="lineNum">    4799</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             const int percentageDone = std::max(1, std::min(99, 100 - (int)(((double)(chainstate.m_chain.Height() - pindex-&gt;nHeight)) / (double)nCheckDepth * 50)));</span></span>
<span id="L4800"><span class="lineNum">    4800</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (reportDone &lt; percentageDone / 10) {</span></span>
<span id="L4801"><span class="lineNum">    4801</span>                 :             :                 // report every 10% step</span>
<span id="L4802"><span class="lineNum">    4802</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 LogInfo(&quot;Verification progress: %d%%&quot;, percentageDone);</span></span>
<span id="L4803"><span class="lineNum">    4803</span>                 :<span class="tlaUNC">           0 :                 reportDone = percentageDone / 10;</span></span>
<span id="L4804"><span class="lineNum">    4804</span>                 :             :             }</span>
<span id="L4805"><span class="lineNum">    4805</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             m_notifications.progress(_(&quot;Verifying blocks&quot;), percentageDone, false);</span></span>
<span id="L4806"><span class="lineNum">    4806</span>                 :<span class="tlaUNC">           0 :             pindex = chainstate.m_chain.Next(pindex);</span></span>
<span id="L4807"><span class="lineNum">    4807</span>                 :<span class="tlaUNC">           0 :             CBlock block;</span></span>
<span id="L4808"><span class="lineNum">    4808</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (!chainstate.m_blockman.ReadBlock(block, *pindex)) {</span></span>
<span id="L4809"><span class="lineNum">    4809</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 LogPrintf(&quot;Verification error: ReadBlock failed at %d, hash=%s\n&quot;, pindex-&gt;nHeight, pindex-&gt;GetBlockHash().ToString());</span></span>
<span id="L4810"><span class="lineNum">    4810</span>                 :<span class="tlaUNC">           0 :                 return VerifyDBResult::CORRUPTED_BLOCK_DB;</span></span>
<span id="L4811"><span class="lineNum">    4811</span>                 :             :             }</span>
<span id="L4812"><span class="lineNum">    4812</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (!chainstate.ConnectBlock(block, state, pindex, coins)) {</span></span>
<span id="L4813"><span class="lineNum">    4813</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                 LogPrintf(&quot;Verification error: found unconnectable block at %d, hash=%s (%s)\n&quot;, pindex-&gt;nHeight, pindex-&gt;GetBlockHash().ToString(), state.ToString());</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L4814"><span class="lineNum">    4814</span>                 :<span class="tlaUNC">           0 :                 return VerifyDBResult::CORRUPTED_BLOCK_DB;</span></span>
<span id="L4815"><span class="lineNum">    4815</span>                 :             :             }</span>
<span id="L4816"><span class="lineNum">    4816</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (chainstate.m_chainman.m_interrupt) return VerifyDBResult::INTERRUPTED;</span></span>
<span id="L4817"><span class="lineNum">    4817</span>                 :<span class="tlaUNC">           0 :         }</span></span>
<span id="L4818"><span class="lineNum">    4818</span>                 :             :     }</span>
<span id="L4819"><span class="lineNum">    4819</span>                 :             : </span>
<span id="L4820"><span class="lineNum">    4820</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     LogInfo(&quot;Verification: No coin database inconsistencies in last %i blocks (%i transactions)&quot;, block_count, nGoodTransactions);</span></span>
<span id="L4821"><span class="lineNum">    4821</span>                 :             : </span>
<span id="L4822"><span class="lineNum">    4822</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (skipped_l3_checks) {</span></span>
<span id="L4823"><span class="lineNum">    4823</span>                 :             :         return VerifyDBResult::SKIPPED_L3_CHECKS;</span>
<span id="L4824"><span class="lineNum">    4824</span>                 :             :     }</span>
<span id="L4825"><span class="lineNum">    4825</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (skipped_no_block_data) {</span></span>
<span id="L4826"><span class="lineNum">    4826</span>                 :<span class="tlaUNC">           0 :         return VerifyDBResult::SKIPPED_MISSING_BLOCKS;</span></span>
<span id="L4827"><span class="lineNum">    4827</span>                 :             :     }</span>
<span id="L4828"><span class="lineNum">    4828</span>                 :             :     return VerifyDBResult::SUCCESS;</span>
<span id="L4829"><span class="lineNum">    4829</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L4830"><span class="lineNum">    4830</span>                 :             : </span>
<span id="L4831"><span class="lineNum">    4831</span>                 :             : /** Apply the effects of a block on the utxo cache, ignoring that it may already have been applied. */</span>
<span id="L4832"><span class="lineNum">    4832</span>                 :<span class="tlaUNC">           0 : bool Chainstate::RollforwardBlock(const CBlockIndex* pindex, CCoinsViewCache&amp; inputs)</span></span>
<span id="L4833"><span class="lineNum">    4833</span>                 :             : {</span>
<span id="L4834"><span class="lineNum">    4834</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(cs_main);</span></span>
<span id="L4835"><span class="lineNum">    4835</span>                 :             :     // TODO: merge with ConnectBlock</span>
<span id="L4836"><span class="lineNum">    4836</span>                 :<span class="tlaUNC">           0 :     CBlock block;</span></span>
<span id="L4837"><span class="lineNum">    4837</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!m_blockman.ReadBlock(block, *pindex)) {</span></span>
<span id="L4838"><span class="lineNum">    4838</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LogError(&quot;ReplayBlock(): ReadBlock failed at %d, hash=%s\n&quot;, pindex-&gt;nHeight, pindex-&gt;GetBlockHash().ToString());</span></span>
<span id="L4839"><span class="lineNum">    4839</span>                 :<span class="tlaUNC">           0 :         return false;</span></span>
<span id="L4840"><span class="lineNum">    4840</span>                 :             :     }</span>
<span id="L4841"><span class="lineNum">    4841</span>                 :             : </span>
<span id="L4842"><span class="lineNum">    4842</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (const CTransactionRef&amp; tx : block.vtx) {</span></span>
<span id="L4843"><span class="lineNum">    4843</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!tx-&gt;IsCoinBase()) {</span></span>
<span id="L4844"><span class="lineNum">    4844</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             for (const CTxIn &amp;txin : tx-&gt;vin) {</span></span>
<span id="L4845"><span class="lineNum">    4845</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 inputs.SpendCoin(txin.prevout);</span></span>
<span id="L4846"><span class="lineNum">    4846</span>                 :             :             }</span>
<span id="L4847"><span class="lineNum">    4847</span>                 :             :         }</span>
<span id="L4848"><span class="lineNum">    4848</span>                 :             :         // Pass check = true as every addition may be an overwrite.</span>
<span id="L4849"><span class="lineNum">    4849</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         AddCoins(inputs, *tx, pindex-&gt;nHeight, true);</span></span>
<span id="L4850"><span class="lineNum">    4850</span>                 :             :     }</span>
<span id="L4851"><span class="lineNum">    4851</span>                 :             :     return true;</span>
<span id="L4852"><span class="lineNum">    4852</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L4853"><span class="lineNum">    4853</span>                 :             : </span>
<span id="L4854"><span class="lineNum">    4854</span>                 :<span class="tlaGNC">        2960 : bool Chainstate::ReplayBlocks()</span></span>
<span id="L4855"><span class="lineNum">    4855</span>                 :             : {</span>
<span id="L4856"><span class="lineNum">    4856</span>                 :<span class="tlaGNC">        2960 :     LOCK(cs_main);</span></span>
<span id="L4857"><span class="lineNum">    4857</span>                 :             : </span>
<span id="L4858"><span class="lineNum">    4858</span>         [<span class="tlaGBC" title="Branch 0 was taken 2960 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        2960 :     CCoinsView&amp; db = this-&gt;CoinsDB();</span></span>
<span id="L4859"><span class="lineNum">    4859</span>         [<span class="tlaGBC" title="Branch 0 was taken 2960 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        2960 :     CCoinsViewCache cache(&amp;db);</span></span>
<span id="L4860"><span class="lineNum">    4860</span>                 :             : </span>
<span id="L4861"><span class="lineNum">    4861</span>         [<span class="tlaGBC" title="Branch 0 was taken 2960 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        2960 :     std::vector&lt;uint256&gt; hashHeads = db.GetHeadBlocks();</span></span>
<span id="L4862"><span class="lineNum">    4862</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 2960 times"> + </span>]:<span class="tlaGNC">        2960 :     if (hashHeads.empty()) return true; // We're already in a consistent state.</span></span>
<span id="L4863"><span class="lineNum">    4863</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (hashHeads.size() != 2) {</span></span>
<span id="L4864"><span class="lineNum">    4864</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LogError(&quot;ReplayBlocks(): unknown inconsistent state\n&quot;);</span></span>
<span id="L4865"><span class="lineNum">    4865</span>                 :             :         return false;</span>
<span id="L4866"><span class="lineNum">    4866</span>                 :             :     }</span>
<span id="L4867"><span class="lineNum">    4867</span>                 :             : </span>
<span id="L4868"><span class="lineNum">    4868</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     m_chainman.GetNotifications().progress(_(&quot;Replaying blocks&quot;), 0, false);</span></span>
<span id="L4869"><span class="lineNum">    4869</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     LogInfo(&quot;Replaying blocks&quot;);</span></span>
<span id="L4870"><span class="lineNum">    4870</span>                 :             : </span>
<span id="L4871"><span class="lineNum">    4871</span>                 :<span class="tlaUNC">           0 :     const CBlockIndex* pindexOld = nullptr;  // Old tip during the interrupted flush.</span></span>
<span id="L4872"><span class="lineNum">    4872</span>                 :<span class="tlaUNC">           0 :     const CBlockIndex* pindexNew;            // New tip during the interrupted flush.</span></span>
<span id="L4873"><span class="lineNum">    4873</span>                 :<span class="tlaUNC">           0 :     const CBlockIndex* pindexFork = nullptr; // Latest block common to both the old and the new tip.</span></span>
<span id="L4874"><span class="lineNum">    4874</span>                 :             : </span>
<span id="L4875"><span class="lineNum">    4875</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (m_blockman.m_block_index.count(hashHeads[0]) == 0) {</span></span>
<span id="L4876"><span class="lineNum">    4876</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LogError(&quot;ReplayBlocks(): reorganization to unknown block requested\n&quot;);</span></span>
<span id="L4877"><span class="lineNum">    4877</span>                 :             :         return false;</span>
<span id="L4878"><span class="lineNum">    4878</span>                 :             :     }</span>
<span id="L4879"><span class="lineNum">    4879</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     pindexNew = &amp;(m_blockman.m_block_index[hashHeads[0]]);</span></span>
<span id="L4880"><span class="lineNum">    4880</span>                 :             : </span>
<span id="L4881"><span class="lineNum">    4881</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!hashHeads[1].IsNull()) { // The old tip is allowed to be 0, indicating it's the first flush.</span></span>
<span id="L4882"><span class="lineNum">    4882</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (m_blockman.m_block_index.count(hashHeads[1]) == 0) {</span></span>
<span id="L4883"><span class="lineNum">    4883</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             LogError(&quot;ReplayBlocks(): reorganization from unknown block requested\n&quot;);</span></span>
<span id="L4884"><span class="lineNum">    4884</span>                 :             :             return false;</span>
<span id="L4885"><span class="lineNum">    4885</span>                 :             :         }</span>
<span id="L4886"><span class="lineNum">    4886</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         pindexOld = &amp;(m_blockman.m_block_index[hashHeads[1]]);</span></span>
<span id="L4887"><span class="lineNum">    4887</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         pindexFork = LastCommonAncestor(pindexOld, pindexNew);</span></span>
<span id="L4888"><span class="lineNum">    4888</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         assert(pindexFork != nullptr);</span></span>
<span id="L4889"><span class="lineNum">    4889</span>                 :             :     }</span>
<span id="L4890"><span class="lineNum">    4890</span>                 :             : </span>
<span id="L4891"><span class="lineNum">    4891</span>                 :             :     // Rollback along the old branch.</span>
<span id="L4892"><span class="lineNum">    4892</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     while (pindexOld != pindexFork) {</span></span>
<span id="L4893"><span class="lineNum">    4893</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (pindexOld-&gt;nHeight &gt; 0) { // Never disconnect the genesis block.</span></span>
<span id="L4894"><span class="lineNum">    4894</span>                 :<span class="tlaUNC">           0 :             CBlock block;</span></span>
<span id="L4895"><span class="lineNum">    4895</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (!m_blockman.ReadBlock(block, *pindexOld)) {</span></span>
<span id="L4896"><span class="lineNum">    4896</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 LogError(&quot;RollbackBlock(): ReadBlock() failed at %d, hash=%s\n&quot;, pindexOld-&gt;nHeight, pindexOld-&gt;GetBlockHash().ToString());</span></span>
<span id="L4897"><span class="lineNum">    4897</span>                 :<span class="tlaUNC">           0 :                 return false;</span></span>
<span id="L4898"><span class="lineNum">    4898</span>                 :             :             }</span>
<span id="L4899"><span class="lineNum">    4899</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             LogInfo(&quot;Rolling back %s (%i)&quot;, pindexOld-&gt;GetBlockHash().ToString(), pindexOld-&gt;nHeight);</span></span>
<span id="L4900"><span class="lineNum">    4900</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             DisconnectResult res = DisconnectBlock(block, pindexOld, cache);</span></span>
<span id="L4901"><span class="lineNum">    4901</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (res == DISCONNECT_FAILED) {</span></span>
<span id="L4902"><span class="lineNum">    4902</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 LogError(&quot;RollbackBlock(): DisconnectBlock failed at %d, hash=%s\n&quot;, pindexOld-&gt;nHeight, pindexOld-&gt;GetBlockHash().ToString());</span></span>
<span id="L4903"><span class="lineNum">    4903</span>                 :<span class="tlaUNC">           0 :                 return false;</span></span>
<span id="L4904"><span class="lineNum">    4904</span>                 :             :             }</span>
<span id="L4905"><span class="lineNum">    4905</span>                 :             :             // If DISCONNECT_UNCLEAN is returned, it means a non-existing UTXO was deleted, or an existing UTXO was</span>
<span id="L4906"><span class="lineNum">    4906</span>                 :             :             // overwritten. It corresponds to cases where the block-to-be-disconnect never had all its operations</span>
<span id="L4907"><span class="lineNum">    4907</span>                 :             :             // applied to the UTXO set. However, as both writing a UTXO and deleting a UTXO are idempotent operations,</span>
<span id="L4908"><span class="lineNum">    4908</span>                 :             :             // the result is still a version of the UTXO set with the effects of that block undone.</span>
<span id="L4909"><span class="lineNum">    4909</span>                 :<span class="tlaUNC">           0 :         }</span></span>
<span id="L4910"><span class="lineNum">    4910</span>                 :<span class="tlaUNC">           0 :         pindexOld = pindexOld-&gt;pprev;</span></span>
<span id="L4911"><span class="lineNum">    4911</span>                 :             :     }</span>
<span id="L4912"><span class="lineNum">    4912</span>                 :             : </span>
<span id="L4913"><span class="lineNum">    4913</span>                 :             :     // Roll forward from the forking point to the new tip.</span>
<span id="L4914"><span class="lineNum">    4914</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     int nForkHeight = pindexFork ? pindexFork-&gt;nHeight : 0;</span></span>
<span id="L4915"><span class="lineNum">    4915</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     for (int nHeight = nForkHeight + 1; nHeight &lt;= pindexNew-&gt;nHeight; ++nHeight) {</span></span>
<span id="L4916"><span class="lineNum">    4916</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         const CBlockIndex&amp; pindex{*Assert(pindexNew-&gt;GetAncestor(nHeight))};</span></span>
<span id="L4917"><span class="lineNum">    4917</span>                 :             : </span>
<span id="L4918"><span class="lineNum">    4918</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LogInfo(&quot;Rolling forward %s (%i)&quot;, pindex.GetBlockHash().ToString(), nHeight);</span></span>
<span id="L4919"><span class="lineNum">    4919</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         m_chainman.GetNotifications().progress(_(&quot;Replaying blocks&quot;), (int)((nHeight - nForkHeight) * 100.0 / (pindexNew-&gt;nHeight - nForkHeight)), false);</span></span>
<span id="L4920"><span class="lineNum">    4920</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!RollforwardBlock(&amp;pindex, cache)) return false;</span></span>
<span id="L4921"><span class="lineNum">    4921</span>                 :             :     }</span>
<span id="L4922"><span class="lineNum">    4922</span>                 :             : </span>
<span id="L4923"><span class="lineNum">    4923</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     cache.SetBestBlock(pindexNew-&gt;GetBlockHash());</span></span>
<span id="L4924"><span class="lineNum">    4924</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     cache.Flush();</span></span>
<span id="L4925"><span class="lineNum">    4925</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     m_chainman.GetNotifications().progress(bilingual_str{}, 100, false);</span></span>
<span id="L4926"><span class="lineNum">    4926</span>                 :<span class="tlaUNC">           0 :     return true;</span></span>
<span id="L4927"><span class="lineNum">    4927</span>         [<span class="tlaGBC" title="Branch 0 was taken 2960 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        5920 : }</span></span>
<span id="L4928"><span class="lineNum">    4928</span>                 :             : </span>
<span id="L4929"><span class="lineNum">    4929</span>                 :<span class="tlaGNC">        2960 : bool Chainstate::NeedsRedownload() const</span></span>
<span id="L4930"><span class="lineNum">    4930</span>                 :             : {</span>
<span id="L4931"><span class="lineNum">    4931</span>                 :<span class="tlaGNC">        2960 :     AssertLockHeld(cs_main);</span></span>
<span id="L4932"><span class="lineNum">    4932</span>                 :             : </span>
<span id="L4933"><span class="lineNum">    4933</span>                 :             :     // At and above m_params.SegwitHeight, segwit consensus rules must be validated</span>
<span id="L4934"><span class="lineNum">    4934</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 2960 times"> + </span>]:<span class="tlaGNC">        2960 :     CBlockIndex* block{m_chain.Tip()};</span></span>
<span id="L4935"><span class="lineNum">    4935</span>                 :             : </span>
<span id="L4936"><span class="lineNum">    4936</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 2960 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">        2960 :     while (block != nullptr &amp;&amp; DeploymentActiveAt(*block, m_chainman, Consensus::DEPLOYMENT_SEGWIT)) {</span></span>
<span id="L4937"><span class="lineNum">    4937</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!(block-&gt;nStatus &amp; BLOCK_OPT_WITNESS)) {</span></span>
<span id="L4938"><span class="lineNum">    4938</span>                 :             :             // block is insufficiently validated for a segwit client</span>
<span id="L4939"><span class="lineNum">    4939</span>                 :             :             return true;</span>
<span id="L4940"><span class="lineNum">    4940</span>                 :             :         }</span>
<span id="L4941"><span class="lineNum">    4941</span>                 :<span class="tlaUNC">           0 :         block = block-&gt;pprev;</span></span>
<span id="L4942"><span class="lineNum">    4942</span>                 :             :     }</span>
<span id="L4943"><span class="lineNum">    4943</span>                 :             : </span>
<span id="L4944"><span class="lineNum">    4944</span>                 :             :     return false;</span>
<span id="L4945"><span class="lineNum">    4945</span>                 :             : }</span>
<span id="L4946"><span class="lineNum">    4946</span>                 :             : </span>
<span id="L4947"><span class="lineNum">    4947</span>                 :<span class="tlaUNC">           0 : void Chainstate::ClearBlockIndexCandidates()</span></span>
<span id="L4948"><span class="lineNum">    4948</span>                 :             : {</span>
<span id="L4949"><span class="lineNum">    4949</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(::cs_main);</span></span>
<span id="L4950"><span class="lineNum">    4950</span>                 :<span class="tlaUNC">           0 :     setBlockIndexCandidates.clear();</span></span>
<span id="L4951"><span class="lineNum">    4951</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L4952"><span class="lineNum">    4952</span>                 :             : </span>
<span id="L4953"><span class="lineNum">    4953</span>                 :<span class="tlaGNC">        2960 : bool ChainstateManager::LoadBlockIndex()</span></span>
<span id="L4954"><span class="lineNum">    4954</span>                 :             : {</span>
<span id="L4955"><span class="lineNum">    4955</span>                 :<span class="tlaGNC">        2960 :     AssertLockHeld(cs_main);</span></span>
<span id="L4956"><span class="lineNum">    4956</span>                 :             :     // Load block index from databases</span>
<span id="L4957"><span class="lineNum">    4957</span>         [<span class="tlaGBC" title="Branch 0 was taken 2960 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        2960 :     if (m_blockman.m_blockfiles_indexed) {</span></span>
<span id="L4958"><span class="lineNum">    4958</span>                 :<span class="tlaGNC">        2960 :         bool ret{m_blockman.LoadBlockIndexDB(SnapshotBlockhash())};</span></span>
<span id="L4959"><span class="lineNum">    4959</span>         [<span class="tlaGBC" title="Branch 0 was taken 2960 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        2960 :         if (!ret) return false;</span></span>
<span id="L4960"><span class="lineNum">    4960</span>                 :             : </span>
<span id="L4961"><span class="lineNum">    4961</span>                 :<span class="tlaGNC">        2960 :         m_blockman.ScanAndUnlinkAlreadyPrunedFiles();</span></span>
<span id="L4962"><span class="lineNum">    4962</span>                 :             : </span>
<span id="L4963"><span class="lineNum">    4963</span>                 :<span class="tlaGNC">        2960 :         std::vector&lt;CBlockIndex*&gt; vSortedByHeight{m_blockman.GetAllBlockIndices()};</span></span>
<span id="L4964"><span class="lineNum">    4964</span>         [<span class="tlaGBC" title="Branch 0 was taken 2960 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        2960 :         std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),</span></span>
<span id="L4965"><span class="lineNum">    4965</span>                 :             :                   CBlockIndexHeightOnlyComparator());</span>
<span id="L4966"><span class="lineNum">    4966</span>                 :             : </span>
<span id="L4967"><span class="lineNum">    4967</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 2960 times"> + </span>]:<span class="tlaGNC">        2960 :         for (CBlockIndex* pindex : vSortedByHeight) {</span></span>
<span id="L4968"><span class="lineNum">    4968</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (m_interrupt) return false;</span></span>
<span id="L4969"><span class="lineNum">    4969</span>                 :             :             // If we have an assumeutxo-based chainstate, then the snapshot</span>
<span id="L4970"><span class="lineNum">    4970</span>                 :             :             // block will be a candidate for the tip, but it may not be</span>
<span id="L4971"><span class="lineNum">    4971</span>                 :             :             // VALID_TRANSACTIONS (eg if we haven't yet downloaded the block),</span>
<span id="L4972"><span class="lineNum">    4972</span>                 :             :             // so we special-case the snapshot block as a potential candidate</span>
<span id="L4973"><span class="lineNum">    4973</span>                 :             :             // here.</span>
<span id="L4974"><span class="lineNum">    4974</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (pindex == GetSnapshotBaseBlock() ||</span></span>
<span id="L4975"><span class="lineNum">    4975</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     (pindex-&gt;IsValid(BLOCK_VALID_TRANSACTIONS) &amp;&amp;</span></span>
<span id="L4976"><span class="lineNum">    4976</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                      (pindex-&gt;HaveNumChainTxs() || pindex-&gt;pprev == nullptr))) {</span></span>
<span id="L4977"><span class="lineNum">    4977</span>                 :             : </span>
<span id="L4978"><span class="lineNum">    4978</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 for (Chainstate* chainstate : GetAll()) {</span></span>
<span id="L4979"><span class="lineNum">    4979</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     chainstate-&gt;TryAddBlockIndexCandidate(pindex);</span></span>
<span id="L4980"><span class="lineNum">    4980</span>                 :             :                 }</span>
<span id="L4981"><span class="lineNum">    4981</span>                 :             :             }</span>
<span id="L4982"><span class="lineNum">    4982</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             if (pindex-&gt;nStatus &amp; BLOCK_FAILED_MASK &amp;&amp; (!m_best_invalid || pindex-&gt;nChainWork &gt; m_best_invalid-&gt;nChainWork)) {</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L4983"><span class="lineNum">    4983</span>                 :<span class="tlaUNC">           0 :                 m_best_invalid = pindex;</span></span>
<span id="L4984"><span class="lineNum">    4984</span>                 :             :             }</span>
<span id="L4985"><span class="lineNum">    4985</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             if (pindex-&gt;IsValid(BLOCK_VALID_TREE) &amp;&amp; (m_best_header == nullptr || CBlockIndexWorkComparator()(m_best_header, pindex)))</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not executed"> # </span>]
<span id="L4986"><span class="lineNum">    4986</span>                 :<span class="tlaUNC">           0 :                 m_best_header = pindex;</span></span>
<span id="L4987"><span class="lineNum">    4987</span>                 :             :         }</span>
<span id="L4988"><span class="lineNum">    4988</span>                 :<span class="tlaGNC">        2960 :     }</span></span>
<span id="L4989"><span class="lineNum">    4989</span>                 :             :     return true;</span>
<span id="L4990"><span class="lineNum">    4990</span>                 :             : }</span>
<span id="L4991"><span class="lineNum">    4991</span>                 :             : </span>
<span id="L4992"><span class="lineNum">    4992</span>                 :<span class="tlaGNC">        2960 : bool Chainstate::LoadGenesisBlock()</span></span>
<span id="L4993"><span class="lineNum">    4993</span>                 :             : {</span>
<span id="L4994"><span class="lineNum">    4994</span>                 :<span class="tlaGNC">        2960 :     LOCK(cs_main);</span></span>
<span id="L4995"><span class="lineNum">    4995</span>                 :             : </span>
<span id="L4996"><span class="lineNum">    4996</span>         [<span class="tlaGBC" title="Branch 0 was taken 2960 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        2960 :     const CChainParams&amp; params{m_chainman.GetParams()};</span></span>
<span id="L4997"><span class="lineNum">    4997</span>                 :             : </span>
<span id="L4998"><span class="lineNum">    4998</span>                 :             :     // Check whether we're already initialized by checking for genesis in</span>
<span id="L4999"><span class="lineNum">    4999</span>                 :             :     // m_blockman.m_block_index. Note that we can't use m_chain here, since it is</span>
<span id="L5000"><span class="lineNum">    5000</span>                 :             :     // set based on the coins db, not the block index db, which is the only</span>
<span id="L5001"><span class="lineNum">    5001</span>                 :             :     // thing loaded at this point.</span>
<span id="L5002"><span class="lineNum">    5002</span>   [<span class="tlaGBC" title="Branch 0 was taken 2960 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 2960 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">        5920 :     if (m_blockman.m_block_index.count(params.GenesisBlock().GetHash()))</span></span>
<span id="L5003"><span class="lineNum">    5003</span>                 :             :         return true;</span>
<span id="L5004"><span class="lineNum">    5004</span>                 :             : </span>
<span id="L5005"><span class="lineNum">    5005</span>                 :<span class="tlaGNC">        2960 :     try {</span></span>
<span id="L5006"><span class="lineNum">    5006</span>         [<span class="tlaGBC" title="Branch 0 was taken 2960 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        2960 :         const CBlock&amp; block = params.GenesisBlock();</span></span>
<span id="L5007"><span class="lineNum">    5007</span>         [<span class="tlaGBC" title="Branch 0 was taken 2960 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        2960 :         FlatFilePos blockPos{m_blockman.WriteBlock(block, 0)};</span></span>
<span id="L5008"><span class="lineNum">    5008</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 2960 times"> + </span>]:<span class="tlaGNC">        2960 :         if (blockPos.IsNull()) {</span></span>
<span id="L5009"><span class="lineNum">    5009</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             LogError(&quot;%s: writing genesis block to disk failed\n&quot;, __func__);</span></span>
<span id="L5010"><span class="lineNum">    5010</span>                 :             :             return false;</span>
<span id="L5011"><span class="lineNum">    5011</span>                 :             :         }</span>
<span id="L5012"><span class="lineNum">    5012</span>         [<span class="tlaGBC" title="Branch 0 was taken 2960 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        2960 :         CBlockIndex* pindex = m_blockman.AddToBlockIndex(block, m_chainman.m_best_header);</span></span>
<span id="L5013"><span class="lineNum">    5013</span>         [<span class="tlaGBC" title="Branch 0 was taken 2960 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        2960 :         m_chainman.ReceivedBlockTransactions(block, pindex, blockPos);</span></span>
<span id="L5014"><span class="lineNum">    5014</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaUNC">           0 :     } catch (const std::runtime_error&amp; e) {</span></span>
<span id="L5015"><span class="lineNum">    5015</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaUNC">           0 :         LogError(&quot;%s: failed to write genesis block: %s\n&quot;, __func__, e.what());</span></span>
<span id="L5016"><span class="lineNum">    5016</span>                 :<span class="tlaUNC">           0 :         return false;</span></span>
<span id="L5017"><span class="lineNum">    5017</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L5018"><span class="lineNum">    5018</span>                 :             : </span>
<span id="L5019"><span class="lineNum">    5019</span>                 :             :     return true;</span>
<span id="L5020"><span class="lineNum">    5020</span>                 :<span class="tlaGNC">        2960 : }</span></span>
<span id="L5021"><span class="lineNum">    5021</span>                 :             : </span>
<span id="L5022"><span class="lineNum">    5022</span>                 :<span class="tlaGNC">         860 : void ChainstateManager::LoadExternalBlockFile(</span></span>
<span id="L5023"><span class="lineNum">    5023</span>                 :             :     AutoFile&amp; file_in,</span>
<span id="L5024"><span class="lineNum">    5024</span>                 :             :     FlatFilePos* dbp,</span>
<span id="L5025"><span class="lineNum">    5025</span>                 :             :     std::multimap&lt;uint256, FlatFilePos&gt;* blocks_with_unknown_parent)</span>
<span id="L5026"><span class="lineNum">    5026</span>                 :             : {</span>
<span id="L5027"><span class="lineNum">    5027</span>                 :             :     // Either both should be specified (-reindex), or neither (-loadblock).</span>
<span id="L5028"><span class="lineNum">    5028</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 860 times"> + </span>]:<span class="tlaGNC">         860 :     assert(!dbp == !blocks_with_unknown_parent);</span></span>
<span id="L5029"><span class="lineNum">    5029</span>                 :             : </span>
<span id="L5030"><span class="lineNum">    5030</span>                 :<span class="tlaGNC">         860 :     const auto start{SteadyClock::now()};</span></span>
<span id="L5031"><span class="lineNum">    5031</span>         [<span class="tlaGBC" title="Branch 0 was taken 860 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">         860 :     const CChainParams&amp; params{GetParams()};</span></span>
<span id="L5032"><span class="lineNum">    5032</span>                 :             : </span>
<span id="L5033"><span class="lineNum">    5033</span>                 :<span class="tlaGNC">         860 :     int nLoaded = 0;</span></span>
<span id="L5034"><span class="lineNum">    5034</span>                 :<span class="tlaGNC">         860 :     try {</span></span>
<span id="L5035"><span class="lineNum">    5035</span>         [<span class="tlaGBC" title="Branch 0 was taken 860 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">         860 :         BufferedFile blkdat{file_in, 2 * MAX_BLOCK_SERIALIZED_SIZE, MAX_BLOCK_SERIALIZED_SIZE + 8};</span></span>
<span id="L5036"><span class="lineNum">    5036</span>                 :             :         // nRewind indicates where to resume scanning in case something goes wrong,</span>
<span id="L5037"><span class="lineNum">    5037</span>                 :             :         // such as a block fails to deserialize.</span>
<span id="L5038"><span class="lineNum">    5038</span>                 :<span class="tlaGNC">         860 :         uint64_t nRewind = blkdat.GetPos();</span></span>
<span id="L5039"><span class="lineNum">    5039</span>         [<span class="tlaGBC" title="Branch 0 was taken 2646721 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 357 times"> + </span>]:<span class="tlaGNC">     2647078 :         while (!blkdat.eof()) {</span></span>
<span id="L5040"><span class="lineNum">    5040</span>   [<span class="tlaGBC" title="Branch 0 was taken 2646721 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 2646721 times"> + </span>]:<span class="tlaGNC">     2646721 :             if (m_interrupt) return;</span></span>
<span id="L5041"><span class="lineNum">    5041</span>                 :             : </span>
<span id="L5042"><span class="lineNum">    5042</span>                 :<span class="tlaGNC">     2646721 :             blkdat.SetPos(nRewind);</span></span>
<span id="L5043"><span class="lineNum">    5043</span>                 :<span class="tlaGNC">     2646721 :             nRewind++; // start one byte further next time, in case of failure</span></span>
<span id="L5044"><span class="lineNum">    5044</span>         [<span class="tlaGBC" title="Branch 0 was taken 2646272 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 449 times"> + </span>]:<span class="tlaGNC">     2646721 :             blkdat.SetLimit(); // remove former limit</span></span>
<span id="L5045"><span class="lineNum">    5045</span>                 :<span class="tlaGNC">     2646721 :             unsigned int nSize = 0;</span></span>
<span id="L5046"><span class="lineNum">    5046</span>                 :<span class="tlaGNC">     2646721 :             try {</span></span>
<span id="L5047"><span class="lineNum">    5047</span>                 :             :                 // locate a header</span>
<span id="L5048"><span class="lineNum">    5048</span>                 :<span class="tlaGNC">     2646721 :                 MessageStartChars buf;</span></span>
<span id="L5049"><span class="lineNum">    5049</span>         [<span class="tlaGBC" title="Branch 0 was taken 2646272 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 449 times"> + </span>]:<span class="tlaGNC">     2646721 :                 blkdat.FindByte(std::byte(params.MessageStart()[0]));</span></span>
<span id="L5050"><span class="lineNum">    5050</span>         [<span class="tlaGBC" title="Branch 0 was taken 2646236 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 36 times"> + </span>]:<span class="tlaGNC">     2646272 :                 nRewind = blkdat.GetPos() + 1;</span></span>
<span id="L5051"><span class="lineNum">    5051</span>         [<span class="tlaGBC" title="Branch 0 was taken 2646236 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 36 times"> + </span>]:<span class="tlaGNC">     2646272 :                 blkdat &gt;&gt; buf;</span></span>
<span id="L5052"><span class="lineNum">    5052</span>         [<span class="tlaGBC" title="Branch 0 was taken 2139625 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 506611 times"> + </span>]:<span class="tlaGNC">     2646236 :                 if (buf != params.MessageStart()) {</span></span>
<span id="L5053"><span class="lineNum">    5053</span>                 :<span class="tlaGNC">     2139625 :                     continue;</span></span>
<span id="L5054"><span class="lineNum">    5054</span>                 :             :                 }</span>
<span id="L5055"><span class="lineNum">    5055</span>                 :             :                 // read size</span>
<span id="L5056"><span class="lineNum">    5056</span>         [<span class="tlaGBC" title="Branch 0 was taken 506593 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 18 times"> + </span>]:<span class="tlaGNC">      506611 :                 blkdat &gt;&gt; nSize;</span></span>
<span id="L5057"><span class="lineNum">    5057</span>         [<span class="tlaGBC" title="Branch 0 was taken 64308 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 442285 times"> + </span>]:<span class="tlaGNC">      506593 :                 if (nSize &lt; 80 || nSize &gt; MAX_BLOCK_SERIALIZED_SIZE)</span></span>
<span id="L5058"><span class="lineNum">    5058</span>                 :<span class="tlaGNC">       64308 :                     continue;</span></span>
<span id="L5059"><span class="lineNum">    5059</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 503 times"> + </span>]:<span class="tlaGNC">         503 :             } catch (const std::exception&amp;) {</span></span>
<span id="L5060"><span class="lineNum">    5060</span>                 :             :                 // no valid block header found; don't complain</span>
<span id="L5061"><span class="lineNum">    5061</span>                 :             :                 // (this happens at the end of every blk.dat file)</span>
<span id="L5062"><span class="lineNum">    5062</span>                 :<span class="tlaGNC">         503 :                 break;</span></span>
<span id="L5063"><span class="lineNum">    5063</span>                 :<span class="tlaGNC">         503 :             }</span></span>
<span id="L5064"><span class="lineNum">    5064</span>                 :<span class="tlaGNC">      442285 :             try {</span></span>
<span id="L5065"><span class="lineNum">    5065</span>                 :             :                 // read block header</span>
<span id="L5066"><span class="lineNum">    5066</span>         [<span class="tlaGBC" title="Branch 0 was taken 212823 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 229462 times"> + </span>]:<span class="tlaGNC">      442285 :                 const uint64_t nBlockPos{blkdat.GetPos()};</span></span>
<span id="L5067"><span class="lineNum">    5067</span>         [<span class="tlaGBC" title="Branch 0 was taken 212823 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 229462 times"> + </span>]:<span class="tlaGNC">      442285 :                 if (dbp)</span></span>
<span id="L5068"><span class="lineNum">    5068</span>                 :<span class="tlaGNC">      212823 :                     dbp-&gt;nPos = nBlockPos;</span></span>
<span id="L5069"><span class="lineNum">    5069</span>         [<span class="tlaGBC" title="Branch 0 was taken 442285 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      442285 :                 blkdat.SetLimit(nBlockPos + nSize);</span></span>
<span id="L5070"><span class="lineNum">    5070</span>                 :<span class="tlaGNC">      442285 :                 CBlockHeader header;</span></span>
<span id="L5071"><span class="lineNum">    5071</span>         [<span class="tlaGBC" title="Branch 0 was taken 440950 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 1335 times"> + </span>]:<span class="tlaGNC">      442285 :                 blkdat &gt;&gt; header;</span></span>
<span id="L5072"><span class="lineNum">    5072</span>         [<span class="tlaGBC" title="Branch 0 was taken 440950 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      440950 :                 const uint256 hash{header.GetHash()};</span></span>
<span id="L5073"><span class="lineNum">    5073</span>                 :             :                 // Skip the rest of this block (this may read from disk into memory); position to the marker before the</span>
<span id="L5074"><span class="lineNum">    5074</span>                 :             :                 // next block, but it's still possible to rewind to the start of the current block (without a disk read).</span>
<span id="L5075"><span class="lineNum">    5075</span>                 :<span class="tlaGNC">      440950 :                 nRewind = nBlockPos + nSize;</span></span>
<span id="L5076"><span class="lineNum">    5076</span>         [<span class="tlaGBC" title="Branch 0 was taken 439090 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 1860 times"> + </span>]:<span class="tlaGNC">      440950 :                 blkdat.SkipTo(nRewind);</span></span>
<span id="L5077"><span class="lineNum">    5077</span>                 :             : </span>
<span id="L5078"><span class="lineNum">    5078</span>                 :<span class="tlaGNC">      439090 :                 std::shared_ptr&lt;CBlock&gt; pblock{}; // needs to remain available after the cs_main lock is released to avoid duplicate reads from disk</span></span>
<span id="L5079"><span class="lineNum">    5079</span>                 :             : </span>
<span id="L5080"><span class="lineNum">    5080</span>                 :<span class="tlaGNC">      439090 :                 {</span></span>
<span id="L5081"><span class="lineNum">    5081</span>         [<span class="tlaGBC" title="Branch 0 was taken 439090 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      439090 :                     LOCK(cs_main);</span></span>
<span id="L5082"><span class="lineNum">    5082</span>                 :             :                     // detect out of order blocks, and store them for later</span>
<span id="L5083"><span class="lineNum">    5083</span>   [<span class="tlaGBC" title="Branch 0 was taken 439090 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 439090 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      439090 :                     if (hash != params.GetConsensus().hashGenesisBlock &amp;&amp; !m_blockman.LookupBlockIndex(header.hashPrevBlock)) {</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 280877 times"> + </span><span class="tlaGBC" title="Branch 5 was taken 158213 times"> + </span>]
<span id="L5084"><span class="lineNum">    5084</span>   [<span class="tlaGBC" title="Branch 0 was taken 280877 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 280877 times"> + </span> :<span class="tlaGNC">      280877 :                         LogDebug(BCLog::REINDEX, &quot;%s: Out of order block %s, parent %s not known\n&quot;, __func__, hash.ToString(),</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaUNC" title="Branch 6 was not taken"> - </span><span class="tlaUNC" title="Branch 7 was not taken"> - </span><span class="tlaUNC" title="Branch 8 was not taken"> - </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not taken"> - </span>]
<span id="L5085"><span class="lineNum">    5085</span>                 :             :                                  header.hashPrevBlock.ToString());</span>
<span id="L5086"><span class="lineNum">    5086</span>         [<span class="tlaGBC" title="Branch 0 was taken 162406 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 118471 times"> + </span>]:<span class="tlaGNC">      280877 :                         if (dbp &amp;&amp; blocks_with_unknown_parent) {</span></span>
<span id="L5087"><span class="lineNum">    5087</span>         [<span class="tlaGBC" title="Branch 0 was taken 162406 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      162406 :                             blocks_with_unknown_parent-&gt;emplace(header.hashPrevBlock, *dbp);</span></span>
<span id="L5088"><span class="lineNum">    5088</span>                 :             :                         }</span>
<span id="L5089"><span class="lineNum">    5089</span>                 :<span class="tlaGNC">      280877 :                         continue;</span></span>
<span id="L5090"><span class="lineNum">    5090</span>         [<span class="tlaGBC" title="Branch 0 was taken 280877 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      280877 :                     }</span></span>
<span id="L5091"><span class="lineNum">    5091</span>                 :             : </span>
<span id="L5092"><span class="lineNum">    5092</span>                 :             :                     // process in case the block isn't known yet</span>
<span id="L5093"><span class="lineNum">    5093</span>         [<span class="tlaGBC" title="Branch 0 was taken 158213 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      158213 :                     const CBlockIndex* pindex = m_blockman.LookupBlockIndex(hash);</span></span>
<span id="L5094"><span class="lineNum">    5094</span>   [<span class="tlaGBC" title="Branch 0 was taken 29990 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 128223 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 29990 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      158213 :                     if (!pindex || (pindex-&gt;nStatus &amp; BLOCK_HAVE_DATA) == 0) {</span></span>
<span id="L5095"><span class="lineNum">    5095</span>                 :             :                         // This block can be processed immediately; rewind to its start, read and deserialize it.</span>
<span id="L5096"><span class="lineNum">    5096</span>                 :<span class="tlaGNC">      158213 :                         blkdat.SetPos(nBlockPos);</span></span>
<span id="L5097"><span class="lineNum">    5097</span>   [<span class="tlaGBC" title="Branch 0 was taken 158213 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 158213 times"> + </span>]:<span class="tlaGNC">      316426 :                         pblock = std::make_shared&lt;CBlock&gt;();</span></span>
<span id="L5098"><span class="lineNum">    5098</span>         [<span class="tlaGBC" title="Branch 0 was taken 102956 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 55257 times"> + </span>]:<span class="tlaGNC">      158213 :                         blkdat &gt;&gt; TX_WITH_WITNESS(*pblock);</span></span>
<span id="L5099"><span class="lineNum">    5099</span>         [<span class="tlaGBC" title="Branch 0 was taken 102956 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      102956 :                         nRewind = blkdat.GetPos();</span></span>
<span id="L5100"><span class="lineNum">    5100</span>                 :             : </span>
<span id="L5101"><span class="lineNum">    5101</span>         [<span class="tlaGBC" title="Branch 0 was taken 102956 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      102956 :                         BlockValidationState state;</span></span>
<span id="L5102"><span class="lineNum">    5102</span>   [<span class="tlaGBC" title="Branch 0 was taken 102956 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 102956 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      308868 :                         if (AcceptBlock(pblock, state, nullptr, true, dbp, nullptr, true)) {</span></span>
<span class="lineNum">        </span>    <span class="tlaGBC" title="Branch 4 was taken 102956 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaUNC" title="Branch 6 was not taken"> - </span><span class="tlaGBC" title="Branch 7 was taken 102956 times"> + </span>]
<span id="L5103"><span class="lineNum">    5103</span>                 :<span class="tlaUNC">           0 :                             nLoaded++;</span></span>
<span id="L5104"><span class="lineNum">    5104</span>                 :             :                         }</span>
<span id="L5105"><span class="lineNum">    5105</span>         [<span class="tlaGBC" title="Branch 0 was taken 102956 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      102956 :                         if (state.IsError()) {</span></span>
<span id="L5106"><span class="lineNum">    5106</span>                 :             :                             break;</span>
<span id="L5107"><span class="lineNum">    5107</span>                 :             :                         }</span>
<span id="L5108"><span class="lineNum">    5108</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      102956 :                     } else if (hash != params.GetConsensus().hashGenesisBlock &amp;&amp; pindex-&gt;nHeight % 1000 == 0) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L5109"><span class="lineNum">    5109</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                         LogDebug(BCLog::REINDEX, &quot;Block Import: already had block %s at height %d\n&quot;, hash.ToString(), pindex-&gt;nHeight);</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L5110"><span class="lineNum">    5110</span>                 :             :                     }</span>
<span id="L5111"><span class="lineNum">    5111</span>                 :<span class="tlaGNC">      336134 :                 }</span></span>
<span id="L5112"><span class="lineNum">    5112</span>                 :             : </span>
<span id="L5113"><span class="lineNum">    5113</span>                 :             :                 // Activate the genesis block so normal node progress can continue</span>
<span id="L5114"><span class="lineNum">    5114</span>                 :             :                 // During first -reindex, this will only connect Genesis since</span>
<span id="L5115"><span class="lineNum">    5115</span>                 :             :                 // ActivateBestChain only connects blocks which are in the block tree db,</span>
<span id="L5116"><span class="lineNum">    5116</span>                 :             :                 // which only contains blocks whose parents are in it.</span>
<span id="L5117"><span class="lineNum">    5117</span>                 :             :                 // But do this only if genesis isn't activated yet, to avoid connecting many blocks</span>
<span id="L5118"><span class="lineNum">    5118</span>                 :             :                 // without assumevalid in the case of a continuation of a reindex that</span>
<span id="L5119"><span class="lineNum">    5119</span>                 :             :                 // was interrupted by the user.</span>
<span id="L5120"><span class="lineNum">    5120</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 102956 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      102956 :                 if (hash == params.GetConsensus().hashGenesisBlock &amp;&amp; WITH_LOCK(::cs_main, return ActiveHeight()) == -1) {</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaUNC" title="Branch 6 was not taken"> - </span><span class="tlaUNC" title="Branch 7 was not taken"> - </span><span class="tlaUNC" title="Branch 8 was not taken"> - </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not taken"> - </span>]
<span id="L5121"><span class="lineNum">    5121</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     BlockValidationState state;</span></span>
<span id="L5122"><span class="lineNum">    5122</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                     if (!ActiveChainstate().ActivateBestChain(state, nullptr)) {</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L5123"><span class="lineNum">    5123</span>                 :             :                         break;</span>
<span id="L5124"><span class="lineNum">    5124</span>                 :             :                     }</span>
<span id="L5125"><span class="lineNum">    5125</span>                 :<span class="tlaUNC">           0 :                 }</span></span>
<span id="L5126"><span class="lineNum">    5126</span>                 :             : </span>
<span id="L5127"><span class="lineNum">    5127</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 102956 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">      102956 :                 if (m_blockman.IsPruneMode() &amp;&amp; m_blockman.m_blockfiles_indexed &amp;&amp; pblock) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L5128"><span class="lineNum">    5128</span>                 :             :                     // must update the tip for pruning to work while importing with -loadblock.</span>
<span id="L5129"><span class="lineNum">    5129</span>                 :             :                     // this is a tradeoff to conserve disk space at the expense of time</span>
<span id="L5130"><span class="lineNum">    5130</span>                 :             :                     // spent updating the tip to be able to prune.</span>
<span id="L5131"><span class="lineNum">    5131</span>                 :             :                     // otherwise, ActivateBestChain won't be called by the import process</span>
<span id="L5132"><span class="lineNum">    5132</span>                 :             :                     // until after all of the block files are loaded. ActivateBestChain can be</span>
<span id="L5133"><span class="lineNum">    5133</span>                 :             :                     // called by concurrent network message processing. but, that is not</span>
<span id="L5134"><span class="lineNum">    5134</span>                 :             :                     // reliable for the purpose of pruning while importing.</span>
<span id="L5135"><span class="lineNum">    5135</span>                 :<span class="tlaUNC">           0 :                     bool activation_failure = false;</span></span>
<span id="L5136"><span class="lineNum">    5136</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     for (auto c : GetAll()) {</span></span>
<span id="L5137"><span class="lineNum">    5137</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                         BlockValidationState state;</span></span>
<span id="L5138"><span class="lineNum">    5138</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                         if (!c-&gt;ActivateBestChain(state, pblock)) {</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L5139"><span class="lineNum">    5139</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                             LogDebug(BCLog::REINDEX, &quot;failed to activate chain (%s)\n&quot;, state.ToString());</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L5140"><span class="lineNum">    5140</span>                 :<span class="tlaUNC">           0 :                             activation_failure = true;</span></span>
<span id="L5141"><span class="lineNum">    5141</span>                 :<span class="tlaUNC">           0 :                             break;</span></span>
<span id="L5142"><span class="lineNum">    5142</span>                 :             :                         }</span>
<span id="L5143"><span class="lineNum">    5143</span>                 :<span class="tlaUNC">           0 :                     }</span></span>
<span id="L5144"><span class="lineNum">    5144</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     if (activation_failure) {</span></span>
<span id="L5145"><span class="lineNum">    5145</span>                 :             :                         break;</span>
<span id="L5146"><span class="lineNum">    5146</span>                 :             :                     }</span>
<span id="L5147"><span class="lineNum">    5147</span>                 :             :                 }</span>
<span id="L5148"><span class="lineNum">    5148</span>                 :             : </span>
<span id="L5149"><span class="lineNum">    5149</span>         [<span class="tlaGBC" title="Branch 0 was taken 102956 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      102956 :                 NotifyHeaderTip();</span></span>
<span id="L5150"><span class="lineNum">    5150</span>                 :             : </span>
<span id="L5151"><span class="lineNum">    5151</span>         [<span class="tlaGBC" title="Branch 0 was taken 68626 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 34330 times"> + </span>]:<span class="tlaGNC">      102956 :                 if (!blocks_with_unknown_parent) continue;</span></span>
<span id="L5152"><span class="lineNum">    5152</span>                 :             : </span>
<span id="L5153"><span class="lineNum">    5153</span>                 :             :                 // Recursively process earlier encountered successors of this block</span>
<span id="L5154"><span class="lineNum">    5154</span>         [<span class="tlaGBC" title="Branch 0 was taken 34330 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       34330 :                 std::deque&lt;uint256&gt; queue;</span></span>
<span id="L5155"><span class="lineNum">    5155</span>         [<span class="tlaGBC" title="Branch 0 was taken 34330 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       34330 :                 queue.push_back(hash);</span></span>
<span id="L5156"><span class="lineNum">    5156</span>         [<span class="tlaGBC" title="Branch 0 was taken 34330 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 34330 times"> + </span>]:<span class="tlaGNC">       68660 :                 while (!queue.empty()) {</span></span>
<span id="L5157"><span class="lineNum">    5157</span>                 :<span class="tlaGNC">       34330 :                     uint256 head = queue.front();</span></span>
<span id="L5158"><span class="lineNum">    5158</span>                 :<span class="tlaGNC">       34330 :                     queue.pop_front();</span></span>
<span id="L5159"><span class="lineNum">    5159</span>                 :<span class="tlaGNC">       34330 :                     auto range = blocks_with_unknown_parent-&gt;equal_range(head);</span></span>
<span id="L5160"><span class="lineNum">    5160</span>         [<span class="tlaGBC" title="Branch 0 was taken 30536 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 34330 times"> + </span>]:<span class="tlaGNC">       64866 :                     while (range.first != range.second) {</span></span>
<span id="L5161"><span class="lineNum">    5161</span>                 :<span class="tlaGNC">       30536 :                         std::multimap&lt;uint256, FlatFilePos&gt;::iterator it = range.first;</span></span>
<span id="L5162"><span class="lineNum">    5162</span>         [<span class="tlaGBC" title="Branch 0 was taken 30536 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       30536 :                         std::shared_ptr&lt;CBlock&gt; pblockrecursive = std::make_shared&lt;CBlock&gt;();</span></span>
<span id="L5163"><span class="lineNum">    5163</span>   [<span class="tlaGBC" title="Branch 0 was taken 30536 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 30536 times"> + </span>]:<span class="tlaGNC">       30536 :                         if (m_blockman.ReadBlock(*pblockrecursive, it-&gt;second, {})) {</span></span>
<span id="L5164"><span class="lineNum">    5164</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                             const auto&amp; block_hash{pblockrecursive-&gt;GetHash()};</span></span>
<span id="L5165"><span class="lineNum">    5165</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                             LogDebug(BCLog::REINDEX, &quot;%s: Processing out of order child %s of %s&quot;, __func__, block_hash.ToString(), head.ToString());</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not executed"> # </span>]
<span id="L5166"><span class="lineNum">    5166</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                             LOCK(cs_main);</span></span>
<span id="L5167"><span class="lineNum">    5167</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                             BlockValidationState dummy;</span></span>
<span id="L5168"><span class="lineNum">    5168</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                             if (AcceptBlock(pblockrecursive, dummy, nullptr, true, &amp;it-&gt;second, nullptr, true)) {</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L5169"><span class="lineNum">    5169</span>                 :<span class="tlaUNC">           0 :                                 nLoaded++;</span></span>
<span id="L5170"><span class="lineNum">    5170</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                                 queue.push_back(block_hash);</span></span>
<span id="L5171"><span class="lineNum">    5171</span>                 :             :                             }</span>
<span id="L5172"><span class="lineNum">    5172</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                         }</span></span>
<span id="L5173"><span class="lineNum">    5173</span>                 :<span class="tlaGNC">       30536 :                         range.first++;</span></span>
<span id="L5174"><span class="lineNum">    5174</span>                 :<span class="tlaGNC">       30536 :                         blocks_with_unknown_parent-&gt;erase(it);</span></span>
<span id="L5175"><span class="lineNum">    5175</span>         [<span class="tlaGBC" title="Branch 0 was taken 30536 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       30536 :                         NotifyHeaderTip();</span></span>
<span id="L5176"><span class="lineNum">    5176</span>                 :<span class="tlaGNC">       30536 :                     }</span></span>
<span id="L5177"><span class="lineNum">    5177</span>                 :             :                 }</span>
<span id="L5178"><span class="lineNum">    5178</span>   [<span class="tlaGBC" title="Branch 0 was taken 34330 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 58452 times"> + </span>]:<span class="tlaGNC">      476615 :             } catch (const std::exception&amp; e) {</span></span>
<span id="L5179"><span class="lineNum">    5179</span>                 :             :                 // historical bugs added extra data to the block files that does not deserialize cleanly.</span>
<span id="L5180"><span class="lineNum">    5180</span>                 :             :                 // commonly this data is between readable blocks, but it does not really matter. such data is not fatal to the import process.</span>
<span id="L5181"><span class="lineNum">    5181</span>                 :             :                 // the code that reads the block files deals with invalid data by simply ignoring it.</span>
<span id="L5182"><span class="lineNum">    5182</span>                 :             :                 // it continues to search for the next {4 byte magic message start bytes + 4 byte length + block} that does deserialize cleanly</span>
<span id="L5183"><span class="lineNum">    5183</span>                 :             :                 // and passes all of the other block validation checks dealing with POW and the merkle root, etc...</span>
<span id="L5184"><span class="lineNum">    5184</span>                 :             :                 // we merely note with this informational log message when unexpected data is encountered.</span>
<span id="L5185"><span class="lineNum">    5185</span>                 :             :                 // we could also be experiencing a storage system read error, or a read of a previous bad write. these are possible, but</span>
<span id="L5186"><span class="lineNum">    5186</span>                 :             :                 // less likely scenarios. we don't have enough information to tell a difference here.</span>
<span id="L5187"><span class="lineNum">    5187</span>                 :             :                 // the reindex process is not the place to attempt to clean and/or compact the block files. if so desired, a studious node operator</span>
<span id="L5188"><span class="lineNum">    5188</span>                 :             :                 // may use knowledge of the fact that the block files are not entirely pristine in order to prepare a set of pristine, and</span>
<span id="L5189"><span class="lineNum">    5189</span>                 :             :                 // perhaps ordered, block files for later reindexing.</span>
<span id="L5190"><span class="lineNum">    5190</span>   [<span class="tlaGBC" title="Branch 0 was taken 58452 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 58452 times"> + </span> :<span class="tlaGNC">       58452 :                 LogDebug(BCLog::REINDEX, &quot;%s: unexpected data at file offset 0x%x - %s. continuing\n&quot;, __func__, (nRewind - 1), e.what());</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L5191"><span class="lineNum">    5191</span>                 :<span class="tlaGNC">       58452 :             }</span></span>
<span id="L5192"><span class="lineNum">    5192</span>                 :             :         }</span>
<span id="L5193"><span class="lineNum">    5193</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">         860 :     } catch (const std::runtime_error&amp; e) {</span></span>
<span id="L5194"><span class="lineNum">    5194</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaUNC">           0 :         GetNotifications().fatalError(strprintf(_(&quot;System error while loading external block file: %s&quot;), e.what()));</span></span>
<span id="L5195"><span class="lineNum">    5195</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L5196"><span class="lineNum">    5196</span>                 :<span class="tlaGNC">         860 :     LogInfo(&quot;Loaded %i blocks from external file in %dms&quot;, nLoaded, Ticks&lt;std::chrono::milliseconds&gt;(SteadyClock::now() - start));</span></span>
<span id="L5197"><span class="lineNum">    5197</span>                 :             : }</span>
<span id="L5198"><span class="lineNum">    5198</span>                 :             : </span>
<span id="L5199"><span class="lineNum">    5199</span>                 :<span class="tlaGNC">      931309 : bool ChainstateManager::ShouldCheckBlockIndex() const</span></span>
<span id="L5200"><span class="lineNum">    5200</span>                 :             : {</span>
<span id="L5201"><span class="lineNum">    5201</span>                 :             :     // Assert to verify Flatten() has been called.</span>
<span id="L5202"><span class="lineNum">    5202</span>         [<span class="tlaGBC" title="Branch 0 was taken 931309 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      931309 :     if (!*Assert(m_options.check_block_index)) return false;</span></span>
<span id="L5203"><span class="lineNum">    5203</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 931309 times"> + </span>]:<span class="tlaGNC">      931309 :     if (FastRandomContext().randrange(*m_options.check_block_index) &gt;= 1) return false;</span></span>
<span id="L5204"><span class="lineNum">    5204</span>                 :             :     return true;</span>
<span id="L5205"><span class="lineNum">    5205</span>                 :             : }</span>
<span id="L5206"><span class="lineNum">    5206</span>                 :             : </span>
<span id="L5207"><span class="lineNum">    5207</span>                 :<span class="tlaGNC">      931309 : void ChainstateManager::CheckBlockIndex() const</span></span>
<span id="L5208"><span class="lineNum">    5208</span>                 :             : {</span>
<span id="L5209"><span class="lineNum">    5209</span>         [<span class="tlaGBC" title="Branch 0 was taken 931309 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      931309 :     if (!ShouldCheckBlockIndex()) {</span></span>
<span id="L5210"><span class="lineNum">    5210</span>                 :             :         return;</span>
<span id="L5211"><span class="lineNum">    5211</span>                 :             :     }</span>
<span id="L5212"><span class="lineNum">    5212</span>                 :             : </span>
<span id="L5213"><span class="lineNum">    5213</span>                 :<span class="tlaGNC">      931309 :     LOCK(cs_main);</span></span>
<span id="L5214"><span class="lineNum">    5214</span>                 :             : </span>
<span id="L5215"><span class="lineNum">    5215</span>                 :             :     // During a reindex, we read the genesis block and call CheckBlockIndex before ActivateBestChain,</span>
<span id="L5216"><span class="lineNum">    5216</span>                 :             :     // so we have the genesis block in m_blockman.m_block_index but no active chain. (A few of the</span>
<span id="L5217"><span class="lineNum">    5217</span>                 :             :     // tests when iterating the block tree require that m_chain has been initialized.)</span>
<span id="L5218"><span class="lineNum">    5218</span>   [<span class="tlaGBC" title="Branch 0 was taken 931309 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 931309 times"> + </span> :<span class="tlaGNC">      931309 :     if (ActiveChain().Height() &lt; 0) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaGBC" title="Branch 5 was taken 931309 times"> + </span>]
<span id="L5219"><span class="lineNum">    5219</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         assert(m_blockman.m_block_index.size() &lt;= 1);</span></span>
<span id="L5220"><span class="lineNum">    5220</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         return;</span></span>
<span id="L5221"><span class="lineNum">    5221</span>                 :             :     }</span>
<span id="L5222"><span class="lineNum">    5222</span>                 :             : </span>
<span id="L5223"><span class="lineNum">    5223</span>                 :             :     // Build forward-pointing data structure for the entire block tree.</span>
<span id="L5224"><span class="lineNum">    5224</span>                 :             :     // For performance reasons, indexes of the best header chain are stored in a vector (within CChain).</span>
<span id="L5225"><span class="lineNum">    5225</span>                 :             :     // All remaining blocks are stored in a multimap.</span>
<span id="L5226"><span class="lineNum">    5226</span>                 :             :     // The best header chain can differ from the active chain: E.g. its entries may belong to blocks that</span>
<span id="L5227"><span class="lineNum">    5227</span>                 :             :     // are not yet validated.</span>
<span id="L5228"><span class="lineNum">    5228</span>                 :<span class="tlaGNC">      931309 :     CChain best_hdr_chain;</span></span>
<span id="L5229"><span class="lineNum">    5229</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 931309 times"> + </span>]:<span class="tlaGNC">      931309 :     assert(m_best_header);</span></span>
<span id="L5230"><span class="lineNum">    5230</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 931309 times"> + </span>]:<span class="tlaGNC">      931309 :     assert(!(m_best_header-&gt;nStatus &amp; BLOCK_FAILED_MASK));</span></span>
<span id="L5231"><span class="lineNum">    5231</span>         [<span class="tlaGBC" title="Branch 0 was taken 931309 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      931309 :     best_hdr_chain.SetTip(*m_best_header);</span></span>
<span id="L5232"><span class="lineNum">    5232</span>                 :             : </span>
<span id="L5233"><span class="lineNum">    5233</span>                 :<span class="tlaGNC">      931309 :     std::multimap&lt;const CBlockIndex*, const CBlockIndex*&gt; forward;</span></span>
<span id="L5234"><span class="lineNum">    5234</span>   [<span class="tlaGBC" title="Branch 0 was taken 931309 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 98206939 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 33285544 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 64921395 times"> + </span>]:<span class="tlaGNC">    99138248 :     for (auto&amp; [_, block_index] : m_blockman.m_block_index) {</span></span>
<span id="L5235"><span class="lineNum">    5235</span>                 :             :         // Only save indexes in forward that are not part of the best header chain.</span>
<span id="L5236"><span class="lineNum">    5236</span>         [<span class="tlaGBC" title="Branch 0 was taken 33285544 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 64921395 times"> + </span>]:<span class="tlaGNC">    98206939 :         if (!best_hdr_chain.Contains(&amp;block_index)) {</span></span>
<span id="L5237"><span class="lineNum">    5237</span>                 :             :             // Only genesis, which must be part of the best header chain, can have a nullptr parent.</span>
<span id="L5238"><span class="lineNum">    5238</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 33285544 times"> + </span>]:<span class="tlaGNC">    33285544 :             assert(block_index.pprev);</span></span>
<span id="L5239"><span class="lineNum">    5239</span>         [<span class="tlaGBC" title="Branch 0 was taken 33285544 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">    33285544 :             forward.emplace(block_index.pprev, &amp;block_index);</span></span>
<span id="L5240"><span class="lineNum">    5240</span>                 :             :         }</span>
<span id="L5241"><span class="lineNum">    5241</span>                 :             :     }</span>
<span id="L5242"><span class="lineNum">    5242</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 931309 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 931309 times"> + </span>]:<span class="tlaGNC">      931309 :     assert(forward.size() + best_hdr_chain.Height() + 1 == m_blockman.m_block_index.size());</span></span>
<span id="L5243"><span class="lineNum">    5243</span>                 :             : </span>
<span id="L5244"><span class="lineNum">    5244</span>         [<span class="tlaGBC" title="Branch 0 was taken 931309 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      931309 :     const CBlockIndex* pindex = best_hdr_chain[0];</span></span>
<span id="L5245"><span class="lineNum">    5245</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 931309 times"> + </span>]:<span class="tlaGNC">      931309 :     assert(pindex);</span></span>
<span id="L5246"><span class="lineNum">    5246</span>                 :             :     // Iterate over the entire block tree, using depth-first search.</span>
<span id="L5247"><span class="lineNum">    5247</span>                 :             :     // Along the way, remember whether there are blocks on the path from genesis</span>
<span id="L5248"><span class="lineNum">    5248</span>                 :             :     // block being explored which are the first to have certain properties.</span>
<span id="L5249"><span class="lineNum">    5249</span>                 :<span class="tlaGNC">      931309 :     size_t nNodes = 0;</span></span>
<span id="L5250"><span class="lineNum">    5250</span>                 :<span class="tlaGNC">      931309 :     int nHeight = 0;</span></span>
<span id="L5251"><span class="lineNum">    5251</span>                 :<span class="tlaGNC">      931309 :     const CBlockIndex* pindexFirstInvalid = nullptr;              // Oldest ancestor of pindex which is invalid.</span></span>
<span id="L5252"><span class="lineNum">    5252</span>                 :<span class="tlaGNC">      931309 :     const CBlockIndex* pindexFirstMissing = nullptr;              // Oldest ancestor of pindex which does not have BLOCK_HAVE_DATA, since assumeutxo snapshot if used.</span></span>
<span id="L5253"><span class="lineNum">    5253</span>                 :<span class="tlaGNC">      931309 :     const CBlockIndex* pindexFirstNeverProcessed = nullptr;       // Oldest ancestor of pindex for which nTx == 0, since assumeutxo snapshot if used.</span></span>
<span id="L5254"><span class="lineNum">    5254</span>                 :<span class="tlaGNC">      931309 :     const CBlockIndex* pindexFirstNotTreeValid = nullptr;         // Oldest ancestor of pindex which does not have BLOCK_VALID_TREE (regardless of being valid or not).</span></span>
<span id="L5255"><span class="lineNum">    5255</span>                 :<span class="tlaGNC">      931309 :     const CBlockIndex* pindexFirstNotTransactionsValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_TRANSACTIONS (regardless of being valid or not), since assumeutxo snapshot if used.</span></span>
<span id="L5256"><span class="lineNum">    5256</span>                 :<span class="tlaGNC">      931309 :     const CBlockIndex* pindexFirstNotChainValid = nullptr;        // Oldest ancestor of pindex which does not have BLOCK_VALID_CHAIN (regardless of being valid or not), since assumeutxo snapshot if used.</span></span>
<span id="L5257"><span class="lineNum">    5257</span>                 :<span class="tlaGNC">      931309 :     const CBlockIndex* pindexFirstNotScriptsValid = nullptr;      // Oldest ancestor of pindex which does not have BLOCK_VALID_SCRIPTS (regardless of being valid or not), since assumeutxo snapshot if used.</span></span>
<span id="L5258"><span class="lineNum">    5258</span>                 :             : </span>
<span id="L5259"><span class="lineNum">    5259</span>                 :             :     // After checking an assumeutxo snapshot block, reset pindexFirst pointers</span>
<span id="L5260"><span class="lineNum">    5260</span>                 :             :     // to earlier blocks that have not been downloaded or validated yet, so</span>
<span id="L5261"><span class="lineNum">    5261</span>                 :             :     // checks for later blocks can assume the earlier blocks were validated and</span>
<span id="L5262"><span class="lineNum">    5262</span>                 :             :     // be stricter, testing for more requirements.</span>
<span id="L5263"><span class="lineNum">    5263</span>         [<span class="tlaGBC" title="Branch 0 was taken 931309 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      931309 :     const CBlockIndex* snap_base{GetSnapshotBaseBlock()};</span></span>
<span id="L5264"><span class="lineNum">    5264</span>                 :<span class="tlaGNC">      931309 :     const CBlockIndex *snap_first_missing{}, *snap_first_notx{}, *snap_first_notv{}, *snap_first_nocv{}, *snap_first_nosv{};</span></span>
<span id="L5265"><span class="lineNum">    5265</span>                 :<span class="tlaGNC">   132423792 :     auto snap_update_firsts = [&amp;] {</span></span>
<span id="L5266"><span class="lineNum">    5266</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 131492483 times"> + </span>]:<span class="tlaGNC">   131492483 :         if (pindex == snap_base) {</span></span>
<span id="L5267"><span class="lineNum">    5267</span>                 :<span class="tlaUNC">           0 :             std::swap(snap_first_missing, pindexFirstMissing);</span></span>
<span id="L5268"><span class="lineNum">    5268</span>                 :<span class="tlaUNC">           0 :             std::swap(snap_first_notx, pindexFirstNeverProcessed);</span></span>
<span id="L5269"><span class="lineNum">    5269</span>                 :<span class="tlaUNC">           0 :             std::swap(snap_first_notv, pindexFirstNotTransactionsValid);</span></span>
<span id="L5270"><span class="lineNum">    5270</span>                 :<span class="tlaUNC">           0 :             std::swap(snap_first_nocv, pindexFirstNotChainValid);</span></span>
<span id="L5271"><span class="lineNum">    5271</span>                 :<span class="tlaUNC">           0 :             std::swap(snap_first_nosv, pindexFirstNotScriptsValid);</span></span>
<span id="L5272"><span class="lineNum">    5272</span>                 :             :         }</span>
<span id="L5273"><span class="lineNum">    5273</span>                 :<span class="tlaGNC">   132423792 :     };</span></span>
<span id="L5274"><span class="lineNum">    5274</span>                 :             : </span>
<span id="L5275"><span class="lineNum">    5275</span>         [<span class="tlaGBC" title="Branch 0 was taken 98206939 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 17495 times"> + </span>]:<span class="tlaGNC">    98224434 :     while (pindex != nullptr) {</span></span>
<span id="L5276"><span class="lineNum">    5276</span>                 :<span class="tlaGNC">    98206939 :         nNodes++;</span></span>
<span id="L5277"><span class="lineNum">    5277</span>   [<span class="tlaGBC" title="Branch 0 was taken 98206939 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 7964268 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 90242671 times"> + </span>]:<span class="tlaGNC">    98206939 :         if (pindexFirstInvalid == nullptr &amp;&amp; pindex-&gt;nStatus &amp; BLOCK_FAILED_VALID) pindexFirstInvalid = pindex;</span></span>
<span id="L5278"><span class="lineNum">    5278</span>   [<span class="tlaGBC" title="Branch 0 was taken 80562218 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 17644721 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 30821431 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 49740787 times"> + </span>]:<span class="tlaGNC">    98206939 :         if (pindexFirstMissing == nullptr &amp;&amp; !(pindex-&gt;nStatus &amp; BLOCK_HAVE_DATA)) {</span></span>
<span id="L5279"><span class="lineNum">    5279</span>                 :<span class="tlaGNC">    30821431 :             pindexFirstMissing = pindex;</span></span>
<span id="L5280"><span class="lineNum">    5280</span>                 :             :         }</span>
<span id="L5281"><span class="lineNum">    5281</span>   [<span class="tlaGBC" title="Branch 0 was taken 80562218 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 17644721 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 30821431 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 49740787 times"> + </span>]:<span class="tlaGNC">    98206939 :         if (pindexFirstNeverProcessed == nullptr &amp;&amp; pindex-&gt;nTx == 0) pindexFirstNeverProcessed = pindex;</span></span>
<span id="L5282"><span class="lineNum">    5282</span>   [<span class="tlaGBC" title="Branch 0 was taken 97275630 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 931309 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 97275630 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">    98206939 :         if (pindex-&gt;pprev != nullptr &amp;&amp; pindexFirstNotTreeValid == nullptr &amp;&amp; (pindex-&gt;nStatus &amp; BLOCK_VALID_MASK) &lt; BLOCK_VALID_TREE) pindexFirstNotTreeValid = pindex;</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaGBC" title="Branch 5 was taken 97275630 times"> + </span>]
<span id="L5283"><span class="lineNum">    5283</span>                 :             : </span>
<span id="L5284"><span class="lineNum">    5284</span>         [<span class="tlaGBC" title="Branch 0 was taken 97275630 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 931309 times"> + </span>]:<span class="tlaGNC">    98206939 :         if (pindex-&gt;pprev != nullptr) {</span></span>
<span id="L5285"><span class="lineNum">    5285</span>         [<span class="tlaGBC" title="Branch 0 was taken 79630909 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 17644721 times"> + </span>]:<span class="tlaGNC">    97275630 :             if (pindexFirstNotTransactionsValid == nullptr &amp;&amp;</span></span>
<span id="L5286"><span class="lineNum">    5286</span>         [<span class="tlaGBC" title="Branch 0 was taken 30821431 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 48809478 times"> + </span>]:<span class="tlaGNC">    79630909 :                     (pindex-&gt;nStatus &amp; BLOCK_VALID_MASK) &lt; BLOCK_VALID_TRANSACTIONS) {</span></span>
<span id="L5287"><span class="lineNum">    5287</span>                 :<span class="tlaGNC">    30821431 :                 pindexFirstNotTransactionsValid = pindex;</span></span>
<span id="L5288"><span class="lineNum">    5288</span>                 :             :             }</span>
<span id="L5289"><span class="lineNum">    5289</span>                 :             : </span>
<span id="L5290"><span class="lineNum">    5290</span>         [<span class="tlaGBC" title="Branch 0 was taken 79630909 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 17644721 times"> + </span>]:<span class="tlaGNC">    97275630 :             if (pindexFirstNotChainValid == nullptr &amp;&amp;</span></span>
<span id="L5291"><span class="lineNum">    5291</span>         [<span class="tlaGBC" title="Branch 0 was taken 32564677 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 47066232 times"> + </span>]:<span class="tlaGNC">    79630909 :                     (pindex-&gt;nStatus &amp; BLOCK_VALID_MASK) &lt; BLOCK_VALID_CHAIN) {</span></span>
<span id="L5292"><span class="lineNum">    5292</span>                 :<span class="tlaGNC">    32564677 :                 pindexFirstNotChainValid = pindex;</span></span>
<span id="L5293"><span class="lineNum">    5293</span>                 :             :             }</span>
<span id="L5294"><span class="lineNum">    5294</span>                 :             : </span>
<span id="L5295"><span class="lineNum">    5295</span>         [<span class="tlaGBC" title="Branch 0 was taken 79630909 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 17644721 times"> + </span>]:<span class="tlaGNC">    97275630 :             if (pindexFirstNotScriptsValid == nullptr &amp;&amp;</span></span>
<span id="L5296"><span class="lineNum">    5296</span>         [<span class="tlaGBC" title="Branch 0 was taken 32564677 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 47066232 times"> + </span>]:<span class="tlaGNC">    79630909 :                     (pindex-&gt;nStatus &amp; BLOCK_VALID_MASK) &lt; BLOCK_VALID_SCRIPTS) {</span></span>
<span id="L5297"><span class="lineNum">    5297</span>                 :<span class="tlaGNC">    32564677 :                 pindexFirstNotScriptsValid = pindex;</span></span>
<span id="L5298"><span class="lineNum">    5298</span>                 :             :             }</span>
<span id="L5299"><span class="lineNum">    5299</span>                 :             :         }</span>
<span id="L5300"><span class="lineNum">    5300</span>                 :             : </span>
<span id="L5301"><span class="lineNum">    5301</span>                 :             :         // Begin: actual consistency checks.</span>
<span id="L5302"><span class="lineNum">    5302</span>         [<span class="tlaGBC" title="Branch 0 was taken 931309 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 97275630 times"> + </span>]:<span class="tlaGNC">    98206939 :         if (pindex-&gt;pprev == nullptr) {</span></span>
<span id="L5303"><span class="lineNum">    5303</span>                 :             :             // Genesis block checks.</span>
<span id="L5304"><span class="lineNum">    5304</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 931309 times"> + </span>]:<span class="tlaGNC">      931309 :             assert(pindex-&gt;GetBlockHash() == GetConsensus().hashGenesisBlock); // Genesis block's hash must match.</span></span>
<span id="L5305"><span class="lineNum">    5305</span>         [<span class="tlaGBC" title="Branch 0 was taken 1862618 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 931309 times"> + </span>]:<span class="tlaGNC">     2793927 :             for (const Chainstate* c : {m_ibd_chainstate.get(), m_snapshot_chainstate.get()}) {</span></span>
<span id="L5306"><span class="lineNum">    5306</span>   [<span class="tlaGBC" title="Branch 0 was taken 931309 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 931309 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 931309 times"> + </span> :<span class="tlaGNC">     3725236 :                 if (c &amp;&amp; c-&gt;m_chain.Genesis() != nullptr) {</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 931309 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L5307"><span class="lineNum">    5307</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 931309 times"> + </span>]:<span class="tlaGNC">      931309 :                     assert(pindex == c-&gt;m_chain.Genesis()); // The chain's genesis block must be this block.</span></span>
<span id="L5308"><span class="lineNum">    5308</span>                 :             :                 }</span>
<span id="L5309"><span class="lineNum">    5309</span>                 :             :             }</span>
<span id="L5310"><span class="lineNum">    5310</span>                 :             :         }</span>
<span id="L5311"><span class="lineNum">    5311</span>   [<span class="tlaGBC" title="Branch 0 was taken 48466152 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 49740787 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 48466152 times"> + </span>]:<span class="tlaGNC">    98206939 :         if (!pindex-&gt;HaveNumChainTxs()) assert(pindex-&gt;nSequenceId &lt;= 0); // nSequenceId can't be set positive for blocks that aren't linked (negative is used for preciousblock)</span></span>
<span id="L5312"><span class="lineNum">    5312</span>                 :             :         // VALID_TRANSACTIONS is equivalent to nTx &gt; 0 for all nodes (whether or not pruning has occurred).</span>
<span id="L5313"><span class="lineNum">    5313</span>                 :             :         // HAVE_DATA is only equivalent to nTx &gt; 0 (or VALID_TRANSACTIONS) if no pruning has occurred.</span>
<span id="L5314"><span class="lineNum">    5314</span>         [<span class="tlaGBC" title="Branch 0 was taken 98206939 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">    98206939 :         if (!m_blockman.m_have_pruned) {</span></span>
<span id="L5315"><span class="lineNum">    5315</span>                 :             :             // If we've never pruned, then HAVE_DATA should be equivalent to nTx &gt; 0</span>
<span id="L5316"><span class="lineNum">    5316</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 98206939 times"> + </span>]:<span class="tlaGNC">    98206939 :             assert(!(pindex-&gt;nStatus &amp; BLOCK_HAVE_DATA) == (pindex-&gt;nTx == 0));</span></span>
<span id="L5317"><span class="lineNum">    5317</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 98206939 times"> + </span>]:<span class="tlaGNC">    98206939 :             assert(pindexFirstMissing == pindexFirstNeverProcessed);</span></span>
<span id="L5318"><span class="lineNum">    5318</span>                 :             :         } else {</span>
<span id="L5319"><span class="lineNum">    5319</span>                 :             :             // If we have pruned, then we can only say that HAVE_DATA implies nTx &gt; 0</span>
<span id="L5320"><span class="lineNum">    5320</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (pindex-&gt;nStatus &amp; BLOCK_HAVE_DATA) assert(pindex-&gt;nTx &gt; 0);</span></span>
<span id="L5321"><span class="lineNum">    5321</span>                 :             :         }</span>
<span id="L5322"><span class="lineNum">    5322</span>   [<span class="tlaGBC" title="Branch 0 was taken 47066232 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 51140707 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 47066232 times"> + </span>]:<span class="tlaGNC">    98206939 :         if (pindex-&gt;nStatus &amp; BLOCK_HAVE_UNDO) assert(pindex-&gt;nStatus &amp; BLOCK_HAVE_DATA);</span></span>
<span id="L5323"><span class="lineNum">    5323</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 98206939 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">    98206939 :         if (snap_base &amp;&amp; snap_base-&gt;GetAncestor(pindex-&gt;nHeight) == pindex) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L5324"><span class="lineNum">    5324</span>                 :             :             // Assumed-valid blocks should connect to the main chain.</span>
<span id="L5325"><span class="lineNum">    5325</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             assert((pindex-&gt;nStatus &amp; BLOCK_VALID_MASK) &gt;= BLOCK_VALID_TREE);</span></span>
<span id="L5326"><span class="lineNum">    5326</span>                 :             :         }</span>
<span id="L5327"><span class="lineNum">    5327</span>                 :             :         // There should only be an nTx value if we have</span>
<span id="L5328"><span class="lineNum">    5328</span>                 :             :         // actually seen a block's transactions.</span>
<span id="L5329"><span class="lineNum">    5329</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 98206939 times"> + </span>]:<span class="tlaGNC">    98206939 :         assert(((pindex-&gt;nStatus &amp; BLOCK_VALID_MASK) &gt;= BLOCK_VALID_TRANSACTIONS) == (pindex-&gt;nTx &gt; 0)); // This is pruning-independent.</span></span>
<span id="L5330"><span class="lineNum">    5330</span>                 :             :         // All parents having had data (at some point) is equivalent to all parents being VALID_TRANSACTIONS, which is equivalent to HaveNumChainTxs().</span>
<span id="L5331"><span class="lineNum">    5331</span>                 :             :         // HaveNumChainTxs will also be set in the assumeutxo snapshot block from snapshot metadata.</span>
<span id="L5332"><span class="lineNum">    5332</span>   [<span class="tlaGBC" title="Branch 0 was taken 48466152 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 49740787 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 48466152 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">   146673091 :         assert((pindexFirstNeverProcessed == nullptr || pindex == snap_base) == pindex-&gt;HaveNumChainTxs());</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaGBC" title="Branch 5 was taken 98206939 times"> + </span>]
<span id="L5333"><span class="lineNum">    5333</span>   [<span class="tlaGBC" title="Branch 0 was taken 48466152 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 49740787 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 48466152 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">   146673091 :         assert((pindexFirstNotTransactionsValid == nullptr || pindex == snap_base) == pindex-&gt;HaveNumChainTxs());</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaGBC" title="Branch 5 was taken 98206939 times"> + </span>]
<span id="L5334"><span class="lineNum">    5334</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 98206939 times"> + </span>]:<span class="tlaGNC">    98206939 :         assert(pindex-&gt;nHeight == nHeight); // nHeight must be consistent.</span></span>
<span id="L5335"><span class="lineNum">    5335</span>   [<span class="tlaGBC" title="Branch 0 was taken 97275630 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 931309 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 97275630 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">    98206939 :         assert(pindex-&gt;pprev == nullptr || pindex-&gt;nChainWork &gt;= pindex-&gt;pprev-&gt;nChainWork); // For every block except the genesis block, the chainwork must be larger than the parent's.</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaGBC" title="Branch 5 was taken 97275630 times"> + </span>]
<span id="L5336"><span class="lineNum">    5336</span>   [<span class="tlaGBC" title="Branch 0 was taken 66025571 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 32181368 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 66025571 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">    98206939 :         assert(nHeight &lt; 2 || (pindex-&gt;pskip &amp;&amp; (pindex-&gt;pskip-&gt;nHeight &lt; nHeight))); // The pskip pointer must point back for all but the first 2 blocks.</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaGBC" title="Branch 5 was taken 66025571 times"> + </span>]
<span id="L5337"><span class="lineNum">    5337</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 98206939 times"> + </span>]:<span class="tlaGNC">    98206939 :         assert(pindexFirstNotTreeValid == nullptr); // All m_blockman.m_block_index entries must at least be TREE valid</span></span>
<span id="L5338"><span class="lineNum">    5338</span>                 :<span class="tlaGNC">    98206939 :         if ((pindex-&gt;nStatus &amp; BLOCK_VALID_MASK) &gt;= BLOCK_VALID_TREE) assert(pindexFirstNotTreeValid == nullptr); // TREE valid implies all parents are TREE valid</span></span>
<span id="L5339"><span class="lineNum">    5339</span>   [<span class="tlaGBC" title="Branch 0 was taken 47066232 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 51140707 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 47066232 times"> + </span>]:<span class="tlaGNC">    98206939 :         if ((pindex-&gt;nStatus &amp; BLOCK_VALID_MASK) &gt;= BLOCK_VALID_CHAIN) assert(pindexFirstNotChainValid == nullptr); // CHAIN valid implies all parents are CHAIN valid</span></span>
<span id="L5340"><span class="lineNum">    5340</span>   [<span class="tlaGBC" title="Branch 0 was taken 47066232 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 51140707 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 47066232 times"> + </span>]:<span class="tlaGNC">    98206939 :         if ((pindex-&gt;nStatus &amp; BLOCK_VALID_MASK) &gt;= BLOCK_VALID_SCRIPTS) assert(pindexFirstNotScriptsValid == nullptr); // SCRIPTS valid implies all parents are SCRIPTS valid</span></span>
<span id="L5341"><span class="lineNum">    5341</span>         [<span class="tlaGBC" title="Branch 0 was taken 90242671 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 7964268 times"> + </span>]:<span class="tlaGNC">    98206939 :         if (pindexFirstInvalid == nullptr) {</span></span>
<span id="L5342"><span class="lineNum">    5342</span>                 :             :             // Checks for not-invalid blocks.</span>
<span id="L5343"><span class="lineNum">    5343</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 90242671 times"> + </span>]:<span class="tlaGNC">    90242671 :             assert((pindex-&gt;nStatus &amp; BLOCK_FAILED_MASK) == 0); // The failed mask cannot be set for blocks without invalid parents.</span></span>
<span id="L5344"><span class="lineNum">    5344</span>                 :             :         } else {</span>
<span id="L5345"><span class="lineNum">    5345</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 7964268 times"> + </span>]:<span class="tlaGNC">     7964268 :             assert(pindex-&gt;nStatus &amp; BLOCK_FAILED_MASK); // Invalid blocks and their descendants must be marked as invalid</span></span>
<span id="L5346"><span class="lineNum">    5346</span>                 :             :         }</span>
<span id="L5347"><span class="lineNum">    5347</span>                 :             :         // Make sure m_chain_tx_count sum is correctly computed.</span>
<span id="L5348"><span class="lineNum">    5348</span>         [<span class="tlaGBC" title="Branch 0 was taken 931309 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 97275630 times"> + </span>]:<span class="tlaGNC">    98206939 :         if (!pindex-&gt;pprev) {</span></span>
<span id="L5349"><span class="lineNum">    5349</span>                 :             :             // If no previous block, nTx and m_chain_tx_count must be the same.</span>
<span id="L5350"><span class="lineNum">    5350</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 931309 times"> + </span>]:<span class="tlaGNC">      931309 :             assert(pindex-&gt;m_chain_tx_count == pindex-&gt;nTx);</span></span>
<span id="L5351"><span class="lineNum">    5351</span>   [<span class="tlaGBC" title="Branch 0 was taken 79630909 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 17644721 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 48809478 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 30821431 times"> + </span>]:<span class="tlaGNC">    97275630 :         } else if (pindex-&gt;pprev-&gt;m_chain_tx_count &gt; 0 &amp;&amp; pindex-&gt;nTx &gt; 0) {</span></span>
<span id="L5352"><span class="lineNum">    5352</span>                 :             :             // If previous m_chain_tx_count is set and number of transactions in block is known, sum must be set.</span>
<span id="L5353"><span class="lineNum">    5353</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 48809478 times"> + </span>]:<span class="tlaGNC">    48809478 :             assert(pindex-&gt;m_chain_tx_count == pindex-&gt;nTx + pindex-&gt;pprev-&gt;m_chain_tx_count);</span></span>
<span id="L5354"><span class="lineNum">    5354</span>                 :             :         } else {</span>
<span id="L5355"><span class="lineNum">    5355</span>                 :             :             // Otherwise m_chain_tx_count should only be set if this is a snapshot</span>
<span id="L5356"><span class="lineNum">    5356</span>                 :             :             // block, and must be set if it is.</span>
<span id="L5357"><span class="lineNum">    5357</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 48466152 times"> + </span>]:<span class="tlaGNC">    48466152 :             assert((pindex-&gt;m_chain_tx_count != 0) == (pindex == snap_base));</span></span>
<span id="L5358"><span class="lineNum">    5358</span>                 :             :         }</span>
<span id="L5359"><span class="lineNum">    5359</span>                 :             :         // There should be no block with more work than m_best_header, unless it's known to be invalid</span>
<span id="L5360"><span class="lineNum">    5360</span>   [<span class="tlaGBC" title="Branch 0 was taken 90242671 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 7964268 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 90242671 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">    98206939 :         assert((pindex-&gt;nStatus &amp; BLOCK_FAILED_MASK) || pindex-&gt;nChainWork &lt;= m_best_header-&gt;nChainWork);</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaGBC" title="Branch 5 was taken 90242671 times"> + </span>]
<span id="L5361"><span class="lineNum">    5361</span>                 :             : </span>
<span id="L5362"><span class="lineNum">    5362</span>                 :             :         // Chainstate-specific checks on setBlockIndexCandidates</span>
<span id="L5363"><span class="lineNum">    5363</span>         [<span class="tlaGBC" title="Branch 0 was taken 196413878 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 98206939 times"> + </span>]:<span class="tlaGNC">   294620817 :         for (const Chainstate* c : {m_ibd_chainstate.get(), m_snapshot_chainstate.get()}) {</span></span>
<span id="L5364"><span class="lineNum">    5364</span>   [<span class="tlaGBC" title="Branch 0 was taken 98206939 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 98206939 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 98206939 times"> + </span> :<span class="tlaGNC">   294620817 :             if (!c || c-&gt;m_chain.Tip() == nullptr) continue;</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 98206939 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L5365"><span class="lineNum">    5365</span>                 :             :             // Two main factors determine whether pindex is a candidate in</span>
<span id="L5366"><span class="lineNum">    5366</span>                 :             :             // setBlockIndexCandidates:</span>
<span id="L5367"><span class="lineNum">    5367</span>                 :             :             //</span>
<span id="L5368"><span class="lineNum">    5368</span>                 :             :             // - If pindex has less work than the chain tip, it should not be a</span>
<span id="L5369"><span class="lineNum">    5369</span>                 :             :             //   candidate, and this will be asserted below. Otherwise it is a</span>
<span id="L5370"><span class="lineNum">    5370</span>                 :             :             //   potential candidate.</span>
<span id="L5371"><span class="lineNum">    5371</span>                 :             :             //</span>
<span id="L5372"><span class="lineNum">    5372</span>                 :             :             // - If pindex or one of its parent blocks back to the genesis block</span>
<span id="L5373"><span class="lineNum">    5373</span>                 :             :             //   or an assumeutxo snapshot never downloaded transactions</span>
<span id="L5374"><span class="lineNum">    5374</span>                 :             :             //   (pindexFirstNeverProcessed is non-null), it should not be a</span>
<span id="L5375"><span class="lineNum">    5375</span>                 :             :             //   candidate, and this will be asserted below. The only exception</span>
<span id="L5376"><span class="lineNum">    5376</span>                 :             :             //   is if pindex itself is an assumeutxo snapshot block. Then it is</span>
<span id="L5377"><span class="lineNum">    5377</span>                 :             :             //   also a potential candidate.</span>
<span id="L5378"><span class="lineNum">    5378</span>   [<span class="tlaGBC" title="Branch 0 was taken 98206939 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 49800080 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 48406859 times"> + </span> :<span class="tlaGNC">    98206939 :             if (!CBlockIndexWorkComparator()(pindex, c-&gt;m_chain.Tip()) &amp;&amp; (pindexFirstNeverProcessed == nullptr || pindex == snap_base)) {</span></span>
<span class="lineNum">        </span>    <span class="tlaGBC" title="Branch 4 was taken 48463310 times"> + </span><span class="tlaGBC" title="Branch 5 was taken 1336770 times"> + </span><span class="tlaGBC" title="Branch 6 was taken 48463310 times"> + </span><span class="tlaUNC" title="Branch 7 was not taken"> - </span>]
<span id="L5379"><span class="lineNum">    5379</span>                 :             :                 // If pindex was detected as invalid (pindexFirstInvalid is</span>
<span id="L5380"><span class="lineNum">    5380</span>                 :             :                 // non-null), it is not required to be in</span>
<span id="L5381"><span class="lineNum">    5381</span>                 :             :                 // setBlockIndexCandidates.</span>
<span id="L5382"><span class="lineNum">    5382</span>         [<span class="tlaGBC" title="Branch 0 was taken 1144435 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 192335 times"> + </span>]:<span class="tlaGNC">     1336770 :                 if (pindexFirstInvalid == nullptr) {</span></span>
<span id="L5383"><span class="lineNum">    5383</span>                 :             :                     // If pindex and all its parents back to the genesis block</span>
<span id="L5384"><span class="lineNum">    5384</span>                 :             :                     // or an assumeutxo snapshot block downloaded transactions,</span>
<span id="L5385"><span class="lineNum">    5385</span>                 :             :                     // and the transactions were not pruned (pindexFirstMissing</span>
<span id="L5386"><span class="lineNum">    5386</span>                 :             :                     // is null), it is a potential candidate. The check</span>
<span id="L5387"><span class="lineNum">    5387</span>                 :             :                     // excludes pruned blocks, because if any blocks were</span>
<span id="L5388"><span class="lineNum">    5388</span>                 :             :                     // pruned between pindex and the current chain tip, pindex will</span>
<span id="L5389"><span class="lineNum">    5389</span>                 :             :                     // only temporarily be added to setBlockIndexCandidates,</span>
<span id="L5390"><span class="lineNum">    5390</span>                 :             :                     // before being moved to m_blocks_unlinked. This check</span>
<span id="L5391"><span class="lineNum">    5391</span>                 :             :                     // could be improved to verify that if all blocks between</span>
<span id="L5392"><span class="lineNum">    5392</span>                 :             :                     // the chain tip and pindex have data, pindex must be a</span>
<span id="L5393"><span class="lineNum">    5393</span>                 :             :                     // candidate.</span>
<span id="L5394"><span class="lineNum">    5394</span>                 :             :                     //</span>
<span id="L5395"><span class="lineNum">    5395</span>                 :             :                     // If pindex is the chain tip, it also is a potential</span>
<span id="L5396"><span class="lineNum">    5396</span>                 :             :                     // candidate.</span>
<span id="L5397"><span class="lineNum">    5397</span>                 :             :                     //</span>
<span id="L5398"><span class="lineNum">    5398</span>                 :             :                     // If the chainstate was loaded from a snapshot and pindex</span>
<span id="L5399"><span class="lineNum">    5399</span>                 :             :                     // is the base of the snapshot, pindex is also a potential</span>
<span id="L5400"><span class="lineNum">    5400</span>                 :             :                     // candidate.</span>
<span id="L5401"><span class="lineNum">    5401</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 1144435 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">     1144435 :                     if (pindexFirstMissing == nullptr || pindex == c-&gt;m_chain.Tip() || pindex == c-&gt;SnapshotBase()) {</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaUNC" title="Branch 6 was not taken"> - </span><span class="tlaUNC" title="Branch 7 was not taken"> - </span><span class="tlaUNC" title="Branch 8 was not taken"> - </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not taken"> - </span>]
<span id="L5402"><span class="lineNum">    5402</span>                 :             :                         // If this chainstate is the active chainstate, pindex</span>
<span id="L5403"><span class="lineNum">    5403</span>                 :             :                         // must be in setBlockIndexCandidates. Otherwise, this</span>
<span id="L5404"><span class="lineNum">    5404</span>                 :             :                         // chainstate is a background validation chainstate, and</span>
<span id="L5405"><span class="lineNum">    5405</span>                 :             :                         // pindex only needs to be added if it is an ancestor of</span>
<span id="L5406"><span class="lineNum">    5406</span>                 :             :                         // the snapshot that is being validated.</span>
<span id="L5407"><span class="lineNum">    5407</span>   [<span class="tlaGBC" title="Branch 0 was taken 1144435 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 1144435 times"> + </span> :<span class="tlaGNC">     1144435 :                         if (c == &amp;ActiveChainstate() || snap_base-&gt;GetAncestor(pindex-&gt;nHeight) == pindex) {</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaUNC" title="Branch 6 was not taken"> - </span><span class="tlaUNC" title="Branch 7 was not taken"> - </span>]
<span id="L5408"><span class="lineNum">    5408</span>   [<span class="tlaGBC" title="Branch 0 was taken 1144435 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 1144435 times"> + </span>]:<span class="tlaGNC">     1144435 :                             assert(c-&gt;setBlockIndexCandidates.contains(const_cast&lt;CBlockIndex*&gt;(pindex)));</span></span>
<span id="L5409"><span class="lineNum">    5409</span>                 :             :                         }</span>
<span id="L5410"><span class="lineNum">    5410</span>                 :             :                     }</span>
<span id="L5411"><span class="lineNum">    5411</span>                 :             :                     // If some parent is missing, then it could be that this block was in</span>
<span id="L5412"><span class="lineNum">    5412</span>                 :             :                     // setBlockIndexCandidates but had to be removed because of the missing data.</span>
<span id="L5413"><span class="lineNum">    5413</span>                 :             :                     // In this case it must be in m_blocks_unlinked -- see test below.</span>
<span id="L5414"><span class="lineNum">    5414</span>                 :             :                 }</span>
<span id="L5415"><span class="lineNum">    5415</span>                 :             :             } else { // If this block sorts worse than the current tip or some ancestor's block has never been seen, it cannot be in setBlockIndexCandidates.</span>
<span id="L5416"><span class="lineNum">    5416</span>   [<span class="tlaGBC" title="Branch 0 was taken 96870169 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 96870169 times"> + </span>]:<span class="tlaGNC">    96870169 :                 assert(!c-&gt;setBlockIndexCandidates.contains(const_cast&lt;CBlockIndex*&gt;(pindex)));</span></span>
<span id="L5417"><span class="lineNum">    5417</span>                 :             :             }</span>
<span id="L5418"><span class="lineNum">    5418</span>                 :             :         }</span>
<span id="L5419"><span class="lineNum">    5419</span>                 :             :         // Check whether this block is in m_blocks_unlinked.</span>
<span id="L5420"><span class="lineNum">    5420</span>                 :<span class="tlaGNC">    98206939 :         auto rangeUnlinked{m_blockman.m_blocks_unlinked.equal_range(pindex-&gt;pprev)};</span></span>
<span id="L5421"><span class="lineNum">    5421</span>                 :<span class="tlaGNC">    98206939 :         bool foundInUnlinked = false;</span></span>
<span id="L5422"><span class="lineNum">    5422</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 98206939 times"> + </span>]:<span class="tlaGNC">    98206939 :         while (rangeUnlinked.first != rangeUnlinked.second) {</span></span>
<span id="L5423"><span class="lineNum">    5423</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             assert(rangeUnlinked.first-&gt;first == pindex-&gt;pprev);</span></span>
<span id="L5424"><span class="lineNum">    5424</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (rangeUnlinked.first-&gt;second == pindex) {</span></span>
<span id="L5425"><span class="lineNum">    5425</span>                 :             :                 foundInUnlinked = true;</span>
<span id="L5426"><span class="lineNum">    5426</span>                 :             :                 break;</span>
<span id="L5427"><span class="lineNum">    5427</span>                 :             :             }</span>
<span id="L5428"><span class="lineNum">    5428</span>                 :<span class="tlaUNC">           0 :             rangeUnlinked.first++;</span></span>
<span id="L5429"><span class="lineNum">    5429</span>                 :             :         }</span>
<span id="L5430"><span class="lineNum">    5430</span>   [<span class="tlaGBC" title="Branch 0 was taken 97275630 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 931309 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 48809478 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 48466152 times"> + </span> :<span class="tlaGNC">    98206939 :         if (pindex-&gt;pprev &amp;&amp; (pindex-&gt;nStatus &amp; BLOCK_HAVE_DATA) &amp;&amp; pindexFirstNeverProcessed != nullptr &amp;&amp; pindexFirstInvalid == nullptr) {</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaGBC" title="Branch 5 was taken 48809478 times"> + </span><span class="tlaUNC" title="Branch 6 was not taken"> - </span><span class="tlaUNC" title="Branch 7 was not taken"> - </span>]
<span id="L5431"><span class="lineNum">    5431</span>                 :             :             // If this block has block data available, some parent was never received, and has no invalid parents, it must be in m_blocks_unlinked.</span>
<span id="L5432"><span class="lineNum">    5432</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             assert(foundInUnlinked);</span></span>
<span id="L5433"><span class="lineNum">    5433</span>                 :             :         }</span>
<span id="L5434"><span class="lineNum">    5434</span>   [<span class="tlaGBC" title="Branch 0 was taken 48466152 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 49740787 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 48466152 times"> + </span>]:<span class="tlaGNC">    98206939 :         if (!(pindex-&gt;nStatus &amp; BLOCK_HAVE_DATA)) assert(!foundInUnlinked); // Can't be in m_blocks_unlinked if we don't HAVE_DATA</span></span>
<span id="L5435"><span class="lineNum">    5435</span>   [<span class="tlaGBC" title="Branch 0 was taken 49740787 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 48466152 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 49740787 times"> + </span>]:<span class="tlaGNC">    98206939 :         if (pindexFirstMissing == nullptr) assert(!foundInUnlinked); // We aren't missing data for any parent -- cannot be in m_blocks_unlinked.</span></span>
<span id="L5436"><span class="lineNum">    5436</span>   [<span class="tlaGBC" title="Branch 0 was taken 97275630 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 931309 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 48809478 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 48466152 times"> + </span> :<span class="tlaGNC">    98206939 :         if (pindex-&gt;pprev &amp;&amp; (pindex-&gt;nStatus &amp; BLOCK_HAVE_DATA) &amp;&amp; pindexFirstNeverProcessed == nullptr &amp;&amp; pindexFirstMissing != nullptr) {</span></span>
<span class="lineNum">        </span>    <span class="tlaGBC" title="Branch 4 was taken 48809478 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaUNC" title="Branch 6 was not taken"> - </span><span class="tlaGBC" title="Branch 7 was taken 48809478 times"> + </span>]
<span id="L5437"><span class="lineNum">    5437</span>                 :             :             // We HAVE_DATA for this block, have received data for all parents at some point, but we're currently missing data for some parent.</span>
<span id="L5438"><span class="lineNum">    5438</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             assert(m_blockman.m_have_pruned);</span></span>
<span id="L5439"><span class="lineNum">    5439</span>                 :             :             // This block may have entered m_blocks_unlinked if:</span>
<span id="L5440"><span class="lineNum">    5440</span>                 :             :             //  - it has a descendant that at some point had more work than the</span>
<span id="L5441"><span class="lineNum">    5441</span>                 :             :             //    tip, and</span>
<span id="L5442"><span class="lineNum">    5442</span>                 :             :             //  - we tried switching to that descendant but were missing</span>
<span id="L5443"><span class="lineNum">    5443</span>                 :             :             //    data for some intermediate block between m_chain and the</span>
<span id="L5444"><span class="lineNum">    5444</span>                 :             :             //    tip.</span>
<span id="L5445"><span class="lineNum">    5445</span>                 :             :             // So if this block is itself better than any m_chain.Tip() and it wasn't in</span>
<span id="L5446"><span class="lineNum">    5446</span>                 :             :             // setBlockIndexCandidates, then it must be in m_blocks_unlinked.</span>
<span id="L5447"><span class="lineNum">    5447</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             for (const Chainstate* c : {m_ibd_chainstate.get(), m_snapshot_chainstate.get()}) {</span></span>
<span id="L5448"><span class="lineNum">    5448</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 if (!c) continue;</span></span>
<span id="L5449"><span class="lineNum">    5449</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 const bool is_active = c == &amp;ActiveChainstate();</span></span>
<span id="L5450"><span class="lineNum">    5450</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                 if (!CBlockIndexWorkComparator()(pindex, c-&gt;m_chain.Tip()) &amp;&amp; !c-&gt;setBlockIndexCandidates.contains(const_cast&lt;CBlockIndex*&gt;(pindex))) {</span></span>
<span class="lineNum">        </span> <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span><span class="tlaUNC" title="Branch 8 was not executed"> # </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not executed"> # </span>]
<span id="L5451"><span class="lineNum">    5451</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     if (pindexFirstInvalid == nullptr) {</span></span>
<span id="L5452"><span class="lineNum">    5452</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                         if (is_active || snap_base-&gt;GetAncestor(pindex-&gt;nHeight) == pindex) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L5453"><span class="lineNum">    5453</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                             assert(foundInUnlinked);</span></span>
<span id="L5454"><span class="lineNum">    5454</span>                 :             :                         }</span>
<span id="L5455"><span class="lineNum">    5455</span>                 :             :                     }</span>
<span id="L5456"><span class="lineNum">    5456</span>                 :             :                 }</span>
<span id="L5457"><span class="lineNum">    5457</span>                 :             :             }</span>
<span id="L5458"><span class="lineNum">    5458</span>                 :             :         }</span>
<span id="L5459"><span class="lineNum">    5459</span>                 :             :         // assert(pindex-&gt;GetBlockHash() == pindex-&gt;GetBlockHeader().GetHash()); // Perhaps too slow</span>
<span id="L5460"><span class="lineNum">    5460</span>                 :             :         // End: actual consistency checks.</span>
<span id="L5461"><span class="lineNum">    5461</span>                 :             : </span>
<span id="L5462"><span class="lineNum">    5462</span>                 :             : </span>
<span id="L5463"><span class="lineNum">    5463</span>                 :             :         // Try descending into the first subnode. Always process forks first and the best header chain after.</span>
<span id="L5464"><span class="lineNum">    5464</span>                 :<span class="tlaGNC">    98206939 :         snap_update_firsts();</span></span>
<span id="L5465"><span class="lineNum">    5465</span>                 :<span class="tlaGNC">    98206939 :         auto range{forward.equal_range(pindex)};</span></span>
<span id="L5466"><span class="lineNum">    5466</span>         [<span class="tlaGBC" title="Branch 0 was taken 1650043 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 96556896 times"> + </span>]:<span class="tlaGNC">    98206939 :         if (range.first != range.second) {</span></span>
<span id="L5467"><span class="lineNum">    5467</span>                 :             :             // A subnode not part of the best header chain was found.</span>
<span id="L5468"><span class="lineNum">    5468</span>                 :<span class="tlaGNC">     1650043 :             pindex = range.first-&gt;second;</span></span>
<span id="L5469"><span class="lineNum">    5469</span>                 :<span class="tlaGNC">     1650043 :             nHeight++;</span></span>
<span id="L5470"><span class="lineNum">    5470</span>                 :<span class="tlaGNC">     1650043 :             continue;</span></span>
<span id="L5471"><span class="lineNum">    5471</span>         [<span class="tlaGBC" title="Branch 0 was taken 63715734 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 32841162 times"> + </span>]:<span class="tlaGNC">    96556896 :         } else if (best_hdr_chain.Contains(pindex)) {</span></span>
<span id="L5472"><span class="lineNum">    5472</span>                 :             :             // Descend further into best header chain.</span>
<span id="L5473"><span class="lineNum">    5473</span>                 :<span class="tlaGNC">    63715734 :             nHeight++;</span></span>
<span id="L5474"><span class="lineNum">    5474</span>         [<span class="tlaGBC" title="Branch 0 was taken 63715734 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">    63715734 :             pindex = best_hdr_chain[nHeight];</span></span>
<span id="L5475"><span class="lineNum">    5475</span>         [<span class="tlaGBC" title="Branch 0 was taken 62801920 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 913814 times"> + </span>]:<span class="tlaGNC">    63715734 :             if (!pindex) break; // we are finished, since the best header chain is always processed last</span></span>
<span id="L5476"><span class="lineNum">    5476</span>                 :<span class="tlaGNC">    62801920 :             continue;</span></span>
<span id="L5477"><span class="lineNum">    5477</span>                 :             :         }</span>
<span id="L5478"><span class="lineNum">    5478</span>                 :             :         // This is a leaf node.</span>
<span id="L5479"><span class="lineNum">    5479</span>                 :             :         // Move upwards until we reach a node of which we have not yet visited the last child.</span>
<span id="L5480"><span class="lineNum">    5480</span>         [<span class="tlaGBC" title="Branch 0 was taken 33285544 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">    33285544 :         while (pindex) {</span></span>
<span id="L5481"><span class="lineNum">    5481</span>                 :             :             // We are going to either move to a parent or a sibling of pindex.</span>
<span id="L5482"><span class="lineNum">    5482</span>                 :<span class="tlaGNC">    33285544 :             snap_update_firsts();</span></span>
<span id="L5483"><span class="lineNum">    5483</span>                 :             :             // If pindex was the first with a certain property, unset the corresponding variable.</span>
<span id="L5484"><span class="lineNum">    5484</span>         [<span class="tlaGBC" title="Branch 0 was taken 7964268 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 25321276 times"> + </span>]:<span class="tlaGNC">    33285544 :             if (pindex == pindexFirstInvalid) pindexFirstInvalid = nullptr;</span></span>
<span id="L5485"><span class="lineNum">    5485</span>         [<span class="tlaGBC" title="Branch 0 was taken 30343603 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 2941941 times"> + </span>]:<span class="tlaGNC">    33285544 :             if (pindex == pindexFirstMissing) pindexFirstMissing = nullptr;</span></span>
<span id="L5486"><span class="lineNum">    5486</span>         [<span class="tlaGBC" title="Branch 0 was taken 30343603 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 2941941 times"> + </span>]:<span class="tlaGNC">    33285544 :             if (pindex == pindexFirstNeverProcessed) pindexFirstNeverProcessed = nullptr;</span></span>
<span id="L5487"><span class="lineNum">    5487</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 33285544 times"> + </span>]:<span class="tlaGNC">    33285544 :             if (pindex == pindexFirstNotTreeValid) pindexFirstNotTreeValid = nullptr;</span></span>
<span id="L5488"><span class="lineNum">    5488</span>         [<span class="tlaGBC" title="Branch 0 was taken 30343603 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 2941941 times"> + </span>]:<span class="tlaGNC">    33285544 :             if (pindex == pindexFirstNotTransactionsValid) pindexFirstNotTransactionsValid = nullptr;</span></span>
<span id="L5489"><span class="lineNum">    5489</span>         [<span class="tlaGBC" title="Branch 0 was taken 31873723 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 1411821 times"> + </span>]:<span class="tlaGNC">    33285544 :             if (pindex == pindexFirstNotChainValid) pindexFirstNotChainValid = nullptr;</span></span>
<span id="L5490"><span class="lineNum">    5490</span>         [<span class="tlaGBC" title="Branch 0 was taken 31873723 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 1411821 times"> + </span>]:<span class="tlaGNC">    33285544 :             if (pindex == pindexFirstNotScriptsValid) pindexFirstNotScriptsValid = nullptr;</span></span>
<span id="L5491"><span class="lineNum">    5491</span>                 :             :             // Find our parent.</span>
<span id="L5492"><span class="lineNum">    5492</span>                 :<span class="tlaGNC">    33285544 :             CBlockIndex* pindexPar = pindex-&gt;pprev;</span></span>
<span id="L5493"><span class="lineNum">    5493</span>                 :             :             // Find which child we just visited.</span>
<span id="L5494"><span class="lineNum">    5494</span>                 :<span class="tlaGNC">    33285544 :             auto rangePar{forward.equal_range(pindexPar)};</span></span>
<span id="L5495"><span class="lineNum">    5495</span>         [<span class="tlaGBC" title="Branch 0 was taken 4961176187 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 33285544 times"> + </span>]:<span class="tlaGNC">  4994461731 :             while (rangePar.first-&gt;second != pindex) {</span></span>
<span id="L5496"><span class="lineNum">    5496</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 4961176187 times"> + </span>]:<span class="tlaGNC">  4961176187 :                 assert(rangePar.first != rangePar.second); // Our parent must have at least the node we're coming from as child.</span></span>
<span id="L5497"><span class="lineNum">    5497</span>                 :<span class="tlaGNC">  4961176187 :                 rangePar.first++;</span></span>
<span id="L5498"><span class="lineNum">    5498</span>                 :             :             }</span>
<span id="L5499"><span class="lineNum">    5499</span>                 :             :             // Proceed to the next one.</span>
<span id="L5500"><span class="lineNum">    5500</span>                 :<span class="tlaGNC">    33285544 :             rangePar.first++;</span></span>
<span id="L5501"><span class="lineNum">    5501</span>         [<span class="tlaGBC" title="Branch 0 was taken 31635501 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 1650043 times"> + </span>]:<span class="tlaGNC">    33285544 :             if (rangePar.first != rangePar.second) {</span></span>
<span id="L5502"><span class="lineNum">    5502</span>                 :             :                 // Move to a sibling not part of the best header chain.</span>
<span id="L5503"><span class="lineNum">    5503</span>                 :<span class="tlaGNC">    31635501 :                 pindex = rangePar.first-&gt;second;</span></span>
<span id="L5504"><span class="lineNum">    5504</span>                 :<span class="tlaGNC">    31635501 :                 break;</span></span>
<span id="L5505"><span class="lineNum">    5505</span>   [<span class="tlaGBC" title="Branch 0 was taken 1650043 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 1205661 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 444382 times"> + </span>]:<span class="tlaGNC">     3300086 :             } else if (pindexPar == best_hdr_chain[nHeight - 1]) {</span></span>
<span id="L5506"><span class="lineNum">    5506</span>                 :             :                 // Move to pindex's sibling on the best-chain, if it has one.</span>
<span id="L5507"><span class="lineNum">    5507</span>         [<span class="tlaGBC" title="Branch 0 was taken 1205661 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">     1205661 :                 pindex = best_hdr_chain[nHeight];</span></span>
<span id="L5508"><span class="lineNum">    5508</span>                 :             :                 // There will not be a next block if (and only if) parent block is the best header.</span>
<span id="L5509"><span class="lineNum">    5509</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 1205661 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 1205661 times"> + </span>]:<span class="tlaGNC">     2411322 :                 assert((pindex == nullptr) == (pindexPar == best_hdr_chain.Tip()));</span></span>
<span id="L5510"><span class="lineNum">    5510</span>                 :             :                 break;</span>
<span id="L5511"><span class="lineNum">    5511</span>                 :             :             } else {</span>
<span id="L5512"><span class="lineNum">    5512</span>                 :             :                 // Move up further.</span>
<span id="L5513"><span class="lineNum">    5513</span>                 :<span class="tlaGNC">      444382 :                 pindex = pindexPar;</span></span>
<span id="L5514"><span class="lineNum">    5514</span>                 :<span class="tlaGNC">      444382 :                 nHeight--;</span></span>
<span id="L5515"><span class="lineNum">    5515</span>                 :<span class="tlaGNC">      444382 :                 continue;</span></span>
<span id="L5516"><span class="lineNum">    5516</span>                 :             :             }</span>
<span id="L5517"><span class="lineNum">    5517</span>                 :             :         }</span>
<span id="L5518"><span class="lineNum">    5518</span>                 :             :     }</span>
<span id="L5519"><span class="lineNum">    5519</span>                 :             : </span>
<span id="L5520"><span class="lineNum">    5520</span>                 :             :     // Check that we actually traversed the entire block index.</span>
<span id="L5521"><span class="lineNum">    5521</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 931309 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 931309 times"> + </span>]:<span class="tlaGNC">      931309 :     assert(nNodes == forward.size() + best_hdr_chain.Height() + 1);</span></span>
<span id="L5522"><span class="lineNum">    5522</span>         [<span class="tlaGBC" title="Branch 0 was taken 931309 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">     1862618 : }</span></span>
<span id="L5523"><span class="lineNum">    5523</span>                 :             : </span>
<span id="L5524"><span class="lineNum">    5524</span>                 :<span class="tlaGNC">       12208 : std::string Chainstate::ToString()</span></span>
<span id="L5525"><span class="lineNum">    5525</span>                 :             : {</span>
<span id="L5526"><span class="lineNum">    5526</span>                 :<span class="tlaGNC">       12208 :     AssertLockHeld(::cs_main);</span></span>
<span id="L5527"><span class="lineNum">    5527</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 12208 times"> + </span>]:<span class="tlaGNC">       12208 :     CBlockIndex* tip = m_chain.Tip();</span></span>
<span id="L5528"><span class="lineNum">    5528</span>                 :<span class="tlaGNC">        9248 :     return strprintf(&quot;Chainstate [%s] @ height %d (%s)&quot;,</span></span>
<span id="L5529"><span class="lineNum">    5529</span>                 :<span class="tlaGNC">       24416 :                      m_from_snapshot_blockhash ? &quot;snapshot&quot; : &quot;ibd&quot;,</span></span>
<span id="L5530"><span class="lineNum">    5530</span>   [<span class="tlaGBC" title="Branch 0 was taken 9248 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 2960 times"> + </span> :<span class="tlaGNC">       36512 :                      tip ? tip-&gt;nHeight : -1, tip ? tip-&gt;GetBlockHash().ToString() : &quot;null&quot;);</span></span>
<span class="lineNum">        </span>    <span class="tlaGBC" title="Branch 4 was taken 12096 times"> + </span><span class="tlaGBC" title="Branch 5 was taken 112 times"> + </span><span class="tlaGBC" title="Branch 6 was taken 12208 times"> + </span><span class="tlaUNC" title="Branch 7 was not taken"> - </span>]
<span id="L5531"><span class="lineNum">    5531</span>                 :             : }</span>
<span id="L5532"><span class="lineNum">    5532</span>                 :             : </span>
<span id="L5533"><span class="lineNum">    5533</span>                 :<span class="tlaGNC">        8257 : bool Chainstate::ResizeCoinsCaches(size_t coinstip_size, size_t coinsdb_size)</span></span>
<span id="L5534"><span class="lineNum">    5534</span>                 :             : {</span>
<span id="L5535"><span class="lineNum">    5535</span>                 :<span class="tlaGNC">        8257 :     AssertLockHeld(::cs_main);</span></span>
<span id="L5536"><span class="lineNum">    5536</span>         [<span class="tlaGBC" title="Branch 0 was taken 3633 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 4624 times"> + </span>]:<span class="tlaGNC">        8257 :     if (coinstip_size == m_coinstip_cache_size_bytes &amp;&amp;</span></span>
<span id="L5537"><span class="lineNum">    5537</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 3633 times"> + </span>]:<span class="tlaGNC">        3633 :             coinsdb_size == m_coinsdb_cache_size_bytes) {</span></span>
<span id="L5538"><span class="lineNum">    5538</span>                 :             :         // Cache sizes are unchanged, no need to continue.</span>
<span id="L5539"><span class="lineNum">    5539</span>                 :             :         return true;</span>
<span id="L5540"><span class="lineNum">    5540</span>                 :             :     }</span>
<span id="L5541"><span class="lineNum">    5541</span>                 :<span class="tlaGNC">        4624 :     size_t old_coinstip_size = m_coinstip_cache_size_bytes;</span></span>
<span id="L5542"><span class="lineNum">    5542</span>                 :<span class="tlaGNC">        4624 :     m_coinstip_cache_size_bytes = coinstip_size;</span></span>
<span id="L5543"><span class="lineNum">    5543</span>                 :<span class="tlaGNC">        4624 :     m_coinsdb_cache_size_bytes = coinsdb_size;</span></span>
<span id="L5544"><span class="lineNum">    5544</span>                 :<span class="tlaGNC">        4624 :     CoinsDB().ResizeCache(coinsdb_size);</span></span>
<span id="L5545"><span class="lineNum">    5545</span>                 :             : </span>
<span id="L5546"><span class="lineNum">    5546</span>         [<span class="tlaGBC" title="Branch 0 was taken 4624 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        4624 :     LogInfo(&quot;[%s] resized coinsdb cache to %.1f MiB&quot;,</span></span>
<span id="L5547"><span class="lineNum">    5547</span>                 :             :         this-&gt;ToString(), coinsdb_size * (1.0 / 1024 / 1024));</span>
<span id="L5548"><span class="lineNum">    5548</span>         [<span class="tlaGBC" title="Branch 0 was taken 4624 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        4624 :     LogInfo(&quot;[%s] resized coinstip cache to %.1f MiB&quot;,</span></span>
<span id="L5549"><span class="lineNum">    5549</span>                 :             :         this-&gt;ToString(), coinstip_size * (1.0 / 1024 / 1024));</span>
<span id="L5550"><span class="lineNum">    5550</span>                 :             : </span>
<span id="L5551"><span class="lineNum">    5551</span>         [<span class="tlaGBC" title="Branch 0 was taken 2284 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 2340 times"> + </span>]:<span class="tlaGNC">        4624 :     BlockValidationState state;</span></span>
<span id="L5552"><span class="lineNum">    5552</span>                 :<span class="tlaGNC">        4624 :     bool ret;</span></span>
<span id="L5553"><span class="lineNum">    5553</span>                 :             : </span>
<span id="L5554"><span class="lineNum">    5554</span>         [<span class="tlaGBC" title="Branch 0 was taken 2284 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 2340 times"> + </span>]:<span class="tlaGNC">        4624 :     if (coinstip_size &gt; old_coinstip_size) {</span></span>
<span id="L5555"><span class="lineNum">    5555</span>                 :             :         // Likely no need to flush if cache sizes have grown.</span>
<span id="L5556"><span class="lineNum">    5556</span>         [<span class="tlaGBC" title="Branch 0 was taken 2284 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        2284 :         ret = FlushStateToDisk(state, FlushStateMode::IF_NEEDED);</span></span>
<span id="L5557"><span class="lineNum">    5557</span>                 :             :     } else {</span>
<span id="L5558"><span class="lineNum">    5558</span>                 :             :         // Otherwise, flush state to disk and deallocate the in-memory coins map.</span>
<span id="L5559"><span class="lineNum">    5559</span>         [<span class="tlaGBC" title="Branch 0 was taken 2340 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        2340 :         ret = FlushStateToDisk(state, FlushStateMode::ALWAYS);</span></span>
<span id="L5560"><span class="lineNum">    5560</span>                 :             :     }</span>
<span id="L5561"><span class="lineNum">    5561</span>                 :<span class="tlaGNC">        4624 :     return ret;</span></span>
<span id="L5562"><span class="lineNum">    5562</span>                 :<span class="tlaGNC">        4624 : }</span></span>
<span id="L5563"><span class="lineNum">    5563</span>                 :             : </span>
<span id="L5564"><span class="lineNum">    5564</span>                 :<span class="tlaGNC">      401442 : double ChainstateManager::GuessVerificationProgress(const CBlockIndex* pindex) const</span></span>
<span id="L5565"><span class="lineNum">    5565</span>                 :             : {</span>
<span id="L5566"><span class="lineNum">    5566</span>                 :<span class="tlaGNC">      401442 :     AssertLockHeld(GetMutex());</span></span>
<span id="L5567"><span class="lineNum">    5567</span>         [<span class="tlaGBC" title="Branch 0 was taken 401442 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      401442 :     const ChainTxData&amp; data{GetParams().TxData()};</span></span>
<span id="L5568"><span class="lineNum">    5568</span>         [<span class="tlaGBC" title="Branch 0 was taken 401442 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      401442 :     if (pindex == nullptr) {</span></span>
<span id="L5569"><span class="lineNum">    5569</span>                 :             :         return 0.0;</span>
<span id="L5570"><span class="lineNum">    5570</span>                 :             :     }</span>
<span id="L5571"><span class="lineNum">    5571</span>                 :             : </span>
<span id="L5572"><span class="lineNum">    5572</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 401442 times"> + </span>]:<span class="tlaGNC">      401442 :     if (pindex-&gt;m_chain_tx_count == 0) {</span></span>
<span id="L5573"><span class="lineNum">    5573</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LogDebug(BCLog::VALIDATION, &quot;Block %d has unset m_chain_tx_count. Unable to estimate verification progress.\n&quot;, pindex-&gt;nHeight);</span></span>
<span id="L5574"><span class="lineNum">    5574</span>                 :<span class="tlaUNC">           0 :         return 0.0;</span></span>
<span id="L5575"><span class="lineNum">    5575</span>                 :             :     }</span>
<span id="L5576"><span class="lineNum">    5576</span>                 :             : </span>
<span id="L5577"><span class="lineNum">    5577</span>                 :<span class="tlaGNC">      401442 :     const int64_t nNow{TicksSinceEpoch&lt;std::chrono::seconds&gt;(NodeClock::now())};</span></span>
<span id="L5578"><span class="lineNum">    5578</span>                 :<span class="tlaGNC">      401442 :     const auto block_time{</span></span>
<span id="L5579"><span class="lineNum">    5579</span>         [<span class="tlaGBC" title="Branch 0 was taken 162294 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 239148 times"> + </span>]:<span class="tlaGNC">      802884 :         (Assume(m_best_header) &amp;&amp; std::abs(nNow - pindex-&gt;GetBlockTime()) &lt;= Ticks&lt;std::chrono::seconds&gt;(2h) &amp;&amp;</span></span>
<span id="L5580"><span class="lineNum">    5580</span>   [<span class="tlaGBC" title="Branch 0 was taken 401442 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 162294 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      563736 :          Assume(m_best_header-&gt;nHeight &gt;= pindex-&gt;nHeight)) ?</span></span>
<span id="L5581"><span class="lineNum">    5581</span>                 :             :             // When the header is known to be recent, switch to a height-based</span>
<span id="L5582"><span class="lineNum">    5582</span>                 :             :             // approach. This ensures the returned value is quantized when</span>
<span id="L5583"><span class="lineNum">    5583</span>                 :             :             // close to &quot;1.0&quot;, because some users expect it to be. This also</span>
<span id="L5584"><span class="lineNum">    5584</span>                 :             :             // avoids relying too much on the exact miner-set timestamp, which</span>
<span id="L5585"><span class="lineNum">    5585</span>                 :             :             // may be off.</span>
<span id="L5586"><span class="lineNum">    5586</span>                 :<span class="tlaGNC">      162294 :             nNow - (m_best_header-&gt;nHeight - pindex-&gt;nHeight) * GetConsensus().nPowTargetSpacing :</span></span>
<span id="L5587"><span class="lineNum">    5587</span>                 :<span class="tlaGNC">      239148 :             pindex-&gt;GetBlockTime(),</span></span>
<span id="L5588"><span class="lineNum">    5588</span>                 :<span class="tlaGNC">      162294 :     };</span></span>
<span id="L5589"><span class="lineNum">    5589</span>                 :             : </span>
<span id="L5590"><span class="lineNum">    5590</span>                 :<span class="tlaGNC">      401442 :     double fTxTotal;</span></span>
<span id="L5591"><span class="lineNum">    5591</span>                 :             : </span>
<span id="L5592"><span class="lineNum">    5592</span>         [<span class="tlaGBC" title="Branch 0 was taken 2 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 401440 times"> + </span>]:<span class="tlaGNC">      401442 :     if (pindex-&gt;m_chain_tx_count &lt;= data.tx_count) {</span></span>
<span id="L5593"><span class="lineNum">    5593</span>                 :<span class="tlaGNC">           2 :         fTxTotal = data.tx_count + (nNow - data.nTime) * data.dTxRate;</span></span>
<span id="L5594"><span class="lineNum">    5594</span>                 :             :     } else {</span>
<span id="L5595"><span class="lineNum">    5595</span>                 :<span class="tlaGNC">      401440 :         fTxTotal = pindex-&gt;m_chain_tx_count + (nNow - block_time) * data.dTxRate;</span></span>
<span id="L5596"><span class="lineNum">    5596</span>                 :             :     }</span>
<span id="L5597"><span class="lineNum">    5597</span>                 :             : </span>
<span id="L5598"><span class="lineNum">    5598</span>         [<span class="tlaGBC" title="Branch 0 was taken 401442 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      401442 :     return std::min&lt;double&gt;(pindex-&gt;m_chain_tx_count / fTxTotal, 1.0);</span></span>
<span id="L5599"><span class="lineNum">    5599</span>                 :             : }</span>
<span id="L5600"><span class="lineNum">    5600</span>                 :             : </span>
<span id="L5601"><span class="lineNum">    5601</span>                 :<span class="tlaGNC">        9152 : std::optional&lt;uint256&gt; ChainstateManager::SnapshotBlockhash() const</span></span>
<span id="L5602"><span class="lineNum">    5602</span>                 :             : {</span>
<span id="L5603"><span class="lineNum">    5603</span>                 :<span class="tlaGNC">        9152 :     LOCK(::cs_main);</span></span>
<span id="L5604"><span class="lineNum">    5604</span>   [<span class="tlaGBC" title="Branch 0 was taken 9152 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 112 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 9040 times"> + </span>]:<span class="tlaGNC">        9152 :     if (m_active_chainstate &amp;&amp; m_active_chainstate-&gt;m_from_snapshot_blockhash) {</span></span>
<span id="L5605"><span class="lineNum">    5605</span>                 :             :         // If a snapshot chainstate exists, it will always be our active.</span>
<span id="L5606"><span class="lineNum">    5606</span>                 :<span class="tlaGNC">         112 :         return m_active_chainstate-&gt;m_from_snapshot_blockhash;</span></span>
<span id="L5607"><span class="lineNum">    5607</span>                 :             :     }</span>
<span id="L5608"><span class="lineNum">    5608</span>                 :<span class="tlaGNC">        9040 :     return std::nullopt;</span></span>
<span id="L5609"><span class="lineNum">    5609</span>                 :<span class="tlaGNC">        9152 : }</span></span>
<span id="L5610"><span class="lineNum">    5610</span>                 :             : </span>
<span id="L5611"><span class="lineNum">    5611</span>                 :<span class="tlaGNC">      712675 : std::vector&lt;Chainstate*&gt; ChainstateManager::GetAll()</span></span>
<span id="L5612"><span class="lineNum">    5612</span>                 :             : {</span>
<span id="L5613"><span class="lineNum">    5613</span>                 :<span class="tlaGNC">      712675 :     LOCK(::cs_main);</span></span>
<span id="L5614"><span class="lineNum">    5614</span>                 :<span class="tlaGNC">      712675 :     std::vector&lt;Chainstate*&gt; out;</span></span>
<span id="L5615"><span class="lineNum">    5615</span>                 :             : </span>
<span id="L5616"><span class="lineNum">    5616</span>         [<span class="tlaGBC" title="Branch 0 was taken 1425350 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 712675 times"> + </span>]:<span class="tlaGNC">     2138025 :     for (Chainstate* cs : {m_ibd_chainstate.get(), m_snapshot_chainstate.get()}) {</span></span>
<span id="L5617"><span class="lineNum">    5617</span>   [<span class="tlaGBC" title="Branch 0 was taken 712675 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 712675 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 712675 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">     2138025 :         if (this-&gt;IsUsable(cs)) out.push_back(cs);</span></span>
<span id="L5618"><span class="lineNum">    5618</span>                 :             :     }</span>
<span id="L5619"><span class="lineNum">    5619</span>                 :             : </span>
<span id="L5620"><span class="lineNum">    5620</span>         [<span class="tlaGBC" title="Branch 0 was taken 712675 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      712675 :     return out;</span></span>
<span id="L5621"><span class="lineNum">    5621</span>                 :<span class="tlaGNC">      712675 : }</span></span>
<span id="L5622"><span class="lineNum">    5622</span>                 :             : </span>
<span id="L5623"><span class="lineNum">    5623</span>                 :<span class="tlaGNC">        2960 : Chainstate&amp; ChainstateManager::InitializeChainstate(CTxMemPool* mempool)</span></span>
<span id="L5624"><span class="lineNum">    5624</span>                 :             : {</span>
<span id="L5625"><span class="lineNum">    5625</span>                 :<span class="tlaGNC">        2960 :     AssertLockHeld(::cs_main);</span></span>
<span id="L5626"><span class="lineNum">    5626</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 2960 times"> + </span>]:<span class="tlaGNC">        2960 :     assert(!m_ibd_chainstate);</span></span>
<span id="L5627"><span class="lineNum">    5627</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 2960 times"> + </span>]:<span class="tlaGNC">        2960 :     assert(!m_active_chainstate);</span></span>
<span id="L5628"><span class="lineNum">    5628</span>                 :             : </span>
<span id="L5629"><span class="lineNum">    5629</span>                 :<span class="tlaGNC">        2960 :     m_ibd_chainstate = std::make_unique&lt;Chainstate&gt;(mempool, m_blockman, *this);</span></span>
<span id="L5630"><span class="lineNum">    5630</span>                 :<span class="tlaGNC">        2960 :     m_active_chainstate = m_ibd_chainstate.get();</span></span>
<span id="L5631"><span class="lineNum">    5631</span>                 :<span class="tlaGNC">        2960 :     return *m_active_chainstate;</span></span>
<span id="L5632"><span class="lineNum">    5632</span>                 :             : }</span>
<span id="L5633"><span class="lineNum">    5633</span>                 :             : </span>
<span id="L5634"><span class="lineNum">    5634</span>                 :<span class="tlaUNC">           0 : [[nodiscard]] static bool DeleteCoinsDBFromDisk(const fs::path db_path, bool is_snapshot)</span></span>
<span id="L5635"><span class="lineNum">    5635</span>                 :             :     EXCLUSIVE_LOCKS_REQUIRED(::cs_main)</span>
<span id="L5636"><span class="lineNum">    5636</span>                 :             : {</span>
<span id="L5637"><span class="lineNum">    5637</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(::cs_main);</span></span>
<span id="L5638"><span class="lineNum">    5638</span>                 :             : </span>
<span id="L5639"><span class="lineNum">    5639</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (is_snapshot) {</span></span>
<span id="L5640"><span class="lineNum">    5640</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         fs::path base_blockhash_path = db_path / node::SNAPSHOT_BLOCKHASH_FILENAME;</span></span>
<span id="L5641"><span class="lineNum">    5641</span>                 :             : </span>
<span id="L5642"><span class="lineNum">    5642</span>                 :<span class="tlaUNC">           0 :         try {</span></span>
<span id="L5643"><span class="lineNum">    5643</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             bool existed = fs::remove(base_blockhash_path);</span></span>
<span id="L5644"><span class="lineNum">    5644</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (!existed) {</span></span>
<span id="L5645"><span class="lineNum">    5645</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 LogPrintf(&quot;[snapshot] snapshot chainstate dir being removed lacks %s file\n&quot;,</span></span>
<span id="L5646"><span class="lineNum">    5646</span>                 :             :                           fs::PathToString(node::SNAPSHOT_BLOCKHASH_FILENAME));</span>
<span id="L5647"><span class="lineNum">    5647</span>                 :             :             }</span>
<span id="L5648"><span class="lineNum">    5648</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaUNC">           0 :         } catch (const fs::filesystem_error&amp; e) {</span></span>
<span id="L5649"><span class="lineNum">    5649</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaUNC">           0 :             LogWarning(&quot;[snapshot] failed to remove file %s: %s\n&quot;,</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L5650"><span class="lineNum">    5650</span>                 :             :                        fs::PathToString(base_blockhash_path), e.code().message());</span>
<span id="L5651"><span class="lineNum">    5651</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaUNC">           0 :         }</span></span>
<span id="L5652"><span class="lineNum">    5652</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L5653"><span class="lineNum">    5653</span>                 :             : </span>
<span id="L5654"><span class="lineNum">    5654</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     std::string path_str = fs::PathToString(db_path);</span></span>
<span id="L5655"><span class="lineNum">    5655</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     LogInfo(&quot;Removing leveldb dir at %s\n&quot;, path_str);</span></span>
<span id="L5656"><span class="lineNum">    5656</span>                 :             : </span>
<span id="L5657"><span class="lineNum">    5657</span>                 :             :     // We have to destruct before this call leveldb::DB in order to release the db</span>
<span id="L5658"><span class="lineNum">    5658</span>                 :             :     // lock, otherwise `DestroyDB` will fail. See `leveldb::~DBImpl()`.</span>
<span id="L5659"><span class="lineNum">    5659</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     const bool destroyed = DestroyDB(path_str);</span></span>
<span id="L5660"><span class="lineNum">    5660</span>                 :             : </span>
<span id="L5661"><span class="lineNum">    5661</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!destroyed) {</span></span>
<span id="L5662"><span class="lineNum">    5662</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LogPrintf(&quot;error: leveldb DestroyDB call failed on %s\n&quot;, path_str);</span></span>
<span id="L5663"><span class="lineNum">    5663</span>                 :             :     }</span>
<span id="L5664"><span class="lineNum">    5664</span>                 :             : </span>
<span id="L5665"><span class="lineNum">    5665</span>                 :             :     // Datadir should be removed from filesystem; otherwise initialization may detect</span>
<span id="L5666"><span class="lineNum">    5666</span>                 :             :     // it on subsequent statups and get confused.</span>
<span id="L5667"><span class="lineNum">    5667</span>                 :             :     //</span>
<span id="L5668"><span class="lineNum">    5668</span>                 :             :     // If the base_blockhash_path removal above fails in the case of snapshot</span>
<span id="L5669"><span class="lineNum">    5669</span>                 :             :     // chainstates, this will return false since leveldb won't remove a non-empty</span>
<span id="L5670"><span class="lineNum">    5670</span>                 :             :     // directory.</span>
<span id="L5671"><span class="lineNum">    5671</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     return destroyed &amp;&amp; !fs::exists(db_path);</span></span>
<span id="L5672"><span class="lineNum">    5672</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L5673"><span class="lineNum">    5673</span>                 :             : </span>
<span id="L5674"><span class="lineNum">    5674</span>                 :<span class="tlaGNC">        2874 : util::Result&lt;CBlockIndex*&gt; ChainstateManager::ActivateSnapshot(</span></span>
<span id="L5675"><span class="lineNum">    5675</span>                 :             :         AutoFile&amp; coins_file,</span>
<span id="L5676"><span class="lineNum">    5676</span>                 :             :         const SnapshotMetadata&amp; metadata,</span>
<span id="L5677"><span class="lineNum">    5677</span>                 :             :         bool in_memory)</span>
<span id="L5678"><span class="lineNum">    5678</span>                 :             : {</span>
<span id="L5679"><span class="lineNum">    5679</span>                 :<span class="tlaGNC">        2874 :     uint256 base_blockhash = metadata.m_base_blockhash;</span></span>
<span id="L5680"><span class="lineNum">    5680</span>                 :             : </span>
<span id="L5681"><span class="lineNum">    5681</span>         [<span class="tlaGBC" title="Branch 0 was taken 56 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 2818 times"> + </span>]:<span class="tlaGNC">        2874 :     if (this-&gt;SnapshotBlockhash()) {</span></span>
<span id="L5682"><span class="lineNum">    5682</span>         [<span class="tlaGBC" title="Branch 0 was taken 56 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">         168 :         return util::Error{Untranslated(&quot;Can't activate a snapshot-based chainstate more than once&quot;)};</span></span>
<span id="L5683"><span class="lineNum">    5683</span>                 :             :     }</span>
<span id="L5684"><span class="lineNum">    5684</span>                 :             : </span>
<span id="L5685"><span class="lineNum">    5685</span>                 :<span class="tlaGNC">        2818 :     CBlockIndex* snapshot_start_block{};</span></span>
<span id="L5686"><span class="lineNum">    5686</span>                 :             : </span>
<span id="L5687"><span class="lineNum">    5687</span>                 :<span class="tlaGNC">        2818 :     {</span></span>
<span id="L5688"><span class="lineNum">    5688</span>                 :<span class="tlaGNC">        2818 :         LOCK(::cs_main);</span></span>
<span id="L5689"><span class="lineNum">    5689</span>                 :             : </span>
<span id="L5690"><span class="lineNum">    5690</span>         [<span class="tlaGBC" title="Branch 0 was taken 496 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 2322 times"> + </span>]:<span class="tlaGNC">        2818 :         if (!GetParams().AssumeutxoForBlockhash(base_blockhash).has_value()) {</span></span>
<span id="L5691"><span class="lineNum">    5691</span>         [<span class="tlaGBC" title="Branch 0 was taken 496 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">         496 :             auto available_heights = GetParams().GetAvailableSnapshotHeights();</span></span>
<span id="L5692"><span class="lineNum">    5692</span>   [<span class="tlaGBC" title="Branch 0 was taken 496 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 1488 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">        1984 :             std::string heights_formatted = util::Join(available_heights, &quot;, &quot;, [&amp;](const auto&amp; i) { return util::ToString(i); });</span></span>
<span id="L5693"><span class="lineNum">    5693</span>   [<span class="tlaGBC" title="Branch 0 was taken 496 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 496 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">         992 :             return util::Error{Untranslated(strprintf(&quot;assumeutxo block hash in snapshot metadata not recognized (hash: %s). The following snapshot heights are available: %s&quot;,</span></span>
<span id="L5694"><span class="lineNum">    5694</span>         [<span class="tlaGBC" title="Branch 0 was taken 496 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">         992 :                 base_blockhash.ToString(),</span></span>
<span id="L5695"><span class="lineNum">    5695</span>                 :<span class="tlaGNC">         496 :                 heights_formatted))};</span></span>
<span id="L5696"><span class="lineNum">    5696</span>                 :<span class="tlaGNC">         496 :         }</span></span>
<span id="L5697"><span class="lineNum">    5697</span>                 :             : </span>
<span id="L5698"><span class="lineNum">    5698</span>         [<span class="tlaGBC" title="Branch 0 was taken 2322 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        2322 :         snapshot_start_block = m_blockman.LookupBlockIndex(base_blockhash);</span></span>
<span id="L5699"><span class="lineNum">    5699</span>         [<span class="tlaGBC" title="Branch 0 was taken 38 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 2284 times"> + </span>]:<span class="tlaGNC">        2322 :         if (!snapshot_start_block) {</span></span>
<span id="L5700"><span class="lineNum">    5700</span>   [<span class="tlaGBC" title="Branch 0 was taken 38 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 38 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">          76 :             return util::Error{Untranslated(strprintf(&quot;The base block header (%s) must appear in the headers chain. Make sure all headers are syncing, and call loadtxoutset again&quot;,</span></span>
<span id="L5701"><span class="lineNum">    5701</span>         [<span class="tlaGBC" title="Branch 0 was taken 38 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">         114 :                           base_blockhash.ToString()))};</span></span>
<span id="L5702"><span class="lineNum">    5702</span>                 :             :         }</span>
<span id="L5703"><span class="lineNum">    5703</span>                 :             : </span>
<span id="L5704"><span class="lineNum">    5704</span>                 :<span class="tlaGNC">        2284 :         bool start_block_invalid = snapshot_start_block-&gt;nStatus &amp; BLOCK_FAILED_MASK;</span></span>
<span id="L5705"><span class="lineNum">    5705</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 2284 times"> + </span>]:<span class="tlaGNC">        2284 :         if (start_block_invalid) {</span></span>
<span id="L5706"><span class="lineNum">    5706</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             return util::Error{Untranslated(strprintf(&quot;The base block header (%s) is part of an invalid chain&quot;, base_blockhash.ToString()))};</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L5707"><span class="lineNum">    5707</span>                 :             :         }</span>
<span id="L5708"><span class="lineNum">    5708</span>                 :             : </span>
<span id="L5709"><span class="lineNum">    5709</span>   [<span class="tlaGBC" title="Branch 0 was taken 2284 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 2284 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">        2284 :         if (!m_best_header || m_best_header-&gt;GetAncestor(snapshot_start_block-&gt;nHeight) != snapshot_start_block) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaGBC" title="Branch 5 was taken 2284 times"> + </span>]
<span id="L5710"><span class="lineNum">    5710</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             return util::Error{Untranslated(&quot;A forked headers-chain with more work than the chain with the snapshot base block header exists. Please proceed to sync without AssumeUtxo.&quot;)};</span></span>
<span id="L5711"><span class="lineNum">    5711</span>                 :             :         }</span>
<span id="L5712"><span class="lineNum">    5712</span>                 :             : </span>
<span id="L5713"><span class="lineNum">    5713</span>         [<span class="tlaGBC" title="Branch 0 was taken 2284 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        2284 :         auto mempool{m_active_chainstate-&gt;GetMempool()};</span></span>
<span id="L5714"><span class="lineNum">    5714</span>   [<span class="tlaGBC" title="Branch 0 was taken 2284 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 2284 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">        2284 :         if (mempool &amp;&amp; mempool-&gt;size() &gt; 0) {</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 2284 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L5715"><span class="lineNum">    5715</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             return util::Error{Untranslated(&quot;Can't activate a snapshot when mempool not empty&quot;)};</span></span>
<span id="L5716"><span class="lineNum">    5716</span>                 :             :         }</span>
<span id="L5717"><span class="lineNum">    5717</span>                 :<span class="tlaGNC">         534 :     }</span></span>
<span id="L5718"><span class="lineNum">    5718</span>                 :             : </span>
<span id="L5719"><span class="lineNum">    5719</span>                 :<span class="tlaGNC">        2284 :     int64_t current_coinsdb_cache_size{0};</span></span>
<span id="L5720"><span class="lineNum">    5720</span>                 :<span class="tlaGNC">        2284 :     int64_t current_coinstip_cache_size{0};</span></span>
<span id="L5721"><span class="lineNum">    5721</span>                 :             : </span>
<span id="L5722"><span class="lineNum">    5722</span>                 :             :     // Cache percentages to allocate to each chainstate.</span>
<span id="L5723"><span class="lineNum">    5723</span>                 :             :     //</span>
<span id="L5724"><span class="lineNum">    5724</span>                 :             :     // These particular percentages don't matter so much since they will only be</span>
<span id="L5725"><span class="lineNum">    5725</span>                 :             :     // relevant during snapshot activation; caches are rebalanced at the conclusion of</span>
<span id="L5726"><span class="lineNum">    5726</span>                 :             :     // this function. We want to give (essentially) all available cache capacity to the</span>
<span id="L5727"><span class="lineNum">    5727</span>                 :             :     // snapshot to aid the bulk load later in this function.</span>
<span id="L5728"><span class="lineNum">    5728</span>                 :<span class="tlaGNC">        2284 :     static constexpr double IBD_CACHE_PERC = 0.01;</span></span>
<span id="L5729"><span class="lineNum">    5729</span>                 :<span class="tlaGNC">        2284 :     static constexpr double SNAPSHOT_CACHE_PERC = 0.99;</span></span>
<span id="L5730"><span class="lineNum">    5730</span>                 :             : </span>
<span id="L5731"><span class="lineNum">    5731</span>                 :<span class="tlaGNC">        2284 :     {</span></span>
<span id="L5732"><span class="lineNum">    5732</span>                 :<span class="tlaGNC">        2284 :         LOCK(::cs_main);</span></span>
<span id="L5733"><span class="lineNum">    5733</span>                 :             :         // Resize the coins caches to ensure we're not exceeding memory limits.</span>
<span id="L5734"><span class="lineNum">    5734</span>                 :             :         //</span>
<span id="L5735"><span class="lineNum">    5735</span>                 :             :         // Allocate the majority of the cache to the incoming snapshot chainstate, since</span>
<span id="L5736"><span class="lineNum">    5736</span>                 :             :         // (optimistically) getting to its tip will be the top priority. We'll need to call</span>
<span id="L5737"><span class="lineNum">    5737</span>                 :             :         // `MaybeRebalanceCaches()` once we're done with this function to ensure</span>
<span id="L5738"><span class="lineNum">    5738</span>                 :             :         // the right allocation (including the possibility that no snapshot was activated</span>
<span id="L5739"><span class="lineNum">    5739</span>                 :             :         // and that we should restore the active chainstate caches to their original size).</span>
<span id="L5740"><span class="lineNum">    5740</span>                 :             :         //</span>
<span id="L5741"><span class="lineNum">    5741</span>         [<span class="tlaGBC" title="Branch 0 was taken 2284 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        2284 :         current_coinsdb_cache_size = this-&gt;ActiveChainstate().m_coinsdb_cache_size_bytes;</span></span>
<span id="L5742"><span class="lineNum">    5742</span>         [<span class="tlaGBC" title="Branch 0 was taken 2284 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        2284 :         current_coinstip_cache_size = this-&gt;ActiveChainstate().m_coinstip_cache_size_bytes;</span></span>
<span id="L5743"><span class="lineNum">    5743</span>                 :             : </span>
<span id="L5744"><span class="lineNum">    5744</span>                 :             :         // Temporarily resize the active coins cache to make room for the newly-created</span>
<span id="L5745"><span class="lineNum">    5745</span>                 :             :         // snapshot chain.</span>
<span id="L5746"><span class="lineNum">    5746</span>         [<span class="tlaGBC" title="Branch 0 was taken 2284 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        2284 :         this-&gt;ActiveChainstate().ResizeCoinsCaches(</span></span>
<span id="L5747"><span class="lineNum">    5747</span>                 :<span class="tlaGNC">        2284 :             static_cast&lt;size_t&gt;(current_coinstip_cache_size * IBD_CACHE_PERC),</span></span>
<span id="L5748"><span class="lineNum">    5748</span>         [<span class="tlaGBC" title="Branch 0 was taken 2284 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        2284 :             static_cast&lt;size_t&gt;(current_coinsdb_cache_size * IBD_CACHE_PERC));</span></span>
<span id="L5749"><span class="lineNum">    5749</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L5750"><span class="lineNum">    5750</span>                 :             : </span>
<span id="L5751"><span class="lineNum">    5751</span>         [<span class="tlaGBC" title="Branch 0 was taken 2284 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        6852 :     auto snapshot_chainstate = WITH_LOCK(::cs_main,</span></span>
<span id="L5752"><span class="lineNum">    5752</span>                 :             :         return std::make_unique&lt;Chainstate&gt;(</span>
<span id="L5753"><span class="lineNum">    5753</span>                 :             :             /*mempool=*/nullptr, m_blockman, *this, base_blockhash));</span>
<span id="L5754"><span class="lineNum">    5754</span>                 :             : </span>
<span id="L5755"><span class="lineNum">    5755</span>                 :<span class="tlaGNC">        2284 :     {</span></span>
<span id="L5756"><span class="lineNum">    5756</span>         [<span class="tlaGBC" title="Branch 0 was taken 2284 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        2284 :         LOCK(::cs_main);</span></span>
<span id="L5757"><span class="lineNum">    5757</span>         [<span class="tlaGBC" title="Branch 0 was taken 2284 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        2284 :         snapshot_chainstate-&gt;InitCoinsDB(</span></span>
<span id="L5758"><span class="lineNum">    5758</span>                 :<span class="tlaGNC">        2284 :             static_cast&lt;size_t&gt;(current_coinsdb_cache_size * SNAPSHOT_CACHE_PERC),</span></span>
<span id="L5759"><span class="lineNum">    5759</span>         [<span class="tlaGBC" title="Branch 0 was taken 2284 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        2284 :             in_memory, false, &quot;chainstate&quot;);</span></span>
<span id="L5760"><span class="lineNum">    5760</span>         [<span class="tlaGBC" title="Branch 0 was taken 2284 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        2284 :         snapshot_chainstate-&gt;InitCoinsCache(</span></span>
<span id="L5761"><span class="lineNum">    5761</span>         [<span class="tlaGBC" title="Branch 0 was taken 2284 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        2284 :             static_cast&lt;size_t&gt;(current_coinstip_cache_size * SNAPSHOT_CACHE_PERC));</span></span>
<span id="L5762"><span class="lineNum">    5762</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L5763"><span class="lineNum">    5763</span>                 :             : </span>
<span id="L5764"><span class="lineNum">    5764</span>                 :<span class="tlaGNC">        4512 :     auto cleanup_bad_snapshot = [&amp;](bilingual_str reason) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {</span></span>
<span id="L5765"><span class="lineNum">    5765</span>                 :<span class="tlaGNC">        2228 :         this-&gt;MaybeRebalanceCaches();</span></span>
<span id="L5766"><span class="lineNum">    5766</span>                 :             : </span>
<span id="L5767"><span class="lineNum">    5767</span>                 :             :         // PopulateAndValidateSnapshot can return (in error) before the leveldb datadir</span>
<span id="L5768"><span class="lineNum">    5768</span>                 :             :         // has been created, so only attempt removal if we got that far.</span>
<span id="L5769"><span class="lineNum">    5769</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 2228 times"> + </span>]:<span class="tlaGNC">        2228 :         if (auto snapshot_datadir = node::FindSnapshotChainstateDir(m_options.datadir)) {</span></span>
<span id="L5770"><span class="lineNum">    5770</span>                 :             :             // We have to destruct leveldb::DB in order to release the db lock, otherwise</span>
<span id="L5771"><span class="lineNum">    5771</span>                 :             :             // DestroyDB() (in DeleteCoinsDBFromDisk()) will fail. See `leveldb::~DBImpl()`.</span>
<span id="L5772"><span class="lineNum">    5772</span>                 :             :             // Destructing the chainstate (and so resetting the coinsviews object) does this.</span>
<span id="L5773"><span class="lineNum">    5773</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             snapshot_chainstate.reset();</span></span>
<span id="L5774"><span class="lineNum">    5774</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             bool removed = DeleteCoinsDBFromDisk(*snapshot_datadir, /*is_snapshot=*/true);</span></span>
<span id="L5775"><span class="lineNum">    5775</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             if (!removed) {</span></span>
<span id="L5776"><span class="lineNum">    5776</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                 GetNotifications().fatalError(strprintf(_(&quot;Failed to remove snapshot chainstate dir (%s). &quot;</span></span>
<span id="L5777"><span class="lineNum">    5777</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     &quot;Manually remove it before restarting.\n&quot;), fs::PathToString(*snapshot_datadir)));</span></span>
<span id="L5778"><span class="lineNum">    5778</span>                 :             :             }</span>
<span id="L5779"><span class="lineNum">    5779</span>                 :<span class="tlaGNC">        2228 :         }</span></span>
<span id="L5780"><span class="lineNum">    5780</span>                 :<span class="tlaGNC">        2228 :         return util::Error{std::move(reason)};</span></span>
<span id="L5781"><span class="lineNum">    5781</span>                 :<span class="tlaGNC">        2284 :     };</span></span>
<span id="L5782"><span class="lineNum">    5782</span>                 :             : </span>
<span id="L5783"><span class="lineNum">    5783</span>   [<span class="tlaGBC" title="Branch 0 was taken 2284 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 2228 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 56 times"> + </span>]:<span class="tlaGNC">        2284 :     if (auto res{this-&gt;PopulateAndValidateSnapshot(*snapshot_chainstate, coins_file, metadata)}; !res) {</span></span>
<span id="L5784"><span class="lineNum">    5784</span>         [<span class="tlaGBC" title="Branch 0 was taken 2228 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        2228 :         LOCK(::cs_main);</span></span>
<span id="L5785"><span class="lineNum">    5785</span>   [<span class="tlaGBC" title="Branch 0 was taken 2228 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 2228 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">       11140 :         return cleanup_bad_snapshot(Untranslated(strprintf(&quot;Population failed: %s&quot;, util::ErrorString(res).original)));</span></span>
<span class="lineNum">        </span> <span class="tlaGBC" title="Branch 4 was taken 2228 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaGBC" title="Branch 6 was taken 2228 times"> + </span><span class="tlaUNC" title="Branch 7 was not taken"> - </span><span class="tlaGBC" title="Branch 8 was taken 2228 times"> + </span> 
<span class="lineNum">        </span>             <span class="tlaUNC" title="Branch 9 was not taken"> - </span>]
<span id="L5786"><span class="lineNum">    5786</span>                 :<span class="tlaGNC">        2228 :     }</span></span>
<span id="L5787"><span class="lineNum">    5787</span>                 :             : </span>
<span id="L5788"><span class="lineNum">    5788</span>         [<span class="tlaGBC" title="Branch 0 was taken 56 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">          56 :     LOCK(::cs_main);  // cs_main required for rest of snapshot activation.</span></span>
<span id="L5789"><span class="lineNum">    5789</span>                 :             : </span>
<span id="L5790"><span class="lineNum">    5790</span>                 :             :     // Do a final check to ensure that the snapshot chainstate is actually a more</span>
<span id="L5791"><span class="lineNum">    5791</span>                 :             :     // work chain than the active chainstate; a user could have loaded a snapshot</span>
<span id="L5792"><span class="lineNum">    5792</span>                 :             :     // very late in the IBD process, and we wouldn't want to load a useless chainstate.</span>
<span id="L5793"><span class="lineNum">    5793</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 56 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 56 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">         112 :     if (!CBlockIndexWorkComparator()(ActiveTip(), snapshot_chainstate-&gt;m_chain.Tip())) {</span></span>
<span class="lineNum">        </span>    <span class="tlaGBC" title="Branch 4 was taken 56 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaUNC" title="Branch 6 was not taken"> - </span><span class="tlaGBC" title="Branch 7 was taken 56 times"> + </span>]
<span id="L5794"><span class="lineNum">    5794</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         return cleanup_bad_snapshot(Untranslated(&quot;work does not exceed active chainstate&quot;));</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L5795"><span class="lineNum">    5795</span>                 :             :     }</span>
<span id="L5796"><span class="lineNum">    5796</span>                 :             :     // If not in-memory, persist the base blockhash for use during subsequent</span>
<span id="L5797"><span class="lineNum">    5797</span>                 :             :     // initialization.</span>
<span id="L5798"><span class="lineNum">    5798</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 56 times"> + </span>]:<span class="tlaGNC">          56 :     if (!in_memory) {</span></span>
<span id="L5799"><span class="lineNum">    5799</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!node::WriteSnapshotBaseBlockhash(*snapshot_chainstate)) {</span></span>
<span id="L5800"><span class="lineNum">    5800</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             return cleanup_bad_snapshot(Untranslated(&quot;could not write base blockhash&quot;));</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L5801"><span class="lineNum">    5801</span>                 :             :         }</span>
<span id="L5802"><span class="lineNum">    5802</span>                 :             :     }</span>
<span id="L5803"><span class="lineNum">    5803</span>                 :             : </span>
<span id="L5804"><span class="lineNum">    5804</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 56 times"> + </span>]:<span class="tlaGNC">          56 :     assert(!m_snapshot_chainstate);</span></span>
<span id="L5805"><span class="lineNum">    5805</span>         [<span class="tlaGBC" title="Branch 0 was taken 56 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">          56 :     m_snapshot_chainstate.swap(snapshot_chainstate);</span></span>
<span id="L5806"><span class="lineNum">    5806</span>         [<span class="tlaGBC" title="Branch 0 was taken 56 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">          56 :     const bool chaintip_loaded = m_snapshot_chainstate-&gt;LoadChainTip();</span></span>
<span id="L5807"><span class="lineNum">    5807</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 56 times"> + </span>]:<span class="tlaGNC">          56 :     assert(chaintip_loaded);</span></span>
<span id="L5808"><span class="lineNum">    5808</span>                 :             : </span>
<span id="L5809"><span class="lineNum">    5809</span>                 :             :     // Transfer possession of the mempool to the snapshot chainstate.</span>
<span id="L5810"><span class="lineNum">    5810</span>                 :             :     // Mempool is empty at this point because we're still in IBD.</span>
<span id="L5811"><span class="lineNum">    5811</span>   [<span class="tlaGBC" title="Branch 0 was taken 56 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 56 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">          56 :     Assert(m_active_chainstate-&gt;m_mempool-&gt;size() == 0);</span></span>
<span id="L5812"><span class="lineNum">    5812</span>         [<span class="tlaGBC" title="Branch 0 was taken 56 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">          56 :     Assert(!m_snapshot_chainstate-&gt;m_mempool);</span></span>
<span id="L5813"><span class="lineNum">    5813</span>         [<span class="tlaGBC" title="Branch 0 was taken 56 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">          56 :     m_snapshot_chainstate-&gt;m_mempool = m_active_chainstate-&gt;m_mempool;</span></span>
<span id="L5814"><span class="lineNum">    5814</span>                 :<span class="tlaGNC">          56 :     m_active_chainstate-&gt;m_mempool = nullptr;</span></span>
<span id="L5815"><span class="lineNum">    5815</span>                 :<span class="tlaGNC">          56 :     m_active_chainstate = m_snapshot_chainstate.get();</span></span>
<span id="L5816"><span class="lineNum">    5816</span>         [<span class="tlaGBC" title="Branch 0 was taken 56 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">          56 :     m_blockman.m_snapshot_height = this-&gt;GetSnapshotBaseHeight();</span></span>
<span id="L5817"><span class="lineNum">    5817</span>                 :             : </span>
<span id="L5818"><span class="lineNum">    5818</span>   [<span class="tlaGBC" title="Branch 0 was taken 56 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 56 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">          56 :     LogInfo(&quot;[snapshot] successfully activated snapshot %s&quot;, base_blockhash.ToString());</span></span>
<span id="L5819"><span class="lineNum">    5819</span>   [<span class="tlaGBC" title="Branch 0 was taken 56 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 56 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">          56 :     LogInfo(&quot;[snapshot] (%.2f MB)&quot;,</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 56 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L5820"><span class="lineNum">    5820</span>                 :             :         m_snapshot_chainstate-&gt;CoinsTip().DynamicMemoryUsage() / (1000 * 1000));</span>
<span id="L5821"><span class="lineNum">    5821</span>                 :             : </span>
<span id="L5822"><span class="lineNum">    5822</span>         [<span class="tlaGBC" title="Branch 0 was taken 56 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">          56 :     this-&gt;MaybeRebalanceCaches();</span></span>
<span id="L5823"><span class="lineNum">    5823</span>                 :<span class="tlaGNC">          56 :     return snapshot_start_block;</span></span>
<span id="L5824"><span class="lineNum">    5824</span>                 :<span class="tlaGNC">        2284 : }</span></span>
<span id="L5825"><span class="lineNum">    5825</span>                 :             : </span>
<span id="L5826"><span class="lineNum">    5826</span>                 :<span class="tlaGNC">        1380 : static void FlushSnapshotToDisk(CCoinsViewCache&amp; coins_cache, bool snapshot_loaded)</span></span>
<span id="L5827"><span class="lineNum">    5827</span>                 :             : {</span>
<span id="L5828"><span class="lineNum">    5828</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 1380 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 1380 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">        2760 :     LOG_TIME_MILLIS_WITH_CATEGORY_MSG_ONCE(</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 1380 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L5829"><span class="lineNum">    5829</span>                 :             :         strprintf(&quot;%s (%.2f MB)&quot;,</span>
<span id="L5830"><span class="lineNum">    5830</span>                 :             :                   snapshot_loaded ? &quot;saving snapshot chainstate&quot; : &quot;flushing coins cache&quot;,</span>
<span id="L5831"><span class="lineNum">    5831</span>                 :             :                   coins_cache.DynamicMemoryUsage() / (1000 * 1000)),</span>
<span id="L5832"><span class="lineNum">    5832</span>                 :             :         BCLog::LogFlags::ALL);</span>
<span id="L5833"><span class="lineNum">    5833</span>                 :             : </span>
<span id="L5834"><span class="lineNum">    5834</span>         [<span class="tlaGBC" title="Branch 0 was taken 1380 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        1380 :     coins_cache.Flush();</span></span>
<span id="L5835"><span class="lineNum">    5835</span>                 :<span class="tlaGNC">        1380 : }</span></span>
<span id="L5836"><span class="lineNum">    5836</span>                 :             : </span>
<span id="L5837"><span class="lineNum">    5837</span>                 :<span class="tlaUNC">           0 : struct StopHashingException : public std::exception</span></span>
<span id="L5838"><span class="lineNum">    5838</span>                 :             : {</span>
<span id="L5839"><span class="lineNum">    5839</span>                 :<span class="tlaUNC">           0 :     const char* what() const noexcept override</span></span>
<span id="L5840"><span class="lineNum">    5840</span>                 :             :     {</span>
<span id="L5841"><span class="lineNum">    5841</span>                 :<span class="tlaUNC">           0 :         return &quot;ComputeUTXOStats interrupted.&quot;;</span></span>
<span id="L5842"><span class="lineNum">    5842</span>                 :             :     }</span>
<span id="L5843"><span class="lineNum">    5843</span>                 :             : };</span>
<span id="L5844"><span class="lineNum">    5844</span>                 :             : </span>
<span id="L5845"><span class="lineNum">    5845</span>                 :<span class="tlaGNC">       36524 : static void SnapshotUTXOHashBreakpoint(const util::SignalInterrupt&amp; interrupt)</span></span>
<span id="L5846"><span class="lineNum">    5846</span>                 :             : {</span>
<span id="L5847"><span class="lineNum">    5847</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 36524 times"> + </span>]:<span class="tlaGNC">       36524 :     if (interrupt) throw StopHashingException();</span></span>
<span id="L5848"><span class="lineNum">    5848</span>                 :<span class="tlaGNC">       36524 : }</span></span>
<span id="L5849"><span class="lineNum">    5849</span>                 :             : </span>
<span id="L5850"><span class="lineNum">    5850</span>                 :<span class="tlaGNC">        2284 : util::Result&lt;void&gt; ChainstateManager::PopulateAndValidateSnapshot(</span></span>
<span id="L5851"><span class="lineNum">    5851</span>                 :             :     Chainstate&amp; snapshot_chainstate,</span>
<span id="L5852"><span class="lineNum">    5852</span>                 :             :     AutoFile&amp; coins_file,</span>
<span id="L5853"><span class="lineNum">    5853</span>                 :             :     const SnapshotMetadata&amp; metadata)</span>
<span id="L5854"><span class="lineNum">    5854</span>                 :             : {</span>
<span id="L5855"><span class="lineNum">    5855</span>                 :             :     // It's okay to release cs_main before we're done using `coins_cache` because we know</span>
<span id="L5856"><span class="lineNum">    5856</span>                 :             :     // that nothing else will be referencing the newly created snapshot_chainstate yet.</span>
<span id="L5857"><span class="lineNum">    5857</span>   [<span class="tlaGBC" title="Branch 0 was taken 2284 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 2284 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">        6852 :     CCoinsViewCache&amp; coins_cache = *WITH_LOCK(::cs_main, return &amp;snapshot_chainstate.CoinsTip());</span></span>
<span id="L5858"><span class="lineNum">    5858</span>                 :             : </span>
<span id="L5859"><span class="lineNum">    5859</span>                 :<span class="tlaGNC">        2284 :     uint256 base_blockhash = metadata.m_base_blockhash;</span></span>
<span id="L5860"><span class="lineNum">    5860</span>                 :             : </span>
<span id="L5861"><span class="lineNum">    5861</span>   [<span class="tlaGBC" title="Branch 0 was taken 2284 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 2284 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">        6852 :     CBlockIndex* snapshot_start_block = WITH_LOCK(::cs_main, return m_blockman.LookupBlockIndex(base_blockhash));</span></span>
<span id="L5862"><span class="lineNum">    5862</span>                 :             : </span>
<span id="L5863"><span class="lineNum">    5863</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 2284 times"> + </span>]:<span class="tlaGNC">        2284 :     if (!snapshot_start_block) {</span></span>
<span id="L5864"><span class="lineNum">    5864</span>                 :             :         // Needed for ComputeUTXOStats to determine the</span>
<span id="L5865"><span class="lineNum">    5865</span>                 :             :         // height and to avoid a crash when base_blockhash.IsNull()</span>
<span id="L5866"><span class="lineNum">    5866</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         return util::Error{Untranslated(strprintf(&quot;Did not find snapshot start blockheader %s&quot;,</span></span>
<span id="L5867"><span class="lineNum">    5867</span>                 :<span class="tlaUNC">           0 :                   base_blockhash.ToString()))};</span></span>
<span id="L5868"><span class="lineNum">    5868</span>                 :             :     }</span>
<span id="L5869"><span class="lineNum">    5869</span>                 :             : </span>
<span id="L5870"><span class="lineNum">    5870</span>                 :<span class="tlaGNC">        2284 :     int base_height = snapshot_start_block-&gt;nHeight;</span></span>
<span id="L5871"><span class="lineNum">    5871</span>                 :<span class="tlaGNC">        2284 :     const auto&amp; maybe_au_data = GetParams().AssumeutxoForHeight(base_height);</span></span>
<span id="L5872"><span class="lineNum">    5872</span>                 :             : </span>
<span id="L5873"><span class="lineNum">    5873</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 2284 times"> + </span>]:<span class="tlaGNC">        2284 :     if (!maybe_au_data) {</span></span>
<span id="L5874"><span class="lineNum">    5874</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         return util::Error{Untranslated(strprintf(&quot;Assumeutxo height in snapshot metadata not recognized &quot;</span></span>
<span id="L5875"><span class="lineNum">    5875</span>                 :<span class="tlaUNC">           0 :                   &quot;(%d) - refusing to load snapshot&quot;, base_height))};</span></span>
<span id="L5876"><span class="lineNum">    5876</span>                 :             :     }</span>
<span id="L5877"><span class="lineNum">    5877</span>                 :             : </span>
<span id="L5878"><span class="lineNum">    5878</span>                 :<span class="tlaGNC">        2284 :     const AssumeutxoData&amp; au_data = *maybe_au_data;</span></span>
<span id="L5879"><span class="lineNum">    5879</span>                 :             : </span>
<span id="L5880"><span class="lineNum">    5880</span>                 :             :     // This work comparison is a duplicate check with the one performed later in</span>
<span id="L5881"><span class="lineNum">    5881</span>                 :             :     // ActivateSnapshot(), but is done so that we avoid doing the long work of staging</span>
<span id="L5882"><span class="lineNum">    5882</span>                 :             :     // a snapshot that isn't actually usable.</span>
<span id="L5883"><span class="lineNum">    5883</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 2284 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 2284 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">        6852 :     if (WITH_LOCK(::cs_main, return !CBlockIndexWorkComparator()(ActiveTip(), snapshot_start_block))) {</span></span>
<span class="lineNum">        </span>    <span class="tlaGBC" title="Branch 4 was taken 2284 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span><span class="tlaGBC" title="Branch 6 was taken 2284 times"> + </span><span class="tlaUNC" title="Branch 7 was not taken"> - </span>]
<span id="L5884"><span class="lineNum">    5884</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         return util::Error{Untranslated(&quot;Work does not exceed active chainstate&quot;)};</span></span>
<span id="L5885"><span class="lineNum">    5885</span>                 :             :     }</span>
<span id="L5886"><span class="lineNum">    5886</span>                 :             : </span>
<span id="L5887"><span class="lineNum">    5887</span>                 :<span class="tlaGNC">        2284 :     const uint64_t coins_count = metadata.m_coins_count;</span></span>
<span id="L5888"><span class="lineNum">    5888</span>                 :<span class="tlaGNC">        2284 :     uint64_t coins_left = metadata.m_coins_count;</span></span>
<span id="L5889"><span class="lineNum">    5889</span>                 :             : </span>
<span id="L5890"><span class="lineNum">    5890</span>         [<span class="tlaGBC" title="Branch 0 was taken 2284 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        2284 :     LogInfo(&quot;[snapshot] loading %d coins from snapshot %s&quot;, coins_left, base_blockhash.ToString());</span></span>
<span id="L5891"><span class="lineNum">    5891</span>                 :<span class="tlaGNC">        2284 :     int64_t coins_processed{0};</span></span>
<span id="L5892"><span class="lineNum">    5892</span>                 :             : </span>
<span id="L5893"><span class="lineNum">    5893</span>         [<span class="tlaGBC" title="Branch 0 was taken 53020 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 1486 times"> + </span>]:<span class="tlaGNC">       54506 :     while (coins_left &gt; 0) {</span></span>
<span id="L5894"><span class="lineNum">    5894</span>                 :<span class="tlaGNC">       53020 :         try {</span></span>
<span id="L5895"><span class="lineNum">    5895</span>         [<span class="tlaGBC" title="Branch 0 was taken 52980 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 40 times"> + </span>]:<span class="tlaGNC">       53020 :             Txid txid;</span></span>
<span id="L5896"><span class="lineNum">    5896</span>         [<span class="tlaGBC" title="Branch 0 was taken 52980 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 40 times"> + </span>]:<span class="tlaGNC">       53020 :             coins_file &gt;&gt; txid;</span></span>
<span id="L5897"><span class="lineNum">    5897</span>                 :<span class="tlaGNC">       52980 :             size_t coins_per_txid{0};</span></span>
<span id="L5898"><span class="lineNum">    5898</span>         [<span class="tlaGBC" title="Branch 0 was taken 52912 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 68 times"> + </span>]:<span class="tlaGNC">       52980 :             coins_per_txid = ReadCompactSize(coins_file);</span></span>
<span id="L5899"><span class="lineNum">    5899</span>                 :             : </span>
<span id="L5900"><span class="lineNum">    5900</span>         [<span class="tlaGBC" title="Branch 0 was taken 82 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 52830 times"> + </span>]:<span class="tlaGNC">       52912 :             if (coins_per_txid &gt; coins_left) {</span></span>
<span id="L5901"><span class="lineNum">    5901</span>   [<span class="tlaGBC" title="Branch 0 was taken 82 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 82 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">         246 :                 return util::Error{Untranslated(&quot;Mismatch in coins count in snapshot metadata and actual snapshot data&quot;)};</span></span>
<span id="L5902"><span class="lineNum">    5902</span>                 :             :             }</span>
<span id="L5903"><span class="lineNum">    5903</span>                 :             : </span>
<span id="L5904"><span class="lineNum">    5904</span>         [<span class="tlaGBC" title="Branch 0 was taken 362186 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 52222 times"> + </span>]:<span class="tlaGNC">      414408 :             for (size_t i = 0; i &lt; coins_per_txid; i++) {</span></span>
<span id="L5905"><span class="lineNum">    5905</span>                 :<span class="tlaGNC">      362186 :                 COutPoint outpoint;</span></span>
<span id="L5906"><span class="lineNum">    5906</span>                 :<span class="tlaGNC">      362186 :                 Coin coin;</span></span>
<span id="L5907"><span class="lineNum">    5907</span>         [<span class="tlaGBC" title="Branch 0 was taken 362078 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 108 times"> + </span>]:<span class="tlaGNC">      362186 :                 outpoint.n = static_cast&lt;uint32_t&gt;(ReadCompactSize(coins_file));</span></span>
<span id="L5908"><span class="lineNum">    5908</span>                 :<span class="tlaGNC">      362078 :                 outpoint.hash = txid;</span></span>
<span id="L5909"><span class="lineNum">    5909</span>         [<span class="tlaGBC" title="Branch 0 was taken 361708 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 370 times"> + </span>]:<span class="tlaGNC">      362078 :                 coins_file &gt;&gt; coin;</span></span>
<span id="L5910"><span class="lineNum">    5910</span>         [<span class="tlaGBC" title="Branch 0 was taken 361614 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 94 times"> + </span>]:<span class="tlaGNC">      361708 :                 if (coin.nHeight &gt; base_height ||</span></span>
<span id="L5911"><span class="lineNum">    5911</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 361614 times"> + </span>]:<span class="tlaGNC">      361614 :                     outpoint.n &gt;= std::numeric_limits&lt;decltype(outpoint.n)&gt;::max() // Avoid integer wrap-around in coinstats.cpp:ApplyHash</span></span>
<span id="L5912"><span class="lineNum">    5912</span>                 :             :                 ) {</span>
<span id="L5913"><span class="lineNum">    5913</span>         [<span class="tlaGBC" title="Branch 0 was taken 94 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">         188 :                     return util::Error{Untranslated(strprintf(&quot;Bad snapshot data after deserializing %d coins&quot;,</span></span>
<span id="L5914"><span class="lineNum">    5914</span>         [<span class="tlaGBC" title="Branch 0 was taken 94 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">         188 :                               coins_count - coins_left))};</span></span>
<span id="L5915"><span class="lineNum">    5915</span>                 :             :                 }</span>
<span id="L5916"><span class="lineNum">    5916</span>         [<span class="tlaGBC" title="Branch 0 was taken 36 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 361578 times"> + </span>]:<span class="tlaGNC">      361614 :                 if (!MoneyRange(coin.out.nValue)) {</span></span>
<span id="L5917"><span class="lineNum">    5917</span>         [<span class="tlaGBC" title="Branch 0 was taken 36 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">          72 :                     return util::Error{Untranslated(strprintf(&quot;Bad snapshot data after deserializing %d coins - bad tx out value&quot;,</span></span>
<span id="L5918"><span class="lineNum">    5918</span>         [<span class="tlaGBC" title="Branch 0 was taken 36 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">          72 :                               coins_count - coins_left))};</span></span>
<span id="L5919"><span class="lineNum">    5919</span>                 :             :                 }</span>
<span id="L5920"><span class="lineNum">    5920</span>         [<span class="tlaGBC" title="Branch 0 was taken 361578 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      361578 :                 coins_cache.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));</span></span>
<span id="L5921"><span class="lineNum">    5921</span>                 :             : </span>
<span id="L5922"><span class="lineNum">    5922</span>                 :<span class="tlaGNC">      361578 :                 --coins_left;</span></span>
<span id="L5923"><span class="lineNum">    5923</span>                 :<span class="tlaGNC">      361578 :                 ++coins_processed;</span></span>
<span id="L5924"><span class="lineNum">    5924</span>                 :             : </span>
<span id="L5925"><span class="lineNum">    5925</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 361578 times"> + </span>]:<span class="tlaGNC">      361578 :                 if (coins_processed % 1000000 == 0) {</span></span>
<span id="L5926"><span class="lineNum">    5926</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     LogInfo(&quot;[snapshot] %d coins loaded (%.2f%%, %.2f MB)&quot;,</span></span>
<span id="L5927"><span class="lineNum">    5927</span>                 :             :                         coins_processed,</span>
<span id="L5928"><span class="lineNum">    5928</span>                 :             :                         static_cast&lt;float&gt;(coins_processed) * 100 / static_cast&lt;float&gt;(coins_count),</span>
<span id="L5929"><span class="lineNum">    5929</span>                 :             :                         coins_cache.DynamicMemoryUsage() / (1000 * 1000));</span>
<span id="L5930"><span class="lineNum">    5930</span>                 :             :                 }</span>
<span id="L5931"><span class="lineNum">    5931</span>                 :             : </span>
<span id="L5932"><span class="lineNum">    5932</span>                 :             :                 // Batch write and flush (if we need to) every so often.</span>
<span id="L5933"><span class="lineNum">    5933</span>                 :             :                 //</span>
<span id="L5934"><span class="lineNum">    5934</span>                 :             :                 // If our average Coin size is roughly 41 bytes, checking every 120,000 coins</span>
<span id="L5935"><span class="lineNum">    5935</span>                 :             :                 // means &lt;5MB of memory imprecision.</span>
<span id="L5936"><span class="lineNum">    5936</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 361578 times"> + </span>]:<span class="tlaGNC">      361578 :                 if (coins_processed % 120000 == 0) {</span></span>
<span id="L5937"><span class="lineNum">    5937</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     if (m_interrupt) {</span></span>
<span id="L5938"><span class="lineNum">    5938</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :                         return util::Error{Untranslated(&quot;Aborting after an interrupt was requested&quot;)};</span></span>
<span id="L5939"><span class="lineNum">    5939</span>                 :             :                     }</span>
<span id="L5940"><span class="lineNum">    5940</span>                 :             : </span>
<span id="L5941"><span class="lineNum">    5941</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :                     const auto snapshot_cache_state = WITH_LOCK(::cs_main,</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L5942"><span class="lineNum">    5942</span>                 :             :                         return snapshot_chainstate.GetCoinsCacheSizeState());</span>
<span id="L5943"><span class="lineNum">    5943</span>                 :             : </span>
<span id="L5944"><span class="lineNum">    5944</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                     if (snapshot_cache_state &gt;= CoinsCacheSizeState::CRITICAL) {</span></span>
<span id="L5945"><span class="lineNum">    5945</span>                 :             :                         // This is a hack - we don't know what the actual best block is, but that</span>
<span id="L5946"><span class="lineNum">    5946</span>                 :             :                         // doesn't matter for the purposes of flushing the cache here. We'll set this</span>
<span id="L5947"><span class="lineNum">    5947</span>                 :             :                         // to its correct value (`base_blockhash`) below after the coins are loaded.</span>
<span id="L5948"><span class="lineNum">    5948</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                         coins_cache.SetBestBlock(GetRandHash());</span></span>
<span id="L5949"><span class="lineNum">    5949</span>                 :             : </span>
<span id="L5950"><span class="lineNum">    5950</span>                 :             :                         // No need to acquire cs_main since this chainstate isn't being used yet.</span>
<span id="L5951"><span class="lineNum">    5951</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :                         FlushSnapshotToDisk(coins_cache, /*snapshot_loaded=*/false);</span></span>
<span id="L5952"><span class="lineNum">    5952</span>                 :             :                     }</span>
<span id="L5953"><span class="lineNum">    5953</span>                 :             :                 }</span>
<span id="L5954"><span class="lineNum">    5954</span>                 :<span class="tlaGNC">      362186 :             }</span></span>
<span id="L5955"><span class="lineNum">    5955</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 586 times"> + </span>]:<span class="tlaGNC">         586 :         } catch (const std::ios_base::failure&amp;) {</span></span>
<span id="L5956"><span class="lineNum">    5956</span>   [<span class="tlaGBC" title="Branch 0 was taken 586 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 586 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">        1172 :             return util::Error{Untranslated(strprintf(&quot;Bad snapshot format or truncated snapshot after deserializing %d coins&quot;,</span></span>
<span id="L5957"><span class="lineNum">    5957</span>                 :<span class="tlaGNC">         586 :                       coins_processed))};</span></span>
<span id="L5958"><span class="lineNum">    5958</span>                 :<span class="tlaGNC">         586 :         }</span></span>
<span id="L5959"><span class="lineNum">    5959</span>                 :             :     }</span>
<span id="L5960"><span class="lineNum">    5960</span>                 :             : </span>
<span id="L5961"><span class="lineNum">    5961</span>                 :             :     // Important that we set this. This and the coins_cache accesses above are</span>
<span id="L5962"><span class="lineNum">    5962</span>                 :             :     // sort of a layer violation, but either we reach into the innards of</span>
<span id="L5963"><span class="lineNum">    5963</span>                 :             :     // CCoinsViewCache here or we have to invert some of the Chainstate to</span>
<span id="L5964"><span class="lineNum">    5964</span>                 :             :     // embed them in a snapshot-activation-specific CCoinsViewCache bulk load</span>
<span id="L5965"><span class="lineNum">    5965</span>                 :             :     // method.</span>
<span id="L5966"><span class="lineNum">    5966</span>                 :<span class="tlaGNC">        1486 :     coins_cache.SetBestBlock(base_blockhash);</span></span>
<span id="L5967"><span class="lineNum">    5967</span>                 :             : </span>
<span id="L5968"><span class="lineNum">    5968</span>                 :<span class="tlaGNC">        1486 :     bool out_of_coins{false};</span></span>
<span id="L5969"><span class="lineNum">    5969</span>                 :<span class="tlaGNC">        1486 :     try {</span></span>
<span id="L5970"><span class="lineNum">    5970</span>                 :<span class="tlaGNC">        1486 :         std::byte left_over_byte;</span></span>
<span id="L5971"><span class="lineNum">    5971</span>         [<span class="tlaGBC" title="Branch 0 was taken 106 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 1380 times"> + </span>]:<span class="tlaGNC">        1486 :         coins_file &gt;&gt; left_over_byte;</span></span>
<span id="L5972"><span class="lineNum">    5972</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 1380 times"> + </span>]:<span class="tlaGNC">        1380 :     } catch (const std::ios_base::failure&amp;) {</span></span>
<span id="L5973"><span class="lineNum">    5973</span>                 :             :         // We expect an exception since we should be out of coins.</span>
<span id="L5974"><span class="lineNum">    5974</span>                 :<span class="tlaGNC">        1380 :         out_of_coins = true;</span></span>
<span id="L5975"><span class="lineNum">    5975</span>                 :<span class="tlaGNC">        1380 :     }</span></span>
<span id="L5976"><span class="lineNum">    5976</span>                 :<span class="tlaGNC">        1486 :     if (!out_of_coins) {</span></span>
<span id="L5977"><span class="lineNum">    5977</span>         [<span class="tlaGBC" title="Branch 0 was taken 106 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">         212 :         return util::Error{Untranslated(strprintf(&quot;Bad snapshot - coins left over after deserializing %d coins&quot;,</span></span>
<span id="L5978"><span class="lineNum">    5978</span>                 :<span class="tlaGNC">         106 :             coins_count))};</span></span>
<span id="L5979"><span class="lineNum">    5979</span>                 :             :     }</span>
<span id="L5980"><span class="lineNum">    5980</span>                 :             : </span>
<span id="L5981"><span class="lineNum">    5981</span>   [<span class="tlaGBC" title="Branch 0 was taken 1380 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 1380 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">        1380 :     LogInfo(&quot;[snapshot] loaded %d (%.2f MB) coins from snapshot %s&quot;,</span></span>
<span id="L5982"><span class="lineNum">    5982</span>                 :             :         coins_count,</span>
<span id="L5983"><span class="lineNum">    5983</span>                 :             :         coins_cache.DynamicMemoryUsage() / (1000 * 1000),</span>
<span id="L5984"><span class="lineNum">    5984</span>                 :             :         base_blockhash.ToString());</span>
<span id="L5985"><span class="lineNum">    5985</span>                 :             : </span>
<span id="L5986"><span class="lineNum">    5986</span>                 :             :     // No need to acquire cs_main since this chainstate isn't being used yet.</span>
<span id="L5987"><span class="lineNum">    5987</span>                 :<span class="tlaGNC">        1380 :     FlushSnapshotToDisk(coins_cache, /*snapshot_loaded=*/true);</span></span>
<span id="L5988"><span class="lineNum">    5988</span>                 :             : </span>
<span id="L5989"><span class="lineNum">    5989</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 1380 times"> + </span>]:<span class="tlaGNC">        1380 :     assert(coins_cache.GetBestBlock() == base_blockhash);</span></span>
<span id="L5990"><span class="lineNum">    5990</span>                 :             : </span>
<span id="L5991"><span class="lineNum">    5991</span>                 :             :     // As above, okay to immediately release cs_main here since no other context knows</span>
<span id="L5992"><span class="lineNum">    5992</span>                 :             :     // about the snapshot_chainstate.</span>
<span id="L5993"><span class="lineNum">    5993</span>   [<span class="tlaGBC" title="Branch 0 was taken 1380 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 1380 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">        4140 :     CCoinsViewDB* snapshot_coinsdb = WITH_LOCK(::cs_main, return &amp;snapshot_chainstate.CoinsDB());</span></span>
<span id="L5994"><span class="lineNum">    5994</span>                 :             : </span>
<span id="L5995"><span class="lineNum">    5995</span>                 :<span class="tlaGNC">        1380 :     std::optional&lt;CCoinsStats&gt; maybe_stats;</span></span>
<span id="L5996"><span class="lineNum">    5996</span>                 :             : </span>
<span id="L5997"><span class="lineNum">    5997</span>                 :<span class="tlaGNC">        1380 :     try {</span></span>
<span id="L5998"><span class="lineNum">    5998</span>                 :<span class="tlaGNC">        1380 :         maybe_stats = ComputeUTXOStats(</span></span>
<span id="L5999"><span class="lineNum">    5999</span>         [<span class="tlaGBC" title="Branch 0 was taken 1380 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       37904 :             CoinStatsHashType::HASH_SERIALIZED, snapshot_coinsdb, m_blockman, [&amp;interrupt = m_interrupt] { SnapshotUTXOHashBreakpoint(interrupt); });</span></span>
<span id="L6000"><span class="lineNum">    6000</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaUNC">           0 :     } catch (StopHashingException const&amp;) {</span></span>
<span id="L6001"><span class="lineNum">    6001</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaUNC">           0 :         return util::Error{Untranslated(&quot;Aborting after an interrupt was requested&quot;)};</span></span>
<span id="L6002"><span class="lineNum">    6002</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L6003"><span class="lineNum">    6003</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 1380 times"> + </span>]:<span class="tlaGNC">        1380 :     if (!maybe_stats.has_value()) {</span></span>
<span id="L6004"><span class="lineNum">    6004</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaUNC">           0 :         return util::Error{Untranslated(&quot;Failed to generate coins stats&quot;)};</span></span>
<span id="L6005"><span class="lineNum">    6005</span>                 :             :     }</span>
<span id="L6006"><span class="lineNum">    6006</span>                 :             : </span>
<span id="L6007"><span class="lineNum">    6007</span>                 :             :     // Assert that the deserialized chainstate contents match the expected assumeutxo value.</span>
<span id="L6008"><span class="lineNum">    6008</span>         [<span class="tlaGBC" title="Branch 0 was taken 1324 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 56 times"> + </span>]:<span class="tlaGNC">        1380 :     if (AssumeutxoHash{maybe_stats-&gt;hashSerialized} != au_data.hash_serialized) {</span></span>
<span id="L6009"><span class="lineNum">    6009</span>         [<span class="tlaGBC" title="Branch 0 was taken 1324 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        3972 :         return util::Error{Untranslated(strprintf(&quot;Bad snapshot content hash: expected %s, got %s&quot;,</span></span>
<span id="L6010"><span class="lineNum">    6010</span>   [<span class="tlaGBC" title="Branch 0 was taken 1324 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 1324 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">        3972 :             au_data.hash_serialized.ToString(), maybe_stats-&gt;hashSerialized.ToString()))};</span></span>
<span id="L6011"><span class="lineNum">    6011</span>                 :             :     }</span>
<span id="L6012"><span class="lineNum">    6012</span>                 :             : </span>
<span id="L6013"><span class="lineNum">    6013</span>                 :<span class="tlaGNC">          56 :     snapshot_chainstate.m_chain.SetTip(*snapshot_start_block);</span></span>
<span id="L6014"><span class="lineNum">    6014</span>                 :             : </span>
<span id="L6015"><span class="lineNum">    6015</span>                 :             :     // The remainder of this function requires modifying data protected by cs_main.</span>
<span id="L6016"><span class="lineNum">    6016</span>                 :<span class="tlaGNC">          56 :     LOCK(::cs_main);</span></span>
<span id="L6017"><span class="lineNum">    6017</span>                 :             : </span>
<span id="L6018"><span class="lineNum">    6018</span>                 :             :     // Fake various pieces of CBlockIndex state:</span>
<span id="L6019"><span class="lineNum">    6019</span>                 :<span class="tlaGNC">          56 :     CBlockIndex* index = nullptr;</span></span>
<span id="L6020"><span class="lineNum">    6020</span>                 :             : </span>
<span id="L6021"><span class="lineNum">    6021</span>                 :             :     // Don't make any modifications to the genesis block since it shouldn't be</span>
<span id="L6022"><span class="lineNum">    6022</span>                 :             :     // necessary, and since the genesis block doesn't have normal flags like</span>
<span id="L6023"><span class="lineNum">    6023</span>                 :             :     // BLOCK_VALID_SCRIPTS set.</span>
<span id="L6024"><span class="lineNum">    6024</span>                 :<span class="tlaGNC">          56 :     constexpr int AFTER_GENESIS_START{1};</span></span>
<span id="L6025"><span class="lineNum">    6025</span>                 :             : </span>
<span id="L6026"><span class="lineNum">    6026</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 11256 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 11200 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 56 times"> + </span>]:<span class="tlaGNC">       11256 :     for (int i = AFTER_GENESIS_START; i &lt;= snapshot_chainstate.m_chain.Height(); ++i) {</span></span>
<span id="L6027"><span class="lineNum">    6027</span>         [<span class="tlaGBC" title="Branch 0 was taken 11200 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       11200 :         index = snapshot_chainstate.m_chain[i];</span></span>
<span id="L6028"><span class="lineNum">    6028</span>                 :             : </span>
<span id="L6029"><span class="lineNum">    6029</span>                 :             :         // Fake BLOCK_OPT_WITNESS so that Chainstate::NeedsRedownload()</span>
<span id="L6030"><span class="lineNum">    6030</span>                 :             :         // won't ask for -reindex on startup.</span>
<span id="L6031"><span class="lineNum">    6031</span>         [<span class="tlaGBC" title="Branch 0 was taken 11200 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       11200 :         if (DeploymentActiveAt(*index, *this, Consensus::DEPLOYMENT_SEGWIT)) {</span></span>
<span id="L6032"><span class="lineNum">    6032</span>                 :<span class="tlaGNC">       11200 :             index-&gt;nStatus |= BLOCK_OPT_WITNESS;</span></span>
<span id="L6033"><span class="lineNum">    6033</span>                 :             :         }</span>
<span id="L6034"><span class="lineNum">    6034</span>                 :             : </span>
<span id="L6035"><span class="lineNum">    6035</span>         [<span class="tlaGBC" title="Branch 0 was taken 11200 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       11200 :         m_blockman.m_dirty_blockindex.insert(index);</span></span>
<span id="L6036"><span class="lineNum">    6036</span>                 :             :         // Changes to the block index will be flushed to disk after this call</span>
<span id="L6037"><span class="lineNum">    6037</span>                 :             :         // returns in `ActivateSnapshot()`, when `MaybeRebalanceCaches()` is</span>
<span id="L6038"><span class="lineNum">    6038</span>                 :             :         // called, since we've added a snapshot chainstate and therefore will</span>
<span id="L6039"><span class="lineNum">    6039</span>                 :             :         // have to downsize the IBD chainstate, which will result in a call to</span>
<span id="L6040"><span class="lineNum">    6040</span>                 :             :         // `FlushStateToDisk(ALWAYS)`.</span>
<span id="L6041"><span class="lineNum">    6041</span>                 :             :     }</span>
<span id="L6042"><span class="lineNum">    6042</span>                 :             : </span>
<span id="L6043"><span class="lineNum">    6043</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 56 times"> + </span>]:<span class="tlaGNC">          56 :     assert(index);</span></span>
<span id="L6044"><span class="lineNum">    6044</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 56 times"> + </span>]:<span class="tlaGNC">          56 :     assert(index == snapshot_start_block);</span></span>
<span id="L6045"><span class="lineNum">    6045</span>                 :<span class="tlaGNC">          56 :     index-&gt;m_chain_tx_count = au_data.m_chain_tx_count;</span></span>
<span id="L6046"><span class="lineNum">    6046</span>         [<span class="tlaGBC" title="Branch 0 was taken 56 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">          56 :     snapshot_chainstate.setBlockIndexCandidates.insert(snapshot_start_block);</span></span>
<span id="L6047"><span class="lineNum">    6047</span>                 :             : </span>
<span id="L6048"><span class="lineNum">    6048</span>   [<span class="tlaGBC" title="Branch 0 was taken 56 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 56 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">          56 :     LogInfo(&quot;[snapshot] validated snapshot (%.2f MB)&quot;,</span></span>
<span id="L6049"><span class="lineNum">    6049</span>                 :             :         coins_cache.DynamicMemoryUsage() / (1000 * 1000));</span>
<span id="L6050"><span class="lineNum">    6050</span>         [<span class="tlaGBC" title="Branch 0 was taken 56 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">          56 :     return {};</span></span>
<span id="L6051"><span class="lineNum">    6051</span>                 :<span class="tlaGNC">          56 : }</span></span>
<span id="L6052"><span class="lineNum">    6052</span>                 :             : </span>
<span id="L6053"><span class="lineNum">    6053</span>                 :             : // Currently, this function holds cs_main for its duration, which could be for</span>
<span id="L6054"><span class="lineNum">    6054</span>                 :             : // multiple minutes due to the ComputeUTXOStats call. This hold is necessary</span>
<span id="L6055"><span class="lineNum">    6055</span>                 :             : // because we need to avoid advancing the background validation chainstate</span>
<span id="L6056"><span class="lineNum">    6056</span>                 :             : // farther than the snapshot base block - and this function is also invoked</span>
<span id="L6057"><span class="lineNum">    6057</span>                 :             : // from within ConnectTip, i.e. from within ActivateBestChain, so cs_main is</span>
<span id="L6058"><span class="lineNum">    6058</span>                 :             : // held anyway.</span>
<span id="L6059"><span class="lineNum">    6059</span>                 :             : //</span>
<span id="L6060"><span class="lineNum">    6060</span>                 :             : // Eventually (TODO), we could somehow separate this function's runtime from</span>
<span id="L6061"><span class="lineNum">    6061</span>                 :             : // maintenance of the active chain, but that will either require</span>
<span id="L6062"><span class="lineNum">    6062</span>                 :             : //</span>
<span id="L6063"><span class="lineNum">    6063</span>                 :             : //  (i) setting `m_disabled` immediately and ensuring all chainstate accesses go</span>
<span id="L6064"><span class="lineNum">    6064</span>                 :             : //      through IsUsable() checks, or</span>
<span id="L6065"><span class="lineNum">    6065</span>                 :             : //</span>
<span id="L6066"><span class="lineNum">    6066</span>                 :             : //  (ii) giving each chainstate its own lock instead of using cs_main for everything.</span>
<span id="L6067"><span class="lineNum">    6067</span>                 :<span class="tlaGNC">        2960 : SnapshotCompletionResult ChainstateManager::MaybeCompleteSnapshotValidation()</span></span>
<span id="L6068"><span class="lineNum">    6068</span>                 :             : {</span>
<span id="L6069"><span class="lineNum">    6069</span>                 :<span class="tlaGNC">        2960 :     AssertLockHeld(cs_main);</span></span>
<span id="L6070"><span class="lineNum">    6070</span>                 :<span class="tlaGNC">        2960 :     if (m_ibd_chainstate.get() == &amp;this-&gt;ActiveChainstate() ||</span></span>
<span id="L6071"><span class="lineNum">    6071</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             !this-&gt;IsUsable(m_snapshot_chainstate.get()) ||</span></span>
<span id="L6072"><span class="lineNum">    6072</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 2960 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">        2960 :             !this-&gt;IsUsable(m_ibd_chainstate.get()) ||</span></span>
<span id="L6073"><span class="lineNum">    6073</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">        2960 :             !m_ibd_chainstate-&gt;m_chain.Tip()) {</span></span>
<span id="L6074"><span class="lineNum">    6074</span>                 :             :        // Nothing to do - this function only applies to the background</span>
<span id="L6075"><span class="lineNum">    6075</span>                 :             :        // validation chainstate.</span>
<span id="L6076"><span class="lineNum">    6076</span>                 :             :        return SnapshotCompletionResult::SKIPPED;</span>
<span id="L6077"><span class="lineNum">    6077</span>                 :             :     }</span>
<span id="L6078"><span class="lineNum">    6078</span>                 :<span class="tlaUNC">           0 :     const int snapshot_tip_height = this-&gt;ActiveHeight();</span></span>
<span id="L6079"><span class="lineNum">    6079</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     const int snapshot_base_height = *Assert(this-&gt;GetSnapshotBaseHeight());</span></span>
<span id="L6080"><span class="lineNum">    6080</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     const CBlockIndex&amp; index_new = *Assert(m_ibd_chainstate-&gt;m_chain.Tip());</span></span>
<span id="L6081"><span class="lineNum">    6081</span>                 :             : </span>
<span id="L6082"><span class="lineNum">    6082</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (index_new.nHeight &lt; snapshot_base_height) {</span></span>
<span id="L6083"><span class="lineNum">    6083</span>                 :             :         // Background IBD not complete yet.</span>
<span id="L6084"><span class="lineNum">    6084</span>                 :             :         return SnapshotCompletionResult::SKIPPED;</span>
<span id="L6085"><span class="lineNum">    6085</span>                 :             :     }</span>
<span id="L6086"><span class="lineNum">    6086</span>                 :             : </span>
<span id="L6087"><span class="lineNum">    6087</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     assert(SnapshotBlockhash());</span></span>
<span id="L6088"><span class="lineNum">    6088</span>                 :<span class="tlaUNC">           0 :     uint256 snapshot_blockhash = *Assert(SnapshotBlockhash());</span></span>
<span id="L6089"><span class="lineNum">    6089</span>                 :             : </span>
<span id="L6090"><span class="lineNum">    6090</span>                 :<span class="tlaUNC">           0 :     auto handle_invalid_snapshot = [&amp;]() EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {</span></span>
<span id="L6091"><span class="lineNum">    6091</span>                 :<span class="tlaUNC">           0 :         bilingual_str user_error = strprintf(_(</span></span>
<span id="L6092"><span class="lineNum">    6092</span>                 :             :             &quot;%s failed to validate the -assumeutxo snapshot state. &quot;</span>
<span id="L6093"><span class="lineNum">    6093</span>                 :             :             &quot;This indicates a hardware problem, or a bug in the software, or a &quot;</span>
<span id="L6094"><span class="lineNum">    6094</span>                 :             :             &quot;bad software modification that allowed an invalid snapshot to be &quot;</span>
<span id="L6095"><span class="lineNum">    6095</span>                 :             :             &quot;loaded. As a result of this, the node will shut down and stop using any &quot;</span>
<span id="L6096"><span class="lineNum">    6096</span>                 :             :             &quot;state that was built on the snapshot, resetting the chain height &quot;</span>
<span id="L6097"><span class="lineNum">    6097</span>                 :             :             &quot;from %d to %d. On the next &quot;</span>
<span id="L6098"><span class="lineNum">    6098</span>                 :             :             &quot;restart, the node will resume syncing from %d &quot;</span>
<span id="L6099"><span class="lineNum">    6099</span>                 :             :             &quot;without using any snapshot data. &quot;</span>
<span id="L6100"><span class="lineNum">    6100</span>                 :             :             &quot;Please report this incident to %s, including how you obtained the snapshot. &quot;</span>
<span id="L6101"><span class="lineNum">    6101</span>                 :             :             &quot;The invalid snapshot chainstate will be left on disk in case it is &quot;</span>
<span id="L6102"><span class="lineNum">    6102</span>                 :             :             &quot;helpful in diagnosing the issue that caused this error.&quot;),</span>
<span id="L6103"><span class="lineNum">    6103</span>                 :             :             CLIENT_NAME, snapshot_tip_height, snapshot_base_height, snapshot_base_height, CLIENT_BUGREPORT</span>
<span id="L6104"><span class="lineNum">    6104</span>                 :<span class="tlaUNC">           0 :         );</span></span>
<span id="L6105"><span class="lineNum">    6105</span>                 :             : </span>
<span id="L6106"><span class="lineNum">    6106</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LogError(&quot;[snapshot] !!! %s\n&quot;, user_error.original);</span></span>
<span id="L6107"><span class="lineNum">    6107</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LogError(&quot;[snapshot] deleting snapshot, reverting to validated chain, and stopping node\n&quot;);</span></span>
<span id="L6108"><span class="lineNum">    6108</span>                 :             : </span>
<span id="L6109"><span class="lineNum">    6109</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         m_active_chainstate = m_ibd_chainstate.get();</span></span>
<span id="L6110"><span class="lineNum">    6110</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         m_snapshot_chainstate-&gt;m_disabled = true;</span></span>
<span id="L6111"><span class="lineNum">    6111</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         assert(!this-&gt;IsUsable(m_snapshot_chainstate.get()));</span></span>
<span id="L6112"><span class="lineNum">    6112</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         assert(this-&gt;IsUsable(m_ibd_chainstate.get()));</span></span>
<span id="L6113"><span class="lineNum">    6113</span>                 :             : </span>
<span id="L6114"><span class="lineNum">    6114</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         auto rename_result = m_snapshot_chainstate-&gt;InvalidateCoinsDBOnDisk();</span></span>
<span id="L6115"><span class="lineNum">    6115</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!rename_result) {</span></span>
<span id="L6116"><span class="lineNum">    6116</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :             user_error += Untranslated(&quot;\n&quot;) + util::ErrorString(rename_result);</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L6117"><span class="lineNum">    6117</span>                 :             :         }</span>
<span id="L6118"><span class="lineNum">    6118</span>                 :             : </span>
<span id="L6119"><span class="lineNum">    6119</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         GetNotifications().fatalError(user_error);</span></span>
<span id="L6120"><span class="lineNum">    6120</span>                 :<span class="tlaUNC">           0 :     };</span></span>
<span id="L6121"><span class="lineNum">    6121</span>                 :             : </span>
<span id="L6122"><span class="lineNum">    6122</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (index_new.GetBlockHash() != snapshot_blockhash) {</span></span>
<span id="L6123"><span class="lineNum">    6123</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LogPrintf(&quot;[snapshot] supposed base block %s does not match the &quot;</span></span>
<span id="L6124"><span class="lineNum">    6124</span>                 :             :           &quot;snapshot base block %s (height %d). Snapshot is not valid.\n&quot;,</span>
<span id="L6125"><span class="lineNum">    6125</span>                 :             :           index_new.ToString(), snapshot_blockhash.ToString(), snapshot_base_height);</span>
<span id="L6126"><span class="lineNum">    6126</span>                 :<span class="tlaUNC">           0 :         handle_invalid_snapshot();</span></span>
<span id="L6127"><span class="lineNum">    6127</span>                 :<span class="tlaUNC">           0 :         return SnapshotCompletionResult::BASE_BLOCKHASH_MISMATCH;</span></span>
<span id="L6128"><span class="lineNum">    6128</span>                 :             :     }</span>
<span id="L6129"><span class="lineNum">    6129</span>                 :             : </span>
<span id="L6130"><span class="lineNum">    6130</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     assert(index_new.nHeight == snapshot_base_height);</span></span>
<span id="L6131"><span class="lineNum">    6131</span>                 :             : </span>
<span id="L6132"><span class="lineNum">    6132</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     int curr_height = m_ibd_chainstate-&gt;m_chain.Height();</span></span>
<span id="L6133"><span class="lineNum">    6133</span>                 :             : </span>
<span id="L6134"><span class="lineNum">    6134</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     assert(snapshot_base_height == curr_height);</span></span>
<span id="L6135"><span class="lineNum">    6135</span>                 :<span class="tlaUNC">           0 :     assert(snapshot_base_height == index_new.nHeight);</span></span>
<span id="L6136"><span class="lineNum">    6136</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     assert(this-&gt;IsUsable(m_snapshot_chainstate.get()));</span></span>
<span id="L6137"><span class="lineNum">    6137</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     assert(this-&gt;GetAll().size() == 2);</span></span>
<span id="L6138"><span class="lineNum">    6138</span>                 :             : </span>
<span id="L6139"><span class="lineNum">    6139</span>                 :<span class="tlaUNC">           0 :     CCoinsViewDB&amp; ibd_coins_db = m_ibd_chainstate-&gt;CoinsDB();</span></span>
<span id="L6140"><span class="lineNum">    6140</span>                 :<span class="tlaUNC">           0 :     m_ibd_chainstate-&gt;ForceFlushStateToDisk();</span></span>
<span id="L6141"><span class="lineNum">    6141</span>                 :             : </span>
<span id="L6142"><span class="lineNum">    6142</span>                 :<span class="tlaUNC">           0 :     const auto&amp; maybe_au_data = m_options.chainparams.AssumeutxoForHeight(curr_height);</span></span>
<span id="L6143"><span class="lineNum">    6143</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!maybe_au_data) {</span></span>
<span id="L6144"><span class="lineNum">    6144</span>                 :<span class="tlaUNC">           0 :         LogPrintf(&quot;[snapshot] assumeutxo data not found for height &quot;</span></span>
<span id="L6145"><span class="lineNum">    6145</span>                 :             :             &quot;(%d) - refusing to validate snapshot\n&quot;, curr_height);</span>
<span id="L6146"><span class="lineNum">    6146</span>                 :<span class="tlaUNC">           0 :         handle_invalid_snapshot();</span></span>
<span id="L6147"><span class="lineNum">    6147</span>                 :<span class="tlaUNC">           0 :         return SnapshotCompletionResult::MISSING_CHAINPARAMS;</span></span>
<span id="L6148"><span class="lineNum">    6148</span>                 :             :     }</span>
<span id="L6149"><span class="lineNum">    6149</span>                 :             : </span>
<span id="L6150"><span class="lineNum">    6150</span>                 :<span class="tlaUNC">           0 :     const AssumeutxoData&amp; au_data = *maybe_au_data;</span></span>
<span id="L6151"><span class="lineNum">    6151</span>                 :<span class="tlaUNC">           0 :     std::optional&lt;CCoinsStats&gt; maybe_ibd_stats;</span></span>
<span id="L6152"><span class="lineNum">    6152</span>                 :<span class="tlaUNC">           0 :     LogInfo(&quot;[snapshot] computing UTXO stats for background chainstate to validate &quot;</span></span>
<span id="L6153"><span class="lineNum">    6153</span>                 :             :         &quot;snapshot - this could take a few minutes&quot;);</span>
<span id="L6154"><span class="lineNum">    6154</span>                 :<span class="tlaUNC">           0 :     try {</span></span>
<span id="L6155"><span class="lineNum">    6155</span>                 :<span class="tlaUNC">           0 :         maybe_ibd_stats = ComputeUTXOStats(</span></span>
<span id="L6156"><span class="lineNum">    6156</span>                 :             :             CoinStatsHashType::HASH_SERIALIZED,</span>
<span id="L6157"><span class="lineNum">    6157</span>                 :             :             &amp;ibd_coins_db,</span>
<span id="L6158"><span class="lineNum">    6158</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             m_blockman,</span></span>
<span id="L6159"><span class="lineNum">    6159</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :             [&amp;interrupt = m_interrupt] { SnapshotUTXOHashBreakpoint(interrupt); });</span></span>
<span id="L6160"><span class="lineNum">    6160</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaUNC">           0 :     } catch (StopHashingException const&amp;) {</span></span>
<span id="L6161"><span class="lineNum">    6161</span>                 :<span class="tlaUNC">           0 :         return SnapshotCompletionResult::STATS_FAILED;</span></span>
<span id="L6162"><span class="lineNum">    6162</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L6163"><span class="lineNum">    6163</span>                 :             : </span>
<span id="L6164"><span class="lineNum">    6164</span>                 :             :     // XXX note that this function is slow and will hold cs_main for potentially minutes.</span>
<span id="L6165"><span class="lineNum">    6165</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!maybe_ibd_stats) {</span></span>
<span id="L6166"><span class="lineNum">    6166</span>                 :<span class="tlaUNC">           0 :         LogPrintf(&quot;[snapshot] failed to generate stats for validation coins db\n&quot;);</span></span>
<span id="L6167"><span class="lineNum">    6167</span>                 :             :         // While this isn't a problem with the snapshot per se, this condition</span>
<span id="L6168"><span class="lineNum">    6168</span>                 :             :         // prevents us from validating the snapshot, so we should shut down and let the</span>
<span id="L6169"><span class="lineNum">    6169</span>                 :             :         // user handle the issue manually.</span>
<span id="L6170"><span class="lineNum">    6170</span>                 :<span class="tlaUNC">           0 :         handle_invalid_snapshot();</span></span>
<span id="L6171"><span class="lineNum">    6171</span>                 :<span class="tlaUNC">           0 :         return SnapshotCompletionResult::STATS_FAILED;</span></span>
<span id="L6172"><span class="lineNum">    6172</span>                 :             :     }</span>
<span id="L6173"><span class="lineNum">    6173</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     const auto&amp; ibd_stats = *maybe_ibd_stats;</span></span>
<span id="L6174"><span class="lineNum">    6174</span>                 :             : </span>
<span id="L6175"><span class="lineNum">    6175</span>                 :             :     // Compare the background validation chainstate's UTXO set hash against the hard-coded</span>
<span id="L6176"><span class="lineNum">    6176</span>                 :             :     // assumeutxo hash we expect.</span>
<span id="L6177"><span class="lineNum">    6177</span>                 :             :     //</span>
<span id="L6178"><span class="lineNum">    6178</span>                 :             :     // TODO: For belt-and-suspenders, we could cache the UTXO set</span>
<span id="L6179"><span class="lineNum">    6179</span>                 :             :     // hash for the snapshot when it's loaded in its chainstate's leveldb. We could then</span>
<span id="L6180"><span class="lineNum">    6180</span>                 :             :     // reference that here for an additional check.</span>
<span id="L6181"><span class="lineNum">    6181</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (AssumeutxoHash{ibd_stats.hashSerialized} != au_data.hash_serialized) {</span></span>
<span id="L6182"><span class="lineNum">    6182</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LogPrintf(&quot;[snapshot] hash mismatch: actual=%s, expected=%s\n&quot;,</span></span>
<span id="L6183"><span class="lineNum">    6183</span>                 :             :             ibd_stats.hashSerialized.ToString(),</span>
<span id="L6184"><span class="lineNum">    6184</span>                 :             :             au_data.hash_serialized.ToString());</span>
<span id="L6185"><span class="lineNum">    6185</span>                 :<span class="tlaUNC">           0 :         handle_invalid_snapshot();</span></span>
<span id="L6186"><span class="lineNum">    6186</span>                 :<span class="tlaUNC">           0 :         return SnapshotCompletionResult::HASH_MISMATCH;</span></span>
<span id="L6187"><span class="lineNum">    6187</span>                 :             :     }</span>
<span id="L6188"><span class="lineNum">    6188</span>                 :             : </span>
<span id="L6189"><span class="lineNum">    6189</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     LogInfo(&quot;[snapshot] snapshot beginning at %s has been fully validated&quot;,</span></span>
<span id="L6190"><span class="lineNum">    6190</span>                 :             :         snapshot_blockhash.ToString());</span>
<span id="L6191"><span class="lineNum">    6191</span>                 :             : </span>
<span id="L6192"><span class="lineNum">    6192</span>                 :<span class="tlaUNC">           0 :     m_ibd_chainstate-&gt;m_disabled = true;</span></span>
<span id="L6193"><span class="lineNum">    6193</span>                 :<span class="tlaUNC">           0 :     this-&gt;MaybeRebalanceCaches();</span></span>
<span id="L6194"><span class="lineNum">    6194</span>                 :             : </span>
<span id="L6195"><span class="lineNum">    6195</span>                 :<span class="tlaUNC">           0 :     return SnapshotCompletionResult::SUCCESS;</span></span>
<span id="L6196"><span class="lineNum">    6196</span>                 :             : }</span>
<span id="L6197"><span class="lineNum">    6197</span>                 :             : </span>
<span id="L6198"><span class="lineNum">    6198</span>                 :<span class="tlaGNC">     7699869 : Chainstate&amp; ChainstateManager::ActiveChainstate() const</span></span>
<span id="L6199"><span class="lineNum">    6199</span>                 :             : {</span>
<span id="L6200"><span class="lineNum">    6200</span>                 :<span class="tlaGNC">     7699869 :     LOCK(::cs_main);</span></span>
<span id="L6201"><span class="lineNum">    6201</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 7699869 times"> + </span>]:<span class="tlaGNC">     7699869 :     assert(m_active_chainstate);</span></span>
<span id="L6202"><span class="lineNum">    6202</span>         [<span class="tlaGBC" title="Branch 0 was taken 7699869 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">     7699869 :     return *m_active_chainstate;</span></span>
<span id="L6203"><span class="lineNum">    6203</span>                 :<span class="tlaGNC">     7699869 : }</span></span>
<span id="L6204"><span class="lineNum">    6204</span>                 :             : </span>
<span id="L6205"><span class="lineNum">    6205</span>                 :<span class="tlaUNC">           0 : bool ChainstateManager::IsSnapshotActive() const</span></span>
<span id="L6206"><span class="lineNum">    6206</span>                 :             : {</span>
<span id="L6207"><span class="lineNum">    6207</span>                 :<span class="tlaUNC">           0 :     LOCK(::cs_main);</span></span>
<span id="L6208"><span class="lineNum">    6208</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     return m_snapshot_chainstate &amp;&amp; m_active_chainstate == m_snapshot_chainstate.get();</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L6209"><span class="lineNum">    6209</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L6210"><span class="lineNum">    6210</span>                 :             : </span>
<span id="L6211"><span class="lineNum">    6211</span>                 :<span class="tlaGNC">        5917 : void ChainstateManager::MaybeRebalanceCaches()</span></span>
<span id="L6212"><span class="lineNum">    6212</span>                 :             : {</span>
<span id="L6213"><span class="lineNum">    6213</span>                 :<span class="tlaGNC">        5917 :     AssertLockHeld(::cs_main);</span></span>
<span id="L6214"><span class="lineNum">    6214</span>         [<span class="tlaGBC" title="Branch 0 was taken 5917 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        5917 :     bool ibd_usable = this-&gt;IsUsable(m_ibd_chainstate.get());</span></span>
<span id="L6215"><span class="lineNum">    6215</span>         [<span class="tlaGBC" title="Branch 0 was taken 56 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 5861 times"> + </span>]:<span class="tlaGNC">        5917 :     bool snapshot_usable = this-&gt;IsUsable(m_snapshot_chainstate.get());</span></span>
<span id="L6216"><span class="lineNum">    6216</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 5861 times"> + </span>]:<span class="tlaGNC">        5861 :     assert(ibd_usable || snapshot_usable);</span></span>
<span id="L6217"><span class="lineNum">    6217</span>                 :             : </span>
<span id="L6218"><span class="lineNum">    6218</span>         [<span class="tlaGBC" title="Branch 0 was taken 5861 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 56 times"> + </span>]:<span class="tlaGNC">        5917 :     if (ibd_usable &amp;&amp; !snapshot_usable) {</span></span>
<span id="L6219"><span class="lineNum">    6219</span>                 :             :         // Allocate everything to the IBD chainstate. This will always happen</span>
<span id="L6220"><span class="lineNum">    6220</span>                 :             :         // when we are not using a snapshot.</span>
<span id="L6221"><span class="lineNum">    6221</span>                 :<span class="tlaGNC">        5861 :         m_ibd_chainstate-&gt;ResizeCoinsCaches(m_total_coinstip_cache, m_total_coinsdb_cache);</span></span>
<span id="L6222"><span class="lineNum">    6222</span>                 :             :     }</span>
<span id="L6223"><span class="lineNum">    6223</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 56 times"> + </span>]:<span class="tlaGNC">          56 :     else if (snapshot_usable &amp;&amp; !ibd_usable) {</span></span>
<span id="L6224"><span class="lineNum">    6224</span>                 :             :         // If background validation has completed and snapshot is our active chain...</span>
<span id="L6225"><span class="lineNum">    6225</span>                 :<span class="tlaUNC">           0 :         LogInfo(&quot;[snapshot] allocating all cache to the snapshot chainstate&quot;);</span></span>
<span id="L6226"><span class="lineNum">    6226</span>                 :             :         // Allocate everything to the snapshot chainstate.</span>
<span id="L6227"><span class="lineNum">    6227</span>                 :<span class="tlaUNC">           0 :         m_snapshot_chainstate-&gt;ResizeCoinsCaches(m_total_coinstip_cache, m_total_coinsdb_cache);</span></span>
<span id="L6228"><span class="lineNum">    6228</span>                 :             :     }</span>
<span id="L6229"><span class="lineNum">    6229</span>         [<span class="tlaGBC" title="Branch 0 was taken 56 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">          56 :     else if (ibd_usable &amp;&amp; snapshot_usable) {</span></span>
<span id="L6230"><span class="lineNum">    6230</span>                 :             :         // If both chainstates exist, determine who needs more cache based on IBD status.</span>
<span id="L6231"><span class="lineNum">    6231</span>                 :             :         //</span>
<span id="L6232"><span class="lineNum">    6232</span>                 :             :         // Note: shrink caches first so that we don't inadvertently overwhelm available memory.</span>
<span id="L6233"><span class="lineNum">    6233</span>         [<span class="tlaGBC" title="Branch 0 was taken 42 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 14 times"> + </span>]:<span class="tlaGNC">          56 :         if (IsInitialBlockDownload()) {</span></span>
<span id="L6234"><span class="lineNum">    6234</span>                 :<span class="tlaGNC">          42 :             m_ibd_chainstate-&gt;ResizeCoinsCaches(</span></span>
<span id="L6235"><span class="lineNum">    6235</span>                 :<span class="tlaGNC">          42 :                 m_total_coinstip_cache * 0.05, m_total_coinsdb_cache * 0.05);</span></span>
<span id="L6236"><span class="lineNum">    6236</span>                 :<span class="tlaGNC">          42 :             m_snapshot_chainstate-&gt;ResizeCoinsCaches(</span></span>
<span id="L6237"><span class="lineNum">    6237</span>                 :<span class="tlaGNC">          42 :                 m_total_coinstip_cache * 0.95, m_total_coinsdb_cache * 0.95);</span></span>
<span id="L6238"><span class="lineNum">    6238</span>                 :             :         } else {</span>
<span id="L6239"><span class="lineNum">    6239</span>                 :<span class="tlaGNC">          14 :             m_snapshot_chainstate-&gt;ResizeCoinsCaches(</span></span>
<span id="L6240"><span class="lineNum">    6240</span>                 :<span class="tlaGNC">          14 :                 m_total_coinstip_cache * 0.05, m_total_coinsdb_cache * 0.05);</span></span>
<span id="L6241"><span class="lineNum">    6241</span>                 :<span class="tlaGNC">          14 :             m_ibd_chainstate-&gt;ResizeCoinsCaches(</span></span>
<span id="L6242"><span class="lineNum">    6242</span>                 :<span class="tlaGNC">          14 :                 m_total_coinstip_cache * 0.95, m_total_coinsdb_cache * 0.95);</span></span>
<span id="L6243"><span class="lineNum">    6243</span>                 :             :         }</span>
<span id="L6244"><span class="lineNum">    6244</span>                 :             :     }</span>
<span id="L6245"><span class="lineNum">    6245</span>                 :<span class="tlaGNC">        5917 : }</span></span>
<span id="L6246"><span class="lineNum">    6246</span>                 :             : </span>
<span id="L6247"><span class="lineNum">    6247</span>                 :<span class="tlaUNC">           0 : void ChainstateManager::ResetChainstates()</span></span>
<span id="L6248"><span class="lineNum">    6248</span>                 :             : {</span>
<span id="L6249"><span class="lineNum">    6249</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     m_ibd_chainstate.reset();</span></span>
<span id="L6250"><span class="lineNum">    6250</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     m_snapshot_chainstate.reset();</span></span>
<span id="L6251"><span class="lineNum">    6251</span>                 :<span class="tlaUNC">           0 :     m_active_chainstate = nullptr;</span></span>
<span id="L6252"><span class="lineNum">    6252</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L6253"><span class="lineNum">    6253</span>                 :             : </span>
<span id="L6254"><span class="lineNum">    6254</span>                 :             : /**</span>
<span id="L6255"><span class="lineNum">    6255</span>                 :             :  * Apply default chain params to nullopt members.</span>
<span id="L6256"><span class="lineNum">    6256</span>                 :             :  * This helps to avoid coding errors around the accidental use of the compare</span>
<span id="L6257"><span class="lineNum">    6257</span>                 :             :  * operators that accept nullopt, thus ignoring the intended default value.</span>
<span id="L6258"><span class="lineNum">    6258</span>                 :             :  */</span>
<span id="L6259"><span class="lineNum">    6259</span>                 :<span class="tlaGNC">        2960 : static ChainstateManager::Options&amp;&amp; Flatten(ChainstateManager::Options&amp;&amp; opts)</span></span>
<span id="L6260"><span class="lineNum">    6260</span>                 :             : {</span>
<span id="L6261"><span class="lineNum">    6261</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 2960 times"> + </span>]:<span class="tlaGNC">        2960 :     if (!opts.check_block_index.has_value()) opts.check_block_index = opts.chainparams.DefaultConsistencyChecks();</span></span>
<span id="L6262"><span class="lineNum">    6262</span>         [<span class="tlaGBC" title="Branch 0 was taken 2960 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        2960 :     if (!opts.minimum_chain_work.has_value()) opts.minimum_chain_work = UintToArith256(opts.chainparams.GetConsensus().nMinimumChainWork);</span></span>
<span id="L6263"><span class="lineNum">    6263</span>         [<span class="tlaGBC" title="Branch 0 was taken 2960 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        2960 :     if (!opts.assumed_valid_block.has_value()) opts.assumed_valid_block = opts.chainparams.GetConsensus().defaultAssumeValid;</span></span>
<span id="L6264"><span class="lineNum">    6264</span>                 :<span class="tlaGNC">        2960 :     return std::move(opts);</span></span>
<span id="L6265"><span class="lineNum">    6265</span>                 :             : }</span>
<span id="L6266"><span class="lineNum">    6266</span>                 :             : </span>
<span id="L6267"><span class="lineNum">    6267</span>                 :<span class="tlaGNC">        2960 : ChainstateManager::ChainstateManager(const util::SignalInterrupt&amp; interrupt, Options options, node::BlockManager::Options blockman_options)</span></span>
<span id="L6268"><span class="lineNum">    6268</span>   [<span class="tlaGBC" title="Branch 0 was taken 2960 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 2960 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">        5920 :     : m_script_check_queue{/*batch_size=*/128, std::clamp(options.worker_threads_num, 0, MAX_SCRIPTCHECK_THREADS)},</span></span>
<span id="L6269"><span class="lineNum">    6269</span>                 :<span class="tlaGNC">        2960 :       m_interrupt{interrupt},</span></span>
<span id="L6270"><span class="lineNum">    6270</span>         [<span class="tlaGBC" title="Branch 0 was taken 2960 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        2960 :       m_options{Flatten(std::move(options))},</span></span>
<span id="L6271"><span class="lineNum">    6271</span>   [<span class="tlaGBC" title="Branch 0 was taken 2960 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 2960 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">        2960 :       m_blockman{interrupt, std::move(blockman_options)},</span></span>
<span id="L6272"><span class="lineNum">    6272</span>   [<span class="tlaGBC" title="Branch 0 was taken 2960 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaGBC" title="Branch 2 was taken 2960 times"> + </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaGNC">       11840 :       m_validation_cache{m_options.script_execution_cache_bytes, m_options.signature_cache_bytes}</span></span>
<span class="lineNum">        </span>          <span class="tlaGBC" title="Branch 4 was taken 2960 times"> + </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L6273"><span class="lineNum">    6273</span>                 :             : {</span>
<span id="L6274"><span class="lineNum">    6274</span>                 :<span class="tlaGNC">        2960 : }</span></span>
<span id="L6275"><span class="lineNum">    6275</span>                 :             : </span>
<span id="L6276"><span class="lineNum">    6276</span>                 :<span class="tlaGNC">        2960 : ChainstateManager::~ChainstateManager()</span></span>
<span id="L6277"><span class="lineNum">    6277</span>                 :             : {</span>
<span id="L6278"><span class="lineNum">    6278</span>                 :<span class="tlaGNC">        2960 :     LOCK(::cs_main);</span></span>
<span id="L6279"><span class="lineNum">    6279</span>                 :             : </span>
<span id="L6280"><span class="lineNum">    6280</span>         [<span class="tlaGBC" title="Branch 0 was taken 2960 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">        2960 :     m_versionbitscache.Clear();</span></span>
<span id="L6281"><span class="lineNum">    6281</span>                 :<span class="tlaGNC">       11840 : }</span></span>
<span id="L6282"><span class="lineNum">    6282</span>                 :             : </span>
<span id="L6283"><span class="lineNum">    6283</span>                 :<span class="tlaGNC">        2960 : bool ChainstateManager::DetectSnapshotChainstate()</span></span>
<span id="L6284"><span class="lineNum">    6284</span>                 :             : {</span>
<span id="L6285"><span class="lineNum">    6285</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 2960 times"> + </span>]:<span class="tlaGNC">        2960 :     assert(!m_snapshot_chainstate);</span></span>
<span id="L6286"><span class="lineNum">    6286</span>                 :<span class="tlaGNC">        2960 :     std::optional&lt;fs::path&gt; path = node::FindSnapshotChainstateDir(m_options.datadir);</span></span>
<span id="L6287"><span class="lineNum">    6287</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 2960 times"> + </span>]:<span class="tlaGNC">        2960 :     if (!path) {</span></span>
<span id="L6288"><span class="lineNum">    6288</span>                 :             :         return false;</span>
<span id="L6289"><span class="lineNum">    6289</span>                 :             :     }</span>
<span id="L6290"><span class="lineNum">    6290</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     std::optional&lt;uint256&gt; base_blockhash = node::ReadSnapshotBaseBlockhash(*path);</span></span>
<span id="L6291"><span class="lineNum">    6291</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!base_blockhash) {</span></span>
<span id="L6292"><span class="lineNum">    6292</span>                 :             :         return false;</span>
<span id="L6293"><span class="lineNum">    6293</span>                 :             :     }</span>
<span id="L6294"><span class="lineNum">    6294</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     LogInfo(&quot;[snapshot] detected active snapshot chainstate (%s) - loading&quot;,</span></span>
<span id="L6295"><span class="lineNum">    6295</span>                 :             :         fs::PathToString(*path));</span>
<span id="L6296"><span class="lineNum">    6296</span>                 :             : </span>
<span id="L6297"><span class="lineNum">    6297</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     this-&gt;ActivateExistingSnapshot(*base_blockhash);</span></span>
<span id="L6298"><span class="lineNum">    6298</span>                 :             :     return true;</span>
<span id="L6299"><span class="lineNum">    6299</span>                 :<span class="tlaGNC">        2960 : }</span></span>
<span id="L6300"><span class="lineNum">    6300</span>                 :             : </span>
<span id="L6301"><span class="lineNum">    6301</span>                 :<span class="tlaUNC">           0 : Chainstate&amp; ChainstateManager::ActivateExistingSnapshot(uint256 base_blockhash)</span></span>
<span id="L6302"><span class="lineNum">    6302</span>                 :             : {</span>
<span id="L6303"><span class="lineNum">    6303</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     assert(!m_snapshot_chainstate);</span></span>
<span id="L6304"><span class="lineNum">    6304</span>                 :<span class="tlaUNC">           0 :     m_snapshot_chainstate =</span></span>
<span id="L6305"><span class="lineNum">    6305</span>                 :<span class="tlaUNC">           0 :         std::make_unique&lt;Chainstate&gt;(nullptr, m_blockman, *this, base_blockhash);</span></span>
<span id="L6306"><span class="lineNum">    6306</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     LogInfo(&quot;[snapshot] switching active chainstate to %s&quot;, m_snapshot_chainstate-&gt;ToString());</span></span>
<span id="L6307"><span class="lineNum">    6307</span>                 :             : </span>
<span id="L6308"><span class="lineNum">    6308</span>                 :             :     // Mempool is empty at this point because we're still in IBD.</span>
<span id="L6309"><span class="lineNum">    6309</span>                 :<span class="tlaUNC">           0 :     Assert(m_active_chainstate-&gt;m_mempool-&gt;size() == 0);</span></span>
<span id="L6310"><span class="lineNum">    6310</span>                 :<span class="tlaUNC">           0 :     Assert(!m_snapshot_chainstate-&gt;m_mempool);</span></span>
<span id="L6311"><span class="lineNum">    6311</span>                 :<span class="tlaUNC">           0 :     m_snapshot_chainstate-&gt;m_mempool = m_active_chainstate-&gt;m_mempool;</span></span>
<span id="L6312"><span class="lineNum">    6312</span>                 :<span class="tlaUNC">           0 :     m_active_chainstate-&gt;m_mempool = nullptr;</span></span>
<span id="L6313"><span class="lineNum">    6313</span>                 :<span class="tlaUNC">           0 :     m_active_chainstate = m_snapshot_chainstate.get();</span></span>
<span id="L6314"><span class="lineNum">    6314</span>                 :<span class="tlaUNC">           0 :     return *m_snapshot_chainstate;</span></span>
<span id="L6315"><span class="lineNum">    6315</span>                 :             : }</span>
<span id="L6316"><span class="lineNum">    6316</span>                 :             : </span>
<span id="L6317"><span class="lineNum">    6317</span>                 :<span class="tlaGNC">      462209 : bool IsBIP30Repeat(const CBlockIndex&amp; block_index)</span></span>
<span id="L6318"><span class="lineNum">    6318</span>                 :             : {</span>
<span id="L6319"><span class="lineNum">    6319</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 462209 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      462209 :     return (block_index.nHeight==91842 &amp;&amp; block_index.GetBlockHash() == uint256{&quot;00000000000a4d0a398161ffc163c503763b1f4360639393e0e4c8e300e0caec&quot;}) ||</span></span>
<span id="L6320"><span class="lineNum">    6320</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 462209 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span>]:<span class="tlaGNC">      462209 :            (block_index.nHeight==91880 &amp;&amp; block_index.GetBlockHash() == uint256{&quot;00000000000743f190a18c5577a3c2d2a1f610ae9601ac046a38084ccb7cd721&quot;});</span></span>
<span id="L6321"><span class="lineNum">    6321</span>                 :             : }</span>
<span id="L6322"><span class="lineNum">    6322</span>                 :             : </span>
<span id="L6323"><span class="lineNum">    6323</span>                 :<span class="tlaUNC">           0 : bool IsBIP30Unspendable(const uint256&amp; block_hash, int block_height)</span></span>
<span id="L6324"><span class="lineNum">    6324</span>                 :             : {</span>
<span id="L6325"><span class="lineNum">    6325</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     return (block_height==91722 &amp;&amp; block_hash == uint256{&quot;00000000000271a2dc26e7667f8419f2e15416dc6955e5a6c6cdf3f2574dd08e&quot;}) ||</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L6326"><span class="lineNum">    6326</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :            (block_height==91812 &amp;&amp; block_hash == uint256{&quot;00000000000af0aed4792b1acee3d966af36cf5def14935db8de83d6f9306f2f&quot;});</span></span>
<span id="L6327"><span class="lineNum">    6327</span>                 :             : }</span>
<span id="L6328"><span class="lineNum">    6328</span>                 :             : </span>
<span id="L6329"><span class="lineNum">    6329</span>                 :<span class="tlaUNC">           0 : static fs::path GetSnapshotCoinsDBPath(Chainstate&amp; cs) EXCLUSIVE_LOCKS_REQUIRED(::cs_main)</span></span>
<span id="L6330"><span class="lineNum">    6330</span>                 :             : {</span>
<span id="L6331"><span class="lineNum">    6331</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(::cs_main);</span></span>
<span id="L6332"><span class="lineNum">    6332</span>                 :             :     // Should never be called on a non-snapshot chainstate.</span>
<span id="L6333"><span class="lineNum">    6333</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     assert(cs.m_from_snapshot_blockhash);</span></span>
<span id="L6334"><span class="lineNum">    6334</span>                 :<span class="tlaUNC">           0 :     auto storage_path_maybe = cs.CoinsDB().StoragePath();</span></span>
<span id="L6335"><span class="lineNum">    6335</span>                 :             :     // Should never be called with a non-existent storage path.</span>
<span id="L6336"><span class="lineNum">    6336</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     assert(storage_path_maybe);</span></span>
<span id="L6337"><span class="lineNum">    6337</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     return *storage_path_maybe;</span></span>
<span id="L6338"><span class="lineNum">    6338</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L6339"><span class="lineNum">    6339</span>                 :             : </span>
<span id="L6340"><span class="lineNum">    6340</span>                 :<span class="tlaUNC">           0 : util::Result&lt;void&gt; Chainstate::InvalidateCoinsDBOnDisk()</span></span>
<span id="L6341"><span class="lineNum">    6341</span>                 :             : {</span>
<span id="L6342"><span class="lineNum">    6342</span>                 :<span class="tlaUNC">           0 :     fs::path snapshot_datadir = GetSnapshotCoinsDBPath(*this);</span></span>
<span id="L6343"><span class="lineNum">    6343</span>                 :             : </span>
<span id="L6344"><span class="lineNum">    6344</span>                 :             :     // Coins views no longer usable.</span>
<span id="L6345"><span class="lineNum">    6345</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     m_coins_views.reset();</span></span>
<span id="L6346"><span class="lineNum">    6346</span>                 :             : </span>
<span id="L6347"><span class="lineNum">    6347</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     auto invalid_path = snapshot_datadir + &quot;_INVALID&quot;;</span></span>
<span id="L6348"><span class="lineNum">    6348</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     std::string dbpath = fs::PathToString(snapshot_datadir);</span></span>
<span id="L6349"><span class="lineNum">    6349</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     std::string target = fs::PathToString(invalid_path);</span></span>
<span id="L6350"><span class="lineNum">    6350</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     LogInfo(&quot;[snapshot] renaming snapshot datadir %s to %s&quot;, dbpath, target);</span></span>
<span id="L6351"><span class="lineNum">    6351</span>                 :             : </span>
<span id="L6352"><span class="lineNum">    6352</span>                 :             :     // The invalid snapshot datadir is simply moved and not deleted because we may</span>
<span id="L6353"><span class="lineNum">    6353</span>                 :             :     // want to do forensics later during issue investigation. The user is instructed</span>
<span id="L6354"><span class="lineNum">    6354</span>                 :             :     // accordingly in MaybeCompleteSnapshotValidation().</span>
<span id="L6355"><span class="lineNum">    6355</span>                 :<span class="tlaUNC">           0 :     try {</span></span>
<span id="L6356"><span class="lineNum">    6356</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         fs::rename(snapshot_datadir, invalid_path);</span></span>
<span id="L6357"><span class="lineNum">    6357</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaUNC">           0 :     } catch (const fs::filesystem_error&amp; e) {</span></span>
<span id="L6358"><span class="lineNum">    6358</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaUNC">           0 :         auto src_str = fs::PathToString(snapshot_datadir);</span></span>
<span id="L6359"><span class="lineNum">    6359</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaUNC">           0 :         auto dest_str = fs::PathToString(invalid_path);</span></span>
<span id="L6360"><span class="lineNum">    6360</span>                 :             : </span>
<span id="L6361"><span class="lineNum">    6361</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaUNC">           0 :         LogPrintf(&quot;%s: error renaming file '%s' -&gt; '%s': %s\n&quot;,</span></span>
<span id="L6362"><span class="lineNum">    6362</span>                 :             :                 __func__, src_str, dest_str, e.what());</span>
<span id="L6363"><span class="lineNum">    6363</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaUNC">           0 :         return util::Error{strprintf(_(</span></span>
<span id="L6364"><span class="lineNum">    6364</span>                 :             :             &quot;Rename of '%s' -&gt; '%s' failed. &quot;</span>
<span id="L6365"><span class="lineNum">    6365</span>                 :             :             &quot;You should resolve this by manually moving or deleting the invalid &quot;</span>
<span id="L6366"><span class="lineNum">    6366</span>                 :             :             &quot;snapshot directory %s, otherwise you will encounter the same error again &quot;</span>
<span id="L6367"><span class="lineNum">    6367</span>                 :             :             &quot;on the next startup.&quot;),</span>
<span id="L6368"><span class="lineNum">    6368</span>                 :<span class="tlaUNC">           0 :             src_str, dest_str, src_str)};</span></span>
<span id="L6369"><span class="lineNum">    6369</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaUNC">           0 :     }</span></span>
<span id="L6370"><span class="lineNum">    6370</span>                 :<span class="tlaUNC">           0 :     return {};</span></span>
<span id="L6371"><span class="lineNum">    6371</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L6372"><span class="lineNum">    6372</span>                 :             : </span>
<span id="L6373"><span class="lineNum">    6373</span>                 :<span class="tlaUNC">           0 : bool ChainstateManager::DeleteSnapshotChainstate()</span></span>
<span id="L6374"><span class="lineNum">    6374</span>                 :             : {</span>
<span id="L6375"><span class="lineNum">    6375</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(::cs_main);</span></span>
<span id="L6376"><span class="lineNum">    6376</span>                 :<span class="tlaUNC">           0 :     Assert(m_snapshot_chainstate);</span></span>
<span id="L6377"><span class="lineNum">    6377</span>                 :<span class="tlaUNC">           0 :     Assert(m_ibd_chainstate);</span></span>
<span id="L6378"><span class="lineNum">    6378</span>                 :             : </span>
<span id="L6379"><span class="lineNum">    6379</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     fs::path snapshot_datadir = Assert(node::FindSnapshotChainstateDir(m_options.datadir)).value();</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L6380"><span class="lineNum">    6380</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     if (!DeleteCoinsDBFromDisk(snapshot_datadir, /*is_snapshot=*/ true)) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L6381"><span class="lineNum">    6381</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LogPrintf(&quot;Deletion of %s failed. Please remove it manually to continue reindexing.\n&quot;,</span></span>
<span id="L6382"><span class="lineNum">    6382</span>                 :             :                   fs::PathToString(snapshot_datadir));</span>
<span id="L6383"><span class="lineNum">    6383</span>                 :<span class="tlaUNC">           0 :         return false;</span></span>
<span id="L6384"><span class="lineNum">    6384</span>                 :             :     }</span>
<span id="L6385"><span class="lineNum">    6385</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     m_active_chainstate = m_ibd_chainstate.get();</span></span>
<span id="L6386"><span class="lineNum">    6386</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     m_active_chainstate-&gt;m_mempool = m_snapshot_chainstate-&gt;m_mempool;</span></span>
<span id="L6387"><span class="lineNum">    6387</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     m_snapshot_chainstate.reset();</span></span>
<span id="L6388"><span class="lineNum">    6388</span>                 :             :     return true;</span>
<span id="L6389"><span class="lineNum">    6389</span>                 :<span class="tlaUNC">           0 : }</span></span>
<span id="L6390"><span class="lineNum">    6390</span>                 :             : </span>
<span id="L6391"><span class="lineNum">    6391</span>                 :<span class="tlaGNC">      470720 : ChainstateRole Chainstate::GetRole() const</span></span>
<span id="L6392"><span class="lineNum">    6392</span>                 :             : {</span>
<span id="L6393"><span class="lineNum">    6393</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 470720 times"> + </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaGBC" title="Branch 3 was taken 470720 times"> + </span>]:<span class="tlaGNC">      470720 :     if (m_chainman.GetAll().size() &lt;= 1) {</span></span>
<span id="L6394"><span class="lineNum">    6394</span>                 :             :         return ChainstateRole::NORMAL;</span>
<span id="L6395"><span class="lineNum">    6395</span>                 :             :     }</span>
<span id="L6396"><span class="lineNum">    6396</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     return (this != &amp;m_chainman.ActiveChainstate()) ?</span></span>
<span id="L6397"><span class="lineNum">    6397</span>                 :             :                ChainstateRole::BACKGROUND :</span>
<span id="L6398"><span class="lineNum">    6398</span>                 :             :                ChainstateRole::ASSUMEDVALID;</span>
<span id="L6399"><span class="lineNum">    6399</span>                 :             : }</span>
<span id="L6400"><span class="lineNum">    6400</span>                 :             : </span>
<span id="L6401"><span class="lineNum">    6401</span>                 :<span class="tlaGNC">      942565 : const CBlockIndex* ChainstateManager::GetSnapshotBaseBlock() const</span></span>
<span id="L6402"><span class="lineNum">    6402</span>                 :             : {</span>
<span id="L6403"><span class="lineNum">    6403</span>         [<span class="tlaGBC" title="Branch 0 was taken 942565 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">      942565 :     return m_active_chainstate ? m_active_chainstate-&gt;SnapshotBase() : nullptr;</span></span>
<span id="L6404"><span class="lineNum">    6404</span>                 :             : }</span>
<span id="L6405"><span class="lineNum">    6405</span>                 :             : </span>
<span id="L6406"><span class="lineNum">    6406</span>                 :<span class="tlaGNC">       11256 : std::optional&lt;int&gt; ChainstateManager::GetSnapshotBaseHeight() const</span></span>
<span id="L6407"><span class="lineNum">    6407</span>                 :             : {</span>
<span id="L6408"><span class="lineNum">    6408</span>                 :<span class="tlaGNC">       11256 :     const CBlockIndex* base = this-&gt;GetSnapshotBaseBlock();</span></span>
<span id="L6409"><span class="lineNum">    6409</span>         [<span class="tlaGBC" title="Branch 0 was taken 11256 times"> + </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaGNC">       11256 :     return base ? std::make_optional(base-&gt;nHeight) : std::nullopt;</span></span>
<span id="L6410"><span class="lineNum">    6410</span>                 :             : }</span>
<span id="L6411"><span class="lineNum">    6411</span>                 :             : </span>
<span id="L6412"><span class="lineNum">    6412</span>                 :<span class="tlaGNC">       15401 : void ChainstateManager::RecalculateBestHeader()</span></span>
<span id="L6413"><span class="lineNum">    6413</span>                 :             : {</span>
<span id="L6414"><span class="lineNum">    6414</span>                 :<span class="tlaGNC">       15401 :     AssertLockHeld(cs_main);</span></span>
<span id="L6415"><span class="lineNum">    6415</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaGBC" title="Branch 1 was taken 15401 times"> + </span>]:<span class="tlaGNC">       15401 :     m_best_header = ActiveChain().Tip();</span></span>
<span id="L6416"><span class="lineNum">    6416</span>   [<span class="tlaGBC" title="Branch 0 was taken 847649 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 15401 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 557840 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 289809 times"> + </span>]:<span class="tlaGNC">      863050 :     for (auto&amp; entry : m_blockman.m_block_index) {</span></span>
<span id="L6417"><span class="lineNum">    6417</span>   [<span class="tlaGBC" title="Branch 0 was taken 32 times"> + </span><span class="tlaGBC" title="Branch 1 was taken 557808 times"> + </span><span class="tlaGBC" title="Branch 2 was taken 557840 times"> + </span><span class="tlaGBC" title="Branch 3 was taken 289809 times"> + </span>]:<span class="tlaGNC">      847649 :         if (!(entry.second.nStatus &amp; BLOCK_FAILED_MASK) &amp;&amp; m_best_header-&gt;nChainWork &lt; entry.second.nChainWork) {</span></span>
<span id="L6418"><span class="lineNum">    6418</span>                 :<span class="tlaGNC">          32 :             m_best_header = &amp;entry.second;</span></span>
<span id="L6419"><span class="lineNum">    6419</span>                 :             :         }</span>
<span id="L6420"><span class="lineNum">    6420</span>                 :             :     }</span>
<span id="L6421"><span class="lineNum">    6421</span>                 :<span class="tlaGNC">       15401 : }</span></span>
<span id="L6422"><span class="lineNum">    6422</span>                 :             : </span>
<span id="L6423"><span class="lineNum">    6423</span>                 :<span class="tlaUNC">           0 : bool ChainstateManager::ValidatedSnapshotCleanup()</span></span>
<span id="L6424"><span class="lineNum">    6424</span>                 :             : {</span>
<span id="L6425"><span class="lineNum">    6425</span>                 :<span class="tlaUNC">           0 :     AssertLockHeld(::cs_main);</span></span>
<span id="L6426"><span class="lineNum">    6426</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     auto get_storage_path = [](auto&amp; chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) -&gt; std::optional&lt;fs::path&gt; {</span></span>
<span id="L6427"><span class="lineNum">    6427</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         if (!(chainstate &amp;&amp; chainstate-&gt;HasCoinsViews())) {</span></span>
<span id="L6428"><span class="lineNum">    6428</span>                 :<span class="tlaUNC">           0 :             return {};</span></span>
<span id="L6429"><span class="lineNum">    6429</span>                 :             :         }</span>
<span id="L6430"><span class="lineNum">    6430</span>                 :<span class="tlaUNC">           0 :         return chainstate-&gt;CoinsDB().StoragePath();</span></span>
<span id="L6431"><span class="lineNum">    6431</span>                 :             :     };</span>
<span id="L6432"><span class="lineNum">    6432</span>                 :<span class="tlaUNC">           0 :     std::optional&lt;fs::path&gt; ibd_chainstate_path_maybe = get_storage_path(m_ibd_chainstate);</span></span>
<span id="L6433"><span class="lineNum">    6433</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     std::optional&lt;fs::path&gt; snapshot_chainstate_path_maybe = get_storage_path(m_snapshot_chainstate);</span></span>
<span id="L6434"><span class="lineNum">    6434</span>                 :             : </span>
<span id="L6435"><span class="lineNum">    6435</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!this-&gt;IsSnapshotValidated()) {</span></span>
<span id="L6436"><span class="lineNum">    6436</span>                 :             :         // No need to clean up.</span>
<span id="L6437"><span class="lineNum">    6437</span>                 :             :         return false;</span>
<span id="L6438"><span class="lineNum">    6438</span>                 :             :     }</span>
<span id="L6439"><span class="lineNum">    6439</span>                 :             :     // If either path doesn't exist, that means at least one of the chainstates</span>
<span id="L6440"><span class="lineNum">    6440</span>                 :             :     // is in-memory, in which case we can't do on-disk cleanup. You'd better be</span>
<span id="L6441"><span class="lineNum">    6441</span>                 :             :     // in a unittest!</span>
<span id="L6442"><span class="lineNum">    6442</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (!ibd_chainstate_path_maybe || !snapshot_chainstate_path_maybe) {</span></span>
<span id="L6443"><span class="lineNum">    6443</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LogPrintf(&quot;[snapshot] snapshot chainstate cleanup cannot happen with &quot;</span></span>
<span id="L6444"><span class="lineNum">    6444</span>                 :             :                   &quot;in-memory chainstates. You are testing, right?\n&quot;);</span>
<span id="L6445"><span class="lineNum">    6445</span>                 :             :         return false;</span>
<span id="L6446"><span class="lineNum">    6446</span>                 :             :     }</span>
<span id="L6447"><span class="lineNum">    6447</span>                 :             : </span>
<span id="L6448"><span class="lineNum">    6448</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     const auto&amp; snapshot_chainstate_path = *snapshot_chainstate_path_maybe;</span></span>
<span id="L6449"><span class="lineNum">    6449</span>                 :<span class="tlaUNC">           0 :     const auto&amp; ibd_chainstate_path = *ibd_chainstate_path_maybe;</span></span>
<span id="L6450"><span class="lineNum">    6450</span>                 :             : </span>
<span id="L6451"><span class="lineNum">    6451</span>                 :             :     // Since we're going to be moving around the underlying leveldb filesystem content</span>
<span id="L6452"><span class="lineNum">    6452</span>                 :             :     // for each chainstate, make sure that the chainstates (and their constituent</span>
<span id="L6453"><span class="lineNum">    6453</span>                 :             :     // CoinsViews members) have been destructed first.</span>
<span id="L6454"><span class="lineNum">    6454</span>                 :             :     //</span>
<span id="L6455"><span class="lineNum">    6455</span>                 :             :     // The caller of this method will be responsible for reinitializing chainstates</span>
<span id="L6456"><span class="lineNum">    6456</span>                 :             :     // if they want to continue operation.</span>
<span id="L6457"><span class="lineNum">    6457</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     this-&gt;ResetChainstates();</span></span>
<span id="L6458"><span class="lineNum">    6458</span>                 :             : </span>
<span id="L6459"><span class="lineNum">    6459</span>                 :             :     // No chainstates should be considered usable.</span>
<span id="L6460"><span class="lineNum">    6460</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     assert(this-&gt;GetAll().size() == 0);</span></span>
<span id="L6461"><span class="lineNum">    6461</span>                 :             : </span>
<span id="L6462"><span class="lineNum">    6462</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     LogInfo(&quot;[snapshot] deleting background chainstate directory (now unnecessary) (%s)&quot;,</span></span>
<span id="L6463"><span class="lineNum">    6463</span>                 :             :               fs::PathToString(ibd_chainstate_path));</span>
<span id="L6464"><span class="lineNum">    6464</span>                 :             : </span>
<span id="L6465"><span class="lineNum">    6465</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     fs::path tmp_old{ibd_chainstate_path + &quot;_todelete&quot;};</span></span>
<span id="L6466"><span class="lineNum">    6466</span>                 :             : </span>
<span id="L6467"><span class="lineNum">    6467</span>                 :<span class="tlaUNC">           0 :     auto rename_failed_abort = [this](</span></span>
<span id="L6468"><span class="lineNum">    6468</span>                 :             :                                    fs::path p_old,</span>
<span id="L6469"><span class="lineNum">    6469</span>                 :             :                                    fs::path p_new,</span>
<span id="L6470"><span class="lineNum">    6470</span>                 :             :                                    const fs::filesystem_error&amp; err) {</span>
<span id="L6471"><span class="lineNum">    6471</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :         LogError(&quot;[snapshot] Error renaming path (%s) -&gt; (%s): %s\n&quot;,</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L6472"><span class="lineNum">    6472</span>                 :             :                   fs::PathToString(p_old), fs::PathToString(p_new), err.what());</span>
<span id="L6473"><span class="lineNum">    6473</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         GetNotifications().fatalError(strprintf(_(</span></span>
<span id="L6474"><span class="lineNum">    6474</span>                 :             :             &quot;Rename of '%s' -&gt; '%s' failed. &quot;</span>
<span id="L6475"><span class="lineNum">    6475</span>                 :             :             &quot;Cannot clean up the background chainstate leveldb directory.&quot;),</span>
<span id="L6476"><span class="lineNum">    6476</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :             fs::PathToString(p_old), fs::PathToString(p_new)));</span></span>
<span id="L6477"><span class="lineNum">    6477</span>                 :<span class="tlaUNC">           0 :     };</span></span>
<span id="L6478"><span class="lineNum">    6478</span>                 :             : </span>
<span id="L6479"><span class="lineNum">    6479</span>                 :<span class="tlaUNC">           0 :     try {</span></span>
<span id="L6480"><span class="lineNum">    6480</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         fs::rename(ibd_chainstate_path, tmp_old);</span></span>
<span id="L6481"><span class="lineNum">    6481</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaUNC">           0 :     } catch (const fs::filesystem_error&amp; e) {</span></span>
<span id="L6482"><span class="lineNum">    6482</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaUNC">           0 :         rename_failed_abort(ibd_chainstate_path, tmp_old, e);</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L6483"><span class="lineNum">    6483</span>                 :<span class="tlaUNC">           0 :         throw;</span></span>
<span id="L6484"><span class="lineNum">    6484</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L6485"><span class="lineNum">    6485</span>                 :             : </span>
<span id="L6486"><span class="lineNum">    6486</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     LogInfo(&quot;[snapshot] moving snapshot chainstate (%s) to &quot;</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L6487"><span class="lineNum">    6487</span>                 :             :               &quot;default chainstate directory (%s)&quot;,</span>
<span id="L6488"><span class="lineNum">    6488</span>                 :             :               fs::PathToString(snapshot_chainstate_path), fs::PathToString(ibd_chainstate_path));</span>
<span id="L6489"><span class="lineNum">    6489</span>                 :             : </span>
<span id="L6490"><span class="lineNum">    6490</span>                 :<span class="tlaUNC">           0 :     try {</span></span>
<span id="L6491"><span class="lineNum">    6491</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :         fs::rename(snapshot_chainstate_path, ibd_chainstate_path);</span></span>
<span id="L6492"><span class="lineNum">    6492</span>         [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span>]:<span class="tlaUNC">           0 :     } catch (const fs::filesystem_error&amp; e) {</span></span>
<span id="L6493"><span class="lineNum">    6493</span>   [<span class="tlaUNC" title="Branch 0 was not taken"> - </span><span class="tlaUNC" title="Branch 1 was not taken"> - </span><span class="tlaUNC" title="Branch 2 was not taken"> - </span><span class="tlaUNC" title="Branch 3 was not taken"> - </span> :<span class="tlaUNC">           0 :         rename_failed_abort(snapshot_chainstate_path, ibd_chainstate_path, e);</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not taken"> - </span><span class="tlaUNC" title="Branch 5 was not taken"> - </span>]
<span id="L6494"><span class="lineNum">    6494</span>                 :<span class="tlaUNC">           0 :         throw;</span></span>
<span id="L6495"><span class="lineNum">    6495</span>                 :<span class="tlaUNC">           0 :     }</span></span>
<span id="L6496"><span class="lineNum">    6496</span>                 :             : </span>
<span id="L6497"><span class="lineNum">    6497</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     if (!DeleteCoinsDBFromDisk(tmp_old, /*is_snapshot=*/false)) {</span></span>
<span class="lineNum">        </span>          <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span>]
<span id="L6498"><span class="lineNum">    6498</span>                 :             :         // No need to FatalError because once the unneeded bg chainstate data is</span>
<span id="L6499"><span class="lineNum">    6499</span>                 :             :         // moved, it will not interfere with subsequent initialization.</span>
<span id="L6500"><span class="lineNum">    6500</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LogPrintf(&quot;Deletion of %s failed. Please remove it manually, as the &quot;</span></span>
<span id="L6501"><span class="lineNum">    6501</span>                 :             :                   &quot;directory is now unnecessary.\n&quot;,</span>
<span id="L6502"><span class="lineNum">    6502</span>                 :             :                   fs::PathToString(tmp_old));</span>
<span id="L6503"><span class="lineNum">    6503</span>                 :             :     } else {</span>
<span id="L6504"><span class="lineNum">    6504</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         LogInfo(&quot;[snapshot] deleted background chainstate directory (%s)&quot;,</span></span>
<span id="L6505"><span class="lineNum">    6505</span>                 :             :                   fs::PathToString(ibd_chainstate_path));</span>
<span id="L6506"><span class="lineNum">    6506</span>                 :             :     }</span>
<span id="L6507"><span class="lineNum">    6507</span>                 :<span class="tlaUNC">           0 :     return true;</span></span>
<span id="L6508"><span class="lineNum">    6508</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 : }</span></span>
<span id="L6509"><span class="lineNum">    6509</span>                 :             : </span>
<span id="L6510"><span class="lineNum">    6510</span>                 :<span class="tlaUNC">           0 : Chainstate&amp; ChainstateManager::GetChainstateForIndexing()</span></span>
<span id="L6511"><span class="lineNum">    6511</span>                 :             : {</span>
<span id="L6512"><span class="lineNum">    6512</span>                 :             :     // We can't always return `m_ibd_chainstate` because after background validation</span>
<span id="L6513"><span class="lineNum">    6513</span>                 :             :     // has completed, `m_snapshot_chainstate == m_active_chainstate`, but it can be</span>
<span id="L6514"><span class="lineNum">    6514</span>                 :             :     // indexed.</span>
<span id="L6515"><span class="lineNum">    6515</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     return (this-&gt;GetAll().size() &gt; 1) ? *m_ibd_chainstate : *m_active_chainstate;</span></span>
<span id="L6516"><span class="lineNum">    6516</span>                 :             : }</span>
<span id="L6517"><span class="lineNum">    6517</span>                 :             : </span>
<span id="L6518"><span class="lineNum">    6518</span>                 :<span class="tlaUNC">           0 : std::pair&lt;int, int&gt; ChainstateManager::GetPruneRange(const Chainstate&amp; chainstate, int last_height_can_prune)</span></span>
<span id="L6519"><span class="lineNum">    6519</span>                 :             : {</span>
<span id="L6520"><span class="lineNum">    6520</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :     if (chainstate.m_chain.Height() &lt;= 0) {</span></span>
<span id="L6521"><span class="lineNum">    6521</span>                 :<span class="tlaUNC">           0 :         return {0, 0};</span></span>
<span id="L6522"><span class="lineNum">    6522</span>                 :             :     }</span>
<span id="L6523"><span class="lineNum">    6523</span>                 :<span class="tlaUNC">           0 :     int prune_start{0};</span></span>
<span id="L6524"><span class="lineNum">    6524</span>                 :             : </span>
<span id="L6525"><span class="lineNum">    6525</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span> :<span class="tlaUNC">           0 :     if (this-&gt;GetAll().size() &gt; 1 &amp;&amp; m_snapshot_chainstate.get() == &amp;chainstate) {</span></span>
<span class="lineNum">        </span>    <span class="tlaUNC" title="Branch 4 was not executed"> # </span><span class="tlaUNC" title="Branch 5 was not executed"> # </span><span class="tlaUNC" title="Branch 6 was not executed"> # </span><span class="tlaUNC" title="Branch 7 was not executed"> # </span>]
<span id="L6526"><span class="lineNum">    6526</span>                 :             :         // Leave the blocks in the background IBD chain alone if we're pruning</span>
<span id="L6527"><span class="lineNum">    6527</span>                 :             :         // the snapshot chain.</span>
<span id="L6528"><span class="lineNum">    6528</span>                 :<span class="tlaUNC">           0 :         prune_start = *Assert(GetSnapshotBaseHeight()) + 1;</span></span>
<span id="L6529"><span class="lineNum">    6529</span>                 :             :     }</span>
<span id="L6530"><span class="lineNum">    6530</span>                 :             : </span>
<span id="L6531"><span class="lineNum">    6531</span>                 :<span class="tlaUNC">           0 :     int max_prune = std::max&lt;int&gt;(</span></span>
<span id="L6532"><span class="lineNum">    6532</span>   [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span><span class="tlaUNC" title="Branch 2 was not executed"> # </span><span class="tlaUNC" title="Branch 3 was not executed"> # </span>]:<span class="tlaUNC">           0 :         0, chainstate.m_chain.Height() - static_cast&lt;int&gt;(MIN_BLOCKS_TO_KEEP));</span></span>
<span id="L6533"><span class="lineNum">    6533</span>                 :             : </span>
<span id="L6534"><span class="lineNum">    6534</span>                 :             :     // last block to prune is the lesser of (caller-specified height, MIN_BLOCKS_TO_KEEP from the tip)</span>
<span id="L6535"><span class="lineNum">    6535</span>                 :             :     //</span>
<span id="L6536"><span class="lineNum">    6536</span>                 :             :     // While you might be tempted to prune the background chainstate more</span>
<span id="L6537"><span class="lineNum">    6537</span>                 :             :     // aggressively (i.e. fewer MIN_BLOCKS_TO_KEEP), this won't work with index</span>
<span id="L6538"><span class="lineNum">    6538</span>                 :             :     // building - specifically blockfilterindex requires undo data, and if</span>
<span id="L6539"><span class="lineNum">    6539</span>                 :             :     // we don't maintain this trailing window, we hit indexing failures.</span>
<span id="L6540"><span class="lineNum">    6540</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaUNC">           0 :     int prune_end = std::min(last_height_can_prune, max_prune);</span></span>
<span id="L6541"><span class="lineNum">    6541</span>                 :             : </span>
<span id="L6542"><span class="lineNum">    6542</span>                 :<span class="tlaUNC">           0 :     return {prune_start, prune_end};</span></span>
<span id="L6543"><span class="lineNum">    6543</span>                 :             : }</span>
        </pre>
              </td>
            </tr>
          </table>
          <br>

          <table width="100%" border=0 cellspacing=0 cellpadding=0>
            <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
            <tr><td class="versionInfo">Generated by: <a href="https://github.com//linux-test-project/lcov" target="_parent">LCOV version 2.0-1</a></td></tr>
          </table>
          <br>

</body>
</html>
