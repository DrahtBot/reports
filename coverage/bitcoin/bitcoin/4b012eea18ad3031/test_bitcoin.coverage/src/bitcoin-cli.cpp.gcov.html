<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - test_bitcoin_coverage.info - src/bitcoin-cli.cpp</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">src</a> - bitcoin-cli.cpp<span style="font-size: 80%;"> (source / <a href="bitcoin-cli.cpp.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">test_bitcoin_coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">646</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2000-01-01 12:00:00</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">40</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td></td>
            <td></td>
            <td></td>
            <td class="headerItem">Branches:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntryHi">-</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">           Branch data     Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>                :            : // Copyright (c) 2009-2010 Satoshi Nakamoto</a>
<a name="2"><span class="lineNum">       2 </span>                :            : // Copyright (c) 2009-2021 The Bitcoin Core developers</a>
<a name="3"><span class="lineNum">       3 </span>                :            : // Distributed under the MIT software license, see the accompanying</a>
<a name="4"><span class="lineNum">       4 </span>                :            : // file COPYING or http://www.opensource.org/licenses/mit-license.php.</a>
<a name="5"><span class="lineNum">       5 </span>                :            : </a>
<a name="6"><span class="lineNum">       6 </span>                :            : #if defined(HAVE_CONFIG_H)</a>
<a name="7"><span class="lineNum">       7 </span>                :            : #include &lt;config/bitcoin-config.h&gt;</a>
<a name="8"><span class="lineNum">       8 </span>                :            : #endif</a>
<a name="9"><span class="lineNum">       9 </span>                :            : </a>
<a name="10"><span class="lineNum">      10 </span>                :            : #include &lt;chainparamsbase.h&gt;</a>
<a name="11"><span class="lineNum">      11 </span>                :            : #include &lt;clientversion.h&gt;</a>
<a name="12"><span class="lineNum">      12 </span>                :            : #include &lt;compat/compat.h&gt;</a>
<a name="13"><span class="lineNum">      13 </span>                :            : #include &lt;compat/stdin.h&gt;</a>
<a name="14"><span class="lineNum">      14 </span>                :            : #include &lt;policy/feerate.h&gt;</a>
<a name="15"><span class="lineNum">      15 </span>                :            : #include &lt;rpc/client.h&gt;</a>
<a name="16"><span class="lineNum">      16 </span>                :            : #include &lt;rpc/mining.h&gt;</a>
<a name="17"><span class="lineNum">      17 </span>                :            : #include &lt;rpc/protocol.h&gt;</a>
<a name="18"><span class="lineNum">      18 </span>                :            : #include &lt;rpc/request.h&gt;</a>
<a name="19"><span class="lineNum">      19 </span>                :            : #include &lt;tinyformat.h&gt;</a>
<a name="20"><span class="lineNum">      20 </span>                :            : #include &lt;univalue.h&gt;</a>
<a name="21"><span class="lineNum">      21 </span>                :            : #include &lt;util/strencodings.h&gt;</a>
<a name="22"><span class="lineNum">      22 </span>                :            : #include &lt;util/system.h&gt;</a>
<a name="23"><span class="lineNum">      23 </span>                :            : #include &lt;util/translation.h&gt;</a>
<a name="24"><span class="lineNum">      24 </span>                :            : #include &lt;util/url.h&gt;</a>
<a name="25"><span class="lineNum">      25 </span>                :            : </a>
<a name="26"><span class="lineNum">      26 </span>                :            : #include &lt;algorithm&gt;</a>
<a name="27"><span class="lineNum">      27 </span>                :            : #include &lt;chrono&gt;</a>
<a name="28"><span class="lineNum">      28 </span>                :            : #include &lt;cmath&gt;</a>
<a name="29"><span class="lineNum">      29 </span>                :            : #include &lt;cstdio&gt;</a>
<a name="30"><span class="lineNum">      30 </span>                :            : #include &lt;functional&gt;</a>
<a name="31"><span class="lineNum">      31 </span>                :            : #include &lt;memory&gt;</a>
<a name="32"><span class="lineNum">      32 </span>                :            : #include &lt;optional&gt;</a>
<a name="33"><span class="lineNum">      33 </span>                :            : #include &lt;string&gt;</a>
<a name="34"><span class="lineNum">      34 </span>                :            : #include &lt;tuple&gt;</a>
<a name="35"><span class="lineNum">      35 </span>                :            : </a>
<a name="36"><span class="lineNum">      36 </span>                :            : #ifndef WIN32</a>
<a name="37"><span class="lineNum">      37 </span>                :            : #include &lt;unistd.h&gt;</a>
<a name="38"><span class="lineNum">      38 </span>                :            : #endif</a>
<a name="39"><span class="lineNum">      39 </span>                :            : </a>
<a name="40"><span class="lineNum">      40 </span>                :            : #include &lt;event2/buffer.h&gt;</a>
<a name="41"><span class="lineNum">      41 </span>                :            : #include &lt;event2/keyvalq_struct.h&gt;</a>
<a name="42"><span class="lineNum">      42 </span>                :            : #include &lt;support/events.h&gt;</a>
<a name="43"><span class="lineNum">      43 </span>                :            : </a>
<a name="44"><span class="lineNum">      44 </span>                :            : // The server returns time values from a mockable system clock, but it is not</a>
<a name="45"><span class="lineNum">      45 </span>                :            : // trivial to get the mocked time from the server, nor is it needed for now, so</a>
<a name="46"><span class="lineNum">      46 </span>                :            : // just use a plain system_clock.</a>
<a name="47"><span class="lineNum">      47 </span>                :            : using CliClock = std::chrono::system_clock;</a>
<a name="48"><span class="lineNum">      48 </span>                :            : </a>
<a name="49"><span class="lineNum">      49 </span>                :            : const std::function&lt;std::string(const char*)&gt; G_TRANSLATION_FUN = nullptr;</a>
<a name="50"><span class="lineNum">      50 </span>                :            : UrlDecodeFn* const URL_DECODE = urlDecode;</a>
<a name="51"><span class="lineNum">      51 </span>                :            : </a>
<a name="52"><span class="lineNum">      52 </span>                :            : static const char DEFAULT_RPCCONNECT[] = &quot;127.0.0.1&quot;;</a>
<a name="53"><span class="lineNum">      53 </span>                :            : static const int DEFAULT_HTTP_CLIENT_TIMEOUT=900;</a>
<a name="54"><span class="lineNum">      54 </span>                :            : static constexpr int DEFAULT_WAIT_CLIENT_TIMEOUT = 0;</a>
<a name="55"><span class="lineNum">      55 </span>                :            : static const bool DEFAULT_NAMED=false;</a>
<a name="56"><span class="lineNum">      56 </span>                :            : static const int CONTINUE_EXECUTION=-1;</a>
<a name="57"><span class="lineNum">      57 </span>                :            : static constexpr int8_t UNKNOWN_NETWORK{-1};</a>
<a name="58"><span class="lineNum">      58 </span>                :            : static constexpr std::array NETWORKS{&quot;ipv4&quot;, &quot;ipv6&quot;, &quot;onion&quot;, &quot;i2p&quot;, &quot;cjdns&quot;};</a>
<a name="59"><span class="lineNum">      59 </span>                :            : </a>
<a name="60"><span class="lineNum">      60 </span>                :            : /** Default number of blocks to generate for RPC generatetoaddress. */</a>
<a name="61"><span class="lineNum">      61 </span>                :            : static const std::string DEFAULT_NBLOCKS = &quot;1&quot;;</a>
<a name="62"><span class="lineNum">      62 </span>                :            : </a>
<a name="63"><span class="lineNum">      63 </span>                :            : /** Default -color setting. */</a>
<a name="64"><span class="lineNum">      64 </span>                :            : static const std::string DEFAULT_COLOR_SETTING{&quot;auto&quot;};</a>
<a name="65"><span class="lineNum">      65 </span>                :            : </a>
<a name="66"><span class="lineNum">      66 </span>                :<span class="lineNoCov">          0 : static void SetupCliArgs(ArgsManager&amp; argsman)</span></a>
<a name="67"><span class="lineNum">      67 </span>                :            : {</a>
<a name="68"><span class="lineNum">      68 </span>                :<span class="lineNoCov">          0 :     SetupHelpOptions(argsman);</span></a>
<a name="69"><span class="lineNum">      69 </span>                :            : </a>
<a name="70"><span class="lineNum">      70 </span>                :<span class="lineNoCov">          0 :     const auto defaultBaseParams = CreateBaseChainParams(CBaseChainParams::MAIN);</span></a>
<a name="71"><span class="lineNum">      71 </span>                :<span class="lineNoCov">          0 :     const auto testnetBaseParams = CreateBaseChainParams(CBaseChainParams::TESTNET);</span></a>
<a name="72"><span class="lineNum">      72 </span>                :<span class="lineNoCov">          0 :     const auto signetBaseParams = CreateBaseChainParams(CBaseChainParams::SIGNET);</span></a>
<a name="73"><span class="lineNum">      73 </span>                :<span class="lineNoCov">          0 :     const auto regtestBaseParams = CreateBaseChainParams(CBaseChainParams::REGTEST);</span></a>
<a name="74"><span class="lineNum">      74 </span>                :            : </a>
<a name="75"><span class="lineNum">      75 </span>                :<span class="lineNoCov">          0 :     argsman.AddArg(&quot;-version&quot;, &quot;Print version and exit&quot;, ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);</span></a>
<a name="76"><span class="lineNum">      76 </span>                :<span class="lineNoCov">          0 :     argsman.AddArg(&quot;-conf=&lt;file&gt;&quot;, strprintf(&quot;Specify configuration file. Relative paths will be prefixed by datadir location. (default: %s)&quot;, BITCOIN_CONF_FILENAME), ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);</span></a>
<a name="77"><span class="lineNum">      77 </span>                :<span class="lineNoCov">          0 :     argsman.AddArg(&quot;-datadir=&lt;dir&gt;&quot;, &quot;Specify data directory&quot;, ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);</span></a>
<a name="78"><span class="lineNum">      78 </span>                :<span class="lineNoCov">          0 :     argsman.AddArg(&quot;-generate&quot;,</span></a>
<a name="79"><span class="lineNum">      79 </span>                :<span class="lineNoCov">          0 :                    strprintf(&quot;Generate blocks, equivalent to RPC getnewaddress followed by RPC generatetoaddress. Optional positional integer &quot;</span></a>
<a name="80"><span class="lineNum">      80 </span>                :            :                              &quot;arguments are number of blocks to generate (default: %s) and maximum iterations to try (default: %s), equivalent to &quot;</a>
<a name="81"><span class="lineNum">      81 </span>                :            :                              &quot;RPC generatetoaddress nblocks and maxtries arguments. Example: bitcoin-cli -generate 4 1000&quot;,</a>
<a name="82"><span class="lineNum">      82 </span>                :<span class="lineNoCov">          0 :                              DEFAULT_NBLOCKS, DEFAULT_MAX_TRIES),</span></a>
<a name="83"><span class="lineNum">      83 </span>                :<span class="lineNoCov">          0 :                    ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);</span></a>
<a name="84"><span class="lineNum">      84 </span>                :<span class="lineNoCov">          0 :     argsman.AddArg(&quot;-addrinfo&quot;, &quot;Get the number of addresses known to the node, per network and total, after filtering for quality and recency. The total number of addresses known to the node may be higher.&quot;, ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);</span></a>
<a name="85"><span class="lineNum">      85 </span>                :<span class="lineNoCov">          0 :     argsman.AddArg(&quot;-getinfo&quot;, &quot;Get general information from the remote server. Note that unlike server-side RPC calls, the results of -getinfo is the result of multiple non-atomic requests. Some entries in the result may represent results from different states (e.g. wallet balance may be as of a different block from the chain state reported)&quot;, ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);</span></a>
<a name="86"><span class="lineNum">      86 </span>                :<span class="lineNoCov">          0 :     argsman.AddArg(&quot;-netinfo&quot;, &quot;Get network peer connection information from the remote server. An optional integer argument from 0 to 4 can be passed for different peers listings (default: 0). Pass \&quot;help\&quot; for detailed help documentation.&quot;, ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);</span></a>
<a name="87"><span class="lineNum">      87 </span>                :            : </a>
<a name="88"><span class="lineNum">      88 </span>                :<span class="lineNoCov">          0 :     SetupChainParamsBaseOptions(argsman);</span></a>
<a name="89"><span class="lineNum">      89 </span>                :<span class="lineNoCov">          0 :     argsman.AddArg(&quot;-color=&lt;when&gt;&quot;, strprintf(&quot;Color setting for CLI output (default: %s). Valid values: always, auto (add color codes when standard output is connected to a terminal and OS is not WIN32), never.&quot;, DEFAULT_COLOR_SETTING), ArgsManager::ALLOW_ANY | ArgsManager::DISALLOW_NEGATION, OptionsCategory::OPTIONS);</span></a>
<a name="90"><span class="lineNum">      90 </span>                :<span class="lineNoCov">          0 :     argsman.AddArg(&quot;-named&quot;, strprintf(&quot;Pass named instead of positional arguments (default: %s)&quot;, DEFAULT_NAMED), ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);</span></a>
<a name="91"><span class="lineNum">      91 </span>                :<span class="lineNoCov">          0 :     argsman.AddArg(&quot;-rpcclienttimeout=&lt;n&gt;&quot;, strprintf(&quot;Timeout in seconds during HTTP requests, or 0 for no timeout. (default: %d)&quot;, DEFAULT_HTTP_CLIENT_TIMEOUT), ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);</span></a>
<a name="92"><span class="lineNum">      92 </span>                :<span class="lineNoCov">          0 :     argsman.AddArg(&quot;-rpcconnect=&lt;ip&gt;&quot;, strprintf(&quot;Send commands to node running on &lt;ip&gt; (default: %s)&quot;, DEFAULT_RPCCONNECT), ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);</span></a>
<a name="93"><span class="lineNum">      93 </span>                :<span class="lineNoCov">          0 :     argsman.AddArg(&quot;-rpccookiefile=&lt;loc&gt;&quot;, &quot;Location of the auth cookie. Relative paths will be prefixed by a net-specific datadir location. (default: data dir)&quot;, ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);</span></a>
<a name="94"><span class="lineNum">      94 </span>                :<span class="lineNoCov">          0 :     argsman.AddArg(&quot;-rpcpassword=&lt;pw&gt;&quot;, &quot;Password for JSON-RPC connections&quot;, ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);</span></a>
<a name="95"><span class="lineNum">      95 </span>                :<span class="lineNoCov">          0 :     argsman.AddArg(&quot;-rpcport=&lt;port&gt;&quot;, strprintf(&quot;Connect to JSON-RPC on &lt;port&gt; (default: %u, testnet: %u, signet: %u, regtest: %u)&quot;, defaultBaseParams-&gt;RPCPort(), testnetBaseParams-&gt;RPCPort(), signetBaseParams-&gt;RPCPort(), regtestBaseParams-&gt;RPCPort()), ArgsManager::ALLOW_ANY | ArgsManager::NETWORK_ONLY, OptionsCategory::OPTIONS);</span></a>
<a name="96"><span class="lineNum">      96 </span>                :<span class="lineNoCov">          0 :     argsman.AddArg(&quot;-rpcuser=&lt;user&gt;&quot;, &quot;Username for JSON-RPC connections&quot;, ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);</span></a>
<a name="97"><span class="lineNum">      97 </span>                :<span class="lineNoCov">          0 :     argsman.AddArg(&quot;-rpcwait&quot;, &quot;Wait for RPC server to start&quot;, ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);</span></a>
<a name="98"><span class="lineNum">      98 </span>                :<span class="lineNoCov">          0 :     argsman.AddArg(&quot;-rpcwaittimeout=&lt;n&gt;&quot;, strprintf(&quot;Timeout in seconds to wait for the RPC server to start, or 0 for no timeout. (default: %d)&quot;, DEFAULT_WAIT_CLIENT_TIMEOUT), ArgsManager::ALLOW_ANY | ArgsManager::DISALLOW_NEGATION, OptionsCategory::OPTIONS);</span></a>
<a name="99"><span class="lineNum">      99 </span>                :<span class="lineNoCov">          0 :     argsman.AddArg(&quot;-rpcwallet=&lt;walletname&gt;&quot;, &quot;Send RPC for non-default wallet on RPC server (needs to exactly match corresponding -wallet option passed to bitcoind). This changes the RPC endpoint used, e.g. http://127.0.0.1:8332/wallet/&lt;walletname&gt;&quot;, ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);</span></a>
<a name="100"><span class="lineNum">     100 </span>                :<span class="lineNoCov">          0 :     argsman.AddArg(&quot;-stdin&quot;, &quot;Read extra arguments from standard input, one per line until EOF/Ctrl-D (recommended for sensitive information such as passphrases). When combined with -stdinrpcpass, the first line from standard input is used for the RPC password.&quot;, ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);</span></a>
<a name="101"><span class="lineNum">     101 </span>                :<span class="lineNoCov">          0 :     argsman.AddArg(&quot;-stdinrpcpass&quot;, &quot;Read RPC password from standard input as a single line. When combined with -stdin, the first line from standard input is used for the RPC password. When combined with -stdinwalletpassphrase, -stdinrpcpass consumes the first line, and -stdinwalletpassphrase consumes the second.&quot;, ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);</span></a>
<a name="102"><span class="lineNum">     102 </span>                :<span class="lineNoCov">          0 :     argsman.AddArg(&quot;-stdinwalletpassphrase&quot;, &quot;Read wallet passphrase from standard input as a single line. When combined with -stdin, the first line from standard input is used for the wallet passphrase.&quot;, ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);</span></a>
<a name="103"><span class="lineNum">     103 </span>                :<span class="lineNoCov">          0 : }</span></a>
<a name="104"><span class="lineNum">     104 </span>                :            : </a>
<a name="105"><span class="lineNum">     105 </span>                :            : /** libevent event log callback */</a>
<a name="106"><span class="lineNum">     106 </span>                :<span class="lineNoCov">          0 : static void libevent_log_cb(int severity, const char *msg)</span></a>
<a name="107"><span class="lineNum">     107 </span>                :            : {</a>
<a name="108"><span class="lineNum">     108 </span>                :            :     // Ignore everything other than errors</a>
<a name="109"><span class="lineNum">     109 </span>                :<span class="lineNoCov">          0 :     if (severity &gt;= EVENT_LOG_ERR) {</span></a>
<a name="110"><span class="lineNum">     110 </span>                :<span class="lineNoCov">          0 :         throw std::runtime_error(strprintf(&quot;libevent error: %s&quot;, msg));</span></a>
<a name="111"><span class="lineNum">     111 </span>                :            :     }</a>
<a name="112"><span class="lineNum">     112 </span>                :<span class="lineNoCov">          0 : }</span></a>
<a name="113"><span class="lineNum">     113 </span>                :            : </a>
<a name="114"><span class="lineNum">     114 </span>                :            : //</a>
<a name="115"><span class="lineNum">     115 </span>                :            : // Exception thrown on connection error.  This error is used to determine</a>
<a name="116"><span class="lineNum">     116 </span>                :            : // when to wait if -rpcwait is given.</a>
<a name="117"><span class="lineNum">     117 </span>                :            : //</a>
<a name="118"><span class="lineNum">     118 </span>                :            : class CConnectionFailed : public std::runtime_error</a>
<a name="119"><span class="lineNum">     119 </span>                :            : {</a>
<a name="120"><span class="lineNum">     120 </span>                :            : public:</a>
<a name="121"><span class="lineNum">     121 </span>                :            : </a>
<a name="122"><span class="lineNum">     122 </span>                :<span class="lineNoCov">          0 :     explicit inline CConnectionFailed(const std::string&amp; msg) :</span></a>
<a name="123"><span class="lineNum">     123 </span>                :<span class="lineNoCov">          0 :         std::runtime_error(msg)</span></a>
<a name="124"><span class="lineNum">     124 </span>                :<span class="lineNoCov">          0 :     {}</span></a>
<a name="125"><span class="lineNum">     125 </span>                :            : </a>
<a name="126"><span class="lineNum">     126 </span>                :            : };</a>
<a name="127"><span class="lineNum">     127 </span>                :            : </a>
<a name="128"><span class="lineNum">     128 </span>                :            : //</a>
<a name="129"><span class="lineNum">     129 </span>                :            : // This function returns either one of EXIT_ codes when it's expected to stop the process or</a>
<a name="130"><span class="lineNum">     130 </span>                :            : // CONTINUE_EXECUTION when it's expected to continue further.</a>
<a name="131"><span class="lineNum">     131 </span>                :            : //</a>
<a name="132"><span class="lineNum">     132 </span>                :<span class="lineNoCov">          0 : static int AppInitRPC(int argc, char* argv[])</span></a>
<a name="133"><span class="lineNum">     133 </span>                :            : {</a>
<a name="134"><span class="lineNum">     134 </span>                :<span class="lineNoCov">          0 :     SetupCliArgs(gArgs);</span></a>
<a name="135"><span class="lineNum">     135 </span>                :<span class="lineNoCov">          0 :     std::string error;</span></a>
<a name="136"><span class="lineNum">     136 </span>                :<span class="lineNoCov">          0 :     if (!gArgs.ParseParameters(argc, argv, error)) {</span></a>
<a name="137"><span class="lineNum">     137 </span>                :<span class="lineNoCov">          0 :         tfm::format(std::cerr, &quot;Error parsing command line arguments: %s\n&quot;, error);</span></a>
<a name="138"><span class="lineNum">     138 </span>                :<span class="lineNoCov">          0 :         return EXIT_FAILURE;</span></a>
<a name="139"><span class="lineNum">     139 </span>                :            :     }</a>
<a name="140"><span class="lineNum">     140 </span>                :<span class="lineNoCov">          0 :     if (argc &lt; 2 || HelpRequested(gArgs) || gArgs.IsArgSet(&quot;-version&quot;)) {</span></a>
<a name="141"><span class="lineNum">     141 </span>                :<span class="lineNoCov">          0 :         std::string strUsage = PACKAGE_NAME &quot; RPC client version &quot; + FormatFullVersion() + &quot;\n&quot;;</span></a>
<a name="142"><span class="lineNum">     142 </span>                :            : </a>
<a name="143"><span class="lineNum">     143 </span>                :<span class="lineNoCov">          0 :         if (gArgs.IsArgSet(&quot;-version&quot;)) {</span></a>
<a name="144"><span class="lineNum">     144 </span>                :<span class="lineNoCov">          0 :             strUsage += FormatParagraph(LicenseInfo());</span></a>
<a name="145"><span class="lineNum">     145 </span>                :            :         } else {</a>
<a name="146"><span class="lineNum">     146 </span>                :            :             strUsage += &quot;\n&quot;</a>
<a name="147"><span class="lineNum">     147 </span>                :            :                 &quot;Usage:  bitcoin-cli [options] &lt;command&gt; [params]  Send command to &quot; PACKAGE_NAME &quot;\n&quot;</a>
<a name="148"><span class="lineNum">     148 </span>                :            :                 &quot;or:     bitcoin-cli [options] -named &lt;command&gt; [name=value]...  Send command to &quot; PACKAGE_NAME &quot; (with named arguments)\n&quot;</a>
<a name="149"><span class="lineNum">     149 </span>                :            :                 &quot;or:     bitcoin-cli [options] help                List commands\n&quot;</a>
<a name="150"><span class="lineNum">     150 </span>                :<span class="lineNoCov">          0 :                 &quot;or:     bitcoin-cli [options] help &lt;command&gt;      Get help for a command\n&quot;;</span></a>
<a name="151"><span class="lineNum">     151 </span>                :<span class="lineNoCov">          0 :             strUsage += &quot;\n&quot; + gArgs.GetHelpMessage();</span></a>
<a name="152"><span class="lineNum">     152 </span>                :            :         }</a>
<a name="153"><span class="lineNum">     153 </span>                :            : </a>
<a name="154"><span class="lineNum">     154 </span>                :<span class="lineNoCov">          0 :         tfm::format(std::cout, &quot;%s&quot;, strUsage);</span></a>
<a name="155"><span class="lineNum">     155 </span>                :<span class="lineNoCov">          0 :         if (argc &lt; 2) {</span></a>
<a name="156"><span class="lineNum">     156 </span>                :<span class="lineNoCov">          0 :             tfm::format(std::cerr, &quot;Error: too few parameters\n&quot;);</span></a>
<a name="157"><span class="lineNum">     157 </span>                :<span class="lineNoCov">          0 :             return EXIT_FAILURE;</span></a>
<a name="158"><span class="lineNum">     158 </span>                :            :         }</a>
<a name="159"><span class="lineNum">     159 </span>                :<span class="lineNoCov">          0 :         return EXIT_SUCCESS;</span></a>
<a name="160"><span class="lineNum">     160 </span>                :            :     }</a>
<a name="161"><span class="lineNum">     161 </span>                :<span class="lineNoCov">          0 :     if (!CheckDataDirOption()) {</span></a>
<a name="162"><span class="lineNum">     162 </span>                :<span class="lineNoCov">          0 :         tfm::format(std::cerr, &quot;Error: Specified data directory \&quot;%s\&quot; does not exist.\n&quot;, gArgs.GetArg(&quot;-datadir&quot;, &quot;&quot;));</span></a>
<a name="163"><span class="lineNum">     163 </span>                :<span class="lineNoCov">          0 :         return EXIT_FAILURE;</span></a>
<a name="164"><span class="lineNum">     164 </span>                :            :     }</a>
<a name="165"><span class="lineNum">     165 </span>                :<span class="lineNoCov">          0 :     if (!gArgs.ReadConfigFiles(error, true)) {</span></a>
<a name="166"><span class="lineNum">     166 </span>                :<span class="lineNoCov">          0 :         tfm::format(std::cerr, &quot;Error reading configuration file: %s\n&quot;, error);</span></a>
<a name="167"><span class="lineNum">     167 </span>                :<span class="lineNoCov">          0 :         return EXIT_FAILURE;</span></a>
<a name="168"><span class="lineNum">     168 </span>                :            :     }</a>
<a name="169"><span class="lineNum">     169 </span>                :            :     // Check for chain settings (BaseParams() calls are only valid after this clause)</a>
<a name="170"><span class="lineNum">     170 </span>                :            :     try {</a>
<a name="171"><span class="lineNum">     171 </span>                :<span class="lineNoCov">          0 :         SelectBaseParams(gArgs.GetChainName());</span></a>
<a name="172"><span class="lineNum">     172 </span>                :<span class="lineNoCov">          0 :     } catch (const std::exception&amp; e) {</span></a>
<a name="173"><span class="lineNum">     173 </span>                :<span class="lineNoCov">          0 :         tfm::format(std::cerr, &quot;Error: %s\n&quot;, e.what());</span></a>
<a name="174"><span class="lineNum">     174 </span>                :<span class="lineNoCov">          0 :         return EXIT_FAILURE;</span></a>
<a name="175"><span class="lineNum">     175 </span>                :            :     }</a>
<a name="176"><span class="lineNum">     176 </span>                :<span class="lineNoCov">          0 :     return CONTINUE_EXECUTION;</span></a>
<a name="177"><span class="lineNum">     177 </span>                :            : }</a>
<a name="178"><span class="lineNum">     178 </span>                :            : </a>
<a name="179"><span class="lineNum">     179 </span>                :            : </a>
<a name="180"><span class="lineNum">     180 </span>                :            : /** Reply structure for request_done to fill in */</a>
<a name="181"><span class="lineNum">     181 </span>                :            : struct HTTPReply</a>
<a name="182"><span class="lineNum">     182 </span>                :            : {</a>
<a name="183"><span class="lineNum">     183 </span>                :<span class="lineNoCov">          0 :     HTTPReply() = default;</span></a>
<a name="184"><span class="lineNum">     184 </span>                :            : </a>
<a name="185"><span class="lineNum">     185 </span>                :            :     int status{0};</a>
<a name="186"><span class="lineNum">     186 </span>                :            :     int error{-1};</a>
<a name="187"><span class="lineNum">     187 </span>                :            :     std::string body;</a>
<a name="188"><span class="lineNum">     188 </span>                :            : };</a>
<a name="189"><span class="lineNum">     189 </span>                :            : </a>
<a name="190"><span class="lineNum">     190 </span>                :<span class="lineNoCov">          0 : static std::string http_errorstring(int code)</span></a>
<a name="191"><span class="lineNum">     191 </span>                :            : {</a>
<a name="192"><span class="lineNum">     192 </span>                :<span class="lineNoCov">          0 :     switch(code) {</span></a>
<a name="193"><span class="lineNum">     193 </span>                :<span class="lineNoCov">          0 :     case EVREQ_HTTP_TIMEOUT:</span></a>
<a name="194"><span class="lineNum">     194 </span>                :<span class="lineNoCov">          0 :         return &quot;timeout reached&quot;;</span></a>
<a name="195"><span class="lineNum">     195 </span>                :<span class="lineNoCov">          0 :     case EVREQ_HTTP_EOF:</span></a>
<a name="196"><span class="lineNum">     196 </span>                :<span class="lineNoCov">          0 :         return &quot;EOF reached&quot;;</span></a>
<a name="197"><span class="lineNum">     197 </span>                :<span class="lineNoCov">          0 :     case EVREQ_HTTP_INVALID_HEADER:</span></a>
<a name="198"><span class="lineNum">     198 </span>                :<span class="lineNoCov">          0 :         return &quot;error while reading header, or invalid header&quot;;</span></a>
<a name="199"><span class="lineNum">     199 </span>                :<span class="lineNoCov">          0 :     case EVREQ_HTTP_BUFFER_ERROR:</span></a>
<a name="200"><span class="lineNum">     200 </span>                :<span class="lineNoCov">          0 :         return &quot;error encountered while reading or writing&quot;;</span></a>
<a name="201"><span class="lineNum">     201 </span>                :<span class="lineNoCov">          0 :     case EVREQ_HTTP_REQUEST_CANCEL:</span></a>
<a name="202"><span class="lineNum">     202 </span>                :<span class="lineNoCov">          0 :         return &quot;request was canceled&quot;;</span></a>
<a name="203"><span class="lineNum">     203 </span>                :<span class="lineNoCov">          0 :     case EVREQ_HTTP_DATA_TOO_LONG:</span></a>
<a name="204"><span class="lineNum">     204 </span>                :<span class="lineNoCov">          0 :         return &quot;response body is larger than allowed&quot;;</span></a>
<a name="205"><span class="lineNum">     205 </span>                :<span class="lineNoCov">          0 :     default:</span></a>
<a name="206"><span class="lineNum">     206 </span>                :<span class="lineNoCov">          0 :         return &quot;unknown&quot;;</span></a>
<a name="207"><span class="lineNum">     207 </span>                :            :     }</a>
<a name="208"><span class="lineNum">     208 </span>                :            : }</a>
<a name="209"><span class="lineNum">     209 </span>                :            : </a>
<a name="210"><span class="lineNum">     210 </span>                :<span class="lineNoCov">          0 : static void http_request_done(struct evhttp_request *req, void *ctx)</span></a>
<a name="211"><span class="lineNum">     211 </span>                :            : {</a>
<a name="212"><span class="lineNum">     212 </span>                :<span class="lineNoCov">          0 :     HTTPReply *reply = static_cast&lt;HTTPReply*&gt;(ctx);</span></a>
<a name="213"><span class="lineNum">     213 </span>                :            : </a>
<a name="214"><span class="lineNum">     214 </span>                :<span class="lineNoCov">          0 :     if (req == nullptr) {</span></a>
<a name="215"><span class="lineNum">     215 </span>                :            :         /* If req is nullptr, it means an error occurred while connecting: the</a>
<a name="216"><span class="lineNum">     216 </span>                :            :          * error code will have been passed to http_error_cb.</a>
<a name="217"><span class="lineNum">     217 </span>                :            :          */</a>
<a name="218"><span class="lineNum">     218 </span>                :<span class="lineNoCov">          0 :         reply-&gt;status = 0;</span></a>
<a name="219"><span class="lineNum">     219 </span>                :<span class="lineNoCov">          0 :         return;</span></a>
<a name="220"><span class="lineNum">     220 </span>                :            :     }</a>
<a name="221"><span class="lineNum">     221 </span>                :            : </a>
<a name="222"><span class="lineNum">     222 </span>                :<span class="lineNoCov">          0 :     reply-&gt;status = evhttp_request_get_response_code(req);</span></a>
<a name="223"><span class="lineNum">     223 </span>                :            : </a>
<a name="224"><span class="lineNum">     224 </span>                :<span class="lineNoCov">          0 :     struct evbuffer *buf = evhttp_request_get_input_buffer(req);</span></a>
<a name="225"><span class="lineNum">     225 </span>                :<span class="lineNoCov">          0 :     if (buf)</span></a>
<a name="226"><span class="lineNum">     226 </span>                :            :     {</a>
<a name="227"><span class="lineNum">     227 </span>                :<span class="lineNoCov">          0 :         size_t size = evbuffer_get_length(buf);</span></a>
<a name="228"><span class="lineNum">     228 </span>                :<span class="lineNoCov">          0 :         const char *data = (const char*)evbuffer_pullup(buf, size);</span></a>
<a name="229"><span class="lineNum">     229 </span>                :<span class="lineNoCov">          0 :         if (data)</span></a>
<a name="230"><span class="lineNum">     230 </span>                :<span class="lineNoCov">          0 :             reply-&gt;body = std::string(data, size);</span></a>
<a name="231"><span class="lineNum">     231 </span>                :<span class="lineNoCov">          0 :         evbuffer_drain(buf, size);</span></a>
<a name="232"><span class="lineNum">     232 </span>                :            :     }</a>
<a name="233"><span class="lineNum">     233 </span>                :            : }</a>
<a name="234"><span class="lineNum">     234 </span>                :            : </a>
<a name="235"><span class="lineNum">     235 </span>                :<span class="lineNoCov">          0 : static void http_error_cb(enum evhttp_request_error err, void *ctx)</span></a>
<a name="236"><span class="lineNum">     236 </span>                :            : {</a>
<a name="237"><span class="lineNum">     237 </span>                :<span class="lineNoCov">          0 :     HTTPReply *reply = static_cast&lt;HTTPReply*&gt;(ctx);</span></a>
<a name="238"><span class="lineNum">     238 </span>                :<span class="lineNoCov">          0 :     reply-&gt;error = err;</span></a>
<a name="239"><span class="lineNum">     239 </span>                :<span class="lineNoCov">          0 : }</span></a>
<a name="240"><span class="lineNum">     240 </span>                :            : </a>
<a name="241"><span class="lineNum">     241 </span>                :            : /** Class that handles the conversion from a command-line to a JSON-RPC request,</a>
<a name="242"><span class="lineNum">     242 </span>                :            :  * as well as converting back to a JSON object that can be shown as result.</a>
<a name="243"><span class="lineNum">     243 </span>                :            :  */</a>
<a name="244"><span class="lineNum">     244 </span>                :            : class BaseRequestHandler</a>
<a name="245"><span class="lineNum">     245 </span>                :            : {</a>
<a name="246"><span class="lineNum">     246 </span>                :            : public:</a>
<a name="247"><span class="lineNum">     247 </span>                :<span class="lineNoCov">          0 :     virtual ~BaseRequestHandler() = default;</span></a>
<a name="248"><span class="lineNum">     248 </span>                :            :     virtual UniValue PrepareRequest(const std::string&amp; method, const std::vector&lt;std::string&gt;&amp; args) = 0;</a>
<a name="249"><span class="lineNum">     249 </span>                :            :     virtual UniValue ProcessReply(const UniValue &amp;batch_in) = 0;</a>
<a name="250"><span class="lineNum">     250 </span>                :            : };</a>
<a name="251"><span class="lineNum">     251 </span>                :            : </a>
<a name="252"><span class="lineNum">     252 </span>                :            : /** Process addrinfo requests */</a>
<a name="253"><span class="lineNum">     253 </span>                :            : class AddrinfoRequestHandler : public BaseRequestHandler</a>
<a name="254"><span class="lineNum">     254 </span>                :            : {</a>
<a name="255"><span class="lineNum">     255 </span>                :            : private:</a>
<a name="256"><span class="lineNum">     256 </span>                :<span class="lineNoCov">          0 :     int8_t NetworkStringToId(const std::string&amp; str) const</span></a>
<a name="257"><span class="lineNum">     257 </span>                :            :     {</a>
<a name="258"><span class="lineNum">     258 </span>                :<span class="lineNoCov">          0 :         for (size_t i = 0; i &lt; NETWORKS.size(); ++i) {</span></a>
<a name="259"><span class="lineNum">     259 </span>                :<span class="lineNoCov">          0 :             if (str == NETWORKS[i]) return i;</span></a>
<a name="260"><span class="lineNum">     260 </span>                :            :         }</a>
<a name="261"><span class="lineNum">     261 </span>                :<span class="lineNoCov">          0 :         return UNKNOWN_NETWORK;</span></a>
<a name="262"><span class="lineNum">     262 </span>                :            :     }</a>
<a name="263"><span class="lineNum">     263 </span>                :            : </a>
<a name="264"><span class="lineNum">     264 </span>                :            : public:</a>
<a name="265"><span class="lineNum">     265 </span>                :<span class="lineNoCov">          0 :     UniValue PrepareRequest(const std::string&amp; method, const std::vector&lt;std::string&gt;&amp; args) override</span></a>
<a name="266"><span class="lineNum">     266 </span>                :            :     {</a>
<a name="267"><span class="lineNum">     267 </span>                :<span class="lineNoCov">          0 :         if (!args.empty()) {</span></a>
<a name="268"><span class="lineNum">     268 </span>                :<span class="lineNoCov">          0 :             throw std::runtime_error(&quot;-addrinfo takes no arguments&quot;);</span></a>
<a name="269"><span class="lineNum">     269 </span>                :            :         }</a>
<a name="270"><span class="lineNum">     270 </span>                :<span class="lineNoCov">          0 :         UniValue params{RPCConvertValues(&quot;getnodeaddresses&quot;, std::vector&lt;std::string&gt;{{&quot;0&quot;}})};</span></a>
<a name="271"><span class="lineNum">     271 </span>                :<span class="lineNoCov">          0 :         return JSONRPCRequestObj(&quot;getnodeaddresses&quot;, params, 1);</span></a>
<a name="272"><span class="lineNum">     272 </span>                :            :     }</a>
<a name="273"><span class="lineNum">     273 </span>                :            : </a>
<a name="274"><span class="lineNum">     274 </span>                :<span class="lineNoCov">          0 :     UniValue ProcessReply(const UniValue&amp; reply) override</span></a>
<a name="275"><span class="lineNum">     275 </span>                :            :     {</a>
<a name="276"><span class="lineNum">     276 </span>                :<span class="lineNoCov">          0 :         if (!reply[&quot;error&quot;].isNull()) return reply;</span></a>
<a name="277"><span class="lineNum">     277 </span>                :<span class="lineNoCov">          0 :         const std::vector&lt;UniValue&gt;&amp; nodes{reply[&quot;result&quot;].getValues()};</span></a>
<a name="278"><span class="lineNum">     278 </span>                :<span class="lineNoCov">          0 :         if (!nodes.empty() &amp;&amp; nodes.at(0)[&quot;network&quot;].isNull()) {</span></a>
<a name="279"><span class="lineNum">     279 </span>                :<span class="lineNoCov">          0 :             throw std::runtime_error(&quot;-addrinfo requires bitcoind server to be running v22.0 and up&quot;);</span></a>
<a name="280"><span class="lineNum">     280 </span>                :            :         }</a>
<a name="281"><span class="lineNum">     281 </span>                :            :         // Count the number of peers known to our node, by network.</a>
<a name="282"><span class="lineNum">     282 </span>                :<span class="lineNoCov">          0 :         std::array&lt;uint64_t, NETWORKS.size()&gt; counts{{}};</span></a>
<a name="283"><span class="lineNum">     283 </span>                :<span class="lineNoCov">          0 :         for (const UniValue&amp; node : nodes) {</span></a>
<a name="284"><span class="lineNum">     284 </span>                :<span class="lineNoCov">          0 :             std::string network_name{node[&quot;network&quot;].get_str()};</span></a>
<a name="285"><span class="lineNum">     285 </span>                :<span class="lineNoCov">          0 :             const int8_t network_id{NetworkStringToId(network_name)};</span></a>
<a name="286"><span class="lineNum">     286 </span>                :<span class="lineNoCov">          0 :             if (network_id == UNKNOWN_NETWORK) continue;</span></a>
<a name="287"><span class="lineNum">     287 </span>                :<span class="lineNoCov">          0 :             ++counts.at(network_id);</span></a>
<a name="288"><span class="lineNum">     288 </span>                :            :         }</a>
<a name="289"><span class="lineNum">     289 </span>                :            :         // Prepare result to return to user.</a>
<a name="290"><span class="lineNum">     290 </span>                :<span class="lineNoCov">          0 :         UniValue result{UniValue::VOBJ}, addresses{UniValue::VOBJ};</span></a>
<a name="291"><span class="lineNum">     291 </span>                :<span class="lineNoCov">          0 :         uint64_t total{0}; // Total address count</span></a>
<a name="292"><span class="lineNum">     292 </span>                :<span class="lineNoCov">          0 :         for (size_t i = 0; i &lt; NETWORKS.size(); ++i) {</span></a>
<a name="293"><span class="lineNum">     293 </span>                :<span class="lineNoCov">          0 :             addresses.pushKV(NETWORKS[i], counts.at(i));</span></a>
<a name="294"><span class="lineNum">     294 </span>                :<span class="lineNoCov">          0 :             total += counts.at(i);</span></a>
<a name="295"><span class="lineNum">     295 </span>                :            :         }</a>
<a name="296"><span class="lineNum">     296 </span>                :<span class="lineNoCov">          0 :         addresses.pushKV(&quot;total&quot;, total);</span></a>
<a name="297"><span class="lineNum">     297 </span>                :<span class="lineNoCov">          0 :         result.pushKV(&quot;addresses_known&quot;, addresses);</span></a>
<a name="298"><span class="lineNum">     298 </span>                :<span class="lineNoCov">          0 :         return JSONRPCReplyObj(result, NullUniValue, 1);</span></a>
<a name="299"><span class="lineNum">     299 </span>                :            :     }</a>
<a name="300"><span class="lineNum">     300 </span>                :            : };</a>
<a name="301"><span class="lineNum">     301 </span>                :            : </a>
<a name="302"><span class="lineNum">     302 </span>                :            : /** Process getinfo requests */</a>
<a name="303"><span class="lineNum">     303 </span>                :            : class GetinfoRequestHandler: public BaseRequestHandler</a>
<a name="304"><span class="lineNum">     304 </span>                :            : {</a>
<a name="305"><span class="lineNum">     305 </span>                :            : public:</a>
<a name="306"><span class="lineNum">     306 </span>                :            :     const int ID_NETWORKINFO = 0;</a>
<a name="307"><span class="lineNum">     307 </span>                :            :     const int ID_BLOCKCHAININFO = 1;</a>
<a name="308"><span class="lineNum">     308 </span>                :            :     const int ID_WALLETINFO = 2;</a>
<a name="309"><span class="lineNum">     309 </span>                :            :     const int ID_BALANCES = 3;</a>
<a name="310"><span class="lineNum">     310 </span>                :            : </a>
<a name="311"><span class="lineNum">     311 </span>                :            :     /** Create a simulated `getinfo` request. */</a>
<a name="312"><span class="lineNum">     312 </span>                :<span class="lineNoCov">          0 :     UniValue PrepareRequest(const std::string&amp; method, const std::vector&lt;std::string&gt;&amp; args) override</span></a>
<a name="313"><span class="lineNum">     313 </span>                :            :     {</a>
<a name="314"><span class="lineNum">     314 </span>                :<span class="lineNoCov">          0 :         if (!args.empty()) {</span></a>
<a name="315"><span class="lineNum">     315 </span>                :<span class="lineNoCov">          0 :             throw std::runtime_error(&quot;-getinfo takes no arguments&quot;);</span></a>
<a name="316"><span class="lineNum">     316 </span>                :            :         }</a>
<a name="317"><span class="lineNum">     317 </span>                :<span class="lineNoCov">          0 :         UniValue result(UniValue::VARR);</span></a>
<a name="318"><span class="lineNum">     318 </span>                :<span class="lineNoCov">          0 :         result.push_back(JSONRPCRequestObj(&quot;getnetworkinfo&quot;, NullUniValue, ID_NETWORKINFO));</span></a>
<a name="319"><span class="lineNum">     319 </span>                :<span class="lineNoCov">          0 :         result.push_back(JSONRPCRequestObj(&quot;getblockchaininfo&quot;, NullUniValue, ID_BLOCKCHAININFO));</span></a>
<a name="320"><span class="lineNum">     320 </span>                :<span class="lineNoCov">          0 :         result.push_back(JSONRPCRequestObj(&quot;getwalletinfo&quot;, NullUniValue, ID_WALLETINFO));</span></a>
<a name="321"><span class="lineNum">     321 </span>                :<span class="lineNoCov">          0 :         result.push_back(JSONRPCRequestObj(&quot;getbalances&quot;, NullUniValue, ID_BALANCES));</span></a>
<a name="322"><span class="lineNum">     322 </span>                :<span class="lineNoCov">          0 :         return result;</span></a>
<a name="323"><span class="lineNum">     323 </span>                :            :     }</a>
<a name="324"><span class="lineNum">     324 </span>                :            : </a>
<a name="325"><span class="lineNum">     325 </span>                :            :     /** Collect values from the batch and form a simulated `getinfo` reply. */</a>
<a name="326"><span class="lineNum">     326 </span>                :<span class="lineNoCov">          0 :     UniValue ProcessReply(const UniValue &amp;batch_in) override</span></a>
<a name="327"><span class="lineNum">     327 </span>                :            :     {</a>
<a name="328"><span class="lineNum">     328 </span>                :<span class="lineNoCov">          0 :         UniValue result(UniValue::VOBJ);</span></a>
<a name="329"><span class="lineNum">     329 </span>                :<span class="lineNoCov">          0 :         const std::vector&lt;UniValue&gt; batch = JSONRPCProcessBatchReply(batch_in);</span></a>
<a name="330"><span class="lineNum">     330 </span>                :            :         // Errors in getnetworkinfo() and getblockchaininfo() are fatal, pass them on;</a>
<a name="331"><span class="lineNum">     331 </span>                :            :         // getwalletinfo() and getbalances() are allowed to fail if there is no wallet.</a>
<a name="332"><span class="lineNum">     332 </span>                :<span class="lineNoCov">          0 :         if (!batch[ID_NETWORKINFO][&quot;error&quot;].isNull()) {</span></a>
<a name="333"><span class="lineNum">     333 </span>                :<span class="lineNoCov">          0 :             return batch[ID_NETWORKINFO];</span></a>
<a name="334"><span class="lineNum">     334 </span>                :            :         }</a>
<a name="335"><span class="lineNum">     335 </span>                :<span class="lineNoCov">          0 :         if (!batch[ID_BLOCKCHAININFO][&quot;error&quot;].isNull()) {</span></a>
<a name="336"><span class="lineNum">     336 </span>                :<span class="lineNoCov">          0 :             return batch[ID_BLOCKCHAININFO];</span></a>
<a name="337"><span class="lineNum">     337 </span>                :            :         }</a>
<a name="338"><span class="lineNum">     338 </span>                :<span class="lineNoCov">          0 :         result.pushKV(&quot;version&quot;, batch[ID_NETWORKINFO][&quot;result&quot;][&quot;version&quot;]);</span></a>
<a name="339"><span class="lineNum">     339 </span>                :<span class="lineNoCov">          0 :         result.pushKV(&quot;blocks&quot;, batch[ID_BLOCKCHAININFO][&quot;result&quot;][&quot;blocks&quot;]);</span></a>
<a name="340"><span class="lineNum">     340 </span>                :<span class="lineNoCov">          0 :         result.pushKV(&quot;headers&quot;, batch[ID_BLOCKCHAININFO][&quot;result&quot;][&quot;headers&quot;]);</span></a>
<a name="341"><span class="lineNum">     341 </span>                :<span class="lineNoCov">          0 :         result.pushKV(&quot;verificationprogress&quot;, batch[ID_BLOCKCHAININFO][&quot;result&quot;][&quot;verificationprogress&quot;]);</span></a>
<a name="342"><span class="lineNum">     342 </span>                :<span class="lineNoCov">          0 :         result.pushKV(&quot;timeoffset&quot;, batch[ID_NETWORKINFO][&quot;result&quot;][&quot;timeoffset&quot;]);</span></a>
<a name="343"><span class="lineNum">     343 </span>                :            : </a>
<a name="344"><span class="lineNum">     344 </span>                :<span class="lineNoCov">          0 :         UniValue connections(UniValue::VOBJ);</span></a>
<a name="345"><span class="lineNum">     345 </span>                :<span class="lineNoCov">          0 :         connections.pushKV(&quot;in&quot;, batch[ID_NETWORKINFO][&quot;result&quot;][&quot;connections_in&quot;]);</span></a>
<a name="346"><span class="lineNum">     346 </span>                :<span class="lineNoCov">          0 :         connections.pushKV(&quot;out&quot;, batch[ID_NETWORKINFO][&quot;result&quot;][&quot;connections_out&quot;]);</span></a>
<a name="347"><span class="lineNum">     347 </span>                :<span class="lineNoCov">          0 :         connections.pushKV(&quot;total&quot;, batch[ID_NETWORKINFO][&quot;result&quot;][&quot;connections&quot;]);</span></a>
<a name="348"><span class="lineNum">     348 </span>                :<span class="lineNoCov">          0 :         result.pushKV(&quot;connections&quot;, connections);</span></a>
<a name="349"><span class="lineNum">     349 </span>                :            : </a>
<a name="350"><span class="lineNum">     350 </span>                :<span class="lineNoCov">          0 :         result.pushKV(&quot;networks&quot;, batch[ID_NETWORKINFO][&quot;result&quot;][&quot;networks&quot;]);</span></a>
<a name="351"><span class="lineNum">     351 </span>                :<span class="lineNoCov">          0 :         result.pushKV(&quot;difficulty&quot;, batch[ID_BLOCKCHAININFO][&quot;result&quot;][&quot;difficulty&quot;]);</span></a>
<a name="352"><span class="lineNum">     352 </span>                :<span class="lineNoCov">          0 :         result.pushKV(&quot;chain&quot;, UniValue(batch[ID_BLOCKCHAININFO][&quot;result&quot;][&quot;chain&quot;]));</span></a>
<a name="353"><span class="lineNum">     353 </span>                :<span class="lineNoCov">          0 :         if (!batch[ID_WALLETINFO][&quot;result&quot;].isNull()) {</span></a>
<a name="354"><span class="lineNum">     354 </span>                :<span class="lineNoCov">          0 :             result.pushKV(&quot;has_wallet&quot;, true);</span></a>
<a name="355"><span class="lineNum">     355 </span>                :<span class="lineNoCov">          0 :             result.pushKV(&quot;keypoolsize&quot;, batch[ID_WALLETINFO][&quot;result&quot;][&quot;keypoolsize&quot;]);</span></a>
<a name="356"><span class="lineNum">     356 </span>                :<span class="lineNoCov">          0 :             result.pushKV(&quot;walletname&quot;, batch[ID_WALLETINFO][&quot;result&quot;][&quot;walletname&quot;]);</span></a>
<a name="357"><span class="lineNum">     357 </span>                :<span class="lineNoCov">          0 :             if (!batch[ID_WALLETINFO][&quot;result&quot;][&quot;unlocked_until&quot;].isNull()) {</span></a>
<a name="358"><span class="lineNum">     358 </span>                :<span class="lineNoCov">          0 :                 result.pushKV(&quot;unlocked_until&quot;, batch[ID_WALLETINFO][&quot;result&quot;][&quot;unlocked_until&quot;]);</span></a>
<a name="359"><span class="lineNum">     359 </span>                :            :             }</a>
<a name="360"><span class="lineNum">     360 </span>                :<span class="lineNoCov">          0 :             result.pushKV(&quot;paytxfee&quot;, batch[ID_WALLETINFO][&quot;result&quot;][&quot;paytxfee&quot;]);</span></a>
<a name="361"><span class="lineNum">     361 </span>                :            :         }</a>
<a name="362"><span class="lineNum">     362 </span>                :<span class="lineNoCov">          0 :         if (!batch[ID_BALANCES][&quot;result&quot;].isNull()) {</span></a>
<a name="363"><span class="lineNum">     363 </span>                :<span class="lineNoCov">          0 :             result.pushKV(&quot;balance&quot;, batch[ID_BALANCES][&quot;result&quot;][&quot;mine&quot;][&quot;trusted&quot;]);</span></a>
<a name="364"><span class="lineNum">     364 </span>                :            :         }</a>
<a name="365"><span class="lineNum">     365 </span>                :<span class="lineNoCov">          0 :         result.pushKV(&quot;relayfee&quot;, batch[ID_NETWORKINFO][&quot;result&quot;][&quot;relayfee&quot;]);</span></a>
<a name="366"><span class="lineNum">     366 </span>                :<span class="lineNoCov">          0 :         result.pushKV(&quot;warnings&quot;, batch[ID_NETWORKINFO][&quot;result&quot;][&quot;warnings&quot;]);</span></a>
<a name="367"><span class="lineNum">     367 </span>                :<span class="lineNoCov">          0 :         return JSONRPCReplyObj(result, NullUniValue, 1);</span></a>
<a name="368"><span class="lineNum">     368 </span>                :            :     }</a>
<a name="369"><span class="lineNum">     369 </span>                :            : };</a>
<a name="370"><span class="lineNum">     370 </span>                :            : </a>
<a name="371"><span class="lineNum">     371 </span>                :            : /** Process netinfo requests */</a>
<a name="372"><span class="lineNum">     372 </span>                :            : class NetinfoRequestHandler : public BaseRequestHandler</a>
<a name="373"><span class="lineNum">     373 </span>                :            : {</a>
<a name="374"><span class="lineNum">     374 </span>                :            : private:</a>
<a name="375"><span class="lineNum">     375 </span>                :            :     static constexpr uint8_t MAX_DETAIL_LEVEL{4};</a>
<a name="376"><span class="lineNum">     376 </span>                :            :     std::array&lt;std::array&lt;uint16_t, NETWORKS.size() + 1&gt;, 3&gt; m_counts{{{}}}; //!&lt; Peer counts by (in/out/total, networks/total)</a>
<a name="377"><span class="lineNum">     377 </span>                :            :     uint8_t m_block_relay_peers_count{0};</a>
<a name="378"><span class="lineNum">     378 </span>                :            :     uint8_t m_manual_peers_count{0};</a>
<a name="379"><span class="lineNum">     379 </span>                :<span class="lineNoCov">          0 :     int8_t NetworkStringToId(const std::string&amp; str) const</span></a>
<a name="380"><span class="lineNum">     380 </span>                :            :     {</a>
<a name="381"><span class="lineNum">     381 </span>                :<span class="lineNoCov">          0 :         for (size_t i = 0; i &lt; NETWORKS.size(); ++i) {</span></a>
<a name="382"><span class="lineNum">     382 </span>                :<span class="lineNoCov">          0 :             if (str == NETWORKS[i]) return i;</span></a>
<a name="383"><span class="lineNum">     383 </span>                :            :         }</a>
<a name="384"><span class="lineNum">     384 </span>                :<span class="lineNoCov">          0 :         return UNKNOWN_NETWORK;</span></a>
<a name="385"><span class="lineNum">     385 </span>                :            :     }</a>
<a name="386"><span class="lineNum">     386 </span>                :            :     uint8_t m_details_level{0}; //!&lt; Optional user-supplied arg to set dashboard details level</a>
<a name="387"><span class="lineNum">     387 </span>                :<span class="lineNoCov">          0 :     bool DetailsRequested() const { return m_details_level &gt; 0 &amp;&amp; m_details_level &lt; 5; }</span></a>
<a name="388"><span class="lineNum">     388 </span>                :<span class="lineNoCov">          0 :     bool IsAddressSelected() const { return m_details_level == 2 || m_details_level == 4; }</span></a>
<a name="389"><span class="lineNum">     389 </span>                :<span class="lineNoCov">          0 :     bool IsVersionSelected() const { return m_details_level == 3 || m_details_level == 4; }</span></a>
<a name="390"><span class="lineNum">     390 </span>                :            :     bool m_is_asmap_on{false};</a>
<a name="391"><span class="lineNum">     391 </span>                :            :     size_t m_max_addr_length{0};</a>
<a name="392"><span class="lineNum">     392 </span>                :            :     size_t m_max_addr_processed_length{5};</a>
<a name="393"><span class="lineNum">     393 </span>                :            :     size_t m_max_addr_rate_limited_length{6};</a>
<a name="394"><span class="lineNum">     394 </span>                :            :     size_t m_max_age_length{5};</a>
<a name="395"><span class="lineNum">     395 </span>                :            :     size_t m_max_id_length{2};</a>
<a name="396"><span class="lineNum">     396 </span>                :            :     struct Peer {</a>
<a name="397"><span class="lineNum">     397 </span>                :            :         std::string addr;</a>
<a name="398"><span class="lineNum">     398 </span>                :            :         std::string sub_version;</a>
<a name="399"><span class="lineNum">     399 </span>                :            :         std::string conn_type;</a>
<a name="400"><span class="lineNum">     400 </span>                :            :         std::string network;</a>
<a name="401"><span class="lineNum">     401 </span>                :            :         std::string age;</a>
<a name="402"><span class="lineNum">     402 </span>                :            :         double min_ping;</a>
<a name="403"><span class="lineNum">     403 </span>                :            :         double ping;</a>
<a name="404"><span class="lineNum">     404 </span>                :            :         int64_t addr_processed;</a>
<a name="405"><span class="lineNum">     405 </span>                :            :         int64_t addr_rate_limited;</a>
<a name="406"><span class="lineNum">     406 </span>                :            :         int64_t last_blck;</a>
<a name="407"><span class="lineNum">     407 </span>                :            :         int64_t last_recv;</a>
<a name="408"><span class="lineNum">     408 </span>                :            :         int64_t last_send;</a>
<a name="409"><span class="lineNum">     409 </span>                :            :         int64_t last_trxn;</a>
<a name="410"><span class="lineNum">     410 </span>                :            :         int id;</a>
<a name="411"><span class="lineNum">     411 </span>                :            :         int mapped_as;</a>
<a name="412"><span class="lineNum">     412 </span>                :            :         int version;</a>
<a name="413"><span class="lineNum">     413 </span>                :            :         bool is_addr_relay_enabled;</a>
<a name="414"><span class="lineNum">     414 </span>                :            :         bool is_bip152_hb_from;</a>
<a name="415"><span class="lineNum">     415 </span>                :            :         bool is_bip152_hb_to;</a>
<a name="416"><span class="lineNum">     416 </span>                :            :         bool is_outbound;</a>
<a name="417"><span class="lineNum">     417 </span>                :            :         bool is_tx_relay;</a>
<a name="418"><span class="lineNum">     418 </span>                :<span class="lineNoCov">          0 :         bool operator&lt;(const Peer&amp; rhs) const { return std::tie(is_outbound, min_ping) &lt; std::tie(rhs.is_outbound, rhs.min_ping); }</span></a>
<a name="419"><span class="lineNum">     419 </span>                :            :     };</a>
<a name="420"><span class="lineNum">     420 </span>                :            :     std::vector&lt;Peer&gt; m_peers;</a>
<a name="421"><span class="lineNum">     421 </span>                :<span class="lineNoCov">          0 :     std::string ChainToString() const</span></a>
<a name="422"><span class="lineNum">     422 </span>                :            :     {</a>
<a name="423"><span class="lineNum">     423 </span>                :<span class="lineNoCov">          0 :         if (gArgs.GetChainName() == CBaseChainParams::TESTNET) return &quot; testnet&quot;;</span></a>
<a name="424"><span class="lineNum">     424 </span>                :<span class="lineNoCov">          0 :         if (gArgs.GetChainName() == CBaseChainParams::SIGNET) return &quot; signet&quot;;</span></a>
<a name="425"><span class="lineNum">     425 </span>                :<span class="lineNoCov">          0 :         if (gArgs.GetChainName() == CBaseChainParams::REGTEST) return &quot; regtest&quot;;</span></a>
<a name="426"><span class="lineNum">     426 </span>                :<span class="lineNoCov">          0 :         return &quot;&quot;;</span></a>
<a name="427"><span class="lineNum">     427 </span>                :            :     }</a>
<a name="428"><span class="lineNum">     428 </span>                :<span class="lineNoCov">          0 :     std::string PingTimeToString(double seconds) const</span></a>
<a name="429"><span class="lineNum">     429 </span>                :            :     {</a>
<a name="430"><span class="lineNum">     430 </span>                :<span class="lineNoCov">          0 :         if (seconds &lt; 0) return &quot;&quot;;</span></a>
<a name="431"><span class="lineNum">     431 </span>                :<span class="lineNoCov">          0 :         const double milliseconds{round(1000 * seconds)};</span></a>
<a name="432"><span class="lineNum">     432 </span>                :<span class="lineNoCov">          0 :         return milliseconds &gt; 999999 ? &quot;-&quot; : ToString(milliseconds);</span></a>
<a name="433"><span class="lineNum">     433 </span>                :            :     }</a>
<a name="434"><span class="lineNum">     434 </span>                :<span class="lineNoCov">          0 :     std::string ConnectionTypeForNetinfo(const std::string&amp; conn_type) const</span></a>
<a name="435"><span class="lineNum">     435 </span>                :            :     {</a>
<a name="436"><span class="lineNum">     436 </span>                :<span class="lineNoCov">          0 :         if (conn_type == &quot;outbound-full-relay&quot;) return &quot;full&quot;;</span></a>
<a name="437"><span class="lineNum">     437 </span>                :<span class="lineNoCov">          0 :         if (conn_type == &quot;block-relay-only&quot;) return &quot;block&quot;;</span></a>
<a name="438"><span class="lineNum">     438 </span>                :<span class="lineNoCov">          0 :         if (conn_type == &quot;manual&quot; || conn_type == &quot;feeler&quot;) return conn_type;</span></a>
<a name="439"><span class="lineNum">     439 </span>                :<span class="lineNoCov">          0 :         if (conn_type == &quot;addr-fetch&quot;) return &quot;addr&quot;;</span></a>
<a name="440"><span class="lineNum">     440 </span>                :<span class="lineNoCov">          0 :         return &quot;&quot;;</span></a>
<a name="441"><span class="lineNum">     441 </span>                :            :     }</a>
<a name="442"><span class="lineNum">     442 </span>                :            : </a>
<a name="443"><span class="lineNum">     443 </span>                :            : public:</a>
<a name="444"><span class="lineNum">     444 </span>                :            :     static constexpr int ID_PEERINFO = 0;</a>
<a name="445"><span class="lineNum">     445 </span>                :            :     static constexpr int ID_NETWORKINFO = 1;</a>
<a name="446"><span class="lineNum">     446 </span>                :            : </a>
<a name="447"><span class="lineNum">     447 </span>                :<span class="lineNoCov">          0 :     UniValue PrepareRequest(const std::string&amp; method, const std::vector&lt;std::string&gt;&amp; args) override</span></a>
<a name="448"><span class="lineNum">     448 </span>                :            :     {</a>
<a name="449"><span class="lineNum">     449 </span>                :<span class="lineNoCov">          0 :         if (!args.empty()) {</span></a>
<a name="450"><span class="lineNum">     450 </span>                :<span class="lineNoCov">          0 :             uint8_t n{0};</span></a>
<a name="451"><span class="lineNum">     451 </span>                :<span class="lineNoCov">          0 :             if (ParseUInt8(args.at(0), &amp;n)) {</span></a>
<a name="452"><span class="lineNum">     452 </span>                :<span class="lineNoCov">          0 :                 m_details_level = std::min(n, MAX_DETAIL_LEVEL);</span></a>
<a name="453"><span class="lineNum">     453 </span>                :            :             } else {</a>
<a name="454"><span class="lineNum">     454 </span>                :<span class="lineNoCov">          0 :                 throw std::runtime_error(strprintf(&quot;invalid -netinfo argument: %s\nFor more information, run: bitcoin-cli -netinfo help&quot;, args.at(0)));</span></a>
<a name="455"><span class="lineNum">     455 </span>                :            :             }</a>
<a name="456"><span class="lineNum">     456 </span>                :            :         }</a>
<a name="457"><span class="lineNum">     457 </span>                :<span class="lineNoCov">          0 :         UniValue result(UniValue::VARR);</span></a>
<a name="458"><span class="lineNum">     458 </span>                :<span class="lineNoCov">          0 :         result.push_back(JSONRPCRequestObj(&quot;getpeerinfo&quot;, NullUniValue, ID_PEERINFO));</span></a>
<a name="459"><span class="lineNum">     459 </span>                :<span class="lineNoCov">          0 :         result.push_back(JSONRPCRequestObj(&quot;getnetworkinfo&quot;, NullUniValue, ID_NETWORKINFO));</span></a>
<a name="460"><span class="lineNum">     460 </span>                :<span class="lineNoCov">          0 :         return result;</span></a>
<a name="461"><span class="lineNum">     461 </span>                :            :     }</a>
<a name="462"><span class="lineNum">     462 </span>                :            : </a>
<a name="463"><span class="lineNum">     463 </span>                :<span class="lineNoCov">          0 :     UniValue ProcessReply(const UniValue&amp; batch_in) override</span></a>
<a name="464"><span class="lineNum">     464 </span>                :            :     {</a>
<a name="465"><span class="lineNum">     465 </span>                :<span class="lineNoCov">          0 :         const std::vector&lt;UniValue&gt; batch{JSONRPCProcessBatchReply(batch_in)};</span></a>
<a name="466"><span class="lineNum">     466 </span>                :<span class="lineNoCov">          0 :         if (!batch[ID_PEERINFO][&quot;error&quot;].isNull()) return batch[ID_PEERINFO];</span></a>
<a name="467"><span class="lineNum">     467 </span>                :<span class="lineNoCov">          0 :         if (!batch[ID_NETWORKINFO][&quot;error&quot;].isNull()) return batch[ID_NETWORKINFO];</span></a>
<a name="468"><span class="lineNum">     468 </span>                :            : </a>
<a name="469"><span class="lineNum">     469 </span>                :<span class="lineNoCov">          0 :         const UniValue&amp; networkinfo{batch[ID_NETWORKINFO][&quot;result&quot;]};</span></a>
<a name="470"><span class="lineNum">     470 </span>                :<span class="lineNoCov">          0 :         if (networkinfo[&quot;version&quot;].getInt&lt;int&gt;() &lt; 209900) {</span></a>
<a name="471"><span class="lineNum">     471 </span>                :<span class="lineNoCov">          0 :             throw std::runtime_error(&quot;-netinfo requires bitcoind server to be running v0.21.0 and up&quot;);</span></a>
<a name="472"><span class="lineNum">     472 </span>                :            :         }</a>
<a name="473"><span class="lineNum">     473 </span>                :<span class="lineNoCov">          0 :         const int64_t time_now{TicksSinceEpoch&lt;std::chrono::seconds&gt;(CliClock::now())};</span></a>
<a name="474"><span class="lineNum">     474 </span>                :            : </a>
<a name="475"><span class="lineNum">     475 </span>                :            :         // Count peer connection totals, and if DetailsRequested(), store peer data in a vector of structs.</a>
<a name="476"><span class="lineNum">     476 </span>                :<span class="lineNoCov">          0 :         for (const UniValue&amp; peer : batch[ID_PEERINFO][&quot;result&quot;].getValues()) {</span></a>
<a name="477"><span class="lineNum">     477 </span>                :<span class="lineNoCov">          0 :             const std::string network{peer[&quot;network&quot;].get_str()};</span></a>
<a name="478"><span class="lineNum">     478 </span>                :<span class="lineNoCov">          0 :             const int8_t network_id{NetworkStringToId(network)};</span></a>
<a name="479"><span class="lineNum">     479 </span>                :<span class="lineNoCov">          0 :             if (network_id == UNKNOWN_NETWORK) continue;</span></a>
<a name="480"><span class="lineNum">     480 </span>                :<span class="lineNoCov">          0 :             const bool is_outbound{!peer[&quot;inbound&quot;].get_bool()};</span></a>
<a name="481"><span class="lineNum">     481 </span>                :<span class="lineNoCov">          0 :             const bool is_tx_relay{peer[&quot;relaytxes&quot;].isNull() ? true : peer[&quot;relaytxes&quot;].get_bool()};</span></a>
<a name="482"><span class="lineNum">     482 </span>                :<span class="lineNoCov">          0 :             const std::string conn_type{peer[&quot;connection_type&quot;].get_str()};</span></a>
<a name="483"><span class="lineNum">     483 </span>                :<span class="lineNoCov">          0 :             ++m_counts.at(is_outbound).at(network_id);      // in/out by network</span></a>
<a name="484"><span class="lineNum">     484 </span>                :<span class="lineNoCov">          0 :             ++m_counts.at(is_outbound).at(NETWORKS.size()); // in/out overall</span></a>
<a name="485"><span class="lineNum">     485 </span>                :<span class="lineNoCov">          0 :             ++m_counts.at(2).at(network_id);                // total by network</span></a>
<a name="486"><span class="lineNum">     486 </span>                :<span class="lineNoCov">          0 :             ++m_counts.at(2).at(NETWORKS.size());           // total overall</span></a>
<a name="487"><span class="lineNum">     487 </span>                :<span class="lineNoCov">          0 :             if (conn_type == &quot;block-relay-only&quot;) ++m_block_relay_peers_count;</span></a>
<a name="488"><span class="lineNum">     488 </span>                :<span class="lineNoCov">          0 :             if (conn_type == &quot;manual&quot;) ++m_manual_peers_count;</span></a>
<a name="489"><span class="lineNum">     489 </span>                :<span class="lineNoCov">          0 :             if (DetailsRequested()) {</span></a>
<a name="490"><span class="lineNum">     490 </span>                :            :                 // Push data for this peer to the peers vector.</a>
<a name="491"><span class="lineNum">     491 </span>                :<span class="lineNoCov">          0 :                 const int peer_id{peer[&quot;id&quot;].getInt&lt;int&gt;()};</span></a>
<a name="492"><span class="lineNum">     492 </span>                :<span class="lineNoCov">          0 :                 const int mapped_as{peer[&quot;mapped_as&quot;].isNull() ? 0 : peer[&quot;mapped_as&quot;].getInt&lt;int&gt;()};</span></a>
<a name="493"><span class="lineNum">     493 </span>                :<span class="lineNoCov">          0 :                 const int version{peer[&quot;version&quot;].getInt&lt;int&gt;()};</span></a>
<a name="494"><span class="lineNum">     494 </span>                :<span class="lineNoCov">          0 :                 const int64_t addr_processed{peer[&quot;addr_processed&quot;].isNull() ? 0 : peer[&quot;addr_processed&quot;].getInt&lt;int64_t&gt;()};</span></a>
<a name="495"><span class="lineNum">     495 </span>                :<span class="lineNoCov">          0 :                 const int64_t addr_rate_limited{peer[&quot;addr_rate_limited&quot;].isNull() ? 0 : peer[&quot;addr_rate_limited&quot;].getInt&lt;int64_t&gt;()};</span></a>
<a name="496"><span class="lineNum">     496 </span>                :<span class="lineNoCov">          0 :                 const int64_t conn_time{peer[&quot;conntime&quot;].getInt&lt;int64_t&gt;()};</span></a>
<a name="497"><span class="lineNum">     497 </span>                :<span class="lineNoCov">          0 :                 const int64_t last_blck{peer[&quot;last_block&quot;].getInt&lt;int64_t&gt;()};</span></a>
<a name="498"><span class="lineNum">     498 </span>                :<span class="lineNoCov">          0 :                 const int64_t last_recv{peer[&quot;lastrecv&quot;].getInt&lt;int64_t&gt;()};</span></a>
<a name="499"><span class="lineNum">     499 </span>                :<span class="lineNoCov">          0 :                 const int64_t last_send{peer[&quot;lastsend&quot;].getInt&lt;int64_t&gt;()};</span></a>
<a name="500"><span class="lineNum">     500 </span>                :<span class="lineNoCov">          0 :                 const int64_t last_trxn{peer[&quot;last_transaction&quot;].getInt&lt;int64_t&gt;()};</span></a>
<a name="501"><span class="lineNum">     501 </span>                :<span class="lineNoCov">          0 :                 const double min_ping{peer[&quot;minping&quot;].isNull() ? -1 : peer[&quot;minping&quot;].get_real()};</span></a>
<a name="502"><span class="lineNum">     502 </span>                :<span class="lineNoCov">          0 :                 const double ping{peer[&quot;pingtime&quot;].isNull() ? -1 : peer[&quot;pingtime&quot;].get_real()};</span></a>
<a name="503"><span class="lineNum">     503 </span>                :<span class="lineNoCov">          0 :                 const std::string addr{peer[&quot;addr&quot;].get_str()};</span></a>
<a name="504"><span class="lineNum">     504 </span>                :<span class="lineNoCov">          0 :                 const std::string age{conn_time == 0 ? &quot;&quot; : ToString((time_now - conn_time) / 60)};</span></a>
<a name="505"><span class="lineNum">     505 </span>                :<span class="lineNoCov">          0 :                 const std::string sub_version{peer[&quot;subver&quot;].get_str()};</span></a>
<a name="506"><span class="lineNum">     506 </span>                :<span class="lineNoCov">          0 :                 const bool is_addr_relay_enabled{peer[&quot;addr_relay_enabled&quot;].isNull() ? false : peer[&quot;addr_relay_enabled&quot;].get_bool()};</span></a>
<a name="507"><span class="lineNum">     507 </span>                :<span class="lineNoCov">          0 :                 const bool is_bip152_hb_from{peer[&quot;bip152_hb_from&quot;].get_bool()};</span></a>
<a name="508"><span class="lineNum">     508 </span>                :<span class="lineNoCov">          0 :                 const bool is_bip152_hb_to{peer[&quot;bip152_hb_to&quot;].get_bool()};</span></a>
<a name="509"><span class="lineNum">     509 </span>                :<span class="lineNoCov">          0 :                 m_peers.push_back({addr, sub_version, conn_type, network, age, min_ping, ping, addr_processed, addr_rate_limited, last_blck, last_recv, last_send, last_trxn, peer_id, mapped_as, version, is_addr_relay_enabled, is_bip152_hb_from, is_bip152_hb_to, is_outbound, is_tx_relay});</span></a>
<a name="510"><span class="lineNum">     510 </span>                :<span class="lineNoCov">          0 :                 m_max_addr_length = std::max(addr.length() + 1, m_max_addr_length);</span></a>
<a name="511"><span class="lineNum">     511 </span>                :<span class="lineNoCov">          0 :                 m_max_addr_processed_length = std::max(ToString(addr_processed).length(), m_max_addr_processed_length);</span></a>
<a name="512"><span class="lineNum">     512 </span>                :<span class="lineNoCov">          0 :                 m_max_addr_rate_limited_length = std::max(ToString(addr_rate_limited).length(), m_max_addr_rate_limited_length);</span></a>
<a name="513"><span class="lineNum">     513 </span>                :<span class="lineNoCov">          0 :                 m_max_age_length = std::max(age.length(), m_max_age_length);</span></a>
<a name="514"><span class="lineNum">     514 </span>                :<span class="lineNoCov">          0 :                 m_max_id_length = std::max(ToString(peer_id).length(), m_max_id_length);</span></a>
<a name="515"><span class="lineNum">     515 </span>                :<span class="lineNoCov">          0 :                 m_is_asmap_on |= (mapped_as != 0);</span></a>
<a name="516"><span class="lineNum">     516 </span>                :            :             }</a>
<a name="517"><span class="lineNum">     517 </span>                :            :         }</a>
<a name="518"><span class="lineNum">     518 </span>                :            : </a>
<a name="519"><span class="lineNum">     519 </span>                :            :         // Generate report header.</a>
<a name="520"><span class="lineNum">     520 </span>                :<span class="lineNoCov">          0 :         std::string result{strprintf(&quot;%s client %s%s - server %i%s\n\n&quot;, PACKAGE_NAME, FormatFullVersion(), ChainToString(), networkinfo[&quot;protocolversion&quot;].getInt&lt;int&gt;(), networkinfo[&quot;subversion&quot;].get_str())};</span></a>
<a name="521"><span class="lineNum">     521 </span>                :            : </a>
<a name="522"><span class="lineNum">     522 </span>                :            :         // Report detailed peer connections list sorted by direction and minimum ping time.</a>
<a name="523"><span class="lineNum">     523 </span>                :<span class="lineNoCov">          0 :         if (DetailsRequested() &amp;&amp; !m_peers.empty()) {</span></a>
<a name="524"><span class="lineNum">     524 </span>                :<span class="lineNoCov">          0 :             std::sort(m_peers.begin(), m_peers.end());</span></a>
<a name="525"><span class="lineNum">     525 </span>                :<span class="lineNoCov">          0 :             result += strprintf(&quot;&lt;-&gt;   type   net  mping   ping send recv  txn  blk  hb %*s%*s%*s &quot;,</span></a>
<a name="526"><span class="lineNum">     526 </span>                :<span class="lineNoCov">          0 :                                 m_max_addr_processed_length, &quot;addrp&quot;,</span></a>
<a name="527"><span class="lineNum">     527 </span>                :<span class="lineNoCov">          0 :                                 m_max_addr_rate_limited_length, &quot;addrl&quot;,</span></a>
<a name="528"><span class="lineNum">     528 </span>                :<span class="lineNoCov">          0 :                                 m_max_age_length, &quot;age&quot;);</span></a>
<a name="529"><span class="lineNum">     529 </span>                :<span class="lineNoCov">          0 :             if (m_is_asmap_on) result += &quot; asmap &quot;;</span></a>
<a name="530"><span class="lineNum">     530 </span>                :<span class="lineNoCov">          0 :             result += strprintf(&quot;%*s %-*s%s\n&quot;, m_max_id_length, &quot;id&quot;, IsAddressSelected() ? m_max_addr_length : 0, IsAddressSelected() ? &quot;address&quot; : &quot;&quot;, IsVersionSelected() ? &quot;version&quot; : &quot;&quot;);</span></a>
<a name="531"><span class="lineNum">     531 </span>                :<span class="lineNoCov">          0 :             for (const Peer&amp; peer : m_peers) {</span></a>
<a name="532"><span class="lineNum">     532 </span>                :<span class="lineNoCov">          0 :                 std::string version{ToString(peer.version) + peer.sub_version};</span></a>
<a name="533"><span class="lineNum">     533 </span>                :<span class="lineNoCov">          0 :                 result += strprintf(</span></a>
<a name="534"><span class="lineNum">     534 </span>                :            :                     &quot;%3s %6s %5s%7s%7s%5s%5s%5s%5s  %2s %*s%*s%*s%*i %*s %-*s%s\n&quot;,</a>
<a name="535"><span class="lineNum">     535 </span>                :<span class="lineNoCov">          0 :                     peer.is_outbound ? &quot;out&quot; : &quot;in&quot;,</span></a>
<a name="536"><span class="lineNum">     536 </span>                :<span class="lineNoCov">          0 :                     ConnectionTypeForNetinfo(peer.conn_type),</span></a>
<a name="537"><span class="lineNum">     537 </span>                :<span class="lineNoCov">          0 :                     peer.network,</span></a>
<a name="538"><span class="lineNum">     538 </span>                :<span class="lineNoCov">          0 :                     PingTimeToString(peer.min_ping),</span></a>
<a name="539"><span class="lineNum">     539 </span>                :<span class="lineNoCov">          0 :                     PingTimeToString(peer.ping),</span></a>
<a name="540"><span class="lineNum">     540 </span>                :<span class="lineNoCov">          0 :                     peer.last_send ? ToString(time_now - peer.last_send) : &quot;&quot;,</span></a>
<a name="541"><span class="lineNum">     541 </span>                :<span class="lineNoCov">          0 :                     peer.last_recv ? ToString(time_now - peer.last_recv) : &quot;&quot;,</span></a>
<a name="542"><span class="lineNum">     542 </span>                :<span class="lineNoCov">          0 :                     peer.last_trxn ? ToString((time_now - peer.last_trxn) / 60) : peer.is_tx_relay ? &quot;&quot; : &quot;*&quot;,</span></a>
<a name="543"><span class="lineNum">     543 </span>                :<span class="lineNoCov">          0 :                     peer.last_blck ? ToString((time_now - peer.last_blck) / 60) : &quot;&quot;,</span></a>
<a name="544"><span class="lineNum">     544 </span>                :<span class="lineNoCov">          0 :                     strprintf(&quot;%s%s&quot;, peer.is_bip152_hb_to ? &quot;.&quot; : &quot; &quot;, peer.is_bip152_hb_from ? &quot;*&quot; : &quot; &quot;),</span></a>
<a name="545"><span class="lineNum">     545 </span>                :<span class="lineNoCov">          0 :                     m_max_addr_processed_length, // variable spacing</span></a>
<a name="546"><span class="lineNum">     546 </span>                :<span class="lineNoCov">          0 :                     peer.addr_processed ? ToString(peer.addr_processed) : peer.is_addr_relay_enabled ? &quot;&quot; : &quot;.&quot;,</span></a>
<a name="547"><span class="lineNum">     547 </span>                :<span class="lineNoCov">          0 :                     m_max_addr_rate_limited_length, // variable spacing</span></a>
<a name="548"><span class="lineNum">     548 </span>                :<span class="lineNoCov">          0 :                     peer.addr_rate_limited ? ToString(peer.addr_rate_limited) : &quot;&quot;,</span></a>
<a name="549"><span class="lineNum">     549 </span>                :<span class="lineNoCov">          0 :                     m_max_age_length, // variable spacing</span></a>
<a name="550"><span class="lineNum">     550 </span>                :<span class="lineNoCov">          0 :                     peer.age,</span></a>
<a name="551"><span class="lineNum">     551 </span>                :<span class="lineNoCov">          0 :                     m_is_asmap_on ? 7 : 0, // variable spacing</span></a>
<a name="552"><span class="lineNum">     552 </span>                :<span class="lineNoCov">          0 :                     m_is_asmap_on &amp;&amp; peer.mapped_as ? ToString(peer.mapped_as) : &quot;&quot;,</span></a>
<a name="553"><span class="lineNum">     553 </span>                :<span class="lineNoCov">          0 :                     m_max_id_length, // variable spacing</span></a>
<a name="554"><span class="lineNum">     554 </span>                :<span class="lineNoCov">          0 :                     peer.id,</span></a>
<a name="555"><span class="lineNum">     555 </span>                :<span class="lineNoCov">          0 :                     IsAddressSelected() ? m_max_addr_length : 0, // variable spacing</span></a>
<a name="556"><span class="lineNum">     556 </span>                :<span class="lineNoCov">          0 :                     IsAddressSelected() ? peer.addr : &quot;&quot;,</span></a>
<a name="557"><span class="lineNum">     557 </span>                :<span class="lineNoCov">          0 :                     IsVersionSelected() &amp;&amp; version != &quot;0&quot; ? version : &quot;&quot;);</span></a>
<a name="558"><span class="lineNum">     558 </span>                :            :             }</a>
<a name="559"><span class="lineNum">     559 </span>                :<span class="lineNoCov">          0 :             result += strprintf(&quot;                     ms     ms  sec  sec  min  min                %*s\n\n&quot;, m_max_age_length, &quot;min&quot;);</span></a>
<a name="560"><span class="lineNum">     560 </span>                :            :         }</a>
<a name="561"><span class="lineNum">     561 </span>                :            : </a>
<a name="562"><span class="lineNum">     562 </span>                :            :         // Report peer connection totals by type.</a>
<a name="563"><span class="lineNum">     563 </span>                :<span class="lineNoCov">          0 :         result += &quot;     &quot;;</span></a>
<a name="564"><span class="lineNum">     564 </span>                :<span class="lineNoCov">          0 :         std::vector&lt;int8_t&gt; reachable_networks;</span></a>
<a name="565"><span class="lineNum">     565 </span>                :<span class="lineNoCov">          0 :         for (const UniValue&amp; network : networkinfo[&quot;networks&quot;].getValues()) {</span></a>
<a name="566"><span class="lineNum">     566 </span>                :<span class="lineNoCov">          0 :             if (network[&quot;reachable&quot;].get_bool()) {</span></a>
<a name="567"><span class="lineNum">     567 </span>                :<span class="lineNoCov">          0 :                 const std::string&amp; network_name{network[&quot;name&quot;].get_str()};</span></a>
<a name="568"><span class="lineNum">     568 </span>                :<span class="lineNoCov">          0 :                 const int8_t network_id{NetworkStringToId(network_name)};</span></a>
<a name="569"><span class="lineNum">     569 </span>                :<span class="lineNoCov">          0 :                 if (network_id == UNKNOWN_NETWORK) continue;</span></a>
<a name="570"><span class="lineNum">     570 </span>                :<span class="lineNoCov">          0 :                 result += strprintf(&quot;%8s&quot;, network_name); // column header</span></a>
<a name="571"><span class="lineNum">     571 </span>                :<span class="lineNoCov">          0 :                 reachable_networks.push_back(network_id);</span></a>
<a name="572"><span class="lineNum">     572 </span>                :            :             }</a>
<a name="573"><span class="lineNum">     573 </span>                :            :         };</a>
<a name="574"><span class="lineNum">     574 </span>                :<span class="lineNoCov">          0 :         result += &quot;   total   block&quot;;</span></a>
<a name="575"><span class="lineNum">     575 </span>                :<span class="lineNoCov">          0 :         if (m_manual_peers_count) result += &quot;  manual&quot;;</span></a>
<a name="576"><span class="lineNum">     576 </span>                :            : </a>
<a name="577"><span class="lineNum">     577 </span>                :<span class="lineNoCov">          0 :         const std::array rows{&quot;in&quot;, &quot;out&quot;, &quot;total&quot;};</span></a>
<a name="578"><span class="lineNum">     578 </span>                :<span class="lineNoCov">          0 :         for (size_t i = 0; i &lt; rows.size(); ++i) {</span></a>
<a name="579"><span class="lineNum">     579 </span>                :<span class="lineNoCov">          0 :             result += strprintf(&quot;\n%-5s&quot;, rows[i]); // row header</span></a>
<a name="580"><span class="lineNum">     580 </span>                :<span class="lineNoCov">          0 :             for (int8_t n : reachable_networks) {</span></a>
<a name="581"><span class="lineNum">     581 </span>                :<span class="lineNoCov">          0 :                 result += strprintf(&quot;%8i&quot;, m_counts.at(i).at(n)); // network peers count</span></a>
<a name="582"><span class="lineNum">     582 </span>                :            :             }</a>
<a name="583"><span class="lineNum">     583 </span>                :<span class="lineNoCov">          0 :             result += strprintf(&quot;   %5i&quot;, m_counts.at(i).at(NETWORKS.size())); // total peers count</span></a>
<a name="584"><span class="lineNum">     584 </span>                :<span class="lineNoCov">          0 :             if (i == 1) { // the outbound row has two extra columns for block relay and manual peer counts</span></a>
<a name="585"><span class="lineNum">     585 </span>                :<span class="lineNoCov">          0 :                 result += strprintf(&quot;   %5i&quot;, m_block_relay_peers_count);</span></a>
<a name="586"><span class="lineNum">     586 </span>                :<span class="lineNoCov">          0 :                 if (m_manual_peers_count) result += strprintf(&quot;   %5i&quot;, m_manual_peers_count);</span></a>
<a name="587"><span class="lineNum">     587 </span>                :            :             }</a>
<a name="588"><span class="lineNum">     588 </span>                :            :         }</a>
<a name="589"><span class="lineNum">     589 </span>                :            : </a>
<a name="590"><span class="lineNum">     590 </span>                :            :         // Report local addresses, ports, and scores.</a>
<a name="591"><span class="lineNum">     591 </span>                :<span class="lineNoCov">          0 :         result += &quot;\n\nLocal addresses&quot;;</span></a>
<a name="592"><span class="lineNum">     592 </span>                :<span class="lineNoCov">          0 :         const std::vector&lt;UniValue&gt;&amp; local_addrs{networkinfo[&quot;localaddresses&quot;].getValues()};</span></a>
<a name="593"><span class="lineNum">     593 </span>                :<span class="lineNoCov">          0 :         if (local_addrs.empty()) {</span></a>
<a name="594"><span class="lineNum">     594 </span>                :<span class="lineNoCov">          0 :             result += &quot;: n/a\n&quot;;</span></a>
<a name="595"><span class="lineNum">     595 </span>                :            :         } else {</a>
<a name="596"><span class="lineNum">     596 </span>                :<span class="lineNoCov">          0 :             size_t max_addr_size{0};</span></a>
<a name="597"><span class="lineNum">     597 </span>                :<span class="lineNoCov">          0 :             for (const UniValue&amp; addr : local_addrs) {</span></a>
<a name="598"><span class="lineNum">     598 </span>                :<span class="lineNoCov">          0 :                 max_addr_size = std::max(addr[&quot;address&quot;].get_str().length() + 1, max_addr_size);</span></a>
<a name="599"><span class="lineNum">     599 </span>                :            :             }</a>
<a name="600"><span class="lineNum">     600 </span>                :<span class="lineNoCov">          0 :             for (const UniValue&amp; addr : local_addrs) {</span></a>
<a name="601"><span class="lineNum">     601 </span>                :<span class="lineNoCov">          0 :                 result += strprintf(&quot;\n%-*s    port %6i    score %6i&quot;, max_addr_size, addr[&quot;address&quot;].get_str(), addr[&quot;port&quot;].getInt&lt;int&gt;(), addr[&quot;score&quot;].getInt&lt;int&gt;());</span></a>
<a name="602"><span class="lineNum">     602 </span>                :            :             }</a>
<a name="603"><span class="lineNum">     603 </span>                :            :         }</a>
<a name="604"><span class="lineNum">     604 </span>                :            : </a>
<a name="605"><span class="lineNum">     605 </span>                :<span class="lineNoCov">          0 :         return JSONRPCReplyObj(UniValue{result}, NullUniValue, 1);</span></a>
<a name="606"><span class="lineNum">     606 </span>                :            :     }</a>
<a name="607"><span class="lineNum">     607 </span>                :            : </a>
<a name="608"><span class="lineNum">     608 </span>                :            :     const std::string m_help_doc{</a>
<a name="609"><span class="lineNum">     609 </span>                :            :         &quot;-netinfo level|\&quot;help\&quot; \n\n&quot;</a>
<a name="610"><span class="lineNum">     610 </span>                :            :         &quot;Returns a network peer connections dashboard with information from the remote server.\n&quot;</a>
<a name="611"><span class="lineNum">     611 </span>                :            :         &quot;This human-readable interface will change regularly and is not intended to be a stable API.\n&quot;</a>
<a name="612"><span class="lineNum">     612 </span>                :            :         &quot;Under the hood, -netinfo fetches the data by calling getpeerinfo and getnetworkinfo.\n&quot;</a>
<a name="613"><span class="lineNum">     613 </span>                :            :         + strprintf(&quot;An optional integer argument from 0 to %d can be passed for different peers listings; %d to 255 are parsed as %d.\n&quot;, MAX_DETAIL_LEVEL, MAX_DETAIL_LEVEL, MAX_DETAIL_LEVEL) +</a>
<a name="614"><span class="lineNum">     614 </span>                :            :         &quot;Pass \&quot;help\&quot; to see this detailed help documentation.\n&quot;</a>
<a name="615"><span class="lineNum">     615 </span>                :            :         &quot;If more than one argument is passed, only the first one is read and parsed.\n&quot;</a>
<a name="616"><span class="lineNum">     616 </span>                :            :         &quot;Suggestion: use with the Linux watch(1) command for a live dashboard; see example below.\n\n&quot;</a>
<a name="617"><span class="lineNum">     617 </span>                :            :         &quot;Arguments:\n&quot;</a>
<a name="618"><span class="lineNum">     618 </span>                :            :         + strprintf(&quot;1. level (integer 0-%d, optional)  Specify the info level of the peers dashboard (default 0):\n&quot;, MAX_DETAIL_LEVEL) +</a>
<a name="619"><span class="lineNum">     619 </span>                :            :         &quot;                                  0 - Peer counts for each reachable network as well as for block relay peers\n&quot;</a>
<a name="620"><span class="lineNum">     620 </span>                :            :         &quot;                                      and manual peers, and the list of local addresses and ports\n&quot;</a>
<a name="621"><span class="lineNum">     621 </span>                :            :         &quot;                                  1 - Like 0 but preceded by a peers listing (without address and version columns)\n&quot;</a>
<a name="622"><span class="lineNum">     622 </span>                :            :         &quot;                                  2 - Like 1 but with an address column\n&quot;</a>
<a name="623"><span class="lineNum">     623 </span>                :            :         &quot;                                  3 - Like 1 but with a version column\n&quot;</a>
<a name="624"><span class="lineNum">     624 </span>                :            :         &quot;                                  4 - Like 1 but with both address and version columns\n&quot;</a>
<a name="625"><span class="lineNum">     625 </span>                :            :         &quot;2. help (string \&quot;help\&quot;, optional) Print this help documentation instead of the dashboard.\n\n&quot;</a>
<a name="626"><span class="lineNum">     626 </span>                :            :         &quot;Result:\n\n&quot;</a>
<a name="627"><span class="lineNum">     627 </span>                :            :         + strprintf(&quot;* The peers listing in levels 1-%d displays all of the peers sorted by direction and minimum ping time:\n\n&quot;, MAX_DETAIL_LEVEL) +</a>
<a name="628"><span class="lineNum">     628 </span>                :            :         &quot;  Column   Description\n&quot;</a>
<a name="629"><span class="lineNum">     629 </span>                :            :         &quot;  ------   -----------\n&quot;</a>
<a name="630"><span class="lineNum">     630 </span>                :            :         &quot;  &lt;-&gt;      Direction\n&quot;</a>
<a name="631"><span class="lineNum">     631 </span>                :            :         &quot;           \&quot;in\&quot;  - inbound connections are those initiated by the peer\n&quot;</a>
<a name="632"><span class="lineNum">     632 </span>                :            :         &quot;           \&quot;out\&quot; - outbound connections are those initiated by us\n&quot;</a>
<a name="633"><span class="lineNum">     633 </span>                :            :         &quot;  type     Type of peer connection\n&quot;</a>
<a name="634"><span class="lineNum">     634 </span>                :            :         &quot;           \&quot;full\&quot;   - full relay, the default\n&quot;</a>
<a name="635"><span class="lineNum">     635 </span>                :            :         &quot;           \&quot;block\&quot;  - block relay; like full relay but does not relay transactions or addresses\n&quot;</a>
<a name="636"><span class="lineNum">     636 </span>                :            :         &quot;           \&quot;manual\&quot; - peer we manually added using RPC addnode or the -addnode/-connect config options\n&quot;</a>
<a name="637"><span class="lineNum">     637 </span>                :            :         &quot;           \&quot;feeler\&quot; - short-lived connection for testing addresses\n&quot;</a>
<a name="638"><span class="lineNum">     638 </span>                :            :         &quot;           \&quot;addr\&quot;   - address fetch; short-lived connection for requesting addresses\n&quot;</a>
<a name="639"><span class="lineNum">     639 </span>                :            :         &quot;  net      Network the peer connected through (\&quot;ipv4\&quot;, \&quot;ipv6\&quot;, \&quot;onion\&quot;, \&quot;i2p\&quot;, or \&quot;cjdns\&quot;)\n&quot;</a>
<a name="640"><span class="lineNum">     640 </span>                :            :         &quot;  mping    Minimum observed ping time, in milliseconds (ms)\n&quot;</a>
<a name="641"><span class="lineNum">     641 </span>                :            :         &quot;  ping     Last observed ping time, in milliseconds (ms)\n&quot;</a>
<a name="642"><span class="lineNum">     642 </span>                :            :         &quot;  send     Time since last message sent to the peer, in seconds\n&quot;</a>
<a name="643"><span class="lineNum">     643 </span>                :            :         &quot;  recv     Time since last message received from the peer, in seconds\n&quot;</a>
<a name="644"><span class="lineNum">     644 </span>                :            :         &quot;  txn      Time since last novel transaction received from the peer and accepted into our mempool, in minutes\n&quot;</a>
<a name="645"><span class="lineNum">     645 </span>                :            :         &quot;           \&quot;*\&quot; - the peer requested we not relay transactions to it (relaytxes is false)\n&quot;</a>
<a name="646"><span class="lineNum">     646 </span>                :            :         &quot;  blk      Time since last novel block passing initial validity checks received from the peer, in minutes\n&quot;</a>
<a name="647"><span class="lineNum">     647 </span>                :            :         &quot;  hb       High-bandwidth BIP152 compact block relay\n&quot;</a>
<a name="648"><span class="lineNum">     648 </span>                :            :         &quot;           \&quot;.\&quot; (to)   - we selected the peer as a high-bandwidth peer\n&quot;</a>
<a name="649"><span class="lineNum">     649 </span>                :            :         &quot;           \&quot;*\&quot; (from) - the peer selected us as a high-bandwidth peer\n&quot;</a>
<a name="650"><span class="lineNum">     650 </span>                :            :         &quot;  addrp    Total number of addresses processed, excluding those dropped due to rate limiting\n&quot;</a>
<a name="651"><span class="lineNum">     651 </span>                :            :         &quot;           \&quot;.\&quot; - we do not relay addresses to this peer (addr_relay_enabled is false)\n&quot;</a>
<a name="652"><span class="lineNum">     652 </span>                :            :         &quot;  addrl    Total number of addresses dropped due to rate limiting\n&quot;</a>
<a name="653"><span class="lineNum">     653 </span>                :            :         &quot;  age      Duration of connection to the peer, in minutes\n&quot;</a>
<a name="654"><span class="lineNum">     654 </span>                :            :         &quot;  asmap    Mapped AS (Autonomous System) number in the BGP route to the peer, used for diversifying\n&quot;</a>
<a name="655"><span class="lineNum">     655 </span>                :            :         &quot;           peer selection (only displayed if the -asmap config option is set)\n&quot;</a>
<a name="656"><span class="lineNum">     656 </span>                :            :         &quot;  id       Peer index, in increasing order of peer connections since node startup\n&quot;</a>
<a name="657"><span class="lineNum">     657 </span>                :            :         &quot;  address  IP address and port of the peer\n&quot;</a>
<a name="658"><span class="lineNum">     658 </span>                :            :         &quot;  version  Peer version and subversion concatenated, e.g. \&quot;70016/Satoshi:21.0.0/\&quot;\n\n&quot;</a>
<a name="659"><span class="lineNum">     659 </span>                :            :         &quot;* The peer counts table displays the number of peers for each reachable network as well as\n&quot;</a>
<a name="660"><span class="lineNum">     660 </span>                :            :         &quot;  the number of block relay peers and manual peers.\n\n&quot;</a>
<a name="661"><span class="lineNum">     661 </span>                :            :         &quot;* The local addresses table lists each local address broadcast by the node, the port, and the score.\n\n&quot;</a>
<a name="662"><span class="lineNum">     662 </span>                :            :         &quot;Examples:\n\n&quot;</a>
<a name="663"><span class="lineNum">     663 </span>                :            :         &quot;Peer counts table of reachable networks and list of local addresses\n&quot;</a>
<a name="664"><span class="lineNum">     664 </span>                :            :         &quot;&gt; bitcoin-cli -netinfo\n\n&quot;</a>
<a name="665"><span class="lineNum">     665 </span>                :            :         &quot;The same, preceded by a peers listing without address and version columns\n&quot;</a>
<a name="666"><span class="lineNum">     666 </span>                :            :         &quot;&gt; bitcoin-cli -netinfo 1\n\n&quot;</a>
<a name="667"><span class="lineNum">     667 </span>                :            :         &quot;Full dashboard\n&quot;</a>
<a name="668"><span class="lineNum">     668 </span>                :            :         + strprintf(&quot;&gt; bitcoin-cli -netinfo %d\n\n&quot;, MAX_DETAIL_LEVEL) +</a>
<a name="669"><span class="lineNum">     669 </span>                :            :         &quot;Full live dashboard, adjust --interval or --no-title as needed (Linux)\n&quot;</a>
<a name="670"><span class="lineNum">     670 </span>                :            :         + strprintf(&quot;&gt; watch --interval 1 --no-title bitcoin-cli -netinfo %d\n\n&quot;, MAX_DETAIL_LEVEL) +</a>
<a name="671"><span class="lineNum">     671 </span>                :            :         &quot;See this help\n&quot;</a>
<a name="672"><span class="lineNum">     672 </span>                :            :         &quot;&gt; bitcoin-cli -netinfo help\n&quot;};</a>
<a name="673"><span class="lineNum">     673 </span>                :            : };</a>
<a name="674"><span class="lineNum">     674 </span>                :            : </a>
<a name="675"><span class="lineNum">     675 </span>                :            : /** Process RPC generatetoaddress request. */</a>
<a name="676"><span class="lineNum">     676 </span>                :            : class GenerateToAddressRequestHandler : public BaseRequestHandler</a>
<a name="677"><span class="lineNum">     677 </span>                :            : {</a>
<a name="678"><span class="lineNum">     678 </span>                :            : public:</a>
<a name="679"><span class="lineNum">     679 </span>                :<span class="lineNoCov">          0 :     UniValue PrepareRequest(const std::string&amp; method, const std::vector&lt;std::string&gt;&amp; args) override</span></a>
<a name="680"><span class="lineNum">     680 </span>                :            :     {</a>
<a name="681"><span class="lineNum">     681 </span>                :<span class="lineNoCov">          0 :         address_str = args.at(1);</span></a>
<a name="682"><span class="lineNum">     682 </span>                :<span class="lineNoCov">          0 :         UniValue params{RPCConvertValues(&quot;generatetoaddress&quot;, args)};</span></a>
<a name="683"><span class="lineNum">     683 </span>                :<span class="lineNoCov">          0 :         return JSONRPCRequestObj(&quot;generatetoaddress&quot;, params, 1);</span></a>
<a name="684"><span class="lineNum">     684 </span>                :            :     }</a>
<a name="685"><span class="lineNum">     685 </span>                :            : </a>
<a name="686"><span class="lineNum">     686 </span>                :<span class="lineNoCov">          0 :     UniValue ProcessReply(const UniValue &amp;reply) override</span></a>
<a name="687"><span class="lineNum">     687 </span>                :            :     {</a>
<a name="688"><span class="lineNum">     688 </span>                :<span class="lineNoCov">          0 :         UniValue result(UniValue::VOBJ);</span></a>
<a name="689"><span class="lineNum">     689 </span>                :<span class="lineNoCov">          0 :         result.pushKV(&quot;address&quot;, address_str);</span></a>
<a name="690"><span class="lineNum">     690 </span>                :<span class="lineNoCov">          0 :         result.pushKV(&quot;blocks&quot;, reply.get_obj()[&quot;result&quot;]);</span></a>
<a name="691"><span class="lineNum">     691 </span>                :<span class="lineNoCov">          0 :         return JSONRPCReplyObj(result, NullUniValue, 1);</span></a>
<a name="692"><span class="lineNum">     692 </span>                :            :     }</a>
<a name="693"><span class="lineNum">     693 </span>                :            : protected:</a>
<a name="694"><span class="lineNum">     694 </span>                :            :     std::string address_str;</a>
<a name="695"><span class="lineNum">     695 </span>                :            : };</a>
<a name="696"><span class="lineNum">     696 </span>                :            : </a>
<a name="697"><span class="lineNum">     697 </span>                :            : /** Process default single requests */</a>
<a name="698"><span class="lineNum">     698 </span>                :            : class DefaultRequestHandler: public BaseRequestHandler {</a>
<a name="699"><span class="lineNum">     699 </span>                :            : public:</a>
<a name="700"><span class="lineNum">     700 </span>                :<span class="lineNoCov">          0 :     UniValue PrepareRequest(const std::string&amp; method, const std::vector&lt;std::string&gt;&amp; args) override</span></a>
<a name="701"><span class="lineNum">     701 </span>                :            :     {</a>
<a name="702"><span class="lineNum">     702 </span>                :<span class="lineNoCov">          0 :         UniValue params;</span></a>
<a name="703"><span class="lineNum">     703 </span>                :<span class="lineNoCov">          0 :         if(gArgs.GetBoolArg(&quot;-named&quot;, DEFAULT_NAMED)) {</span></a>
<a name="704"><span class="lineNum">     704 </span>                :<span class="lineNoCov">          0 :             params = RPCConvertNamedValues(method, args);</span></a>
<a name="705"><span class="lineNum">     705 </span>                :            :         } else {</a>
<a name="706"><span class="lineNum">     706 </span>                :<span class="lineNoCov">          0 :             params = RPCConvertValues(method, args);</span></a>
<a name="707"><span class="lineNum">     707 </span>                :            :         }</a>
<a name="708"><span class="lineNum">     708 </span>                :<span class="lineNoCov">          0 :         return JSONRPCRequestObj(method, params, 1);</span></a>
<a name="709"><span class="lineNum">     709 </span>                :            :     }</a>
<a name="710"><span class="lineNum">     710 </span>                :            : </a>
<a name="711"><span class="lineNum">     711 </span>                :<span class="lineNoCov">          0 :     UniValue ProcessReply(const UniValue &amp;reply) override</span></a>
<a name="712"><span class="lineNum">     712 </span>                :            :     {</a>
<a name="713"><span class="lineNum">     713 </span>                :<span class="lineNoCov">          0 :         return reply.get_obj();</span></a>
<a name="714"><span class="lineNum">     714 </span>                :            :     }</a>
<a name="715"><span class="lineNum">     715 </span>                :            : };</a>
<a name="716"><span class="lineNum">     716 </span>                :            : </a>
<a name="717"><span class="lineNum">     717 </span>                :<span class="lineNoCov">          0 : static UniValue CallRPC(BaseRequestHandler* rh, const std::string&amp; strMethod, const std::vector&lt;std::string&gt;&amp; args, const std::optional&lt;std::string&gt;&amp; rpcwallet = {})</span></a>
<a name="718"><span class="lineNum">     718 </span>                :            : {</a>
<a name="719"><span class="lineNum">     719 </span>                :<span class="lineNoCov">          0 :     std::string host;</span></a>
<a name="720"><span class="lineNum">     720 </span>                :            :     // In preference order, we choose the following for the port:</a>
<a name="721"><span class="lineNum">     721 </span>                :            :     //     1. -rpcport</a>
<a name="722"><span class="lineNum">     722 </span>                :            :     //     2. port in -rpcconnect (ie following : in ipv4 or ]: in ipv6)</a>
<a name="723"><span class="lineNum">     723 </span>                :            :     //     3. default port for chain</a>
<a name="724"><span class="lineNum">     724 </span>                :<span class="lineNoCov">          0 :     uint16_t port{BaseParams().RPCPort()};</span></a>
<a name="725"><span class="lineNum">     725 </span>                :<span class="lineNoCov">          0 :     SplitHostPort(gArgs.GetArg(&quot;-rpcconnect&quot;, DEFAULT_RPCCONNECT), port, host);</span></a>
<a name="726"><span class="lineNum">     726 </span>                :<span class="lineNoCov">          0 :     port = static_cast&lt;uint16_t&gt;(gArgs.GetIntArg(&quot;-rpcport&quot;, port));</span></a>
<a name="727"><span class="lineNum">     727 </span>                :            : </a>
<a name="728"><span class="lineNum">     728 </span>                :            :     // Obtain event base</a>
<a name="729"><span class="lineNum">     729 </span>                :<span class="lineNoCov">          0 :     raii_event_base base = obtain_event_base();</span></a>
<a name="730"><span class="lineNum">     730 </span>                :            : </a>
<a name="731"><span class="lineNum">     731 </span>                :            :     // Synchronously look up hostname</a>
<a name="732"><span class="lineNum">     732 </span>                :<span class="lineNoCov">          0 :     raii_evhttp_connection evcon = obtain_evhttp_connection_base(base.get(), host, port);</span></a>
<a name="733"><span class="lineNum">     733 </span>                :            : </a>
<a name="734"><span class="lineNum">     734 </span>                :            :     // Set connection timeout</a>
<a name="735"><span class="lineNum">     735 </span>                :            :     {</a>
<a name="736"><span class="lineNum">     736 </span>                :<span class="lineNoCov">          0 :         const int timeout = gArgs.GetIntArg(&quot;-rpcclienttimeout&quot;, DEFAULT_HTTP_CLIENT_TIMEOUT);</span></a>
<a name="737"><span class="lineNum">     737 </span>                :<span class="lineNoCov">          0 :         if (timeout &gt; 0) {</span></a>
<a name="738"><span class="lineNum">     738 </span>                :<span class="lineNoCov">          0 :             evhttp_connection_set_timeout(evcon.get(), timeout);</span></a>
<a name="739"><span class="lineNum">     739 </span>                :            :         } else {</a>
<a name="740"><span class="lineNum">     740 </span>                :            :             // Indefinite request timeouts are not possible in libevent-http, so we</a>
<a name="741"><span class="lineNum">     741 </span>                :            :             // set the timeout to a very long time period instead.</a>
<a name="742"><span class="lineNum">     742 </span>                :            : </a>
<a name="743"><span class="lineNum">     743 </span>                :<span class="lineNoCov">          0 :             constexpr int YEAR_IN_SECONDS = 31556952; // Average length of year in Gregorian calendar</span></a>
<a name="744"><span class="lineNum">     744 </span>                :<span class="lineNoCov">          0 :             evhttp_connection_set_timeout(evcon.get(), 5 * YEAR_IN_SECONDS);</span></a>
<a name="745"><span class="lineNum">     745 </span>                :            :         }</a>
<a name="746"><span class="lineNum">     746 </span>                :            :     }</a>
<a name="747"><span class="lineNum">     747 </span>                :            : </a>
<a name="748"><span class="lineNum">     748 </span>                :<span class="lineNoCov">          0 :     HTTPReply response;</span></a>
<a name="749"><span class="lineNum">     749 </span>                :<span class="lineNoCov">          0 :     raii_evhttp_request req = obtain_evhttp_request(http_request_done, (void*)&amp;response);</span></a>
<a name="750"><span class="lineNum">     750 </span>                :<span class="lineNoCov">          0 :     if (req == nullptr) {</span></a>
<a name="751"><span class="lineNum">     751 </span>                :<span class="lineNoCov">          0 :         throw std::runtime_error(&quot;create http request failed&quot;);</span></a>
<a name="752"><span class="lineNum">     752 </span>                :            :     }</a>
<a name="753"><span class="lineNum">     753 </span>                :            : </a>
<a name="754"><span class="lineNum">     754 </span>                :<span class="lineNoCov">          0 :     evhttp_request_set_error_cb(req.get(), http_error_cb);</span></a>
<a name="755"><span class="lineNum">     755 </span>                :            : </a>
<a name="756"><span class="lineNum">     756 </span>                :            :     // Get credentials</a>
<a name="757"><span class="lineNum">     757 </span>                :<span class="lineNoCov">          0 :     std::string strRPCUserColonPass;</span></a>
<a name="758"><span class="lineNum">     758 </span>                :<span class="lineNoCov">          0 :     bool failedToGetAuthCookie = false;</span></a>
<a name="759"><span class="lineNum">     759 </span>                :<span class="lineNoCov">          0 :     if (gArgs.GetArg(&quot;-rpcpassword&quot;, &quot;&quot;) == &quot;&quot;) {</span></a>
<a name="760"><span class="lineNum">     760 </span>                :            :         // Try fall back to cookie-based authentication if no password is provided</a>
<a name="761"><span class="lineNum">     761 </span>                :<span class="lineNoCov">          0 :         if (!GetAuthCookie(&amp;strRPCUserColonPass)) {</span></a>
<a name="762"><span class="lineNum">     762 </span>                :<span class="lineNoCov">          0 :             failedToGetAuthCookie = true;</span></a>
<a name="763"><span class="lineNum">     763 </span>                :            :         }</a>
<a name="764"><span class="lineNum">     764 </span>                :            :     } else {</a>
<a name="765"><span class="lineNum">     765 </span>                :<span class="lineNoCov">          0 :         strRPCUserColonPass = gArgs.GetArg(&quot;-rpcuser&quot;, &quot;&quot;) + &quot;:&quot; + gArgs.GetArg(&quot;-rpcpassword&quot;, &quot;&quot;);</span></a>
<a name="766"><span class="lineNum">     766 </span>                :            :     }</a>
<a name="767"><span class="lineNum">     767 </span>                :            : </a>
<a name="768"><span class="lineNum">     768 </span>                :<span class="lineNoCov">          0 :     struct evkeyvalq* output_headers = evhttp_request_get_output_headers(req.get());</span></a>
<a name="769"><span class="lineNum">     769 </span>                :<span class="lineNoCov">          0 :     assert(output_headers);</span></a>
<a name="770"><span class="lineNum">     770 </span>                :<span class="lineNoCov">          0 :     evhttp_add_header(output_headers, &quot;Host&quot;, host.c_str());</span></a>
<a name="771"><span class="lineNum">     771 </span>                :<span class="lineNoCov">          0 :     evhttp_add_header(output_headers, &quot;Connection&quot;, &quot;close&quot;);</span></a>
<a name="772"><span class="lineNum">     772 </span>                :<span class="lineNoCov">          0 :     evhttp_add_header(output_headers, &quot;Content-Type&quot;, &quot;application/json&quot;);</span></a>
<a name="773"><span class="lineNum">     773 </span>                :<span class="lineNoCov">          0 :     evhttp_add_header(output_headers, &quot;Authorization&quot;, (std::string(&quot;Basic &quot;) + EncodeBase64(strRPCUserColonPass)).c_str());</span></a>
<a name="774"><span class="lineNum">     774 </span>                :            : </a>
<a name="775"><span class="lineNum">     775 </span>                :            :     // Attach request data</a>
<a name="776"><span class="lineNum">     776 </span>                :<span class="lineNoCov">          0 :     std::string strRequest = rh-&gt;PrepareRequest(strMethod, args).write() + &quot;\n&quot;;</span></a>
<a name="777"><span class="lineNum">     777 </span>                :<span class="lineNoCov">          0 :     struct evbuffer* output_buffer = evhttp_request_get_output_buffer(req.get());</span></a>
<a name="778"><span class="lineNum">     778 </span>                :<span class="lineNoCov">          0 :     assert(output_buffer);</span></a>
<a name="779"><span class="lineNum">     779 </span>                :<span class="lineNoCov">          0 :     evbuffer_add(output_buffer, strRequest.data(), strRequest.size());</span></a>
<a name="780"><span class="lineNum">     780 </span>                :            : </a>
<a name="781"><span class="lineNum">     781 </span>                :            :     // check if we should use a special wallet endpoint</a>
<a name="782"><span class="lineNum">     782 </span>                :<span class="lineNoCov">          0 :     std::string endpoint = &quot;/&quot;;</span></a>
<a name="783"><span class="lineNum">     783 </span>                :<span class="lineNoCov">          0 :     if (rpcwallet) {</span></a>
<a name="784"><span class="lineNum">     784 </span>                :<span class="lineNoCov">          0 :         char* encodedURI = evhttp_uriencode(rpcwallet-&gt;data(), rpcwallet-&gt;size(), false);</span></a>
<a name="785"><span class="lineNum">     785 </span>                :<span class="lineNoCov">          0 :         if (encodedURI) {</span></a>
<a name="786"><span class="lineNum">     786 </span>                :<span class="lineNoCov">          0 :             endpoint = &quot;/wallet/&quot; + std::string(encodedURI);</span></a>
<a name="787"><span class="lineNum">     787 </span>                :<span class="lineNoCov">          0 :             free(encodedURI);</span></a>
<a name="788"><span class="lineNum">     788 </span>                :            :         } else {</a>
<a name="789"><span class="lineNum">     789 </span>                :<span class="lineNoCov">          0 :             throw CConnectionFailed(&quot;uri-encode failed&quot;);</span></a>
<a name="790"><span class="lineNum">     790 </span>                :            :         }</a>
<a name="791"><span class="lineNum">     791 </span>                :            :     }</a>
<a name="792"><span class="lineNum">     792 </span>                :<span class="lineNoCov">          0 :     int r = evhttp_make_request(evcon.get(), req.get(), EVHTTP_REQ_POST, endpoint.c_str());</span></a>
<a name="793"><span class="lineNum">     793 </span>                :<span class="lineNoCov">          0 :     req.release(); // ownership moved to evcon in above call</span></a>
<a name="794"><span class="lineNum">     794 </span>                :<span class="lineNoCov">          0 :     if (r != 0) {</span></a>
<a name="795"><span class="lineNum">     795 </span>                :<span class="lineNoCov">          0 :         throw CConnectionFailed(&quot;send http request failed&quot;);</span></a>
<a name="796"><span class="lineNum">     796 </span>                :            :     }</a>
<a name="797"><span class="lineNum">     797 </span>                :            : </a>
<a name="798"><span class="lineNum">     798 </span>                :<span class="lineNoCov">          0 :     event_base_dispatch(base.get());</span></a>
<a name="799"><span class="lineNum">     799 </span>                :            : </a>
<a name="800"><span class="lineNum">     800 </span>                :<span class="lineNoCov">          0 :     if (response.status == 0) {</span></a>
<a name="801"><span class="lineNum">     801 </span>                :<span class="lineNoCov">          0 :         std::string responseErrorMessage;</span></a>
<a name="802"><span class="lineNum">     802 </span>                :<span class="lineNoCov">          0 :         if (response.error != -1) {</span></a>
<a name="803"><span class="lineNum">     803 </span>                :<span class="lineNoCov">          0 :             responseErrorMessage = strprintf(&quot; (error code %d - \&quot;%s\&quot;)&quot;, response.error, http_errorstring(response.error));</span></a>
<a name="804"><span class="lineNum">     804 </span>                :            :         }</a>
<a name="805"><span class="lineNum">     805 </span>                :<span class="lineNoCov">          0 :         throw CConnectionFailed(strprintf(&quot;Could not connect to the server %s:%d%s\n\nMake sure the bitcoind server is running and that you are connecting to the correct RPC port.&quot;, host, port, responseErrorMessage));</span></a>
<a name="806"><span class="lineNum">     806 </span>                :<span class="lineNoCov">          0 :     } else if (response.status == HTTP_UNAUTHORIZED) {</span></a>
<a name="807"><span class="lineNum">     807 </span>                :<span class="lineNoCov">          0 :         if (failedToGetAuthCookie) {</span></a>
<a name="808"><span class="lineNum">     808 </span>                :<span class="lineNoCov">          0 :             throw std::runtime_error(strprintf(</span></a>
<a name="809"><span class="lineNum">     809 </span>                :            :                 &quot;Could not locate RPC credentials. No authentication cookie could be found, and RPC password is not set.  See -rpcpassword and -stdinrpcpass.  Configuration file: (%s)&quot;,</a>
<a name="810"><span class="lineNum">     810 </span>                :<span class="lineNoCov">          0 :                 fs::PathToString(GetConfigFile(gArgs.GetPathArg(&quot;-conf&quot;, BITCOIN_CONF_FILENAME)))));</span></a>
<a name="811"><span class="lineNum">     811 </span>                :            :         } else {</a>
<a name="812"><span class="lineNum">     812 </span>                :<span class="lineNoCov">          0 :             throw std::runtime_error(&quot;Authorization failed: Incorrect rpcuser or rpcpassword&quot;);</span></a>
<a name="813"><span class="lineNum">     813 </span>                :            :         }</a>
<a name="814"><span class="lineNum">     814 </span>                :<span class="lineNoCov">          0 :     } else if (response.status == HTTP_SERVICE_UNAVAILABLE) {</span></a>
<a name="815"><span class="lineNum">     815 </span>                :<span class="lineNoCov">          0 :         throw std::runtime_error(strprintf(&quot;Server response: %s&quot;, response.body));</span></a>
<a name="816"><span class="lineNum">     816 </span>                :<span class="lineNoCov">          0 :     } else if (response.status &gt;= 400 &amp;&amp; response.status != HTTP_BAD_REQUEST &amp;&amp; response.status != HTTP_NOT_FOUND &amp;&amp; response.status != HTTP_INTERNAL_SERVER_ERROR)</span></a>
<a name="817"><span class="lineNum">     817 </span>                :<span class="lineNoCov">          0 :         throw std::runtime_error(strprintf(&quot;server returned HTTP error %d&quot;, response.status));</span></a>
<a name="818"><span class="lineNum">     818 </span>                :<span class="lineNoCov">          0 :     else if (response.body.empty())</span></a>
<a name="819"><span class="lineNum">     819 </span>                :<span class="lineNoCov">          0 :         throw std::runtime_error(&quot;no response from server&quot;);</span></a>
<a name="820"><span class="lineNum">     820 </span>                :            : </a>
<a name="821"><span class="lineNum">     821 </span>                :            :     // Parse reply</a>
<a name="822"><span class="lineNum">     822 </span>                :<span class="lineNoCov">          0 :     UniValue valReply(UniValue::VSTR);</span></a>
<a name="823"><span class="lineNum">     823 </span>                :<span class="lineNoCov">          0 :     if (!valReply.read(response.body))</span></a>
<a name="824"><span class="lineNum">     824 </span>                :<span class="lineNoCov">          0 :         throw std::runtime_error(&quot;couldn't parse reply from server&quot;);</span></a>
<a name="825"><span class="lineNum">     825 </span>                :<span class="lineNoCov">          0 :     const UniValue reply = rh-&gt;ProcessReply(valReply);</span></a>
<a name="826"><span class="lineNum">     826 </span>                :<span class="lineNoCov">          0 :     if (reply.empty())</span></a>
<a name="827"><span class="lineNum">     827 </span>                :<span class="lineNoCov">          0 :         throw std::runtime_error(&quot;expected reply to have result, error and id properties&quot;);</span></a>
<a name="828"><span class="lineNum">     828 </span>                :            : </a>
<a name="829"><span class="lineNum">     829 </span>                :<span class="lineNoCov">          0 :     return reply;</span></a>
<a name="830"><span class="lineNum">     830 </span>                :            : }</a>
<a name="831"><span class="lineNum">     831 </span>                :            : </a>
<a name="832"><span class="lineNum">     832 </span>                :            : /**</a>
<a name="833"><span class="lineNum">     833 </span>                :            :  * ConnectAndCallRPC wraps CallRPC with -rpcwait and an exception handler.</a>
<a name="834"><span class="lineNum">     834 </span>                :            :  *</a>
<a name="835"><span class="lineNum">     835 </span>                :            :  * @param[in] rh         Pointer to RequestHandler.</a>
<a name="836"><span class="lineNum">     836 </span>                :            :  * @param[in] strMethod  Reference to const string method to forward to CallRPC.</a>
<a name="837"><span class="lineNum">     837 </span>                :            :  * @param[in] rpcwallet  Reference to const optional string wallet name to forward to CallRPC.</a>
<a name="838"><span class="lineNum">     838 </span>                :            :  * @returns the RPC response as a UniValue object.</a>
<a name="839"><span class="lineNum">     839 </span>                :            :  * @throws a CConnectionFailed std::runtime_error if connection failed or RPC server still in warmup.</a>
<a name="840"><span class="lineNum">     840 </span>                :            :  */</a>
<a name="841"><span class="lineNum">     841 </span>                :<span class="lineNoCov">          0 : static UniValue ConnectAndCallRPC(BaseRequestHandler* rh, const std::string&amp; strMethod, const std::vector&lt;std::string&gt;&amp; args, const std::optional&lt;std::string&gt;&amp; rpcwallet = {})</span></a>
<a name="842"><span class="lineNum">     842 </span>                :            : {</a>
<a name="843"><span class="lineNum">     843 </span>                :<span class="lineNoCov">          0 :     UniValue response(UniValue::VOBJ);</span></a>
<a name="844"><span class="lineNum">     844 </span>                :            :     // Execute and handle connection failures with -rpcwait.</a>
<a name="845"><span class="lineNum">     845 </span>                :<span class="lineNoCov">          0 :     const bool fWait = gArgs.GetBoolArg(&quot;-rpcwait&quot;, false);</span></a>
<a name="846"><span class="lineNum">     846 </span>                :<span class="lineNoCov">          0 :     const int timeout = gArgs.GetIntArg(&quot;-rpcwaittimeout&quot;, DEFAULT_WAIT_CLIENT_TIMEOUT);</span></a>
<a name="847"><span class="lineNum">     847 </span>                :<span class="lineNoCov">          0 :     const auto deadline{std::chrono::steady_clock::now() + 1s * timeout};</span></a>
<a name="848"><span class="lineNum">     848 </span>                :            : </a>
<a name="849"><span class="lineNum">     849 </span>                :<span class="lineNoCov">          0 :     do {</span></a>
<a name="850"><span class="lineNum">     850 </span>                :            :         try {</a>
<a name="851"><span class="lineNum">     851 </span>                :<span class="lineNoCov">          0 :             response = CallRPC(rh, strMethod, args, rpcwallet);</span></a>
<a name="852"><span class="lineNum">     852 </span>                :<span class="lineNoCov">          0 :             if (fWait) {</span></a>
<a name="853"><span class="lineNum">     853 </span>                :<span class="lineNoCov">          0 :                 const UniValue&amp; error = find_value(response, &quot;error&quot;);</span></a>
<a name="854"><span class="lineNum">     854 </span>                :<span class="lineNoCov">          0 :                 if (!error.isNull() &amp;&amp; error[&quot;code&quot;].getInt&lt;int&gt;() == RPC_IN_WARMUP) {</span></a>
<a name="855"><span class="lineNum">     855 </span>                :<span class="lineNoCov">          0 :                     throw CConnectionFailed(&quot;server in warmup&quot;);</span></a>
<a name="856"><span class="lineNum">     856 </span>                :            :                 }</a>
<a name="857"><span class="lineNum">     857 </span>                :            :             }</a>
<a name="858"><span class="lineNum">     858 </span>                :<span class="lineNoCov">          0 :             break; // Connection succeeded, no need to retry.</span></a>
<a name="859"><span class="lineNum">     859 </span>                :<span class="lineNoCov">          0 :         } catch (const CConnectionFailed&amp; e) {</span></a>
<a name="860"><span class="lineNum">     860 </span>                :<span class="lineNoCov">          0 :             if (fWait &amp;&amp; (timeout &lt;= 0 || std::chrono::steady_clock::now() &lt; deadline)) {</span></a>
<a name="861"><span class="lineNum">     861 </span>                :<span class="lineNoCov">          0 :                 UninterruptibleSleep(1s);</span></a>
<a name="862"><span class="lineNum">     862 </span>                :            :             } else {</a>
<a name="863"><span class="lineNum">     863 </span>                :<span class="lineNoCov">          0 :                 throw CConnectionFailed(strprintf(&quot;timeout on transient error: %s&quot;, e.what()));</span></a>
<a name="864"><span class="lineNum">     864 </span>                :            :             }</a>
<a name="865"><span class="lineNum">     865 </span>                :            :         }</a>
<a name="866"><span class="lineNum">     866 </span>                :<span class="lineNoCov">          0 :     } while (fWait);</span></a>
<a name="867"><span class="lineNum">     867 </span>                :<span class="lineNoCov">          0 :     return response;</span></a>
<a name="868"><span class="lineNum">     868 </span>                :            : }</a>
<a name="869"><span class="lineNum">     869 </span>                :            : </a>
<a name="870"><span class="lineNum">     870 </span>                :            : /** Parse UniValue result to update the message to print to std::cout. */</a>
<a name="871"><span class="lineNum">     871 </span>                :<span class="lineNoCov">          0 : static void ParseResult(const UniValue&amp; result, std::string&amp; strPrint)</span></a>
<a name="872"><span class="lineNum">     872 </span>                :            : {</a>
<a name="873"><span class="lineNum">     873 </span>                :<span class="lineNoCov">          0 :     if (result.isNull()) return;</span></a>
<a name="874"><span class="lineNum">     874 </span>                :<span class="lineNoCov">          0 :     strPrint = result.isStr() ? result.get_str() : result.write(2);</span></a>
<a name="875"><span class="lineNum">     875 </span>                :            : }</a>
<a name="876"><span class="lineNum">     876 </span>                :            : </a>
<a name="877"><span class="lineNum">     877 </span>                :            : /** Parse UniValue error to update the message to print to std::cerr and the code to return. */</a>
<a name="878"><span class="lineNum">     878 </span>                :<span class="lineNoCov">          0 : static void ParseError(const UniValue&amp; error, std::string&amp; strPrint, int&amp; nRet)</span></a>
<a name="879"><span class="lineNum">     879 </span>                :            : {</a>
<a name="880"><span class="lineNum">     880 </span>                :<span class="lineNoCov">          0 :     if (error.isObject()) {</span></a>
<a name="881"><span class="lineNum">     881 </span>                :<span class="lineNoCov">          0 :         const UniValue&amp; err_code = find_value(error, &quot;code&quot;);</span></a>
<a name="882"><span class="lineNum">     882 </span>                :<span class="lineNoCov">          0 :         const UniValue&amp; err_msg = find_value(error, &quot;message&quot;);</span></a>
<a name="883"><span class="lineNum">     883 </span>                :<span class="lineNoCov">          0 :         if (!err_code.isNull()) {</span></a>
<a name="884"><span class="lineNum">     884 </span>                :<span class="lineNoCov">          0 :             strPrint = &quot;error code: &quot; + err_code.getValStr() + &quot;\n&quot;;</span></a>
<a name="885"><span class="lineNum">     885 </span>                :            :         }</a>
<a name="886"><span class="lineNum">     886 </span>                :<span class="lineNoCov">          0 :         if (err_msg.isStr()) {</span></a>
<a name="887"><span class="lineNum">     887 </span>                :<span class="lineNoCov">          0 :             strPrint += (&quot;error message:\n&quot; + err_msg.get_str());</span></a>
<a name="888"><span class="lineNum">     888 </span>                :            :         }</a>
<a name="889"><span class="lineNum">     889 </span>                :<span class="lineNoCov">          0 :         if (err_code.isNum() &amp;&amp; err_code.getInt&lt;int&gt;() == RPC_WALLET_NOT_SPECIFIED) {</span></a>
<a name="890"><span class="lineNum">     890 </span>                :<span class="lineNoCov">          0 :             strPrint += &quot;\nTry adding \&quot;-rpcwallet=&lt;filename&gt;\&quot; option to bitcoin-cli command line.&quot;;</span></a>
<a name="891"><span class="lineNum">     891 </span>                :            :         }</a>
<a name="892"><span class="lineNum">     892 </span>                :            :     } else {</a>
<a name="893"><span class="lineNum">     893 </span>                :<span class="lineNoCov">          0 :         strPrint = &quot;error: &quot; + error.write();</span></a>
<a name="894"><span class="lineNum">     894 </span>                :            :     }</a>
<a name="895"><span class="lineNum">     895 </span>                :<span class="lineNoCov">          0 :     nRet = abs(error[&quot;code&quot;].getInt&lt;int&gt;());</span></a>
<a name="896"><span class="lineNum">     896 </span>                :<span class="lineNoCov">          0 : }</span></a>
<a name="897"><span class="lineNum">     897 </span>                :            : </a>
<a name="898"><span class="lineNum">     898 </span>                :            : /**</a>
<a name="899"><span class="lineNum">     899 </span>                :            :  * GetWalletBalances calls listwallets; if more than one wallet is loaded, it then</a>
<a name="900"><span class="lineNum">     900 </span>                :            :  * fetches mine.trusted balances for each loaded wallet and pushes them to `result`.</a>
<a name="901"><span class="lineNum">     901 </span>                :            :  *</a>
<a name="902"><span class="lineNum">     902 </span>                :            :  * @param result  Reference to UniValue object the wallet names and balances are pushed to.</a>
<a name="903"><span class="lineNum">     903 </span>                :            :  */</a>
<a name="904"><span class="lineNum">     904 </span>                :<span class="lineNoCov">          0 : static void GetWalletBalances(UniValue&amp; result)</span></a>
<a name="905"><span class="lineNum">     905 </span>                :            : {</a>
<a name="906"><span class="lineNum">     906 </span>                :<span class="lineNoCov">          0 :     DefaultRequestHandler rh;</span></a>
<a name="907"><span class="lineNum">     907 </span>                :<span class="lineNoCov">          0 :     const UniValue listwallets = ConnectAndCallRPC(&amp;rh, &quot;listwallets&quot;, /* args=*/{});</span></a>
<a name="908"><span class="lineNum">     908 </span>                :<span class="lineNoCov">          0 :     if (!find_value(listwallets, &quot;error&quot;).isNull()) return;</span></a>
<a name="909"><span class="lineNum">     909 </span>                :<span class="lineNoCov">          0 :     const UniValue&amp; wallets = find_value(listwallets, &quot;result&quot;);</span></a>
<a name="910"><span class="lineNum">     910 </span>                :<span class="lineNoCov">          0 :     if (wallets.size() &lt;= 1) return;</span></a>
<a name="911"><span class="lineNum">     911 </span>                :            : </a>
<a name="912"><span class="lineNum">     912 </span>                :<span class="lineNoCov">          0 :     UniValue balances(UniValue::VOBJ);</span></a>
<a name="913"><span class="lineNum">     913 </span>                :<span class="lineNoCov">          0 :     for (const UniValue&amp; wallet : wallets.getValues()) {</span></a>
<a name="914"><span class="lineNum">     914 </span>                :<span class="lineNoCov">          0 :         const std::string&amp; wallet_name = wallet.get_str();</span></a>
<a name="915"><span class="lineNum">     915 </span>                :<span class="lineNoCov">          0 :         const UniValue getbalances = ConnectAndCallRPC(&amp;rh, &quot;getbalances&quot;, /* args=*/{}, wallet_name);</span></a>
<a name="916"><span class="lineNum">     916 </span>                :<span class="lineNoCov">          0 :         const UniValue&amp; balance = find_value(getbalances, &quot;result&quot;)[&quot;mine&quot;][&quot;trusted&quot;];</span></a>
<a name="917"><span class="lineNum">     917 </span>                :<span class="lineNoCov">          0 :         balances.pushKV(wallet_name, balance);</span></a>
<a name="918"><span class="lineNum">     918 </span>                :            :     }</a>
<a name="919"><span class="lineNum">     919 </span>                :<span class="lineNoCov">          0 :     result.pushKV(&quot;balances&quot;, balances);</span></a>
<a name="920"><span class="lineNum">     920 </span>                :            : }</a>
<a name="921"><span class="lineNum">     921 </span>                :            : </a>
<a name="922"><span class="lineNum">     922 </span>                :            : /**</a>
<a name="923"><span class="lineNum">     923 </span>                :            :  * GetProgressBar constructs a progress bar with 5% intervals.</a>
<a name="924"><span class="lineNum">     924 </span>                :            :  *</a>
<a name="925"><span class="lineNum">     925 </span>                :            :  * @param[in]   progress      The proportion of the progress bar to be filled between 0 and 1.</a>
<a name="926"><span class="lineNum">     926 </span>                :            :  * @param[out]  progress_bar  String representation of the progress bar.</a>
<a name="927"><span class="lineNum">     927 </span>                :            :  */</a>
<a name="928"><span class="lineNum">     928 </span>                :<span class="lineNoCov">          0 : static void GetProgressBar(double progress, std::string&amp; progress_bar)</span></a>
<a name="929"><span class="lineNum">     929 </span>                :            : {</a>
<a name="930"><span class="lineNum">     930 </span>                :<span class="lineNoCov">          0 :     if (progress &lt; 0 || progress &gt; 1) return;</span></a>
<a name="931"><span class="lineNum">     931 </span>                :            : </a>
<a name="932"><span class="lineNum">     932 </span>                :            :     static constexpr double INCREMENT{0.05};</a>
<a name="933"><span class="lineNum">     933 </span>                :<span class="lineNoCov">          0 :     static const std::string COMPLETE_BAR{&quot;\u2592&quot;};</span></a>
<a name="934"><span class="lineNum">     934 </span>                :<span class="lineNoCov">          0 :     static const std::string INCOMPLETE_BAR{&quot;\u2591&quot;};</span></a>
<a name="935"><span class="lineNum">     935 </span>                :            : </a>
<a name="936"><span class="lineNum">     936 </span>                :<span class="lineNoCov">          0 :     for (int i = 0; i &lt; progress / INCREMENT; ++i) {</span></a>
<a name="937"><span class="lineNum">     937 </span>                :<span class="lineNoCov">          0 :         progress_bar += COMPLETE_BAR;</span></a>
<a name="938"><span class="lineNum">     938 </span>                :            :     }</a>
<a name="939"><span class="lineNum">     939 </span>                :            : </a>
<a name="940"><span class="lineNum">     940 </span>                :<span class="lineNoCov">          0 :     for (int i = 0; i &lt; (1 - progress) / INCREMENT; ++i) {</span></a>
<a name="941"><span class="lineNum">     941 </span>                :<span class="lineNoCov">          0 :         progress_bar += INCOMPLETE_BAR;</span></a>
<a name="942"><span class="lineNum">     942 </span>                :            :     }</a>
<a name="943"><span class="lineNum">     943 </span>                :            : }</a>
<a name="944"><span class="lineNum">     944 </span>                :            : </a>
<a name="945"><span class="lineNum">     945 </span>                :            : /**</a>
<a name="946"><span class="lineNum">     946 </span>                :            :  * ParseGetInfoResult takes in -getinfo result in UniValue object and parses it</a>
<a name="947"><span class="lineNum">     947 </span>                :            :  * into a user friendly UniValue string to be printed on the console.</a>
<a name="948"><span class="lineNum">     948 </span>                :            :  * @param[out] result  Reference to UniValue result containing the -getinfo output.</a>
<a name="949"><span class="lineNum">     949 </span>                :            :  */</a>
<a name="950"><span class="lineNum">     950 </span>                :<span class="lineNoCov">          0 : static void ParseGetInfoResult(UniValue&amp; result)</span></a>
<a name="951"><span class="lineNum">     951 </span>                :            : {</a>
<a name="952"><span class="lineNum">     952 </span>                :<span class="lineNoCov">          0 :     if (!find_value(result, &quot;error&quot;).isNull()) return;</span></a>
<a name="953"><span class="lineNum">     953 </span>                :            : </a>
<a name="954"><span class="lineNum">     954 </span>                :<span class="lineNoCov">          0 :     std::string RESET, GREEN, BLUE, YELLOW, MAGENTA, CYAN;</span></a>
<a name="955"><span class="lineNum">     955 </span>                :<span class="lineNoCov">          0 :     bool should_colorize = false;</span></a>
<a name="956"><span class="lineNum">     956 </span>                :            : </a>
<a name="957"><span class="lineNum">     957 </span>                :            : #ifndef WIN32</a>
<a name="958"><span class="lineNum">     958 </span>                :<span class="lineNoCov">          0 :     if (isatty(fileno(stdout))) {</span></a>
<a name="959"><span class="lineNum">     959 </span>                :            :         // By default, only print colored text if OS is not WIN32 and stdout is connected to a terminal.</a>
<a name="960"><span class="lineNum">     960 </span>                :<span class="lineNoCov">          0 :         should_colorize = true;</span></a>
<a name="961"><span class="lineNum">     961 </span>                :            :     }</a>
<a name="962"><span class="lineNum">     962 </span>                :            : #endif</a>
<a name="963"><span class="lineNum">     963 </span>                :            : </a>
<a name="964"><span class="lineNum">     964 </span>                :<span class="lineNoCov">          0 :     if (gArgs.IsArgSet(&quot;-color&quot;)) {</span></a>
<a name="965"><span class="lineNum">     965 </span>                :<span class="lineNoCov">          0 :         const std::string color{gArgs.GetArg(&quot;-color&quot;, DEFAULT_COLOR_SETTING)};</span></a>
<a name="966"><span class="lineNum">     966 </span>                :<span class="lineNoCov">          0 :         if (color == &quot;always&quot;) {</span></a>
<a name="967"><span class="lineNum">     967 </span>                :<span class="lineNoCov">          0 :             should_colorize = true;</span></a>
<a name="968"><span class="lineNum">     968 </span>                :<span class="lineNoCov">          0 :         } else if (color == &quot;never&quot;) {</span></a>
<a name="969"><span class="lineNum">     969 </span>                :<span class="lineNoCov">          0 :             should_colorize = false;</span></a>
<a name="970"><span class="lineNum">     970 </span>                :<span class="lineNoCov">          0 :         } else if (color != &quot;auto&quot;) {</span></a>
<a name="971"><span class="lineNum">     971 </span>                :<span class="lineNoCov">          0 :             throw std::runtime_error(&quot;Invalid value for -color option. Valid values: always, auto, never.&quot;);</span></a>
<a name="972"><span class="lineNum">     972 </span>                :            :         }</a>
<a name="973"><span class="lineNum">     973 </span>                :            :     }</a>
<a name="974"><span class="lineNum">     974 </span>                :            : </a>
<a name="975"><span class="lineNum">     975 </span>                :<span class="lineNoCov">          0 :     if (should_colorize) {</span></a>
<a name="976"><span class="lineNum">     976 </span>                :<span class="lineNoCov">          0 :         RESET = &quot;\x1B[0m&quot;;</span></a>
<a name="977"><span class="lineNum">     977 </span>                :<span class="lineNoCov">          0 :         GREEN = &quot;\x1B[32m&quot;;</span></a>
<a name="978"><span class="lineNum">     978 </span>                :<span class="lineNoCov">          0 :         BLUE = &quot;\x1B[34m&quot;;</span></a>
<a name="979"><span class="lineNum">     979 </span>                :<span class="lineNoCov">          0 :         YELLOW = &quot;\x1B[33m&quot;;</span></a>
<a name="980"><span class="lineNum">     980 </span>                :<span class="lineNoCov">          0 :         MAGENTA = &quot;\x1B[35m&quot;;</span></a>
<a name="981"><span class="lineNum">     981 </span>                :<span class="lineNoCov">          0 :         CYAN = &quot;\x1B[36m&quot;;</span></a>
<a name="982"><span class="lineNum">     982 </span>                :            :     }</a>
<a name="983"><span class="lineNum">     983 </span>                :            : </a>
<a name="984"><span class="lineNum">     984 </span>                :<span class="lineNoCov">          0 :     std::string result_string = strprintf(&quot;%sChain: %s%s\n&quot;, BLUE, result[&quot;chain&quot;].getValStr(), RESET);</span></a>
<a name="985"><span class="lineNum">     985 </span>                :<span class="lineNoCov">          0 :     result_string += strprintf(&quot;Blocks: %s\n&quot;, result[&quot;blocks&quot;].getValStr());</span></a>
<a name="986"><span class="lineNum">     986 </span>                :<span class="lineNoCov">          0 :     result_string += strprintf(&quot;Headers: %s\n&quot;, result[&quot;headers&quot;].getValStr());</span></a>
<a name="987"><span class="lineNum">     987 </span>                :            : </a>
<a name="988"><span class="lineNum">     988 </span>                :<span class="lineNoCov">          0 :     const double ibd_progress{result[&quot;verificationprogress&quot;].get_real()};</span></a>
<a name="989"><span class="lineNum">     989 </span>                :<span class="lineNoCov">          0 :     std::string ibd_progress_bar;</span></a>
<a name="990"><span class="lineNum">     990 </span>                :            :     // Display the progress bar only if IBD progress is less than 99%</a>
<a name="991"><span class="lineNum">     991 </span>                :<span class="lineNoCov">          0 :     if (ibd_progress &lt; 0.99) {</span></a>
<a name="992"><span class="lineNum">     992 </span>                :<span class="lineNoCov">          0 :       GetProgressBar(ibd_progress, ibd_progress_bar);</span></a>
<a name="993"><span class="lineNum">     993 </span>                :            :       // Add padding between progress bar and IBD progress</a>
<a name="994"><span class="lineNum">     994 </span>                :<span class="lineNoCov">          0 :       ibd_progress_bar += &quot; &quot;;</span></a>
<a name="995"><span class="lineNum">     995 </span>                :            :     }</a>
<a name="996"><span class="lineNum">     996 </span>                :            : </a>
<a name="997"><span class="lineNum">     997 </span>                :<span class="lineNoCov">          0 :     result_string += strprintf(&quot;Verification progress: %s%.4f%%\n&quot;, ibd_progress_bar, ibd_progress * 100);</span></a>
<a name="998"><span class="lineNum">     998 </span>                :<span class="lineNoCov">          0 :     result_string += strprintf(&quot;Difficulty: %s\n\n&quot;, result[&quot;difficulty&quot;].getValStr());</span></a>
<a name="999"><span class="lineNum">     999 </span>                :            : </a>
<a name="1000"><span class="lineNum">    1000 </span>                :<span class="lineNoCov">          0 :     result_string += strprintf(</span></a>
<a name="1001"><span class="lineNum">    1001 </span>                :            :         &quot;%sNetwork: in %s, out %s, total %s%s\n&quot;,</a>
<a name="1002"><span class="lineNum">    1002 </span>                :            :         GREEN,</a>
<a name="1003"><span class="lineNum">    1003 </span>                :<span class="lineNoCov">          0 :         result[&quot;connections&quot;][&quot;in&quot;].getValStr(),</span></a>
<a name="1004"><span class="lineNum">    1004 </span>                :<span class="lineNoCov">          0 :         result[&quot;connections&quot;][&quot;out&quot;].getValStr(),</span></a>
<a name="1005"><span class="lineNum">    1005 </span>                :<span class="lineNoCov">          0 :         result[&quot;connections&quot;][&quot;total&quot;].getValStr(),</span></a>
<a name="1006"><span class="lineNum">    1006 </span>                :<span class="lineNoCov">          0 :         RESET);</span></a>
<a name="1007"><span class="lineNum">    1007 </span>                :<span class="lineNoCov">          0 :     result_string += strprintf(&quot;Version: %s\n&quot;, result[&quot;version&quot;].getValStr());</span></a>
<a name="1008"><span class="lineNum">    1008 </span>                :<span class="lineNoCov">          0 :     result_string += strprintf(&quot;Time offset (s): %s\n&quot;, result[&quot;timeoffset&quot;].getValStr());</span></a>
<a name="1009"><span class="lineNum">    1009 </span>                :            : </a>
<a name="1010"><span class="lineNum">    1010 </span>                :            :     // proxies</a>
<a name="1011"><span class="lineNum">    1011 </span>                :<span class="lineNoCov">          0 :     std::map&lt;std::string, std::vector&lt;std::string&gt;&gt; proxy_networks;</span></a>
<a name="1012"><span class="lineNum">    1012 </span>                :<span class="lineNoCov">          0 :     std::vector&lt;std::string&gt; ordered_proxies;</span></a>
<a name="1013"><span class="lineNum">    1013 </span>                :            : </a>
<a name="1014"><span class="lineNum">    1014 </span>                :<span class="lineNoCov">          0 :     for (const UniValue&amp; network : result[&quot;networks&quot;].getValues()) {</span></a>
<a name="1015"><span class="lineNum">    1015 </span>                :<span class="lineNoCov">          0 :         const std::string proxy = network[&quot;proxy&quot;].getValStr();</span></a>
<a name="1016"><span class="lineNum">    1016 </span>                :<span class="lineNoCov">          0 :         if (proxy.empty()) continue;</span></a>
<a name="1017"><span class="lineNum">    1017 </span>                :            :         // Add proxy to ordered_proxy if has not been processed</a>
<a name="1018"><span class="lineNum">    1018 </span>                :<span class="lineNoCov">          0 :         if (proxy_networks.find(proxy) == proxy_networks.end()) ordered_proxies.push_back(proxy);</span></a>
<a name="1019"><span class="lineNum">    1019 </span>                :            : </a>
<a name="1020"><span class="lineNum">    1020 </span>                :<span class="lineNoCov">          0 :         proxy_networks[proxy].push_back(network[&quot;name&quot;].getValStr());</span></a>
<a name="1021"><span class="lineNum">    1021 </span>                :            :     }</a>
<a name="1022"><span class="lineNum">    1022 </span>                :            : </a>
<a name="1023"><span class="lineNum">    1023 </span>                :<span class="lineNoCov">          0 :     std::vector&lt;std::string&gt; formatted_proxies;</span></a>
<a name="1024"><span class="lineNum">    1024 </span>                :<span class="lineNoCov">          0 :     for (const std::string&amp; proxy : ordered_proxies) {</span></a>
<a name="1025"><span class="lineNum">    1025 </span>                :<span class="lineNoCov">          0 :         formatted_proxies.emplace_back(strprintf(&quot;%s (%s)&quot;, proxy, Join(proxy_networks.find(proxy)-&gt;second, &quot;, &quot;)));</span></a>
<a name="1026"><span class="lineNum">    1026 </span>                :            :     }</a>
<a name="1027"><span class="lineNum">    1027 </span>                :<span class="lineNoCov">          0 :     result_string += strprintf(&quot;Proxies: %s\n&quot;, formatted_proxies.empty() ? &quot;n/a&quot; : Join(formatted_proxies, &quot;, &quot;));</span></a>
<a name="1028"><span class="lineNum">    1028 </span>                :            : </a>
<a name="1029"><span class="lineNum">    1029 </span>                :<span class="lineNoCov">          0 :     result_string += strprintf(&quot;Min tx relay fee rate (%s/kvB): %s\n\n&quot;, CURRENCY_UNIT, result[&quot;relayfee&quot;].getValStr());</span></a>
<a name="1030"><span class="lineNum">    1030 </span>                :            : </a>
<a name="1031"><span class="lineNum">    1031 </span>                :<span class="lineNoCov">          0 :     if (!result[&quot;has_wallet&quot;].isNull()) {</span></a>
<a name="1032"><span class="lineNum">    1032 </span>                :<span class="lineNoCov">          0 :         const std::string walletname = result[&quot;walletname&quot;].getValStr();</span></a>
<a name="1033"><span class="lineNum">    1033 </span>                :<span class="lineNoCov">          0 :         result_string += strprintf(&quot;%sWallet: %s%s\n&quot;, MAGENTA, walletname.empty() ? &quot;\&quot;\&quot;&quot; : walletname, RESET);</span></a>
<a name="1034"><span class="lineNum">    1034 </span>                :            : </a>
<a name="1035"><span class="lineNum">    1035 </span>                :<span class="lineNoCov">          0 :         result_string += strprintf(&quot;Keypool size: %s\n&quot;, result[&quot;keypoolsize&quot;].getValStr());</span></a>
<a name="1036"><span class="lineNum">    1036 </span>                :<span class="lineNoCov">          0 :         if (!result[&quot;unlocked_until&quot;].isNull()) {</span></a>
<a name="1037"><span class="lineNum">    1037 </span>                :<span class="lineNoCov">          0 :             result_string += strprintf(&quot;Unlocked until: %s\n&quot;, result[&quot;unlocked_until&quot;].getValStr());</span></a>
<a name="1038"><span class="lineNum">    1038 </span>                :            :         }</a>
<a name="1039"><span class="lineNum">    1039 </span>                :<span class="lineNoCov">          0 :         result_string += strprintf(&quot;Transaction fee rate (-paytxfee) (%s/kvB): %s\n\n&quot;, CURRENCY_UNIT, result[&quot;paytxfee&quot;].getValStr());</span></a>
<a name="1040"><span class="lineNum">    1040 </span>                :            :     }</a>
<a name="1041"><span class="lineNum">    1041 </span>                :<span class="lineNoCov">          0 :     if (!result[&quot;balance&quot;].isNull()) {</span></a>
<a name="1042"><span class="lineNum">    1042 </span>                :<span class="lineNoCov">          0 :         result_string += strprintf(&quot;%sBalance:%s %s\n\n&quot;, CYAN, RESET, result[&quot;balance&quot;].getValStr());</span></a>
<a name="1043"><span class="lineNum">    1043 </span>                :            :     }</a>
<a name="1044"><span class="lineNum">    1044 </span>                :            : </a>
<a name="1045"><span class="lineNum">    1045 </span>                :<span class="lineNoCov">          0 :     if (!result[&quot;balances&quot;].isNull()) {</span></a>
<a name="1046"><span class="lineNum">    1046 </span>                :<span class="lineNoCov">          0 :         result_string += strprintf(&quot;%sBalances%s\n&quot;, CYAN, RESET);</span></a>
<a name="1047"><span class="lineNum">    1047 </span>                :            : </a>
<a name="1048"><span class="lineNum">    1048 </span>                :<span class="lineNoCov">          0 :         size_t max_balance_length{10};</span></a>
<a name="1049"><span class="lineNum">    1049 </span>                :            : </a>
<a name="1050"><span class="lineNum">    1050 </span>                :<span class="lineNoCov">          0 :         for (const std::string&amp; wallet : result[&quot;balances&quot;].getKeys()) {</span></a>
<a name="1051"><span class="lineNum">    1051 </span>                :<span class="lineNoCov">          0 :             max_balance_length = std::max(result[&quot;balances&quot;][wallet].getValStr().length(), max_balance_length);</span></a>
<a name="1052"><span class="lineNum">    1052 </span>                :            :         }</a>
<a name="1053"><span class="lineNum">    1053 </span>                :            : </a>
<a name="1054"><span class="lineNum">    1054 </span>                :<span class="lineNoCov">          0 :         for (const std::string&amp; wallet : result[&quot;balances&quot;].getKeys()) {</span></a>
<a name="1055"><span class="lineNum">    1055 </span>                :<span class="lineNoCov">          0 :             result_string += strprintf(&quot;%*s %s\n&quot;,</span></a>
<a name="1056"><span class="lineNum">    1056 </span>                :            :                                        max_balance_length,</a>
<a name="1057"><span class="lineNum">    1057 </span>                :<span class="lineNoCov">          0 :                                        result[&quot;balances&quot;][wallet].getValStr(),</span></a>
<a name="1058"><span class="lineNum">    1058 </span>                :<span class="lineNoCov">          0 :                                        wallet.empty() ? &quot;\&quot;\&quot;&quot; : wallet);</span></a>
<a name="1059"><span class="lineNum">    1059 </span>                :            :         }</a>
<a name="1060"><span class="lineNum">    1060 </span>                :<span class="lineNoCov">          0 :         result_string += &quot;\n&quot;;</span></a>
<a name="1061"><span class="lineNum">    1061 </span>                :            :     }</a>
<a name="1062"><span class="lineNum">    1062 </span>                :            : </a>
<a name="1063"><span class="lineNum">    1063 </span>                :<span class="lineNoCov">          0 :     const std::string warnings{result[&quot;warnings&quot;].getValStr()};</span></a>
<a name="1064"><span class="lineNum">    1064 </span>                :<span class="lineNoCov">          0 :     result_string += strprintf(&quot;%sWarnings:%s %s&quot;, YELLOW, RESET, warnings.empty() ? &quot;(none)&quot; : warnings);</span></a>
<a name="1065"><span class="lineNum">    1065 </span>                :            : </a>
<a name="1066"><span class="lineNum">    1066 </span>                :<span class="lineNoCov">          0 :     result.setStr(result_string);</span></a>
<a name="1067"><span class="lineNum">    1067 </span>                :            : }</a>
<a name="1068"><span class="lineNum">    1068 </span>                :            : </a>
<a name="1069"><span class="lineNum">    1069 </span>                :            : /**</a>
<a name="1070"><span class="lineNum">    1070 </span>                :            :  * Call RPC getnewaddress.</a>
<a name="1071"><span class="lineNum">    1071 </span>                :            :  * @returns getnewaddress response as a UniValue object.</a>
<a name="1072"><span class="lineNum">    1072 </span>                :            :  */</a>
<a name="1073"><span class="lineNum">    1073 </span>                :<span class="lineNoCov">          0 : static UniValue GetNewAddress()</span></a>
<a name="1074"><span class="lineNum">    1074 </span>                :            : {</a>
<a name="1075"><span class="lineNum">    1075 </span>                :<span class="lineNoCov">          0 :     std::optional&lt;std::string&gt; wallet_name{};</span></a>
<a name="1076"><span class="lineNum">    1076 </span>                :<span class="lineNoCov">          0 :     if (gArgs.IsArgSet(&quot;-rpcwallet&quot;)) wallet_name = gArgs.GetArg(&quot;-rpcwallet&quot;, &quot;&quot;);</span></a>
<a name="1077"><span class="lineNum">    1077 </span>                :<span class="lineNoCov">          0 :     DefaultRequestHandler rh;</span></a>
<a name="1078"><span class="lineNum">    1078 </span>                :<span class="lineNoCov">          0 :     return ConnectAndCallRPC(&amp;rh, &quot;getnewaddress&quot;, /* args=*/{}, wallet_name);</span></a>
<a name="1079"><span class="lineNum">    1079 </span>                :            : }</a>
<a name="1080"><span class="lineNum">    1080 </span>                :            : </a>
<a name="1081"><span class="lineNum">    1081 </span>                :            : /**</a>
<a name="1082"><span class="lineNum">    1082 </span>                :            :  * Check bounds and set up args for RPC generatetoaddress params: nblocks, address, maxtries.</a>
<a name="1083"><span class="lineNum">    1083 </span>                :            :  * @param[in] address  Reference to const string address to insert into the args.</a>
<a name="1084"><span class="lineNum">    1084 </span>                :            :  * @param     args     Reference to vector of string args to modify.</a>
<a name="1085"><span class="lineNum">    1085 </span>                :            :  */</a>
<a name="1086"><span class="lineNum">    1086 </span>                :<span class="lineNoCov">          0 : static void SetGenerateToAddressArgs(const std::string&amp; address, std::vector&lt;std::string&gt;&amp; args)</span></a>
<a name="1087"><span class="lineNum">    1087 </span>                :            : {</a>
<a name="1088"><span class="lineNum">    1088 </span>                :<span class="lineNoCov">          0 :     if (args.size() &gt; 2) throw std::runtime_error(&quot;too many arguments (maximum 2 for nblocks and maxtries)&quot;);</span></a>
<a name="1089"><span class="lineNum">    1089 </span>                :<span class="lineNoCov">          0 :     if (args.size() == 0) {</span></a>
<a name="1090"><span class="lineNum">    1090 </span>                :<span class="lineNoCov">          0 :         args.emplace_back(DEFAULT_NBLOCKS);</span></a>
<a name="1091"><span class="lineNum">    1091 </span>                :<span class="lineNoCov">          0 :     } else if (args.at(0) == &quot;0&quot;) {</span></a>
<a name="1092"><span class="lineNum">    1092 </span>                :<span class="lineNoCov">          0 :         throw std::runtime_error(&quot;the first argument (number of blocks to generate, default: &quot; + DEFAULT_NBLOCKS + &quot;) must be an integer value greater than zero&quot;);</span></a>
<a name="1093"><span class="lineNum">    1093 </span>                :            :     }</a>
<a name="1094"><span class="lineNum">    1094 </span>                :<span class="lineNoCov">          0 :     args.emplace(args.begin() + 1, address);</span></a>
<a name="1095"><span class="lineNum">    1095 </span>                :<span class="lineNoCov">          0 : }</span></a>
<a name="1096"><span class="lineNum">    1096 </span>                :            : </a>
<a name="1097"><span class="lineNum">    1097 </span>                :<span class="lineNoCov">          0 : static int CommandLineRPC(int argc, char *argv[])</span></a>
<a name="1098"><span class="lineNum">    1098 </span>                :            : {</a>
<a name="1099"><span class="lineNum">    1099 </span>                :<span class="lineNoCov">          0 :     std::string strPrint;</span></a>
<a name="1100"><span class="lineNum">    1100 </span>                :<span class="lineNoCov">          0 :     int nRet = 0;</span></a>
<a name="1101"><span class="lineNum">    1101 </span>                :            :     try {</a>
<a name="1102"><span class="lineNum">    1102 </span>                :            :         // Skip switches</a>
<a name="1103"><span class="lineNum">    1103 </span>                :<span class="lineNoCov">          0 :         while (argc &gt; 1 &amp;&amp; IsSwitchChar(argv[1][0])) {</span></a>
<a name="1104"><span class="lineNum">    1104 </span>                :<span class="lineNoCov">          0 :             argc--;</span></a>
<a name="1105"><span class="lineNum">    1105 </span>                :<span class="lineNoCov">          0 :             argv++;</span></a>
<a name="1106"><span class="lineNum">    1106 </span>                :            :         }</a>
<a name="1107"><span class="lineNum">    1107 </span>                :<span class="lineNoCov">          0 :         std::string rpcPass;</span></a>
<a name="1108"><span class="lineNum">    1108 </span>                :<span class="lineNoCov">          0 :         if (gArgs.GetBoolArg(&quot;-stdinrpcpass&quot;, false)) {</span></a>
<a name="1109"><span class="lineNum">    1109 </span>                :<span class="lineNoCov">          0 :             NO_STDIN_ECHO();</span></a>
<a name="1110"><span class="lineNum">    1110 </span>                :<span class="lineNoCov">          0 :             if (!StdinReady()) {</span></a>
<a name="1111"><span class="lineNum">    1111 </span>                :<span class="lineNoCov">          0 :                 fputs(&quot;RPC password&gt; &quot;, stderr);</span></a>
<a name="1112"><span class="lineNum">    1112 </span>                :<span class="lineNoCov">          0 :                 fflush(stderr);</span></a>
<a name="1113"><span class="lineNum">    1113 </span>                :            :             }</a>
<a name="1114"><span class="lineNum">    1114 </span>                :<span class="lineNoCov">          0 :             if (!std::getline(std::cin, rpcPass)) {</span></a>
<a name="1115"><span class="lineNum">    1115 </span>                :<span class="lineNoCov">          0 :                 throw std::runtime_error(&quot;-stdinrpcpass specified but failed to read from standard input&quot;);</span></a>
<a name="1116"><span class="lineNum">    1116 </span>                :            :             }</a>
<a name="1117"><span class="lineNum">    1117 </span>                :<span class="lineNoCov">          0 :             if (StdinTerminal()) {</span></a>
<a name="1118"><span class="lineNum">    1118 </span>                :<span class="lineNoCov">          0 :                 fputc('\n', stdout);</span></a>
<a name="1119"><span class="lineNum">    1119 </span>                :            :             }</a>
<a name="1120"><span class="lineNum">    1120 </span>                :<span class="lineNoCov">          0 :             gArgs.ForceSetArg(&quot;-rpcpassword&quot;, rpcPass);</span></a>
<a name="1121"><span class="lineNum">    1121 </span>                :            :         }</a>
<a name="1122"><span class="lineNum">    1122 </span>                :<span class="lineNoCov">          0 :         std::vector&lt;std::string&gt; args = std::vector&lt;std::string&gt;(&amp;argv[1], &amp;argv[argc]);</span></a>
<a name="1123"><span class="lineNum">    1123 </span>                :<span class="lineNoCov">          0 :         if (gArgs.GetBoolArg(&quot;-stdinwalletpassphrase&quot;, false)) {</span></a>
<a name="1124"><span class="lineNum">    1124 </span>                :<span class="lineNoCov">          0 :             NO_STDIN_ECHO();</span></a>
<a name="1125"><span class="lineNum">    1125 </span>                :<span class="lineNoCov">          0 :             std::string walletPass;</span></a>
<a name="1126"><span class="lineNum">    1126 </span>                :<span class="lineNoCov">          0 :             if (args.size() &lt; 1 || args[0].substr(0, 16) != &quot;walletpassphrase&quot;) {</span></a>
<a name="1127"><span class="lineNum">    1127 </span>                :<span class="lineNoCov">          0 :                 throw std::runtime_error(&quot;-stdinwalletpassphrase is only applicable for walletpassphrase(change)&quot;);</span></a>
<a name="1128"><span class="lineNum">    1128 </span>                :            :             }</a>
<a name="1129"><span class="lineNum">    1129 </span>                :<span class="lineNoCov">          0 :             if (!StdinReady()) {</span></a>
<a name="1130"><span class="lineNum">    1130 </span>                :<span class="lineNoCov">          0 :                 fputs(&quot;Wallet passphrase&gt; &quot;, stderr);</span></a>
<a name="1131"><span class="lineNum">    1131 </span>                :<span class="lineNoCov">          0 :                 fflush(stderr);</span></a>
<a name="1132"><span class="lineNum">    1132 </span>                :            :             }</a>
<a name="1133"><span class="lineNum">    1133 </span>                :<span class="lineNoCov">          0 :             if (!std::getline(std::cin, walletPass)) {</span></a>
<a name="1134"><span class="lineNum">    1134 </span>                :<span class="lineNoCov">          0 :                 throw std::runtime_error(&quot;-stdinwalletpassphrase specified but failed to read from standard input&quot;);</span></a>
<a name="1135"><span class="lineNum">    1135 </span>                :            :             }</a>
<a name="1136"><span class="lineNum">    1136 </span>                :<span class="lineNoCov">          0 :             if (StdinTerminal()) {</span></a>
<a name="1137"><span class="lineNum">    1137 </span>                :<span class="lineNoCov">          0 :                 fputc('\n', stdout);</span></a>
<a name="1138"><span class="lineNum">    1138 </span>                :            :             }</a>
<a name="1139"><span class="lineNum">    1139 </span>                :<span class="lineNoCov">          0 :             args.insert(args.begin() + 1, walletPass);</span></a>
<a name="1140"><span class="lineNum">    1140 </span>                :            :         }</a>
<a name="1141"><span class="lineNum">    1141 </span>                :<span class="lineNoCov">          0 :         if (gArgs.GetBoolArg(&quot;-stdin&quot;, false)) {</span></a>
<a name="1142"><span class="lineNum">    1142 </span>                :            :             // Read one arg per line from stdin and append</a>
<a name="1143"><span class="lineNum">    1143 </span>                :<span class="lineNoCov">          0 :             std::string line;</span></a>
<a name="1144"><span class="lineNum">    1144 </span>                :<span class="lineNoCov">          0 :             while (std::getline(std::cin, line)) {</span></a>
<a name="1145"><span class="lineNum">    1145 </span>                :<span class="lineNoCov">          0 :                 args.push_back(line);</span></a>
<a name="1146"><span class="lineNum">    1146 </span>                :            :             }</a>
<a name="1147"><span class="lineNum">    1147 </span>                :<span class="lineNoCov">          0 :             if (StdinTerminal()) {</span></a>
<a name="1148"><span class="lineNum">    1148 </span>                :<span class="lineNoCov">          0 :                 fputc('\n', stdout);</span></a>
<a name="1149"><span class="lineNum">    1149 </span>                :            :             }</a>
<a name="1150"><span class="lineNum">    1150 </span>                :            :         }</a>
<a name="1151"><span class="lineNum">    1151 </span>                :<span class="lineNoCov">          0 :         std::unique_ptr&lt;BaseRequestHandler&gt; rh;</span></a>
<a name="1152"><span class="lineNum">    1152 </span>                :<span class="lineNoCov">          0 :         std::string method;</span></a>
<a name="1153"><span class="lineNum">    1153 </span>                :<span class="lineNoCov">          0 :         if (gArgs.IsArgSet(&quot;-getinfo&quot;)) {</span></a>
<a name="1154"><span class="lineNum">    1154 </span>                :<span class="lineNoCov">          0 :             rh.reset(new GetinfoRequestHandler());</span></a>
<a name="1155"><span class="lineNum">    1155 </span>                :<span class="lineNoCov">          0 :         } else if (gArgs.GetBoolArg(&quot;-netinfo&quot;, false)) {</span></a>
<a name="1156"><span class="lineNum">    1156 </span>                :<span class="lineNoCov">          0 :             if (!args.empty() &amp;&amp; args.at(0) == &quot;help&quot;) {</span></a>
<a name="1157"><span class="lineNum">    1157 </span>                :<span class="lineNoCov">          0 :                 tfm::format(std::cout, &quot;%s\n&quot;, NetinfoRequestHandler().m_help_doc);</span></a>
<a name="1158"><span class="lineNum">    1158 </span>                :<span class="lineNoCov">          0 :                 return 0;</span></a>
<a name="1159"><span class="lineNum">    1159 </span>                :            :             }</a>
<a name="1160"><span class="lineNum">    1160 </span>                :<span class="lineNoCov">          0 :             rh.reset(new NetinfoRequestHandler());</span></a>
<a name="1161"><span class="lineNum">    1161 </span>                :<span class="lineNoCov">          0 :         } else if (gArgs.GetBoolArg(&quot;-generate&quot;, false)) {</span></a>
<a name="1162"><span class="lineNum">    1162 </span>                :<span class="lineNoCov">          0 :             const UniValue getnewaddress{GetNewAddress()};</span></a>
<a name="1163"><span class="lineNum">    1163 </span>                :<span class="lineNoCov">          0 :             const UniValue&amp; error{find_value(getnewaddress, &quot;error&quot;)};</span></a>
<a name="1164"><span class="lineNum">    1164 </span>                :<span class="lineNoCov">          0 :             if (error.isNull()) {</span></a>
<a name="1165"><span class="lineNum">    1165 </span>                :<span class="lineNoCov">          0 :                 SetGenerateToAddressArgs(find_value(getnewaddress, &quot;result&quot;).get_str(), args);</span></a>
<a name="1166"><span class="lineNum">    1166 </span>                :<span class="lineNoCov">          0 :                 rh.reset(new GenerateToAddressRequestHandler());</span></a>
<a name="1167"><span class="lineNum">    1167 </span>                :            :             } else {</a>
<a name="1168"><span class="lineNum">    1168 </span>                :<span class="lineNoCov">          0 :                 ParseError(error, strPrint, nRet);</span></a>
<a name="1169"><span class="lineNum">    1169 </span>                :            :             }</a>
<a name="1170"><span class="lineNum">    1170 </span>                :<span class="lineNoCov">          0 :         } else if (gArgs.GetBoolArg(&quot;-addrinfo&quot;, false)) {</span></a>
<a name="1171"><span class="lineNum">    1171 </span>                :<span class="lineNoCov">          0 :             rh.reset(new AddrinfoRequestHandler());</span></a>
<a name="1172"><span class="lineNum">    1172 </span>                :            :         } else {</a>
<a name="1173"><span class="lineNum">    1173 </span>                :<span class="lineNoCov">          0 :             rh.reset(new DefaultRequestHandler());</span></a>
<a name="1174"><span class="lineNum">    1174 </span>                :<span class="lineNoCov">          0 :             if (args.size() &lt; 1) {</span></a>
<a name="1175"><span class="lineNum">    1175 </span>                :<span class="lineNoCov">          0 :                 throw std::runtime_error(&quot;too few parameters (need at least command)&quot;);</span></a>
<a name="1176"><span class="lineNum">    1176 </span>                :            :             }</a>
<a name="1177"><span class="lineNum">    1177 </span>                :<span class="lineNoCov">          0 :             method = args[0];</span></a>
<a name="1178"><span class="lineNum">    1178 </span>                :<span class="lineNoCov">          0 :             args.erase(args.begin()); // Remove trailing method name from arguments vector</span></a>
<a name="1179"><span class="lineNum">    1179 </span>                :            :         }</a>
<a name="1180"><span class="lineNum">    1180 </span>                :<span class="lineNoCov">          0 :         if (nRet == 0) {</span></a>
<a name="1181"><span class="lineNum">    1181 </span>                :            :             // Perform RPC call</a>
<a name="1182"><span class="lineNum">    1182 </span>                :<span class="lineNoCov">          0 :             std::optional&lt;std::string&gt; wallet_name{};</span></a>
<a name="1183"><span class="lineNum">    1183 </span>                :<span class="lineNoCov">          0 :             if (gArgs.IsArgSet(&quot;-rpcwallet&quot;)) wallet_name = gArgs.GetArg(&quot;-rpcwallet&quot;, &quot;&quot;);</span></a>
<a name="1184"><span class="lineNum">    1184 </span>                :<span class="lineNoCov">          0 :             const UniValue reply = ConnectAndCallRPC(rh.get(), method, args, wallet_name);</span></a>
<a name="1185"><span class="lineNum">    1185 </span>                :            : </a>
<a name="1186"><span class="lineNum">    1186 </span>                :            :             // Parse reply</a>
<a name="1187"><span class="lineNum">    1187 </span>                :<span class="lineNoCov">          0 :             UniValue result = find_value(reply, &quot;result&quot;);</span></a>
<a name="1188"><span class="lineNum">    1188 </span>                :<span class="lineNoCov">          0 :             const UniValue&amp; error = find_value(reply, &quot;error&quot;);</span></a>
<a name="1189"><span class="lineNum">    1189 </span>                :<span class="lineNoCov">          0 :             if (error.isNull()) {</span></a>
<a name="1190"><span class="lineNum">    1190 </span>                :<span class="lineNoCov">          0 :                 if (gArgs.GetBoolArg(&quot;-getinfo&quot;, false)) {</span></a>
<a name="1191"><span class="lineNum">    1191 </span>                :<span class="lineNoCov">          0 :                     if (!gArgs.IsArgSet(&quot;-rpcwallet&quot;)) {</span></a>
<a name="1192"><span class="lineNum">    1192 </span>                :<span class="lineNoCov">          0 :                         GetWalletBalances(result); // fetch multiwallet balances and append to result</span></a>
<a name="1193"><span class="lineNum">    1193 </span>                :            :                     }</a>
<a name="1194"><span class="lineNum">    1194 </span>                :<span class="lineNoCov">          0 :                     ParseGetInfoResult(result);</span></a>
<a name="1195"><span class="lineNum">    1195 </span>                :            :                 }</a>
<a name="1196"><span class="lineNum">    1196 </span>                :            : </a>
<a name="1197"><span class="lineNum">    1197 </span>                :<span class="lineNoCov">          0 :                 ParseResult(result, strPrint);</span></a>
<a name="1198"><span class="lineNum">    1198 </span>                :            :             } else {</a>
<a name="1199"><span class="lineNum">    1199 </span>                :<span class="lineNoCov">          0 :                 ParseError(error, strPrint, nRet);</span></a>
<a name="1200"><span class="lineNum">    1200 </span>                :            :             }</a>
<a name="1201"><span class="lineNum">    1201 </span>                :            :         }</a>
<a name="1202"><span class="lineNum">    1202 </span>                :<span class="lineNoCov">          0 :     } catch (const std::exception&amp; e) {</span></a>
<a name="1203"><span class="lineNum">    1203 </span>                :<span class="lineNoCov">          0 :         strPrint = std::string(&quot;error: &quot;) + e.what();</span></a>
<a name="1204"><span class="lineNum">    1204 </span>                :<span class="lineNoCov">          0 :         nRet = EXIT_FAILURE;</span></a>
<a name="1205"><span class="lineNum">    1205 </span>                :<span class="lineNoCov">          0 :     } catch (...) {</span></a>
<a name="1206"><span class="lineNum">    1206 </span>                :<span class="lineNoCov">          0 :         PrintExceptionContinue(nullptr, &quot;CommandLineRPC()&quot;);</span></a>
<a name="1207"><span class="lineNum">    1207 </span>                :<span class="lineNoCov">          0 :         throw;</span></a>
<a name="1208"><span class="lineNum">    1208 </span>                :            :     }</a>
<a name="1209"><span class="lineNum">    1209 </span>                :            : </a>
<a name="1210"><span class="lineNum">    1210 </span>                :<span class="lineNoCov">          0 :     if (strPrint != &quot;&quot;) {</span></a>
<a name="1211"><span class="lineNum">    1211 </span>                :<span class="lineNoCov">          0 :         tfm::format(nRet == 0 ? std::cout : std::cerr, &quot;%s\n&quot;, strPrint);</span></a>
<a name="1212"><span class="lineNum">    1212 </span>                :            :     }</a>
<a name="1213"><span class="lineNum">    1213 </span>                :<span class="lineNoCov">          0 :     return nRet;</span></a>
<a name="1214"><span class="lineNum">    1214 </span>                :            : }</a>
<a name="1215"><span class="lineNum">    1215 </span>                :            : </a>
<a name="1216"><span class="lineNum">    1216 </span>                :<span class="lineNoCov">          0 : MAIN_FUNCTION</span></a>
<a name="1217"><span class="lineNum">    1217 </span>                :            : {</a>
<a name="1218"><span class="lineNum">    1218 </span>                :            : #ifdef WIN32</a>
<a name="1219"><span class="lineNum">    1219 </span>                :            :     util::WinCmdLineArgs winArgs;</a>
<a name="1220"><span class="lineNum">    1220 </span>                :            :     std::tie(argc, argv) = winArgs.get();</a>
<a name="1221"><span class="lineNum">    1221 </span>                :            : #endif</a>
<a name="1222"><span class="lineNum">    1222 </span>                :<span class="lineNoCov">          0 :     SetupEnvironment();</span></a>
<a name="1223"><span class="lineNum">    1223 </span>                :<span class="lineNoCov">          0 :     if (!SetupNetworking()) {</span></a>
<a name="1224"><span class="lineNum">    1224 </span>                :<span class="lineNoCov">          0 :         tfm::format(std::cerr, &quot;Error: Initializing networking failed\n&quot;);</span></a>
<a name="1225"><span class="lineNum">    1225 </span>                :<span class="lineNoCov">          0 :         return EXIT_FAILURE;</span></a>
<a name="1226"><span class="lineNum">    1226 </span>                :            :     }</a>
<a name="1227"><span class="lineNum">    1227 </span>                :<span class="lineNoCov">          0 :     event_set_log_callback(&amp;libevent_log_cb);</span></a>
<a name="1228"><span class="lineNum">    1228 </span>                :            : </a>
<a name="1229"><span class="lineNum">    1229 </span>                :            :     try {</a>
<a name="1230"><span class="lineNum">    1230 </span>                :<span class="lineNoCov">          0 :         int ret = AppInitRPC(argc, argv);</span></a>
<a name="1231"><span class="lineNum">    1231 </span>                :<span class="lineNoCov">          0 :         if (ret != CONTINUE_EXECUTION)</span></a>
<a name="1232"><span class="lineNum">    1232 </span>                :<span class="lineNoCov">          0 :             return ret;</span></a>
<a name="1233"><span class="lineNum">    1233 </span>                :            :     }</a>
<a name="1234"><span class="lineNum">    1234 </span>                :<span class="lineNoCov">          0 :     catch (const std::exception&amp; e) {</span></a>
<a name="1235"><span class="lineNum">    1235 </span>                :<span class="lineNoCov">          0 :         PrintExceptionContinue(&amp;e, &quot;AppInitRPC()&quot;);</span></a>
<a name="1236"><span class="lineNum">    1236 </span>                :<span class="lineNoCov">          0 :         return EXIT_FAILURE;</span></a>
<a name="1237"><span class="lineNum">    1237 </span>                :<span class="lineNoCov">          0 :     } catch (...) {</span></a>
<a name="1238"><span class="lineNum">    1238 </span>                :<span class="lineNoCov">          0 :         PrintExceptionContinue(nullptr, &quot;AppInitRPC()&quot;);</span></a>
<a name="1239"><span class="lineNum">    1239 </span>                :<span class="lineNoCov">          0 :         return EXIT_FAILURE;</span></a>
<a name="1240"><span class="lineNum">    1240 </span>                :            :     }</a>
<a name="1241"><span class="lineNum">    1241 </span>                :            : </a>
<a name="1242"><span class="lineNum">    1242 </span>                :<span class="lineNoCov">          0 :     int ret = EXIT_FAILURE;</span></a>
<a name="1243"><span class="lineNum">    1243 </span>                :            :     try {</a>
<a name="1244"><span class="lineNum">    1244 </span>                :<span class="lineNoCov">          0 :         ret = CommandLineRPC(argc, argv);</span></a>
<a name="1245"><span class="lineNum">    1245 </span>                :            :     }</a>
<a name="1246"><span class="lineNum">    1246 </span>                :<span class="lineNoCov">          0 :     catch (const std::exception&amp; e) {</span></a>
<a name="1247"><span class="lineNum">    1247 </span>                :<span class="lineNoCov">          0 :         PrintExceptionContinue(&amp;e, &quot;CommandLineRPC()&quot;);</span></a>
<a name="1248"><span class="lineNum">    1248 </span>                :<span class="lineNoCov">          0 :     } catch (...) {</span></a>
<a name="1249"><span class="lineNum">    1249 </span>                :<span class="lineNoCov">          0 :         PrintExceptionContinue(nullptr, &quot;CommandLineRPC()&quot;);</span></a>
<a name="1250"><span class="lineNum">    1250 </span>                :            :     }</a>
<a name="1251"><span class="lineNum">    1251 </span>                :<span class="lineNoCov">          0 :     return ret;</span></a>
<a name="1252"><span class="lineNum">    1252 </span>                :            : }</a>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.14</a></td></tr>
  </table>
  <br>

</body>
</html>
