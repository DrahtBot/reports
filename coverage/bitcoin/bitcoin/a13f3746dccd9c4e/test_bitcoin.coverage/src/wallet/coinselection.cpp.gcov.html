<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - test_bitcoin_coverage.info - src/wallet/coinselection.cpp</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">src/wallet</a> - coinselection.cpp<span style="font-size: 80%;"> (source / <a href="coinselection.cpp.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">test_bitcoin_coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">268</td>
            <td class="headerCovTableEntry">279</td>
            <td class="headerCovTableEntryHi">96.1 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2000-01-01 12:00:00</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">28</td>
            <td class="headerCovTableEntry">30</td>
            <td class="headerCovTableEntryHi">93.3 %</td>
          </tr>
          <tr>
            <td></td>
            <td></td>
            <td></td>
            <td class="headerItem">Branches:</td>
            <td class="headerCovTableEntry">230</td>
            <td class="headerCovTableEntry">327</td>
            <td class="headerCovTableEntryLo">70.3 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">           Branch data     Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>                :            : // Copyright (c) 2017-2022 The Bitcoin Core developers</a>
<a name="2"><span class="lineNum">       2 </span>                :            : // Distributed under the MIT software license, see the accompanying</a>
<a name="3"><span class="lineNum">       3 </span>                :            : // file COPYING or http://www.opensource.org/licenses/mit-license.php.</a>
<a name="4"><span class="lineNum">       4 </span>                :            : </a>
<a name="5"><span class="lineNum">       5 </span>                :            : #include &lt;wallet/coinselection.h&gt;</a>
<a name="6"><span class="lineNum">       6 </span>                :            : </a>
<a name="7"><span class="lineNum">       7 </span>                :            : #include &lt;consensus/amount.h&gt;</a>
<a name="8"><span class="lineNum">       8 </span>                :            : #include &lt;consensus/consensus.h&gt;</a>
<a name="9"><span class="lineNum">       9 </span>                :            : #include &lt;logging.h&gt;</a>
<a name="10"><span class="lineNum">      10 </span>                :            : #include &lt;policy/feerate.h&gt;</a>
<a name="11"><span class="lineNum">      11 </span>                :            : #include &lt;util/check.h&gt;</a>
<a name="12"><span class="lineNum">      12 </span>                :            : #include &lt;util/moneystr.h&gt;</a>
<a name="13"><span class="lineNum">      13 </span>                :            : #include &lt;util/system.h&gt;</a>
<a name="14"><span class="lineNum">      14 </span>                :            : </a>
<a name="15"><span class="lineNum">      15 </span>                :            : #include &lt;numeric&gt;</a>
<a name="16"><span class="lineNum">      16 </span>                :            : #include &lt;optional&gt;</a>
<a name="17"><span class="lineNum">      17 </span>                :            : #include &lt;queue&gt;</a>
<a name="18"><span class="lineNum">      18 </span>                :            : </a>
<a name="19"><span class="lineNum">      19 </span>                :            : namespace wallet {</a>
<a name="20"><span class="lineNum">      20 </span>                :            : // Common selection error across the algorithms</a>
<a name="21"><span class="lineNum">      21 </span>                :<span class="lineCov">         21 : static util::Result&lt;SelectionResult&gt; ErrorMaxWeightExceeded()</span></a>
<a name="22"><span class="lineNum">      22 </span>                :            : {</a>
<a name="23"><span class="lineNum">      23 </span>                :<span class="lineCov">         42 :     return util::Error{_(&quot;The inputs size exceeds the maximum weight. &quot;</span></a>
<a name="24"><span class="lineNum">      24 </span>        [<span class="branchCov" title="Branch 0 was taken 21 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         42 :                          &quot;Please try sending a smaller amount or manually consolidating your wallet's UTXOs&quot;)};</span></a>
<a name="25"><span class="lineNum">      25 </span>                :            : }</a>
<a name="26"><span class="lineNum">      26 </span>                :            : </a>
<a name="27"><span class="lineNum">      27 </span>                :            : // Descending order comparator</a>
<a name="28"><span class="lineNum">      28 </span>                :            : struct {</a>
<a name="29"><span class="lineNum">      29 </span>                :<span class="lineCov">    4880376 :     bool operator()(const OutputGroup&amp; a, const OutputGroup&amp; b) const</span></a>
<a name="30"><span class="lineNum">      30 </span>                :            :     {</a>
<a name="31"><span class="lineNum">      31 </span>                :<span class="lineCov">    4880376 :         return a.GetSelectionAmount() &gt; b.GetSelectionAmount();</span></a>
<a name="32"><span class="lineNum">      32 </span>                :            :     }</a>
<a name="33"><span class="lineNum">      33 </span>                :            : } descending;</a>
<a name="34"><span class="lineNum">      34 </span>                :            : </a>
<a name="35"><span class="lineNum">      35 </span>                :            : /*</a>
<a name="36"><span class="lineNum">      36 </span>                :            :  * This is the Branch and Bound Coin Selection algorithm designed by Murch. It searches for an input</a>
<a name="37"><span class="lineNum">      37 </span>                :            :  * set that can pay for the spending target and does not exceed the spending target by more than the</a>
<a name="38"><span class="lineNum">      38 </span>                :            :  * cost of creating and spending a change output. The algorithm uses a depth-first search on a binary</a>
<a name="39"><span class="lineNum">      39 </span>                :            :  * tree. In the binary tree, each node corresponds to the inclusion or the omission of a UTXO. UTXOs</a>
<a name="40"><span class="lineNum">      40 </span>                :            :  * are sorted by their effective values and the tree is explored deterministically per the inclusion</a>
<a name="41"><span class="lineNum">      41 </span>                :            :  * branch first. At each node, the algorithm checks whether the selection is within the target range.</a>
<a name="42"><span class="lineNum">      42 </span>                :            :  * While the selection has not reached the target range, more UTXOs are included. When a selection's</a>
<a name="43"><span class="lineNum">      43 </span>                :            :  * value exceeds the target range, the complete subtree deriving from this selection can be omitted.</a>
<a name="44"><span class="lineNum">      44 </span>                :            :  * At that point, the last included UTXO is deselected and the corresponding omission branch explored</a>
<a name="45"><span class="lineNum">      45 </span>                :            :  * instead. The search ends after the complete tree has been searched or after a limited number of tries.</a>
<a name="46"><span class="lineNum">      46 </span>                :            :  *</a>
<a name="47"><span class="lineNum">      47 </span>                :            :  * The search continues to search for better solutions after one solution has been found. The best</a>
<a name="48"><span class="lineNum">      48 </span>                :            :  * solution is chosen by minimizing the waste metric. The waste metric is defined as the cost to</a>
<a name="49"><span class="lineNum">      49 </span>                :            :  * spend the current inputs at the given fee rate minus the long term expected cost to spend the</a>
<a name="50"><span class="lineNum">      50 </span>                :            :  * inputs, plus the amount by which the selection exceeds the spending target:</a>
<a name="51"><span class="lineNum">      51 </span>                :            :  *</a>
<a name="52"><span class="lineNum">      52 </span>                :            :  * waste = selectionTotal - target + inputs × (currentFeeRate - longTermFeeRate)</a>
<a name="53"><span class="lineNum">      53 </span>                :            :  *</a>
<a name="54"><span class="lineNum">      54 </span>                :            :  * The algorithm uses two additional optimizations. A lookahead keeps track of the total value of</a>
<a name="55"><span class="lineNum">      55 </span>                :            :  * the unexplored UTXOs. A subtree is not explored if the lookahead indicates that the target range</a>
<a name="56"><span class="lineNum">      56 </span>                :            :  * cannot be reached. Further, it is unnecessary to test equivalent combinations. This allows us</a>
<a name="57"><span class="lineNum">      57 </span>                :            :  * to skip testing the inclusion of UTXOs that match the effective value and waste of an omitted</a>
<a name="58"><span class="lineNum">      58 </span>                :            :  * predecessor.</a>
<a name="59"><span class="lineNum">      59 </span>                :            :  *</a>
<a name="60"><span class="lineNum">      60 </span>                :            :  * The Branch and Bound algorithm is described in detail in Murch's Master Thesis:</a>
<a name="61"><span class="lineNum">      61 </span>                :            :  * https://murch.one/wp-content/uploads/2016/11/erhardt2016coinselection.pdf</a>
<a name="62"><span class="lineNum">      62 </span>                :            :  *</a>
<a name="63"><span class="lineNum">      63 </span>                :            :  * @param const std::vector&lt;OutputGroup&gt;&amp; utxo_pool The set of UTXO groups that we are choosing from.</a>
<a name="64"><span class="lineNum">      64 </span>                :            :  *        These UTXO groups will be sorted in descending order by effective value and the OutputGroups'</a>
<a name="65"><span class="lineNum">      65 </span>                :            :  *        values are their effective values.</a>
<a name="66"><span class="lineNum">      66 </span>                :            :  * @param const CAmount&amp; selection_target This is the value that we want to select. It is the lower</a>
<a name="67"><span class="lineNum">      67 </span>                :            :  *        bound of the range.</a>
<a name="68"><span class="lineNum">      68 </span>                :            :  * @param const CAmount&amp; cost_of_change This is the cost of creating and spending a change output.</a>
<a name="69"><span class="lineNum">      69 </span>                :            :  *        This plus selection_target is the upper bound of the range.</a>
<a name="70"><span class="lineNum">      70 </span>                :            :  * @returns The result of this coin selection algorithm, or std::nullopt</a>
<a name="71"><span class="lineNum">      71 </span>                :            :  */</a>
<a name="72"><span class="lineNum">      72 </span>                :            : </a>
<a name="73"><span class="lineNum">      73 </span>                :            : static const size_t TOTAL_TRIES = 100000;</a>
<a name="74"><span class="lineNum">      74 </span>                :            : </a>
<a name="75"><span class="lineNum">      75 </span>                :<span class="lineCov">        241 : util::Result&lt;SelectionResult&gt; SelectCoinsBnB(std::vector&lt;OutputGroup&gt;&amp; utxo_pool, const CAmount&amp; selection_target, const CAmount&amp; cost_of_change,</span></a>
<a name="76"><span class="lineNum">      76 </span>                :            :                                              int max_weight)</a>
<a name="77"><span class="lineNum">      77 </span>                :            : {</a>
<a name="78"><span class="lineNum">      78 </span>                :<span class="lineCov">        241 :     SelectionResult result(selection_target, SelectionAlgorithm::BNB);</span></a>
<a name="79"><span class="lineNum">      79 </span>                :<span class="lineCov">        241 :     CAmount curr_value = 0;</span></a>
<a name="80"><span class="lineNum">      80 </span>                :<span class="lineCov">        241 :     std::vector&lt;size_t&gt; curr_selection; // selected utxo indexes</span></a>
<a name="81"><span class="lineNum">      81 </span>                :<span class="lineCov">        241 :     int curr_selection_weight = 0; // sum of selected utxo weight</span></a>
<a name="82"><span class="lineNum">      82 </span>                :            : </a>
<a name="83"><span class="lineNum">      83 </span>                :            :     // Calculate curr_available_value</a>
<a name="84"><span class="lineNum">      84 </span>                :<span class="lineCov">        241 :     CAmount curr_available_value = 0;</span></a>
<a name="85"><span class="lineNum">      85 </span>        [<span class="branchCov" title="Branch 0 was taken 164743 times"> + </span><span class="branchCov" title="Branch 1 was taken 241 times"> + </span>]:<span class="lineCov">     164984 :     for (const OutputGroup&amp; utxo : utxo_pool) {</span></a>
<a name="86"><span class="lineNum">      86 </span>                :            :         // Assert that this utxo is not negative. It should never be negative,</a>
<a name="87"><span class="lineNum">      87 </span>                :            :         // effective value calculation should have removed it</a>
<a name="88"><span class="lineNum">      88 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 164743 times"> + </span>]:<span class="lineCov">     164743 :         assert(utxo.GetSelectionAmount() &gt; 0);</span></a>
<a name="89"><span class="lineNum">      89 </span>                :<span class="lineCov">     164743 :         curr_available_value += utxo.GetSelectionAmount();</span></a>
<a name="90"><span class="lineNum">      90 </span>                :            :     }</a>
<a name="91"><span class="lineNum">      91 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchCov" title="Branch 1 was taken 238 times"> + </span>]:<span class="lineCov">        241 :     if (curr_available_value &lt; selection_target) {</span></a>
<a name="92"><span class="lineNum">      92 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          6 :         return util::Error();</span></a>
<a name="93"><span class="lineNum">      93 </span>                :            :     }</a>
<a name="94"><span class="lineNum">      94 </span>                :            : </a>
<a name="95"><span class="lineNum">      95 </span>                :            :     // Sort the utxo_pool</a>
<a name="96"><span class="lineNum">      96 </span>        [<span class="branchCov" title="Branch 0 was taken 238 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        238 :     std::sort(utxo_pool.begin(), utxo_pool.end(), descending);</span></a>
<a name="97"><span class="lineNum">      97 </span>                :            : </a>
<a name="98"><span class="lineNum">      98 </span>                :<span class="lineCov">        238 :     CAmount curr_waste = 0;</span></a>
<a name="99"><span class="lineNum">      99 </span>                :<span class="lineCov">        238 :     std::vector&lt;size_t&gt; best_selection;</span></a>
<a name="100"><span class="lineNum">     100 </span>                :<span class="lineCov">        238 :     CAmount best_waste = MAX_MONEY;</span></a>
<a name="101"><span class="lineNum">     101 </span>                :            : </a>
<a name="102"><span class="lineNum">     102 </span>  [<span class="branchCov" title="Branch 0 was taken 238 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 238 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">        238 :     bool is_feerate_high = utxo_pool.at(0).fee &gt; utxo_pool.at(0).long_term_fee;</span></a>
<a name="103"><span class="lineNum">     103 </span>                :<span class="lineCov">        238 :     bool max_tx_weight_exceeded = false;</span></a>
<a name="104"><span class="lineNum">     104 </span>                :            : </a>
<a name="105"><span class="lineNum">     105 </span>                :            :     // Depth First search loop for choosing the UTXOs</a>
<a name="106"><span class="lineNum">     106 </span>        [<span class="branchCov" title="Branch 0 was taken 11085414 times"> + </span><span class="branchCov" title="Branch 1 was taken 110 times"> + </span>]:<span class="lineCov">   11085524 :     for (size_t curr_try = 0, utxo_pool_index = 0; curr_try &lt; TOTAL_TRIES; ++curr_try, ++utxo_pool_index) {</span></a>
<a name="107"><span class="lineNum">     107 </span>                :            :         // Conditions for starting a backtrack</a>
<a name="108"><span class="lineNum">     108 </span>                :<span class="lineCov">   11085414 :         bool backtrack = false;</span></a>
<a name="109"><span class="lineNum">     109 </span>        [<span class="branchCov" title="Branch 0 was taken 9665975 times"> + </span><span class="branchCov" title="Branch 1 was taken 1419439 times"> + </span>]:<span class="lineCov">   11085414 :         if (curr_value + curr_available_value &lt; selection_target || // Cannot possibly reach target with the amount remaining in the curr_available_value.</span></a>
<a name="110"><span class="lineNum">     110 </span>  [<span class="branchCov" title="Branch 0 was taken 5995759 times"> + </span><span class="branchCov" title="Branch 1 was taken 3670216 times"> + </span><span class="branchCov" title="Branch 2 was taken 4 times"> + </span><span class="branchCov" title="Branch 3 was taken 5995755 times"> + </span>]:<span class="lineCov">    9665975 :             curr_value &gt; selection_target + cost_of_change || // Selected value is out of range, go back and try other branch</span></a>
<a name="111"><span class="lineNum">     111 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          4 :             (curr_waste &gt; best_waste &amp;&amp; is_feerate_high)) { // Don't select things which we know will be more wasteful if the waste is increasing</span></a>
<a name="112"><span class="lineNum">     112 </span>                :<span class="lineCov">    5089658 :             backtrack = true;</span></a>
<a name="113"><span class="lineNum">     113 </span>        [<span class="branchCov" title="Branch 0 was taken 39 times"> + </span><span class="branchCov" title="Branch 1 was taken 5995717 times"> + </span>]:<span class="lineCov">    5995756 :         } else if (curr_selection_weight &gt; max_weight) { // Exceeding weight for standard tx, cannot find more solutions by adding more inputs</span></a>
<a name="114"><span class="lineNum">     114 </span>                :<span class="lineCov">         39 :             max_tx_weight_exceeded = true; // at least one selection attempt exceeded the max weight</span></a>
<a name="115"><span class="lineNum">     115 </span>                :<span class="lineCov">         39 :             backtrack = true;</span></a>
<a name="116"><span class="lineNum">     116 </span>        [<span class="branchCov" title="Branch 0 was taken 25211 times"> + </span><span class="branchCov" title="Branch 1 was taken 5970506 times"> + </span>]:<span class="lineCov">    5995717 :         } else if (curr_value &gt;= selection_target) {       // Selected value is within range</span></a>
<a name="117"><span class="lineNum">     117 </span>                :<span class="lineCov">      25211 :             curr_waste += (curr_value - selection_target); // This is the excess value which is added to the waste for the below comparison</span></a>
<a name="118"><span class="lineNum">     118 </span>                :            :             // Adding another UTXO after this check could bring the waste down if the long term fee is higher than the current fee.</a>
<a name="119"><span class="lineNum">     119 </span>                :            :             // However we are not going to explore that because this optimization for the waste is only done when we have hit our target</a>
<a name="120"><span class="lineNum">     120 </span>                :            :             // value. Adding any more UTXOs will be just burning the UTXO; it will go entirely to fees. Thus we aren't going to</a>
<a name="121"><span class="lineNum">     121 </span>                :            :             // explore any more UTXOs to avoid burning money like that.</a>
<a name="122"><span class="lineNum">     122 </span>        [<span class="branchCov" title="Branch 0 was taken 12789 times"> + </span><span class="branchCov" title="Branch 1 was taken 12422 times"> + </span>]:<span class="lineCov">      25211 :             if (curr_waste &lt;= best_waste) {</span></a>
<a name="123"><span class="lineNum">     123 </span>        [<span class="branchCov" title="Branch 0 was taken 12789 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      12789 :                 best_selection = curr_selection;</span></a>
<a name="124"><span class="lineNum">     124 </span>                :<span class="lineCov">      12789 :                 best_waste = curr_waste;</span></a>
<a name="125"><span class="lineNum">     125 </span>                :            :             }</a>
<a name="126"><span class="lineNum">     126 </span>                :<span class="lineCov">      25211 :             curr_waste -= (curr_value - selection_target); // Remove the excess value as we will be selecting different coins now</span></a>
<a name="127"><span class="lineNum">     127 </span>                :<span class="lineCov">      25211 :             backtrack = true;</span></a>
<a name="128"><span class="lineNum">     128 </span>                :            :         }</a>
<a name="129"><span class="lineNum">     129 </span>                :            : </a>
<a name="130"><span class="lineNum">     130 </span>        [<span class="branchCov" title="Branch 0 was taken 5114908 times"> + </span><span class="branchCov" title="Branch 1 was taken 5970506 times"> + </span>]:<span class="lineCov">   11085414 :         if (backtrack) { // Backtracking, moving backwards</span></a>
<a name="131"><span class="lineNum">     131 </span>        [<span class="branchCov" title="Branch 0 was taken 128 times"> + </span><span class="branchCov" title="Branch 1 was taken 5114780 times"> + </span>]:<span class="lineCov">    5114908 :             if (curr_selection.empty()) { // We have walked back to the first utxo and no branch is untraversed. All solutions searched</span></a>
<a name="132"><span class="lineNum">     132 </span>                :<span class="lineCov">        128 :                 break;</span></a>
<a name="133"><span class="lineNum">     133 </span>                :            :             }</a>
<a name="134"><span class="lineNum">     134 </span>                :            : </a>
<a name="135"><span class="lineNum">     135 </span>                :            :             // Add omitted UTXOs back to lookahead before traversing the omission branch of last included UTXO.</a>
<a name="136"><span class="lineNum">     136 </span>        [<span class="branchCov" title="Branch 0 was taken 5812197 times"> + </span><span class="branchCov" title="Branch 1 was taken 5114780 times"> + </span>]:<span class="lineCov">   10926977 :             for (--utxo_pool_index; utxo_pool_index &gt; curr_selection.back(); --utxo_pool_index) {</span></a>
<a name="137"><span class="lineNum">     137 </span>        [<span class="branchCov" title="Branch 0 was taken 5812197 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">    5812197 :                 curr_available_value += utxo_pool.at(utxo_pool_index).GetSelectionAmount();</span></a>
<a name="138"><span class="lineNum">     138 </span>                :            :             }</a>
<a name="139"><span class="lineNum">     139 </span>                :            : </a>
<a name="140"><span class="lineNum">     140 </span>                :            :             // Output was included on previous iterations, try excluding now.</a>
<a name="141"><span class="lineNum">     141 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 5114780 times"> + </span>]:<span class="lineCov">    5114780 :             assert(utxo_pool_index == curr_selection.back());</span></a>
<a name="142"><span class="lineNum">     142 </span>        [<span class="branchCov" title="Branch 0 was taken 5114780 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">    5114780 :             OutputGroup&amp; utxo = utxo_pool.at(utxo_pool_index);</span></a>
<a name="143"><span class="lineNum">     143 </span>                :<span class="lineCov">    5114780 :             curr_value -= utxo.GetSelectionAmount();</span></a>
<a name="144"><span class="lineNum">     144 </span>                :<span class="lineCov">    5114780 :             curr_waste -= utxo.fee - utxo.long_term_fee;</span></a>
<a name="145"><span class="lineNum">     145 </span>                :<span class="lineCov">    5114780 :             curr_selection_weight -= utxo.m_weight;</span></a>
<a name="146"><span class="lineNum">     146 </span>                :<span class="lineCov">    5114780 :             curr_selection.pop_back();</span></a>
<a name="147"><span class="lineNum">     147 </span>                :            :         } else { // Moving forwards, continuing down this branch</a>
<a name="148"><span class="lineNum">     148 </span>        [<span class="branchCov" title="Branch 0 was taken 5970506 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">    5970506 :             OutputGroup&amp; utxo = utxo_pool.at(utxo_pool_index);</span></a>
<a name="149"><span class="lineNum">     149 </span>                :            : </a>
<a name="150"><span class="lineNum">     150 </span>                :            :             // Remove this utxo from the curr_available_value utxo amount</a>
<a name="151"><span class="lineNum">     151 </span>                :<span class="lineCov">    5970506 :             curr_available_value -= utxo.GetSelectionAmount();</span></a>
<a name="152"><span class="lineNum">     152 </span>                :            : </a>
<a name="153"><span class="lineNum">     153 </span>                :<span class="lineCov">    5970506 :             if (curr_selection.empty() ||</span></a>
<a name="154"><span class="lineNum">     154 </span>                :            :                 // The previous index is included and therefore not relevant for exclusion shortcut</a>
<a name="155"><span class="lineNum">     155 </span>  [<span class="branchCov" title="Branch 0 was taken 4516910 times"> + </span><span class="branchCov" title="Branch 1 was taken 1451804 times"> + </span><span class="branchCov" title="Branch 2 was taken 823186 times"> + </span><span class="branchCov" title="Branch 3 was taken 3693724 times"> + </span>]:<span class="lineCov">   10485624 :                 (utxo_pool_index - 1) == curr_selection.back() ||</span></a>
<a name="156"><span class="lineNum">     156 </span>                :            :                 // Avoid searching a branch if the previous UTXO has the same value and same waste and was excluded.</a>
<a name="157"><span class="lineNum">     157 </span>                :            :                 // Since the ratio of fee to long term fee is the same, we only need to check if one of those values match in order to know that the waste is the same.</a>
<a name="158"><span class="lineNum">     158 </span>  [<span class="branchCov" title="Branch 0 was taken 5968714 times"> + </span><span class="branchCov" title="Branch 1 was taken 1792 times"> + </span><span class="branchCov" title="Branch 2 was taken 4516910 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span> :<span class="lineCov">   16456130 :                 utxo.GetSelectionAmount() != utxo_pool.at(utxo_pool_index - 1).GetSelectionAmount() ||</span></a>
<span class="lineNum">         </span>         <span class="branchCov" title="Branch 4 was taken 5147323 times"> + </span><span class="branchCov" title="Branch 5 was taken 823183 times"> + </span>]
<a name="159"><span class="lineNum">     159 </span>  [<span class="branchCov" title="Branch 0 was taken 823186 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 3 times"> + </span><span class="branchCov" title="Branch 3 was taken 823183 times"> + </span>]:<span class="lineCov">     823186 :                 utxo.fee != utxo_pool.at(utxo_pool_index - 1).fee)</span></a>
<a name="160"><span class="lineNum">     160 </span>                :            :             {</a>
<a name="161"><span class="lineNum">     161 </span>                :            :                 // Inclusion branch first (Largest First Exploration)</a>
<a name="162"><span class="lineNum">     162 </span>        [<span class="branchCov" title="Branch 0 was taken 5147323 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">    5147323 :                 curr_selection.push_back(utxo_pool_index);</span></a>
<a name="163"><span class="lineNum">     163 </span>                :<span class="lineCov">    5147323 :                 curr_value += utxo.GetSelectionAmount();</span></a>
<a name="164"><span class="lineNum">     164 </span>                :<span class="lineCov">    5147323 :                 curr_waste += utxo.fee - utxo.long_term_fee;</span></a>
<a name="165"><span class="lineNum">     165 </span>                :<span class="lineCov">    5147323 :                 curr_selection_weight += utxo.m_weight;</span></a>
<a name="166"><span class="lineNum">     166 </span>                :            :             }</a>
<a name="167"><span class="lineNum">     167 </span>                :            :         }</a>
<a name="168"><span class="lineNum">     168 </span>                :            :     }</a>
<a name="169"><span class="lineNum">     169 </span>                :            : </a>
<a name="170"><span class="lineNum">     170 </span>                :            :     // Check for solution</a>
<a name="171"><span class="lineNum">     171 </span>        [<span class="branchCov" title="Branch 0 was taken 116 times"> + </span><span class="branchCov" title="Branch 1 was taken 122 times"> + </span>]:<span class="lineCov">        238 :     if (best_selection.empty()) {</span></a>
<a name="172"><span class="lineNum">     172 </span>  [<span class="branchCov" title="Branch 0 was taken 8 times"> + </span><span class="branchCov" title="Branch 1 was taken 108 times"> + </span><span class="branchCov" title="Branch 2 was taken 8 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span> :<span class="lineCov">        232 :         return max_tx_weight_exceeded ? ErrorMaxWeightExceeded() : util::Error();</span></a>
<span class="lineNum">         </span><span class="branchCov" title="Branch 4 was taken 108 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span><span class="branchCov" title="Branch 6 was taken 108 times"> + </span><span class="branchCov" title="Branch 7 was taken 8 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span> 
<span class="lineNum">         </span>            <span class="branchNoCov" title="Branch 9 was not taken"> - </span>]
<a name="173"><span class="lineNum">     173 </span>                :            :     }</a>
<a name="174"><span class="lineNum">     174 </span>                :            : </a>
<a name="175"><span class="lineNum">     175 </span>                :            :     // Set output set</a>
<a name="176"><span class="lineNum">     176 </span>        [<span class="branchCov" title="Branch 0 was taken 26891 times"> + </span><span class="branchCov" title="Branch 1 was taken 122 times"> + </span>]:<span class="lineCov">      27013 :     for (const size_t&amp; i : best_selection) {</span></a>
<a name="177"><span class="lineNum">     177 </span>  [<span class="branchCov" title="Branch 0 was taken 26891 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 26891 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">      26891 :         result.AddInput(utxo_pool.at(i));</span></a>
<a name="178"><span class="lineNum">     178 </span>                :            :     }</a>
<a name="179"><span class="lineNum">     179 </span>        [<span class="branchCov" title="Branch 0 was taken 122 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        122 :     result.ComputeAndSetWaste(cost_of_change, cost_of_change, CAmount{0});</span></a>
<a name="180"><span class="lineNum">     180 </span>  [<span class="branchCov" title="Branch 0 was taken 122 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 122 times"> + </span>]:<span class="lineCov">        122 :     assert(best_waste == result.GetWaste());</span></a>
<a name="181"><span class="lineNum">     181 </span>                :            : </a>
<a name="182"><span class="lineNum">     182 </span>        [<span class="branchCov" title="Branch 0 was taken 122 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        122 :     return result;</span></a>
<a name="183"><span class="lineNum">     183 </span>                :<span class="lineCov">        241 : }</span></a>
<a name="184"><span class="lineNum">     184 </span>                :            : </a>
<a name="185"><span class="lineNum">     185 </span>                :            : class MinOutputGroupComparator</a>
<a name="186"><span class="lineNum">     186 </span>                :            : {</a>
<a name="187"><span class="lineNum">     187 </span>                :            : public:</a>
<a name="188"><span class="lineNum">     188 </span>                :<span class="lineCov">     549301 :     int operator() (const OutputGroup&amp; group1, const OutputGroup&amp; group2) const</span></a>
<a name="189"><span class="lineNum">     189 </span>                :            :     {</a>
<a name="190"><span class="lineNum">     190 </span>                :<span class="lineCov">     549301 :         return group1.GetSelectionAmount() &gt; group2.GetSelectionAmount();</span></a>
<a name="191"><span class="lineNum">     191 </span>                :            :     }</a>
<a name="192"><span class="lineNum">     192 </span>                :            : };</a>
<a name="193"><span class="lineNum">     193 </span>                :            : </a>
<a name="194"><span class="lineNum">     194 </span>                :<span class="lineCov">        128 : util::Result&lt;SelectionResult&gt; SelectCoinsSRD(const std::vector&lt;OutputGroup&gt;&amp; utxo_pool, CAmount target_value, FastRandomContext&amp; rng,</span></a>
<a name="195"><span class="lineNum">     195 </span>                :            :                                              int max_weight)</a>
<a name="196"><span class="lineNum">     196 </span>                :            : {</a>
<a name="197"><span class="lineNum">     197 </span>                :<span class="lineCov">        128 :     SelectionResult result(target_value, SelectionAlgorithm::SRD);</span></a>
<a name="198"><span class="lineNum">     198 </span>                :<span class="lineCov">        128 :     std::priority_queue&lt;OutputGroup, std::vector&lt;OutputGroup&gt;, MinOutputGroupComparator&gt; heap;</span></a>
<a name="199"><span class="lineNum">     199 </span>                :            : </a>
<a name="200"><span class="lineNum">     200 </span>                :            :     // Include change for SRD as we want to avoid making really small change if the selection just</a>
<a name="201"><span class="lineNum">     201 </span>                :            :     // barely meets the target. Just use the lower bound change target instead of the randomly</a>
<a name="202"><span class="lineNum">     202 </span>                :            :     // generated one, since SRD will result in a random change amount anyway; avoid making the</a>
<a name="203"><span class="lineNum">     203 </span>                :            :     // target needlessly large.</a>
<a name="204"><span class="lineNum">     204 </span>                :<span class="lineCov">        128 :     target_value += CHANGE_LOWER;</span></a>
<a name="205"><span class="lineNum">     205 </span>                :            : </a>
<a name="206"><span class="lineNum">     206 </span>                :<span class="lineCov">        128 :     std::vector&lt;size_t&gt; indexes;</span></a>
<a name="207"><span class="lineNum">     207 </span>        [<span class="branchCov" title="Branch 0 was taken 128 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        128 :     indexes.resize(utxo_pool.size());</span></a>
<a name="208"><span class="lineNum">     208 </span>                :<span class="lineCov">        128 :     std::iota(indexes.begin(), indexes.end(), 0);</span></a>
<a name="209"><span class="lineNum">     209 </span>                :<span class="lineCov">        128 :     Shuffle(indexes.begin(), indexes.end(), rng);</span></a>
<a name="210"><span class="lineNum">     210 </span>                :            : </a>
<a name="211"><span class="lineNum">     211 </span>                :<span class="lineCov">        128 :     CAmount selected_eff_value = 0;</span></a>
<a name="212"><span class="lineNum">     212 </span>                :<span class="lineCov">        128 :     int weight = 0;</span></a>
<a name="213"><span class="lineNum">     213 </span>                :<span class="lineCov">        128 :     bool max_tx_weight_exceeded = false;</span></a>
<a name="214"><span class="lineNum">     214 </span>        [<span class="branchCov" title="Branch 0 was taken 62103 times"> + </span><span class="branchCov" title="Branch 1 was taken 17 times"> + </span>]:<span class="lineCov">      62120 :     for (const size_t i : indexes) {</span></a>
<a name="215"><span class="lineNum">     215 </span>        [<span class="branchCov" title="Branch 0 was taken 62103 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      62103 :         const OutputGroup&amp; group = utxo_pool.at(i);</span></a>
<a name="216"><span class="lineNum">     216 </span>                :<span class="lineCov">      62103 :         Assume(group.GetSelectionAmount() &gt; 0);</span></a>
<a name="217"><span class="lineNum">     217 </span>                :            : </a>
<a name="218"><span class="lineNum">     218 </span>                :            :         // Add group to selection</a>
<a name="219"><span class="lineNum">     219 </span>        [<span class="branchCov" title="Branch 0 was taken 62103 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      62103 :         heap.push(group);</span></a>
<a name="220"><span class="lineNum">     220 </span>                :<span class="lineCov">      62103 :         selected_eff_value += group.GetSelectionAmount();</span></a>
<a name="221"><span class="lineNum">     221 </span>                :<span class="lineCov">      62103 :         weight += group.m_weight;</span></a>
<a name="222"><span class="lineNum">     222 </span>                :            : </a>
<a name="223"><span class="lineNum">     223 </span>                :            :         // If the selection weight exceeds the maximum allowed size, remove the least valuable inputs until we</a>
<a name="224"><span class="lineNum">     224 </span>                :            :         // are below max weight.</a>
<a name="225"><span class="lineNum">     225 </span>        [<span class="branchCov" title="Branch 0 was taken 862 times"> + </span><span class="branchCov" title="Branch 1 was taken 61241 times"> + </span>]:<span class="lineCov">      62103 :         if (weight &gt; max_weight) {</span></a>
<a name="226"><span class="lineNum">     226 </span>                :<span class="lineCov">        862 :             max_tx_weight_exceeded = true; // mark it in case we don't find any useful result.</span></a>
<a name="227"><span class="lineNum">     227 </span>                :            :             do {</a>
<a name="228"><span class="lineNum">     228 </span>                :<span class="lineCov">        862 :                 const OutputGroup&amp; to_remove_group = heap.top();</span></a>
<a name="229"><span class="lineNum">     229 </span>                :<span class="lineCov">        862 :                 selected_eff_value -= to_remove_group.GetSelectionAmount();</span></a>
<a name="230"><span class="lineNum">     230 </span>                :<span class="lineCov">        862 :                 weight -= to_remove_group.m_weight;</span></a>
<a name="231"><span class="lineNum">     231 </span>        [<span class="branchCov" title="Branch 0 was taken 862 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        862 :                 heap.pop();</span></a>
<a name="232"><span class="lineNum">     232 </span>  [<span class="branchCov" title="Branch 0 was taken 862 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 862 times"> + </span> :<span class="lineCov">        862 :             } while (!heap.empty() &amp;&amp; weight &gt; max_weight);</span></a>
<span class="lineNum">         </span>         <span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchCov" title="Branch 5 was taken 862 times"> + </span>]
<a name="233"><span class="lineNum">     233 </span>                :            :         }</a>
<a name="234"><span class="lineNum">     234 </span>                :            : </a>
<a name="235"><span class="lineNum">     235 </span>                :            :         // Now check if we are above the target</a>
<a name="236"><span class="lineNum">     236 </span>        [<span class="branchCov" title="Branch 0 was taken 111 times"> + </span><span class="branchCov" title="Branch 1 was taken 61992 times"> + </span>]:<span class="lineCov">      62103 :         if (selected_eff_value &gt;= target_value) {</span></a>
<a name="237"><span class="lineNum">     237 </span>                :            :             // Result found, add it.</a>
<a name="238"><span class="lineNum">     238 </span>        [<span class="branchCov" title="Branch 0 was taken 52386 times"> + </span><span class="branchCov" title="Branch 1 was taken 111 times"> + </span>]:<span class="lineCov">      52497 :             while (!heap.empty()) {</span></a>
<a name="239"><span class="lineNum">     239 </span>        [<span class="branchCov" title="Branch 0 was taken 52386 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      52386 :                 result.AddInput(heap.top());</span></a>
<a name="240"><span class="lineNum">     240 </span>        [<span class="branchCov" title="Branch 0 was taken 52386 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      52386 :                 heap.pop();</span></a>
<a name="241"><span class="lineNum">     241 </span>                :            :             }</a>
<a name="242"><span class="lineNum">     242 </span>        [<span class="branchCov" title="Branch 0 was taken 111 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        111 :             return result;</span></a>
<a name="243"><span class="lineNum">     243 </span>                :            :         }</a>
<a name="244"><span class="lineNum">     244 </span>                :            :     }</a>
<a name="245"><span class="lineNum">     245 </span>  [<span class="branchCov" title="Branch 0 was taken 7 times"> + </span><span class="branchCov" title="Branch 1 was taken 10 times"> + </span><span class="branchCov" title="Branch 2 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span> :<span class="lineCov">         34 :     return max_tx_weight_exceeded ? ErrorMaxWeightExceeded() : util::Error();</span></a>
<span class="lineNum">         </span><span class="branchCov" title="Branch 4 was taken 10 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span><span class="branchCov" title="Branch 6 was taken 10 times"> + </span><span class="branchCov" title="Branch 7 was taken 7 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span> 
<span class="lineNum">         </span>            <span class="branchNoCov" title="Branch 9 was not taken"> - </span>]
<a name="246"><span class="lineNum">     246 </span>                :<span class="lineCov">        128 : }</span></a>
<a name="247"><span class="lineNum">     247 </span>                :            : </a>
<a name="248"><span class="lineNum">     248 </span>                :            : /** Find a subset of the OutputGroups that is at least as large as, but as close as possible to, the</a>
<a name="249"><span class="lineNum">     249 </span>                :            :  * target amount; solve subset sum.</a>
<a name="250"><span class="lineNum">     250 </span>                :            :  * param@[in]   groups          OutputGroups to choose from, sorted by value in descending order.</a>
<a name="251"><span class="lineNum">     251 </span>                :            :  * param@[in]   nTotalLower     Total (effective) value of the UTXOs in groups.</a>
<a name="252"><span class="lineNum">     252 </span>                :            :  * param@[in]   nTargetValue    Subset sum target, not including change.</a>
<a name="253"><span class="lineNum">     253 </span>                :            :  * param@[out]  vfBest          Boolean vector representing the subset chosen that is closest to</a>
<a name="254"><span class="lineNum">     254 </span>                :            :  *                              nTargetValue, with indices corresponding to groups. If the ith</a>
<a name="255"><span class="lineNum">     255 </span>                :            :  *                              entry is true, that means the ith group in groups was selected.</a>
<a name="256"><span class="lineNum">     256 </span>                :            :  * param@[out]  nBest           Total amount of subset chosen that is closest to nTargetValue.</a>
<a name="257"><span class="lineNum">     257 </span>                :            :  * param@[in]   iterations      Maximum number of tries.</a>
<a name="258"><span class="lineNum">     258 </span>                :            :  */</a>
<a name="259"><span class="lineNum">     259 </span>                :<span class="lineCov">       2915 : static void ApproximateBestSubset(FastRandomContext&amp; insecure_rand, const std::vector&lt;OutputGroup&gt;&amp; groups,</span></a>
<a name="260"><span class="lineNum">     260 </span>                :            :                                   const CAmount&amp; nTotalLower, const CAmount&amp; nTargetValue,</a>
<a name="261"><span class="lineNum">     261 </span>                :            :                                   std::vector&lt;char&gt;&amp; vfBest, CAmount&amp; nBest, int iterations = 1000)</a>
<a name="262"><span class="lineNum">     262 </span>                :            : {</a>
<a name="263"><span class="lineNum">     263 </span>                :<span class="lineCov">       2915 :     std::vector&lt;char&gt; vfIncluded;</span></a>
<a name="264"><span class="lineNum">     264 </span>                :            : </a>
<a name="265"><span class="lineNum">     265 </span>                :            :     // Worst case &quot;best&quot; approximation is just all of the groups.</a>
<a name="266"><span class="lineNum">     266 </span>        [<span class="branchCov" title="Branch 0 was taken 2915 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       2915 :     vfBest.assign(groups.size(), true);</span></a>
<a name="267"><span class="lineNum">     267 </span>                :<span class="lineCov">       2915 :     nBest = nTotalLower;</span></a>
<a name="268"><span class="lineNum">     268 </span>                :            : </a>
<a name="269"><span class="lineNum">     269 </span>  [<span class="branchCov" title="Branch 0 was taken 1722401 times"> + </span><span class="branchCov" title="Branch 1 was taken 1706 times"> + </span><span class="branchCov" title="Branch 2 was taken 1721192 times"> + </span><span class="branchCov" title="Branch 3 was taken 1209 times"> + </span>]:<span class="lineCov">    1724107 :     for (int nRep = 0; nRep &lt; iterations &amp;&amp; nBest != nTargetValue; nRep++)</span></a>
<a name="270"><span class="lineNum">     270 </span>                :            :     {</a>
<a name="271"><span class="lineNum">     271 </span>        [<span class="branchCov" title="Branch 0 was taken 1721192 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">    1721192 :         vfIncluded.assign(groups.size(), false);</span></a>
<a name="272"><span class="lineNum">     272 </span>                :<span class="lineCov">    1721192 :         CAmount nTotal = 0;</span></a>
<a name="273"><span class="lineNum">     273 </span>                :<span class="lineCov">    1721192 :         bool fReachedTarget = false;</span></a>
<a name="274"><span class="lineNum">     274 </span>  [<span class="branchCov" title="Branch 0 was taken 3442384 times"> + </span><span class="branchCov" title="Branch 1 was taken 872993 times"> + </span><span class="branchCov" title="Branch 2 was taken 2594185 times"> + </span><span class="branchCov" title="Branch 3 was taken 848199 times"> + </span>]:<span class="lineCov">    4315377 :         for (int nPass = 0; nPass &lt; 2 &amp;&amp; !fReachedTarget; nPass++)</span></a>
<a name="275"><span class="lineNum">     275 </span>                :            :         {</a>
<a name="276"><span class="lineNum">     276 </span>        [<span class="branchCov" title="Branch 0 was taken 364394699 times"> + </span><span class="branchCov" title="Branch 1 was taken 2594185 times"> + </span>]:<span class="lineCov">  366988884 :             for (unsigned int i = 0; i &lt; groups.size(); i++)</span></a>
<a name="277"><span class="lineNum">     277 </span>                :            :             {</a>
<a name="278"><span class="lineNum">     278 </span>                :            :                 //The solver here uses a randomized algorithm,</a>
<a name="279"><span class="lineNum">     279 </span>                :            :                 //the randomness serves no real security purpose but is just</a>
<a name="280"><span class="lineNum">     280 </span>                :            :                 //needed to prevent degenerate behavior and it is important</a>
<a name="281"><span class="lineNum">     281 </span>                :            :                 //that the rng is fast. We do not use a constant random sequence,</a>
<a name="282"><span class="lineNum">     282 </span>                :            :                 //because there may be some privacy improvement by making</a>
<a name="283"><span class="lineNum">     283 </span>                :            :                 //the selection random.</a>
<a name="284"><span class="lineNum">     284 </span>  [<span class="branchCov" title="Branch 0 was taken 355447200 times"> + </span><span class="branchCov" title="Branch 1 was taken 8947499 times"> + </span><span class="branchCov" title="Branch 2 was taken 182536007 times"> + </span><span class="branchCov" title="Branch 3 was taken 181858692 times"> + </span>]:<span class="lineCov">  364394699 :                 if (nPass == 0 ? insecure_rand.randbool() : !vfIncluded[i])</span></a>
<a name="285"><span class="lineNum">     285 </span>                :            :                 {</a>
<a name="286"><span class="lineNum">     286 </span>                :<span class="lineCov">  182536007 :                     nTotal += groups[i].GetSelectionAmount();</span></a>
<a name="287"><span class="lineNum">     287 </span>                :<span class="lineCov">  182536007 :                     vfIncluded[i] = true;</span></a>
<a name="288"><span class="lineNum">     288 </span>        [<span class="branchCov" title="Branch 0 was taken 168202717 times"> + </span><span class="branchCov" title="Branch 1 was taken 14333290 times"> + </span>]:<span class="lineCov">  182536007 :                     if (nTotal &gt;= nTargetValue)</span></a>
<a name="289"><span class="lineNum">     289 </span>                :            :                     {</a>
<a name="290"><span class="lineNum">     290 </span>                :<span class="lineCov">  168202717 :                         fReachedTarget = true;</span></a>
<a name="291"><span class="lineNum">     291 </span>                :            :                         // If the total is between nTargetValue and nBest, it's our new best</a>
<a name="292"><span class="lineNum">     292 </span>                :            :                         // approximation.</a>
<a name="293"><span class="lineNum">     293 </span>        [<span class="branchCov" title="Branch 0 was taken 17859 times"> + </span><span class="branchCov" title="Branch 1 was taken 168184858 times"> + </span>]:<span class="lineCov">  168202717 :                         if (nTotal &lt; nBest)</span></a>
<a name="294"><span class="lineNum">     294 </span>                :            :                         {</a>
<a name="295"><span class="lineNum">     295 </span>                :<span class="lineCov">      17859 :                             nBest = nTotal;</span></a>
<a name="296"><span class="lineNum">     296 </span>        [<span class="branchCov" title="Branch 0 was taken 17859 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      17859 :                             vfBest = vfIncluded;</span></a>
<a name="297"><span class="lineNum">     297 </span>                :            :                         }</a>
<a name="298"><span class="lineNum">     298 </span>                :<span class="lineCov">  168202717 :                         nTotal -= groups[i].GetSelectionAmount();</span></a>
<a name="299"><span class="lineNum">     299 </span>                :<span class="lineCov">  168202717 :                         vfIncluded[i] = false;</span></a>
<a name="300"><span class="lineNum">     300 </span>                :            :                     }</a>
<a name="301"><span class="lineNum">     301 </span>                :            :                 }</a>
<a name="302"><span class="lineNum">     302 </span>                :            :             }</a>
<a name="303"><span class="lineNum">     303 </span>                :            :         }</a>
<a name="304"><span class="lineNum">     304 </span>                :            :     }</a>
<a name="305"><span class="lineNum">     305 </span>                :<span class="lineCov">       2915 : }</span></a>
<a name="306"><span class="lineNum">     306 </span>                :            : </a>
<a name="307"><span class="lineNum">     307 </span>                :<span class="lineCov">       5726 : util::Result&lt;SelectionResult&gt; KnapsackSolver(std::vector&lt;OutputGroup&gt;&amp; groups, const CAmount&amp; nTargetValue,</span></a>
<a name="308"><span class="lineNum">     308 </span>                :            :                                              CAmount change_target, FastRandomContext&amp; rng, int max_weight)</a>
<a name="309"><span class="lineNum">     309 </span>                :            : {</a>
<a name="310"><span class="lineNum">     310 </span>                :<span class="lineCov">       5726 :     SelectionResult result(nTargetValue, SelectionAlgorithm::KNAPSACK);</span></a>
<a name="311"><span class="lineNum">     311 </span>                :            : </a>
<a name="312"><span class="lineNum">     312 </span>                :            :     // List of values less than target</a>
<a name="313"><span class="lineNum">     313 </span>                :<span class="lineCov">       5726 :     std::optional&lt;OutputGroup&gt; lowest_larger;</span></a>
<a name="314"><span class="lineNum">     314 </span>                :            :     // Groups with selection amount smaller than the target and any change we might produce.</a>
<a name="315"><span class="lineNum">     315 </span>                :            :     // Don't include groups larger than this, because they will only cause us to overshoot.</a>
<a name="316"><span class="lineNum">     316 </span>                :<span class="lineCov">       5726 :     std::vector&lt;OutputGroup&gt; applicable_groups;</span></a>
<a name="317"><span class="lineNum">     317 </span>                :<span class="lineCov">       5726 :     CAmount nTotalLower = 0;</span></a>
<a name="318"><span class="lineNum">     318 </span>                :            : </a>
<a name="319"><span class="lineNum">     319 </span>                :<span class="lineCov">       5726 :     Shuffle(groups.begin(), groups.end(), rng);</span></a>
<a name="320"><span class="lineNum">     320 </span>                :            : </a>
<a name="321"><span class="lineNum">     321 </span>        [<span class="branchCov" title="Branch 0 was taken 593029 times"> + </span><span class="branchCov" title="Branch 1 was taken 4621 times"> + </span>]:<span class="lineCov">     597650 :     for (const OutputGroup&amp; group : groups) {</span></a>
<a name="322"><span class="lineNum">     322 </span>        [<span class="branchCov" title="Branch 0 was taken 1105 times"> + </span><span class="branchCov" title="Branch 1 was taken 591924 times"> + </span>]:<span class="lineCov">     593029 :         if (group.GetSelectionAmount() == nTargetValue) {</span></a>
<a name="323"><span class="lineNum">     323 </span>        [<span class="branchCov" title="Branch 0 was taken 1105 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       1105 :             result.AddInput(group);</span></a>
<a name="324"><span class="lineNum">     324 </span>        [<span class="branchCov" title="Branch 0 was taken 1105 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       1105 :             return result;</span></a>
<a name="325"><span class="lineNum">     325 </span>        [<span class="branchCov" title="Branch 0 was taken 354017 times"> + </span><span class="branchCov" title="Branch 1 was taken 237907 times"> + </span>]:<span class="lineCov">     591924 :         } else if (group.GetSelectionAmount() &lt; nTargetValue + change_target) {</span></a>
<a name="326"><span class="lineNum">     326 </span>        [<span class="branchCov" title="Branch 0 was taken 354017 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">     354017 :             applicable_groups.push_back(group);</span></a>
<a name="327"><span class="lineNum">     327 </span>                :<span class="lineCov">     354017 :             nTotalLower += group.GetSelectionAmount();</span></a>
<a name="328"><span class="lineNum">     328 </span>  [<span class="branchCov" title="Branch 0 was taken 235400 times"> + </span><span class="branchCov" title="Branch 1 was taken 2507 times"> + </span><span class="branchCov" title="Branch 2 was taken 589 times"> + </span><span class="branchCov" title="Branch 3 was taken 234811 times"> + </span> :<span class="lineCov">     237907 :         } else if (!lowest_larger || group.GetSelectionAmount() &lt; lowest_larger-&gt;GetSelectionAmount()) {</span></a>
<span class="lineNum">         </span>         <span class="branchCov" title="Branch 4 was taken 3096 times"> + </span><span class="branchCov" title="Branch 5 was taken 234811 times"> + </span>]
<a name="329"><span class="lineNum">     329 </span>        [<span class="branchCov" title="Branch 0 was taken 3096 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       3096 :             lowest_larger = group;</span></a>
<a name="330"><span class="lineNum">     330 </span>                :            :         }</a>
<a name="331"><span class="lineNum">     331 </span>                :            :     }</a>
<a name="332"><span class="lineNum">     332 </span>                :            : </a>
<a name="333"><span class="lineNum">     333 </span>        [<span class="branchCov" title="Branch 0 was taken 501 times"> + </span><span class="branchCov" title="Branch 1 was taken 4120 times"> + </span>]:<span class="lineCov">       4621 :     if (nTotalLower == nTargetValue) {</span></a>
<a name="334"><span class="lineNum">     334 </span>        [<span class="branchCov" title="Branch 0 was taken 1902 times"> + </span><span class="branchCov" title="Branch 1 was taken 501 times"> + </span>]:<span class="lineCov">       2403 :         for (const auto&amp; group : applicable_groups) {</span></a>
<a name="335"><span class="lineNum">     335 </span>        [<span class="branchCov" title="Branch 0 was taken 1902 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       1902 :             result.AddInput(group);</span></a>
<a name="336"><span class="lineNum">     336 </span>                :            :         }</a>
<a name="337"><span class="lineNum">     337 </span>        [<span class="branchCov" title="Branch 0 was taken 501 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        501 :         return result;</span></a>
<a name="338"><span class="lineNum">     338 </span>                :            :     }</a>
<a name="339"><span class="lineNum">     339 </span>                :            : </a>
<a name="340"><span class="lineNum">     340 </span>        [<span class="branchCov" title="Branch 0 was taken 2105 times"> + </span><span class="branchCov" title="Branch 1 was taken 2015 times"> + </span>]:<span class="lineCov">       4120 :     if (nTotalLower &lt; nTargetValue) {</span></a>
<a name="341"><span class="lineNum">     341 </span>  [<span class="branchCov" title="Branch 0 was taken 600 times"> + </span><span class="branchCov" title="Branch 1 was taken 1505 times"> + </span><span class="branchCov" title="Branch 2 was taken 600 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">       2705 :         if (!lowest_larger) return util::Error();</span></a>
<a name="342"><span class="lineNum">     342 </span>        [<span class="branchCov" title="Branch 0 was taken 1505 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       1505 :         result.AddInput(*lowest_larger);</span></a>
<a name="343"><span class="lineNum">     343 </span>        [<span class="branchCov" title="Branch 0 was taken 1505 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       1505 :         return result;</span></a>
<a name="344"><span class="lineNum">     344 </span>                :            :     }</a>
<a name="345"><span class="lineNum">     345 </span>                :            : </a>
<a name="346"><span class="lineNum">     346 </span>                :            :     // Solve subset sum by stochastic approximation</a>
<a name="347"><span class="lineNum">     347 </span>        [<span class="branchCov" title="Branch 0 was taken 2015 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       2015 :     std::sort(applicable_groups.begin(), applicable_groups.end(), descending);</span></a>
<a name="348"><span class="lineNum">     348 </span>                :<span class="lineCov">       2015 :     std::vector&lt;char&gt; vfBest;</span></a>
<a name="349"><span class="lineNum">     349 </span>                :            :     CAmount nBest;</a>
<a name="350"><span class="lineNum">     350 </span>                :            : </a>
<a name="351"><span class="lineNum">     351 </span>        [<span class="branchCov" title="Branch 0 was taken 2015 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       2015 :     ApproximateBestSubset(rng, applicable_groups, nTotalLower, nTargetValue, vfBest, nBest);</span></a>
<a name="352"><span class="lineNum">     352 </span>  [<span class="branchCov" title="Branch 0 was taken 1006 times"> + </span><span class="branchCov" title="Branch 1 was taken 1009 times"> + </span><span class="branchCov" title="Branch 2 was taken 900 times"> + </span><span class="branchCov" title="Branch 3 was taken 106 times"> + </span>]:<span class="lineCov">       2015 :     if (nBest != nTargetValue &amp;&amp; nTotalLower &gt;= nTargetValue + change_target) {</span></a>
<a name="353"><span class="lineNum">     353 </span>        [<span class="branchCov" title="Branch 0 was taken 900 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        900 :         ApproximateBestSubset(rng, applicable_groups, nTotalLower, nTargetValue + change_target, vfBest, nBest);</span></a>
<a name="354"><span class="lineNum">     354 </span>                :            :     }</a>
<a name="355"><span class="lineNum">     355 </span>                :            : </a>
<a name="356"><span class="lineNum">     356 </span>                :            :     // If we have a bigger coin and (either the stochastic approximation didn't find a good solution,</a>
<a name="357"><span class="lineNum">     357 </span>                :            :     //                                   or the next bigger coin is closer), return the bigger coin</a>
<a name="358"><span class="lineNum">     358 </span>  [<span class="branchCov" title="Branch 0 was taken 901 times"> + </span><span class="branchCov" title="Branch 1 was taken 1114 times"> + </span><span class="branchCov" title="Branch 2 was taken 300 times"> + </span><span class="branchCov" title="Branch 3 was taken 1715 times"> + </span>]:<span class="lineCov">       2916 :     if (lowest_larger &amp;&amp;</span></a>
<a name="359"><span class="lineNum">     359 </span>  [<span class="branchCov" title="Branch 0 was taken 400 times"> + </span><span class="branchCov" title="Branch 1 was taken 501 times"> + </span><span class="branchCov" title="Branch 2 was taken 300 times"> + </span><span class="branchCov" title="Branch 3 was taken 100 times"> + </span> :<span class="lineCov">       2916 :         ((nBest != nTargetValue &amp;&amp; nBest &lt; nTargetValue + change_target) || lowest_larger-&gt;GetSelectionAmount() &lt;= nBest)) {</span></a>
<span class="lineNum">         </span>         <span class="branchCov" title="Branch 4 was taken 200 times"> + </span><span class="branchCov" title="Branch 5 was taken 601 times"> + </span>]
<a name="360"><span class="lineNum">     360 </span>        [<span class="branchCov" title="Branch 0 was taken 300 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        300 :         result.AddInput(*lowest_larger);</span></a>
<a name="361"><span class="lineNum">     361 </span>                :            :     } else {</a>
<a name="362"><span class="lineNum">     362 </span>        [<span class="branchCov" title="Branch 0 was taken 343012 times"> + </span><span class="branchCov" title="Branch 1 was taken 1715 times"> + </span>]:<span class="lineCov">     344727 :         for (unsigned int i = 0; i &lt; applicable_groups.size(); i++) {</span></a>
<a name="363"><span class="lineNum">     363 </span>        [<span class="branchCov" title="Branch 0 was taken 138234 times"> + </span><span class="branchCov" title="Branch 1 was taken 204778 times"> + </span>]:<span class="lineCov">     343012 :             if (vfBest[i]) {</span></a>
<a name="364"><span class="lineNum">     364 </span>        [<span class="branchCov" title="Branch 0 was taken 138234 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">     138234 :                 result.AddInput(applicable_groups[i]);</span></a>
<a name="365"><span class="lineNum">     365 </span>                :            :             }</a>
<a name="366"><span class="lineNum">     366 </span>                :            :         }</a>
<a name="367"><span class="lineNum">     367 </span>                :            : </a>
<a name="368"><span class="lineNum">     368 </span>                :            :         // If the result exceeds the maximum allowed size, return closest UTXO above the target</a>
<a name="369"><span class="lineNum">     369 </span>        [<span class="branchCov" title="Branch 0 was taken 7 times"> + </span><span class="branchCov" title="Branch 1 was taken 1708 times"> + </span>]:<span class="lineCov">       1715 :         if (result.GetWeight() &gt; max_weight) {</span></a>
<a name="370"><span class="lineNum">     370 </span>                :            :             // No coin above target, nothing to do.</a>
<a name="371"><span class="lineNum">     371 </span>  [<span class="branchCov" title="Branch 0 was taken 6 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchCov" title="Branch 2 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          7 :             if (!lowest_larger) return ErrorMaxWeightExceeded();</span></a>
<a name="372"><span class="lineNum">     372 </span>                :            : </a>
<a name="373"><span class="lineNum">     373 </span>                :            :             // Return closest UTXO above target</a>
<a name="374"><span class="lineNum">     374 </span>                :<span class="lineCov">          1 :             result.Clear();</span></a>
<a name="375"><span class="lineNum">     375 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :             result.AddInput(*lowest_larger);</span></a>
<a name="376"><span class="lineNum">     376 </span>                :            :         }</a>
<a name="377"><span class="lineNum">     377 </span>                :            : </a>
<a name="378"><span class="lineNum">     378 </span>  [<span class="branchCov" title="Branch 0 was taken 1709 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 1709 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">       1709 :         if (LogAcceptCategory(BCLog::SELECTCOINS, BCLog::Level::Debug)) {</span></a>
<a name="379"><span class="lineNum">     379 </span>        [<span class="branchCov" title="Branch 0 was taken 1709 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       1709 :             std::string log_message{&quot;Coin selection best subset: &quot;};</span></a>
<a name="380"><span class="lineNum">     380 </span>        [<span class="branchCov" title="Branch 0 was taken 333922 times"> + </span><span class="branchCov" title="Branch 1 was taken 1709 times"> + </span>]:<span class="lineCov">     335631 :             for (unsigned int i = 0; i &lt; applicable_groups.size(); i++) {</span></a>
<a name="381"><span class="lineNum">     381 </span>        [<span class="branchCov" title="Branch 0 was taken 129234 times"> + </span><span class="branchCov" title="Branch 1 was taken 204688 times"> + </span>]:<span class="lineCov">     333922 :                 if (vfBest[i]) {</span></a>
<a name="382"><span class="lineNum">     382 </span>  [<span class="branchCov" title="Branch 0 was taken 129234 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 129234 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span> :<span class="lineCov">     129234 :                     log_message += strprintf(&quot;%s &quot;, FormatMoney(applicable_groups[i].m_value));</span></a>
<span class="lineNum">         </span>         <span class="branchCov" title="Branch 4 was taken 129234 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]
<a name="383"><span class="lineNum">     383 </span>                :            :                 }</a>
<a name="384"><span class="lineNum">     384 </span>                :            :             }</a>
<a name="385"><span class="lineNum">     385 </span>  [<span class="branchCov" title="Branch 0 was taken 1709 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 1709 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span> :<span class="lineCov">       1709 :             LogPrint(BCLog::SELECTCOINS, &quot;%stotal %s\n&quot;, log_message, FormatMoney(nBest));</span></a>
<span class="lineNum">         </span><span class="branchCov" title="Branch 4 was taken 1709 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span><span class="branchCov" title="Branch 6 was taken 1709 times"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span><span class="branchCov" title="Branch 8 was taken 1709 times"> + </span> 
<span class="lineNum">         </span>      <span class="branchNoCov" title="Branch 9 was not taken"> - </span><span class="branchCov" title="Branch 10 was taken 1709 times"> + </span><span class="branchNoCov" title="Branch 11 was not taken"> - </span>]
<a name="386"><span class="lineNum">     386 </span>                :<span class="lineCov">       1709 :         }</span></a>
<a name="387"><span class="lineNum">     387 </span>                :            :     }</a>
<a name="388"><span class="lineNum">     388 </span>                :            : </a>
<a name="389"><span class="lineNum">     389 </span>        [<span class="branchCov" title="Branch 0 was taken 2009 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       2009 :     return result;</span></a>
<a name="390"><span class="lineNum">     390 </span>                :<span class="lineCov">       5726 : }</span></a>
<a name="391"><span class="lineNum">     391 </span>                :            : </a>
<a name="392"><span class="lineNum">     392 </span>                :            : /******************************************************************************</a>
<a name="393"><span class="lineNum">     393 </span>                :            : </a>
<a name="394"><span class="lineNum">     394 </span>                :            :  OutputGroup</a>
<a name="395"><span class="lineNum">     395 </span>                :            : </a>
<a name="396"><span class="lineNum">     396 </span>                :            :  ******************************************************************************/</a>
<a name="397"><span class="lineNum">     397 </span>                :            : </a>
<a name="398"><span class="lineNum">     398 </span>                :<span class="lineCov">     737996 : void OutputGroup::Insert(const std::shared_ptr&lt;COutput&gt;&amp; output, size_t ancestors, size_t descendants) {</span></a>
<a name="399"><span class="lineNum">     399 </span>                :<span class="lineCov">     737996 :     m_outputs.push_back(output);</span></a>
<a name="400"><span class="lineNum">     400 </span>                :<span class="lineCov">     737996 :     auto&amp; coin = *m_outputs.back();</span></a>
<a name="401"><span class="lineNum">     401 </span>                :            : </a>
<a name="402"><span class="lineNum">     402 </span>                :<span class="lineCov">     737996 :     fee += coin.GetFee();</span></a>
<a name="403"><span class="lineNum">     403 </span>                :            : </a>
<a name="404"><span class="lineNum">     404 </span>        [<span class="branchCov" title="Branch 0 was taken 6650 times"> + </span><span class="branchCov" title="Branch 1 was taken 731346 times"> + </span>]:<span class="lineCov">     737996 :     coin.long_term_fee = coin.input_bytes &lt; 0 ? 0 : m_long_term_feerate.GetFee(coin.input_bytes);</span></a>
<a name="405"><span class="lineNum">     405 </span>                :<span class="lineCov">     737996 :     long_term_fee += coin.long_term_fee;</span></a>
<a name="406"><span class="lineNum">     406 </span>                :            : </a>
<a name="407"><span class="lineNum">     407 </span>                :<span class="lineCov">     737996 :     effective_value += coin.GetEffectiveValue();</span></a>
<a name="408"><span class="lineNum">     408 </span>                :            : </a>
<a name="409"><span class="lineNum">     409 </span>                :<span class="lineCov">     737996 :     m_from_me &amp;= coin.from_me;</span></a>
<a name="410"><span class="lineNum">     410 </span>                :<span class="lineCov">     737996 :     m_value += coin.txout.nValue;</span></a>
<a name="411"><span class="lineNum">     411 </span>                :<span class="lineCov">     737996 :     m_depth = std::min(m_depth, coin.depth);</span></a>
<a name="412"><span class="lineNum">     412 </span>                :            :     // ancestors here express the number of ancestors the new coin will end up having, which is</a>
<a name="413"><span class="lineNum">     413 </span>                :            :     // the sum, rather than the max; this will overestimate in the cases where multiple inputs</a>
<a name="414"><span class="lineNum">     414 </span>                :            :     // have common ancestors</a>
<a name="415"><span class="lineNum">     415 </span>                :<span class="lineCov">     737996 :     m_ancestors += ancestors;</span></a>
<a name="416"><span class="lineNum">     416 </span>                :            :     // descendants is the count as seen from the top ancestor, not the descendants as seen from the</a>
<a name="417"><span class="lineNum">     417 </span>                :            :     // coin itself; thus, this value is counted as the max, not the sum</a>
<a name="418"><span class="lineNum">     418 </span>                :<span class="lineCov">     737996 :     m_descendants = std::max(m_descendants, descendants);</span></a>
<a name="419"><span class="lineNum">     419 </span>                :            : </a>
<a name="420"><span class="lineNum">     420 </span>        [<span class="branchCov" title="Branch 0 was taken 6650 times"> + </span><span class="branchCov" title="Branch 1 was taken 731346 times"> + </span>]:<span class="lineCov">     737996 :     if (output-&gt;input_bytes &gt; 0) {</span></a>
<a name="421"><span class="lineNum">     421 </span>                :<span class="lineCov">       6650 :         m_weight += output-&gt;input_bytes * WITNESS_SCALE_FACTOR;</span></a>
<a name="422"><span class="lineNum">     422 </span>                :            :     }</a>
<a name="423"><span class="lineNum">     423 </span>                :<span class="lineCov">     737996 : }</span></a>
<a name="424"><span class="lineNum">     424 </span>                :            : </a>
<a name="425"><span class="lineNum">     425 </span>                :<span class="lineCov">     987882 : bool OutputGroup::EligibleForSpending(const CoinEligibilityFilter&amp; eligibility_filter) const</span></a>
<a name="426"><span class="lineNum">     426 </span>                :            : {</a>
<a name="427"><span class="lineNum">     427 </span>        [<span class="branchCov" title="Branch 0 was taken 1211 times"> + </span><span class="branchCov" title="Branch 1 was taken 986671 times"> + </span>]:<span class="lineCov">     987882 :     return m_depth &gt;= (m_from_me ? eligibility_filter.conf_mine : eligibility_filter.conf_theirs)</span></a>
<a name="428"><span class="lineNum">     428 </span>        [<span class="branchCov" title="Branch 0 was taken 987261 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">     987261 :         &amp;&amp; m_ancestors &lt;= eligibility_filter.max_ancestors</span></a>
<a name="429"><span class="lineNum">     429 </span>  [<span class="branchCov" title="Branch 0 was taken 987261 times"> + </span><span class="branchCov" title="Branch 1 was taken 621 times"> + </span><span class="branchCov" title="Branch 2 was taken 987261 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">    1975143 :         &amp;&amp; m_descendants &lt;= eligibility_filter.max_descendants;</span></a>
<a name="430"><span class="lineNum">     430 </span>                :            : }</a>
<a name="431"><span class="lineNum">     431 </span>                :            : </a>
<a name="432"><span class="lineNum">     432 </span>                :<span class="lineCov">  396129040 : CAmount OutputGroup::GetSelectionAmount() const</span></a>
<a name="433"><span class="lineNum">     433 </span>                :            : {</a>
<a name="434"><span class="lineNum">     434 </span>        [<span class="branchCov" title="Branch 0 was taken 12553 times"> + </span><span class="branchCov" title="Branch 1 was taken 396116487 times"> + </span>]:<span class="lineCov">  396129040 :     return m_subtract_fee_outputs ? m_value : effective_value;</span></a>
<a name="435"><span class="lineNum">     435 </span>                :            : }</a>
<a name="436"><span class="lineNum">     436 </span>                :            : </a>
<a name="437"><span class="lineNum">     437 </span>                :<span class="lineCov">     987259 : void OutputGroupTypeMap::Push(const OutputGroup&amp; group, OutputType type, bool insert_positive, bool insert_mixed)</span></a>
<a name="438"><span class="lineNum">     438 </span>                :            : {</a>
<a name="439"><span class="lineNum">     439 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 987259 times"> + </span>]:<span class="lineCov">     987259 :     if (group.m_outputs.empty()) return;</span></a>
<a name="440"><span class="lineNum">     440 </span>                :            : </a>
<a name="441"><span class="lineNum">     441 </span>                :<span class="lineCov">     987259 :     Groups&amp; groups = groups_by_type[type];</span></a>
<a name="442"><span class="lineNum">     442 </span>  [<span class="branchCov" title="Branch 0 was taken 987211 times"> + </span><span class="branchCov" title="Branch 1 was taken 48 times"> + </span><span class="branchCov" title="Branch 2 was taken 987193 times"> + </span><span class="branchCov" title="Branch 3 was taken 18 times"> + </span> :<span class="lineCov">     987259 :     if (insert_positive &amp;&amp; group.GetSelectionAmount() &gt; 0) {</span></a>
<span class="lineNum">         </span>         <span class="branchCov" title="Branch 4 was taken 987193 times"> + </span><span class="branchCov" title="Branch 5 was taken 66 times"> + </span>]
<a name="443"><span class="lineNum">     443 </span>                :<span class="lineCov">     987193 :         groups.positive_group.emplace_back(group);</span></a>
<a name="444"><span class="lineNum">     444 </span>                :<span class="lineCov">     987193 :         all_groups.positive_group.emplace_back(group);</span></a>
<a name="445"><span class="lineNum">     445 </span>                :            :     }</a>
<a name="446"><span class="lineNum">     446 </span>        [<span class="branchCov" title="Branch 0 was taken 987217 times"> + </span><span class="branchCov" title="Branch 1 was taken 42 times"> + </span>]:<span class="lineCov">     987259 :     if (insert_mixed) {</span></a>
<a name="447"><span class="lineNum">     447 </span>                :<span class="lineCov">     987217 :         groups.mixed_group.emplace_back(group);</span></a>
<a name="448"><span class="lineNum">     448 </span>                :<span class="lineCov">     987217 :         all_groups.mixed_group.emplace_back(group);</span></a>
<a name="449"><span class="lineNum">     449 </span>                :            :     }</a>
<a name="450"><span class="lineNum">     450 </span>                :            : }</a>
<a name="451"><span class="lineNum">     451 </span>                :            : </a>
<a name="452"><span class="lineNum">     452 </span>                :<span class="lineCov">        365 : CAmount GetSelectionWaste(const std::set&lt;std::shared_ptr&lt;COutput&gt;&gt;&amp; inputs, CAmount change_cost, CAmount target, bool use_effective_value)</span></a>
<a name="453"><span class="lineNum">     453 </span>                :            : {</a>
<a name="454"><span class="lineNum">     454 </span>                :            :     // This function should not be called with empty inputs as that would mean the selection failed</a>
<a name="455"><span class="lineNum">     455 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 365 times"> + </span>]:<span class="lineCov">        365 :     assert(!inputs.empty());</span></a>
<a name="456"><span class="lineNum">     456 </span>                :            : </a>
<a name="457"><span class="lineNum">     457 </span>                :            :     // Always consider the cost of spending an input now vs in the future.</a>
<a name="458"><span class="lineNum">     458 </span>                :<span class="lineCov">        365 :     CAmount waste = 0;</span></a>
<a name="459"><span class="lineNum">     459 </span>                :<span class="lineCov">        365 :     CAmount selected_effective_value = 0;</span></a>
<a name="460"><span class="lineNum">     460 </span>        [<span class="branchCov" title="Branch 0 was taken 119183 times"> + </span><span class="branchCov" title="Branch 1 was taken 365 times"> + </span>]:<span class="lineCov">     119548 :     for (const auto&amp; coin_ptr : inputs) {</span></a>
<a name="461"><span class="lineNum">     461 </span>                :<span class="lineCov">     119183 :         const COutput&amp; coin = *coin_ptr;</span></a>
<a name="462"><span class="lineNum">     462 </span>                :<span class="lineCov">     119183 :         waste += coin.GetFee() - coin.long_term_fee;</span></a>
<a name="463"><span class="lineNum">     463 </span>        [<span class="branchCov" title="Branch 0 was taken 119134 times"> + </span><span class="branchCov" title="Branch 1 was taken 49 times"> + </span>]:<span class="lineCov">     119183 :         selected_effective_value += use_effective_value ? coin.GetEffectiveValue() : coin.txout.nValue;</span></a>
<a name="464"><span class="lineNum">     464 </span>                :            :     }</a>
<a name="465"><span class="lineNum">     465 </span>                :            : </a>
<a name="466"><span class="lineNum">     466 </span>        [<span class="branchCov" title="Branch 0 was taken 119 times"> + </span><span class="branchCov" title="Branch 1 was taken 246 times"> + </span>]:<span class="lineCov">        365 :     if (change_cost) {</span></a>
<a name="467"><span class="lineNum">     467 </span>                :            :         // Consider the cost of making change and spending it in the future</a>
<a name="468"><span class="lineNum">     468 </span>                :            :         // If we aren't making change, the caller should've set change_cost to 0</a>
<a name="469"><span class="lineNum">     469 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 119 times"> + </span>]:<span class="lineCov">        119 :         assert(change_cost &gt; 0);</span></a>
<a name="470"><span class="lineNum">     470 </span>                :<span class="lineCov">        119 :         waste += change_cost;</span></a>
<a name="471"><span class="lineNum">     471 </span>                :            :     } else {</a>
<a name="472"><span class="lineNum">     472 </span>                :            :         // When we are not making change (change_cost == 0), consider the excess we are throwing away to fees</a>
<a name="473"><span class="lineNum">     473 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 246 times"> + </span>]:<span class="lineCov">        246 :         assert(selected_effective_value &gt;= target);</span></a>
<a name="474"><span class="lineNum">     474 </span>                :<span class="lineCov">        246 :         waste += selected_effective_value - target;</span></a>
<a name="475"><span class="lineNum">     475 </span>                :            :     }</a>
<a name="476"><span class="lineNum">     476 </span>                :            : </a>
<a name="477"><span class="lineNum">     477 </span>                :<span class="lineCov">        365 :     return waste;</span></a>
<a name="478"><span class="lineNum">     478 </span>                :            : }</a>
<a name="479"><span class="lineNum">     479 </span>                :            : </a>
<a name="480"><span class="lineNum">     480 </span>                :<span class="lineCov">         15 : CAmount GenerateChangeTarget(const CAmount payment_value, const CAmount change_fee, FastRandomContext&amp; rng)</span></a>
<a name="481"><span class="lineNum">     481 </span>                :            : {</a>
<a name="482"><span class="lineNum">     482 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 15 times"> + </span>]:<span class="lineCov">         15 :     if (payment_value &lt;= CHANGE_LOWER / 2) {</span></a>
<a name="483"><span class="lineNum">     483 </span>                :<span class="lineNoCov">          0 :         return change_fee + CHANGE_LOWER;</span></a>
<a name="484"><span class="lineNum">     484 </span>                :            :     } else {</a>
<a name="485"><span class="lineNum">     485 </span>                :            :         // random value between 50ksat and min (payment_value * 2, 1milsat)</a>
<a name="486"><span class="lineNum">     486 </span>                :<span class="lineCov">         15 :         const auto upper_bound = std::min(payment_value * 2, CHANGE_UPPER);</span></a>
<a name="487"><span class="lineNum">     487 </span>                :<span class="lineCov">         15 :         return change_fee + rng.randrange(upper_bound - CHANGE_LOWER) + CHANGE_LOWER;</span></a>
<a name="488"><span class="lineNum">     488 </span>                :            :     }</a>
<a name="489"><span class="lineNum">     489 </span>                :            : }</a>
<a name="490"><span class="lineNum">     490 </span>                :            : </a>
<a name="491"><span class="lineNum">     491 </span>                :<span class="lineCov">        353 : void SelectionResult::ComputeAndSetWaste(const CAmount min_viable_change, const CAmount change_cost, const CAmount change_fee)</span></a>
<a name="492"><span class="lineNum">     492 </span>                :            : {</a>
<a name="493"><span class="lineNum">     493 </span>                :<span class="lineCov">        353 :     const CAmount change = GetChange(min_viable_change, change_fee);</span></a>
<a name="494"><span class="lineNum">     494 </span>                :            : </a>
<a name="495"><span class="lineNum">     495 </span>        [<span class="branchCov" title="Branch 0 was taken 116 times"> + </span><span class="branchCov" title="Branch 1 was taken 237 times"> + </span>]:<span class="lineCov">        353 :     if (change &gt; 0) {</span></a>
<a name="496"><span class="lineNum">     496 </span>                :<span class="lineCov">        116 :         m_waste = GetSelectionWaste(m_selected_inputs, change_cost, m_target, m_use_effective);</span></a>
<a name="497"><span class="lineNum">     497 </span>                :            :     } else {</a>
<a name="498"><span class="lineNum">     498 </span>                :<span class="lineCov">        237 :         m_waste = GetSelectionWaste(m_selected_inputs, 0, m_target, m_use_effective);</span></a>
<a name="499"><span class="lineNum">     499 </span>                :            :     }</a>
<a name="500"><span class="lineNum">     500 </span>                :<span class="lineCov">        353 : }</span></a>
<a name="501"><span class="lineNum">     501 </span>                :            : </a>
<a name="502"><span class="lineNum">     502 </span>                :<span class="lineCov">        122 : CAmount SelectionResult::GetWaste() const</span></a>
<a name="503"><span class="lineNum">     503 </span>                :            : {</a>
<a name="504"><span class="lineNum">     504 </span>                :<span class="lineCov">        122 :     return *Assert(m_waste);</span></a>
<a name="505"><span class="lineNum">     505 </span>                :            : }</a>
<a name="506"><span class="lineNum">     506 </span>                :            : </a>
<a name="507"><span class="lineNum">     507 </span>                :<span class="lineCov">       2885 : CAmount SelectionResult::GetSelectedValue() const</span></a>
<a name="508"><span class="lineNum">     508 </span>                :            : {</a>
<a name="509"><span class="lineNum">     509 </span>                :<span class="lineCov">     123030 :     return std::accumulate(m_selected_inputs.cbegin(), m_selected_inputs.cend(), CAmount{0}, [](CAmount sum, const auto&amp; coin) { return sum + coin-&gt;txout.nValue; });</span></a>
<a name="510"><span class="lineNum">     510 </span>                :            : }</a>
<a name="511"><span class="lineNum">     511 </span>                :            : </a>
<a name="512"><span class="lineNum">     512 </span>                :<span class="lineCov">        316 : CAmount SelectionResult::GetSelectedEffectiveValue() const</span></a>
<a name="513"><span class="lineNum">     513 </span>                :            : {</a>
<a name="514"><span class="lineNum">     514 </span>                :<span class="lineCov">     119427 :     return std::accumulate(m_selected_inputs.cbegin(), m_selected_inputs.cend(), CAmount{0}, [](CAmount sum, const auto&amp; coin) { return sum + coin-&gt;GetEffectiveValue(); });</span></a>
<a name="515"><span class="lineNum">     515 </span>                :            : }</a>
<a name="516"><span class="lineNum">     516 </span>                :            : </a>
<a name="517"><span class="lineNum">     517 </span>                :<span class="lineCov">         13 : void SelectionResult::Clear()</span></a>
<a name="518"><span class="lineNum">     518 </span>                :            : {</a>
<a name="519"><span class="lineNum">     519 </span>                :<span class="lineCov">         13 :     m_selected_inputs.clear();</span></a>
<a name="520"><span class="lineNum">     520 </span>                :<span class="lineCov">         13 :     m_waste.reset();</span></a>
<a name="521"><span class="lineNum">     521 </span>                :<span class="lineCov">         13 :     m_weight = 0;</span></a>
<a name="522"><span class="lineNum">     522 </span>                :<span class="lineCov">         13 : }</span></a>
<a name="523"><span class="lineNum">     523 </span>                :            : </a>
<a name="524"><span class="lineNum">     524 </span>                :<span class="lineCov">     222346 : void SelectionResult::AddInput(const OutputGroup&amp; group)</span></a>
<a name="525"><span class="lineNum">     525 </span>                :            : {</a>
<a name="526"><span class="lineNum">     526 </span>                :            :     // As it can fail, combine inputs first</a>
<a name="527"><span class="lineNum">     527 </span>                :<span class="lineCov">     222346 :     InsertInputs(group.m_outputs);</span></a>
<a name="528"><span class="lineNum">     528 </span>                :<span class="lineCov">     222346 :     m_use_effective = !group.m_subtract_fee_outputs;</span></a>
<a name="529"><span class="lineNum">     529 </span>                :            : </a>
<a name="530"><span class="lineNum">     530 </span>                :<span class="lineCov">     222346 :     m_weight += group.m_weight;</span></a>
<a name="531"><span class="lineNum">     531 </span>                :<span class="lineCov">     222346 : }</span></a>
<a name="532"><span class="lineNum">     532 </span>                :            : </a>
<a name="533"><span class="lineNum">     533 </span>                :<span class="lineCov">          2 : void SelectionResult::AddInputs(const std::set&lt;std::shared_ptr&lt;COutput&gt;&gt;&amp; inputs, bool subtract_fee_outputs)</span></a>
<a name="534"><span class="lineNum">     534 </span>                :            : {</a>
<a name="535"><span class="lineNum">     535 </span>                :            :     // As it can fail, combine inputs first</a>
<a name="536"><span class="lineNum">     536 </span>                :<span class="lineCov">          2 :     InsertInputs(inputs);</span></a>
<a name="537"><span class="lineNum">     537 </span>                :<span class="lineCov">          2 :     m_use_effective = !subtract_fee_outputs;</span></a>
<a name="538"><span class="lineNum">     538 </span>                :            : </a>
<a name="539"><span class="lineNum">     539 </span>                :<span class="lineCov">          2 :     m_weight += std::accumulate(inputs.cbegin(), inputs.cend(), 0, [](int sum, const auto&amp; coin) {</span></a>
<a name="540"><span class="lineNum">     540 </span>                :<span class="lineCov">          2 :         return sum + std::max(coin-&gt;input_bytes, 0) * WITNESS_SCALE_FACTOR;</span></a>
<a name="541"><span class="lineNum">     541 </span>                :            :     });</a>
<a name="542"><span class="lineNum">     542 </span>                :<span class="lineCov">          2 : }</span></a>
<a name="543"><span class="lineNum">     543 </span>                :            : </a>
<a name="544"><span class="lineNum">     544 </span>                :<span class="lineCov">          2 : void SelectionResult::Merge(const SelectionResult&amp; other)</span></a>
<a name="545"><span class="lineNum">     545 </span>                :            : {</a>
<a name="546"><span class="lineNum">     546 </span>                :            :     // As it can fail, combine inputs first</a>
<a name="547"><span class="lineNum">     547 </span>                :<span class="lineCov">          2 :     InsertInputs(other.m_selected_inputs);</span></a>
<a name="548"><span class="lineNum">     548 </span>                :            : </a>
<a name="549"><span class="lineNum">     549 </span>                :<span class="lineCov">          2 :     m_target += other.m_target;</span></a>
<a name="550"><span class="lineNum">     550 </span>                :<span class="lineCov">          2 :     m_use_effective |= other.m_use_effective;</span></a>
<a name="551"><span class="lineNum">     551 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">          2 :     if (m_algo == SelectionAlgorithm::MANUAL) {</span></a>
<a name="552"><span class="lineNum">     552 </span>                :<span class="lineNoCov">          0 :         m_algo = other.m_algo;</span></a>
<a name="553"><span class="lineNum">     553 </span>                :            :     }</a>
<a name="554"><span class="lineNum">     554 </span>                :            : </a>
<a name="555"><span class="lineNum">     555 </span>                :<span class="lineCov">          2 :     m_weight += other.m_weight;</span></a>
<a name="556"><span class="lineNum">     556 </span>                :<span class="lineCov">          2 : }</span></a>
<a name="557"><span class="lineNum">     557 </span>                :            : </a>
<a name="558"><span class="lineNum">     558 </span>                :<span class="lineCov">       6439 : const std::set&lt;std::shared_ptr&lt;COutput&gt;&gt;&amp; SelectionResult::GetInputSet() const</span></a>
<a name="559"><span class="lineNum">     559 </span>                :            : {</a>
<a name="560"><span class="lineNum">     560 </span>                :<span class="lineCov">       6439 :     return m_selected_inputs;</span></a>
<a name="561"><span class="lineNum">     561 </span>                :            : }</a>
<a name="562"><span class="lineNum">     562 </span>                :            : </a>
<a name="563"><span class="lineNum">     563 </span>                :<span class="lineCov">         13 : std::vector&lt;std::shared_ptr&lt;COutput&gt;&gt; SelectionResult::GetShuffledInputVector() const</span></a>
<a name="564"><span class="lineNum">     564 </span>                :            : {</a>
<a name="565"><span class="lineNum">     565 </span>        [<span class="branchCov" title="Branch 0 was taken 13 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         13 :     std::vector&lt;std::shared_ptr&lt;COutput&gt;&gt; coins(m_selected_inputs.begin(), m_selected_inputs.end());</span></a>
<a name="566"><span class="lineNum">     566 </span>                :<span class="lineCov">         13 :     Shuffle(coins.begin(), coins.end(), FastRandomContext());</span></a>
<a name="567"><span class="lineNum">     567 </span>                :<span class="lineCov">         13 :     return coins;</span></a>
<a name="568"><span class="lineNum">     568 </span>                :            : }</a>
<a name="569"><span class="lineNum">     569 </span>                :            : </a>
<a name="570"><span class="lineNum">     570 </span>                :<span class="lineCov">        223 : bool SelectionResult::operator&lt;(SelectionResult other) const</span></a>
<a name="571"><span class="lineNum">     571 </span>                :            : {</a>
<a name="572"><span class="lineNum">     572 </span>                :<span class="lineCov">        223 :     Assert(m_waste.has_value());</span></a>
<a name="573"><span class="lineNum">     573 </span>                :<span class="lineCov">        223 :     Assert(other.m_waste.has_value());</span></a>
<a name="574"><span class="lineNum">     574 </span>                :            :     // As this operator is only used in std::min_element, we want the result that has more inputs when waste are equal.</a>
<a name="575"><span class="lineNum">     575 </span>  [<span class="branchCov" title="Branch 0 was taken 223 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 117 times"> + </span><span class="branchCov" title="Branch 3 was taken 106 times"> + </span> :<span class="lineCov">        223 :     return *m_waste &lt; *other.m_waste || (*m_waste == *other.m_waste &amp;&amp; m_selected_inputs.size() &gt; other.m_selected_inputs.size());</span></a>
<span class="lineNum">         </span>         <span class="branchCov" title="Branch 4 was taken 92 times"> + </span><span class="branchCov" title="Branch 5 was taken 25 times"> + </span>]
<a name="576"><span class="lineNum">     576 </span>                :            : }</a>
<a name="577"><span class="lineNum">     577 </span>                :            : </a>
<a name="578"><span class="lineNum">     578 </span>                :<span class="lineNoCov">          0 : std::string COutput::ToString() const</span></a>
<a name="579"><span class="lineNum">     579 </span>                :            : {</a>
<a name="580"><span class="lineNum">     580 </span>  [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     return strprintf(&quot;COutput(%s, %d, %d) [%s]&quot;, outpoint.hash.ToString(), outpoint.n, depth, FormatMoney(txout.nValue));</span></a>
<a name="581"><span class="lineNum">     581 </span>                :            : }</a>
<a name="582"><span class="lineNum">     582 </span>                :            : </a>
<a name="583"><span class="lineNum">     583 </span>                :<span class="lineNoCov">          0 : std::string GetAlgorithmName(const SelectionAlgorithm algo)</span></a>
<a name="584"><span class="lineNum">     584 </span>                :            : {</a>
<a name="585"><span class="lineNum">     585 </span>  [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span> :<span class="lineNoCov">          0 :     switch (algo)</span></a>
<span class="lineNum">         </span>            <span class="branchNoExec" title="Branch 4 was not executed"> # </span>]
<a name="586"><span class="lineNum">     586 </span>                :            :     {</a>
<a name="587"><span class="lineNum">     587 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     case SelectionAlgorithm::BNB: return &quot;bnb&quot;;</span></a>
<a name="588"><span class="lineNum">     588 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     case SelectionAlgorithm::KNAPSACK: return &quot;knapsack&quot;;</span></a>
<a name="589"><span class="lineNum">     589 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     case SelectionAlgorithm::SRD: return &quot;srd&quot;;</span></a>
<a name="590"><span class="lineNum">     590 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     case SelectionAlgorithm::MANUAL: return &quot;manual&quot;;</span></a>
<a name="591"><span class="lineNum">     591 </span>                :            :     // No default case to allow for compiler to warn</a>
<a name="592"><span class="lineNum">     592 </span>                :            :     }</a>
<a name="593"><span class="lineNum">     593 </span>                :<span class="lineNoCov">          0 :     assert(false);</span></a>
<a name="594"><span class="lineNum">     594 </span>                :            : }</a>
<a name="595"><span class="lineNum">     595 </span>                :            : </a>
<a name="596"><span class="lineNum">     596 </span>                :<span class="lineCov">        366 : CAmount SelectionResult::GetChange(const CAmount min_viable_change, const CAmount change_fee) const</span></a>
<a name="597"><span class="lineNum">     597 </span>                :            : {</a>
<a name="598"><span class="lineNum">     598 </span>                :            :     // change = SUM(inputs) - SUM(outputs) - fees</a>
<a name="599"><span class="lineNum">     599 </span>                :            :     // 1) With SFFO we don't pay any fees</a>
<a name="600"><span class="lineNum">     600 </span>                :            :     // 2) Otherwise we pay all the fees:</a>
<a name="601"><span class="lineNum">     601 </span>                :            :     //  - input fees are covered by GetSelectedEffectiveValue()</a>
<a name="602"><span class="lineNum">     602 </span>                :            :     //  - non_input_fee is included in m_target</a>
<a name="603"><span class="lineNum">     603 </span>                :            :     //  - change_fee</a>
<a name="604"><span class="lineNum">     604 </span>                :<span class="lineCov">        366 :     const CAmount change = m_use_effective</span></a>
<a name="605"><span class="lineNum">     605 </span>        [<span class="branchCov" title="Branch 0 was taken 316 times"> + </span><span class="branchCov" title="Branch 1 was taken 50 times"> + </span>]:<span class="lineCov">        366 :                            ? GetSelectedEffectiveValue() - m_target - change_fee</span></a>
<a name="606"><span class="lineNum">     606 </span>                :<span class="lineCov">         50 :                            : GetSelectedValue() - m_target;</span></a>
<a name="607"><span class="lineNum">     607 </span>                :            : </a>
<a name="608"><span class="lineNum">     608 </span>        [<span class="branchCov" title="Branch 0 was taken 242 times"> + </span><span class="branchCov" title="Branch 1 was taken 124 times"> + </span>]:<span class="lineCov">        366 :     if (change &lt; min_viable_change) {</span></a>
<a name="609"><span class="lineNum">     609 </span>                :<span class="lineCov">        242 :         return 0;</span></a>
<a name="610"><span class="lineNum">     610 </span>                :            :     }</a>
<a name="611"><span class="lineNum">     611 </span>                :            : </a>
<a name="612"><span class="lineNum">     612 </span>                :<span class="lineCov">        124 :     return change;</span></a>
<a name="613"><span class="lineNum">     613 </span>                :            : }</a>
<a name="614"><span class="lineNum">     614 </span>                :            : </a>
<a name="615"><span class="lineNum">     615 </span>                :            : } // namespace wallet</a>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="https://github.com/linux-test-project/lcov" target="_parent">LCOV version 1.16</a></td></tr>
  </table>
  <br>

</body>
</html>
